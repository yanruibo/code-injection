


/**
 * @author ABertacco
 */
function printObject(object) {
	var output = '';
	for (property in object) {
	  output += property + ': ' + object[property]+'; ';
	}
	alert(output);
}
 
function ab_number_format(number, decimals, dec_point, thousands_sep){

    var n = number, prec = decimals;
    
    var toFixedFix = function(n, prec){
        var k = Math.pow(10, prec);
        return (Math.round(n * k) / k).toString();
    };
    
    n = !isFinite(+n) ? 0 : +n;
    prec = !isFinite(+prec) ? 0 : Math.abs(prec);
    var sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep;
    var dec = (typeof dec_point === 'undefined') ? '.' : dec_point;				$("#qarchivio_footer_adv").css("text-align", "center");
				$("#archivio_footer_adv").css("text-align", "center");
    
    
    var s = (prec > 0) ? toFixedFix(n, prec) : toFixedFix(Math.round(n), prec); //fix for IE parseFloat(0.55).toFixed(0) = 0;
    var abs = toFixedFix(Math.abs(n), prec);
    var _, i;
    
    if (abs >= 1000) {
        _ = abs.split(/\D/);
        i = _[0].length % 3 || 3;
        
        _[0] = s.slice(0, i + (n < 0)) +
        _[0].slice(i).replace(/(\d{3})/g, sep + '$1');
        s = _.join(dec);
    }
    else {
        s = s.replace('.', dec);
    }
    
    var decPos = s.indexOf(dec);
    if (prec >= 1 && decPos !== -1 && (s.length - decPos - 1) < prec) {
        s += new Array(prec - (s.length - decPos - 1)).join(0) + '0';
    }
    else 
        if (prec >= 1 && decPos === -1) {
            s += dec + new Array(prec).join(0) + '0';
        }
    return s;
}

function ab_euro_formatter(number) {
	return ab_number_format(number, 2, ',', '.') + " €";
}

var dateFormat = function () {
	var	token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
		timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
		timezoneClip = /[^-+\dA-Z]/g,
		pad = function (val, len) {
			val = String(val);
			len = len || 2;
			while (val.length < len) val = "0" + val;
			return val;
		};

	// Regexes and supporting functions are cached through closure
	return function (date, mask, utc) {
		var dF = dateFormat;

		// You can't provide utc if you skip other args (use the "UTC:" mask prefix)
		if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
			mask = date;
			date = undefined;
		}

		// Passing date through Date applies Date.parse, if necessary
		date = date ? new Date(date) : new Date;
		if (isNaN(date)) throw SyntaxError("invalid date");

		mask = String(dF.masks[mask] || mask || dF.masks["default"]);

		// Allow setting the utc argument via the mask
		if (mask.slice(0, 4) == "UTC:") {
			mask = mask.slice(4);
			utc = true;
		}

		var	_ = utc ? "getUTC" : "get",
			d = date[_ + "Date"](),
			D = date[_ + "Day"](),
			m = date[_ + "Month"](),
			y = date[_ + "FullYear"](),
			H = date[_ + "Hours"](),
			M = date[_ + "Minutes"](),
			s = date[_ + "Seconds"](),
			L = date[_ + "Milliseconds"](),
			o = utc ? 0 : date.getTimezoneOffset(),
			flags = {
				d:    d,
				dd:   pad(d),
				ddd:  dF.i18n.dayNames[D],
				dddd: dF.i18n.dayNames[D + 7],
				m:    m + 1,
				mm:   pad(m + 1),
				mmm:  dF.i18n.monthNames[m],
				mmmm: dF.i18n.monthNames[m + 12],
				yy:   String(y).slice(2),
				yyyy: y,
				h:    H % 12 || 12,
				hh:   pad(H % 12 || 12),
				H:    H,
				HH:   pad(H),
				M:    M,
				MM:   pad(M),
				s:    s,
				ss:   pad(s),
				l:    pad(L, 3),
				L:    pad(L > 99 ? Math.round(L / 10) : L),
				t:    H < 12 ? "a"  : "p",
				tt:   H < 12 ? "am" : "pm",
				T:    H < 12 ? "A"  : "P",
				TT:   H < 12 ? "AM" : "PM",
				Z:    utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
				o:    (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
				S:    ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
			};

		return mask.replace(token, function ($0) {
			return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
		});
	};
}();

// Some common format strings
dateFormat.masks = {
	"default":      "ddd mmm dd yyyy HH:MM:ss",
	shortDate:      "m/d/yy",
	mediumDate:     "mmm d, yyyy",
	longDate:       "mmmm d, yyyy",
	fullDate:       "dddd, mmmm d, yyyy",
	shortTime:      "h:MM TT",
	mediumTime:     "h:MM:ss TT",
	longTime:       "h:MM:ss TT Z",
	isoDate:        "yyyy-mm-dd",
	isoTime:        "HH:MM:ss",
	isoDateTime:    "yyyy-mm-dd'T'HH:MM:ss",
	isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};

// Internationalization strings
dateFormat.i18n = {
	dayNames: [
		"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
		"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
	],
	monthNames: [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
		"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
	]
};

// For convenience...
Date.prototype.format = function (mask, utc) {
	return dateFormat(this, mask, utc);
};

function parseDateWithDbFormat(string) {
	var reggie = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/g;
	var tokens = reggie.exec(string);
	if (tokens.length != 7)
		return new Date();
	else 
		return new Date(
			tokens[1],
		    tokens[2] - 1, // mesi partono da 0 in js
		    tokens[3],
		    tokens[4],
		    tokens[5],
		    tokens[6]
		);
};

var abutils = {
	voidfunc : function() {},
	alert : function(msg, title, callback) {
		if (title == null) title = "Il Sole 24 ORE";
		if (callback == null) callback = abutils.voidfunc;
		try {
			
			navigator.notification.alert(msg, function(){
				callback.call();
			}, title, 'Ok');
		
		} catch (exc) {
			alert(msg);
			if (callback != null) {
				callback.call();
			}
		}
	}
};


var PGAleBerUtils = function() {
}
PGAleBerUtils.prototype.splashScreenHide = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'splashScreenHide', []);
}
PGAleBerUtils.prototype.activityStart = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStart', []);
}
PGAleBerUtils.prototype.activityStop = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStop', []);
}
PGAleBerUtils.prototype.deviceExtraInfo = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deviceExtraInfo', []);
}
PGAleBerUtils.prototype.deleteDirectoryAtAbsolutePath = function(successCB, errorCB, path) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deleteDirectoryAtAbsolutePath', [path]);
}
PGAleBerUtils.prototype.registerForRemoteNotification = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'registerForRemoteNotification', []);
}
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.pgaleberutils = new PGAleBerUtils();
});
*/
/* ------------------------------------------------------------- */

var PGFlipper24 = function() {}
PGFlipper24.prototype.trackApp = function(successCB, errorCB, pageName, channel) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.appmeasurement', 'trackApp', [pageName, channel]);
}
PGFlipper24.prototype.openFlipper24 = function(successCB, errorCB, testata, edizione, issue, startingPage, fastLoading) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.flipper24', 'openFlipper24', [testata, edizione, issue, startingPage, fastLoading]);
}
PGFlipper24.prototype.addIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'addIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.removeIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.getQueueDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'getQueueDownloadQueue', []);
}
PGFlipper24.prototype.removeAllIssuesFromDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeAllIssuesFromDownloadQueue', []);
}

var PGAppStore = function() {}
PGAppStore.prototype.setup = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setup', []);
}
PGAppStore.prototype.setUserInfo = function(successCB, errorCB, username, useridentity) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setUserInfo', [username, useridentity]);
}
PGAppStore.prototype.productsListRequest = function(successCB, errorCB, productsIds) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'productsListRequest', [productsIds]);
}
PGAppStore.prototype.purchase = function(successCB, errorCB, productId, planS24) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'purchase', [productId, planS24]);
}
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.flipper24 = new PGFlipper24();
	window.plugins.appstore = new PGAppStore();
});
*/

/* ------------------------------------------------------------- */
NotificationEx = function() {
};

NotificationEx.prototype.loadingStart = function(options) {
    //PhoneGap.exec(null, null, "NotificationEx","loadingStart", [options]);
};
NotificationEx.prototype.loadingStop = function() {
    //PhoneGap.exec(null, null, "NotificationEx","loadingStop", []);
};

NotificationEx.prototype.activityStart = function() {
    //PhoneGap.exec(null, null, "NotificationEx", "activityStart", []);
};

NotificationEx.prototype.activityStop = function() {
    //PhoneGap.exec(null, null, "NotificationEx", "activityStop", []);
};
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
    navigator.plugins.notificationEx = new NotificationEx();
});*/
// Variabile contente l'identificativo del prodotto aperto in edicola
var _PRODUCT_IN_EDICOLA = null;
var _INTERVALLO_CHECK_PRODUCTS = 15 * 60 * 1000;
var _EDICOLA_PRODUCTS_ISCROLL = null;
var _EDICOLA_PRODUCTS_COUNT = 0;
var _EDICOLA_PRODUCTS_INLINE_V = 3;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _EDICOLA_PRODUCTS_INLINE_H = 4;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _EDICOLA_PRODUCTS_DETAILS = null;
var _EDICOLA_DESCR_ISCROLL = null;
// Flag utile per capire se i prodotti in edicola debbano essere aggiornati quando l'utente clicca sul relativo pulsante nella barra menu
var _EDICOLA_REFRESH_PRODUCTS = false;
// hash map tra testata e product id del sole, utilizzato per aprire l'archivio
var _HASH_MAP_TESTATA_PRODUCTID = {};

var _LockTap = false;

var _DEBUG_MODE = !('ontouchstart' in window), _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseup';
/*
 var _API24_APPKEY = "IpadQuot";//<- PRODUZIONE //// DA CAMBIARE!!! //DroidQuot
 //var _API24_APPKEY = "1123344";//<- NEURAL
 //var _API24_SIGNATURE_KEY = "qu0t$STG";//<- PRODUZIONE
 var _API24_SIGNATURE_KEY = "qu0t$PROD";//<- PRODUZIONE
 //var _API24_SIGNATURE_KEY = "pppppppp";//<- NEURAL
 var _API24_SITECODE = "MB"
 var _API24_ENDPOINT = "https://api24.ilsole24ore.com/"; //<- PRODUZIONE
 //var _API24_ENDPOINT = "http://10.5.4.166:400/";//<- NEURAL
 var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";

 var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
 */
 
var isPortrait = null, screenHeight = null, screenWidth = null;

var _SCREENADV = Math.min(window.innerWidth, window.innerHeight);

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _debugIPADContent = false;

var _API24_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot' ;
//<- PRODUZIONE //DroidQuot iPadQuot
var _API24_SIGNATURE_KEY = "qu0t$PROD";
//<- PRODUZIONE
var _API24_SITECODE = "MB"
var _API24_ENDPOINT = "https://api24.ilsole24ore.com/";
//<- PRODUZIONE
var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";
var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php";

var _API24TEST_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot' ;
//<- STAGE //DroidQuot iPadQuot
var _API24TEST_SIGNATURE_KEY = "qu0t$STG";
//<- STAGE
var _API24TEST_SITECODE = "MB"
var _API24TEST_ENDPOINT = "http://api24test.ilsole24ore.com/";
//<- STAGE
var _SOLEGWTEST_ENDPOINT = _API24TEST_ENDPOINT + "SoleGateway/";
var _ADVTEST_PROXY = "http://212.45.97.204/adv_proxy_and.php";

// Variabile globale contenente lo username dell'utente che sta utilizzando l'applicativo
var _USERNAME = null;
// Variabile globale contenente la password dell'utente che sta utilizzando l'applicativo
var _USER_PASSWORD = null;
// Variabile globale contenente lo user identity associato all'utente
var _USER_IDENTITY = null;
// Variabile contenente la funzione da richiamare come prossima azione. Utile in diverse situazioni per esempio dopo aver fatto la login e proseguire con la prossima azione.
var _NEXT_ACTION = null;

var _AJAX_TIMEOUT = 15000;
var _AJAX_TIMEOUT_PING = 10 * 1000;
var _INTERVALLO_CHECK_INBOX = 15 * 60 * 1000;
var _INTERVALLO_CHECK_ONLINE = 10 * 1000;

/*******************AGGIUNTA PER CHECKACQ*****************************************/
//metterlo a false se non si vogliono usare le categorie
//quotidiano --> false
//riviste professionali --> true
var _EDICOLA_USE_CATEGORIES = false;
//metterlo a true se si vuole chiedere la registrazione pre-acquisto one-shot
//quotidiano --> false
//riviste professionali --> true
var _ONESHOT_CHECK_REGISTRATO = true;

/************************************************************/
var _menuButtonsIndex = ['#appmenu_edicola', '#appmenu_preferiti', '#appmenu_inbox', '#appmenu_impostazioni'];
var device = {
		uuid : null,
		version : null,
		platform : null,
		name : null,
		phonegap : null
};

function loadCategories() {
	try {

		// svuoto categorie
		$('#edicola_titolo_btn').html('');

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getCategorie");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "categories.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getCategories");
				console.log(p_response);
				if (checkAjaxResponse(p_response)) {
					var res = p_response.Result.res;
					if ((!res.categoryList) || (res.categoryList.length <= 0)) {
						loadProductsByCategory(null);
						return;
					}
					var l_select = $('<select onchange="edicolaFiltroProdottiByCategory();" id="edicola_titolo_btn_select"></select>');
					for (var i = 0; i < res.categoryList.length; i++) {
						$('<option value="' + res.categoryList[i].categoryName + '">' + res.categoryList[i].categoryDescription + '</option>').appendTo(l_select);
					}

					$('#edicola_titolo_btn').html('');
					l_select.appendTo('#edicola_titolo_btn');

					loadProductsByCategory(res.categoryList[0].categoryName);
				} else {
					console.log('getCategories check ajax response error');
					loadProductsByCategory(null);
				}
			},
			error : function() {
				console.log('getCategories ajax error');
				loadProductsByCategory(null);
			}
		});
	} catch (exc) {
		console.log('getCategories exception ' + exc.message);
		loadProductsByCategory(null);
	}
}

function loadProductsByCategory(p_category) {
	console.log('loadProductsByCategory:' + p_category);
	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + JSON.stringify(p_response));
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if ( typeof _PRODUCTLINK[0] != 'undefined' && _PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});
	} catch(exc) {
		console.log("error::load: " + exc.message);
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}
}

/**
 * Gestisce il caricamento dell'anteprima dei prodotti nell'edicola
 * Utilizza le seguenti chiamate:
 *   - ajaxErrorHandler per la gestione degli errori di comunicazione con API24
 */
var _EDICOLA_LAST_PRODUCT_LOAD = null;
function loadProducts() {

	if ((_EDICOLA_LAST_PRODUCT_LOAD != null) && (Math.abs(_EDICOLA_LAST_PRODUCT_LOAD - (new Date().getTime())) < _INTERVALLO_CHECK_PRODUCTS )) {
		console.log('loadProducts NON necessario');
		return;
	}

	_EDICOLA_LAST_PRODUCT_LOAD = new Date().getTime();

	if (_EDICOLA_USE_CATEGORIES) {
		loadCategories();
		return;
	} else {
		loadProductsByCategory(null);
		return;
	}

	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + /*JSON.stringify(*/p_response/*)*/);
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if (_PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});

	} catch (exc) {
		_EDICOLA_LAST_PRODUCT_LOAD = null;
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}

}

/**
 * Inizializza il controllo per l'aggiornamento dei prodotti attivando un flag per l'aggiornamento dei dati quando l'utente clicca sul pulsante edicola della barra menu
 */
function initCheckProducts() {
	console.log("initCheckProducts");
}

function updateEdicolaProductsIscroll() {
	var pboxes = $('#edicola_container .edicola_prodotto_box');

	if ((pboxes.length == 0) || (_EDICOLA_PRODUCTS_COUNT == 0)) {
		$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
	} else {
		if (_ORIENTATION == 'V') {
			$('#edicola_catalogo').css('left', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('top', '-' + ($('#centrale').height() - 180) + 'px');
				$('#edicola_container').width($(pboxes[0]).outerWidth(true) * pboxes.length);
			} else {
				$('#edicola_catalogo').css('top', '1px');
				$('#edicola_container').width('100%');
			}
		} else {
			$('#edicola_catalogo').css('top', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('left', ($('#centrale').width() - 200) + 'px');
				$('#edicola_container').width($('#edicola_wrapper').width());
			} else {
				$('#edicola_catalogo').css('left', '1px');
				$('#edicola_container').width('100%');
			}
		}
	}
	
	if (_EDICOLA_PRODUCTS_ISCROLL == null) {
		_EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_PRODUCTS_ISCROLL.refresh();
	}

	if (_EDICOLA_DESCR_ISCROLL != null) _EDICOLA_DESCR_ISCROLL.refresh();
	if (_ABBONAMENTI_ISCROLL != null) _ABBONAMENTI_ISCROLL.refresh();
}

var _PRODUCT_DETAILS_COVERFLOW = null;
function openProductDetails(productId) {

	if (_LockTap) return;
	_LockTap = true;
	
	console.log("openProductDetails " + productId);
	if (_EDICOLA_PRODUCTS_DETAILS[productId] == null) {	
		_LockTap = false;
		return;
	}

	$('#edicola_prodotto').attr('class', 'edicola_prodotto_type_' + _EDICOLA_PRODUCTS_DETAILS[productId].type);

	$('.edicola_prodotto_box_icon').removeClass('edicola_prodotto_box_icon_selected');
	$('#edicola_prodotto_box_icon_' + productId).addClass('edicola_prodotto_box_icon_selected');
	if (!_EDICOLA_CATALOGO_SMALL) {
		edicolaCatalogoSwitchView();
	}

	if (_PRODUCT_DETAILS_COVERFLOW != null) {
		_PRODUCT_DETAILS_COVERFLOW.destroy();
		_PRODUCT_DETAILS_COVERFLOW = null;
	}

	$('#edicola_prodotto').hide();

	// elimino prodotto precedente
	$('#edicola_prodotto_titolo_content').empty();
	$('#edicola_prodotto_coverflow_box').empty();
	$('#edicola_prodotto_btns').empty();
	//$('#edicola_prodotto_descr').empty();
	$('#edicola_prodotto_descr_container').empty();
	$('#edicola_prodotto_adv_content').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname || _DEVICE_SETTINGS.appname,
		"appVersion" : device.appversion || _DEVICE_SETTINGS.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> getProductDetails(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> getProductDetails(' + productId + ')');
			console.log('--RESP--> getProductDetails ' + JSON.stringify(p_response));
			
			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				_LockTap = false;
				openProductDetails(productId);
				window.product.setProduct(productId);
			})) {
				//try{
				console.log("OK response openProductDetails " + /*JSON.stringify(*/
				p_response.Result.res/*)*/);
				//var risposta="{\"productName\":\"Il Sole 24 Ore\",\"productId\":\"a1\",\"productDescription\":\"Il Sole 24 ORE è il più autorevole strumento di informazione economica in Italia. Un resoconto chiaro e completo dei fatti che contano. Un aiuto insostituibile per orientarsi nel complesso mondo della finanza, delle normative e dei mercati economici mondiali. Il Sole 24 ORE: l'informazione va oltre il quotidiano!\",\"subscription\":true,\"free\":false,\"singleOffers\":[{\"offerId\":\"QUOTIDIANOSINGOLO\",\"offerDescription\":\"copia singola\",\"offerPrice\":1.59,\"offerItunesProductId\":\"MOBAPP_S24_SINGLE_S24_20120720\"}],\"testata\":\"S24\",\"showarchivio\":\"1\",\"editionId\":\"20120720\",\"editionDescription\":\"20 Luglio 2012\",\"pubDate\":\"20120720\",\"inserts\":[{\"description\":\"Il Sole 24 Ore\",\"insertId\":\"SOLE\",\"cover\":\"http://212.45.97.204/_deploy/S24/20120720/SOLE/cover_high.jpg\",\"anteprima\":0}],\"single\":true,\"demo\":false,\"editionTitle\":\"venerdì 20 luglio 2012\",\"subscriptionOffers\":[{\"offerId\":\"QOL_CANONE_7GG\",\"offerDescription\":\"alla settimana\",\"offerPrice\":9.99,\"offerItunesProductId\":\"http://shopping24.dlv.24orepro.in.ilsole24ore.it/sh4/mobile/android/addToCart.jsp?url_catalog_ref_id=sku1790109&url_product_id=prod1250025\"},{\"offerId\":\"QOL_ABBONAMENTO_MENSILE_PAG\",\"offerDescription\":\"all'anno mensilizzato\",\"offerPrice\":31.99,\"offerItunesProductId\":\"url1\"},{\"offerId\":\"QOL_CANONE_30GG\",\"offerDescription\":\"al mese\",\"offerPrice\":34.99,\"offerItunesProductId\":\"url2\"},{\"offerId\":\"QOL_ABBONAMENTO_ANNUALE_PAG\",\"offerDescription\":\"all'anno\",\"offerPrice\":319.99,\"offerItunesProductId\":\"url3\"}],\"serviceName\":\"products\",\"elapsedTime\":9}";
				schedaProdotto(p_response.Result.res);
				//schedaProdotto($.parseJSON(risposta));
				$('#edicola_prodotto').fadeIn('normal', function(){
					_LockTap = false;
				});
				loadAdvCatalogo(productId);
				loadAdvTabbar(productId);
				window.product.setProduct(productId);
				//}catch(exc){
				//alert(exc.message);
				//}
			} else {
				
				_LockTap = false;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			_LockTap = false;
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

	//carico link store android
	loadlink(productId);
}

//carico i link dello store per gli offerItunesProductId
function loadlink(productId) {
	console.log("loadlink " + productId);

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> loadlink(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/links/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			//console.log('--RESP--> url_loadlink ' +  _SOLEGW_ENDPOINT + "products/links/" + productId + ".json?appKey="+_API24_APPKEY);
			console.log('--RESP--> loadlink(' + productId + ')');
			console.log('--RESP--> loadlink ' + p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				loadlink(productId);
			})) {
				console.log("OK response loadlink "/*+JSON.stringify(p_response)*/);
				loadLinkProdotto(p_response.Result.res);
			} else {
				console.log('Si è verificato un errore nella comunicazione con il server');
			}
		},
		error : function() {
			console.log('Si è verificato un errore nella comunicazione con il server');
		}
	});

}

// Si popola _PRODUCTLINK per l'acquisto
_PRODUCTLINK = [];
function loadLinkProdotto(p_product) {
	console.log("loadLinkProdotto " + p_product.storeLinkItemsList.length + ',' + JSON.stringify(p_product.storeLinkItemsList));
	for (var i = 0; i < p_product.storeLinkItemsList.length; i++) {
		_PRODUCTLINK[i] = {};
		//name
		_PRODUCTLINK[i]['name'] = p_product.storeLinkItemsList[i]['name'];
		//url
		_PRODUCTLINK[i]['url'] = p_product.storeLinkItemsList[i]['url'];
		//productId
		_PRODUCTLINK[i]['productId'] = p_product.storeLinkItemsList[i]['productId'];
		//linkType
		_PRODUCTLINK[i]['linkType'] = p_product.storeLinkItemsList[i]['linkType'];
	}

	console.log("_PRODUCTLINK is  len ::: " + _PRODUCTLINK.length + " :::");
	console.log("_PRODUCTLINK[linkType] is " + ((_PRODUCTLINK) ? _PRODUCTLINK[0]['linkType'] : ""));
}

/**
 * Aggiorna la scheda del prodotto se necessario
 */
function refreshProductDetails() {
	if ((_EDICOLA_CATALOGO_SMALL == true) && (_PRODUCT_IN_EDICOLA != null)) {
		schedaProdotto(_PRODUCT_IN_EDICOLA);
	}
}

/**
 * Crea la scheda del prodotto
 */
//var _EDICOLA_DESCR_ISCROLL = null;
function schedaProdotto(p_product) {
	try {

		console.log("openProductDetails p_product is " + p_product + ',' + p_product.productId);

		if (_PRODUCT_DETAILS_COVERFLOW != null) {
			_PRODUCT_DETAILS_COVERFLOW.destroy();
			_PRODUCT_DETAILS_COVERFLOW = null;
		}
		$('#edicola_prodotto_titolo_content').empty();
		$('#edicola_prodotto_coverflow_box').empty();
		$('#edicola_prodotto_btns').empty();
		$('#edicola_prodotto_descr_container').empty();
		$('#edicola_prodotto_adv_content').empty();

		_PRODUCT_IN_EDICOLA = p_product;

		_HASH_MAP_TESTATA_PRODUCTID[p_product.testata] = p_product.productId;

		_MAP_CODICE_TESTATA[p_product.productId + ''] = p_product.testata;
		
		// titolo
		$('#edicola_prodotto_titolo_content').empty();
		$('<h1>' + p_product.productName + '</h1>').appendTo('#edicola_prodotto_titolo_content');
		$('<h2>' + (p_product.editionDescription != null ? 'Edizione del ' + p_product.editionDescription : '') + '</h2>').appendTo('#edicola_prodotto_titolo_content');

		// Coverflow
		$('#edicola_prodotto_coverflow_box').empty();
		var l_covers_list = [];
		var l_num_covers = p_product.inserts.length;
		for (var i = 0; i < l_num_covers; i++) {
			l_covers_list[i] = {
				'src' : p_product.inserts[i].cover,
				'code' : p_product.inserts[i].insertId,
				'description' : p_product.inserts[i].description,
				'anteprima' : p_product.inserts[i].anteprima && (parseInt(p_product.inserts[i].anteprima) > 0) && !(p_product.free || p_product.subscription),
				'abbonati': p_product.inserts[i].premium && (parseInt(p_product.inserts[i].premium) > 0)
			}
		}
		_PRODUCT_DETAILS_COVERFLOW = new CoveerFlow('edicola_prodotto_coverflow_box', l_covers_list);

		console.log("_PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);

		// bottoni
		$('#edicola_prodotto_btns').empty();
		if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "store") {
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '" ><img src="imgs/edicola_catalogo_appstore_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				window.location = _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'];
			}
		} else if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "webpage") {
			//$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&deviceName=' + encodeURIComponent(device.name) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" class="button red24 commonGenericButton" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
		} else {
			// metto possibilità di tappare dirrettamente sulla cover dell'inserto
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				console.log('TAP ON COVERFLOW: ' + p_product.testata + ' ' + p_product.editionId + ' ' + p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				tapOnAnInsert(p_product);
			}
			// nascondo i bottoni, vengono mostrati quando si sa se è sfoglia o acquisto copia singola
			$('#edicola_prodotto_btns').css('display', 'none');

			console.log('verifica is ' + p_product.productId + ',' + p_product.subscriptionOffers.length + ',' + (p_product.subscriptionOffers && p_product.subscriptionOffers.length));

			// Se ci sono delle offerte
			if (p_product.subscriptionOffers && p_product.subscriptionOffers.length) {
				$('<button class="button medium red24 prodotto_dettaglio_abbonamenti">Abbonamenti</button>').click(function() {
					popupAcquistoAbbonamenti(p_product);
				}).appendTo('#edicola_prodotto_btns');

				for (var i = 0; i < p_product.subscriptionOffers.length; i++) {
					//appstoreReqProduct(p_product.subscriptionOffers[i].offerId, p_product.subscriptionOffers[i].offerItunesProductId)
				}
			}

			// Se c'è la possibilità di acquistare solo un numero viene aggiunto il pulsante per l'acquisto della singola copia
			console.log('productsingle is ' + JSON.stringify(p_product.single));
			if (p_product.single) {
				//for (var i = 0; i < p_product.singleOffers.length; i++) {
				for (var i = 0; i < p_product.singleOffers.length; i++) {
					//creaPulsanteAcquistoSingolo(p_product.singleOffers[i]);
					//$('<button class="button red24 prodotto_dettaglio_acquisto">' + p_product.singleOffers[i].offerPrice + ' €</button>').click(function(){
					$('<button class="button medium red24 prodotto_dettaglio_acquisto">' + ab_euro_formatter(p_product.singleOffers[i].offerPrice) + '</button>').click(function() {
					
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
						mostraPopupInsertoAbbonati();
					} else {	
						acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);
					}
                        
					}).appendTo('#edicola_prodotto_btns');

					//appstoreReqProduct(p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);

					break;
					// <--- visualizzo una sola offerta
				}
			}

			//appstoreReqProducts();

			$('<button class="button medium red24 prodotto_dettaglio_sfoglia">Sfoglia</button>').click(function() {var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);
				if ((!p_product.subscription) && l_edizione_premium) {
					sfogliaCheckPremium(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				} else {
					sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				}
			}).appendTo('#edicola_prodotto_btns');

			$('<br />').appendTo('#edicola_prodotto_btns');

			// Archivio
			$('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" /> Consulta l\'archivio</button>').click(function() {
				if (_LockTap) return;
				_LockTap = true;
				
				console.log("CLICK CONSULTA ARCHIVIO");
				//archivio standard al momento non utilizzato
				if (p_product.productId == _CODICE_PRODOTTO_QUOTIDIANO/*'3'*/) {//CORRETTO????
					// chiamata per aprire archivio STANDARD
					qarchivioOpen(p_product.productId);
				} else {
					// chiamata per aprire archivio QUOTIDIANO
					console.log('archivioOpen p_product.productId' + p_product.productId);
					archivioOpen(p_product.productId);
				}
				
				_LockTap = false;
			}).appendTo('#edicola_prodotto_btns');

			var consultaBtn = $('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" width="15" height="14" /> Consulta l\'archivio</button>');

			checkLocalProductForBtnsRender(p_product);
			console.log(" _PRODUCT_DETAILS_COVERFLOW");
		}

		// Descrizione prodotto
		if (_EDICOLA_DESCR_ISCROLL != null) {
			_EDICOLA_DESCR_ISCROLL.destroy();
			_EDICOLA_DESCR_ISCROLL = null;
		}

		$('#edicola_prodotto_descr_container').empty();
		console.log("descr " + p_product.productDescription);
		//alert("descr "+p_product.productDescription);
		$('<p>' + p_product.productDescription + '</p>').appendTo('#edicola_prodotto_descr_container');

		if (_EDICOLA_DESCR_ISCROLL == null) {
			setTimeout(function() {
				_EDICOLA_DESCR_ISCROLL.refresh();
			}, 100);
			//console.log("1edicolaSSSSSSSasd "+$('#edicola_prodotto_descr_container').outerHeight());
			_EDICOLA_DESCR_ISCROLL = new iScroll('edicola_prodotto_descr', {
				hScroll : false,
				vScroll : true,
				hScrollbar : false,
				bounce : false
			});
			//_EDICOLA_DESCR_ISCROLL.refresh();
		}
		console.log("2edicola descr iscroll is " + $('#edicola_prodotto_descr_container').html() + "::: _EDICOLA_DESCR_ISCROLL " + _EDICOLA_DESCR_ISCROLL);
		//alert("aaa "+ $('#edicola_prodotto_descr_container').html() );
		omnitureTrackApp('APP:edicola:loadProduct:' + p_product.productId, 'APP:edicola');

		console.log(" _PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);
	} catch (exc) {
		console.log(exc.message);
	}
}

function checkLocalProductForBtnsRender(p_product) {
	try {
		
		var l_testata = p_product.testata;
		var l_issue = p_product.editionId;
		var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
		
		console.log('xok0');
		
		if (_DB) {
			console.log('xok');
			/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
			var querySuccess = function(tx, p_results) {
				//alert('asd ' + JSON.stringify(p_results.rows));
				var len = p_results.rows.length;
				//console.log("checkLocalProductForBtnsRender: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);
				if ((len > 0) || p_product.free || p_product.subscription) {
					// solo bottone sfoglia
					$('#edicola_prodotto_btns .prodotto_dettaglio_acquisto').css('display', 'none');
					/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
					$('.coveerflow_anteprima').css('display', 'none');
					//alert('aaa_sed' + p_product.free +','+ p_product.subscription );
				} else {
					// acquisto copia singola
					$('#edicola_prodotto_btns .prodotto_dettaglio_sfoglia').css('display', 'none');
					$('.coveerflow_anteprima').css('display', 'inline-block');
				}
				console.log('xok1');
				$('#edicola_prodotto_btns').css('display', 'inline-block');
			}
			var queryError = function(p_error) {
				console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	} catch(exc) {
		console.log(exc.message);
	}
}

function mostraPopupInsertoAbbonati() {
	abutils.alert('Per poter leggere questo inserto devi essere abbonato.', 'Inserto per abbonati');
}

function sfogliaCheckPremium(p_testata, p_issue, p_edizione) {
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			if (len > 0) {
				sfoglia(p_testata, p_issue, p_edizione);
			} else {
				mostraPopupInsertoAbbonati();
			}
		}
		var queryError = function(p_error) {
			sfoglia(p_testata, p_issue, p_edizione);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [p_testata, p_issue, p_edizione], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function tapOnAnInsert(p_product) {
	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// se la issue è gratuita o è coperta da abbonamento...
			if (p_product.free || p_product.subscription) {
				// si apre lo sfoglio...
				sfoglia(l_testata, l_issue, l_edizione);
			} else {
				// se la issue è presente in locale (o lo è uno dei suoi inserti)...
				if (len > 0) {
					// controllo se è in locale proprio questa issue
					_DB.transaction(function(tx) {
						tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], function(tx, p_results) {
							var len = p_results.rows.length;
							if (len > 0) {
								// la copia è in locale
								sfoglia(l_testata, l_issue, l_edizione);
							} else {
								// la copia non è ancora in locale
								if (l_edizione_premium) {
									mostraPopupInsertoAbbonati();
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							}
						}, function() {
							sfoglia(l_testata, l_issue, l_edizione);
						});
					}, function() {
						sfoglia(l_testata, l_issue, l_edizione);
					});
					/*
					 if ((!p_product.subscription) && l_edizione_premium) {
					 sfogliaCheckPremium(l_testata, l_issue, l_edizione);
					 } else {
					 sfoglia(l_testata, l_issue, l_edizione);
					 }
					 */
				} else {
					// se è disponibile l'anteprima
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima) > 0)) {
						// apro l'anteprima
						openAnteprima(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima));
					} else {
						// altrimenti se sono presenti degli abbonamenti ...
						if (p_product.subscriptionOffers.length) {
							// si aprono le offerte commerciali ...
							popupAcquistoAbbonamenti(p_product);
						} else {
							// altrimenti se è presente la possibilità di acquisto come copia singola ...
							if (p_product.single && (p_product.singleOffers.length > 0)) {
								// si passa all'acquisto della copia singola ...
								if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
									mostraPopupInsertoAbbonati();
								} else {
									acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[0].offerId, p_product.singleOffers[0].offerItunesProductId);
								}
							} else {
								// niente da fare...
							}
						}
					}
				}
			}
		}
		var queryError = function(p_error) {

		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

// DA CAMBIAREEEEEEEEEEEEEEEEEEEEEEEEEE***************************************
function openAnteprima(p_testata, p_issue, p_edizione, p_anteprima) {
	//openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
	console.log('anteprimaaaa');
	openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
}

function sfoglia(p_testata, p_issue, p_edizione, p_pagina) {
	if (_LockTap) return;
	_LockTap = true;
	
	if ( typeof p_pagina == undefined || p_pagina == null) {
		p_pagina = '1';
	}
	console.log('pagina sfoglia ' 	+ p_pagina);
	//alert('pagina sfoglia ' 	+ p_pagina);
	
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	//APRO LO SFOGLIO ANDROID
	try {
		//window.loader.launchSfogliatore("S24", "SOLE", "20111011", "Descrizione");
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		//alert("style: "+node.style.display);
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		window.simulate.dbset(keyinput, valoutput);
		
		console.log("sfoglia " + p_testata + "," + p_edizione + "," + p_issue + "," + "Descrizione" + window.localStorage.getItem(keyinput) + "," + "aaaa" + "," + null);
		
		//alert("sfoglia " + p_testata + "," + p_edizione + "," + p_issue + "," + "Descrizione" + window.localStorage.getItem(keyinput));
		
		if(p_pagina!='1') {
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null, p_pagina);
		} else {
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null);
		}
	} catch(exc) {
		//alert(exc.message);
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}

	//Chiude eventuali schermate aperte

	setTimeout(function() {
		archivioClose();
		qarchivioClose();
		_LockTap = false;
	}, 1500);

}

function scarica(p_testata, p_issue, p_edizione) {
	sfoglia(p_testata, p_issue, p_edizione);
}

function eliminaCopiaLocale(p_testata, p_issue, p_edizione) {
	if (_LockTap) return;
	_LockTap = true;
	
	var type = ($('#edicola_offline_subtitolo_opzioni_vista_ICONS').hasClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on')) ? 'ICONS' : 'LIST';
	//alert("Elimina copia locale testata: " + p_testata + " issue: " + p_issue+ " edizione: " + p_edizione);
	window.simulatePG.confirm('Sei sicuro?', "eliminaCopiaLocaleSucc('"+p_testata+"','"+p_issue+"','"+p_edizione+"', '" + type + "')", 'Cancellazione issue', 'Si,No');
	
	setTimeout(function() { _LockTap = false; }, 2000);
}

function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina, p_forceSkipOneshotCheck) {
	if (!p_forceSkipOneshotCheck)
		p_forceSkipOneshotCheck = false;
	if (false/*_ONESHOT_CHECK_REGISTRATO && !_USERNAME && !p_forceSkipOneshotCheck*/) {
		_NEXT_ACTION = function() {
			acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
		}
		popupAcquistoRegistrazione(p_testata);
	} else {
		acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
	}
}

var _CURRENT_FLIPPER_TESTATA = null;
var _CURRENT_FLIPPER_ISSUE = null;
var _CURRENT_FLIPPER_EDIZIONE = null;
var _CURRENT_FLIPPER_PAGINA = null;
function setFlipperCurrentState(p_testata, p_issue, p_edizione, p_pagina) {
	if (p_testata == null)
		console.log('setFlipperCurrentState null*4');
	else
		console.log('setFlipperCurrentState ' + p_testata + ' ' + p_issue + ' ' + p_edizione + ' ' + p_pagina);
	_CURRENT_FLIPPER_TESTATA = p_testata;
	_CURRENT_FLIPPER_ISSUE = p_issue;
	_CURRENT_FLIPPER_EDIZIONE = p_edizione;
	_CURRENT_FLIPPER_PAGINA = p_pagina;
}

function openFlipper(testata, issue, edizione, pagina, anteprima) {
	if (_LockTap) return;
	_LockTap = true;
	try {

		if (anteprima == null || anteprima == 0)
			anteprima = false;
		else
			anteprima = true;

		console.log("openflipper");
		var l_fast_loading = false;

		if ((testata == null) && (issue == null) && (edizione == null)) {
			testata = _CURRENT_FLIPPER_TESTATA;
			issue = _CURRENT_FLIPPER_ISSUE;
			edizione = _CURRENT_FLIPPER_EDIZIONE;
			pagina = _CURRENT_FLIPPER_PAGINA;
			l_fast_loading = true;
		}

		if ((testata == null) || (issue == null) || (edizione == null)) {
			return false;
		}

		if (pagina == null)
			pagina = 1;

		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);

		setTimeout(function() {

			if (anteprima) {
				_CURRENT_FLIPPER_TESTATA = null;
				_CURRENT_FLIPPER_ISSUE = null;
				_CURRENT_FLIPPER_EDIZIONE = null;
				_CURRENT_FLIPPER_PAGINA = null;
			} else {
				_CURRENT_FLIPPER_TESTATA = testata;
				_CURRENT_FLIPPER_ISSUE = issue;
				_CURRENT_FLIPPER_EDIZIONE = edizione;
				_CURRENT_FLIPPER_PAGINA = pagina;
			}
			
			var keyinput = "unread_message_sole";
			var valoutput = 0;

			var node = document.getElementById('appmenu_inbox_count');
			if (node.style.display == 'block' || node.style.display == 'inline-block') {
				valoutput = 1;
			} else {
				valoutput = 0;
			}

			if ( typeof (window.localStorage) != 'undefined') {
				window.localStorage.setItem(keyinput, valoutput);
			} else {
				throw "window.localStorage, not defined";
			}

			// VERIFICA****************************************
			removeToDownloadQueue(testata, edizione, issue);

			console.log(_CURRENT_FLIPPER_TESTATA + ',' + _CURRENT_FLIPPER_EDIZIONE + ',' + _CURRENT_FLIPPER_ISSUE + ',' + _CURRENT_FLIPPER_PAGINA);
			window.simulate.dbset(keyinput, valoutput);
			if (!anteprima) {
				window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
			} else {
				console.log('anteprima launch');
				window.soledownloader.launchAnteprimaSfogliatore(testata, edizione, issue, "Descrizione" + valoutput, null, null);
			}

			setTimeout(function() {
				//window.go.to(_CURRENT_FLIPPER_PAGINA);

				// chiudo eventuali schermate aperte
				qarchivioClose();
				archivioClose();
				popupAcquistoAbbonamentiClose();
				popupAcquistoRegistrazioneClose();

				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				omnitureTrackApp('APP:edicola:open:' + testata + ':' + issue + ':' + edizione + ( anteprima ? ':PREVIEW' : ''), 'APP:edicola');
				nielsenCall('SFOGLIATORE');
				_LockTap = false;
			}, 3000);

		}, 250);

		return true;
	} catch (exc) {
		console.log(exc.message);
		return false;
	}
}

/*
 * Controlla se un prodotto sia stato scaricato in locale ed in caso abilita il pulsante Sfoglia
 * @params p_product Prodotto
 */
function checkLocalProduct(p_product) {

	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("checkLocalProduct: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);

			if (len) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				creaPulsanteSfoglia(p_product, false);
				// Se il prodotto/inserto è presente in locale avrò il pulsante sfoglia in grigio
			} else if (p_product.free || p_product.subscription) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				// Se il prodotto/inserto non è presente in locale il pulsante sfoglia sarà rosso
				creaPulsanteSfoglia(p_product, true);
			} else {
				// Vengono mostrati gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeIn(200);
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			//tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], querySuccess, queryError);
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function creaPulsanteSfoglia(p_product, p_red) {
	var l_pulsante = $('#edicola_prodotto_sfoglia_btn');

	if (!l_pulsante.length) {

		l_pulsante = $('<button id ="edicola_prodotto_sfoglia_btn" class="button">Sfoglia</button>');

		if (p_red) {
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.addClass('gray');
		}

		l_pulsante.click(function() {
			sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
		});

		l_pulsante.appendTo('#edicola_prodotto_btns');

	} else {
		if (p_red) {
			l_pulsante.removeClass('gray');
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.removeClass('red24');
			l_pulsante.addClass('gray');
		}
	}
}

var _EDICOLA_CATALOGO_SMALL = false;
function edicolaCatalogoSwitchView() {

	var isPortrait = window.innerWidth < window.innerHeight;
	_EDICOLA_CATALOGO_SMALL = !_EDICOLA_CATALOGO_SMALL;

	if (!_EDICOLA_CATALOGO_SMALL) {
		$('.edicola_prodotto_box_icon_selected').removeClass('edicola_prodotto_box_icon_selected');
		_PRODUCT_IN_EDICOLA = null;
	}
	
	if (isPortrait) {
		if ($('#edicola_catalogo').css('top') == '1px') {
			$('#edicola_catalogo').animate({
				'top': '-' + ($('#centrale').height() - 180) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'top': '1px'
			});
		}
	} else {
		if ($('#edicola_catalogo').css('left') == '1px') {
			$('#edicola_catalogo').animate({
				'left': ($('#centrale').width() - 200) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'left': '1px'
			});
		}
	}

	$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
	$('#edicola_container > .edicola_prodotto_box').toggleClass('edicola_prodotto_box_small');
	$('#edicola_wrapper').toggleClass('edicola_wrapper_small');
	
	setTimeout(function() {
		updateEdicolaProductsIscroll();
	}, 0);

	if (_EDICOLA_DESCR_ISCROLL != null && !_EDICOLA_CATALOGO_SMALL) {
		_EDICOLA_DESCR_ISCROLL.destroy();
		_EDICOLA_DESCR_ISCROLL = null;
	}
}

/**
 * Filtra i prodotti in edicola.
 */
function edicolaFiltroProdotti() {
	var l_selected_option = $('#edicola_titolo_btn_select option:selected');

	if (l_selected_option.val() == '') {
		$('#edicola_container .edicola_prodotto_box').fadeIn(200);
	} else {
		$('#edicola_container .edicola_prodotto_box').not('.' + l_selected_option.val()).css('display', 'none');
		$('#edicola_container .edicola_prodotto_box.' + l_selected_option.val()).fadeIn(200);
	}
}

/* --------- gestione drag&drop catalogo ----------- */
var _EDICOLA_TOUCH_START_POS_X = 0;
var _EDICOLA_TOUCH_START_POS_Y = 0;
var _EDICOLA_TOUCH_START_Y = 0;
var _EDICOLA_TOUCH_START_X = 0;
var _EDICOLA_TOUCH_MOVE_Y = 0;
var _EDICOLA_TOUCH_MOVE_X = 0;
var _EDICOLA_TOUCH_STARTED = false;
var _EDICOLA_TOUCH_MOVED = false;
function edicolaTouchStart(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_STARTED = true;
		_EDICOLA_TOUCH_MOVED = false;
		_EDICOLA_TOUCH_START_POS_X = $('#edicola_catalogo').offset().left;
		/*_EDICOLA_TOUCH_START_X = _event.clientX;*/
		_EDICOLA_TOUCH_START_POS_Y = $('#edicola_catalogo').offset().top;
		_EDICOLA_TOUCH_START_X = _event.clientX;
		_EDICOLA_TOUCH_START_Y = _event.clientY;

	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMove(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_X = _event.clientX;
		var position = Math.max(0, Math.min(_EDICOLA_TOUCH_START_POS_X + $('#edicola_wrapper').position().left, (_EDICOLA_TOUCH_START_POS_X + _EDICOLA_TOUCH_MOVE_X - _EDICOLA_TOUCH_START_X)));
		if (position <  - ($('#centrale').height() - 180)) position = - ($('#centrale').height() - 180);
		$('#edicola_catalogo').css('left', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMoveVertical(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_Y = _event.clientY;
		var position = Math.min(0, _EDICOLA_TOUCH_START_POS_Y + _EDICOLA_TOUCH_MOVE_Y - _EDICOLA_TOUCH_START_Y);
		if (position <  - ($('#centrale').height() - 180)) position = - ($('#centrale').height() - 180);
		$('#edicola_catalogo').css('top', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchEnd(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		if (!_EDICOLA_TOUCH_MOVED)
			return;
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		_EDICOLA_TOUCH_STARTED = false;
		edicolaCatalogoSwitchView();
		
	} catch (exc) {
		console.log(exc.message);
	}
}

/******************************************************
 Gestione demo
 ******************************************************/
/**
 * Verifica che l'utente possa utilizzare la demo
 */
function verifyDemo() {
	console.log("---REQ---> verifyDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	} else {
		_NEXT_ACTION = verifyDemo;
		//popupAccediRegistrati();
		popupAcquistoRegistrazione();
		return;
	}

	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> verifyDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, verifyDemo)) {
				if (p_response.Result.res.canUseDemo == true)
					useDemo();
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

/**
 * Utilizza la demo
 */
function useDemo() {
	console.log("---REQ---> useDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		'userIdentity' : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		'username' : _USERNAME
	}

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		dataType : "json",
		processData : false,
		data : JSON.stringify(l_req_data),
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('----> useDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, useDemo)) {
				//&& p_response.Result.res.canUseDemo == true
				sfoglia(_PRODUCT_IN_EDICOLA.testata, _PRODUCT_IN_EDICOLA.editionId, _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				omnitureTrackApp('APP:edicola:demo:' + _PRODUCT_IN_EDICOLA.testata + ':' + _PRODUCT_IN_EDICOLA.editionId + ':' + _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, 'APP:edicola');
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

_ABBONAMENTI_ISCROLL = null;
/* --------- gestione schermata acquisto ----------------- */
function popupAcquistoAbbonamenti(p_product_detail) {
	if (_LockTap) return;
	_LockTap = true;

	function creaPulsanteAbbonamento(p_offerta) {
		console.log("p_offerta is " + _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][0]['linkType'] + ',' + JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']) + ',' + JSON.stringify(p_product_detail) + '::' + JSON.stringify(p_offerta));
		var linkPulsante = '';
		for (var x = 0; x < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; x++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['name'] == p_offerta.offerId) {
				linkPulsante = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['linkType'];
			}
		}

		if (!linkPulsante) {
			//_PRODUCTLINK
			console.log(JSON.stringify(_PRODUCTLINK));
			for (var x = 0; x < _PRODUCTLINK.length; x++) {
				if (_PRODUCTLINK[x]['name'] == p_offerta.offerId) {
					linkPulsante = _PRODUCTLINK[x]['linkType'];
				}
				_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x] = _PRODUCTLINK[x];
			}

		}

		if (linkPulsante && linkPulsante.toString().indexOf('nolink') != -1) {
			//niente
		} else {
			$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
				popupAcquistoAbbonamentiClose();
				if (_USERNAME) {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /*|| p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
						//console.log("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
						
						//alert(JSON.stringify(p_product_detail, null, 4));
						//alert(JSON.stringify(p_offerta, null, 4));
						
						popupRiepilogoApri(p_product_detail, p_offerta);
					} else {
						//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
						//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
						
						//alert(JSON.stringify(p_product_detail, null, 4));
						//alert(JSON.stringify(p_offerta, null, 4));
						
						window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
						console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
					}
				} else {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					_NEXT_ACTION = function() {
						if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /* || p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							popupRiepilogoApri(p_product_detail, p_offerta);
						} else {
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
							window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
							console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
						}
					}
					popupAcquistoRegistrazione(p_offerta.offerId);
				}
			}).appendTo('#acquisto_abbonamenti_offerte');
		}
	}

	function creaPulsanteCopiaSingola(p_offerta) {
		$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
			//acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			//alert("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
			popupAcquistoAbbonamentiClose();
			acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			console.log("offerItunesProductId " + p_offerta.offerItunesProductId);

		}).appendTo('#acquisto_abbonamenti_offerte');
	}


	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_others').css('display', p_product_detail.testata == 'S24' ? 'none' : 'inline-block');
	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_s24').css('display', p_product_detail.testata == 'S24' ? 'inline-block' : 'none');
	if (p_product_detail.testata == 'S24') {
		$('#acquisto_abbonamenti_body_prodotto').html('Il Sole 24 Ore Versione Digitale');
	} else {
		$('#acquisto_abbonamenti_body_prodotto').html(p_product_detail.productName);
	}
	// Inserimento offerte
	$('#acquisto_abbonamenti_offerte').empty();
	
	var l_inserto_premium = p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (!l_inserto_premium) {
		for (var i = 0; i < p_product_detail.singleOffers.length; i++) {
			creaPulsanteCopiaSingola(p_product_detail.singleOffers[i]);
			break;
			// <-- una sola offerta singola
		}
	}

	for (var i = 0; i < p_product_detail.subscriptionOffers.length; i++) {
		creaPulsanteAbbonamento(p_product_detail.subscriptionOffers[i]);
	}
	// Demo prodotto
	if ((!l_inserto_premium) && p_product_detail.demo == true)
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'none');
	/* ---- inizio modifica ---- */
	if (_USERNAME == null)
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'none');
	/* ---- fine modifica ---- */

	// Viene mostrato il popup
	$('#acquisto_abbonamenti').css('display', 'inline');

	//$('#acquisto_abbonamenti_wrapper').height($('#acquisto_abbonamenti_content').height());

	if (_ABBONAMENTI_ISCROLL == null /*_ORIENTATION == 'H'*/ ) {
		_ABBONAMENTI_ISCROLL = new iScroll('acquisto_abbonamenti_wrapper', {
			bounce : false
		});
		_ABBONAMENTI_ISCROLL.refresh();
	} else {
		_ABBONAMENTI_ISCROLL.refresh();
	}

	$('select').attr('disabled', 'disabled');
	
	setTimeout(function() { _LockTap = false; }, 500);
}

function popupAcquistoAbbonamentiClose() {
	if (_LockTap)
		return;
	//$('#acquisto_abbonamenti').fadeOut();
	$('#acquisto_abbonamenti').css('display', 'none');
	$('select').removeAttr('disabled');
}

var _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = null;
function popupAcquistoRegistrazione(p_testata) {
	if (_LockTap)
		return;
	_LockTap = true;
	console.log("REGISTRAZIONE" + p_testata);
	//-------INIZIO
	if (p_testata == 'S24') {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'none');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'block');
		document.getElementById('acquisto_registrazione_body').className = '';
	} else {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'block');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'none');
		document.getElementById('acquisto_registrazione_body').className = 'acquisto_registrazione_type_others';
	}
	//-------FINE
	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	if (_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is " + _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL);
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}

function popupAcquistoRegistrazioneClose() {
	//$('#acquisto_registrazione').fadeOut();
	console.log("REGISTRAZIONE chiusa");
	$('#acquisto_registrazione').css('display', 'none');
}

function acquistoAbbonamento(abbonamento) {
	popupAcquistoRegistrazione();
}

function popupAcquistoRegistrazioneRegistrati() {
	console.log("REGISTRAZIONE 1");
	popupRegistrazioneApri();
}

function procediAcquistoAbbonamento(p_product, p_offerta, p_itunes) {
	var l_testata = p_product.testata;
	if (!l_testata)
		l_testata = 'S24';
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
}

function acquistoAbbonamentiAgganciaAbbonamento() {

	_NEXT_ACTION = acquistoAbbonamentiAgganciaAbbonamento_done;

	popupLogin();

}

function acquistoAbbonamentiAgganciaAbbonamento_done() {
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggancio abbonamento..."]);
	// controllo stato abbonamento

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + _PRODUCT_IN_EDICOLA.productId);
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription/' + _PRODUCT_IN_EDICOLA.productId);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				acquistoAbbonamentiAgganciaAbbonamento_done();
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					//if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}

				if (l_attivo) {

					acquistoAbbonamentiAgganciaAbbonamento_complete('Aggancio abbonamento completato. Il tuo abbonamento scade il ' + l_date_end.format('dd/mm/yyyy'));
				} else {
					acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
				}

			} else {
				acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
			}
		},
		error : function() {
			acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
		}
	});

}

function acquistoAbbonamentiAgganciaAbbonamento_complete(p_msg) {
	abutils.alert(p_msg, 'Aggancia abbonamento');

	// chiudo schermata abbonamenti
	popupAcquistoAbbonamentiClose();
	// ricarico dettaglio prodotto
	openProductDetails(_PRODUCT_IN_EDICOLA.productId);

	/*navigator.notification.loadingStop();*/
	window.simulatePG.exec(null, null, "Notification", "activityStop", []);
}

function acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina) {
	if (!p_pagina)
		p_pagina = 1;
	var l_productid = _HASH_MAP_TESTATA_PRODUCTID[p_testata];

	//alert('aaa '+l_productid);
	if (!l_productid) {
		//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione, p_pagina); });
		//BUY
		var link_singola = '';
		for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
				link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
			}
		}

		if (!link_singola || link_singola == '') {
			_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] = _PRODUCTLINK;
			for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
				}
			}
		}

		if (link_singola != '') {
			window.payment.paySingle(p_testata, p_issue, p_edizione, p_offerta, p_itunes, link_singola);
		} else {
			abutils.alert('Errore su link!', 'Pagamento');
		}

	} else
		checkAcquisto(l_productid, p_issue, p_edizione, p_offerta, p_itunes, function() {
			sfoglia(p_testata, p_issue, p_edizione, p_pagina);
		});
	//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione); });
}


var _PRODOTTO_PRINCIPALE_DEFAULT = {
	id : (_debugIPADContent) ? "1" : "a1",
	descr : "Il Sole 24 ORE"
};

var _DEVICE_SETTINGS = {
	platform : "2",
	appname : (_debugIPADContent) ? "ITQUOIPAD" : "ITQUOANDROID", // DA CAMBIARE!!! //ITQUOANDROID ITQUOIPAD
	appversion : (_debugIPADContent) ? "2.2" : "1.5" //da cambiare in a2.0 2.2 1.0
}

var _MAP_CODICE_TESTATA = (_debugIPADContent) ? { '1' : 'S24' } : { 'a1' : 'S24' } ;
var _CODICE_PRODOTTO_QUOTIDIANO = (_debugIPADContent) ? '1' : 'a1' ;

function getQueryString(key) {
	key = key.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	var regex = new RegExp("[\\?&]"+key+"=([^&#]*)");
	var qs = regex.exec(window.location.href);
	if (qs == null) return ''; else return qs[1];
}

function setUserData(p_username, p_password, p_useridentity) {
	console.log('setUserData ' + p_username + ' ' + p_password + ' ' + p_useridentity);
	if (p_username == null || p_password == null || p_useridentity == null) {
		deleteUsername();
		deletePassword();
		_USERNAME = null;
		_USER_PASSWORD = null;
		_USER_IDENTITY = null;
		//PhoneGap.exec('AppStore.setUserInfo');
		//window.plugins.appstore.setUserInfo();
	} else {
		storeUsername(p_username);
		storePassword(p_password);
		_USERNAME = p_username;
		_USER_PASSWORD = p_password;
		_USER_IDENTITY = p_useridentity;
		//PhoneGap.exec('AppStore.setUserInfo', _USERNAME, _USER_IDENTITY);
		//window.plugins.appstore.setUserInfo(null, null, _USERNAME, _USER_IDENTITY);
		//console.log('logging  '+p_username+','+p_password);
	}

	//console.log('setUserData2 ' + _USERNAME + ' ' + _USER_PASSWORD + ' ' + _USER_IDENTITY);
}

function applicationWillEnterForeground() {
	console.log('JS|applicationWillEnterForeground');
	return "OK";
}

function applicationDidEnterBackground() {
	console.log('JS|applicationDidEnterBackground');
	return "OK";
}

var ROTATION_CLASSES = {

	"0" : "none",
	"90" : "right",
	"-90" : "left",
	"180" : "flipped"

};

/*
function detectOrientationEvent() {
	var orientationEvents = ['onorientationchange', 'reorient', 'resize'];
	var orientationEvent = null;
	for (var i = 0; i < orientationEvents.length; i++) {
		if (orientationEvents[i] in window) {
			orientationEvent = orientationEvents[i];
			break;
		}
	}
	return orientationEvent;
}
*/

function monitorOrientationChanges() {
	setInterval(function(){
		updateOrientation();
	}, 500);
}

function search() {
	window.searchlaunch.launch();
}

var CURRENT_ORIENTATION = null;
var _appPageIndex = 0;

function openAppPage(index) {
	_appPageIndex = index;
}

function onBodyLoad() {
	//alert('version 61');
	document.addEventListener("deviceready", onDeviceReady, false);
	document.addEventListener("touchmove", function(e) {
		e.preventDefault();
	}, false);

	if (_DEBUG_MODE) {
		document.getElementById('edicola_catalogo_tiro').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
	} else {
		document.getElementById('edicola_catalogo_tiro').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_MOVE_EV, edicolaTouchMove, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);

		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_MOVE_EV, edicolaTouchMoveVertical, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);
	}

	/* inizializzazione componenti grafiche */
	GalaxyCheckboxStyle.init();

	/* inizializzazione componenti grafiche */
	if ($(".registrazione_body_group :checkbox").iphoneStyle != null)
		$(".registrazione_body_group :checkbox").iphoneStyle({
			checkedLabel : 'SI',
			uncheckedLabel : 'NO'
		});

	monitorOrientationChanges();

	setTimeout(function() {
		updateOrientation();
		//$(_menuButtonsIndex[_appPageIndex]).trigger('click');
	}, 200);

	document.addEventListener("backbutton", backKeyDown, true);

	if (_DEBUG_MODE) {
		device = {// ATTENZIONE, dati impostati anche in onDeviceReady
			platform : _DEVICE_SETTINGS.platform,
			appname : _DEVICE_SETTINGS.appname,
			appversion : _DEVICE_SETTINGS.appversion,
			name : 'Il mio Safari ;)',
			uuid : '201111111115'
		}

		PhoneGap = {};
		PhoneGap.exec = function(successCB, errorCB, namespace, method) {
			console.log('PG ' + namespace + ' . ' + method);
		};
		PhoneGap.windowEventHandler = function() {
		};
		if (navigator == null) {
			console.log("create navigator");
			navigator = {};
		}
		if (navigator.notification == null)
			navigator.notification = {};
		if (navigator.notification.loadingStart == null)
			navigator.notification.loadingStart = function() {
				console.log('loadingStart');
			};
		if (navigator.notification.loadingStop == null)
			navigator.notification.loadingStop = function() {
				console.log('loadingStop');
			};

		if (!window.plugins)
			window.plugins = {};
		window.plugins.flipper24 = new PGFlipper24();
		//window.plugins.appstore = new PGAppStore();
		navigator.plugins.notificationEx = new NotificationEx();
		//window.plugins.pgaleberutils = new PGAleBerUtils();

		onDeviceReadyDeviceInfo(null);
	}
	

	/*
	if(device.uuid == undefined) {
    	device.uuid = window.simulateDevice.getUuid();
		device.version =  window.simulateDevice.getOSVersion();
		device.platform = window.simulateDevice.getPlatform();
		device.name = window.simulateDevice.getProductName();
		device.phonegap = window.simulateDevice.getPhonegapVersion();
	}
		*/

}

function backKeyDown() {
	// ALERT sei sicuro, se si esegui finish()
	window.runfunc.askandrun('Sei sicuro di voler uscire?', '');
}

function onDeviceReady() {
	if (_API24TEST_SWITCH) {
		console.log('************* PUNTAMENTO AD AMBIENTE DI TEST ***********************');
		_API24_APPKEY = _API24TEST_APPKEY;
		_API24_SIGNATURE_KEY = _API24TEST_SIGNATURE_KEY;
		_API24_SITECODE = _API24TEST_SITECODE;
		_API24_ENDPOINT = _API24TEST_ENDPOINT;
		_SOLEGW_ENDPOINT = _SOLEGWTEST_ENDPOINT;
		_ADV_PROXY = _ADVTEST_PROXY;
	}

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Caricamento in corso..."]);
	//window.plugins.pgaleberutils.activityStart();
	onDeviceReadyDeviceInfo(null);
}

function onDeviceReadyDeviceInfo(extraInfo) {
	//mod 03012013  
	//inizializziamo l'uuid
	if (device.uuid == undefined) {
		device.uuid = window.infodroid.getuuid();
		window.infodroid.setuuid(device.uuid);
		device.orig_uuid = device.uuid;
		device.name = window.infodroid.getDevice();
	}
	
	//**********************FINE**
	//if (extraInfo != null && extraInfo.deviceid != null) device.uuid = extraInfo.deviceid;

// 	device.appname = (extraInfo == null || extraInfo.appname == null) ? "---" : extraInfo.appname;
// 	device.appversion = (extraInfo == null || extraInfo.appversion == null) ? "---" : extraInfo.appversion;
	//DA CAMBIARE
	//device.usedspace = (extraInfo == null || extraInfo.usedspace == null) ? "---" : extraInfo.usedspace;
	//device.usedspaceperc = (extraInfo == null || extraInfo.usedspaceperc == null) ? "---" : extraInfo.usedspaceperc;
	device.usedspace = (window.infodroid == null) ? "---" : window.infodroid.dirSize("/S24/");
	device.usedspaceperc = (window.infodroid == null) ? "---" : window.infodroid.dirSizePerc("/S24/");

	/*  MOD 03012013
	if (navigator == null)
		navigator = {};
	if (navigator.fileMgr == null)
		navigator.fileMgr = {};
	if (navigator.fileMgr.libFolderPath == null)
		navigator.fileMgr.libFolderPath = (extraInfo == null || extraInfo.libFolderPath == null) ? "" : extraInfo.libFolderPath;

	if (navigator.notification == null)
		navigator.notification = {};
	if (navigator.notification.loadingStart == null)
		navigator.notification.loadingStart = navigator.plugins.notificationEx.loadingStart;
	if (navigator.notification.loadingStop == null)
		navigator.notification.loadingStop = navigator.plugins.notificationEx.loadingStop;
	 */
	
	// DA VERIFICARE!!! forzo il device.platform a 1
	device.platform = _DEVICE_SETTINGS.platform;
	device.appversion = _DEVICE_SETTINGS.appversion;
	device.appname = _DEVICE_SETTINGS.appname;
	/*
	console.log = function(msg) {
	};*/
	
	/* inizializzazione prodotto principale */
	var l_local_storage_prodotto_principale = window.localStorage.getItem("prodotto_principale_id");
	console.log('prodotto principale settato: ' + l_local_storage_prodotto_principale);
	if (l_local_storage_prodotto_principale == null) {
		window.localStorage.setItem("prodotto_principale_id", _PRODOTTO_PRINCIPALE_DEFAULT.id);
		window.localStorage.setItem("prodotto_principale_descr", _PRODOTTO_PRINCIPALE_DEFAULT.descr);
	}

	// non piu' usato, ma può essere lasciato: all'avvio viene lasciata accesa l'edicola dello sfoglio, per forzare il loading di entrambe le immagini
	// qui viene ripristinata l'icona dell'edicola, e tolta quella dello sfoglio
	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');

	// setta il valore di _ORIENTATION
	initOrientation();

	// apertura db
	inizializzaDatabase();
	
	// controllo username
	controlloUsername();
	
}

function onDeviceReady_aux() {

	initCheckProducts();

	//Controlla lo stato online/offline
	initCheckOnline();

	downloadManagerDBinit();

	inboxLoadMessages();

	loadAdvTabbar();
	loadAdvCatalogo();

	setTimeout(function() {
		//$('#splashscreen').css('display', 'none');
		//window.plugins.pgaleberutils.activityStop();
		//window.plugins.pgaleberutils.splashScreenHide();
		//navigator.notification.loadingStop();
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		if (_API24TEST_SWITCH) {
			abutils.alert('Stai utilizzando l\'ambiente di test...');
		}
	}, 3000);
}

function loadAdvTabbar(product_id) {
	if(!product_id){
		if(window.product.getProduct()!= "")
			product_id = window.product.getProduct();
	}

	//alert("CALL ME!!!");
	//document.getElementById('advtabbar_close').style.display = 'none';
	document.getElementById('advtabbar_close_content').innerHTML = '';
	//$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){

	console.log(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV + '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion());

	$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV + '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {

	}).endCapture();
	document.getElementById('advtabbar_open_content').innerHTML = '';
	console.log(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV + '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion());
	//$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
	$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV + '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
// 		setTimeout(function() {
// 		    	centerImage('advtabbar_open_content');
// 		}, 100);
			
			$('#advtabbar_open_content img').each(function() {
				$(this).load(function() {
					$(this).css('margin-left', - $(this).width() / 2);
				});
			});

	}).endCapture();

}

	function centerImage(divname){
			try{
				
					console.log("CALLED");

					$("#" + divname + " img").load(function(){
					
					if(divname.indexOf('archivio') > -1){
							$("#" + divname).css('visibility', 'hidden');
					}
					
					var statusbar = window.infodroid.getStatusBarHeight()*window.devicePixelRatio;
					console.log("statusbar " + statusbar);
					var screenwidth = parseInt(screen.width/window.devicePixelRatio) ;
					var screenheight = parseInt((screen.height)/window.devicePixelRatio) - statusbar;
					
					if(screenwidth < screenheight){//verticale
						console.log("CALLED1");
						//alert('v '+screenheight+","+screenwidth);
			   			var currentImage = $(this);
			   			var curIdPar = new String(JSON.stringify(currentImage.parent().attr('id')));
			   			//alert(curIdPar);
			   			if(curIdPar && curIdPar.indexOf('portrait') > -1){//portrait img
			   				//alert('v enter1 '+currentImage.parent().html());
			   				var imgwidth = currentImage.outerWidth();
			   				if(imgwidth < 200){
			   					if(this.parentNode)
			   						if(this.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
				   			if(imgwidth > parseInt(screenwidth)){//sposta indietro
				   				//alert('v enter2 '+imgwidth+ "," + this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenwidth)/2) +"px");
				   			}else{//sposta avanti
				   				//alert('v enter6 ' + imgwidth + ",\n" + this.clientWidth + "," + currentImage.parent().html());
				   				currentImage.css("margin-left", parseInt((screenwidth - imgwidth )/2) +"px");
				   			}
			   			}else if(curIdPar && curIdPar.indexOf('landscape') > -1){//lanscape img
			   				//alert('v enter3');
			   				var imgwidth = currentImage.outerWidth();
			   				if(imgwidth < 200){
			   					if(this.parentNode)
			   						if(this.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
				   			if(imgwidth > parseInt(screenheight)){//sposta indietro
				   				//alert('v enter4 ' + imgwidth +','+ this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenheight)/2) +"px");
				   			}else{//sposta avanti
				   				//alert('v enter5'+ imgwidth +","+ this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", parseInt((screenheight - imgwidth )/2) +"px");
				   			}
			   			}else{
			   				var imgwidth = parseInt(currentImage.outerWidth());
			   				if(imgwidth && imgwidth > 200 && imgwidth < 800){
			   					console.log(imgwidth);
			   				}
			   				
			   				//alert($("#" + divname).html());
			   				//alert('v else' + imgwidth+ ","+ this.clientWidth + "," +currentImage.parent().html());
			   				if(imgwidth > $("#" + divname).width()){
			   					//alert('enter -' + imgwidth + ','+$("#" + divname).width());
			   					currentImage.css("margin-left", '-' + parseInt((imgwidth - $("#" + divname).width())/2) +"px");
			   				}else{
			   					//alert('enter +' + imgwidth + ','+$("#" + divname).width());
			   					currentImage.css("margin-left", parseInt(( $("#" + divname).width() - imgwidth)/2) +"px");
			   					currentImage.css("left", "0px");
			   					currentImage.css("padding-left", "0px");
			   					currentImage.css("text-align", "left");
			   					
			   					if(currentImage.parent()){
				   					currentImage.parent().css("text-align", "left");
			   					}
			   					if($("#" + divname).parent()){
			   						$("#" + divname).parent().css("text-align", "left");
			   					}
			   					if($("#" + divname)){
			   						$("#" + divname).css("text-align", "left");
			   					}
			   					//alert((currentImage.parent().html()));
			   				}
			   				
			   				//var style = css(currentImage);
			   				//var style2 = css($("#" + divname));
			   				
			   				//alert(JSON.stringify(style)+ ",\n " +divname + " " + JSON.stringify(style2));
			   			}
			   			console.log('currentImage '+currentImage.css("margin-left"));
			   			
			  		}else{//orizzontale
					//alert('O'+screenheight+","+screenwidth);
					$("#" + divname + " img").load(function(){
						console.log("CALLED1");
						if(divname.indexOf('archivio') > -1){
							$("#" + divname).css('visibility', 'hidden');
						}
			   			//alert('O'+screenheight+","+screenwidth);
						var currentImage = $(this);
						var curIdPar = new String(JSON.stringify(currentImage.parent().attr('id')));
			   			if(curIdPar && curIdPar.indexOf('portrait') > -1){//portrait img
				   			if(currentImage.outerWidth() > parseInt(screenheight)){//sposta indietro
				   				currentImage.css("margin-left", '-' + parseInt((currentImage.outerWidth() - screenheight)/2) +"px");
				   			}else{//sposta avanti
				   				currentImage.css("margin-left", parseInt((screenheight - currentImage.outerWidth() )/2) +"px");
				   			}
			   			}else if(curIdPar && curIdPar.indexOf('landscape') > -1){//lanscape img
				   			if(currentImage.outerWidth() > parseInt(screenwidth)){//sposta indietro
				   				currentImage.css("margin-left", '-' + parseInt((currentImage.outerWidth() - screenwidth)/2) +"px");
				   			}else{//sposta avanti
				   				currentImage.css("margin-left", parseInt((screenwidth - currentImage.outerWidth() )/2) +"px");
				   			}
			   			}else{
			   				
			   				var imgwidth = parseInt(currentImage.outerWidth());
			   				if(imgwidth && imgwidth > 200 && imgwidth < 800){
			   					console.log(imgwidth);
			   				}
			   				
			   				//alert($("#" + divname).html());
			   				//alert('v else' + imgwidth+ ","+ this.clientWidth + "," +currentImage.parent().html());
			   				if(imgwidth > $("#" + divname).width()){
			   					//alert('enter -' + imgwidth + ','+$("#" + divname).width());
			   					currentImage.css("margin-left", '-' + parseInt((imgwidth - $("#" + divname).width())/2) +"px");
			   				}else{
			   					//alert('enter +' + imgwidth + ','+$("#" + divname).width());
			   					currentImage.css("margin-left", parseInt(( $("#" + divname).width() - imgwidth)/2) +"px");
			   					currentImage.css("text-align", "left");
			   					
			   					if(currentImage.parent()){
				   					currentImage.parent().css("text-align", "left");
			   					}
			   					if($("#" + divname).parent()){
			   						$("#" + divname).parent().css("text-align", "left");
			   					}
			   					if($("#" + divname)){
			   						$("#" + divname).css("text-align", "left");
			   					}
			   					//alert((currentImage.parent().html()));
			   				}
			   				
			   				//var style = css(currentImage);
			   				//var style2 = css($("#" + divname));
			   				
			   				//alert(JSON.stringify(style)+ ",\n " +divname + " " + JSON.stringify(style2));
			   			}
			   			console.log(currentImage.css("margin-left"));
			   			$("#" + divname).css('visibility', 'visible');
					});
					
				}
				$("#" + divname).css('visibility', 'visible');
				});
			}catch(exc){
				alert(exc.message);
			}
	}
	
	function css(a){
    var o = {};
    var rules = window.getMatchedCSSRules(a.get(0));
    for(var r in rules) {
        o = $.extend(o, css2json(rules[r].style), css2json(a.attr('style')));
    }
    return o;
}
function css2json(css){
    var s = {};
    if(!css) return s;
    if(css instanceof CSSStyleDeclaration) {
        for(var i in css) {
            if((css[i]).toLowerCase) {
                s[(css[i]).toLowerCase()] = (css[css[i]]);
            }
        }
    } 
    else if(typeof css == "string") {
        css = css.split("; ");          
        for (var i in css) {
            var l = css[i].split(": ");
            s[l[0].toLowerCase()] = (l[1]);
        };
    }
    return s;
}

var _TABBAR_ADV_IS_OPEN = false;

function handleAdvTabbarClick() {
	var _width_close = $('#advtabbar_close_content img').first().width();
	// evita di aprire il contenuto se non c'è nulla caricato
	if ((_width_close == null) || (_width_close < 5))
		return;
	//alert("CALL ME1!!!");
	_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
	document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
	document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
}

function loadAdvCatalogo(product_id) {
	if(!product_id){
		if(window.product.getProduct()!= "")
			product_id = window.product.getProduct();
	}

	//alert("CALL ME2!!!");
	document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
	//$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
	$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
				setTimeout(function() {
		    	centerImage('edicola_prodotto_adv_content');
		}, 100);
		
	}).endCapture();
}

function getSignature(p_request_params) {
	return Crypto.HMAC(Crypto.SHA1, p_request_params, _API24_SIGNATURE_KEY).toUpperCase();
}

var _ORIENTATION = '';

function initOrientation() {
	console.log('********init_Orientation********');

	if (window.innerWidth > window.innerHeight) {
		_ORIENTATION = 'H';
	} else {
		_ORIENTATION = 'V';
	}
}

var _UPDATE_ORIENTATION_RUNNING = false;

function updateOrientation() {
	var that = this;
	setTimeout(function(){
		screenHeight = (_DEBUG_MODE) ? window.innerHeight : document.documentElement.clientHeight ;
		screenWidth = (_DEBUG_MODE) ? window.innerWidth : document.documentElement.clientWidth ;
		isPortrait = screenWidth < screenHeight;
		//alert("screenWidth " + screenWidth + ", screenHeight " + screenHeight);
		
		var orientation = isPortrait ? 1 : 2 ;
		if (CURRENT_ORIENTATION == orientation) return;
		CURRENT_ORIENTATION = orientation;
				
		if (_UPDATE_ORIENTATION_RUNNING) return;
		_UPDATE_ORIENTATION_RUNNING = true;
		console.log('_ORIENTATION ' + _ORIENTATION);
		
		if (!isPortrait) {
			_ORIENTATION = 'H';
		} else {
			_ORIENTATION = 'V';
		}
			
		$('#wrapper').width(screenWidth).height(screenHeight);
	
		// FONT SIZE CALCULATION
		var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.013) : Math.round(screenWidth * 0.013);
		$('body').css('font-size', fontSizeRatio + 'px');
		fontSizeRatio = null;
		
		var edicolaSmallHeight = 180;
		$('#centrale').height(screenHeight - $('#appmenu').height());
		$('#inbox_list_wrapper').height(screenHeight - $('#inbox_list_title').height() - $('#appmenu').height() - $('#inbox_list_refresh').height());
			
		if (isPortrait) {
			// PORTRAIT
			$('#edicola_prodotto').height($('#edicola').height() - edicolaSmallHeight).width('100%');
			$('#edicola_prodotto_coverflow').width('100%');
			
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_subtitolo_prodotto').height() - $('#archivio_subtitolo_opzioni').height() - $('#archivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(50);
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_subtitolo_prodotto').height() - $('#qarchivio_subtitolo_opzioni').height() - $('#qarchivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width('100%');
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width('100%');
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height() - $('#edicola_offline_subtitolo_opzioni').height());
			$('#qarchivio_label_local_v').show();
			$('#qarchivio_label_local_h').hide();
		} else {
			// LANDSCAPE
			$('#edicola_prodotto').height('100%').width(screenWidth - 200);
			$('#edicola_prodotto_coverflow').width(screenWidth - 200 - ((screenWidth - 200) * 0.3));
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(screenHeight - $('#qarchivio_titolo').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width(screenWidth - $('#qarchivio_subtitolo_prodotto').width());
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width(screenWidth - $('#archivio_subtitolo_prodotto').width());
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height());
			$('#qarchivio_label_local').css('top', (screenHeight - 40) + 'px');
			$('#qarchivio_label_local_h').show();
			$('#qarchivio_label_local_v').hide();
		}
		
		// COMMON
		$('.commonContentWithTopBar').height(Math.round((screenHeight * 0.9) - 50));
		$('.commonWindowWithTopBar').height(screenHeight - 50);
		$('.commonWindowWithAppBar').height(screenHeight - 50 - $('#appmenu').height());
		$('.commonMaxContentWithTopBar').css('max-height', (screenHeight * 0.9) - 50);
		
		updateEdicolaProductsIscroll();
		if (_PRODUCT_DETAILS_COVERFLOW != null) _PRODUCT_DETAILS_COVERFLOW._display();
		
		qarchivioUpdateIScroll();
		archivioUpdateIscroll();
		inboxUpdateOrientation();
		preferitiUpdateOrientation();
		impostazioniUpdateOrientation();
	
		if (_REGISTRAZIONE_ISCROLL != null) _REGISTRAZIONE_ISCROLL.refresh();
		if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) _IMPOSTAZIONI_ISCROLL_PRIVACY.refresh();
		
		$('#advtabbar_open_content img').each(function() {
			$(this).css('margin-left', - $(this).width() / 2);
		});
	
		_UPDATE_ORIENTATION_RUNNING = false;
	}, 100);
}

/******************************************************
 Gestione schermata di riepilogo abbonamento annuale
 ******************************************************/
var _RIEPILOGO_ISCROLL = null;
var _RIEPILOGO_PRODUCT = null;
var _RIEPILOGO_OFFER = null;

function popupRiepilogoApri(p_product_detail, p_offerta) {
	console.log('detail ' + /*JSON.stringify(*/
	p_product_detail['subscriptionOffers'] /*)*/ );
	_RIEPILOGO_PRODUCT = p_product_detail;
	_RIEPILOGO_OFFER = p_offerta;
	if (_RIEPILOGO_ISCROLL == null && _ORIENTATION == 'H') {
		_RIEPILOGO_ISCROLL = new iScroll('riepilogo_body', {
			bounce : false
		});
		_RIEPILOGO_ISCROLL.refresh();
	}

	_RIEPILOGO_OFFER = {};
	//p_product_detail['subscriptionOffers'];

	// alert("aaa "+p_product_detail['subscriptionOffers'].length);

	for (var j = 0; j < p_product_detail['subscriptionOffers'].length; j++) {
		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['annuale_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['annuale_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in unica soluzione.<BR/>L\'importo visualizzato a fianco si riferisce alla quota annuale di abbonamento';
			_RIEPILOGO_OFFER['annuale_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['annuale_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_MENSILE_PAG') {
			_RIEPILOGO_OFFER['mensile_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['mensile_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in rate mensili.<BR/>L\'importo visualizzato a fianco si riferisce al canone mensile di abbonamento';
			_RIEPILOGO_OFFER['mensile_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['mensile_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		//se i codici che mi arrivano non sono quelli attessi mi conservo quello che arriva
		if (p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_MENSILE_PAG' && p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['x_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['x_descr'] = 'Abbonamento a ' + p_product_detail.productName + '<BR/>in versione digitale.<BR/>';
			_RIEPILOGO_OFFER['x_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['x_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];

			//console.log(JSON.stringify(_RIEPILOGO_OFFER));
		}

	}

	//alert("aaa " + _RIEPILOGO_OFFER['annuale_price'] + "," + _RIEPILOGO_OFFER['mensile_price']);

	$('#riepilogo').css('display', 'inline-block');
	$('.prezzo_abbo_anno').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['annuale_price'] /*p_offerta.offerPrice*/ ));
	$('.prezzo_abbo_mese').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['mensile_price'] /*p_offerta.offerPrice*/ ));
	$('#prodotto_riepilogo').text(p_product_detail.productName);
	$('.abbo_mensile_text').html(_RIEPILOGO_OFFER['mensile_descr']);
	$('.abbo_annuale_text').html(_RIEPILOGO_OFFER['annuale_descr']);
}

function popupRiepilogoAnnulla() {
	$('#riepilogo').css('display', 'none');

}

function riepilogoProcedi() {
	var p_product_detail = _RIEPILOGO_PRODUCT;
	var p_offerta = _RIEPILOGO_OFFER;

	//alert('aaaa'+$('#riepilogo input[name=id_abbonamento]'));
	if ($('#riepilogo input[name=id_abbonamento]').attr('checked')) {
		console.log('hai selezionato ' + (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0 ? 'Ricorrrente' : 'One shot'));

		//Link se è ricorrente o oneshot
		if (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0) {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['mensile_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['mensile_url'];
			console.log('ricorrente ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'Ricorrrente' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		} else {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['annuale_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['annuale_url'];
			console.log('oneshot ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'One shot' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		}
		$('#riepilogo').css('display', 'none');
	} else {
		alert('Nessuna selezione');
	}
}

/******************************************************
 Gestione schermata di registrazione
 ******************************************************/
var _REGISTRAZIONE_ISCROLL = null;

function popupRegistrazioneApri() {
	if (_LockTap) return;
	_LockTap = true;

	// Inizializzazione dei vari campi della registrazione
	$('#registrazione #id_username').val('');
	$('#registrazione #id_password').val('');
	$('#registrazione #id_password_confirm').val('');
	$('#registrazione #id_email').val('');
	$('#registrazione #id_consenso_privacy').attr('checked', false);
	$('#registrazione #id_consenso_email').attr('checked', false);
	$('#registrazione #id_consenso_societa').attr('checked', false);
	$('#registrazione #id_consenso_privacy').change();
	$('#registrazione #id_consenso_email').change();
	$('#registrazione #id_consenso_societa').change();
	$('#registrazione_senza_email').css('display', 'inline-block');
	$('#registrazione_con_email').css('display', 'none');

	$('#registrazione').css('display', 'inline');

	if (_REGISTRAZIONE_ISCROLL == null) {
		_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
			bounce : false
		});
	} else {
		_REGISTRAZIONE_ISCROLL.refresh();
	}

	//Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
	$('#registrazione #id_email').unbind();
	$('#registrazione #id_email').keyup(function() {
		console.log('keyup');
		if ($('#registrazione #id_email').val() != '') {
			$('#registrazione_senza_email').css('display', 'none');
			$('#registrazione_con_email').css('display', 'inline-block');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();

			if (_REGISTRAZIONE_ISCROLL == null && _ORIENTATION == 'H') {
				_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
					bounce : false
				});
				_REGISTRAZIONE_ISCROLL.refresh();
			}
		} else {
			$('#registrazione_senza_email').css('display', 'inline-block');
			$('#registrazione_con_email').css('display', 'none');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();
		}
	});
	setTimeout(function() { _LockTap = false; }, 500);
}

function popupRegistrazioneChiudi() {
	//$('#registrazione').fadeOut();
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAnnulla() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneIndietro() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAvanti() {
	if (controlloDatiRegistrazione()) {

		// Definizione del profilo utente
		var l_username = $('#registrazione #id_username').val();
		var l_password = $('#registrazione #id_password').val();
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : l_username,
			"password" : l_password
		};

		var l_user_email = $('#registrazione #id_email').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#registrazione #id_consenso_privacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#registrazione #id_consenso_email').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#registrazione #id_consenso_societa').attr('checked') == "checked" ? '1' : '0');
		}

		var l_req_headers = {
			"appKey" : _API24_APPKEY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceName" : device.name,
			"deviceID" : device.uuid,
			"deviceType" : device.platform,
			"profile" : l_user_profile
		};
		console.log('---REQ---> createUser (' + l_username + ')');
		console.log(l_req_headers);
		console.log(l_req_data);
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Registrazione in corso..."]);
		$.ajax({
			type : "POST",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/createUserEDOI",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(res) {
				if ( typeof res == "string") {
					res = $.parseJSON(res);
				}

				console.log('---RESP--> createUser (' + l_username + ')');
				console.log(res);

				if (!res.Success) {
					//navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification", "activityStop", []);
					//Gestione messaggi di errore dal server
					if (res.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Uno o più campi inseriti non sono validi.', 'Registrazione');
					} else if (res.Exception.Name == 'ExistingUserException') {
						abutils.alert('Lo username è già utilizzato.', 'Registrazione');
					} else {
						//alert('Attenzione, ' + res.Exception.Description);
						abutils.alert(res.Exception.Description, 'Registrazione');
					}
				} else {
					if (l_user_email == '') {
						abutils.alert("L'indirizzo email ti verrà richiesto al primo accesso al nostro sito web.", 'Registrazione completata');
					} else {
						abutils.alert("Ti abbiamo inviato una mail per attivare la tua utenza anche per il nostro sito web.", 'Registrazione completata');
					}
					eseguiLogin(l_username, l_password);
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				abutils.alert('Si è verificato un errore durante la registrazione.', 'Registrazione');
			}
		});
	}
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in particolare:
 *  - la username non deve contenere caratteri speciali
 *  - le password devono coincidere e non devono avere caratteri speciali
 *  - l'indirizzo email, se presente, deve essere un indirizzo valido
 *  - l'utente deve acconsentire al trattamento dei dati personali in caso di presenza dell'indirizzo email
 */
function controlloDatiRegistrazione() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	var ck_username = /^[A-Za-z0-9_]{3,20}$/;
	/* Min 3 max 20 caratteri */
	var ck_password = /^[A-Za-z0-9!@#$%^*()_]{8,20}$/;
	/* Min 8 max 20 caratteri senza / \ e & */
	// Controllo username
	username = $('#registrazione #id_username').val();
	if (!ck_username.test(username)) {
		abutils.alert('Lo username non può contenere spazi e caratteri speciali. Deve essere lunga tra i 3 ed i 20 caratteri', 'Registrazione');
		return false;
	}

	// Controlli password
	password = $('#registrazione #id_password').val();
	if (password == '') {
		abutils.alert('La password è obbligatoria.', 'Registrazione');
		return false;
	}
	if (!ck_password.test(password)) {
		abutils.alert('La password inserita non è valida.', 'Registrazione');
		return false;
	}
	password_confirm = $('#registrazione #id_password_confirm').val();
	if (password_confirm != password) {
		abutils.alert('Le password inserite non coincidono.', 'Registrazione');
		return false;
	}

	// Controllo email
	email = $('#registrazione #id_email').val();

	// email obbilgatoria
	if (email == '') {
		abutils.alert("L'indirizzo email è obbligatorio.", 'Registrazione');
		return false;
	}

	if (email != '' && !ck_email.test(email)) {
		abutils.alert("L'indirizzo email inserito non è valido.", 'Registrazione');
		return false;
	}

	//console.log('aaa'+$('#registrazione input[name=id_consenso_privacy]').attr('checked'));
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#registrazione input[name=id_consenso_privacy]').attr('checked')) {
		abutils.alert("Per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Registrazione');
		return false;
	}

	return true;
}

/******************************************************
 Gestione popup di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per la login
 * @params p_username Parametro opzionale con il quale inizializzare il campo username
 *         p_force Se impostato a true forza l'utente a non poter uscire dalla login se non attraverso l'effettuazione della login stessa
 */
var _POPUP_LOGIN_USERNAME = null;

function popupLogin(p_username, p_force) {
	if (_LockTap) return;
	_LockTap = true;
	//alert('bbb');
	_POPUP_LOGIN_USERNAME = p_username;

	//Inizializza lo username se questo viene passato come parametro
	if (p_username) {
		$('#login #id_username').val(p_username);
		$('#login #login_body_message').text(p_username);
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'none');
		$('#login #id_password').val('');
	} else {
		$('#login #id_username').val('');
		$('#login #login_body_message').text('');
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'inline-block');
		$('#login #id_password').val('');
	}

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#login_back_button').css('visibility', 'hidden');
	} else {
		$('#login_back_button').css('visibility', 'visible');
	}
	//$('#riepilogo').css('visibility', 'hidden');
	$('#login').css('display', 'inline');
	
	$('select').attr('disabled', 'disabled');
	
	setTimeout(function() { _LockTap = false; }, 500);
}

function popupLoginChiudi() {
	//$('#login').fadeOut();
	$('#login').css('display', 'none');
	$('#login_body_message').text('');
	
	$('select').removeAttr('disabled');
}

function popupLoginIndietro() {
	//$('#login').fadeOut();
	_NEXT_ACTION = null;
	$('#login').css('display', 'none');

	if (_POPUP_LOGIN_USERNAME != null) {
		// procedo ad una disassociazione del dispositivo
		disassociazioneSilenziosa(_POPUP_LOGIN_USERNAME);
	}
	
	$('select').removeAttr('disabled');
}

function disassociazioneSilenziosa(p_username) {
	if (p_username == null) {
		p_username = _USERNAME;
	}
	var l_request_data = {
		"username" : p_username, //_USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	var l_req_headers = {
		"appKey" : _API24_APPKEY //,
		//"userIdentity": _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice Silent Login');
	console.log(l_req_headers);
	console.log(l_request_data);

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice Silent Login');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {

			} else {

			}

		},
		error : function() {

		}
	});
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupLoginAvanti() {
	if (controlloDatiLogin()) {
		var l_username = $('#login #id_username').val();
		var l_password = $('#login #id_password').val();
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Login in corso..."]);
		_EDICOLA_LAST_PRODUCT_LOAD = 0;
		eseguiLogin(l_username, l_password);
	}
}

/**
 * Esegue la chiamata di login verso il server
 */
function eseguiLogin(p_username, p_password, p_silent) {
	console.log('---REQ---> userLogin (' + p_username + ')');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"siteCode" : _API24_SITECODE,
		"username" : p_username,
		"password" : p_password
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/userLogin",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			setUserData(null, null, null);

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> userLogin');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {
				// procedo ad una associazione
				associaDevice(p_username, p_password, p_response.Result.res, p_silent);
				popupAcquistoRegistrazioneClose();
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				popupAcquistoRegistrazioneClose();
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// errore in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - login: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					// errore da mostrare
					abutils.alert('Si è verificato un errore durante la login. ' + l_exc_descr, 'Login');
				}

			}
		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - login: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare la login. Riprovare tra poco.', 'Login');
			}
		}
	});
}

/**
 * Associa l'utente al dispositivo
 */
function associaDevice(p_username, p_password, p_useridentity, p_silent) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : p_useridentity //_USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceName" : device.name,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : p_username //_USERNAME
	};

	console.log('---REQ---> associauserdevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "POST",
		cache : false,
		contentType : "application/json; charset=utf-8",
		//url: _API24_ENDPOINT + "Users/addUserDevice",
		url : _SOLEGW_ENDPOINT + "associauserdevice.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> associauserdevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, associaDevice) || (p_response.Exception.Name == 'UserDeviceRelationException')) {
				setUserData(p_username, p_password, p_useridentity);
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				if (p_silent) {
					onDeviceReady_aux();
				} else {
					popupLoginChiudi();
					popupRegistrazioneChiudi();
					gestisciProssimaAzione();
				}
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				//Gestione eccezioni
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// exception in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - associauserdevice: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					console.log('associaDevice EXCEPTION ' + p_response.Exception.Name + ': ' + p_response.Exception.Description);
					if ((p_response.Exception.Name != 'UserDeviceRelationException') && (p_response.Exception.Name != 'ExpiredUserIdentityException')) {
						abutils.alert(p_response.Exception.Description, 'Associazione device');
					}
				}

			}

		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - associauserdevice: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare l\'associazione del device. Riprovare tra poco.', 'Login');
			}
		}
	});
}

function controlloDatiLogin() {
	username = $('#login #id_username').val();
	if (username == '') {
		abutils.alert('Attenzione, lo username è obbligatorio.', 'Login');
		return false;
	}

	// Controlli password
	password = $('#login #id_password').val();
	if (password == '') {
		abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
		return false;
	}

	return true;
}

/******************************************************
 Gestione schermata di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per il controllo della password
 * @params p_force Se impostato a true forza l'utente a non poter annullare il controllo password
 */
function popupControlloPassword(p_force) {

	//Inizializza lo username
	$('#controllo_password #controllo_password_account_username').text(_USERNAME);
	$('#controllo_password #id_password').val('');

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#controllo_password_back_button').css('visibility', 'hidden');
	} else {
		$('#controllo_password_back_button').css('visibility', 'visible');
	}

	$('#controllo_password').css('display', 'inline');
	
	$('select').attr('disabled', 'disabled');
}

function popupControlloPasswordChiudi() {
	//$('#controllo_password').fadeOut();
	$('#controllo_password').css('display', 'none');
	
	$('select').removeAttr('disabled');
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupControlloPasswordAvanti() {
	if ($('#controllo_password #id_password').val() != _USER_PASSWORD) {
		abutils.alert('La password non è corretta', 'Attenzione');
	} else {
		popupControlloPasswordChiudi();
		gestisciProssimaAzione();
	}
}

/******************************************************
 Gestione memorizzazione locale username
 ******************************************************/
/**
 * Elimina lo username dell'utente dal local storage
 */
function deleteUsername() {
	window.localStorage.removeItem("username");
}

/**
 * Memorizza lo username dell'utente nel local storage
 * @params p_username Lo username che deve essere memorizzato
 */
function storeUsername(p_username) {
	window.localStorage.setItem("username", p_username);
}

/**
 * Legge lo username dell'utente da local storage
 * @returns String Lo username dell'utente
 */
function getUsername() {
	return window.localStorage.getItem("username");
}

/******************************************************
 Gestione memorizzazione locale password
 ******************************************************/
/**
 * Elimina la password dell'utente dal local storage
 */
function deletePassword() {
	window.localStorage.removeItem("password");
}

/**
 * Memorizza la password dell'utente nel local storage
 * @params p_username La password che deve essere memorizzata
 */
function storePassword(p_password) {
	window.localStorage.setItem("password", p_password);
}

/**
 * Legge la password dell'utente da local storage
 * @returns String La password dell'utente
 */
function getPassword() {
	return window.localStorage.getItem("password");
}

/******************************************************
 Gestione controllo iniziale username
 ******************************************************/
/**
 * Controlla la presenza dello username nel local storage ed in caso controlla
 * che sia lo stesso username associato al dispositivo
 */
function controlloUsername() {
	var l_local_storage_username = getUsername();
	var l_local_storage_password = getPassword();
	console.log('Utente secondo IPAD: ' + l_local_storage_username);
	if (l_local_storage_username != null && l_local_storage_password != null) {
		// procedo direttamente alla login
		//setUserData(null, null, null);
		_NEXT_ACTION = onDeviceReady_aux;
		eseguiLogin(l_local_storage_username, l_local_storage_password, true);
		return;
	}

	// se non ci sono dati in locale chiedo l'eventuale utenza ad API24

	//console.log('Lettura utente associato al dispositivo');
	var l_signature = getSignature(device.uuid + ',' + device.platform);

	console.log('---REQ---> getUserFromDevice');
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	//Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserFromDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			console.log('---RESP--> getUserFromDevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				var l_api24_username = p_response.Result.res;
				console.log('Utente secondo API24: ' + l_api24_username);

				if (l_api24_username != '') {
					_NEXT_ACTION = loadProducts;
					popupLogin(l_api24_username);
					onDeviceReady_aux();
				} else {
					onDeviceReady_aux();
				}
			} else {
				// Gestione eccezioni
				//setUserData(null, null, null);
				onDeviceReady_aux();
				return;
			}
		},
		error : function() {
			//setUserData(null, null, null);
			onDeviceReady_aux();
			return;
		}
	});
}

function popupInformativaPrivacy() {
	//$('#informativa_privacy').fadeIn();
	if (_IMPOSTAZIONI_PROFILO_ISCROLL != null) {
		_IMPOSTAZIONI_PROFILO_ISCROLL.destroy();
		_IMPOSTAZIONI_PROFILO_ISCROLL = null;
	}
	// Viene mostrato il popup
	$('#informativa_privacy').css('display', 'inline');
	if (_IMPOSTAZIONI_ISCROLL_PRIVACY == null)
		_IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
}

function popupInformativaPrivacyClose() {
	//$('#informativa_privacy').fadeOut();
	$('#informativa_privacy').css('display', 'none');
	if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
		console.log("_IMPOSTAZIONI_PROFILO_ISCROLL is null");
		_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper');
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	}
}

/******************************************************
 Gestione inizializzazione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 10 * 1024 * 1024;
var _DB = null;
var _DBFAIL = false;

/**
 * Inizializza il database associato all'applicazione
 */
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	
	if (!window.openDatabase)
    	console.log("Error: can't open local database");
	if (!localStorage)
    	console.log("Error: localstorage not usable");
    try{
    	if(!_DB){
    		console.log("opendatabase "+_DB_NAME +"," + "1.0"+ ","+_DB_NAME+","+ _DB_SIZE);
			_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
		}
	}catch(exc){
		console.log('Errore database '+exc.message);
			setTimeout(function(){
				try{
					if (window.openDatabase){
						_DB = null;
						_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);//window.simulateDB.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
						//window.location.assign('index.html');
					}else{
						_DBFAIL = true;
						
						if(!window.infodroid.isfoglioopen()){
							 window.simulatePG.relaod();
						}
					}
				}catch(exc){
					console.log('Errore simDB database ' + exc.message);
					_DBFAIL = true;
					if(!window.infodroid.isfoglioopen()){
						 window.simulatePG.relaod();
					}
				}
			},500);
	}
	console.log("Inizializzazione database OK");
}

/**
 * Funzione di gestione degli erorri delle operazioni sul database
 */
function dbErrorHandler(p_error) {
	console.log("Error processing SQL: " + p_error);
}

/* -------------------- DOWNLOAD MANAGER ----------------------------------- */
/* ricordarsi di mettere la downloadManagerDBinit() nel deviceready-bodyload */

function downloadManagerDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK downloadManagerDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO downloadManagerDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS issues (id unique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, dttm)', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function addToDownloadQueue(testata, issue, edizione) {
	renderDownloadQueue(testata, issue, edizione);
	//PhoneGap.exec("DownloadManagerCommand.addIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.addIssueToDownloadQueue(null, null, testata, issue, edizione);
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}
	
	window.simulate.dbset('unread_message_sole', valoutput);
	window.soledownloader.launchDownload(testata, edizione, issue, "Descrizione" + window.localStorage.getItem('unread_message_sole'), "" + "aaaa", "false");
	console.log("queue!!!")
}

function getUnreadMessage(testata, edizione, issue) {
	var unread = window.localStorage.getItem('unread_message_sole');
	//alert('aunread is '+unread);
	if (unread != null)
		window.runfunc.retMessage(testata, edizione, issue, unread);
	else
		window.runfunc.retMessage(testata, edizione, issue, 0);
}

function renderDownloadQueue(testata, issue, edizione) {
	// Modifica pulsante
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	btn.show();
	if (btn) {
		$(btn).val('Annulla');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			//alert(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			setTimeout(function() {
				removeToDownloadQueue(testata, issue, edizione);
			}, 0);
			/*
			 setTimeout(function(){
			 window.soledelete.deleteIssue(testata, issue, edizione);
			 },1000);
			 */
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'visible';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
}

function removeToDownloadQueue(testata, issue, edizione) {
	//PhoneGap.exec("DownloadManagerCommand.removeIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.removeIssueToDownloadQueue(null, null, testata, issue, edizione);
	window.soledownloader.cancelDownload(testata, edizione, issue, "", "", true);
	console.log("remove queue t: " + testata + " ed: " + edizione + " iss: " + issue);

	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	if (btn) {
		$(btn).val('Salva in locale');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; ADD2 TO QUEUE " + testata + " " + issue + " " + edizione);
			addToDownloadQueue(testata, issue, edizione);
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
	
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSingleFileComplete(testata, issue, edizione, progress) {
	if (!$('#progressbar_status_' + testata + '_' + issue + '_' + edizione).length) return;
	
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	$('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).show();
	
	if ($('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).val().indexOf('Salva') != -1) {
		renderDownloadQueue(testata, issue, edizione);
	}

	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'royalblue';
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(10,43,128) 0%, rgb(99,151,255) 100%)';

	//alert("is "+progress);
	console.log("progress is " + progress);
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = parseInt(progress) + '%';
}

function downloadManagerCallbackSingleFileError(testata, issue, edizione, progress) {
	//alert('downloadManagerCallbackSingleFileError ' + issue);
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
}

function downloadManagerCallbackSetComplete(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	//alert('downloadManagerCallbackSetComplete ' + issue);
	if (document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione).className = 'qarchivio_container_box_txt_local_LIST';
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
	downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr);
	omnitureTrackApp('APP:download:complete:' + testata + ':' + issue + ':' + edizione, 'APP:download');
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	//alert('downloadManagerCallbackSaveIssueDb ' + issue);
	if (_DB) {
		var querySuccess = function() {
			console.log('OK SAVE LOCAL DB');
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);

			// togliere pulsante scarica e mostrare sfoglia
			var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
			if (btn) {
				$(btn).unbind();
				$(btn).removeClass('gray24');
				$(btn).removeClass('qarchivio_free_copy_btn');
				$(btn).addClass('red24');
				$(btn).val('Sfoglia');
				$(btn).bind('click', function() {
					console.log(";;;;;;;;;; SFOGLIA " + testata + " " + issue + " " + edizione);
					sfoglia(testata, issue, edizione);
					console.log("sfoglia archivio");
					window.loader.local(true);
				});
			}

			// aggiorna dettaglio prodotto se necessario
			refreshProductDetails();
		}
		var queryError = function(tx, p_error) {
			console.log('KO SAVE LOCAL DB ' + p_error.message);
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);
		}
		var executeQuery = function(tx) {
			var idunique = testata + '_' + issue + '_' + edizione;
			console.log('INSERT INTO issues: ' + idunique);
			//tx.executeSql('INSERT INTO issues VALUES("' + idunique + '", "' + testata + '", "' + testata_descr + '", "' + issue + '", "' + issue_descr + '", "' + edizione + '", "' + edizione_descr + '", DATETIME(\'NOW\'));', [], querySuccess, queryError);
			tx.executeSql('INSERT INTO issues VALUES(?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'));', [idunique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function downloadManagerCallbackSetError(testata, issue, edizione) {
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'red';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '100%';
		 */
	}
	if (document.getElementById('stop_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('stop_' + testata + '_' + issue + '_' + edizione).style['display'] = 'none';
	if (document.getElementById('download_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('download_' + testata + '_' + issue + '_' + edizione).style['display'] = 'inline-block';
}

/* ------------------------- FINE DOWNLOAD MANAGER ---------------------- */

/******************************************************
 Gestione popup accedi/registrati
 ******************************************************/
function popupAccediRegistrati() {
	$('#accedi_registrati_menu').css('display', 'inline-block');
}

function popupAccediRegistratiChiudi() {
	$('#accedi_registrati_menu').css('display', 'none');
}

function popupAccediRegistratiAnnulla() {
	$('#accedi_registrati_menu').css('display', 'none');
	_NEXT_ACTION = null;
}

/******************************************************
 Ajax COMMONS
 ******************************************************/
/**
 * Gestisce il controllo del risultato proveniente dalle richieste Ajax.
 * Le risposte devono essere in formato JSON ed avere almeno l'attributo Success ed eventuali eccezioni.
 * @params p_result La risposta proveniente dal server
 * @returns Boolean False in caso di errori, True in caso di successo
 */
function checkAjaxResponse(p_response, p_callback) {
	if ( typeof p_response == "string") {
		p_response = $.parseJSON(p_response);
	}
	if (p_response.Success) {
		//console.log('Check ajax response OK');
		//console.log(p_response);
		return true;
	} else {
		console.log('Check ajax response KO: [' + p_response.Exception.Name + '] ' + p_response.Exception.Description);
		if (p_response.Exception.Name == 'ExpiredUserIdentityException') {
			if (_USERNAME == null && _USER_PASSWORD == null) {
				console.log('WARNING username e/o password non settati, impossibile procedere al rinnovo della useridentity');
				setUserData(null, null, null);
				return false;
			}
			console.log('GESTIONE ExpiredUserIdentityException');
			console.log('---REQ---> userLogin4ExpiredUserIdentityException(' + _USERNAME + ')');
			var l_username = _USERNAME;
			var l_user_password = _USER_PASSWORD;
			var l_req_headers = {
				"appKey" : _API24_APPKEY
			};
			var l_req_data = {
				"siteCode" : _API24_SITECODE,
				"username" : l_username,
				"password" : l_user_password
			};
			console.log(l_req_headers);
			console.log(l_req_data);
			// resetto username e password
			/*
			 _USERNAME = null;
			 _USER_PASSWORD = null;
			 */
			setUserData(null, null, null);

			$.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/userLogin",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					if ( typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> userLogin4ExpiredUserIdentityException');
					console.log(p_response);

					if (checkAjaxResponse(p_response)) {
						setUserData(l_username, l_user_password, p_response.Result.res);
						if (p_callback != null)
							p_callback.call();
						else
							console.log('WARNING userLogin4ExpiredUserIdentityException completata, ma manca la callback');
					} else {
						console.log('WARNING userLogin4ExpiredUserIdentityException error');
					}
				},
				error : function() {
					console.log('WARNING userLogin4ExpiredUserIdentityException timeout');
				}
			});
		}
		return false;
	}
}

/**
 * Callback generica per la gestione degli errori di comunicazione verso le API24
 */
function ajaxErrorHandler(xmlHttpRequest, textStatus, errorThrown) {
	console.log('Ajax error: ' + textStatus);
	//enableOfflineMode();
}

/**
 * Inizializza il controllo per la gestione online/offline
 */
var _OFFLINE_COUNTER = null;
//var _PING_COUNTER = 0;
function testConnectionWorker() {
	//_PING_COUNTER++;
	if (_OFFLINE_COUNTER == null)
		_OFFLINE_COUNTER = 1;
	// al primo avvio il primo risultato è quello buono

	console.log('---REQ---> PING');
	
// 	var l_req_headers = {
// 		"appKey" : _API24_APPKEY
// 	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	//console.log(l_req_headers);
	//console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT_PING,
		//headers : l_req_headers,
		data : l_req_data,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + 'ping.json',
		dataType : "json",
		beforeSend: function (request) {
			request.setRequestHeader("appKey", _API24_APPKEY);
		},
		success : function(p_response) {
			//console.log('---RESP--> PING');
			console.log(p_response);
			try {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				if (checkAjaxResponse(p_response) && (p_response.Result.res.statusCode == 0)) {
					enableOnlineMode();
					_OFFLINE_COUNTER = 0;
				} else {
					_OFFLINE_COUNTER++;
					if (_OFFLINE_COUNTER >= 2) {
						enableOfflineMode();
					}
				}
			} catch (exc) {
				//console.log('errore formato risposta');
				_OFFLINE_COUNTER++;
				if (_OFFLINE_COUNTER >= 2) {
					enableOfflineMode();
				}
			}
		},
		error : function() {
			//console.log('ajax error');
			_OFFLINE_COUNTER++;
			if (_OFFLINE_COUNTER >= 2) {
				enableOfflineMode();
			}
		}
	});
}

function initCheckOnline() {
	testConnectionWorker();
	setInterval(function() {
		testConnectionWorker();
	}, _INTERVALLO_CHECK_ONLINE);
}

/**
 * Gestisce l'esecuzione della prossima azione. Alcune volte al termine delle azioni su una popup è necessario
 * eseguire un azione. Per fare ciò viene impostata la variabile _NEXT_ACTION alla funzione che deve essere richiamata.
 * La seguente funzione controlla che ci sia una prossima azione ed in caso la esegue.
 */
function gestisciProssimaAzione() {
	//Se la variabile _NEXT_ACTION è inizializzata chiama la funzione associata
	if (_NEXT_ACTION && typeof _NEXT_ACTION == "function") {
		var l_next_action = _NEXT_ACTION;
		_NEXT_ACTION = null;
		l_next_action.call();
	}
}

/* --------- gestione bottoni appmenu -------------------- */
function appmenuButtonReset() {
	$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
	$('#appmenu_edicola').removeClass('appmenu_edicola_on');
	$('#appmenu_preferiti').removeClass('appmenu_preferiti_on');
	$('#appmenu_inbox').removeClass('appmenu_inbox_on');
	$('#appmenu_impostazioni').removeClass('appmenu_impostazioni_on');
}

function appmenuSfoglioOpen() {
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
	var l_ret = openFlipper();
	if (!l_ret) {
		$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
		abutils.alert('Nessuna pubblicazione è ancora stata aperta.', 'Sfoglia');
		return;
	}
	appmenuButtonReset();
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
}

function appmenuEdicolaOpenWithIndice(testata, edizione) {
	appmenuEdicolaOpen(true);
	try {
		var l_product_id = _HASH_MAP_TESTATA_PRODUCTID[testata];
		console.log(testata + ' ---> ' + l_product_id);
		if (l_product_id == null)
			return;
		//qarchivioOpen(l_product_id, true, edizione);
		if (l_product_id == _CODICE_PRODOTTO_QUOTIDIANO)
			qarchivioOpen(l_product_id, true, edizione);
		else
			archivioOpen(l_product_id, true);
	} catch (exc) {

	}
}

function appmenuEdicolaOpen(skipFlipper) {

	if (!skipFlipper && _CURRENT_FLIPPER_TESTATA != null && _CURRENT_FLIPPER_ISSUE != null && _CURRENT_FLIPPER_EDIZIONE != null) {
		openFlipper();
		setTimeout(function() {
			appmenuEdicolaOpen(true);
		}, 2000);
		return;
	}

	if (_MOD_OFFLINE != true) {
		loadProducts();
	}

	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(0px, 0px, 0)');

	$('#edicola_titolo_btn_select').removeAttr('disabled');

	omnitureTrackApp("APP:edicola", "APP:edicola");
	nielsenCall('EDICOLA');
}

function appmenuPreferitiOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	preferitiLoadMenuProdotto();
	appmenuButtonReset();
	$('#appmenu_preferiti').addClass('appmenu_preferiti_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-3000px, 0px, 0)');

	omnitureTrackApp("APP:preferiti", "APP:preferiti");
	nielsenCall('PREFERITI');
}

function appmenuInboxOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	$('#appmenu_inbox').addClass('appmenu_inbox_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-6000px, 0px, 0)');

	omnitureTrackApp("APP:inbox", "APP:inbox");
	nielsenCall('INBOX');
}

function appmenuImpostazioniOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	impostazioniInizializza();
	impostazioniOpen();
	$('#appmenu_impostazioni').addClass('appmenu_impostazioni_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-9000px, 0px, 0)');

	omnitureTrackApp("APP:impostazioni", "APP:impostazioni");
}

/* ----------------------------------------------------------------- */
function injectAutoLogin(username, password) {
	if (username == null || password == null)
		return "KO";
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

	_NEXT_ACTION = function() {
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

		setTimeout(function() {
			window.location = 'galaxy.html';
		}, 1000);
	}
	eseguiLogin(username, password);

	return "OK";
}

function checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback) {
	console.log('--->checkAcquisto');
	if (p_prodotto24 == '1') {
		//android workaround temporaneo
		p_prodotto24 = 'a1';
	}

	var local = window.verify.Local(_MAP_CODICE_TESTATA[p_prodotto24 + ''], p_issue, p_edizione);
	console.log("local is " + local);
	if (local == '1') {
		if (callback && typeof callback == "function") {
			console.log("aaaa passsq");
			callback.call();
			return;
		}
	}
	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"date" : p_issue
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> checkAcquisto(' + p_prodotto24 + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "checkacquisto/" + p_prodotto24 + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> checkAcquisto(' + p_prodotto24 + ')');
			console.log('checkAcquisto resp ' + /*JSON.stringify(*/p_response /*)*/ );

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback);
			})) {
				console.log('check ' + p_response.Result.res);

				if (p_response.Result.res && p_response.Result.res.checkAcquisto && (p_response.Result.res.checkAcquisto == true)) {
					//navigator.notification.confirm('Hai già acquistato questa edizione: il nuovo download è gratuito.', function(button){
					if (callback && typeof callback == "function") {
						console.log("Aquisto-->pass to func");
						callback.call();
					}
					//}, 'Acquisto non necessario', 'Ok');
				} else {
					//appstoreBuy(id_shopping24, id_itunes, callback);
					//BUY-----------------------------------------------------------------------------------------

					console.log('buy');
					console.log("aaaa passsq1");
					var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
					var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
					var link_singola = '';
					console.log('productId ' + productId);
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
					// prova con i link
					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}
					}

					if (link_singola != '') {
						window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				}
			} else {
				if (p_response.Exception.Name == 'ExpiredUserIdentityException')
					return;
				//appstoreBuy(id_shopping24, id_itunes, callback);
				//BUY---------------------------------------------------------------------------------------------
				console.log('buy');
				console.log("aaaa passsq2");
				var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
				var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];

				var link_singola = '';
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}

				// prova con i link
				if (!link_singola || link_singola == '') {
					_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
				}
				if (link_singola != '') {
					window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
				} else {
					abutils.alert('Errore su link!', 'Pagamento');
				}
			}
		},
		error : function() {
			//appstoreBuy(id_shopping24, id_itunes, callback);
			//BUY-------------------------------------------------------------------------------------------------
			console.log('buy');
			console.log("aaaa passsq3");
			var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
			var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
			var link_singola = '';
			for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
				if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
				}
			}
			// prova con i link
			if (!link_singola || link_singola == '') {
				_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}
			}
			if (link_singola != '') {
				window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
			} else {
				abutils.alert('Errore su link!', 'Pagamento');
			}
		}
	});
}/**
 * @author ABertacco, MConventi
 */
var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;
var _PREFERITI_ISCROLL_MENU = null;
var _PREFERITI_ISCROLL_VISTA = null;
var _PREFERITI_ISCROLL_DETTAGLIO = null;

// Lista di prodotti da inserire nel menu di sinistra tra i prodotti
/* viene calcolata in base agli articoli presenti in db
 var _PREFERITI_PRODUCTS_LIST = [
 {
 testata: 'S24',
 nome: "Il Sole 24 ORE",
 icon: 'imgs/fake/s24_small_icon.png'
 }
 ];
 */
var _PREFERITI_PRODUCTS_LIST = null;


function preferitiLoadMenuTag(){
    preferitiLoadMenu('TAG');
}

function preferitiLoadMenuProdotto(){
    preferitiLoadMenu('PRODOTTO');
}

function preferitiLoadMenu(mode){
    $('#preferiti_titolo_menu_opzioni_prodotto').removeClass('newgray24');
    $('#preferiti_titolo_menu_opzioni_tag').removeClass('newgray24');
    $('#preferiti_body_menu_container').empty();
    
    if (_PREFERITI_ISCROLL_MENU != null) {
        _PREFERITI_ISCROLL_MENU.destroy();
        _PREFERITI_ISCROLL_MENU = null;
    }
    
    if (mode == 'PRODOTTO') {
        $('#preferiti_titolo_menu_opzioni_prodotto').addClass('newgray24');
        preferitiInitProductList();
    }
    else {
        $('#preferiti_titolo_menu_opzioni_tag').addClass('newgray24');
        preferitiInitTagList();
    }
    
}


	function searchPref(search) {
		console.log('search is '+search);
		
		/*
		db.transaction(function(tx) {
    		tx.executeSql("SELECT id FROM table LIMIT 1", [], function(tx, result) {
      			row = result.rows.item(0);
    		}, function(tx, error) {
    		});
  		});

  		return row;

		 */
		if(search == null)
			return;
		
		if(_DB){
			_DB.transaction(function(tx) { 
				//'occhiello text, titolo text, sottotitolo text, firma text, testo text';
				var l_query = 'occhiello like ? OR titolo like ? OR sottotitolo like ? OR firma like ? OR testo like ?';
				var tmpsearch = search.split(' ');
				var s = '';
				// GLOBAL REPLACE
				// DA FARE
				var args = new Array(tmpsearch.length * 5);
				for(var i = 0; i < tmpsearch.length; i++){
					   if(i > 0)
						   l_query += " OR " + l_query;
					   s = tmpsearch[i];//"4,250%";
					   s = s.replace(/%/g, "\\%");
					   s = s.replace(/_/g, "\\_");
					   s = s.replace(/&rsquo;/g,"\'");
					   s = s.replace(/&quot;/g,"\"");
					   s = "%" + s + "%";
					   for(var j = i*5; j < (i+1)*5; j++)
						   args[j] = s;
					   console.log("search2323 selec "+s);
				   }
				search = "%"+search+"%";
	            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE ' + l_query + " escape '"+"\\"+"' order by issue DESC, pagina ;" , args, function(tx, p_results) {
		            var row = null;
		            if(p_results != null && p_results.rows.length != 0){
		            	for(var irow = 0; irow < p_results.rows.length; irow++){
			            	row = p_results.rows.item(irow);
			            	//console.log("testo[0] "+row.testo);
			            	//'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
			            	window.searchlaunch.addResult(row.artid, row.testata, row.testata_descr, row.issue, row.issue_descr, row.edizione, row.edizione_descr,row.sezione, row.pagina, row.occhiello, row.titolo, row.sottotitolo, row.firma, row.testo);
			            	row = null;
		            	}
		            	
		            	window.searchlaunch.broadcastResult();
		            }else{
		            	console.log('search res '+p_results);
		            	window.searchlaunch.broadcastResult();
		            }
	            	
	            }, function(tx, error) {
	            	alert(error);
	            });
	            
			});
		       
	        //_DB.transaction(querySearch);
	 
		}
	}



	function getArticleFromId(artid){
		if(_DB){
			_DB.transaction(function(tx) { 

				tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid = ? ;' , [artid], function(tx, p_results) {
		            var row = null;
		            if(p_results != null && p_results.rows.length != 0){
		            	preferitiDettaglio(p_results.rows.item(0));
		            }else{
		            	console.log('search res '+p_results);
		            }
	            	
	            }, function(tx, error) {
	            	alert(error);
	            });
	            
			});
		
		}	
	}
	
/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('preferiti_body_vista_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            preferitiDettaglio(p_article);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(e){
        e.stopPropagation();
        
    		if (_LockTap) return;
    		_LockTap = true;
    		
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        } else if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
         	l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
         }
        
			setTimeout(function() { _LockTap = false; }, 500);
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.appendChild(document.createTextNode(p_article.titolo));
    title = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei prodotti in base ai dati inseriti in _PREFERITI_PRODUCTS_LIST
 */
function preferitiInitProductList(){
    /*
     for (var i=0; i < _PREFERITI_PRODUCTS_LIST.length; i++){
     preferitiMenuRenderProduct(_PREFERITI_PRODUCTS_LIST[i]);
     }
     if (_PREFERITI_ISCROLL_MENU == null) {
     _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
     } else {
     _PREFERITI_ISCROLL_MENU.refresh();
     }
     */
    _PREFERITI_PRODUCTS_LIST = [];
    
    if (_DB) {
        var querySuccess = function(tx, p_results){
        
            if (p_results.rows.length == 0) {
                document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
            }
            
            for (var i = 0; i < p_results.rows.length; i++) {
                var l_row = p_results.rows.item(i);
                preferitiMenuRenderProduct({
                    testata: l_row.testata,
                    nome: l_row.testata_descr,
                    icon: 'imgs/fake/s24_small_icon.png' // icona indipendente dalla testata
                });
            }
            
            if (_PREFERITI_ISCROLL_MENU == null) {
                _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
            }
            else {
                _PREFERITI_ISCROLL_MENU.refresh();
            }
			
			if (p_results.rows.length > 0) {
                // apro il primo elemento nel menu
				//preferitiLoadArticlesByProduct(p_results.rows.item(0).testata);
				$('#preferiti_body_menu_container_box_id_' + p_results.rows.item(0).testata.replace(/[^a-zA-Z0-9]+/g,'')).click();
            }
        }
        
        var queryError = function(p_error){
            console.log("preferitiInitProductList: Error processing SQL: " + p_error.message);
            document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            var l_query = 'SELECT testata, testata_descr FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' GROUP BY testata, testata_descr ORDER BY testata_descr';
            tx.executeSql(l_query, [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Crea un elemento prodotto nel menu a sinistra della finestra dei preferiti
 * @params p_product Oggetto tag così come presente in _PREFERITI_PRODUCTS_LIST
 */
function preferitiMenuRenderProduct(p_product){

    var box = document.createElement('div');
    document.getElementById('preferiti_body_menu_container').appendChild(box);
    box.className = 'preferiti_body_menu_container_box';
	box.id = 'preferiti_body_menu_container_box_id_' + p_product.testata.replace(/[^a-zA-Z 0-9]+/g, '');
    
    box.appendChild(document.createTextNode(p_product.nome));
    
    var icon = document.createElement('img');
    box.appendChild(icon);
    icon.className = 'preferiti_body_menu_container_box_icon';
    icon.src = p_product.icon;
    
    box.onclick = (function(){
        preferitiLoadArticlesByProduct(p_product.testata);
        
        $('.preferiti_body_menu_container_box').removeClass('preferiti_body_menu_container_box_active');
        $(this).addClass('preferiti_body_menu_container_box_active');
    });
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei tag attualmente nel database dei preferiti
 */
function preferitiInitTagList(){

    // Inizializza la lista dei tag nel menu di sinistra
    if (_DB) {
        var querySuccess = function(tx, p_results){
        
            if (p_results.rows.length == 0) {
                document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
            }
            
            for (var i = 0; i < p_results.rows.length; i++) {
                preferitiMenuRenderTag(p_results.rows.item(i));
            }
            
            if (_PREFERITI_ISCROLL_MENU == null) {
                _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
            }
            else {
                _PREFERITI_ISCROLL_MENU.refresh();
            }
			
			if (p_results.rows.length > 0) {
                // apro il primo elemento nel menu
				$('#preferiti_body_menu_container_boxtag_id_' + p_results.rows.item(0).nome.replace(/[^a-zA-Z0-9]+/g,'')).click();
            }
        }
        
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
            //var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM '+_PREFERITI_TAG_DB_NAME+' GROUP BY nome ORDER BY num_articles';
            var l_query = 'SELECT nome FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY nome';
            tx.executeSql(l_query, [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Crea un elemento tag nel menu a sinistra della finestra dei preferiti
 * @params p_tag Oggetto tag così come presente nel db _PREFERITI_TAG_DB_NAME
 */
function preferitiMenuRenderTag(p_tag){
    var box = document.createElement('div');
    document.getElementById('preferiti_body_menu_container').appendChild(box);
    box.className = 'preferiti_body_menu_container_boxtag';
	box.id = 'preferiti_body_menu_container_boxtag_id_' + p_tag.nome.replace(/[^a-zA-Z0-9]+/g,'');
    box.appendChild(document.createTextNode(p_tag.nome));
    
    var icon = document.createElement('div');
    box.appendChild(icon);
    icon.className = 'preferiti_body_menu_container_boxtag_icon';
    
    box.onclick = (function(){
    
        preferitiLoadArticlesByTag(p_tag.nome);
        
        //Setta il tag attivo nel menu di sinistra
        $('.preferiti_body_menu_container_boxtag').removeClass('preferiti_body_menu_container_boxtag_active');
        $('.preferiti_body_menu_container_boxtag_icon').removeClass('preferiti_body_menu_container_boxtag_icon_active');
        $(this).addClass('preferiti_body_menu_container_boxtag_active');
        var icon = this.querySelector('div.preferiti_body_menu_container_boxtag_icon');
        if (icon != null) {
            $(icon).addClass('preferiti_body_menu_container_boxtag_icon_active');
        }
    });
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles.item(i));
    }
    
    if (_PREFERITI_ISCROLL_VISTA == null) {
        _PREFERITI_ISCROLL_VISTA = new iScroll('preferiti_body_vista_wrapper');
    }
    else {
        _PREFERITI_ISCROLL_VISTA.refresh();
        //alert('aaaaa');
        _PREFERITI_ISCROLL_VISTA.scrollTo(0, -2, 0);
    }
}

/**
 * Passa alla modalità modifica preferiti
 */
function preferitiSwitchToModifyView(){
    $('#preferiti_list_modify_button').hide();
    $('#preferiti_list_show_button').show();
    $('#preferiti_body_vista_container').addClass('preferiti_modify_view');
    $('.preferiti_body_vista_container_box_status').fadeIn();
    $('#elimina_preferiti').fadeIn();  
}

/**
 * Passa alla modalità visualizza preferiti
 */
function preferitiSwitchToShowView(){
   $('#preferiti_list_show_button').hide();
   $('#preferiti_list_modify_button').show();
   $('.preferiti_body_vista_container_box_status').hide();
   
	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	l_selected_items.removeClass('preferiti_body_vista_container_box_status_selected');
	l_selected_items.addClass('preferiti_body_vista_container_box_status_unselected');

   $('#preferiti_body_vista_container').removeClass('preferiti_modify_view');
   $('#elimina_preferiti').fadeOut();
}



/******************************************************
 Gestione eliminazione preferiti
 ******************************************************/
/**
 * Elimina i record selezionati in modalità modifica
 */
function preferitiDeleteArticles(){
    var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
    var l_items = '';
    
    for (var i = 0; i < l_selected_items.length; i++) {
        var l_pid = l_selected_items[i].id.substring(35);
        if (i > 0) 
            l_items += ',';
        l_items += '"' + l_pid + '"';
    }
    
    if (l_items != '') {
        deletePreferitiFromDB(l_items);
    }
    else {
        abutils.alert('Attenzione, non è stato selezionato nessun articolo', 'Preferiti');
    }
}

/*
 * Elimina i record dal database
 * @params p_artids Lista dei identificativi degli articoli
 */
function deletePreferitiFromDB(p_artids){

    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB && p_artids.length > 0) {
    
        var queryArticleSuccess = function(){
            console.log('Deleted preferiti ' + p_artids);
            deletePreferitiElements();
        }
        
        var queryTagSuccess = function(){
            console.log('Deleted tags ' + p_artids);
        }
        
        var queryError = function(p_error){
            console.log("deletePreferitiFromDB: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryArticleSuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryTagSuccess, queryError);
            
            //queryArticleSuccess();
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Elimina gli elementi html relativi agli articoli preferiti
 * @params p_pids Lista degli identificativi degli articoli che devono essere eliminati
 */
function deletePreferitiElements(){
    $('.preferiti_body_vista_container_box_status_selected').remove();
}


/******************************************************
 Gestione caricamento preferiti
 ******************************************************/
/*
 * Restituisce gli articoli preferiti presenti nel database locale
 * @params p_testata Identificativo del prodotto
 * @return Lista di articoli
 */
function preferitiLoadArticlesByProduct(p_testata){

    // Controlla che il database sia stato inizializzato e carica gli articoli
    if (_DB && p_testata) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " articles from the local PREFERITI store.");
            
            preferitiOpenArticlesList(p_results.rows);
        }
        
        var queryError = function(p_error){
            console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE testata=?', [p_testata], querySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

/*
 * Restituisce gli articoli preferiti presenti nel database locale in base ad un tag
 * @params p_tag Il nome del tag
 * @return Lista di articoli
 */
function preferitiLoadArticlesByTag(p_tag){

    // Controlla che il database sia stato inizializzato e carica gli articoli
    if (_DB && p_tag) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " articles from the local PREFERITI store.");
            
            preferitiOpenArticlesList(p_results.rows);
        }
        
        var tagQuerySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " tags from the local TAG table.");
            var l_articles = '';
            for (var i = 0; i < p_results.rows.length; i++) {
                if (i > 0) 
                    l_articles += ',';
                l_articles += '"' + p_results.rows.item(i).artid + '"';
            }
            console.log("Read " + l_articles);
            
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid IN (' + l_articles + ')', [], querySuccess, queryError);
        }
        
        var queryError = function(p_error){
            console.log("preferitiLoadArticlesByTag: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            console.log("tag: " + p_tag);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
            tx.executeSql('SELECT artid FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE nome=?', [p_tag], tagQuerySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){
    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').text(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        //$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id_tags').val($('#preferiti_body_vista_container_box_tags_span_' + p_article.artid).html());
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    
    // Salva le modifiche
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			/*
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
            */
        }
        
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
	
	var l_tags_el = document.getElementById('preferiti_body_vista_container_box_tags_span_' + l_artid);
	if (l_tags_el) {
		l_tags_el.innerHTML = l_tags;
	}
	l_tags_el = null;
	
    popupPreferitiUpdateArticleChiudi();
}


/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


/******************************************************
 Gestione Dettaglio Preferiti
 ******************************************************/
/**
 * Apre il dettaglio dei preferiti
 */
function preferitiDettaglio(p_article){

    //Inizializzazione dati articolo
    $('#preferiti_dettaglio_titolo').text(p_article.titolo);
    $('#preferiti_dettaglio_occhiello').text(p_article.occhiello);
    $('#preferiti_dettaglio_sottotitolo').text(p_article.sottotitolo);
    $('#preferiti_dettaglio_other_info').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
    $('#preferiti_dettaglio_firma').text(p_article.firma);
    $('#preferiti_dettaglio_text').html(p_article.testo);
    $('#preferiti_dettaglio_header_modifica input').click(function(){
        popupPreferitiUpdateArticle(p_article);
    });
    
    //$('#preferiti_dettaglio').fadeIn(200, function(){
	$('#preferiti_dettaglio').css('display', 'inline-block');
	
	  if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
			_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	  } else {
			_PREFERITI_ISCROLL_DETTAGLIO = new iScroll('preferiti_dettaglio_wrapper');
	  }
    //});
	
	omnitureTrackApp('APP:preferiti:open:' + p_article.artid, 'APP:preferiti');
}

/**
 * Chiude il dettaglio dei preferiti
 */
function preferitiDettaglioChiudi(){
    //$('#preferiti_dettaglio').fadeOut(200);
	$('#preferiti_dettaglio').css('display', 'none');
}

function preferitiUpdateOrientation(){
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.refresh();
    }
    if (_PREFERITI_ISCROLL_MENU != null) {
        _PREFERITI_ISCROLL_MENU.refresh();
    }
    if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
        _PREFERITI_ISCROLL_DETTAGLIO.refresh();
    }
}

/**
 * @author ABertacco FSantagada
 */
var _ARCHIVIO_ISOPEN = false;
var _ARCHIVIO_RENDERED_ITEMS = null;
var _PROID = null;
function archivioOpen(p_product_id, isFromSfoglio) {
	_ARCHIVIO_ISOPEN = true;

	_PROID = p_product_id;

	archivioLoad(p_product_id);
	//archivioLoad();
	archivioLoadAdv(p_product_id);

	//Inizializzazione filtro edizioni
	archivioInitFilter();

	$('#archivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#archivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#archivio').fadeIn();
	$('#archivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function archivioClose() {
	//$('#archivio').fadeOut();
	$('#archivio').css('display', 'none');
	if (_ARCHIVIO_ISCROLL != null) {
		_ARCHIVIO_ISCROLL.destroy();
		_ARCHIVIO_ISCROLL = null;
	}
	_ARCHIVIO_ISOPEN = false;
}

function archivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	openFlipper();
}

function archivioLoadAdv(p_product_id) {
	if(!p_product_id){
		if(window.product.getProduct()!= "")
			p_product_id = window.product.getProduct();
	}

	document.getElementById('archivio_footer_adv').innerHTML = '';
	//$('#qarchivio_footer_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom', function(){
	//}).endCapture();
	// http://mobapp24.ilsole24ore.com/adv_proxy.php?z=SFO_INTERSTITIAL&t=S24&d=123

	//*********************DA SOSTITUIRE!!!!!!************************
	$('#archivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
				setTimeout(function() {
		    	centerImage('archivio_footer_adv');
		    	$(window).resize(function() {
				  // add the stuff here to execute the your slider again;
				  setTimeout(function() {
				  	  
				  		$("#archivio_footer_adv").css('visibility', 'hidden');
					}, 0);
			
						
				  setTimeout(function() {
				  	  
					  $("#archivio_footer_adv img").trigger('load');
					}, 1000);
				});
		    	
		}, 100);
		
	}).endCapture();
}

function archivioLoadTutti() {
	archivioModificaFine();
	archivioLoadMenu('TUTTI');
}

function archivioLoadAcquisti() {
	archivioLoadMenu('ACQUISTI');
}

function archivioLoadMenu(mode) {
	$('#archivio_subtitolo_opzioni_tutti').removeClass('gray24');
	$('#archivio_subtitolo_opzioni_acquisti').removeClass('gray24');
	if (mode == 'TUTTI') {
		$('#archivio_subtitolo_opzioni_tutti').addClass('gray24');
		$('.archivio_container_box').css('display', 'inline-block');
	} else {
		$('#archivio_subtitolo_opzioni_acquisti').addClass('gray24');
		$('.archivio_container_box_isremote').css('display', 'none');
	}

	archivioUpdateIscroll();
}

var _ARCHIVIO_IS_IN_MODIFICA = false;
function archivioModifica() {
	_ARCHIVIO_IS_IN_MODIFICA = true;
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'inline-block');
	archivioLoadAcquisti();
	$('.archivio_container_box > div > .archivio_button_sfoglia').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_elimina').css('display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('LOCAL');
}

function archivioModificaFine() {
	_ARCHIVIO_IS_IN_MODIFICA = false;
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	archivioLoadAcquisti();
	//alert($('#archivio_wrapper').html());
	$('.archivio_container_box > div > .archivio_button_elimina').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_sfoglia').css('display', 'inline-block');
	$('.archivio_container_box_isremote > div > .archivio_button_acquista').css('display', 'inline-block');
	
	$('#archivio_filtro_edizioni_tempo').val(_PROID);
	archivioAggiornaContenutoVisualizzato();
}

var _ARCHIVIO_ISCROLL = null;
function archivioUpdateIscroll() {
	if (!_ARCHIVIO_ISOPEN) return;
	setTimeout(function() {
		if (_ARCHIVIO_ISCROLL == null) {
			_ARCHIVIO_ISCROLL = new iScroll('archivio_wrapper', {
				hideScrollbar : false
			});
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		} else {
			_ARCHIVIO_ISCROLL.refresh();
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		}
	}, 100);
}

var _ARCHIVIO_BOXES_INLINE_V = 2;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _ARCHIVIO_BOXES_INLINE_H = 3;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _ARCHIVIO_COUNT = 0;
function archivioLoad(p_product_id) {
	$('#archivio_container').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_ARCHIVIO_RENDERED_ITEMS = {};

	console.log('---REQ---> past-issues/' + p_product_id);
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> past-issues/' + p_product_id);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				archivioLoad(p_product_id);
			})) {
				var res = p_response.Result.res;

				_ARCHIVIO_PRODUCT = res;

				archivioRenderItems();

				for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
					var l_single_offers = _ARCHIVIO_PRODUCT.items[i].singleOffers;
					if (l_single_offers == null)
						continue;
					for (var j = 0; j < l_single_offers.length; j++) {
						//appstoreReqProduct(l_single_offers[j].offerId, l_single_offers[j].offerItunesProductId);
					}
				}
				//appstoreReqProducts();
			} else {
				console.log('archivioLoad: Error, ' + p_response.Exception.Description);
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_ARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				archivioRenderItems();
				$("#qarchivio_footer_adv").css("text-align", "center");
				$("#archivio_footer_adv").css("text-align", "center");
			}
		},
		error : function() {
			abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
			_ARCHIVIO_PRODUCT = {
				items : [],
				testata : _MAP_CODICE_TESTATA['' + p_product_id]
			};
			archivioRenderItems();
			$("#qarchivio_footer_adv").css("text-align", "center");
			$("#archivio_footer_adv").css("text-align", "center");
			
		}
	});

}

var _ARCHIVIO_LOCAL_ITEMS;
var _ARCHIVIO_LOCAL_ITEMS_ISSUE;
function archivioRenderItems() {
	_ARCHIVIO_LOCAL_ITEMS = [];
	_ARCHIVIO_LOCAL_ITEMS_ISSUE = [];
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioRenderItems: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				_ARCHIVIO_LOCAL_ITEMS.push(l_item_id);
				_ARCHIVIO_LOCAL_ITEMS_ISSUE.push(l_local_item.testata + '_' + l_local_item.issue);
			}

			archivioRenderItems_aux();
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function archivioRenderItems_aux() {
	console.log('archivioRenderItems...');
	console.log(_ARCHIVIO_LOCAL_ITEMS);

	_ARCHIVIO_RENDERED_ITEMS = {};
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId];
	console.log(_EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId]);
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#archivio_titolo_prodotto').text(l_product_details.name);

	//var l_sole_count_per_cover = 0;
	for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
		for (var j = 0; j < _ARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
			var l_item_id = _ARCHIVIO_PRODUCT.testata + '_' + _ARCHIVIO_PRODUCT.items[i].editionId + '_' + _ARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

			if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
				_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
				//archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, i < 30);
			}
		}
	}

	archivioLoadLocalData();
}

function archivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {

	archivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var item_full_id = _ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	var isLocal = $.inArray(item_full_id, _ARCHIVIO_LOCAL_ITEMS) != -1;
	var isLocalFree = $.inArray(_ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId, _ARCHIVIO_LOCAL_ITEMS_ISSUE) != -1;

	var l_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0) ? true : false;

	//console.log(item_full_id + ' ' + isLocal + ' ' + isLocalFree);

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_edizione_' + p_item.inserts[p_insert_index].insertId;
	//box.id = 'archivio_container_box_' + p_insert_index + '_' + p_item.editionId;
	box.id = 'archivio_container_box_' + item_full_id;
	//box.style['display'] = 'none';

	//console.log(item_full_id + "   " + (isLocal ? "LOCAL" : "REMOTE"));

	$(box).addClass( isLocal ? 'archivio_container_box_islocal' : 'archivio_container_box_isremote');

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = p_item.inserts[p_insert_index].cover;

	if (l_premium) {
		var premiumflag = document.createElement('img');
		imgdiv.appendChild(premiumflag);
		premiumflag.className = 'archivio_container_box_img_div_premiumflag';
		premiumflag.src = 'imgs/inserto_abbonati_archivio.png';
		//premiumflag.innerHTML = 'Inserto per abbonati';
	}

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		//eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	// se issue già presente in locale
	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_sfoglia.style.display = isLocal ? 'inline-block' : 'none';
	txt_sfoglia = null;

	// se issue non presente in locale
	var l_prezzo = "";
	if (p_item.free || p_item.subscription || (p_item.singleOffers && (p_item.singleOffers.length > 0))) {
		var txt_acquista = document.createElement('div');
		txt.appendChild(txt_acquista);
		txt_acquista.className = 'button medium red24 archivio_button_acquista';
		txt_acquista.style['text-align'] = 'center';
		//txt_acquista.appendChild(document.createTextNode('0,79 €'));
		
		if (l_premium && (!p_item.subscription) && (!p_item.free)) {
			txt_acquista.innerHTML = 'Per abbonati';
			$(txt_acquista).bind('click', function() {
				mostraPopupInsertoAbbonati();
			});
		} else {

			if (p_item.free || p_item.subscription || isLocalFree) {
				txt_acquista.innerHTML = 'Sfoglia';
				$(txt_acquista).bind('click', function() {
					//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
					sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
				});
			} else {
				//txt_acquista.innerHTML = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				l_prezzo = "<br />" + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				txt_acquista.innerHTML = 'Seleziona';
				$(txt_acquista).bind('click', function() {
					//acquistoSingolo(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);

					var link_singola = '';
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
						//_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola'
						if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
						}
					}
					// prova con i link

					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
							}
						}
					}

					//alert('aaaa');
					//alert('link: '+link_singola);
					//alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
					if (link_singola != '') {
						window.payment.paySingle(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId, link_singola);
						console.log('offerItunesProductId ' + p_item.singleOffers[0].offerItunesProductId);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				});
			}
		}
		txt_acquista.style.display = !isLocal ? 'inline-block' : 'none';
		txt_acquista = null;
	}
	//}

	// ATTENZIONE:  solo per test
	//p_item.inserts[p_insert_index].anteprima = 5;
	if ((!isLocalFree) && (!p_item.free) && (!p_item.subscription) && p_item.inserts[p_insert_index].anteprima && (parseInt(p_item.inserts[p_insert_index].anteprima) > 0)) {
		var txt_anteprima = document.createElement('div');
		txt.appendChild(txt_anteprima);
		txt_anteprima.className = 'button medium gray24 archivio_button_anteprima';
		txt_anteprima.style['text-align'] = 'center';
		txt_anteprima.appendChild(document.createTextNode('Anteprima'));
		$(txt_anteprima).bind('click', function() {
			openAnteprima(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, parseInt(p_item.inserts[p_insert_index].anteprima));
		});
		txt_anteprima = null;
	}

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	//VERIFICA!!!!*************************************
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.inserts[p_insert_index].description;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	//txt_subtitolo.innerHTML = p_item.editionDescription;
	txt_subtitolo.innerHTML = p_item.editionDescription + (!(isLocal || isLocalFree) ? l_prezzo : "");
	txt_subtitolo = null;

	if (isLocal) {
		var l_localdiv = document.createElement('img');
		txt.appendChild(l_localdiv);
		l_localdiv.className = 'archivio_container_box_txt_local_ICONS';
		l_localdiv.src = 'imgs/qarchivio_locale_flag.png';
		l_localdiv = null;
	}

	txt = null;
	box = null;

}

function archivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;
				//console.log(l_item_id);

				if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					archivioRenderLocalAsIcon(l_local_item);

				}

			}

			archivioLoadTutti();
			setTimeout(function() {
				$('#archivio_loading').css('display', 'none');
				
				if (_ARCHIVIO_ISCROLL != null) {
					_ARCHIVIO_ISCROLL.refresh();
					// FIX REDRAW
					_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
				}
			}, 500);
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

function archivioRenderLocalAsIcon(p_item) {

	archivioUpdateFilter(p_item.edizione, p_item.edizione_descr);

	var item_full_id = p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	var isLocal = true;

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_container_box_islocal archivio_edizione_' + p_item.edizione;
	box.id = 'archivio_container_box_' + item_full_id;

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//???? DA VERIFICARE******************************

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_sfoglia.style.display = 'inline-block';
	txt_sfoglia = null;

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.edizione_descr;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	txt_subtitolo.innerHTML = p_item.issue_descr;
	txt_subtitolo = null;

	txt = null;
	box = null;

}

var _ARCHIVIO_FILTRO_EDIZIONI = null;
function archivioInitFilter() {
	var l_filtro_tempo_select = $('#archivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_ARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#archivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	//var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);

}

function archivioUpdateFilter(p_edizione_id, p_edizione_descr) {
	if (jQuery.inArray(p_edizione_id, _ARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_ARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		var l_option = $('<option></option>');
		l_option.val(p_edizione_id);
		l_option.text(p_edizione_descr.replace('&igrave;', 'ì').replace('&#39;', '\''));
		$('#archivio_filtro_edizioni').append(l_option);
	}
}

function archivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#archivio_filtro_edizioni_tempo option:selected');

	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
			$('#archivio_container .archivio_container_box_islocal').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#archivio_container .archivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}
	}

	setTimeout(archivioUpdateIscroll, 100);
}/**
 * @author ABertacco
 */
var _QARCHIVIO_ISOPEN = false;
var _QARCHIVIO_MODE = 'ICONS';
var _QARCHIVIO_RENDERED_ITEMS = null;

var _QARCHIVIO_DEFAULT_EDIZIONE = 'SOLE';

var _PROID = null;

function qarchivioOpen(p_product_id, isFromSfoglio, defaultEdizione) {
	_QARCHIVIO_ISOPEN = true;
	_QARCHIVIO_DEFAULT_EDIZIONE = (defaultEdizione == null ? 'SOLE' : defaultEdizione);
	console.log('p_product_id ' + p_product_id);
	$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'hidden');

	_PROID = p_product_id;
	//alert('aaa'+_PROID);
	qarchivioLoad('ICONS', p_product_id);
	qarchivioLoadAdv(p_product_id);
	//$('#qarchivio').fadeIn();

	$('#qarchivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#qarchivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_loading').css('display', 'inline-block');
	$('#qarchivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function qarchivioClose() {
	//$('#qarchivio').fadeOut();
	$('#qarchivio').css('display', 'none');
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}
	_QARCHIVIO_ISOPEN = false;
}

function sfogliaArchivio(p_testata, p_issue, p_edizione) {
	var keyinput = "unread_message_sole";
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}

	if ( typeof (window.localStorage) != 'undefined') {
		window.localStorage.setItem(keyinput, valoutput);
	} else {
		throw "window.localStorage, not defined";
	}
	window.simulate.dbset('unread_message_sole', valoutput);
	window.loader.launchSfogliatore(p_testata, p_edizione, p_issue, "Descrizione" + valoutput);

}

function qarchivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	//openFlipper();
	console.log("closesfoglia");

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	
	try {
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}
		
		window.simulate.dbset('unread_message_sole', valoutput);
		window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
		
		qarchivioClose();
		setTimeout(function() {
			console.log("launch page " + _CURRENT_FLIPPER_PAGINA);
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			//window.go.to(_CURRENT_FLIPPER_PAGINA);

		}, 1500);
	} catch(exc) {
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}
}

function qarchivioLoadAdv(p_product_id) {
	if(!p_product_id){
		if(window.product.getProduct()!= "")
			p_product_id = window.product.getProduct();
	}
	document.getElementById('qarchivio_footer_adv').innerHTML = '';
	//'http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
	$('#qarchivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
				setTimeout(function() {
		    	centerImage('qarchivio_footer_adv');
		    	$(window).resize(function() {
				  // add the stuff here to execute the your slider again;
				  setTimeout(function() {
				  	  
				  		$("#qarchivio_footer_adv").css('visibility', 'hidden');
					}, 0);
				
		  			setTimeout(function() {
						
		  				
		  			  //$("#qarchivio_footer_adv img").css('visibility', 'hidden');
					  $("#qarchivio_footer_adv img").trigger('load');
					}, 1000);
				  
				});
		    	
		}, 100);
		
	}).endCapture();
}

function updateRichBtn() {
}

var _QARCHIVIO_ISCROLL = null;
function qarchivioUpdateIScroll() {
	//updateRichBtn();
	if (!_QARCHIVIO_ISOPEN)
		return;
	if (_QARCHIVIO_ISCROLL == null) {
		_QARCHIVIO_ISCROLL = new iScroll('qarchivio_wrapper', {
			hideScrollbar : false
		});
	} else {
		_QARCHIVIO_ISCROLL.refresh();
	}
}

function qarchivioLoad(mode, p_product_id) {
	console.log("qarchivioLoad p_product_id: " + p_product_id);
	// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
	if ($('#qarchivio_subtitolo_opzioni_visualizza').is(':visible')) qarchivioVisualizza();

	$('#qarchivio_loading').css('display', 'inline-block');
	if (mode) {
		_QARCHIVIO_MODE = mode;
	} else {
		if (_QARCHIVIO_MODE == null) {
			_QARCHIVIO_MODE = 'ICONS';
		}
	}

	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}

	$('#qarchivio_container').empty();
	$('#qarchivio_subtitolo_opzioni_vista1').removeClass('qarchivio_subtitolo_opzioni_vista1_on');
	$('#qarchivio_subtitolo_opzioni_vista2').removeClass('qarchivio_subtitolo_opzioni_vista2_on');

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname || _DEVICE_SETTINGS.appname,
		"appVersion" : device.appversion || _DEVICE_SETTINGS.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_QARCHIVIO_RENDERED_ITEMS = {};

	if (p_product_id && p_product_id != '') {

		//Inizializzazione filtro edizioni
		qarchivioInitFilter();

		console.log('---REQ---> past-issues/' + p_product_id);
		console.log(l_request_headers);
		console.log(l_request_data);
		
		//alert(device.uuid);

		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
			headers : l_request_headers,
			data : l_request_data,
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> past-issues/' + p_product_id);
				console.log(p_response);

				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, function() { qarchivioLoad(mode, p_product_id); })) {
					var res = p_response.Result.res;

					_QARCHIVIO_PRODUCT = res;

					qarchivioRenderItems();
				} else {
					console.log('qarchivioLoad: Error, ' + p_response.Exception.Description);
					abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
					_QARCHIVIO_PRODUCT = {
						items : [],
						testata : _MAP_CODICE_TESTATA['' + p_product_id]
					};
					qarchivioRenderItems();
					$("#qarchivio_footer_adv").css("text-align", "center");
					$("#archivio_footer_adv").css("text-align", "center");
				}
					
				l_request_headers = null, l_request_data = null;
			},
			error : function() {
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_QARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				qarchivioRenderItems();
				$("#qarchivio_footer_adv").css("text-align", "center");
				$("#archivio_footer_adv").css("text-align", "center");
				
			}
		});

	} else {
		//_QARCHIVIO_PRODUCT = { items: [], testata: _MAP_CODICE_TESTATA[''+p_product_id] };
		qarchivioRenderItems();
	}
	//alert('aaa '+$('#qarchivio_filtro_edizioni option:selected').val());
}

function qarchivioRenderItems() {
	console.log('qarchivioRenderItems...');
	_QARCHIVIO_RENDERED_ITEMS = {};
	//$('#qarchivio_titolo_prodotto').text(_QARCHIVIO_PRODUCT.productDescription);
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_QARCHIVIO_PRODUCT.productId];
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#qarchivio_titolo_prodotto').text(l_product_details.name);

	if (_QARCHIVIO_MODE == 'ICONS') {
		// modalità vista icone
		$('#qarchivio_subtitolo_opzioni_vista1').addClass('qarchivio_subtitolo_opzioni_vista1_on');

		var l_sole_count_per_cover = 0;

		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (_QARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
					l_sole_count_per_cover++;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsIcon(_QARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				}
			}
		}
		console.log('prima di qarchivioLoadLocalData');
		//setTimeout("qarchivioLoadLocalData()",0);
		qarchivioLoadLocalData();
	} else {
		console.log("qarchivioRenderItems LIST");
		// modalità vista lista
		$('#qarchivio_subtitolo_opzioni_vista2').addClass('qarchivio_subtitolo_opzioni_vista2_on');

		qarchivioRenderItems_List_aux();
	}
}

function qarchivioRenderItems_List_aux() {
	console.log('qarchivioRenderItems_List_aux...' + _QARCHIVIO_PRODUCT.items.length);
	try {
		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsList(_QARCHIVIO_PRODUCT.items[i], j);
				}
			}
		}

		qarchivioLoadLocalData();
	} catch (exc) {
		console.log("qarchivioRenderItems_List_aux::error: " + exc.message);
	}
}

var _CURRENT_QUEUE_LIST;
function downloadManagerCallbackQueueList(p_queue) {
	console.log('downloadManagerCallbackQueueList...');
	_CURRENT_QUEUE_LIST = p_queue;
	qarchivioRenderItems_List_aux();
	return "OK";
}

function isInQueueList(testata, issue, edizione) {
	//console.log('isInQueueList?');
	//console.log(testata + ' ' + issue + ' ' + edizione);
	if (_CURRENT_QUEUE_LIST == null)
		return false;
	for (var i = 0; i < _CURRENT_QUEUE_LIST.length; i++) {
		var l_item = _CURRENT_QUEUE_LIST[i];
		//console.log(l_item.testata + ' ' + l_item.issue + ' ' + l_item.edizione);
		if ((l_item.testata == testata) && (l_item.issue == issue) && (l_item.edizione == edizione)) {
			return true;
		}
	}
	return false;
}

/**
 * Crea la rappresentazione di un arretrato come icona
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24') && (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var img_div = document.createElement('div');
	box.appendChild(img_div);
	img_div.className = 'qarchivio_container_box_img_div';
	img_div.id = 'qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	if (createCoverImg) {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = p_item.inserts[p_insert_index].cover;
	} else {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = 'imgs/fake/fake_cover.jpg';
	}

	if (p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0)) {
		var premium_flag = document.createElement('img');
		img_div.appendChild(premium_flag);
		premium_flag.src = 'imgs/inserto_abbonati_archivio.png';
		premium_flag.className = 'qarchivio_container_box_img_div_premiumflag';
	}

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong><br />' + p_item.editionDescription;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
		}
	});
	checkLocalArretrato(p_item, p_insert_index);
}

/**
 * Crea la rappresentazione di un arretrato come lista
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsList(p_item, p_insert_index) {
	console.log('qarchivioRenderAsList');
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24') && (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong> ' + p_item.editionDescription;
	//p_item.editionTitle;
	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	btndiv.id = 'qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	btn.className = 'qarchivio_container_box_btn_download';
	btn.type = 'button';
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'qarchivio_hidden_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);

	checkLocalArretrato(p_item, p_insert_index);

}

/******************************************************
 Gestione caricamento arretrati salvati in locale
 ******************************************************/
/**
 * Carica gli articoli salvati in locale
 */
function qarchivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("qarchivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					if (_QARCHIVIO_MODE == 'ICONS') {
						qarchivioRenderLocalAsIcon(l_local_item);
					} else {
						console.log("NO ICONS");
						qarchivioRenderLocalAsList(l_local_item);
					}
				}

				qarchivioUpdateFilter(l_local_item.edizione, l_local_item.edizione_descr);
			}

			//Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#qarchivio_filtro_edizioni').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.qarchivio_container_box_ICONS').height(Math.round(window.innerHeight / 7));
			} else {
				$('.qarchivio_container_box_ICONS').height(Math.round(window.innerHeight / 4));
			}

			setTimeout(function() {
				//$('#qarchivio_container').css('visibility', 'hidden');
				$('#qarchivio_loading').css('display', 'none');
				//$('#qarchivio_container').css('visibility', 'visible');
				$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'visible');
				
				if (_QARCHIVIO_ISCROLL != null) {
					_QARCHIVIO_ISCROLL.refresh();
					// FIX REDRAW
					_QARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
				}
				
			}, 500);

			/*
			 setTimeout(function(){
			 window.scrollTo(0,0);
			 },560);
			 */

		}
		var queryError = function(p_error) {
			console.log("qarchivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_QARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un arretrato in locale come icona
 * @params p_item Arretrato in locale come salvato nel db issues
 */
function qarchivioRenderLocalAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'qarchivio_container_box_img_div';
	$(img_div).click(function() {
		if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			console.log("sfoglia LIST archivio");
			//window.loader.local(true);
		}
	});
	box.appendChild(img_div);

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	var img = document.createElement('img');
	img_div_crop.appendChild(img);
	img.className = 'qarchivio_container_box_img';
	//ANDROID MODDED
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong><br />' + p_item.issue_descr;
	
	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
		}
	});

}

/**
 * Crea la rappresentazione in lista di un arretrato salvato in locale
 * @params p_item Arretrato in locale come salvato nel db issues
 *
 */
function qarchivioRenderLocalAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + +p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
		console.log("sfoglia LIST archivio");
		window.loader.local(true);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);
}

/******************************************************
 Gestione filtro
 ******************************************************/
function qarchivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#qarchivio_filtro_edizioni_tempo option:selected');
	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#qarchivio_container .qarchivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}

	}

	setTimeout(qarchivioUpdateIScroll, 100);
}

/**
 * Inizializza il filtro sulle edizioni da mostrare.
 */
var _QARCHIVIO_FILTRO_EDIZIONI = null;
function qarchivioInitFilter() {
	var l_filtro_tempo_select = $('#qarchivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});
	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_QARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#qarchivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();
	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);
		
		qarchivioAggiornaContenutoVisualizzato();
	});

	l_filtro_edizioni_select.append('<option value="">Tutti i prodotti</option>');
	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	_QARCHIVIOFILTRORICH.push(row);

	l_filtro_edizioni_select.append('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore") + '" selected="selected">Il Sole 24 Ore</option>');
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore"), "Il Sole 24 Ore");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore"),
		label : "Il Sole 24 Ore"
	};
	_QARCHIVIOFILTRORICH.push(row);

	/*
	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore lunedì") + '" selected="selected">Il Sole 24 Ore lunedì</option>');
	l_filtro_edizioni_select.append(l_option);
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore lunedì"), "Il Sole 24 Ore lunedì");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore lunedì"),
		label : "Il Sole 24 Ore lunedì"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);
	*/
}

function qarchivioLabelToValue(p_label) {
	//return p_label.toLowerCase(p_label.replace(/[^a-zA-Z0-9]/g,'x'));
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function qarchivioUpdateFilter(p_edizione_id, p_edizione_descr) {

	if (jQuery.inArray(qarchivioLabelToValue(p_edizione_descr), _QARCHIVIO_FILTRO_EDIZIONI) == -1) {
		//_QARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue(p_edizione_descr), p_edizione_descr);
		var row = {
			value : qarchivioLabelToValue(p_edizione_descr),
			label : p_edizione_descr
		};
		//console.log('rich '+row.value+','+row.label);
		_QARCHIVIOFILTRORICH.push(row);
		//console.log('rich '+_QARCHIVIOFILTRORICH[0].value);
		var l_option = $('<option></option>');

		l_option.val(qarchivioLabelToValue(p_edizione_descr));
		l_option.html(p_edizione_descr);
		//$('#qarchivio_filtro_edizioni').append(l_option);
		//console.log('append-->'+l_option.html());
		if (navigator.userAgent.indexOf('Android 4.4;') == -1) {
			if (!$('#qarchivio_filtro_edizioni_optgroup').length) $('#qarchivio_filtro_edizioni').append('<optgroup label="Altre testate" id="qarchivio_filtro_edizioni_optgroup"></optgroup>');
			$('#qarchivio_filtro_edizioni_optgroup').append(l_option);
		} else {
			$('#qarchivio_filtro_edizioni').append(l_option);
		}
	}

	if (_QARCHIVIO_DEFAULT_EDIZIONE == p_edizione_id) {
		$('#qarchivio_filtro_edizioni').val(qarchivioLabelToValue(p_edizione_descr));
	}
}

_QARCHIVIOFILTRORICH = new Array();
function updateRichFilter() {
}

/*
 * Controlla se un arretrato sia stato scaricato in locale
 * @params p_item Arretrato
 *         p_insert_index Indice dell'inserto
 */
function checkLocalArretrato(p_item, p_insert_index) {

	var l_testata = _QARCHIVIO_PRODUCT.testata;
	var l_issue = p_item.editionId;
	var l_edizione = p_item.inserts[p_insert_index].insertId;
	var l_edizione_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0);

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length <= 0)
				return;

			var l_query_result = p_results.rows.item(0);

			if (l_query_result.in_locale > 0) {
				$('#qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId).addClass('qarchivio_container_box_isinlocal');
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
			} else {
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE;
			}

			if (_QARCHIVIO_MODE == 'LIST') {
				var btn = document.getElementById('qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
					btn.value = 'Sfoglia';
					$(btn).click(function() {
						sfoglia(l_testata, l_issue, l_edizione);
						window.loader.local(true);
					});

					var del_btn = document.getElementById('qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
					del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
				} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
					// copia con download in corso
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					renderDownloadQueue(l_testata, l_issue, l_edizione);
				} else {
					if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
						if ((!p_item.subscription) && l_edizione_premium) {
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							btn.value = 'Solo per abbonati';
							$(btn).unbind();
							$(btn).bind('click', function() {
								mostraPopupInsertoAbbonati();
							});
						} else {
							// copia gratuita
							btn.className = 'button medium gray24 qarchivio_free_copy_btn';
							btn.value = 'Salva in locale';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ADD1 TO QUEUE " + l_testata + " " + l_issue + " " + l_edizione);
								addToDownloadQueue(l_testata, l_issue, l_edizione);
							});
						}
					} else if (l_edizione_premium) {
						btn.className = 'button medium red24 qarchivio_buy_copy_btn';
						btn.value = 'Solo per abbonati';
						$(btn).unbind();
						$(btn).bind('click', function() {
							mostraPopupInsertoAbbonati();
						});
					} else {
						if (p_item.single && (p_item.singleOffers.length > 0)) {
							// acquisto
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							//btn.value = 'Acquista ' + p_item.singleOffers[0].offerPrice + ' €';
							//btn.value = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
							btn.value = 'Seleziona';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ACQUISTO " + l_testata + " " + l_issue + " " + l_edizione);
								acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
							});
						} else {
							var btndiv = document.getElementById('qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
							btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
							btndiv.style['position'] = 'relative';
							btndiv.style['margin-right'] = '30px';
							btndiv.style['margin-top'] = '10px';
						}
					}
				}
			} else if (_QARCHIVIO_MODE == 'ICONS') {
			
				var icon = document.getElementById('qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					$(icon).click(function() {
						if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (_QARCHIVIO_PRODUCT.free || l_query_result.da_scaricare > 0) {
				if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
					// copia gratuita
					$(icon).click(function() {
						//scarica(l_testata, l_issue, l_edizione);
						if ((!p_item.subscription) && l_edizione_premium) {
							sfogliaCheckPremium(l_testata, l_issue, l_edizione);
						} else {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (p_item.subscription == false && p_item.single) {
				if (l_edizione_premium) {
					$(icon).click(function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					if (p_item.single && (p_item.singleOffers.length > 0)) {
						// acquisto
						$(icon).click(function() {
							acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
						});
					}
				}

			}
		}
		//try{
		var queryError = function(p_error) {
			console.log("checkLocalArretrato: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			var l_query = 'select * from (select count(*) as in_locale, 1 as id from issues where testata=? and issue=? and edizione=?) as a inner join (select count(*) as da_scaricare, 1 as id from issues where testata=? and issue=?) as b on (a.id = b.id)';
			tx.executeSql(l_query, [l_testata, l_issue, l_edizione, l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Passa alla modalità modifica
 */
var _QARCHIVIO_IS_IN_MODIFICA = false;
var _QARCHIVIO_PRE_MODIFICA_TEMPO = '';
function qarchivioModifica() {
	console.log("modifica");
	_QARCHIVIO_IS_IN_MODIFICA = true;
	$('#qarchivio_subtitolo_opzioni_modifica').hide();
	$('#qarchivio_subtitolo_opzioni_visualizza').show();

	$('#qarchivio_container').addClass('qarchivio_modify');

	_QARCHIVIO_PRE_MODIFICA_TEMPO = $('#qarchivio_filtro_edizioni_tempo').val();
	$('#qarchivio_filtro_edizioni_tempo').val("LOCAL");
	qarchivioAggiornaContenutoVisualizzato();
}

/**
 * Passa alla modalità visualizza
 */
function qarchivioVisualizza(light) {
	_QARCHIVIO_IS_IN_MODIFICA = false;
	$('#qarchivio_subtitolo_opzioni_modifica').show();
	$('#qarchivio_subtitolo_opzioni_visualizza').hide();

	$('#qarchivio_container').removeClass('qarchivio_modify');

	if (light == true)
		return;

	$('#qarchivio_filtro_edizioni_tempo').val(_QARCHIVIO_PRE_MODIFICA_TEMPO);
	qarchivioAggiornaContenutoVisualizzato();

	gestisciProssimaAzione();
	// <-- PERCHE'???

}
/**
 * @author ABertacco, MConventi
 */
var _USER_DEVICES = [];
var _IMPOSTAZIONI_MENU_ISCROLL = null;
var _IMPOSTAZIONI_VISTA_ISCROLL = null;
var _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};

function impostazioniInizializza() {
   if (_EDICOLA_USE_CATEGORIES) {
      var req_headers = {
         "appKey": _API24_APPKEY
      };
      var req_data = {
         "appName": device.appname,
         "appVersion": device.appversion,
         "deviceId": device.uuid,
         "deviceType": device.platform
      };
      console.log("--REQ---> getProducts4Impostazioni");
      console.log(req_headers);
      console.log(req_data);
      $.ajax({
         type: "GET",
         cache: false,
         timeout: _AJAX_TIMEOUT,
         contentType: "application/json; charset=utf-8",
         url: _SOLEGW_ENDPOINT + "products.json",
         headers: req_headers,
         data: req_data,
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log("--RESP--> getProducts4Impostazioni");
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
               //console.log('ajax success');
               var res = p_response.Result.res;
               _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};
               for (var i = 0; i < res.products.length; i++) {
                  var pid = res.products[i].productId;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid] = {};
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;
                  if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "storeplus") {
                     _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = "store";
                     _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type_original'] = "storeplus";
                  }
               }
               impostazioniInizializza_aux();
            }
         }
      });
   } else {
      _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = _EDICOLA_PRODUCTS_DETAILS;
      impostazioniInizializza_aux();
   }
}

function impostazioniInizializza_aux() {
   //Inizializza la lista dei prodotti disponibili
   inizializzaImpostazioniProdotti();
   // lista prodotti in select per selezione prodotto principale
   inizializzaListaProdottoPrincipale();
   // carico informativa privacy
   impostazioniLoadInformativaPrivacy();
}
var _IMPOSTAZIONI_ISCROLL_PRIVACY = null;

function impostazioniLoadInformativaPrivacy() {
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      url: 'http://du.ilsole24ore.com/utenti/Privacy.html',
      success: function (p_response) {
         if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
            _IMPOSTAZIONI_ISCROLL_PRIVACY.destroy();
            _IMPOSTAZIONI_ISCROLL_PRIVACY = null;
         }
         document.getElementById('informativa_privacy_body_container').innerHTML = p_response;
         // _IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
      },
      error: function () {}
   });
}
//corregge padding nel caso di monitor 10''
function adjustPadding() {
	$('#impostazioni_body_menu_container_box_generali, #impostazioni_body_menu_container_box_codicepromozionale, #impostazioni_body_menu_container_box_help').css({
		'paddingLeft': '5%'
	});
}

function impostazioniOpen() {
   //alert('aaaaa');
   impostazioniInizializza();
   var l_impostazioni_current = $('.impostazioni_body_menu_container_box_active');
   //alert($('#impostazioni_prodotto_principale_select').html());
   //if (l_impostazioni_current.length == 0)
   impostazioniOpenGenerali();
   //aggiusto 10''
   adjustPadding();
}

function impostazioniVistaClose(event) {
   event.stopPropagation();
   $('#impostazioni_body_vista_wrapper').removeClass('impostazioni_body_vista_active');
   $('#impostazioni_titolo_vista').removeClass('impostazioni_body_vista_active');
   $('.impostazioni_body_menu_container_box_active').removeClass('impostazioni_body_menu_container_box_active');
}

function impostazioniInitOpen(menu, title) {
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.destroy();
      _IMPOSTAZIONI_VISTA_ISCROLL = null;
   }
   $('#impostazioni_body_vista_wrapper').addClass('impostazioni_body_vista_active');
   $('#impostazioni_titolo_vista').addClass('impostazioni_body_vista_active');
   //$('#impostazioni_titolo_vista_back_button').css('display', 'none');
   $('#impostazioni_body_vista_container > div').css('display', 'none');
   $('.impostazioni_body_menu_container_box').removeClass('impostazioni_body_menu_container_box_active');
   $('#' + menu).addClass('impostazioni_body_menu_container_box_active');
   document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title;
   var l_back_button = $('#impostazioni_titolo_vista_back_button');
   l_back_button.html('<span></span><span>Impostaz.</span>');
   l_back_button.unbind('click');
   l_back_button.click(impostazioniVistaClose);
}

function impostazioniUpdateOrientation() {
   if (_IMPOSTAZIONI_MENU_ISCROLL != null) {
      _IMPOSTAZIONI_MENU_ISCROLL.refresh();
   }
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   if (_IMPOSTAZIONI_HELP_LOADED) hlpCreaLinea();
}

function impostazioniOpenGenerali() {
   impostazioniInitOpen('impostazioni_body_menu_container_box_generali', 'Generali');
   // informazioni sul profilo utente
   inizializzaAgganciaProfilo();
   // memoria disponibile
   if ((typeof device != "undefined") && (device.usedspace != null) && (device.usedspaceperc != null)) $('#impostazioni_body_vista_container_generali_memoria_value').html(device.usedspace + ' (' + device.usedspaceperc + ')');
   // carico informazioni sulle versioni
   $('#impostazioni_body_vista_container_generali_info_versione_app').text(device.appversion);
   $('#impostazioni_body_vista_container_generali_info_device_id').text(device.uuid);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: true,
      url: 'VERSION',
      success: function (p_response) {
         $('#impostazioni_body_vista_container_generali_info_versione_gui').text(p_response);
      },
      error: function () {
         $('#impostazioni_body_vista_container_generali_info_versione_gui').text('---');
      }
   });
   $('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   omnitureTrackApp('APP:impostazioni:generali', 'APP:impostazioni');
}
/**
 * Inizializza la sezione di "Aggancia profilo" nelle impostazioni generali
 */
function inizializzaAgganciaProfilo() {
   if (_MOD_OFFLINE) {
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
      //alert('aaa'+_MOD_OFFLINE);
      return;
   }
   //Se l'utente ha effettuato la login viene mostrato il pulsante per accedere al profilo
   if (_USERNAME) {
      //alert('aaa'+_USERNAME);
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_profilo_value').text(_USERNAME);
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'inline-block');
      //alert($('#impostazioni_body_vista_wrapper').width()+','+ $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth());
   } else {
      //alert('aaa');
      // Altrimenti viene mostrato il pulsante per aprire il popup per la login
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'inline-block');
   }
}
IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = null

function impostazioniGeneraliRegistrazione() {
   //console.log("REGISTRAZIONE 2");
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupImpostazioniRegistratiDone;
   if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
      IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
         bounce: false
      });
   } else {
      IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
   }
   //console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is "+IMP_ACQUISTO_REGISTRAZIONE_ISCROLL)
}

function impostazioniCodicePromoRegistrazione() {
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupCodicePromoRegistratiDone;
}

function impostazioniProdottoRegistrazione() {
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupProdottoRegistratiDone;
}

function popupImpostazioniRegistrati() {
   //_NEXT_ACTION = popupImpostazioniRegistratiDone;
   popupRegistrazioneApri();
}

function popupImpostazioniRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenGenerali();
}

function popupCodicePromoRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenCodicePromozionale();
}

function popupProdottoRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenGenerali();
}
/******************************************************
 Gestione impostazioni codice promozionale
 ******************************************************/
/**
 * Apre la sezione delle impostazioni per l'attivazione di un codice promozionale
 * Nel caso in cui l'utente non sia autenticato viene richiesta la login o la registrazione
 */
function impostazioniOpenCodicePromozionale() {
   impostazioniInitOpen('impostazioni_body_menu_container_box_codicepromozionale', 'Codice promozionale');
   if (_USERNAME) {
      $('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'none');
      $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'inline-block');
   } else {
      $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'none');
      $('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'inline-block');
   }
   $('#impostazioni_body_vista_container_codicepromozionale').css('display', 'inline-block');
   
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   omnitureTrackApp('APP:impostazioni:codice_promo', 'APP:impostazioni');
}
/**
 * Esegue la chiamata per l'attivazione di un codice promozionale
 */
function impostazioniOpenCodicePromozionaleAvanti() {
   var l_codice_promozionale = $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice #codice_promozionale').val();
   console.log('Sending the promotional code ' + l_codice_promozionale);
   if (l_codice_promozionale && l_codice_promozionale != '') {
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "appName": device.appname,
         "appVersion": device.appversion,
         "deviceId": device.uuid,
         "deviceType": device.platform,
         "username": _USERNAME //,
         //"promo_code": l_codice_promozionale
      };
      console.log('---REQ---> promo-code');
      console.log(l_req_headers);
      console.log(l_req_data);
      /*
 navigator.notification.loadingStart({
 'labelText': "Richiesta in corso...",
 'backgroundOpacity': 0.8,
 'strokeOpacity': 0.25,
 'strokeColor': "FFFFFF",
 });
 */
      window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
      $.ajax({
         type: "POST",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         //url: _SOLEGW_ENDPOINT + "promo-code.json",
         url: _SOLEGW_ENDPOINT + "promo/" + l_codice_promozionale + ".json",
         headers: l_req_headers,
         processData: false,
         data: JSON.stringify(l_req_data),
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> promo-code');
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response, impostazioniOpenCodicePromozionaleAvanti)) {
               abutils.alert('La tua promozione è stata attivata con successo', 'Codice promozionale');
            } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
               if (p_response.Exception.Description) {
                  abutils.alert(p_response.Exception.Description, 'Codice promozionale');
               } else {
                  abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale.', 'Codice promozionale');
               }
            }
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         },
         error: function () {
            abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale. Riprovare tra poco.', 'Codice promozionale');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      });
   } else {
      abutils.alert('Attenzione, inserire un codice promozionale', 'Codice promozionale');
   }
}
var _IMPOSTAZIONI_HELP_LOADED = false;
var hlpTabsScr, hlpContScr, hlpFaqScr, strOr, hlpGlobNav;

function hlpNav(hli) {
   $('#hlp_tbs2_scroll .tbon').removeClass("tbon");
   $('#hlp_tbs2_scroll .hlp_tb:eq(' + hli + ')').addClass("tbon");
   $('#hlp_tot div[class^=hlp_slide]:visible').fadeOut(200);
   $('#hlp_cont_scroll > div:eq(' + hli + ')').delay(200).fadeIn(200);
   setTimeout(function () {
      hlpContScr.refresh();
      hlpCreaLinea();
   }, 410);
}

function hlpCreaLinea() {
   console.log('hlpCreaLinea()');
   console.log(window.orientation);
   /*verticale o orizzontale*/
   if (typeof window.orientation != "undefined") {
      strOr = Math.abs(window.orientation) == 90 ? "l" : "p";
   } else { //temp non ipad
      strOr = window.innerWidth > window.innerHeight ? "l" : "p";
   }
   if (strOr == "l") {
      $('#hlp_mail').html('Desideri assistenza specifica? Contatta il Servizio Clienti all\'indirizzo <a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
   } else {
      $('#hlp_mail').html('Contatta il Servizio Clienti:<br><a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
   }
   if (hlpFaqScr != null) hlpFaqScr.refresh();
   setTimeout(function () {
      $("#hlp_cont_scroll canvas:visible").each(function (index, element) {
         var $c = $(this);
         var c = $(this)[0];
         $c.width(Number($c.data(strOr + "w")));
         $c.height(Number($c.data(strOr + "h")) + 15);
         c.width = Number($c.data(strOr + "w"));
         c.height = Number($c.data(strOr + "h") + 15);
         $c.css({
            'left': "-" + c.width + "px",
            'top': "-" + (c.height - 15) + "px"
         });
         var cxt = c.getContext("2d");
         cxt.strokeStyle = '#FF0000';
         cxt.lineWidth = 2;
         cxt.lineCap = 'round';
         cxt.moveTo(1, 1);
         cxt.lineTo(c.width - 7, c.height - 2);
         cxt.stroke();
      });
   }, 10);
}

function impostazioniOpenHelp() {
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.destroy();
      _IMPOSTAZIONI_VISTA_ISCROLL == null;
   }
   impostazioniInitOpen('impostazioni_body_menu_container_box_help', 'Help');
   console.log('PASSS HELP');
   //window.location = 'ipad_help.html';
   /*
 $('div').ajaxError(function(event, request, settings){
 alert("Error requesting page " + settings.url );
 });*/
   if (!_IMPOSTAZIONI_HELP_LOADED) {
      // carico il contenuto via ajax
      $.ajax({
         type: "GET",
         timeout: _AJAX_TIMEOUT,
         cache: true,
         url: "ipad_help.html",
         success: function (p_response) {
            try {
               console.log('ipad_help.html letto');
               $('#impostazioni_body_vista_container_help_content').html(p_response);
               //console.log('asdadadasdasdas');
               $('#impostazioni_body_vista_container_help').css('display', 'inline-block');
               // ATTENZIONE ---> evento di aggiornamento in impostazioniUpdateOrientation
               console.log('carico help');
               $('#hlp_tbs2_scroll .hlp_tb').click(function (e) {
                  e.preventDefault();
                  if (!$(this).hasClass('tbon')) {
                     var hli = $(this).index();
                     hlpNav(hli);
                  }
               });
               hlpNav(0);
               hlpTabsScr = new iScroll('hlp_tbs2', {
                  snap: "a",
                  hScrollbar: false
               });
               hlpContScr = new iScroll('hlp_cont', {
                  vScrollbar: false
               });
               hlpFaqScr = new iScroll('hlp_faq', {
                  vScrollbar: false
               });
               $('#hlp_faq').hide(0);
               $('#hlp_tbs1 .hlp_tb').click(function (e) {
                  if (hlpGlobNav != $(this).data('nav')) {
                     hlpGlobNav = $(this).data('nav');
                     $('#hlp_tbs1 .hlp_tb').toggleClass("tbon");
                     $('#hlp_glob_switch > div[id^=hlp_]').hide(0);
                     hlpFaqScr.refresh();
                     $('#hlp_glob_switch > #hlp_' + hlpGlobNav).fadeIn(300, function () {
                        if (hlpGlobNav == "faq") {
                           hlpFaqScr.refresh();
                        }
                     });
                  }
               });
            } catch (exc) {
               console.log(exc.message);
            }
            _IMPOSTAZIONI_HELP_LOADED = true;
         },
         error: function (XMLHttpRequest, textStatus, errorThrown) {
            /*
             * readyState
             * status
             * statusText
             * responseXML and/or responseText when the underlying request responded with xml and/or text, respectively
             * setRequestHeader(name, value) which departs from the standard by replacing the old value with the new one rather than concatenating the new value to the old one
             * getAllResponseHeaders()
             * getResponseHeader()
             * abort()
             */
            console.log("Error status :" + textStatus);
            console.log("Error type :" + errorThrown);
            console.log("Error message :" + XMLHttpRequest.status);
         }
      });
   }
   $('#impostazioni_body_vista_container_help').css('display', 'inline-block');
   /* lo fa il codice dell'help
 if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
 _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
 }
 else {
 _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
 }
 */
   omnitureTrackApp('APP:impostazioni:help', 'APP:impostazioni');
}
/******************************************************
 Gestione prodotto principale
 ******************************************************/
/**
 * Inizializza la lista dei prodotti tra i quali poter scegliere per selezionare il prodotto principale.
 */
function inizializzaListaProdottoPrincipale() {
   // Ottenere il prodotto principale da local storage
   var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
   var l_prodotto_principale_descr = window.localStorage.getItem("prodotto_principale_descr");
   var l_impostazioni_prodotto_principale_select = $('#impostazioni_prodotto_principale_select');
   l_impostazioni_prodotto_principale_select.empty();
   l_impostazioni_prodotto_principale_select.append($('<option value="">Nessun prodotto principale</option>'));
   for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
      if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
         var l_option = $('<option></option>');
         l_option.val(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId);
         l_option.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
         if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
            l_option.attr('selected', 'selected');
         }
         l_impostazioni_prodotto_principale_select.append(l_option);
      }
   }
}

function impostazioniProdottoPrincipaleSelectOnChange() {
   //alert('CIAO');
   console.log('impostazioniProdottoPrincipaleSelectOnChange...');
   var l_selected_option = $('#impostazioni_prodotto_principale_select option:selected');
   l_prodotto_principale_id = l_selected_option.val();
   l_prodotto_principale_descr = l_selected_option.text();
   window.localStorage.setItem("prodotto_principale_id", l_prodotto_principale_id);
   window.localStorage.setItem("prodotto_principale_descr", l_prodotto_principale_descr);
   //console.log('impostazioniProdottoPrincipaleSelectOnChange ---> '+l_selected_option.val()+':::'+ l_selected_option.text());
}
/******************************************************
 Gestione impostazioni prodotti
 ******************************************************/
/**
 * Inizializza la lista dei prodotti nel pannello delle impostazioni
 */
function inizializzaImpostazioniProdotti() {
   var l_lista_prodotti_container = $('#impostazioni_body_menu_container_box_lista_prodotti');
   l_lista_prodotti_container.empty();
   /*
 for (var key in _EDICOLA_PRODUCTS_DETAILS) {
 if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
 var pbox = $('<div></div>');
 pbox.addClass('impostazioni_body_menu_container_box');
 pbox.addClass('impostazioni_body_menu_container_box_prodotto');
 pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
 pbox.text(_EDICOLA_PRODUCTS_DETAILS[key].name);
 pbox.bind('click', (function(p_key){
 return function(){
 impostazioniOpenProdotto(_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _EDICOLA_PRODUCTS_DETAILS[p_key].name);
 }
 })(key));
 l_lista_prodotti_container.append(pbox);
 //alert('aaa_ '+_EDICOLA_PRODUCTS_DETAILS[key].icon);
 var img = document.createElement('img');
 img.className = 'impostazioni_body_menu_container_box_icon';
 img.src = _EDICOLA_PRODUCTS_DETAILS[key].icon;//'imgs/fake/s24_small_icon.png';
 pbox.append(img);
 img = null;
 pbox = null;
 }
 }*/
   for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
      if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
         var pbox = $('<div></div>');
         pbox.addClass('impostazioni_body_menu_container_box');
         pbox.addClass('impostazioni_body_menu_container_box_prodotto');
         pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
         pbox.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
         pbox.bind('click', (function (p_key) {
            return function () {
               impostazioniOpenProdotto(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].name);
            }
         })(key));
         l_lista_prodotti_container.append(pbox);
         var img = document.createElement('img');
         img.className = 'impostazioni_body_menu_container_box_icon';
         if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == _CODICE_PRODOTTO_QUOTIDIANO) img.src = 'imgs/fake/s24_small_icon.png';
         else img.src = _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].icon;
         pbox.append(img);
         img = null;
         pbox = null;
      }
   }
   if (_IMPOSTAZIONI_MENU_ISCROLL == null) {
      _IMPOSTAZIONI_MENU_ISCROLL = new iScroll('impostazioni_body_menu_wrapper', {
         bounce: false
      });
   } else {
      // aggiorno iscroll
      _IMPOSTAZIONI_MENU_ISCROLL.refresh();
   }
}
/**
 * Apre il pannello di impostazioni di un prodotto
 * @params p_product_id Il codice del prodotto
 *         p_product_description La descrizione del prodotto
 */
function impostazioniOpenProdotto(p_product_id, p_product_description) {
   impostazioniInitOpen('impostazioni_body_menu_container_box_' + p_product_id, p_product_description);
   $('#cartaceo_codice_abbonato').val('');
   $('#cartaceo_cap').val('');
   $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'none');
   if (_USERNAME) {
      $('#impostazioni_body_vista_container_prodotto_login').css('display', 'none');
      $('#impostazioni_body_vista_container_prodotto_info').css('display', 'inline');
      impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
   } else {
      $('#impostazioni_body_vista_container_prodotto_info').css('display', 'none');
      $('#impostazioni_body_vista_container_prodotto_login').css('display', 'inline-block');
      _NEXT_ACTION = function () {
         impostazioniOpenProdotto(p_product_id, p_product_description);
      }
   }
   $('#impostazioni_body_vista_container_prodotto').css('display', 'inline-block');
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
   }
   omnitureTrackApp('APP:impostazioni:prodotto:' + p_product_id, 'APP:impostazioni');
}
/**
 * Carica le info sull'abbonamento
 */
function impostazioniProdottoCaricaInfoAbbonamento(p_product_id) {
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "appName": device.appname,
      "appVersion": device.appversion,
      "deviceId": device.uuid,
      "deviceType": device.platform,
      "username": _USERNAME
   };
   console.log('---REQ---> subscription/' + p_product_id);
   console.log(l_req_headers);
   console.log(l_req_data);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _SOLEGW_ENDPOINT + "subscription/" + p_product_id + ".json",
      headers: l_req_headers,
      data: l_req_data,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> subscription/' + p_product_id);
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, function () {
            impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
         })) {
            var l_attivo = false;
            var l_date_end = null;
            try {
               //if (p_response.Result.res.endDate == null)
               if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
                  l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);
                  l_attivo = l_date_end > new Date();
               } else {
                  throw {
                     message: "endDate non valorizzato"
                  };
               }
            } catch (exc) {
               console.log(exc.message);
               console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
               l_attivo = false;
               l_date_end = null;
            }
            if (l_attivo) {
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Attivo');
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text(l_date_end.format('dd/mm/yyyy'));
            } else {
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Non Attivo');
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
               /*
 if (p_product_id == _CODICE_PRODOTTO_QUOTIDIANO) {
 $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'inline-block');
 }
 */
               if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
                  _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
               } else {
                  _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
                     bounce: false
                  });
               }
            }
         } else {
            $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('---');
            $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
         }
      },
      error: ajaxErrorHandler
   });
}
/******************************************************
 Gestione impostazioni profilo
 ******************************************************/
/**
 * Apre il popup contenente le informazioni sul profilo utente
 */
var _IMPOSTAZIONI_PROFILO_ISCROLL = null;
var _IMPOSTAZIONI_PROFILO_INITIALIZED = false;

function popupImpostazioniProfilo() {
   window.location = 'http://du.ilsole24ore.com/utenti/areautente/ilmioprofilo.aspx';
   return;
   if (!_IMPOSTAZIONI_PROFILO_INITIALIZED) {
      //Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
      $('#impostazioni_profilo #id_email_address').unbind();
      $('#impostazioni_profilo #id_email_address').keyup(controlloSezioneConsensoEmail);
      //Inizializzazione campo data
      $('#id_birthdate').scroller({
         showOnFocus: false,
         theme: 'ios',
         mode: 'scroller',
         startYear: 1910
      });
      $('#id_birthdate').click(function () {
         $('#id_birthdate').scroller('show');
         return false;
      });
      _IMPOSTAZIONI_PROFILO_INITIALIZED = true;
   }
   $('#impostazioni_profilo').css('display', 'inline');
   $('#impostazioni_profilo_menu').css('display', 'none');
   //Inizializza i dati del profilo utente
   inizializzaProfilo();
}
/**
 * In base alla presenza dell'email mostra i campi per il consenso della privacy
 */
function controlloSezioneConsensoEmail() {
   if ($('#impostazioni_profilo #id_email_address').val() != '') {
      $('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeIn(200, function () {
         if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
            _IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
               bounce: false
            });
         } else {
            _IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
         }
      });
   } else {
      $('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeOut(200, function () {
         if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
            _IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
               bounce: false
            });
         } else {
            _IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
         }
      });
   }
}
/**
 * Inizializza i dati del profilo dell'utente che sta utilizzando l'applicativo
 */
var _PROFILE_FIELDS = [{
   id: 'email_address',
   type: 'text'
}, {
   id: 'ConsensoPrivacy',
   type: 'checkbox'
}, {
   id: 'ConsensoSocieta',
   type: 'checkbox'
}, {
   id: 'ConsensoMail',
   type: 'checkbox'
}, {
   id: 'first_name',
   type: 'text'
}, {
   id: 'last_name',
   type: 'text'
}, {
   id: 'birth_year',
   type: 'text'
}, {
   id: 'birth_month',
   type: 'text'
}, {
   id: 'birth_day',
   type: 'text'
}, {
   id: 'gender',
   type: 'select'
}, {
   id: 'address_street',
   type: 'text'
}, {
   id: 'city',
   type: 'text'
}, {
   id: 'provincia',
   type: 'text'
}, {
   id: 'state',
   type: 'text'
}, {
   id: 'zip_code',
   type: 'text'
}, {
   id: 'tel_number',
   type: 'text'
}, {
   id: 'mobile_phone',
   type: 'text'
}, {
   id: 'fax_number',
   type: 'text'
}, {
   id: 'societa_ente',
   type: 'text'
}, {
   id: 'professione',
   type: 'text'
}, {
   id: 'settore',
   type: 'text'
}, {
   id: 'codice_fiscale',
   type: 'text'
}, {
   id: 'partita_iva',
   type: 'text'
}];

function inizializzaProfilo() {
   console.log('Get profilo info for user ' + _USERNAME);
   $('#impostazioni_profilo #id_username').text(_USERNAME);
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "username": _USERNAME
   };
   console.log('---REQ---> getUserProfile');
   console.log(l_req_headers);
   console.log(l_req_data);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _API24_ENDPOINT + "Users/getUserProfile",
      headers: l_req_headers,
      data: l_req_data,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> getUserProfile');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, inizializzaProfilo)) {
            //Per tutti i campi definiti in _PROFILE_FIELDS vengono inizializzati i valori nel popup di impostazioni profilo
            for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
               //Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
               var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
               //Se l'elemento html esiste
               if (l_html_element) {
                  //In base al tipo di elemento viene inizializzato il valore
                  if (_PROFILE_FIELDS[i].type == 'text') {
                     if (p_response.Result[_PROFILE_FIELDS[i].id]) {
                        l_html_element.val(p_response.Result[_PROFILE_FIELDS[i].id]);
                     } else {
                        l_html_element.val('');
                     }
                  }
                  if (_PROFILE_FIELDS[i].type == 'checkbox') {
                     if (p_response.Result[_PROFILE_FIELDS[i].id]) {
                        if (p_response.Result[_PROFILE_FIELDS[i].id] == '0') {
                           l_html_element.attr('checked', false);
                        } else if (p_response.Result[_PROFILE_FIELDS[i].id] == '1') {
                           l_html_element.attr('checked', true);
                        }
                     } else {
                        l_html_element.attr('checked', false);
                     }
                     l_html_element.change();
                  }
                  if (_PROFILE_FIELDS[i].type == 'select') {
                     $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').removeAttr('selected');
                     l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option[value=' + p_response.Result[_PROFILE_FIELDS[i].id] + ']');
                     l_html_element.attr('selected', 'selected');
                  }
               }
            }
            //Inizializzazione campo data di nascita
            if (p_response.Result['birth_day'] && p_response.Result['birth_month'] && p_response.Result['birth_year']) {
               $('#id_birthdate').scroller('setDate', new Date(p_response.Result['birth_month'] + '/' + p_response.Result['birth_day'] + '/' + p_response.Result['birth_year']), true);
            }
            controlloSezioneConsensoEmail();
         }
         /*
 else {
 //Gestione eccezioni
 //TODO
 alert('Attenzione, ' + p_response.Exception.Description);
 }
 */
      },
      error: ajaxErrorHandler
   });
}
/**
 * Salva i dati del profilo
 */
function popupImpostazioniProfiloAvanti() {
   if (controlloDatiProfilo()) {
      // Definizione del profilo utente
      var l_user_profile = {
         "siteCode": _API24_SITECODE,
         "username": _USERNAME,
         "disclaimer": "1"
      };
      var l_user_email = $('#impostazioni_profilo #id_email_address').val();
      // Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
      if (l_user_email != '') {
         l_user_profile['email_address'] = l_user_email;
         l_user_profile['consensoPrivacy'] = ($('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked') == "checked" ? '1' : '0');
         l_user_profile['consensoMail'] = ($('#impostazioni_profilo #id_ConsensoMail').attr('checked') == "checked" ? '1' : '0');
         l_user_profile['consensoSocieta'] = ($('#impostazioni_profilo #id_ConsensoSocieta').attr('checked') == "checked" ? '1' : '0');
      }
      //Imposta la data di nascita
      var l_birthdate = $('#id_birthdate').scroller('getDate');
      $('#impostazioni_profilo #id_birth_day').val(l_birthdate.getDate());
      $('#impostazioni_profilo #id_birth_month').val(l_birthdate.getMonth() + 1);
      $('#impostazioni_profilo #id_birth_year').val(l_birthdate.getFullYear());
      //Per tutti i campi definiti in _PROFILE_FIELDS vengono letti i nuovi valori dal popup di impostazioni profilo
      for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
         if (!(_PROFILE_FIELDS[i].id in {
            email_address: 1,
            ConsensoPrivacy: 1,
            ConsensoMail: 1,
            ConsensoSocieta: 1
         })) {
            //Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
            var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
            //Se l'elemento html esiste
            if (l_html_element) {
               //In base al tipo di elemento viene settato il nuovo valore
               if (_PROFILE_FIELDS[i].type == 'text') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = l_html_element.val();
               }
               if (_PROFILE_FIELDS[i].type == 'checkbox') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = (l_html_element.attr('checked') == "checked" ? '1' : '0');
               }
               if (_PROFILE_FIELDS[i].type == 'select') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').val();
               }
            }
         }
      }
      console.log('updateUserProfile call for ' + _USERNAME + ': ' + l_user_profile);
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "profile": l_user_profile
      };
      console.log('---REQ---> updateUserProfile');
      console.log(l_req_headers);
      console.log(l_req_data);
      $.ajax({
         type: "POST",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         url: _API24_ENDPOINT + "Users/updateUserProfile",
         headers: l_req_headers,
         processData: false,
         data: JSON.stringify(l_req_data),
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> updateUserProfile');
            console.log(p_response);
            if (checkAjaxResponse(p_response, popupImpostazioniProfiloAvanti)) {
               //Chiudi popup
               popupImpostazioniProfiloChiudi();
            } else {
               //Gestione messaggi di errore dal server
               if (p_response.Exception.Name == 'InvalidParameterException') {
                  abutils.alert('Attenzione, uno o più campi inseriti non sono validi.', 'Aggiornamento profilo')
               } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
                  abutils.alert(p_response.Exception.Description, 'Aggiornamento profilo');
               }
            }
         },
         error: function (xmlHttpRequest, textStatus, errorThrown) {
            /*
 console.log('ajax error');
 console.log(textStatus);
 alert('Funzione non disponibile in assenza di connessione');
 */
         }
      });
   }
}
/**
 * Controlla che i dati del profilo siano stati immessi correttamente
 */
function controlloDatiProfilo() {
   var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
   // Controllo email
   email = $('#impostazioni_profilo #id_email_address').val();
   if (email == '') {
      abutils.alert("Attenzione, inserire un indirizzo email valido.", 'Profilo utente');
      return false;
   }
   if (email != '' && !ck_email.test(email)) {
      abutils.alert("Attenzione, l'indirizzo email inserito non è valido.", 'Profilo utente');
      return false;
   }
   // Controllo consenso alla privacy solo in caso di email non vuota
   if (email != '' && !$('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked')) {
      abutils.alert("Attenzione, per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Profilo utente');
      return false;
   }
   return true;
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloChiudi() {
   //$('#impostazioni_profilo').fadeOut();
   $('#impostazioni_profilo').css('display', 'none');
}
/******************************************************
 Gestione popup di account menu
 ******************************************************/
/**
 * Apre il popup contenente il menu delle azioni riguardanti il profilo utente
 * Da tale menu l'utente potrà:
 *   - Visualizzare informazioni del proprio profilo
 *   - Disassociare il proprio account
 */
function popupImpostazioniProfiloMenu() {
   //alert('is '+$('#impostazioni_prodotto_principale_select'));
   $('#impostazioni_prodotto_principale_select').attr('disabled', 'true');
   $('#impostazioni_profilo_menu_account_username').text(_USERNAME);
   $('#impostazioni_profilo_menu').css('display', 'inline');
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloMenuChiudi() {
   //$('#impostazioni_profilo_menu').fadeOut();
   //alert('is '+$('#impostazioni_prodotto_principale_select').attr());
   $('#impostazioni_prodotto_principale_select').removeAttr('disabled');
   $('#impostazioni_profilo_menu').css('display', 'none');
}
/******************************************************
 Gestione pannello lista dispositivi
 ******************************************************/
/**
 * Apre la sezione per la gestione dei dispositivi associati all'utente
 */
function impostazioniGeneraliDispositivi() {
   $('#impostazioni_body_vista_container_dispositivi_lista').css('display', 'none');
   $('#impostazioni_body_vista_container_generali').css('display', 'none');
   $('#impostazioni_body_vista_container_dispositivi').css('display', 'inline-block');
   //Inizializza il pulsante di ritorno verso le impostazioni generali
   /*
 var l_back_button = $('#impostazioni_titolo_vista_back_button');
 l_back_button.html('<span></span>Generali');
 l_back_button.css('display', 'inline-block');
 l_back_button.click(impostazioniGeneraliDispositiviChiudi);
 */
   $('#impostazioni_titolo_vista_txt').text('Dispositivi');
   inizializzaListaDispositivi();
}
/**
 * Ottiene dal server la lista dei dispositivi associati all'utente ed inizializza la sezione
 */
function inizializzaListaDispositivi() {
   if (_USERNAME) {
      //console.log('Get devices for user ' + _USERNAME);
      var l_section_body = $('#impostazioni_body_vista_container_dispositivi_lista');
      l_section_body.empty();
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "username": _USERNAME
      };
      console.log('---REQ---> getUserDevices');
      console.log(l_req_headers);
      console.log(l_req_data);
      //Ottengo i dispositivi associati all'utenza in base alle info date da API24
      $.ajax({
         type: "GET",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         url: _API24_ENDPOINT + "Users/getUserDevices",
         headers: l_req_headers,
         data: l_req_data,
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> getUserDevices');
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response, inizializzaListaDispositivi)) {
               //p_response.Result.res = [{"id":"1234567890","name":"Questo device","type":1},{"id":"222","name":"Device 2","type":2},{"id":"333","name":"Device 3","type":3}]; //TODO PER DEBUG
               for (var i = 0; i < p_response.Result.res.length; i++) {
                  var l_device = p_response.Result.res[i];
                  //I dispositivi associati vengono memorizzati in una variabile globale
                  _USER_DEVICES[l_device.id] = l_device;
                  //Viene creato l'elemento nella lista dei dispositivi
                  var l_device_element_container = $('<div></div>');
                  l_device_element_container.addClass('impostazioni_body_vista_container_label');
                  if (l_device["name"] != '') l_device_element_container.html(decodeURIComponent(l_device["name"]) + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
                  else l_device_element_container.html("Dispositivo senza nome" + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
                  if (l_device.id != device.uuid) {
                     var l_device_element_button = $('<div></div>');
                     l_device_element_button.addClass("button medium red24 impostazioni_body_vista_container_label_button");
                     l_device_element_button.text("Disassocia");
                     l_device_element_button.attr("onclick", '_NEXT_ACTION=impostazioniGeneraliDispositivi;popupDisassociaDispositivo("' + l_device.id + '")');
                     l_device_element_container.append(l_device_element_button);
                  }
                  l_section_body.append(l_device_element_container);
               }
               l_section_body.fadeIn();
               if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
                  _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
                     bounce: false
                  });
               } else {
                  _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
               }
            } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
               abutils.alert(p_response.Exception.Description, 'Dispositivi');
            }
         },
         error: ajaxErrorHandler
      });
   } else {
      impostazioniGeneraliDispositiviChiudi();
      inizializzaAgganciaProfilo();
   }
}
/**
 * Chiude la sezione per la gestione dei dispositivi e riapre le impostazioni generali
 */
function impostazioniGeneraliDispositiviChiudi() {
   $('#impostazioni_titolo_vista_txt').text('Generali');
   //Inizializza il pulsante di ritorno verso le impostazioni generali
   var l_back_button = $('#impostazioni_titolo_vista_back_button');
   l_back_button.html('<span></span>');
   l_back_button.css('display', 'none');
   $('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
   $('#impostazioni_body_vista_container_dispositivi').css('display', 'none');
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
}
/******************************************************
 Gestione popup disassocia dispositivo
 ******************************************************/
/**
 * Apre il popup che permette di disassociare un dispositivo
 */
function popupDisassociaDispositivo(p_device_id) {
   $('#disassocia_dispositivo').css('display', 'inline');
   if (p_device_id) {
      $('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti("' + p_device_id + '");')
   } else {
      $('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti();')
   }
}
/**
 * Chiude il popup per disassociare un dispositivo
 */
function popupDisassociaDispositivoChiudi() {
   //$('#impostazioni_profilo_menu').fadeOut();
   $('#disassocia_dispositivo').css('display', 'none');
}
/**
 * Disassocia l'account dal dispositivo
 */
function popupDisassociaDispositivoAvanti(p_device_id) {
   console.log('Delete user association to the device');
   var l_request_data = {
      "username": _USERNAME,
      "deviceID": device.uuid,
      "deviceType": device.platform
   };
   //Se il device id è settato viene disassociato il device memorizzato in _USER_DEVICES[l_device.id]
   if (p_device_id) {
      l_request_data["deviceID"] = p_device_id;
      l_request_data["deviceType"] = _USER_DEVICES[p_device_id]["type"];
   } else {
      _EDICOLA_LAST_PRODUCT_LOAD = 0;
   }
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   console.log('---REQ---> removeUserDevice');
   console.log(l_req_headers);
   console.log(l_request_data);
   /*
 navigator.notification.loadingStart({
 'labelText': "Disassociazione in corso...",
 'backgroundOpacity': 0.8,
 'strokeOpacity': 0.25,
 'strokeColor': "FFFFFF",
 });*/
   window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Disassociazione in corso..."]);
   //Ottengo la username associata al device in base alle info date da API24
   $.ajax({
      type: "POST",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _API24_ENDPOINT + "Users/removeUserDevice",
      headers: l_req_headers,
      data: JSON.stringify(l_request_data),
      processData: false,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> removeUserDevice');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, function () {
            popupDisassociaDispositivoAvanti(p_device_id);
         })) {
            if (!p_device_id) {
               abutils.alert('L\'account è stato disassociato dal dispositivo', 'Disassociazione dispositivo');
               setUserData(null, null, null);
               /*
 _USERNAME = null;
 _PASSWORD = null;
 deleteUsername();
 deletePassword();
 */
               inizializzaAgganciaProfilo();
            }
            popupDisassociaDispositivoChiudi();
            gestisciProssimaAzione();
				openProductDetails(_PRODUCT_IN_EDICOLA.productId);
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
            abutils.alert(p_response.Exception.Description, 'Disassociazione dispositivo');
         } else {
            abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      },
      error: function () {
         abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
         navigator.notification.loadingStop();
      }
   });
}
/**
 * Cancella tutte le edizioni presenti in locale
 */
function impostazioniCancellaContenutoLocale() {
	if (_LockTap) return;
	_LockTap = true;
	window.simulatePG.confirm('Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?', 'impostazioniCancellaContenutoLocaleSucc()' , 'Cancellazione contenuto locale', 'Si,No');
	
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}
/*
 * Aggancio abbonamento cartaceo
 */
function impostazioniCartaceoAgganciaAbbonamento() {
   var l_sub_code = $('#cartaceo_codice_abbonato').val();
   var l_sub_cap = $('#cartaceo_cap').val();
   if ((l_sub_code.length <= 0) || (l_sub_cap.length <= 0)) {
      abutils.alert('Inserire il proprio Codice Abbonato e il CAP', 'Aggancio abbonamento');
      return;
   }
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "username": _USERNAME,
      "deviceID": device.uuid,
      "deviceType": device.platform,
      "appName": device.appname,
      "appVersion": device.appversion,
      "subscriptionCode": l_sub_code,
      "subscriptionType": "XXX",
      "cap": l_sub_cap
   };
   console.log('---REQ---> subscription-paper');
   console.log(l_req_headers);
   console.log(l_req_data);
   window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
   $.ajax({
      type: "POST",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _SOLEGW_ENDPOINT + "subscription-paper.json",
      headers: l_req_headers,
      processData: false,
      data: JSON.stringify(l_req_data),
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> subscription-paper');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, impostazioniCartaceoAgganciaAbbonamento)) {
            abutils.alert('Il tuo abbonamento cartaceo è stato associato al tuo profilo', 'Aggancio abbonamento');
            $('#impostazioni_body_menu_container_box_' + _CODICE_PRODOTTO_QUOTIDIANO).click();
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
            abutils.alert(p_response.Exception.Description, 'Aggancio abbonamento');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      },
      error: function () {
         abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Aggancio abbonamento');
         navigator.notification.loadingStop();
      }
   });
}/**
 * @author mconventi
 */
_RICHOFFLINE_FILTRO_EDIZIONI = new Array();
var _MOD_OFFLINE = null;
var _EDICOLA_OFFLINE_MODE = 'ICONS';
//console.log('PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS');
function enableOfflineMode(){
    if (_MOD_OFFLINE != true) {
        _MOD_OFFLINE = true;
		
        //if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
            edicolaOfflineOpen();
        //}
    }
}

function enableOnlineMode(){
    if (_MOD_OFFLINE != false) {
    	
    	var l_first_run = _MOD_OFFLINE == null;
    	
        _MOD_OFFLINE = false;
        
        //if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
            edicolaOfflineClose(!l_first_run);
        //}
    }
}

function edicolaOfflineOpen(){
    edicolaOfflineInitFilter();
    edicolaOfflineLoad('ICONS');
    $('#edicola_offline').css('display', 'inline-block');
	$('#edicola').css('display', 'none');
	
	// CLOSE OPENED ARCHIVES
	if ($('#archivio_titolo_chiudi_edicola').is(':visible')) $('#archivio_titolo_chiudi_edicola').trigger('click');
	if ($('#archivio_titolo_chiudi_sfoglio').is(':visible')) $('#archivio_titolo_chiudi_sfoglio').trigger('click');
	if ($('#qarchivio_titolo_chiudi_edicola').is(':visible')) $('#qarchivio_titolo_chiudi_edicola').trigger('click');
	if ($('#qarchivio_titolo_chiudi_sfoglio').is(':visible')) $('#qarchivio_titolo_chiudi_sfoglio').trigger('click');
    
    // disabilito impostazioni
    $('#impostazioni_body_menu_container_box_lista_prodotti').css('display', 'none');
    $('#impostazioni_body_menu_container_box_codicepromozionale').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_prodottoprincipale').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_memoria').hide();
    impostazioniOpenGenerali();
    
    if(window.innerWidth < 790 || window.innerWidth == 1024){
    	$("#edicola_offline_filtro").hide();
    }
}

function edicolaOfflineClose(reloadEdicola){
	console.log("database reloadEdicola " + reloadEdicola);
	if (reloadEdicola) {
		/*
		navigator.notification.loadingStart({
	        'labelText': "Modalità on-line...",
	        'backgroundOpacity': 0.80,
	        'strokeOpacity': 0.25,
	        'strokeColor': "FFFFFF",
	    });
	    */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento","Modalità on-line..."]);
    	
	    setTimeout(function() {
			_DB = null;
			
			//window.simulatePG.relaod();
			
	    	window.location = 'galaxy.html';
	    	
		    /*$('#edicola_container').show();
		    $('#edicola_prodotto').show();
		    $('#edicola').css('display', 'inline-block');
		    $('#edicola_offline').css('display', 'none');
		    loadProducts();
	    	
	    	window.simulatePG.exec(null, null, "Notification", "activityStop", []);*/
	    }, 1500);
   	} else {
   		$('#edicola_container').hide();
	    $('#edicola_prodotto').hide();
	    $('#edicola').css('display', 'inline-block');
	    $('#edicola_offline').css('display', 'none');
	    loadProducts();
   	}
	$('#impostazioni_body_vista_container_generali_memoria').show();
}


var _EDICOLA_OFFLINE_ISCROLL = null;
function edicolaOfflineUpdateIscroll(){
    if (!_MOD_OFFLINE) 
        return;
    setTimeout(function(){
        if (_EDICOLA_OFFLINE_ISCROLL == null) {
            _EDICOLA_OFFLINE_ISCROLL = new iScroll('edicola_offline_wrapper', {
                hideScrollbar: false
            });
        }
        else {
            _EDICOLA_OFFLINE_ISCROLL.refresh();
            _EDICOLA_OFFLINE_ISCROLL.scrollTo(0, 0, 0);
        }
    }, 100);
}

/**
 * Carica gli articoli salvati in locale
 */
function edicolaOfflineLoad(mode){


    _EDICOLA_OFFLINE_MODE = mode;
    
    if (_EDICOLA_OFFLINE_ISCROLL != null) {
        _EDICOLA_OFFLINE_ISCROLL.destroy();
        _EDICOLA_OFFLINE_ISCROLL = null;
    }
    
    
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
        
            $('#edicola_offline_container').empty();
            $('#edicola_offline_subtitolo_opzioni_vista_ICONS').removeClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on');
            $('#edicola_offline_subtitolo_opzioni_vista_LIST').removeClass('edicola_offline_subtitolo_opzioni_vista_LIST_on');
            $('#edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE).addClass('edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE + '_on');
            
            var len = p_results.rows.length;
            console.log("edicolaOfflineLoad: read items:" + len);
            
            for (var i = 0; i < p_results.rows.length; i++) {
                if (_EDICOLA_OFFLINE_MODE == 'ICONS') {
                    edicolaOfflineRenderAsIcon(p_results.rows.item(i));
                }
                else {
                    edicolaOfflineRenderAsList(p_results.rows.item(i));
                }
                edicolaOfflineUpdateFilter(p_results.rows.item(i));
            }
            
            //Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
            // sempre una visualizzazione coerente in base al prodotto filtrato
            $('#edicola_offline_filtro').change();
					
				var isPortrait = window.innerWidth < window.innerHeight;
				if (isPortrait) {
					$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 7));
				} else {
					$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 4));
				}
            
            edicolaOfflineUpdateIscroll();
				updateRichFiltroOff();
        }
        
        var queryError = function(p_error){
            console.log("edicolaOfflineLoad: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM issues order by issue DESC', [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
    
}

/**
 * Crea la rappresentazione di un oggetto in locale come icona
 * @params p_item Oggetto in locale come salvato nel db issues
 */
function edicolaOfflineRenderAsIcon(p_item){
    var box = document.createElement('div');
    document.getElementById('edicola_offline_container').appendChild(box);
    //box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
    box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    box.style['display'] = 'none';
    
    var img_div = document.createElement('div');
    img_div.className = 'edicola_offline_container_box_img_div';
    img_div.id = 'edicola_offline_container_box_icon_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    $(img_div).click(function(){
		if (!$('#edicola_offline_container').hasClass('edicola_offline_modify')) 
        	sfoglia(p_item.testata, p_item.issue, p_item.edizione);
    });
    box.appendChild(img_div);
    
    var img = document.createElement('img');
    img_div.appendChild(img);
    img.className = 'edicola_offline_container_box_img';
    //img.src = navigator.fileMgr.docsFolderPath + '/issues/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//ANDROID MODDED
    img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/ '/'  + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';
    //console.log("path-off:: "+navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg');
    
    
    var txt = document.createElement('div');
    txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
    txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong><br/>' + p_item.issue_descr + '<br />' + p_item.edizione_descr;
    box.appendChild(txt);
    
    // flag stato edizione
    var txt_local = document.createElement('div');
    box.appendChild(txt_local);
    txt_local.id = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    txt_local.className = 'edicola_offline_container_box_txt_empty_' + _EDICOLA_OFFLINE_MODE;
    $(txt_local).click(function(){
        if ($('#edicola_offline_container').hasClass('edicola_offline_modify')) {
            eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
        }
    });
}
            

/**
 * Crea la rappresentazione in lista di un oggetto salvato in locale
 * @params p_item Oggetto salvato in locale
 *
 */
function edicolaOfflineRenderAsList(p_item){

    var box = document.createElement('div');
    document.getElementById('edicola_offline_container').appendChild(box);
    //box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
    box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    box.style['display'] = 'none';
    
    var txt = document.createElement('div');
    box.appendChild(txt);
    txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
    //txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong> ' + p_item.edizione_descr + ' ' + p_item.issue_descr;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;
    
    // bottone
    var btndiv = document.createElement('div');
    box.appendChild(btndiv);
    btndiv.style['float'] = 'right';
    var btn = document.createElement('input');
    btn.id = 'edicola_offline_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    btn.type = 'button';
    btn.className = 'button medium red24 edicola_offline_show_local_copy_btn';
    btn.value = 'Sfoglia';
    $(btn).click(function(){
        sfoglia(p_item.testata, p_item.issue, p_item.edizione);
    });
    btndiv.appendChild(btn);
    
    // delete
    var del_btn = document.createElement('input');
    del_btn.id = 'edicola_offline_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    del_btn.type = 'button';
    del_btn.value = 'Elimina';
    del_btn.className = 'button medium red24 edicola_offline_delete_local_copy_btn';
    
    $(del_btn).click(function(){
        eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
    });
    
    btndiv.appendChild(del_btn);
}

/**
 * Inizializza il filtro sulle testate/edizioni da mostrare.
 */
_EDICOLA_OFFLINE_FILTRO_EDIZIONI = null;
function edicolaOfflineInitFilter(){
    if (_EDICOLA_OFFLINE_FILTRO_EDIZIONI != null) {
        $(_EDICOLA_OFFLINE_FILTRO_EDIZIONI).empty();
    }
    else {
        _EDICOLA_OFFLINE_FILTRO_EDIZIONI = new Array();
    }
    var l_filtro_select = $('#edicola_offline_filtro');
    l_filtro_select.empty();
    
    l_filtro_select.change(function(){
        var l_selected_option = $('#edicola_offline_filtro option:selected');
        
        if (l_selected_option.val() == '') {
            //$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).css('display', 'inline-block');
        }
        else {
            $('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).not('.edicola_offline_' + l_selected_option.val()).css('display', 'none');
            //$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).css('display', 'inline-block');
        }
		
		edicolaOfflineUpdateIscroll();
    });
    
    var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
    l_filtro_select.append(l_option);
    
    var row = {
			value : "", 
			label: "Tutti i prodotti"
    }
	console.log('rich '+row.value+','+row.label);
    _RICHOFFLINE_FILTRO_EDIZIONI.push(row);
}

/**
 * Gestisce la creazione del filtro sui prodotti da mostrare.
 * @params p_item Oggetto salvato in locale
 */
function edicolaOfflineLabelToValue(p_label) {
	return p_label.replace(/[^a-zA-Z0-9]/g,'x').toLowerCase();
}
function edicolaOfflineUpdateFilter(p_item){
    //var l_value = p_item.testata + '_' + p_item.edizione;
	var l_value = edicolaOfflineLabelToValue(p_item.edizione_descr);
    //var l_text = p_item.testata_descr + ' - ' + p_item.edizione_descr;
	var l_text = p_item.edizione_descr;
    //Se l'edizione non è presente nell'array _EDICOLA_OFFLINE_FILTRO_EDIZIONI crea un nuovo elemento nell'array ed aggiunge un opzione nel filtro
    if (jQuery.inArray(l_value, _EDICOLA_OFFLINE_FILTRO_EDIZIONI) == -1) {
    
        _EDICOLA_OFFLINE_FILTRO_EDIZIONI.push(l_value, l_text);
		
        var row = {	
				value : l_value, 
				label: l_text
			};
		console.log('rich '+row.value+','+row.label);
        _RICHOFFLINE_FILTRO_EDIZIONI.push(row);
        
        //alert(_RICHOFFLINE_FILTRO_EDIZIONI.length);
        
        var l_option = $('<option></option>');
        l_option.val(l_value);
        l_option.text(l_text);
        $('#edicola_offline_filtro').append(l_option);
    }
}

function updateRichFiltroOff(){
		var value_select = $('#edicola_offline_filtro option:selected').val();
		var dhtmlx_listProductsSelectOff = _RICHOFFLINE_FILTRO_EDIZIONI;
		
		$$('myRichOffselect').attachEvent("onchange",/*impostazioniProdottoPrincipaleSelectOnChange()*/function(newv,oldv){
			setTimeout(function(){
				if(oldv != newv){
					
							$('#edicola_offline_filtro option:selected').removeAttr('selected');

						if(newv.indexOf('Tutti i prodotti')==-1){
							$("#edicola_offline_filtro option[value='"+newv+"']").attr('selected', 'selected');
						}else{
							//alert('aaa'+newv);
							$("#edicola_offline_filtro option[value='']").attr('selected', 'selected');
						}
						console.log('changed');
						edicolaOfflineLoad(_EDICOLA_OFFLINE_MODE);
				}
			}, 200);

		});
		
}


/**
 * Passa alla modalità modifica
 */
function edicolaOfflineModifica(){
    $('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'none');
    $('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'inline-block');
    $('#edicola_offline_container').addClass('edicola_offline_modify');
}

/**
 * Passa alla modalità visualizza
 */
function edicolaOfflineVisualizza(){
    $('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'inline-block');
    $('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'none');
    $('#edicola_offline_container').removeClass('edicola_offline_modify');
}


var _INBOX_LIST_ISCROLL = null;
var _INBOX_MESSAGES = {};
var _INBOX_NUM_UNREAD_MESSAGES = 0;

function inboxRefreshInCorso() {
	$('#inbox_list_refresh_button').css('display', 'none');
	$('#inbox_list_refresh_message').html('Aggiornamento in corso...');
}

function inboxRefreshCompletato() {
	setTimeout(function() {
		$('#inbox_list_refresh_button').css('display', 'inline');
		$('#inbox_list_refresh_message').html('<strong>Aggiornato</strong> ' + (new Date()).format('dd/mm/yyyy') + ' <strong>' + (new Date()).format('HH:MM:ss') + '</strong>');
	}, 1000);
}

/*
 * Restituisce i messaggi presenti nel database locale
 * @return Lista di messaggi
 */
function inboxLoadMessages(){

    if (_INBOX_LIST_ISCROLL != null) {
        _INBOX_LIST_ISCROLL.destroy();
        _INBOX_LIST_ISCROLL = null;
    }
    
    $('#inbox_list_container').empty();
    
    // Controlla che il database sia stato inizializzato e carica i messaggi
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            //console.log("Read " + len + " messages from the local INBOX store.");
            
            inboxAddMessages(p_results.rows);
            
            inboxLoadUnreadMessages();
			
			//inboxOpenFirstMessageSilent();
			
			setInterval(inboxLoadUnreadMessages, _INTERVALLO_CHECK_INBOX);
        }
        
        var queryError = function(p_error){
            console.log("inboxLoadMessages: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            //tx.executeSql('DROP TABLE IF EXISTS INBOX_MESSAGES_2');
            tx.executeSql('CREATE TABLE IF NOT EXISTS INBOX_MESSAGES_2 (id unique, date, subject, mabstract, body, status)');
            tx.executeSql('SELECT id, date, subject, mabstract, body, status FROM INBOX_MESSAGES_2 order by date asc, id asc', [], querySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

function inboxCloseMsgView(){
	//$('#inbox_msg_container').css('display', 'none');
    $('#inbox_container').removeClass('inbox_container_open');
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
}

function inboxUpdateOrientation(){
    document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    
    console.log('inboxUpdateOrientation '+$('#inbox_container').hasClass('inbox_container_open')+','+document.getElementById('inbox_container').className);
    
    //se aperto msg inbox lo riapro quando sono in verticale
    if($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width < 790){
    	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
    }else if($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width > 790){
    	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
    }
    
    if (_INBOX_MSG_ISCROLL != null) {
        _INBOX_MSG_ISCROLL.refresh();
    }
    if (_INBOX_LIST_ISCROLL != null) {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function inboxAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
        inboxAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function inboxAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	inboxUpdateUnreadMessage();
}

/**
 * Carica i messaggi non letti in base al device
 */
var _INBOX_TOBEFETCH_MSGS = [];
var _INBOX_REFRESH_ISRUNNING = false;
function inboxLoadUnreadMessages(){
	
	if (_INBOX_REFRESH_ISRUNNING || (_INBOX_TOBEFETCH_MSGS.length > 0)) {
		console.log('Aggiornamento già in corso...');
		return;
	}
	
	_INBOX_REFRESH_ISRUNNING = true;

	inboxRefreshInCorso();

    //console.log('Retrieve unread messages');
    var l_signature = getSignature(device.uuid + ',' + device.platform);
    //console.log('Signature: ' + l_signature);
    
    var l_req_headers = {
        "appKey": _API24_APPKEY,
        "Signature": l_signature
    };
    var l_req_data = {
        "deviceID": device.uuid,
        "deviceType": device.platform
    };
    console.log('---REQ---> getUnreadMessagesDevice');
    console.log(l_req_headers);
    console.log(l_req_data);
    
    $.ajax({
        type: "GET",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/getUnreadMessagesDevice",
        headers: l_req_headers,
        data: l_req_data,
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> getUnreadMessagesDevice');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
                for (var i = 0; i < p_response.Result.messages.length; i++) {
                    var l_message = p_response.Result.messages[i];
                    _INBOX_TOBEFETCH_MSGS.push({
                        id: l_message.id,
                        subject: l_message.subject,
                        mabstract: "",
                        date: l_message.data,
                        body: "",
                        status: 1
                    });
                }
                
                inboxFetchMessages();
                
            }
            else {
                inboxRefreshCompletato();
            }
			
			_INBOX_REFRESH_ISRUNNING = false;
        },
        error: function() {
			inboxRefreshCompletato();
			
			_INBOX_REFRESH_ISRUNNING = false;
		}
    });
    
}

function inboxFetchMessages(){
    var l_message = _INBOX_TOBEFETCH_MSGS.shift();
    if (l_message == null) {
		inboxRefreshCompletato();
		//inboxOpenFirstMessageSilent();
		return;
	}
    console.log(l_message);
    
    // scarico in locale il messaggio
    var l_req_headers = {
        "appKey": _API24_APPKEY
    };
    var l_req_data = {
        "messageId": l_message.id
    };
    console.log('---REQ---> getMessageBody (' + l_message.id + ')');
    console.log(l_req_headers);
    console.log(l_req_data);
    
    $.ajax({
        type: "GET",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/getMessageBody",
        headers: l_req_headers,
        data: l_req_data,
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> getMessageBody (' + l_message.id + ')');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
				
                l_message.body = p_response.Result.body;
				
				if (p_response.Result.preview) {
					l_message.mabstract = p_response.Result.preview;
				} else {
					l_message.mabstract = "";
				}
                
                inboxMarkAsReadMessageOnServer(l_message);
                
            }
            else {
                inboxFetchMessages();
            }
        },
        error: function(){
            inboxFetchMessages();
        }
    });
}

function inboxMarkAsReadMessageOnServer(p_message){
    var l_signature = getSignature(p_message.id + ',' + device.uuid + ',' + device.platform);
    var l_req_headers = {
        "appKey": _API24_APPKEY,
        "Signature": l_signature
    };
    var l_req_data = {
        "messageId": p_message.id,
        "deviceId": device.uuid,
        "deviceType": device.platform
    };
    console.log('---REQ---> markMessageReadDevice (' + p_message.id + ')');
    console.log(l_req_headers);
    console.log(l_req_data);
    $.ajax({
        type: "POST",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/markMessageReadDevice",
        headers: l_req_headers,
        processData: false,
        data: JSON.stringify(l_req_data),
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> markMessageReadDevice (' + p_message.id + ')');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
                // processo verso server completato, posso salvare il messaggio in locale
                inboxStoreMessageFromServer(p_message);
            }
            else {
                inboxFetchMessages();
            }
            
            
        },
        error: function(){
            inboxFetchMessages();
        }
    });
}

function inboxStoreMessageFromServer(p_message){
    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB) {
    
        var querySuccess = function(){
            console.log('inboxStoreMessageFromServer OK');
            inboxAddMessage(p_message);
            inboxFetchMessages();
        }
        
        var queryError = function(p_error){
            console.log("inboxStoreMessageFromServer KO: Error processing SQL: " + p_error.message);
            inboxFetchMessages();
        }
        
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO INBOX_MESSAGES_2 (id, date, subject, mabstract, body, status) VALUES (?,?,?,?,?,?)', [p_message.id, p_message.date, p_message.subject, p_message.mabstract, p_message.body, p_message.status], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function inboxRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
    	if(screen.width < 790){
    		l_subject = l_subject.substring(0, 25);
    	}else{
    		l_subject = l_subject.substring(0, 40);
    	}
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            inboxOpenMessage(p_mid);
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

/*
function inboxOpenFirstMessageSilent() {
	var l_opened = $('.inbox_list_container_box_active');
	if (l_opened.length == 0) {
		var l_boxes = $('.inbox_list_container_box');
		if (l_boxes.length > 0) {
			console.log(l_boxes);
			$(l_boxes[0]).click();
			inboxCloseMsgView();
		}
	}
}
*/

var _INBOX_MSG_ISCROLL = null;
function inboxOpenMessage(mid){
	
    if (_INBOX_MSG_ISCROLL != null) {
        _INBOX_MSG_ISCROLL.destroy();
        _INBOX_MSG_ISCROLL = null;
    }
    
    inboxInitNavButtons(mid);
    
	$('#inbox_msg_title_content_del').css('display', 'inline-block');
	$('#inbox_msg_container_empty').css('display', 'none');
	
    var l_message_container = $('#inbox_msg_container');
    l_message_container.css('display', 'inline-block');
	
    var box = document.getElementById('inbox_list_container_box_' + mid);
    $('.inbox_list_container_box').removeClass('inbox_list_container_box_active');
    $(box).addClass('inbox_list_container_box_active');
    $(box).removeClass('inbox_list_container_box_unread');
    $(box).addClass('inbox_list_container_box_read');
    box = null;
	
	/*
	if (_ORIENTATION == 'V' && screen.width < 790){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-400px, 0px, 0)';
	} else if (_ORIENTATION == 'V' && screen.width > 790){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-800px, 0px, 0)';
	} else if(_ORIENTATION == 'H'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}
	*/
	
	if (_ORIENTATION == 'V'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if(_ORIENTATION == 'H'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}
	
	//.className+=' newclass'
	//document.getElementById('inbox_container').className += 'inbox_container_open';
	//alert('aaa'+document.getElementById('inbox_container').className);
    $('#inbox_container').addClass('inbox_container_open');
    //alert('aaa'+document.getElementById('inbox_container').className);
    //document.getElementById('inbox_container').className += 'inbox_container_open';
    
    if (_INBOX_MESSAGES['mid_' + mid] == null) return;
	 
    document.getElementById('inbox_msg_header_title').innerHTML = _INBOX_MESSAGES['mid_' + mid].subject;
    document.getElementById('inbox_msg_header_data').innerHTML = inboxFormatDate(_INBOX_MESSAGES['mid_' + mid].date);
	document.getElementById('inbox_msg_body').innerHTML = _INBOX_MESSAGES['mid_' + mid].body;
	_INBOX_MESSAGES['mid_' + mid].status = 0;
	inboxUpdateUnreadMessage();
    
    setTimeout(function(){
        if (_INBOX_MSG_ISCROLL == null) {
            _INBOX_MSG_ISCROLL = new iScroll('inbox_msg_wrapper');
        }
        else {
            _INBOX_MSG_ISCROLL.refresh();
        }
    }, 100);
	
	// marco il messaggio come letto sul db
    if (_DB) {
    
        var querySuccess = function(){
            console.log('inboxOpenMessage OK');
        }
        
        var queryError = function(p_error){
            console.log("inboxOpenMessage KO: Error processing SQL: " + p_error.message);
            inboxFetchMessages();
        }
        
        var executeQuery = function(tx){
            tx.executeSql('UPDATE INBOX_MESSAGES_2 SET status=0 WHERE id=?', [mid], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
	
	omnitureTrackApp('APP:inbox:open:' + mid, 'APP:inbox');
}

function inboxUpdateUnreadMessage(){
	_INBOX_NUM_UNREAD_MESSAGES = 0;
	for (var key in _INBOX_MESSAGES) {
		var l_msg = _INBOX_MESSAGES[key];
		if (l_msg.status == 1)
			_INBOX_NUM_UNREAD_MESSAGES++;
	}
	
    if (_INBOX_NUM_UNREAD_MESSAGES > 0) {
        //$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
        //$('#appmenu_inbox_count').text('*');
        $('#appmenu_inbox_count').css('display', 'inline-block');
    }
    else {
        $('#appmenu_inbox_count').css('display', 'none');
    }
}

function inboxFormatDate(p_date) {
	if (p_date.length != 19) return "00 00 0000";
	var toks = p_date.split(' ');
	if (toks.length != 2) return "00 00 0000";
	var cals = toks[0].split('-');
	if (cals.length != 3) return "00 00 0000";
	return cals[2] + ' ' + cals[1] + ' ' + cals[0];
}

/**
 * Passa alla modalità modifica messaggi
 */
function inboxSwitchToModifyView(){
    $('#inbox_list_modify_button').hide();
    $('#inbox_list_show_button').show();
    $('.inbox_list_container_box').addClass('inbox_list_container_box_unselected');
    $('#elimina_messaggi').fadeIn();
}

/**
 * Passa alla modalità visualizza messaggi
 */
function inboxSwitchToShowView(){
    $('#inbox_list_show_button').hide();
    $('#inbox_list_modify_button').show();
    $('.inbox_list_container_box.inbox_list_container_box_unselected').removeClass('inbox_list_container_box_unselected');
    $('.inbox_list_container_box.inbox_list_container_box_selected').removeClass('inbox_list_container_box_selected');
    $('#elimina_messaggi').fadeOut();
}



/**
 * Inizializza lo stato dei pulsanti per la navigazione tra i messaggi
 */
function inboxInitNavButtons(p_header_id){
	//console.log("inboxInitNavButton");
    var l_next_element = $('#inbox_msg_title_nav_next_btn');
    l_next_element.unbind('click');

    var l_prev_element = $('#inbox_msg_title_nav_prev_btn');
    l_prev_element.unbind('click');

    if ($('#inbox_list_container_box_'+p_header_id).prev().length){
        l_next_element.removeClass('disabled');
        l_next_element.click(function(){
            inboxOpenPrevMsg(p_header_id);
        });
    }else{
        l_next_element.addClass('disabled');
    }

    if ($('#inbox_list_container_box_'+p_header_id).next().length){
        $('#inbox_msg_title_nav_prev_btn').removeClass('disabled');
        l_prev_element.click(function(){
            inboxOpenNextMsg(p_header_id);
        });
    }else{
        $('#inbox_msg_title_nav_prev_btn').addClass('disabled');
    }
}

/**
 * Apre il messaggio successivo
 */
function inboxOpenPrevMsg(p_header_id){
    var l_prev = $('#inbox_list_container_box_'+p_header_id).prev();
    if (l_prev.length) {
        var mid = l_prev[0].id.substr(25);
        inboxOpenMessage(mid);
    }
}
/**
 * Apre il messaggio precedente
 */
function inboxOpenNextMsg(p_header_id){
    var l_next = $('#inbox_list_container_box_'+p_header_id).next();
    if (l_next.length) {
        var mid = l_next[0].id.substr(25);
        inboxOpenMessage(mid);
    }
}




/*
 * Elimina i messaggi dal database
 * @params p_mids Lista dei identificativi dei messaggi
 */
function deleteLocalMessages(p_mids){

    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB && p_mids.length > 0) {
    
        var querySuccess = function(){
            console.log('Deleted messages ' + p_mids.toString());
            deleteInboxElements(p_mids);
        }
        
        var queryError = function(p_error){
            console.log("deleteLocalMessages: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('DELETE FROM INBOX_MESSAGES_2 WHERE id in (' + p_mids.toString() + ')');
            //querySuccess();
        }
        
        _DB.transaction(executeQuery, queryError, querySuccess);
    }
}

/**
 * Elimina i messaggi selezionati in modalità modifica
 */
function inboxDeleteMessages(){
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	var l_all_messages = [];
	
	for (var i = 0; i < l_messages.length; i++) {
		var l_mid = l_messages[i].id.substring(25);
		l_all_messages.push(l_mid);
	}
	
	if (l_all_messages.length > 0) {
        deleteLocalMessages(l_all_messages);
    }
	else {
        abutils.alert('Attenzione, non è stato selezionato nessun messaggio', 'Inbox');
    }
	
	/*
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
    var l_remote_messages = [];
    var l_all_messages = [];
    
    for (var i = 0; i < l_messages.length; i++) {
        var l_mid = l_messages[i].id.substring(25);
        if (_INBOX_MESSAGES[l_mid]) {
            l_all_messages.push(l_mid);
            
            if (!_INBOX_MESSAGES[l_mid].body) {
                l_remote_messages.push(l_mid);
            }
        }
    }
    
    // I messaggi non scaricati vengono segnalati come già letti
    if (l_remote_messages.length > 0) {
        markMessagesAsRead(l_remote_messages);
    }
    
    // Tutti i messaggi vengono eliminati dal database
    // (per evitare problemi dovuti alla sincronizzazione con chiamate remote si cerca di eliminare anche quelli che non sembrano essere stati scaricati)
    if (l_all_messages.length > 0) {
        deleteLocalMessages(l_all_messages);
    }
    else {
        alert('Attenzione, non è stato selezionato nessun messaggio');
    }
    */
}

/**
 * Elimina gli elementi html relativi ai messaggi
 * @params p_mids Lista degli identificativi dei messaggi che devono essere eliminati
 */
function deleteInboxElements(p_mids){
    var l_active_message = $('.inbox_list_container_box_active');
    if (l_active_message.length > 0) {
        var l_active_message_id = l_active_message[0].id.substring(25);
        
        if (jQuery.inArray(l_active_message_id, p_mids) != -1) {
            //$('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
        }
    }
    $('.inbox_list_container_box.inbox_list_container_box_selected').remove();
}

/**
 * Elimina il messaggio aperto
 */
function inboxDeleteOpenedMessage(){
	window.simulatePG.confirm('Il messaggio verrà cancellato.\nSei sicuro?', 'inboxDeleteOpenedMessageSucc()', 'Cancellazione messaggio', 'Si,No');
}


(function() {
	var
		_HAS_TOUCH = 'ontouchstart' in window,
		_START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown',
		_MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove',
		_END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup',
		_CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseout';
	
	var CoveerFlow = function(container, covers) {
		this._container = typeof container == 'object' ? container : document.getElementById(container);
		this._covers = covers;
		this._initialization();
		
	};
	
	CoveerFlow.prototype = {
		_startX: 0,
		_startY: 0,
		_moveX: 0,
		_moveY: 0,
		_galleryHeight: 0,
		_touching: false,
		_moved: false,
		_initialization: function() {
			try{
			this._current = 0;
			this._totals = this._covers.length;
			this._stepPercent = 30;//25;//15;
			this._currentSlidePaddingPercent = 50;//25;
			this._rotateAngle = 0;//65;
			this._loaded = 0;
			
			var gallery = document.createElement('div');
			this._container.appendChild(gallery);
			gallery.className = 'coveerflow';
			//gallery.style.visibility = 'hidden';
			console.log("gallery _ORIENTATION is "+_ORIENTATION);
			console.log("gallery "+parseInt(gallery.offsetHeight, 10)+","+parseInt((window.innerHeight/2)*90/100));
			var galleryHeight = null;
			var slideHeight = null;
			if (_ORIENTATION == 'V'){
				galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
				slideHeight = galleryHeight ;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());		
				slideHeight = galleryHeight ;
			}
			
			this._galleryHeight = galleryHeight;
			//slideHeight = galleryHeight ;//- 20;/*50/*AB150;*/
			
			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;
			
			
			console.log('gal1 galleryHeight ' + galleryHeight);
			console.log('gal1 slideHeight ' + slideHeight);
			console.log('gal1 _step ' + this._step);
			console.log('gal1 _currentSlidePadding ' + this._currentSlidePadding);
			
			
			for (var i = 0; i < this._totals; i++) {
				var coverdiv = document.createElement('div');
				gallery.appendChild(coverdiv);
				
				console.log('gal1 slideHeight ' + slideHeight);
				
				coverdiv.style.height = '100%';
				
				var coverimg = document.createElement('img');
				coverdiv.appendChild(coverimg);
				
				if (this._covers[i]['anteprima']) {
					var anteprimaimg = document.createElement('img');
					anteprimaimg.className = 'coveerflow_anteprima';
					coverdiv.appendChild(anteprimaimg);
					anteprimaimg.src = 'imgs/coveerflow_anteprima.png';
					anteprimaimg = null;
				}
				
				if (this._covers[i]['abbonati']) {
					var abbonatiimg = document.createElement('img');
					abbonatiimg.className = 'coveerflow_abbonati';
					coverdiv.appendChild(abbonatiimg);
					abbonatiimg.src = 'imgs/coveerflow_abbonati2.png';
					abbonatiimg = null;
				}
				
				
				coverimg = null;
				coverdiv = null;
			}
			
			gallery = null;
			
			this._bind(_START_EV);
			this._bind(_MOVE_EV);
			this._bind(_END_EV);
			this._bind(_CANCEL_EV);
			
			// parte aggiunta per evitare l'attesa dell'onload delle immagini
			this._display();
			var that = this;
			setTimeout(function() {
				that._setAnimation();
			}, 100);
			//alert('ok'+_ORIENTATION);
			}catch(exc){
				console.log(exc.message)
			}
		},
		_setAnimation: function() {
			var coverdivs = this._container.children[0].children;
			for (var i = 0; i < coverdivs.length; i++) {
				coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
			}
		},
		_display: function() {
			if (_ORIENTATION == 'V'){
				galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
				slideHeight = galleryHeight ;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());		
				slideHeight = galleryHeight ;
			}
			this._galleryHeight = galleryHeight;
			
			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;
			
			var galleryCenter = null;//600 / 2;
			if (_ORIENTATION == 'V'  ){
				galleryCenter = Math.round(window.innerWidth * 0.5);
			} else {
				galleryCenter = Math.round($('#edicola_prodotto_coverflow').width() * 0.5);
			}
			console.log("gallcent: "+galleryCenter);
			var coverdivs = this._container.children[0].children;
			
			//alert("children  "+this._container.children[0].children);
			
			for (var i = 0; i < this._totals; i++) {
				//var l_cover_width = parseInt(coverdivs[i].offsetWidth, 10);
				console.log("cover#"+i+" "+parseInt(window.innerWidth/2+10));
				var l_cover_width = null;
				if(_ORIENTATION == 'V'){
					l_cover_width = Math.round(window.innerWidth * 0.5);
					//alert(window.innerWidth);
				}else{
					l_cover_width = Math.round(window.innerWidth * 0.3);
				}
				$(coverdivs[i]).width(l_cover_width);
				
				this._step = $(coverdivs[i]).width() / 2;
				
				if (i < this._current) {
					// precedenti - sinistra
					var leftPos = parseInt(galleryCenter - (this._current * this._step) + (i * this._step) - (l_cover_width / 2) - this._currentSlidePadding, 10);
					coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
				} else {
					if (i == this._current) {
						// corrente - centrale
						var leftPos = galleryCenter - (l_cover_width / 2);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					} else {
						// successivi - destra
						var leftPos = parseInt(galleryCenter + ((i - this._current) * this._step) - (l_cover_width / 2) + this._currentSlidePadding, 0);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					}
					
					coverdivs[i].style.display = 'inline-block';
					coverdivs[i].children[0].src = this._covers[i]['src'];
				}
			}
			
			if (_ORIENTATION == 'V') {
				$('.coveerflow img').each(function(){
					var that = this;
					$(that).css('margin-top', Math.round((($('#edicola_prodotto').height() * 0.48) - $(that).height()) / 2));
					$(that).load(function(){
						$(that).css('margin-top', Math.round((($('#edicola_prodotto').height() * 0.48) - $(that).height()) / 2));
					});
				});
			} else {
				$('.coveerflow img').each(function(){
					var that = this;
					$(that).css('margin-top', Math.round(($('#centrale').height() - $(that).height()) / 2));
					$(that).load(function(){
						$(that).css('margin-top', Math.round(($('#centrale').height() - $(that).height()) / 2));
					});
				});
			}
		},
		_bind: function(type, element, bubble) {
			(element || this._container).addEventListener(type, this, !!bubble);
		},
		_unbind: function(type, element, bubble) {
			(element || this._container).removeEventListener(type, this, !!bubble);
		},
		handleEvent: function(e) {
			switch(e.type) {
				case _START_EV: 
					this._e_start(e); 
					break;
				case _MOVE_EV: 
					this._e_move(e);
					break;
				case _END_EV:
				case _CANCEL_EV: 
					this._e_end(e); 
					break;
			}
		},
		_e_start: function(e) {
			e.preventDefault();
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._startX = _e.clientX;
			this._startY = _e.clientY;
			this._touching = true;
			this._moved = false;
			/*
			this._bind(_MOVE_EV);
			this._bind(_END_EV);
			this._bind(_CANCEL_EV);
			this._unbind(_START_EV);
			*/
		},
		_e_move: function(e) {
			e.preventDefault();
			if (!this._touching) return;
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._moveX = _e.clientX;
			this._moveY = _e.clientY;
			this._moved = true;
		},
		_e_end: function(e) {
			e.preventDefault();
			if (!this._touching) return;
			
			if (!this._moved) {
				if (this._touching) {
					if (typeof this.on_tap != "undefined") {
						this.on_tap.call();
					}
				}
				return;
			}
			
			if (this._moveX - this._startX > 100)
				this._gotoPrev();
			else if (this._moveX - this._startX < -100)
				this._gotoNext();
			
			var that = this;
			setTimeout(function() {
				that._touching = false;
			}, 300);
			
                        
                        if (this.on_end){
                            this.on_end.call();
                        }
			/*
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
			*/
		},
		_gotoNext: function() {
			if (this._current + 1 >= this._totals) return;
			this._current++;
			this._display();
		},
		_gotoPrev: function() {
			if (this._current <= 0) return;
			this._current--;
			this._display();
		},
		destroy: function() {
			this._unbind(_START_EV);
			this._unbind(_START_EV);
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
		}
	}
	
	window.CoveerFlow = CoveerFlow;
})();
/**
 * @author ABertacco
 */
var _NIELSEN_BASE_URL = "http://secure-it.imrworldwide.com/cgi-bin/m?ci=ilsole-app&cg=0&si=";

var _AREE = {
	'ALTRO' 			: 'http%3A//sfogliatoremobile.ilsole24ore.com',
	'EDICOLA' 			: 'http%3A//sfogliatoremobile.ilsole24ore.com/edicola',
	'ARCHIVIO_PRODOTTI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/archivio_prodotti',
	'PREFERITI'			: 'http%3A//sfogliatoremobile.ilsole24ore.com/preferiti',
	'RICERCA'			: 'http%3A//sfogliatoremobile.ilsole24ore.com/ricerca',
	'INBOX'				: 'http%3A//sfogliatoremobile.ilsole24ore.com/inbox',
	'REGISTRAZIONE'		: 'http%3A//sfogliatoremobile.ilsole24ore.com/registrazione',
	'SFOGLIATORE'		: 'http%3A//sfogliatoremobile.ilsole24ore.com/sfogliatore'
}
 
 function nielsenCall(area) {
 try {
 	if (_AREE[area] == null) area = 'ALTRO';
 	document.getElementById('nielsen_wrapper').innerHTML = '';
	var img = document.createElement('img');
	document.getElementById('nielsen_wrapper').appendChild(img);
	$(img).load(function() {
		console.log('nielsen load ' + area);
	});
	$(img).error(function() {
		console.log('nielsen error ' + area);
	});
	img.src = _NIELSEN_BASE_URL + _AREE[area];
	img = null;
 } catch(exc) {
 	console.log('nielsen exception: ' + exc.message);
 }
 }
/**
 * @author ABertacco
 */
function omnitureTrackApp(pageName, channel) {
	try {
		
		//PhoneGap.exec("AppMeasurementCommand.trackApp", pageName, channel);
		//window.plugins.flipper24.trackApp(null, null, pageName, channel);
		console.log("omniture:: "+pageName+', '+channel);
		window.infodroid.track(null, null, pageName, channel);
		
	} catch (exc) {
		
		//alert("ERROR OMNI");
	}
	
}
/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	
	//PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();
		
	if ((id_shopping24 == null) || (id_itunes == null)) return;
	
	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in _IAP_REQ_QUEUE
	//var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	//PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null) 
				continue;
			console.log('OK ' + l_product.productIdentifier); 
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}
		
		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}
		
		return "OK";
	} catch(exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}	
	
	navigator.notification.loadingStart({
        'labelText': "Acquisto in corso...",
        'backgroundOpacity': 0.8,
        'strokeOpacity': 0.25,
        'strokeColor': "FFFFFF",
    });
	
	_APPSTORE_BUY_CALLBACK = callback;
	
	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({Success: false, Exception: { Name: 'ExpiredUserIdentityException', Description: 'Rinnovo useridentity pre-pagamento.'}}, function() {
			//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else 
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}




var checkboxHeight = "26";
var radioHeight = "26";

var GalaxyCheckboxStyle = {
	init: function() {
		var inputs = document.getElementsByTagName("input"), span = Array(), textnode, option, active;
		for(a = 0; a < inputs.length; a++) {
			if((inputs[a].type == "checkbox" || inputs[a].type == "radio") && inputs[a].className == "galaxy_style") {
				span[a] = document.createElement("span");
				span[a].className = inputs[a].type;

				if(inputs[a].checked == true) {
					if(inputs[a].type == "checkbox") {
						position = "0 -" + (checkboxHeight) + "px";
						span[a].style.backgroundPosition = position;
					} else {
						position = "0 -" + (radioHeight) + "px";
						span[a].style.backgroundPosition = position;
					}
				}
				inputs[a].parentNode.insertBefore(span[a], inputs[a]);
				inputs[a].onchange = GalaxyCheckboxStyle.clear;
				if(!inputs[a].getAttribute("disabled")) {
					if(_DEBUG_MODE){
						span[a].onmousedown = GalaxyCheckboxStyle.pushed;
						span[a].onmouseup = GalaxyCheckboxStyle.check;
					}else{
						span[a].ontouchstart = GalaxyCheckboxStyle.pushed;
						span[a].ontouchend = GalaxyCheckboxStyle.check;
					}
				} else {
					span[a].className = span[a].className += " disabled";
				}
			}
		}
		// verifico touch
		if(_DEBUG_MODE){
			document.onmouseup = GalaxyCheckboxStyle.clear;
		}else{
			document.ontouchend = GalaxyCheckboxStyle.clear;
		}
	},
	pushed: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "radio") {
			this.style.backgroundPosition = "0 -" + radioHeight + "px";
		}
	},
	check: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "checkbox") {
			this.style.backgroundPosition = "0 0";
			element.checked = false;
		} else {
			if(element.type == "checkbox") {
				this.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else {
				this.style.backgroundPosition = "0 -" + radioHeight + "px";
				group = this.nextSibling.name;
				inputs = document.getElementsByTagName("input");
				for(a = 0; a < inputs.length; a++) {
					if(inputs[a].name == group && inputs[a] != this.nextSibling) {
						inputs[a].previousSibling.style.backgroundPosition = "0 0";
					}
				}
			}
			element.checked = true;
		}
	},
	clear: function() {
		inputs = document.getElementsByTagName("input");
		for(var b = 0; b < inputs.length; b++) {
			if(inputs[b].type == "checkbox" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else if(inputs[b].type == "checkbox" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			} else if(inputs[b].type == "radio" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + radioHeight + "px";
			} else if(inputs[b].type == "radio" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			}
		}
	}
}

(function() {
  var iOSCheckbox;
  iOSCheckbox = (function() {
    function iOSCheckbox(elem, options) {
      var key, opts, value;
      this.elem = $(elem);
      opts = $.extend({}, iOSCheckbox.defaults, options);
      for (key in opts) {
        value = opts[key];
        this[key] = value;
      }
      this.wrapCheckboxWithDivs();
      this.attachEvents();
      this.disableTextSelection();
      if (this.resizeHandle) {
        this.optionallyResize('handle');
      }
      if (this.resizeContainer) {
        this.optionallyResize('container');
      }
      this.initialPosition();
    }
    iOSCheckbox.prototype.isDisabled = function() {
      return this.elem.is(':disabled');
    };
    iOSCheckbox.prototype.wrapCheckboxWithDivs = function() {
      this.elem.wrap("<div class='" + this.containerClass + "' />");
      this.container = this.elem.parent();
      this.offLabel = $("<label style=\"width:40px;\" class='" + this.labelOffClass + "'>\n  <span>" + this.uncheckedLabel + "</span>\n</label>").appendTo(this.container);
      this.offSpan = this.offLabel.children('span');
      this.onLabel = $("<label style=\"width: 40px;\" class='" + this.labelOnClass + "'>\n  <span>" + this.checkedLabel + "</span>\n</label>").appendTo(this.container);
      this.onSpan = this.onLabel.children('span');
      return this.handle = $("<div class='" + this.handleClass + "'>\n  <div class='" + this.handleRightClass + "'>\n    <div class='" + this.handleCenterClass + "' />\n  </div>\n</div>").appendTo(this.container);
    };
    iOSCheckbox.prototype.disableTextSelection = function() {
      if ($.browser.msie) {
        return $([this.handle, this.offLabel, this.onLabel, this.container]).attr("unselectable", "on");
      }
    };
    iOSCheckbox.prototype.optionallyResize = function(mode) {
      var newWidth, offLabelWidth, onLabelWidth;
      //onLabelWidth = this.onLabel.width();
      onLabelWidth = parseInt($(this.onLabel).css('width'));
      //offLabelWidth = this.offLabel.width();
      offLabelWidth = parseInt($(this.offLabel).css('width'));
      if (mode === "container") {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        //newWidth += this.handle.width() + this.handleMargin;
        newWidth += parseInt($(this.handle).css('width')) + this.handleMargin;
        return this.container.css({
          width: newWidth
        });
      } else {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        return this.handle.css({
          width: newWidth
        });
      }
    };
    iOSCheckbox.prototype.onMouseDown = function(event) {
      var x;
      event.preventDefault();
      if (this.isDisabled()) {
        return;
      }
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      iOSCheckbox.currentlyClicking = this.handle;
      iOSCheckbox.dragStartPosition = x;
      return iOSCheckbox.handleLeftOffset = parseInt(this.handle.css('left'), 10) || 0;
    };
    iOSCheckbox.prototype.onDragMove = function(event, x) {
      var newWidth, p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      p = (x + iOSCheckbox.handleLeftOffset - iOSCheckbox.dragStartPosition) / this.rightSide;
      if (p < 0) {
        p = 0;
      }
      if (p > 1) {
        p = 1;
      }
      newWidth = p * this.rightSide;
      this.handle.css({
        left: newWidth
      });
      this.onLabel.css({
        width: newWidth + this.handleRadius
      });
      this.offSpan.css({
        marginRight: -newWidth
      });
      return this.onSpan.css({
        marginLeft: -(1 - p) * this.rightSide
      });
    };
    iOSCheckbox.prototype.onDragEnd = function(event, x) {
      var p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      if (this.isDisabled()) {
        return;
      }
      if (iOSCheckbox.dragging) {
        p = (x - iOSCheckbox.dragStartPosition) / this.rightSide;
        this.elem.prop('checked', p >= 0.5);
      } else {
        this.elem.prop('checked', !this.elem.prop('checked'));
      }
      iOSCheckbox.currentlyClicking = null;
      iOSCheckbox.dragging = null;
      return this.elem.change();
    };
    iOSCheckbox.prototype.onChange = function() {
      var new_left;
      if (this.isDisabled()) {
        this.container.addClass(this.disabledClass);
        return false;
      } else {
        this.container.removeClass(this.disabledClass);
      }
      new_left = this.elem.prop('checked') ? this.rightSide : 0;
      this.handle.animate({
        left: new_left
      }, this.duration);
      this.onLabel.animate({
        width: new_left + this.handleRadius
      }, this.duration);
      this.offSpan.animate({
        marginRight: -new_left
      }, this.duration);
      return this.onSpan.animate({
        marginLeft: new_left - this.rightSide
      }, this.duration);
    };
    iOSCheckbox.prototype.attachEvents = function() {
      var localMouseMove, localMouseUp, self;
      self = this;
      localMouseMove = function(event) {
        return self.onGlobalMove.apply(self, arguments);
      };
      localMouseUp = function(event) {
        self.onGlobalUp.apply(self, arguments);
        $(document).unbind('mousemove touchmove', localMouseMove);
        return $(document).unbind('mouseup touchend', localMouseUp);
      };
      this.container.bind('mousedown touchstart', function(event) {
        self.onMouseDown.apply(self, arguments);
        $(document).bind('mousemove touchmove', localMouseMove);
        return $(document).bind('mouseup touchend', localMouseUp);
      });
      return this.elem.bind("change", function() {
        return self.onChange.apply(self, arguments);
      });
    };
    iOSCheckbox.prototype.initialPosition = function() {
      var offset;
      this.offLabel.css({
        //width: this.container.width() - this.containerRadius
        width: parseInt($(this.container).css('width')) - this.containerRadius
      });
      offset = this.containerRadius + 1;
      if ($.browser.msie && $.browser.version < 7) {
        offset -= 3;
      }
      //this.rightSide = this.container.width() - this.handle.width() - offset;
      this.rightSide = parseInt($(this.container).css('width')) - parseInt($(this.handle).css('width')) - offset;
      if (this.elem.is(':checked')) {
        this.handle.css({
          left: this.rightSide
        });
        this.onLabel.css({
          width: this.rightSide + this.handleRadius
        });
        this.offSpan.css({
          marginRight: -this.rightSide
        });
      } else {
        this.onLabel.css({
          width: 0
        });
        this.onSpan.css({
          marginLeft: -this.rightSide
        });
      }
      if (this.isDisabled()) {
        return this.container.addClass(this.disabledClass);
      }
    };
    iOSCheckbox.prototype.onGlobalMove = function(event) {
      var x;
      if (!(!this.isDisabled() && iOSCheckbox.currentlyClicking)) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      if (!iOSCheckbox.dragging && (Math.abs(iOSCheckbox.dragStartPosition - x) > this.dragThreshold)) {
        iOSCheckbox.dragging = true;
      }
      return this.onDragMove(event, x);
    };
    iOSCheckbox.prototype.onGlobalUp = function(event) {
      var x;
      if (!iOSCheckbox.currentlyClicking) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      return this.onDragEnd(event, x);
    };
    iOSCheckbox.defaults = {
      duration: 200,
      checkedLabel: 'ON',
      uncheckedLabel: 'OFF',
      resizeHandle: true,
      resizeContainer: true,
      disabledClass: 'iPhoneCheckDisabled',
      containerClass: 'iPhoneCheckContainer',
      labelOnClass: 'iPhoneCheckLabelOn',
      labelOffClass: 'iPhoneCheckLabelOff',
      handleClass: 'iPhoneCheckHandle',
      handleCenterClass: 'iPhoneCheckHandleCenter',
      handleRightClass: 'iPhoneCheckHandleRight',
      dragThreshold: 5,
      handleMargin: 15,
      handleRadius: 4,
      containerRadius: 5
    };
    return iOSCheckbox;
  })();
  $.iphoneStyle = this.iOSCheckbox = iOSCheckbox;
  $.fn.iphoneStyle = function(options) {
    var checkbox, _i, _len, _ref;
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iphoneStyle", new iOSCheckbox(checkbox, options));
    }
    return this;
  };
  $.fn.iOSCheckbox = function(options) {
    var checkbox, opts, _i, _len, _ref;
    if (options == null) {
      options = {};
    }
    opts = $.extend({}, options, {
      resizeHandle: false,
      disabledClass: 'iOSCheckDisabled',
      containerClass: 'iOSCheckContainer',
      labelOnClass: 'iOSCheckLabelOn',
      labelOffClass: 'iOSCheckLabelOff',
      handleClass: 'iOSCheckHandle',
      handleCenterClass: 'iOSCheckHandleCenter',
      handleRightClass: 'iOSCheckHandleRight'
    });
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iOSCheckbox", new iOSCheckbox(checkbox, opts));
    }
    return this;
  };
}).call(this);







		function onbodyload(){
			var cities = [
				{id:3, value:"London"},
				{id:1, value:"Stockholm"},
				{id:4, value:"Berlin"},
				{id:2, value:"Moscow"}
			];
			
			dhx.ui({
				view:"popup",
				id:"cities",
				body:{
					view:"list", 
					template: "<div>#value#</div>",
					data:cities,
					type:{
						width:160
					},
					yCount:3
				}
			}).hide();
			/*
			dhx.ui({
				cols:[
				
				{
					rows:[
					
					{ 	view:"toolbar", type:"MainBar",  elements:[{ view:"richselect", name: "from", id:'myrich', label: 'From', value: 1, popup:"cities" }]}
				
				]}
				]
			});
			*/
			dhx.ui({ view:"richselect",id: "myRichselect", container:'jack', options:[
			                                    					{ value:1, label:"One"   }, 
			                                    					{ value:2, label:"Two"   }, 
			                                    					{ value:3, label:"Three" }]
			                                    });
			try{
				
				var item = $$('myRichselect');
				alert('item '+item);
				
				$('#jack').append($('.dhx_view dhx_el_richselect').html());
				
				alert($('.dhx_view dhx_el_richselect').css());
				alert($('#jack').html());
			}catch(exc){
				alert(exc.message);
			}
		}
		












			var dhtmlx_listProductsSelect = null;
			function onbodyload12() {
				var cities = [{
					id : 3,
					value : "London"
				}, {
					id : 1,
					value : "Stockholm"
				}, {
					id : 4,
					value : "Berlin"
				}, {
					id : 2,
					value : "Moscow"
				}];

				dhx.ui({
					view : "popup",
					id : "cities",
					body : {
						view : "list",
						template : "<div>#value#</div>",
						data : cities,
						type : {
							width : 160
						},
						yCount : 4
					}
				}).hide();

				dhtmlx_listProductsSelect = [{
					value : 1,
					label : "Nessun prodotto principale"
				}, {
					value : 2,
					label : "Two"
				}, {
					value : 3,
					label : "Thre2e"
				}];
				dhx.ui({
					view : "richselect",
					id : "myRichselect",
					container : 'impostazioni_body_vista_container_generali_info',
					label : '',
					value : "1",
					iconCss : 'dhx_list_icon2',
					width : '36',
					options : dhtmlx_listProductsSelect
				});
				$('.dhx_inp_list').css('width', '90%');

				//listProductsSelect = [ ;
				var arr1 = [{
					value : 1,
					label : "Nessun prodotto principale"
				}];
				//alert('_EDICOLA_PRODUCTS_DETAILS: ' + _EDICOLA_PRODUCTS_DETAILS);
				for (var key in _EDICOLA_PRODUCTS_DETAILS) {
					if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {

						//listProductsSelect += { value:parseInt(_EDICOLA_PRODUCTS_DETAILS[key].productId+1), label:"Nessun prodotto principale"+_EDICOLA_PRODUCTS_DETAILS[key].productId},
						console.log(_EDICOLA_PRODUCTS_DETAILS[key].productId + 1);
						console.log(_EDICOLA_PRODUCTS_DETAILS[key].name);
						var obj = {
							value : _EDICOLA_PRODUCTS_DETAILS[key].productId + 1,
							label : _EDICOLA_PRODUCTS_DETAILS[key].name
						};
						arr1.push(obj);

					}

				}
				dhtmlx_listProductsSelect = arr1;
				$$('myRichselect').refresh();
			}
		





		_INBOX_NUM_UNREAD_MESSAGES = 0;
		var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
		var _ADV_PROXY_TEST = "http://212.45.97.204/adv_proxy_and.php";
		var _API24TEST_SWITCH = false; // se a true, l'app utilizza la configurazione di stage
		
		var uuid_device = window.infodroid.getUUID();
		var PRODUCT_ID = 0;
		var SCREEN = 0;
		
		//alert(uuid_device);
		function upFromDB(){
    		var valoutput ;
    		console.log('passed... ');
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    			_INBOX_NUM_UNREAD_MESSAGES=valoutput;
    			
    		} 
    		else{
    			console.log('error');
    			throw "window.localStorage, not defined"; 
    		}

		}
		
		function updateUnreadMessage() {
			try{
			//upFromDB();
				setTimeout(function (){
					console.log('updateUnreadMessage:::passed... ');
				    if (_INBOX_NUM_UNREAD_MESSAGES > 0 ){
				        //$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
				        //$('#appmenu_inbox_count').css('display', 'block');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'block';
				    } else {
				        //$('#appmenu_inbox_count').css('display', 'none');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'none';
		
				    }
				},1000);
			}catch(exc){
				console.log(exc.message);
			}
		}
		
		
		function loadExtra(){
			if(_API24TEST_SWITCH){
				_ADV_PROXY = _ADV_PROXY_TEST;
			}
			try{
				//alert(SCREEN);
				if(SCREEN == 0)
					SCREEN = Math.min(window.innerHeight, window.innerWidth);
				console.log('SCREEN is ' + SCREEN);	
			    loadAdvTabbar(PRODUCT_ID);
			    loadAdvCatalogo();
			}catch(exc){
				alert(exc.message);
			}
		}
		
		function loadAdvTabbar(product_id){
			//alert("CALL ME!!!");
			//document.getElementById('advtabbar_close').style.display = 'none';
			try{
		    document.getElementById('advtabbar_close_content').innerHTML = '';
		    //$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){
			$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + uuid_device + "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
		        /*
				setTimeout(function() {
					var ret = false;
					try {

						var imgs = document.getElementById('advtabbar_close_content').getElementsByTagName('img');
						if(imgs != null || imgs.length >= 0) {
							for(var i = 0; i < imgs.length; i++) {
								if(parseInt(imgs[i].height) > 10) {
									ret = true;
								}
							}	
						}
						
					} catch(exc) {
						ret = false;
					}
					
					if (ret) {
						$('#advtabbar_close').fadeIn();
					}

				}, 100);
		        */
		    }).endCapture();
		    document.getElementById('advtabbar_open_content').innerHTML = '';
		    //$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
			$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + uuid_device + "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
// 				setTimeout(function() {
// 				    	centerImage('advtabbar_open_content');
// 				}, 100);

					$('#advtabbar_open_content img').each(function() {
						$(this).load(function() {
							$(this).css('margin-left', - $(this).width() / 2);
						});
					});
		
		    }).endCapture();
		    }catch(exc){
		    	alert(exc.message);
		    }
		}

		var _TABBAR_ADV_IS_OPEN = false;
		function handleAdvTabbarClick(){
			var _width_close = $('#advtabbar_close_content img').first().width();
			// evita di aprire il contenuto se non c'è nulla caricato
			if ((_width_close == null) || (_width_close < 5)) return;
			//alert("CALL ME1!!!");
		    _TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
		    document.getElementById('advtabbar_close').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_open').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    window.resize.resizeweb(200, !_TABBAR_ADV_IS_OPEN);
			if(_TABBAR_ADV_IS_OPEN){
				nascondibarra();
				//console.log(document.getElementsByTagName('body')[0].innerHTML);
			}else{
				visualizzabarra();
			}
			return false;
		}
		
		function nascondibarra(){
			//document.getElementById('appmenu').style.display = 'none';
			$("#appmenu").fadeIn().css("display","none");
		}
		
		function visualizzabarra(){
			//document.getElementById('appmenu').style.display = 'inline-block';
			$("#appmenu").fadeOut().css("display","inline-block");
		}

		function loadAdvCatalogo(product_id){
			//alert("CALL ME2!!!");
			if(!product_id) return;
		    document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
		    //$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
			$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + uuid_device + "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
		    }).endCapture();
		}

		var _UPDATE_ORIENTATION_RUNNING = false, CURRENT_ORIENTATION = null;
		var screenHeight = null, screenWidth = null;

		function updateOrientation() {
			var that = this;
			setTimeout(function(){
				screenHeight = window.innerHeight;
				screenWidth = window.innerWidth;
				
				//alert("screenWidth " + screenWidth + ", screenHeight " + screenHeight);
				
				var orientation = screenWidth / screenHeight ;
				if (CURRENT_ORIENTATION == orientation) return;
				CURRENT_ORIENTATION = orientation;
						
				if (_UPDATE_ORIENTATION_RUNNING) return;
				_UPDATE_ORIENTATION_RUNNING = true;
				
				$('#advtabbar_open_content').hide();
				
				setTimeout(function() {
					$('#advtabbar_open_content').show();
					
					$('#advtabbar_open_content img').each(function() {
						$(this).css('margin-left', - $(this).width() / 2);
					});
				}, 1000);
			
				_UPDATE_ORIENTATION_RUNNING = false;
			}, 100);
		}
		
		function onBodyLoaded() {
			updateUnreadMessage();
			loadExtra();
			
			setInterval(function(){
				updateOrientation();
			}, 500);
		}
		
		function centerImage(divname){
			try{
				console.log("CALLED");
				var statusbar = window.infodroid.getStatusBarHeight()*window.devicePixelRatio;
				console.log("statusbar " + statusbar);
				var screenwidth = parseInt(screen.width/window.devicePixelRatio) ;
				var screenheight = parseInt((screen.height)/window.devicePixelRatio) - statusbar;
				
				
				//alert("CALLED " + screenwidth +","+screenheight);
				if(screenwidth < screenheight){//verticale
					//console.log("CALLED1 " + screenwidth + "," + screenheight + "," + $("#" + divname + " img")[0].src);
					$("#" + divname + " img").load(function(){
						console.log("CALLED1");
						//alert('v '+screenheight+","+screenwidth);
			   			var currentImage = $(this);
			   			var curIdPar = new String(JSON.stringify(currentImage.parent().parent().attr('id')));
			   			//alert(curIdPar);
			   			if(curIdPar && curIdPar.indexOf('portrait') > -1){//portrait img
			   				//alert('v enter1 '+currentImage.parent().html());
			   				var imgwidth = currentImage.outerWidth();
			   				if(imgwidth < 200){
			   					if(this.parentNode.parentNode)
			   						if(this.parentNode.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
				   			if(imgwidth > parseInt(screenwidth)){//sposta indietro
				   				//alert('v enter2 '+imgwidth+ "," + this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenwidth)/2) +"px");
				   			}else{//sposta avanti
				   				//alert('v enter6 ' + imgwidth + ",\n" + this.clientWidth + "," + currentImage.parent().html());
				   				currentImage.css("margin-left", parseInt((screenwidth - imgwidth )/2) +"px");
				   			}
			   			}else if(curIdPar && curIdPar.indexOf('landscape') > -1){//lanscape img
			   				//alert('v enter3');
			   				
			   				var imgwidth = currentImage.outerWidth();
			   				if(imgwidth < 200){
			   					if(this.parentNode.parentNode)
			   						if(this.parentNode.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
			   				if((statusbar + screenheight) ==  imgwidth && Math.round(parseFloat(window.devicePixelRatio)*100)/100==1){ return; }
				   			if(imgwidth > parseInt(screenheight)){//sposta indietro
				   				//alert('v enter4 ' + imgwidth +','+ this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenheight)/2) +"px");
				   			}else{//sposta avanti
				   				//alert('v enter5'+ imgwidth +","+ this.clientWidth + "," +currentImage.parent().html());
				   				currentImage.css("margin-left", parseInt((screenheight - imgwidth )/2) +"px");
				   			}
			   			}else{
			   				var imgwidth = currentImage.outerWidth();
			   				//alert('v else' + imgwidth+ ","+ this.clientWidth + "," +currentImage.parent().html());
			   				if(imgwidth > $("#" + divname).width()){
			   					currentImage.css("margin-left", '-' + parseInt((imgwidth - $("#" + divname).width())/2) +"px");
			   				}else{
			   					currentImage.css("margin-left", parseInt(( $("#" + divname).width() - imgwidth)/2) +"px");
			   				}
			   				
			   			}
			   			console.log('currentImage '+currentImage.css("margin-left"));
					});
				}else{//orizzontale
					//alert('O'+screenheight+","+screenwidth);
					$("#" + divname + " img").load(function(){
						console.log("CALLED1");
			   			console.log('O'+screenheight+","+screenwidth);
						var currentImage = $(this);
						var curIdPar = new String(JSON.stringify(currentImage.parent().parent().attr('id')));
			   			if(curIdPar && curIdPar.indexOf('portrait') > -1){//portrait img
			   				var imgwidth = currentImage.outerWidth();
			   				
			   				if(imgwidth < 200){
			   					if(this.parentNode.parentNode)
			   						if(this.parentNode.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
			   				//alert('here'+screenheight+','+imgwidth);
			   				if((statusbar + screenheight) ==  imgwidth && Math.round(parseFloat(window.devicePixelRatio)*100)/100==1){ return; }
				   			
				   			if(imgwidth > parseInt(screenheight)){//sposta indietro
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenheight)/2) +"px");
				   			}else{//sposta avanti
				   				currentImage.css("margin-left", parseInt((screenheight - imgwidth )/2) +"px");
				   			}
			   			}else if(curIdPar && curIdPar.indexOf('landscape') > -1){//lanscape img
			   				var imgwidth = currentImage.outerWidth();
			   				if(imgwidth < 200){
			   					if(this.parentNode.parentNode)
			   						if(this.parentNode.parentNode.style.width)
			   							imgwidth = parseInt(this.parentNode.parentNode.style.width);
			   				}
			   			
				   			if(imgwidth > parseInt(screenwidth)){//sposta indietro
				   				currentImage.css("margin-left", '-' + parseInt((imgwidth - screenwidth)/2) +"px");
				   			}else{//sposta avanti
				   				currentImage.css("margin-left", parseInt((screenwidth - imgwidth )/2) +"px");
				   			}
			   			}else{
			   				
			   				//alert('else');
			   				if(currentImage.outerWidth() > $("#" + divname).width()){
			   					currentImage.css("margin-left", '-' + parseInt((currentImage.outerWidth() - $("#" + divname).width())/2) +"px");
			   				}else{
			   					currentImage.css("margin-left", parseInt(( $("#" + divname).width() - currentImage.outerWidth())/2) +"px");
			   				}
			   			}
			   			console.log(currentImage.css("margin-left"));
					});
					
				}
			}catch(exc){
				alert(exc.message);
			}
		}
		
	document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
	





	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);

	}
	
	function onDeviceReady()
	{
		
		
       	console.log("NO IOS BRIDGE CALLBACK.");
       	console.log("Load green droid OS file!");
        	
            setTimeout(function(){
	            $('#splashscreen').css('display', 'none');

	    		window.location = 'galaxy.html';

            },3000);
        /*
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
        */
	}
    
    




function load() {
	try{   
		$("#progressbar").reportprogress(0);
		$("#progressbar1").reportprogress(0);
		$("#progressbar2").reportprogress(0);
		$("#progressbar3").reportprogress(0);
		$("#progressbar4").reportprogress(0);
		$("#progressbar5").reportprogress(0);
		
		PhoneGap.exec(null, null, "Notification", "activityStop", []);
	}catch(exc){
		alert(exc.message);
	}
}

var pct=0;
var pct1=0;
var pct2=0;
var pct3=0;
var pct4=0;
var pct5=0;
var handle=0;
var handle1=0;
var handle2=0;
var handle3=0;
var handle4=0;
var handle5=0;
function update(increment_var){
	
	if(increment_var == 'pct'){
        $("#progressbar").reportprogress(++pct);
        if(pct==100){
                clearInterval(handle);
                $("#run").val("sfoglia");
                pct=0;
        }
   }else if(increment_var == 'pct1'){
       $("#progressbar1").reportprogress(++pct1);
       if(pct1==100){
               clearInterval(handle1);
               $("#run1").val("sfoglia");
               //pct1=0;
       }
	}else if(increment_var == 'pct2'){
	       $("#progressbar2").reportprogress(++pct2);
	       if(pct2==100){
	               clearInterval(handle2);
	               $("#run2").val("sfoglia");
	               pct2=0;
	       }
	}else if(increment_var == 'pct3'){
	       $("#progressbar3").reportprogress(++pct3);
	       if(pct3==100){
	               clearInterval(handle3);
	               $("#run3").val("sfoglia");
	               pct3=0;
	       }
	}else if(increment_var == 'pct4'){
	       $("#progressbar4").reportprogress(++pct4);
	       if(pct4==100){
	               clearInterval(handle4);
	               $("#run4").val("sfoglia");
	               pct4=0;
	       }
	}else if(increment_var == 'pct5'){
	       $("#progressbar4").reportprogress(++pct5);
	       if(pct5==100){
	               clearInterval(handle5);
	               $("#run5").val("sfoglia");
	               pct5=0;
	       }
	}else{
		//niente
		console.log("increment_var: "+increment_var);
		if(increment_var == null){
	        $("#progressbar").reportprogress(++pct);
	        if(pct==100){
	                clearInterval(handle2);
	                $("#run").val("sfoglia");
	                pct=0;
			
			}
		}
	}
}

function updateBar(idprogress, value){
	//console.log(" passed!!!!!! " + idprogress + "____" + value);
	if(idprogress != null && value >= 0){
		//console.log(" passed2!!!!!! " + idprogress.id + "____" + value);
        $("#"+idprogress.id).reportprogress(parseInt(value));
        if(value == 100){
                //clearInterval(handle);
                $("#run_"+idprogress.id).val("sfoglia");
                //pct=0;

		}
    }
}



jQuery(function($){
        $("#run_progressbar").click(function(){
                if(this.value=="start"){
                        //handle=setInterval("update(\'pct\')",100);
						//LAUNCH DOWNLOAD
						var temp = this.id.split('_');
						var prog_id = temp[1];
						console.log(prog_id);
						
						window.soledownloader.launchDownload("S24", "SOLE", "20110925", "Descrizione", ""+prog_id);
                        
                        this.value="annulla";
                }else if(this.value=="sfoglia"){
                	console.log("SFOGLIA S24 SOLE 20110925");
                    //CALL A JAVASCRIPT INTERFACE
                	window.loader.launchSfogliatore("S24", "SOLE", "20110925", "Descrizione");
                	//window.location = 'ipad.html';
                }else{
                    clearInterval(handle);
					pct=0;
					$("#progressbar").reportprogress(0);

                    this.value="start";
                    }
        });
        $("#reset").click(function(){
                pct=0;
                $("#progressbar").reportprogress(0);
        });
        $("#run_progressbar1").click(function(){
            if(this.value=="start"){
                    //handle1=setInterval("update(\'pct1\')",100);
                    //this.value="annulla";
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111006", "Descrizione", ""+prog_id);
                
                this.value="annulla";
                
            }else if(this.value=="sfoglia"){
            	console.log("SFOGLIA S24 SOLE 20111007");
                //CALL A JAVASCRIPT INTERFACE
            	window.loader.launchSfogliatore("S24", "SOLE", "20111006", "Descrizione");
            }else{
                clearInterval(handle1);
				pct1=0;
				$("#progressbar1").reportprogress(0);

                this.value="start";
                }
    });
        $("#run_progressbar2").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111115", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111115");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle2);
				pct2=0;
				$("#progressbar2").reportprogress(0);

                this.value="start";
            }
    });
        $("#run_progressbar3").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111109", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111109");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111109", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle3);
				pct3=0;
				$("#progressbar3").reportprogress(0);

                this.value="start";
            }
    });

        $("#run_progressbar4").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111129", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111129");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111129", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle4);
				pct4=0;
				$("#progressbar4").reportprogress(0);

                this.value="start";
            }
    });
        
        $("#run_progressbar5").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "LUNEDI", "20111114", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111114");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "LUNEDI", "20111114", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle5);
				pct5=0;
				$("#progressbar5").reportprogress(0);

                this.value="start";
            }
    });
        
});

	function loadQuick(){
		var valoutput ;
		if(typeof(window.localStorage) != 'undefined'){ 
			valoutput = window.localStorage.getItem ("unread_message_sole"); 
		} 
		else{ 
			throw "window.localStorage, not defined"; 
		}
		window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
    	setTimeout("history.go(-1)", 1500);
	}







	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	function onDeviceReady()
	{
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
	}
    
    

/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	
	//PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();
		
	if ((id_shopping24 == null) || (id_itunes == null)) return;
	
	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in _IAP_REQ_QUEUE
	//var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	//PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null) 
				continue;
			console.log('OK ' + l_product.productIdentifier); 
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}
		
		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}
		
		return "OK";
	} catch(exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}	
	
	navigator.notification.loadingStart({
        'labelText': "Acquisto in corso...",
        'backgroundOpacity': 0.8,
        'strokeOpacity': 0.25,
        'strokeColor': "FFFFFF",
    });
	
	_APPSTORE_BUY_CALLBACK = callback;
	
	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({Success: false, Exception: { Name: 'ExpiredUserIdentityException', Description: 'Rinnovo useridentity pre-pagamento.'}}, function() {
			//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else 
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}




function eliminaCopiaLocaleSucc(p_testata, p_issue, p_edizione, type) {
	//alert('aaa1');
	if (_DB) {
		_DB.transaction(function(transaction) {
			transaction.executeSql("DELETE FROM issues WHERE testata=? and issue=? and edizione=?", [p_testata, p_issue, p_edizione], function(transaction) {
				console.log('delete ok');
				//navigator.fileMgr.deleteDirectory('issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
				//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
				//window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);

				setTimeout(function() {
					window.soledownloader.cancelDownload(p_testata, p_edizione, p_issue, "", "", true);
				}, 0);

				setTimeout(function() {
					window.soledelete.deleteIssue(p_testata, p_issue, p_edizione);
				}, 1000);

				if (_QARCHIVIO_MODE) {
					//Modifica la visualizzazioni dello stato nell'archivio
					var l_status_el = $('#qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione);
					l_status_el.addClass('qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE);
					l_status_el.removeClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE);
					if (_QARCHIVIO_MODE == 'LIST') {
						$('#qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione).css('display', 'none');
					}
					_NEXT_ACTION = qarchivioLoad;
				}

				// gestione cancellazione da archivio standard
				if ($('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione)) {
					console.log('cancellazione da archivio standard');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).removeClass('archivio_container_box_islocal');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).addClass('archivio_container_box_isremote');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + ' > div > .archivio_button_elimina').css('display', 'none');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + " .archivio_container_box_txt_local_ICONS").remove();
				}

				if (type)
					edicolaOfflineLoad(type);
			}, function() {
				console.log('delete error');
			});
		});
	}
}

function impostazioniCancellaContenutoLocaleSucc() {
	if (_DB) {
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Cancellazione in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Cancellazione in corso..."]);
		_DB.transaction(function(transaction) {
			transaction.executeSql("DELETE FROM issues", [], function(transaction) {
				console.log('delete db ok');
				//navigator.fileMgr.deleteDirectory('issues');
				//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues');

				//window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues');
				window.soledelete.deleteAll('/S24/');
				console.log('delete fs ok');
				window.simulatePG.alert('Tutte le edizioni presenti sono state cancellate.', 'window.simulatePG.exec(null, null, "Notification", "activityStop", [])', 'Cancellazione contenuto locale', 'Ok');
				openProductDetails(_PRODUCT_IN_EDICOLA.productId);
			}, function() {
				console.log('delete error');
				window.simulatePG.alert('Si è verificato un errore durante la cancellazione.', 'window.simulatePG.exec(null, null, "Notification", "activityStop", [])', 'Cancellazione contenuto locale', 'Ok');
			});
		});
	}
}

function inboxDeleteOpenedMessageSucc() {
	if (true) {
		var l_active_message = $('.inbox_list_container_box_active');
		if (l_active_message.length > 0) {
			var l_active_message_id = l_active_message[0].id.substring(25);

			if (_INBOX_MESSAGES['mid_' + l_active_message_id]) {
				/*
				 if (!_INBOX_MESSAGES[l_active_message_id].body) {
				 markMessagesAsRead([l_active_message_id]);
				 }
				 */
				deleteLocalMessages([l_active_message_id]);
			}

			//$('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
			l_active_message.remove();
		}
	}
}

var PGCheckVersion = function() {
}
PGCheckVersion.prototype.checkVersion = function(successCB, errorCB) {
	PhoneGap.exec(successCB, errorCB, 'it.alebeer.checkversion', 'checkVersion', []);
}
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.pgcheckversion = new PGCheckVersion();
});



/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
    
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
	
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.artid);
        	window.searchdb.display(p_article.artid);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
	
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}







/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
//var _DEPLOY_BASE_URL = 'http://212.45.97.204/_deploy/';
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';
var _ADV_PROXY = 'http://mobapp24.ilsole24ore.com/adv_proxy_and.php';
var _ADV_PROXY_TEST = 'http://212.45.97.204/adv_proxy_and.php';

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _SCREENADV = screen.width;
var screenHeight = (_DEBUG_MODE) ? window.innerHeight : screen.height / window.devicePixelRatio ;
var screenWidth = (_DEBUG_MODE) ? window.innerWidth : screen.width / window.devicePixelRatio ;
var isPortrait = screenWidth < screenHeight;
var _LockTap = false;

function onBodyLoaded() {
	$('#wrapper_articolo').bind('click', function(event){
		if (_LockTap) return;
		_LockTap = true;
		wrapperArticoloClick();
		setTimeout(function(){ _LockTap = false; }, 500);
	});
	
	setInterval(function(){
		updateOrientation();
	}, 500);

	if (_API24TEST_SWITCH) {
		_ADV_PROXY = _ADV_PROXY_TEST;
	}
	articoloZoomAuxText(0);

	if (_DB == null) {
		inizializzaDatabase();
		preferitiDBinit();
	}

	if (_DEBUG_MODE) {
		debugContent();
	}
}

function debugContent() {
	_CURRENT_ARTICLE = {};
	_CURRENT_ARTICLE.shared_id = "2769977";
	loadArticolo({
		artid : '1317851504',
		shared_id : '2844111',
		testata : 'S24',
		edizione : 'SOLE',
		issue : '20111129',
		testata_descr : 'Il Sole 24 ORE',
		edizione_descr : 'Il Sole 24 Ore',
		issue_descr : '29 Novembre 2011',
		pagina : 1,
		sezione : 'PRIMA',
		sezione_descr : '6126',
		occhiello : ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"],
		titolo : ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"],
		sottotitolo : ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"],
		firme : [],
		testo : ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
		photos : [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg", "«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]],
		grafici : [],
		sommari : []
	}, [], [], [{
		"items" : [{
			"url" : "http://mrdoob.com/projects/chromeexperiments/ball_pool/",
			"descrizione" : "Ball Pool"
		}],
		"id" : "145",
		"package" : "1317851504",
		"descrizione" : "HTML5 - Ball Pool",
		"preview" : "",
		"tipo" : "LINK"
	}]);
	loadCorrelates();
	loadSezioni([{
		"section" : "4898",
		"description" : "PRIMA"
	}, {
		"section" : "4899",
		"description" : "PRIMO PIANO"
	}, {
		"section" : "4901",
		"description" : "COMMENTI E INCHIESTE"
	}, {
		"section" : "4902",
		"description" : "POLITICA E SOCIETA'"
	}, {
		"section" : "4903",
		"description" : "MONDO"
	}, {
		"section" : "4904",
		"description" : "ECONOMIA E IMPRESE"
	}, {
		"section" : "4905",
		"description" : "NORME E TRIBUTI"
	}, {
		"section" : "4906",
		"description" : "LETTERA AL RISPARMIATORE"
	}, {
		"section" : "4907",
		"description" : "FINANZA E MERCATI"
	}, {
		"section" : "4908",
		"description" : "PRIMA PAGINA DOMENICA"
	}, {
		"section" : "4909",
		"description" : "LUOGHI E PERSONE"
	}, {
		"section" : "4910",
		"description" : "TERZA PAGINA"
	}, {
		"section" : "4911",
		"description" : "RACCONTI"
	}, {
		"section" : "4912",
		"description" : "EDITORIA"
	}, {
		"section" : "4913",
		"description" : "LETTURE"
	}, {
		"section" : "4914",
		"description" : "SCIENZA E FILOSOFIA"
	}, {
		"section" : "4916",
		"description" : "GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
	}, {
		"section" : "4917",
		"description" : "GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
	}, {
		"section" : "4918",
		"description" : "FOTOGRAFIA"
	}, {
		"section" : "4919",
		"description" : "ARTE"
	}, {
		"section" : "4920",
		"description" : "ECONOMIA E SOCIETA'"
	}, {
		"section" : "4922",
		"description" : "MUSICA"
	}, {
		"section" : "4923",
		"description" : "IN SCENA"
	}, {
		"section" : "4924",
		"description" : "TEMPO LIBERATO"
	}, {
		"section" : "4925",
		"description" : "PRIMA PAGINA NOVA24"
	}, {
		"section" : "4926",
		"description" : "IDEE"
	}, {
		"section" : "4927",
		"description" : "IMPRESE"
	}, {
		"section" : "4928",
		"description" : "PRODOTTI"
	}]);

	loadListaArticoliSezione('4899', [{
		"pagina" : "0",
		"titolo" : "Correzione prima dell'Eurogruppo",
		"id" : "1317802942"
	}, {
		"pagina" : "0",
		"titolo" : "Braccio di ferro\nsu viceministri\ne sottosegretari",
		"id" : "1317802946"
	}, {
		"pagina" : "0",
		"titolo" : "«Patrimoniale per chi ha di più»",
		"id" : "1317802948"
	}, {
		"pagina" : "0",
		"titolo" : "I nodi della manovra sul tavolo Monti",
		"id" : "1317802950"
	}, {
		"pagina" : "0",
		"titolo" : "Sull'acqua piani per 30 miliardi",
		"id" : "1317802955"
	}, {
		"pagina" : "0",
		"titolo" : "Sud, per la banda larga 1,3 miliardi",
		"id" : "1317802966"
	}, {
		"pagina" : "0",
		"titolo" : "Infrastrutture, in arrivo\npiù incentivi per i privati",
		"id" : "1317802972"
	}, {
		"pagina" : "0",
		"titolo" : "Prevalga la coesione",
		"id" : "1317802973"
	}, {
		"pagina" : "0",
		"titolo" : "Fini: via i vitalizi degli ex deputati",
		"id" : "1317802976"
	}, {
		"pagina" : "0",
		"titolo" : "Primo taglio: 600 giudici di pace",
		"id" : "1317802982"
	}, {
		"pagina" : "0",
		"titolo" : "Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita",
		"id" : "1317802985"
	}, {
		"pagina" : "0",
		"titolo" : "Casa, più entrate fino a 28 miliardi",
		"id" : "1317802993"
	}, {
		"pagina" : "0",
		"titolo" : "L'urgenza della qualità",
		"id" : "1317802995"
	}, {
		"pagina" : "0",
		"titolo" : "Guida per evitare le liti in condominio",
		"id" : "1317802996"
	}, {
		"pagina" : "0",
		"titolo" : "Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice",
		"id" : "1317803003"
	}, {
		"pagina" : "0",
		"titolo" : "CROLLO IN BORSA",
		"id" : "1317803004"
	}, {
		"pagina" : "0",
		"titolo" : "Enav, arrestato l'ad Pugliesi",
		"id" : "1317803007"
	}, {
		"pagina" : "0",
		"titolo" : "Le Borse guardano al debito Usa",
		"id" : "1317803013"
	}, {
		"pagina" : "0",
		"titolo" : "Bruxelles\nvara un budget\ndi austerità",
		"id" : "1317803017"
	}, {
		"pagina" : "0",
		"titolo" : "Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori",
		"id" : "1317803022"
	}, {
		"pagina" : "0",
		"titolo" : "Sugli eurobond\ntre ipotesi\nda Bruxelles",
		"id" : "1317803023"
	}, {
		"pagina" : "0",
		"titolo" : "I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa",
		"id" : "1317803024"
	}, {
		"pagina" : "0",
		"titolo" : "Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa",
		"id" : "1317803026"
	}, {
		"pagina" : "0",
		"titolo" : "Rischio contagio",
		"id" : "1317803032"
	}, {
		"pagina" : "0",
		"titolo" : "Solo l'Asia resiste\nalla frenata\ndegli scambi",
		"id" : "1317803033"
	}, {
		"pagina" : "0",
		"titolo" : "La liquidità\nche scappa\nsceglie la via\ndi Wall Street",
		"id" : "1317803034"
	}, {
		"pagina" : "0",
		"titolo" : "INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA",
		"id" : "1317803050"
	}, {
		"pagina" : "0",
		"titolo" : "Il «tranello»\ndel dividend yield",
		"id" : "1317803051"
	}, {
		"pagina" : "0",
		"titolo" : "L'impatto \ndell'euro",
		"id" : "1317803052"
	}, {
		"pagina" : "0",
		"titolo" : "Cosa sono lo spread e i buoni del tesoro?",
		"id" : "1317803061"
	}, {
		"pagina" : "0",
		"titolo" : "Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California",
		"id" : "1317803066"
	}, {
		"pagina" : "0",
		"titolo" : "Se il bene è senza prezzo»\nservono tasse e divieti",
		"id" : "1317803068"
	}]);
}

var _INDICE_OPEN = true;
function wrapperArticoloClick() {
	if (_INDICE_OPEN) {
		if (isPortrait) {
			closeIndice();
		} else {
			handleTopbar();
		}
	} else {
		handleTopbar();
	}
}

function openIndice() {
	if (_INDICE_OPEN) return;
	_INDICE_OPEN = true;
	nascondiTopbar();
	var wrapperSize = (!isPortrait) ? 0.25 : 0.4 ;
	
	$('#wrapper_indice').animate({
		'left': '+=' + (screenWidth * wrapperSize) + 'px'
	}, 'normal');
}

function closeIndice() {
	if (!_INDICE_OPEN) return;
	_INDICE_OPEN = false;
	var wrapperSize = (!isPortrait) ? 0.25 : 0.4 ;
	
	$('#wrapper_indice').animate({
		'left': '-=' + (screenWidth * wrapperSize) + 'px'
	}, 'normal');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
		_CURRENT_ARTICLE.titolo = ( typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
		_CURRENT_ARTICLE.sottotitolo = ( typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
		_CURRENT_ARTICLE.occhiello = ( typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
		_CURRENT_ARTICLE.firma = ( typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
		_CURRENT_ARTICLE.testo = ( typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
		_CURRENT_ARTICLE.tags = "";
		// usato per agganciare in automatico gli stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = ( typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
		_CURRENT_ARTICLE.grafici = ( typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
		_CURRENT_ARTICLE.sommari = ( typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = ( typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = ( typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = ( typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;

		return renderArticolo();
	} catch (exc) {
		return exc.message;
	}
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
		_CURRENT_ARTICLE.titolo = ( typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
		_CURRENT_ARTICLE.sottotitolo = ( typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
		_CURRENT_ARTICLE.occhiello = ( typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
		_CURRENT_ARTICLE.firma = ( typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
		_CURRENT_ARTICLE.testo = ( typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
		_CURRENT_ARTICLE.tags = "";
		// usato per agganciare in automatico gli stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = ( typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
		_CURRENT_ARTICLE.grafici = ( typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
		_CURRENT_ARTICLE.sommari = ( typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = ( typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = ( typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = ( typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;

		if (!_DEBUG_MODE) {
			setTimeout(function() {
				// window.location = 'dsh://loading.done';

				$('#container_adv').writeCapture().load(_ADV_PROXY + '?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime() + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
				}).endCapture();
				console.log('adv is ' + _ADV_PROXY + '?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime());
				/*
				$('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
				}).endCapture();*/
				//console.log('adv '+'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04');

				setTimeout(function() {
					nascondiTopbar();
				}, 2000);

			}, 200);
		}
	} catch (exc) {
		return exc.message;
	}
	return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo() {
	try {

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.destroy();
			_ARTICOLO_ISCROLL = null;
		}
		if (_MMEDIA_ISCROLL != null) {
			_MMEDIA_ISCROLL.destroy();
			_MMEDIA_ISCROLL = null;
		}

		checkDBalreadyPresent();

		$('.box_articolo_selected').removeClass('box_articolo_selected');
		if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
			$('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
		}

		$('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
		$('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
		$('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);

		if (_CURRENT_ARTICLE.titolo.length > 0) {
			$('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
			document.getElementById('articolo_titolazione_titolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_titolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
			$('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.occhiello.length > 0) {
			$('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
			document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.firma.length > 0) {
			$('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
			document.getElementById('articolo_titolazione_firma').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_firma').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.testo.length > 0) {
			$('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
		} else {
			$('#articolo_body_text').html('&nbsp;');
		}

		if (_CURRENT_ARTICLE.sommari.length == 0) {
			document.getElementById('articolo_body_media_sommari').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_sommari').style.display = 'block';
			document.getElementById('articolo_body_media_sommari').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_sommario';
				document.getElementById('articolo_body_media_sommari').appendChild(box);

				var con = document.createElement('div');
				con.className = 'articolo_body_media_sommario_container';
				box.appendChild(con);

				var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
				var l_testo = _CURRENT_ARTICLE.sommari[i][1];

				con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<p>' + l_titolo + '</p>') : '') + l_testo;
				//alert("aaa "+_CURRENT_ARTICLE.sommari[i][0] );
				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.photos.length == 0) {
			document.getElementById('articolo_body_media_photos').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_photos').style.display = 'block';
			document.getElementById('articolo_body_media_photos').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
				var box = document.createElement('div');
				box.className = "articolo_body_media_photo";
				document.getElementById('articolo_body_media_photos').appendChild(box);

				var con = document.createElement('div');
				con.className = "articolo_body_media_photo_container";
				box.appendChild(con);

				var crop = document.createElement('div');
				crop.className = "articolo_body_media_photo_container_crop";
				con.appendChild(crop);

				var cropbox = document.createElement('div');
				cropbox.className = 'articolo_body_media_photo_container_crop_box';
				crop.appendChild(cropbox);

				var img = document.createElement('img');
				cropbox.appendChild(img);
				img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';

				if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
					var dida = document.createElement('div');
					con.appendChild(dida);
					dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
					dida = null;
				}

				var open = document.createElement('img');
				open.className = 'articolo_body_media_photo_container_open';
				crop.appendChild(open);
				open.src = 'imgs/articolo_body_media_photo_container_open.png';

				box.onclick = (function(url) {
					return function() {
						if (_LockTap) return;
						_LockTap = true;
						//window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.photos[i][0]);

				open = null;
				img = null;
				cropbox = null;
				crop = null;
				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.grafici.length == 0) {
			document.getElementById('articolo_body_media_grafici').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_grafici').style.display = 'block';
			document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
				var box = document.createElement('div');
				document.getElementById('articolo_body_media_grafici_content').appendChild(box);
				box.className = 'articolo_body_media_arricchimento_item';
				box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';

				box.onclick = (function(url) {
					return function() {
						if (_LockTap) return;
						_LockTap = true;
						//window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.grafici[i][0]);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_photos.length == 0) {
			document.getElementById('articolo_body_media_gallery').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_gallery').style.display = 'block';
			document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_gallery_content').appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';

				box.onclick = (function(id) {
					return function(event) {
						if (_LockTap) return;
						_LockTap = true;
						event.preventDefault();
						event.stopPropagation();
						//window.location = 'dsh://gallery.open/' + id;
						console.log("urlid is" + id);
						window.opengallery.open(id);
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.arr_photos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_videos.length == 0) {
			document.getElementById('articolo_body_media_video').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_video').style.display = 'block';
			document.getElementById('articolo_body_media_video_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_video_content').appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';

				box.onclick = (function(id) {
					return function(event) {
						if (_LockTap) return;
						_LockTap = true;
						event.preventDefault();
						event.stopPropagation();
						//window.location = 'dsh://video.open/' + id;
						window.openvideo.open(id);
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.arr_videos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_link.length == 0) {
			document.getElementById('articolo_body_media_link').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_link').style.display = 'block';
			document.getElementById('articolo_body_media_link_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_link_content').appendChild(box);

				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

				if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
							setTimeout(function(){ _LockTap = false; }, 500);
						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

				box = null;
			}
		}
		
		var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
		if (fullArr.length == 0) {
			document.getElementById('articolo_mainmedia').style.display = 'none';
		} else {
			document.getElementById('articolo_mainmedia').style.display = 'block';
			document.getElementById('articolo_mainmedia_container').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
			$('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
			for (var i = 0; i < fullArr.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_mainmedia_container_box';
				document.getElementById('articolo_mainmedia_container').appendChild(box);

				var container = document.createElement('div');
				container.className = 'articolo_mainmedia_container_box_container';
				box.appendChild(container);

				var img = document.createElement('img');
				img.className = 'articolo_mainmedia_container_box_img';
				container.appendChild(img);
				img.src = fullArr[i]['preview'];

				var icon = document.createElement('img');
				icon.className = 'articolo_mainmedia_container_icon';
				box.appendChild(icon);
				icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';

				if (fullArr[i]['tipo'] == "VIDEO") {
					box.onclick = (function(id) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = 'dsh://video.open/' + id;
							window.openvideo.open(id);
							_LockTap = false;
						}
					})(fullArr[i]['id']);
				} else if (fullArr[i]['tipo'] == "PHOTOS") {
					box.onclick = (function(id) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = 'dsh://gallery.open/' + id;
							console.log("urlid is" + id);
							window.opengallery.open(id);
							_LockTap = false;
						}
					})(fullArr[i]['id']);
				}
				
				icon = null;
				img = null;
				container = null;
				box = null;

				var progress = document.createElement('div');
				progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
				document.getElementById('articolo_mainmedia_progress').appendChild(progress);
				progress = null;
			}
		
			_MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
				snap : true,
				momentum : false,
				hScrollbar : false,
				vScroll : false,
				onScrollEnd : function() {
					document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
					document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
				}
			});
		}

		_ARTICOLO_ISCROLL = new iScroll('wrapper_articolo', {});
		
		$('#articolo_body_text table').click(function(event) {
			event.stopPropagation();
			try {
				ARTICOLO_BODY_TEXT_TABLE_CONTENT = $(this)[0].outerHTML;
				if ((ARTICOLO_BODY_TEXT_TABLE_CONTENT != null) && (ARTICOLO_BODY_TEXT_TABLE_CONTENT.length >= 1)) {
					//window.location = 'dsh://tabella.open/HTML';
					//alert('aaaa12');
					window.opentabella.open(JSON.stringify(ARTICOLO_BODY_TEXT_TABLE_CONTENT));
				}
			} catch (exc) {
				console.log(exc.message);
			}
		});

		loadCorrelates();

		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display", "none");
	} catch (exc) {
		console.log("error: " + exc.message + ":::" + exc.what + ":" + exc.stack);
		return exc.message;
	}

	return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var ARTICOLO_BODY_TEXT_TABLE_CONTENT = '';
function getArticoloBodyTextTableContent() {
	return ARTICOLO_BODY_TEXT_TABLE_CONTENT;
}

var CURRENT_ORIENTATION = null;

function updateOrientation() {
	setTimeout(function() {
		screenHeight = window.innerHeight;
		screenWidth = window.innerWidth;
		if (!screenHeight) screenHeight = screen.height;
		if (!screenWidth) screenWidth = screen.width;
// 		if (!_DEBUG_MODE) screenHeight /= window.devicePixelRatio;
// 		if (!_DEBUG_MODE) screenWidth /= window.devicePixelRatio;
		isPortrait = screenWidth < screenHeight;

		var orientation = isPortrait ? 1 : 2 ;
		if (CURRENT_ORIENTATION == orientation) return;
		CURRENT_ORIENTATION = orientation;
		
		//alert('isPortrait: ' + isPortrait);
		//alert('screenWidth: ' + screenWidth + ', screenHeight: ' + screenHeight);
		
		var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.02) : Math.round(screenWidth * 0.02);
		$('body').css('font-size', fontSizeRatio + 'px');
		fontSizeRatio = null;
		
		if (isPortrait) {
			closeIndice();
		} else {
			openIndice();
		}
		
		var androidComponents = (isPortrait) ? 75 : 25;
		$('#articoli_wrapper').height(screenHeight - $('#sezioni_wrapper').height() - androidComponents);
		
		$('.articolo_mainmedia_container_box').width($('#articolo_mainmedia_wrapper').width());
		$('.articolo_body_media_photo_container_crop').height((isPortrait) ? screenHeight * 0.4 : screenHeight * 0.7) ;
		$('#articolo_mainmedia').height((isPortrait) ? screenHeight * 0.3 : screenHeight * 0.55) ;
		
		if (_ARTICOLO_ISCROLL != null) _ARTICOLO_ISCROLL.refresh();
		if (_ISCROLL_ARTICOLI != null) _ISCROLL_ARTICOLI.refresh();
		
	}, 500);
}

function handleTopbar() {
	//document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
	$('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

//var _TIMEOUT_MENU = null;
function mostraTopbar() {
	$('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar() {
	//document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
	$('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent() {
	if (_DB) {
		var querySuccess = function(tx, rs) {
			checkDBalreadyPresent_aux(rs.rows.length > 0);
		}
		var queryError = function(tx, p_error) {
			checkDBalreadyPresent_aux(false);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	} else {

		checkDBalreadyPresent_aux(false);
	}
}

function checkDBalreadyPresent_aux(isPresent) {
	document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
	document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}

function eliminaPreferito() {
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?', 'eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
	if (_CURRENT_ARTICLE == null)
		return;
	try {
		if (_DB) {
			var querySuccessTag = function(tx) {
				//alert('OK eliminazione tag preferito.');
				document.getElementById('btn_preferiti_off').style.display = 'inline-block';
				document.getElementById('btn_preferiti_on').style.display = 'none';
			}
			var queryErrorTag = function(tx, p_error) {
				//alert('KO eliminazione tag preferito: ' + p_error.message);
			}
			var querySuccess = function(tx) {
				//alert('OK eliminazione preferito.');
				tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
			}
			var queryError = function(tx, p_error) {
				//alert('KO eliminazione preferito: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				try {
					tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
				} catch (exc) {
					console.log(exc.message);
				}
			}
			_DB.transaction(executeQuery);
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function openSavePreferiti() {
	if (_CURRENT_ARTICLE == null)
		return;
	if (_LockTap) return;
	_LockTap = true;

	popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
	setTimeout(function(){ _LockTap = false; }, 500);
}

function doSavePreferiti() {
	try {//MOD HTML
		preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());

		document.getElementById('btn_preferiti_off').style.display = 'none';
		document.getElementById('btn_preferiti_on').style.display = 'inline-block';

		popupPreferitiUpdateArticleChiudi();
	} catch(exc) {
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK preferitiDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO preferitiDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags) {
	console.log("db is " + _DB);
	try {
		if (_DB) {
			var querySuccess = function(tx) {
				console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
				var tags_arr = tags.split(',');
				for (var t = 0; t < tags_arr.length; t++) {
					var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, "");
					//TRIM
					if (l_tag.length <= 0)
						continue;
					tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function() {
						console.log('OK SAVE LOCAL DB TAG');
					}, function(tx, p_error) {
						console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
					});
				}
			}
			var queryError = function(tx, p_error) {
				console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
			}
			_DB.transaction(executeQuery);
		}
	} catch(exc) {
		console.log('error ' + exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson) {
	if (_ISCROLL_SEZIONI != null) {
		_ISCROLL_SEZIONI.destroy();
		_ISCROLL_SEZIONI = null;
	}

	document.getElementById('sezioni_container').innerHTML = '';

	//document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';

	//alert(JSON.stringify(sezioniJson));

	for (var i = 0; i < sezioniJson.length; i++) {

		var box = document.createElement('div');
		box.id = 'box_section_' + sezioniJson[i].section;
		box.className = 'box_sezione';
		document.getElementById('sezioni_container').appendChild(box);

		var inner = document.createElement('div');
		box.appendChild(inner);

		inner.innerHTML = sezioniJson[i].description;

		box.onclick = (function(sid) {
			return function() {
				sezioneSelected(sid);
				_ISCROLL_ARTICOLI.refresh();
			}
		})(sezioniJson[i].section);

		inner = null;
		box = null;

	}

	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true));
	}

	setTimeout(function() {
		_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {});
	}, 200);

	return "OK";

}

function sezioneSelected(sid) {
	$('.box_sezione_selected').removeClass('box_sezione_selected');
	//window.location = 'dsh://indice.load/' + sid;
	window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson) {
	$('#box_section_' + sid).addClass('box_sezione_selected');
	$('#articoli_container').empty();

	if (articoliJson.length == 0) $('#articoli_container').html('<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>');

	for (var i = 0; i < articoliJson.length; i++) {
		var box = document.createElement('div');
		box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
		box.id = 'box_articolo_' + articoliJson[i].id;
		document.getElementById('articoli_container').appendChild(box);

		var titolo = document.createElement('p');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;

		box.onclick = (function(aid) {
			return function() {
				console.log("aid is " + aid);
				window.indice.loadArticle(aid);
				if (isPortrait) closeIndice();
			}
		})(articoliJson[i].id);

		titolo = null;
		box = null;
	}

	setTimeout(function() {
		if (_ISCROLL_ARTICOLI != null) {
			_ISCROLL_ARTICOLI.refresh();
		} else {
			_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
				bounce: false,
				hideScrollbar: true,
				fadeScrollbar: true
			});
		}

		if (_ISCROLL_SEZIONI != null) {
			//_ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
		}
	}, 300);

	return "OK";
}

/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	try {
		_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
	} catch(exc) {
		console.log(exc.message);
	}
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;

/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {

	//$('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').html(p_article.titolo);
		$('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
		$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for (var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
				}
			}
			var queryError = function(p_error) {
				console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();
	// Salva le modifiche
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
		}
		var updateQuerySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			if (p_results.rowsAffected > 0) {
				document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
			}
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
			var l_tags_array = l_tags.toLowerCase().split(',');
			for (var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, "");
				//TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
			}
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	//$('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

function decodeHtml(value) {
	return $('<div />').html(value).text();
}

function shareFacebook() {
	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;
		
	if (_LockTap) return;
	_LockTap = true;

    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';

	var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

	//window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
	//window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
	window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent(l_url) + '&t=' + encodeURIComponent(l_titolo));
	setTimeout(function(){ _LockTap = false; }, 500);
}

function shareTwitter() {
	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;
		
	if (_LockTap) return;
	_LockTap = true;

   var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';
    
	var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

	//window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
	//window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
	window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent(l_url) + '&text=' + encodeURIComponent(l_titolo));
	setTimeout(function(){ _LockTap = false; }, 500);
}

/*
 function shareFacebook(){
 if (_CURRENT_ARTICLE == null)
 return;

 if (_CURRENT_ARTICLE == null)
 return;

 var l_shared_id = _CURRENT_ARTICLE.shared_id;
 if (l_shared_id == null)
 return;

 var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

 window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
 }

 function shareTwitter(){
 if (_CURRENT_ARTICLE == null)
 return;

 var l_shared_id = _CURRENT_ARTICLE.shared_id;
 if (l_shared_id == null)
 return;

 var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

 window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
 }

 */
var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
var _API24_APPKEY = "DroidQuot";//"iPadQuot";
//DA CAMBIARE
var _APPNAME = 'ITQUOIPAD';
//DA CAMBIARE
var _APPVERSION = '1.1';
// DA CAMBIARE A 2.0
function loadCorrelates() {
	if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null))
		renderCorrelate(null, null);

	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');

	var req_headers = {
		"appKey" : _API24_APPKEY
	};
	var req_data = {
		"appName" : _APPNAME,
		"appVersion" : _APPVERSION
	};
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
	$.ajax({
		type : "GET",
		cache : false,
		timeout : _AJAX_TIMEOUT,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
		headers : req_headers,
		data : req_data,
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
		},
		error : function() {
			renderCorrelate(null, null);
		}
	});
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		$('#articolo_body_media_correlati').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}

		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);

		box.innerHTML = articoli[i].titolo;

		box.onclick = (function(url) {
			return function(event) {
				event.preventDefault();
				event.stopPropagation();
				window.open.openUrl(url);
			}
		})(articoli[i].url);

		box = null;
	}

	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}

}

function articoloZoomAuxText(p_zoomstep) {
	try {
		if (_LockTap) return;
		_LockTap = true;
		var l_currtextzoom = null;
		if ( typeof (window.localStorage) != 'undefined') {
			l_currtextzoom = window.localStorage.getItem("currtxtzoom");
		}
		if (!l_currtextzoom)
			l_currtextzoom = 100;
		else
			l_currtextzoom = parseInt(l_currtextzoom);
		switch (l_currtextzoom) {
			case 80:
			case 100:
			case 120:
			case 140:
			case 160:

				break;
			default:
				l_currtextzoom = 100;
		}
		l_currtextzoom = Math.max(80, Math.min(160, l_currtextzoom + p_zoomstep));
		window.localStorage.setItem("currtxtzoom", l_currtextzoom);
		$('#articolo_body_text').css('font-size', l_currtextzoom + '%');

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
		setTimeout(function(){ _LockTap = false; }, 500);
	} catch (exc) {
		console.log(exc.message);
	}
}

function articoloZoomInText() {
	articoloZoomAuxText(20);
	//console.log("aaaaaaaa1a");
}

function articoloZoomOutText() {
	articoloZoomAuxText(-20);
	//console.log("aaaaaaaaa");
}

function shareMy24() {
	try {
		if (_CURRENT_ARTICLE == null)
			return;

		var l_shared_id = _CURRENT_ARTICLE.shared_id;
		if (l_shared_id == null)
			return;
			
		if (_LockTap) return;
		_LockTap = true;

		var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

		var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_my24.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

		window.open.openUrl(l_url);
		setTimeout(function(){ _LockTap = false; }, 500);
	} catch(exc) {
		alert(exc.message);
	}
}

if (_DEBUG_MODE) {
	$(function(){ onBodyLoaded(); });
} else {
	document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
}

function setBackground(color){
	$('#wrapper_articolo').css("background-color", color);
	$('#wrapper_articolo').css("background-image","none");
}

/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';


function doCerca() {
	if ($('#search_input').val() == '') return;
	if ($('#searchkeyword_option').val() == 'LOCAL')
		searchDb();
	else
		remoteSearch();
}


var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_ISCROLL_ARTICOLI != null) {
		_ISCROLL_ARTICOLI.destroy();
		_ISCROLL_ARTICOLI = null;
	}
	
	document.getElementById('articoli_container').innerHTML = '';
	
	if (articoliJson.length == 0)
		document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';
	
	for (var i = 0; i < articoliJson.length; i++) {
		
		var box = document.createElement('div');
		box.className = 'box_articolo';
		document.getElementById('articoli_container').appendChild(box);
		box.id = 'box_articolo_' + i;
		
		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;
		
		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;
		
		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr + '</strong> del ' + articoliJson[i].issue_descr + ' (pag. ' + articoliJson[i].pagina + ')';
		
		box.onclick = (function(articoloJson, domid) {
			return function(){
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(function() {
					that.className = 'box_articolo';
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;
					
					//window.location = 'dsh://remotecerca.goto';
					//alert(articoloJson.testata + ' ' + articoloJson.issue + ' ' + articoloJson.edizione + ' ' + articoloJson.itunes);
				}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);
		
		pagina = null;
		snippet = null;
		titolo = null;
		box = null;
		
	}
	
	setTimeout(function() {
		_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', { hScroll: false, vScroll: true });
		_ISCROLL_ARTICOLI.scrollTo(0,0,100);
		
	}, 200);
}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata': _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA, 
			'issue': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE, 
			'edizione': _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE, 
			'itunes': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url': _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}


function onBodyLoad(){

    //mostraTopbar();
    
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    $('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    $('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

function updateOrientation(){
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
        inboxAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

function searchDb(){
	//alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	
	if (toSearch == '') {
		alert('Inserisci una chiave di ricerca');
		return;
	}
	
	//Array res = window.searchdb.search(toSearch);
	//searchAddMessages(res);
}

function remoteSearch(){
	//alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	//alert('remote!!!' + toSearch);
	//Array res = window.searchdb.search(toSearch);
	//searchAddMessages(res);
}

//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}






		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_03', function() { }).endCapture();
		}
	

/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

function doCerca() {
	if ($('#search_input').val() == '') return;
	/*if ($('#searchkeyword_option') == null){
		searchDb();
		return;
	}*/
	if ($('#searchkeyword_option').val() == 'REMOTE')
		remoteSearch();
	else
		searchDb();
}


var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_RICERCA_ISCROLL_VISTA != null) {
		_RICERCA_ISCROLL_VISTA.destroy();
		_RICERCA_ISCROLL_VISTA = null;
	}
	
	if((articoliJson == null) || (typeof articoliJson == undefined)){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	//preferitiOpenArticlesList(res);
	 $('#preferiti_body_vista_container').empty();
	
	//alert(JSON.stringify(articoliJson)+","+articoliJson.length);
	
	//articoliJson = JSON.parse( JSON.stringify( articoliJson ) );
	
	//alert('aaa' + articoliJson.length);
	
	document.getElementById('search_list_container').innerHTML = '';
	
	if (articoliJson.length == 0)
		document.getElementById('search_list_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';
	
	for (var i = 0; i < articoliJson.length; i++) {
		
		var box = document.createElement('div');
		box.className = 'box_articolo_remote';
		document.getElementById('search_list_container').appendChild(box);
		box.id = 'box_articolo_' + i;
		
		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;
		
		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;
		
		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr + '</strong> del ' + articoliJson[i].issue_descr + ' (pag. ' + articoliJson[i].pagina + ')';
		
		box.onclick = (function(articoloJson, domid) {
			return function(){
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(function() {
					that.className = 'box_articolo_remote';
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;
					
					//window.location = 'dsh://remotecerca.goto';
					//alert(articoloJson.testata + ',' + articoloJson.issue + ',' + articoloJson.edizione + ',' + articoloJson.itunes);
					
					//window.searchdb.display(articoloJson.idart);
					
					//checkaquisto
					//var para = new Array();//[articoloJson.testata,articoloJson.issue,articoloJson.edizione,articoloJson.pagina];
					/*para[0] =  articoloJson.testata ;
					para[1] =   articoloJson.issue;
					para[2] =  articoloJson.edizione ;
					para[3]=  articoloJson.pagina ;
					*/
					var para = articoloJson.testata + "|" + articoloJson.issue + "|" +  articoloJson.edizione + "|" + articoloJson.pagina;
					//alert( "asdce "+JSON.stringify(para));
					window.searchdb.check(articoloJson.productid,  articoloJson.issue, articoloJson.edizione,articoloJson.accounting, articoloJson.itunes, "sfoglia", para);
					//checkAcquisto(articoloJson.productid,  articoloJson.issue, articoloJson.accounting, articoloJson.itunes, function() { sfoglia(articoloJson.testata, articoloJson.issue, articoloJson.edizione, articoloJson.pagina); });
					//poi apro pagina
				}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);
		
		pagina = null;
		snippet = null;
		titolo = null;
		box = null;
		
	}
	
	setTimeout(function() {
		
		
		
		_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');// = new iScroll('search_list_wrapper', { hScroll: false, vScroll: true });
		_RICERCA_ISCROLL_VISTA.scrollTo(0,0,0);
		
		
	    $('#search_list_container').css("background-color","white");
	    //$('#search_list_container').css("height","100%")
	    $('#search_list_wrapper').css("position","relative");
	    //$('#search_list_wrapper').css("height","100%")
	    //$('#search_list_wrapper').css("height","460px");
	    $('#search_list_wrapper').css("overflow","hidden");
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html(articoliJson.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white"){
	    	$('#search_list_wrapper').css("background-color","white");
	    }
	    
	    _RICERCA_ISCROLL_VISTA.refresh();

		
	}, 200);
	

}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata': _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA, 
			'issue': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE, 
			'edizione': _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE, 
			'itunes': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url': _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}



var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
	
	//window.searchdb.remoteSearch('abc');
	//window.searchdb.search3('abc');
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
	 	$("#search_input").keydown( function(event) {
            if (event.keyCode == 13) {
            	doCerca();
            }
    });

}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
        var screenHeight = screen.height;
			if (screenHeight > 0) {
      		$('#search_box').height(screenHeight - 47);
      		$('#search_list_wrapper').height($('#search_box').height() - 90);
			}
			
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.pagina);
        	//alert('pag ' + p_article.pagina + "," + JSON.stringify(p_article) );
        	window.searchdb.display(p_article.artid);
        	//renderPreferitiArticle(p_article);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + '<strong>' + p_article.sezione + '</strong> ' + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
	
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function remoteSearch(){
	try{
		//alert($('#search_input').val());
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
		
		window.searchdb.remoteSearch(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert('remote!!!' + toSearch);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
	
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
var _API24_APPKEY = "DroidQuot";//"iPadQuot";//DA CAMBIARE
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.5';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}








		function ipadFlipperTopBarEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuPreferiti() {
			window.location = 'dsh://preferiti.open';
		}
		function ipadFlipper24AppmenuInbox() {
			window.location = 'dsh://inbox.open';
		}
		function ipadFlipper24AppmenuImpostazioni() {
			window.location = 'dsh://impostazioni.open';
		}
		function ipadFlipper24Thumb() {
			window.location = 'dsh://thumb.open';
		}
		function ipadFlipper24UpdatePgnum(current, total) {
			document.getElementById('flipper24_topbar_thumb').innerHTML = current + ' di ' + total;
			return "OK";
		}
		function ipadFlipper24AppmenuIndice() {
			window.location = 'dsh://indice.open';
		}
	


    	function loadTabella(p_tabella) {
    		if (!p_tabella) return;
    		//alert(JSON.stringify(p_tabella));
    		if (p_tabella.titolo) {
    			document.getElementById('flipper24_tab_titolo').innerHTML = p_tabella.titolo;
    		} else {
    			document.getElementById('flipper24_tab_titolo').style.display = 'none';
    		}
    		if (p_tabella.contenuto) {
    			document.getElementById('flipper24_tab_contenuto').innerHTML = p_tabella.contenuto;
    		} else {
    			document.getElementById('flipper24_tab_contenuto').style.display = 'none';
    		}
    	}
    




		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_02', function() { }).endCapture();
		}
	



			var _DEBUG_MODE = !('ontouchstart' in window);
			var orientationTimer = null;
			
			function getRatio(value) {
				return parseInt(value) / window.devicePixelRatio;
			}
			
			var CURRENT_ORIENTATION = null;
			
			function updateOrientation() {
				var screenHeight = screen.height;
				var screenWidth = screen.width;
				isPortrait = screenWidth < screenHeight;
				var aspectRatio = screenWidth / screenHeight;

				var orientation = isPortrait ? 1 : 2 ;
				if (CURRENT_ORIENTATION == orientation) return;
				CURRENT_ORIENTATION = orientation;
		
				var fontSizeRatio = (isPortrait) ? Math.round(getRatio(screenHeight) * 0.02) : Math.round(getRatio(screenWidth) * 0.02);
				$('body').css('font-size', fontSizeRatio + 'px');
				fontSizeRatio = null;
				
				var spaceComponents = 0;
				var contentWidth = document.documentElement.clientWidth;
				var contentHeight = getRatio(screenHeight - 200 - spaceComponents);
				if (isPortrait) contentHeight /= 2.8;
				$('#wrapper').width(contentWidth).height(contentHeight).show();
			}
			
			function onBodyLoaded() {
				$('#wrapper').hide();
				
				setInterval(function(){
					updateOrientation();
				}, 500);
			}
			
			if (_DEBUG_MODE) {
				$(function(){ onBodyLoaded(); });
			} else {
				document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
			}
		










			var _ISCROLL_SEZIONI = null;
			var _ISCROLL_ARTICOLI = null;
			var _DEBUG_MODE = !('ontouchstart' in window);
			
			function getRatio(value) {
				return parseInt(value) / window.devicePixelRatio;
			}
			
// 			var CURRENT_ORIENTATION = null;
			
			function updateOrientation(screenWidth, screenHeight) {
				//var screenWidth = screen.width;
				//var screenHeight = screen.height;
				var deviceData = $.parseJSON(window.DeviceDetection.getData());
				var aspectRatio = screenWidth / screenHeight;
				isPortrait = screenWidth < screenHeight;

// 				var orientation = isPortrait ? 1 : 2 ;
// 				if (CURRENT_ORIENTATION == orientation) return;
// 				CURRENT_ORIENTATION = orientation;
		
				var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.03) : Math.round(screenWidth * 0.03);
				$('body').css('font-size', fontSizeRatio + 'px');
				fontSizeRatio = null;
				
				$('#wrapper').width(screenWidth).height(screenHeight);

				//alert(screen.height + ' ' + document.documentElement.clientWidth + ' ' + window.innerHeight);
			}
			
			function loadSezioni(sezioniJson) {
			
				if (_ISCROLL_SEZIONI != null) {
					_ISCROLL_SEZIONI.destroy();
					_ISCROLL_SEZIONI = null;
				}

				document.getElementById('sezioni_container').innerHTML = '';
			
				for (var i = 0; i < sezioniJson.length; i++) {

					var box = document.createElement('div');
					box.id = 'box_section_' + sezioniJson[i].section;
					box.className = 'box_sezione';
					document.getElementById('sezioni_container').appendChild(box);

					var inner = document.createElement('div');
					box.appendChild(inner);

					inner.innerHTML = sezioniJson[i].description;

					box.onclick = (function(sid) {
						return function() {
							sezioneSelected(sid);
						}
					})(sezioniJson[i].section);

					inner = null;
					box = null;

				}

				if (sezioniJson.length > 0) {
					var scrollerWidth = 0;
					$('#sezioni_container .box_sezione').each(function(){
						scrollerWidth += $(this).width();
					});
					$('#sezioni_container').width(scrollerWidth);
					scrollerWidth = null;
				}
				
				//$('.box_sezione').eq(0).addClass('box_sezione_selected');
				$('.box_sezione div').css('margin-top', ($('#sezioni_wrapper').height() - $('.box_sezione div').eq(0).outerHeight()) / 2);

				setTimeout(function() {
					_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
						hideScrollbar: true,
						fadeScrollbar: true
					});
					_ISCROLL_SEZIONI.scrollTo(0, 0, 100);
					_ISCROLL_SEZIONI.refresh();
					
					$('#sezioni_container .box_sezione').eq(0).trigger('click');
				}, 200);
				
				return "OK";
			}

			function sezioneSelected(sid) {
				$('.box_sezione_selected').removeClass('box_sezione_selected');
				//window.location = 'dsh://indice.load/' + sid;
				console.log("sezioneSelected  " + sid);
				window.indice.load(sid);
			}

			function loadListaArticoliSezione(sid, articoliJson) {
				$('#box_section_' + sid).addClass('box_sezione_selected');

				if (_ISCROLL_ARTICOLI != null) {
					_ISCROLL_ARTICOLI.destroy();
					_ISCROLL_ARTICOLI = null;
				}

				document.getElementById('articoli_container').innerHTML = '';

				if (articoliJson.length == 0)
					return "VUOTO";

				for (var i = 0; i < articoliJson.length; i++) {

					var box = document.createElement('div');
					box.className = 'box_articolo';
					box.id = 'box_articolo' + new Date().getTime();
					document.getElementById('articoli_container').appendChild(box);

					var titolo = document.createElement('h1');
					box.appendChild(titolo);
					titolo.innerHTML = articoliJson[i].titolo;

					var pagina = document.createElement('h3');
					box.appendChild(pagina);
					pagina.innerHTML = 'pag. ' + articoliJson[i].pagina;

					console.log('indice box1 ' + box.id);

					box.onclick = (function(pagina) {
						return function() {
							$('#' + this.id).addClass('box_articolo_selected');

							setTimeout(function() {
								$('.box_articolo_selected').removeClass('box_articolo_selected');
							}, 120);

							setTimeout(function() {
								console.log("vai a " + pagina);
								//Da USARE GOTO THUMB
								window.go.to(pagina);

							}, 150);
						}
					})(articoliJson[i].pagina);

					pagina = null;
					titolo = null;
					box = null;

				}

				setTimeout(function() {
					_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
						hScroll : false,
						vScroll : true
					});
					_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);

				}, 200);

				return "OK";

			}

			if (_DEBUG_MODE) {
				$(function(){ onBodyLoaded(); });
			} else {
				document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
			}
		

var lockDoubleTap = false;
/**
 * @author ABertacco
 */
function ab_number_format(number, decimals, dec_point, thousands_sep) {

	var n = number, prec = decimals;

	var toFixedFix = function(n, prec) {
		var k = Math.pow(10, prec);
		return (Math.round(n * k) / k).toString();
	};

	n = !isFinite(+n) ? 0 : +n;
	prec = !isFinite(+prec) ? 0 : Math.abs(prec);
	var sep = ( typeof thousands_sep === 'undefined') ? ',' : thousands_sep;
	var dec = ( typeof dec_point === 'undefined') ? '.' : dec_point;

	var s = (prec > 0) ? toFixedFix(n, prec) : toFixedFix(Math.round(n), prec);
	//fix for IE parseFloat(0.55).toFixed(0) = 0;
	var abs = toFixedFix(Math.abs(n), prec);
	var _, i;

	if (abs >= 1000) {
		_ = abs.split(/\D/);
		i = _[0].length % 3 || 3;

		_[0] = s.slice(0, i + (n < 0)) + _[0].slice(i).replace(/(\d{3})/g, sep + '$1');
		s = _.join(dec);
	} else {
		s = s.replace('.', dec);
	}

	var decPos = s.indexOf(dec);
	if (prec >= 1 && decPos !== -1 && (s.length - decPos - 1) < prec) {
		s += new Array(prec - (s.length - decPos - 1)).join(0) + '0';
	} else if (prec >= 1 && decPos === -1) {
		s += dec + new Array(prec).join(0) + '0';
	}
	return s;
}

function ab_euro_formatter(number) {
	return ab_number_format(number, 2, ',', '.') + " €";
}

var dateFormat = function() {
	var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g, timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g, timezoneClip = /[^-+\dA-Z]/g, pad = function(val, len) {
		val = String(val);
		len = len || 2;
		while (val.length < len)
		val = "0" + val;
		return val;
	};

	// Regexes and supporting functions are cached through closure
	return function(date, mask, utc) {
		var dF = dateFormat;

		// You can't provide utc if you skip other args (use the "UTC:" mask prefix)
		if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
			mask = date;
			date = undefined;
		}

		// Passing date through Date applies Date.parse, if necessary
		date = date ? new Date(date) : new Date;
		if (isNaN(date))
			throw SyntaxError("invalid date");

		mask = String(dF.masks[mask] || mask || dF.masks["default"]);

		// Allow setting the utc argument via the mask
		if (mask.slice(0, 4) == "UTC:") {
			mask = mask.slice(4);
			utc = true;
		}

		var _ = utc ? "getUTC" : "get", d = date[_ + "Date"](), D = date[_ + "Day"](), m = date[_ + "Month"](), y = date[_ + "FullYear"](), H = date[_ + "Hours"](), M = date[_ + "Minutes"](), s = date[_ + "Seconds"](), L = date[_ + "Milliseconds"](), o = utc ? 0 : date.getTimezoneOffset(), flags = {
			d : d,
			dd : pad(d),
			ddd : dF.i18n.dayNames[D],
			dddd : dF.i18n.dayNames[D + 7],
			m : m + 1,
			mm : pad(m + 1),
			mmm : dF.i18n.monthNames[m],
			mmmm : dF.i18n.monthNames[m + 12],
			yy : String(y).slice(2),
			yyyy : y,
			h : H % 12 || 12,
			hh : pad(H % 12 || 12),
			H : H,
			HH : pad(H),
			M : M,
			MM : pad(M),
			s : s,
			ss : pad(s),
			l : pad(L, 3),
			L : pad(L > 99 ? Math.round(L / 10) : L),
			t : H < 12 ? "a" : "p",
			tt : H < 12 ? "am" : "pm",
			T : H < 12 ? "A" : "P",
			TT : H < 12 ? "AM" : "PM",
			Z : utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
			o : (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
			S : ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
		};

		return mask.replace(token, function($0) {
			return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
		});
	};
}();

// Some common format strings
dateFormat.masks = {
	"default" : "ddd mmm dd yyyy HH:MM:ss",
	shortDate : "m/d/yy",
	mediumDate : "mmm d, yyyy",
	longDate : "mmmm d, yyyy",
	fullDate : "dddd, mmmm d, yyyy",
	shortTime : "h:MM TT",
	mediumTime : "h:MM:ss TT",
	longTime : "h:MM:ss TT Z",
	isoDate : "yyyy-mm-dd",
	isoTime : "HH:MM:ss",
	isoDateTime : "yyyy-mm-dd'T'HH:MM:ss",
	isoUtcDateTime : "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};

// Internationalization strings
dateFormat.i18n = {
	dayNames : ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
	monthNames : ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
};

// For convenience...
Date.prototype.format = function(mask, utc) {
	return dateFormat(this, mask, utc);
};

function parseDateWithDbFormat(string) {
	var reggie = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/g;
	var tokens = reggie.exec(string);
	if (tokens.length != 7)
		return new Date();
	else
		return new Date(tokens[1], tokens[2] - 1, // mesi partono da 0 in js
		tokens[3], tokens[4], tokens[5], tokens[6]);
};

var abutils = {
	voidfunc : function() {
	},
	alert : function(msg, title, callback) {
		if (title == null)
			title = "Il Sole 24 ORE";
		if (callback == null)
			callback = abutils.voidfunc;
		try {

			navigator.notification.alert(msg, function() {
				callback.call();
			}, title, 'Ok');

		} catch (exc) {
			alert(msg);
			if (callback != null) {
				callback.call();
			}
		}
	}
};

var PGAleBerUtils = function() {
}
PGAleBerUtils.prototype.splashScreenHide = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'splashScreenHide', []);
}
PGAleBerUtils.prototype.activityStart = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStart', []);
}
PGAleBerUtils.prototype.activityStop = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStop', []);
}
PGAleBerUtils.prototype.deviceExtraInfo = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deviceExtraInfo', []);
}
PGAleBerUtils.prototype.deleteDirectoryAtAbsolutePath = function(successCB, errorCB, path) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deleteDirectoryAtAbsolutePath', [path]);
}
PGAleBerUtils.prototype.registerForRemoteNotification = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'registerForRemoteNotification', []);
}
/*
 PhoneGap.addConstructor(function() {
 if(!window.plugins)
 window.plugins = {};
 window.plugins.pgaleberutils = new PGAleBerUtils();
 });
 */
/* ------------------------------------------------------------- */

var PGFlipper24 = function() {
}
PGFlipper24.prototype.trackApp = function(successCB, errorCB, pageName, channel) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.appmeasurement', 'trackApp', [pageName, channel]);
}
PGFlipper24.prototype.openFlipper24 = function(successCB, errorCB, testata, edizione, issue, startingPage, fastLoading) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.flipper24', 'openFlipper24', [testata, edizione, issue, startingPage, fastLoading]);
}
PGFlipper24.prototype.addIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'addIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.removeIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.getQueueDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'getQueueDownloadQueue', []);
}
PGFlipper24.prototype.removeAllIssuesFromDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeAllIssuesFromDownloadQueue', []);
}
var PGAppStore = function() {
}
PGAppStore.prototype.setup = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setup', []);
}
PGAppStore.prototype.setUserInfo = function(successCB, errorCB, username, useridentity) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setUserInfo', [username, useridentity]);
}
PGAppStore.prototype.productsListRequest = function(successCB, errorCB, productsIds) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'productsListRequest', [productsIds]);
}
PGAppStore.prototype.purchase = function(successCB, errorCB, productId, planS24) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'purchase', [productId, planS24]);
}
/*
 PhoneGap.addConstructor(function() {
 if(!window.plugins)
 window.plugins = {};
 window.plugins.flipper24 = new PGFlipper24();
 window.plugins.appstore = new PGAppStore();
 });
 */

/* ------------------------------------------------------------- */
NotificationEx = function() {
};

NotificationEx.prototype.loadingStart = function(options) {
	//PhoneGap.exec(null, null, "NotificationEx","loadingStart", [options]);
};
NotificationEx.prototype.loadingStop = function() {
	//PhoneGap.exec(null, null, "NotificationEx","loadingStop", []);
};

NotificationEx.prototype.activityStart = function() {
	//PhoneGap.exec(null, null, "NotificationEx", "activityStart", []);
};

NotificationEx.prototype.activityStop = function() {
	//PhoneGap.exec(null, null, "NotificationEx", "activityStop", []);
};
/*
PhoneGap.addConstructor(function() {
if(!window.plugins)
window.plugins = {};
navigator.plugins.notificationEx = new NotificationEx();
});*/

// Variabile contente l'identificativo del prodotto aperto in edicola
var _PRODUCT_IN_EDICOLA = null;
var _INTERVALLO_CHECK_PRODUCTS = 15 * 60 * 1000;
var _EDICOLA_PRODUCTS_ISCROLL = null;
var _EDICOLA_PRODUCTS_COUNT = 0;
var _EDICOLA_PRODUCTS_INLINE_V = 3;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _EDICOLA_PRODUCTS_INLINE_H = 4;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _EDICOLA_PRODUCTS_DETAILS = null;
var _EDICOLA_DESCR_ISCROLL = null;
// Flag utile per capire se i prodotti in edicola debbano essere aggiornati quando l'utente clicca sul relativo pulsante nella barra menu
var _EDICOLA_REFRESH_PRODUCTS = false;
// hash map tra testata e product id del sole, utilizzato per aprire l'archivio
var _HASH_MAP_TESTATA_PRODUCTID = {};

var _DEBUG_MODE = !('ontouchstart' in window), _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseup';
/*
 var _API24_APPKEY = "IpadQuot";//<- PRODUZIONE //// DA CAMBIARE!!! //DroidQuot
 //var _API24_APPKEY = "1123344";//<- NEURAL
 //var _API24_SIGNATURE_KEY = "qu0t$STG";//<- PRODUZIONE
 var _API24_SIGNATURE_KEY = "qu0t$PROD";//<- PRODUZIONE
 //var _API24_SIGNATURE_KEY = "pppppppp";//<- NEURAL
 var _API24_SITECODE = "MB"
 var _API24_ENDPOINT = "https://api24.ilsole24ore.com/"; //<- PRODUZIONE
 //var _API24_ENDPOINT = "http://10.5.4.166:400/";//<- NEURAL
 var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";

 var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
 */

var _SCREENADV = window.innerWidth;

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _debugIPADContent = false;

var _API24_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
//<- PRODUZIONE //DroidQuot iPadQuot
var _API24_SIGNATURE_KEY = "qu0t$PROD";
//<- PRODUZIONE
var _API24_SITECODE = "MB"
var _API24_ENDPOINT = "https://api24.ilsole24ore.com/";
//<- PRODUZIONE
var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";
var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php";

var _API24TEST_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
//<- STAGE //DroidQuot iPadQuot
var _API24TEST_SIGNATURE_KEY = "qu0t$STG";
//<- STAGE
var _API24TEST_SITECODE = "MB"
var _API24TEST_ENDPOINT = "http://api24test.ilsole24ore.com/";
//<- STAGE
var _SOLEGWTEST_ENDPOINT = _API24TEST_ENDPOINT + "SoleGateway/";
var _ADVTEST_PROXY = "http://212.45.97.204/adv_proxy_and.php";

// Variabile globale contenente lo username dell'utente che sta utilizzando l'applicativo
var _USERNAME = null;
// Variabile globale contenente la password dell'utente che sta utilizzando l'applicativo
var _USER_PASSWORD = null;
// Variabile globale contenente lo user identity associato all'utente
var _USER_IDENTITY = null;
// Variabile contenente la funzione da richiamare come prossima azione. Utile in diverse situazioni per esempio dopo aver fatto la login e proseguire con la prossima azione.
var _NEXT_ACTION = null;

var _AJAX_TIMEOUT = 15000;
var _INTERVALLO_CHECK_INBOX = 15 * 60 * 1000;
var _INTERVALLO_CHECK_ONLINE = 15 * 1000;

/*******************AGGIUNTA PER CHECKACQ*****************************************/
//metterlo a false se non si vogliono usare le categorie
//quotidiano --> false
//riviste professionali --> true
var _EDICOLA_USE_CATEGORIES = false;
//metterlo a true se si vuole chiedere la registrazione pre-acquisto one-shot
//quotidiano --> false
//riviste professionali --> true
var _ONESHOT_CHECK_REGISTRATO = true;


function loadCategories() {
	try {

		// svuoto categorie
		$('#edicola_titolo_btn').html('');

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getCategorie");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "categories.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getCategories");
				console.log(p_response);
				if (checkAjaxResponse(p_response)) {
					var res = p_response.Result.res;
					if ((!res.categoryList) || (res.categoryList.length <= 0)) {
						loadProductsByCategory(null);
						return;
					}
					var l_select = $('<select onchange="edicolaFiltroProdottiByCategory();" id="edicola_titolo_btn_select"></select>');
					for (var i = 0; i < res.categoryList.length; i++) {
						$('<option value="' + res.categoryList[i].categoryName + '">' + res.categoryList[i].categoryDescription + '</option>').appendTo(l_select);
					}

					$('#edicola_titolo_btn').html('');
					l_select.appendTo('#edicola_titolo_btn');

					loadProductsByCategory(res.categoryList[0].categoryName);
				} else {
					console.log('getCategories check ajax response error');
					loadProductsByCategory(null);
				}
			},
			error : function() {
				console.log('getCategories ajax error');
				loadProductsByCategory(null);
			}
		});
	} catch (exc) {
		console.log('getCategories exception ' + exc.message);
		loadProductsByCategory(null);
	}
}

function loadProductsByCategory(p_category) {
	console.log('loadProductsByCategory:' + p_category);
	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		/*
		 if (_EDICOLA_PRODUCTS_DETAILS)
		 $(_EDICOLA_PRODUCTS_DETAILS).empty();
		 else
		 _EDICOLA_PRODUCTS_DETAILS = new Array();
		 */
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + JSON.stringify(p_response));
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if ( typeof _PRODUCTLINK[0] != 'undefined' && _PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {
							/*
							 // icona small webpage
							 var pbox_icon_webpage = document.createElement('div');
							 pbox_icon.appendChild(pbox_icon_webpage);
							 pbox_icon_webpage.className = 'edicola_prodotto_box_icon_webpage';
							 pbox_icon_webpage = null;
							 */

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}
					/*
					 // aggiungo prodotti vuoti per completare la riga verticale
					 if (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_V != 0) {
					 for (var i = 0; i < _EDICOLA_PRODUCTS_INLINE_V - (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_V); i++) {
					 var pbox = document.createElement('div');
					 if (_EDICOLA_CATALOGO_SMALL) {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small edicola_prodotto_box_fake_v';
					 }
					 else {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_fake_v';
					 }
					 l_edicola_container.appendChild(pbox);

					 var pbox_container = document.createElement('div');
					 pbox.appendChild(pbox_container);
					 pbox_container.className = 'edicola_prodotto_box_container';

					 pbox_container = null;
					 pbox = null;
					 }
					 }
					 // aggiungo prodotti vuoti per completare la riga orizzontale
					 if (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_H != 0) {
					 for (var i = 0; i < _EDICOLA_PRODUCTS_INLINE_H - (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_H); i++) {
					 var pbox = document.createElement('div');
					 if (_EDICOLA_CATALOGO_SMALL) {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small  edicola_prodotto_box_fake_h';
					 }
					 else {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_fake_h';
					 }
					 l_edicola_container.appendChild(pbox);

					 var pbox_container = document.createElement('div');
					 pbox.appendChild(pbox_container);
					 pbox_container.className = 'edicola_prodotto_box_container';

					 pbox_container = null;
					 pbox = null;
					 }
					 }
					 */

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});
	} catch(exc) {
		console.log("error::load: " + exc.message);
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}
}

/**
 * Gestisce il caricamento dell'anteprima dei prodotti nell'edicola
 * Utilizza le seguenti chiamate:
 *   - ajaxErrorHandler per la gestione degli errori di comunicazione con API24
 */
var _EDICOLA_LAST_PRODUCT_LOAD = null;
function loadProducts() {

	if ((_EDICOLA_LAST_PRODUCT_LOAD != null) && (Math.abs(_EDICOLA_LAST_PRODUCT_LOAD - (new Date().getTime())) < _INTERVALLO_CHECK_PRODUCTS )) {
		console.log('loadProducts NON necessario');
		return;
	}

	_EDICOLA_LAST_PRODUCT_LOAD = new Date().getTime();

	if (_EDICOLA_USE_CATEGORIES) {
		loadCategories();
		return;
	} else {
		loadProductsByCategory(null);
		return;
	}

	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		/*
		 if (_EDICOLA_PRODUCTS_DETAILS)
		 $(_EDICOLA_PRODUCTS_DETAILS).empty();
		 else
		 _EDICOLA_PRODUCTS_DETAILS = new Array();
		 */
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + /*JSON.stringify(*/p_response/*)*/);
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if (_PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {
							/*
							 // icona small webpage
							 var pbox_icon_webpage = document.createElement('div');
							 pbox_icon.appendChild(pbox_icon_webpage);
							 pbox_icon_webpage.className = 'edicola_prodotto_box_icon_webpage';
							 pbox_icon_webpage = null;
							 */

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}
					/*
					 // aggiungo prodotti vuoti per completare la riga verticale
					 if (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_V != 0) {
					 for (var i = 0; i < _EDICOLA_PRODUCTS_INLINE_V - (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_V); i++) {
					 var pbox = document.createElement('div');
					 if (_EDICOLA_CATALOGO_SMALL) {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small edicola_prodotto_box_fake_v';
					 }
					 else {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_fake_v';
					 }
					 l_edicola_container.appendChild(pbox);

					 var pbox_container = document.createElement('div');
					 pbox.appendChild(pbox_container);
					 pbox_container.className = 'edicola_prodotto_box_container';

					 pbox_container = null;
					 pbox = null;
					 }
					 }
					 // aggiungo prodotti vuoti per completare la riga orizzontale
					 if (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_H != 0) {
					 for (var i = 0; i < _EDICOLA_PRODUCTS_INLINE_H - (_EDICOLA_PRODUCTS_COUNT % _EDICOLA_PRODUCTS_INLINE_H); i++) {
					 var pbox = document.createElement('div');
					 if (_EDICOLA_CATALOGO_SMALL) {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small  edicola_prodotto_box_fake_h';
					 }
					 else {
					 pbox.className = 'edicola_prodotto_box edicola_prodotto_box_fake_h';
					 }
					 l_edicola_container.appendChild(pbox);

					 var pbox_container = document.createElement('div');
					 pbox.appendChild(pbox_container);
					 pbox_container.className = 'edicola_prodotto_box_container';

					 pbox_container = null;
					 pbox = null;
					 }
					 }
					 */

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});

	} catch (exc) {
		_EDICOLA_LAST_PRODUCT_LOAD = null;
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}

}

/**
 * Inizializza il controllo per l'aggiornamento dei prodotti attivando un flag per l'aggiornamento dei dati quando l'utente clicca sul pulsante edicola della barra menu
 */
function initCheckProducts() {
	console.log("initCheckProducts");
	/*
	 setInterval(function(){
	 _EDICOLA_REFRESH_PRODUCTS = true;
	 }, _INTERVALLO_CHECK_PRODUCTS);
	 */
}

function updateEdicolaProductsIscroll() {
	try {
		var pboxes = document.getElementById('edicola_container').getElementsByClassName('edicola_prodotto_box');

		if ((pboxes.length == 0) || (_EDICOLA_PRODUCTS_COUNT == 0)) {
			// nessun prodotto
			$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
			$('#edicola_container').height(0);
		} else {
			if (_EDICOLA_CATALOGO_SMALL) {
				// prodotti disponibili
				if (_ORIENTATION == 'V') {
					$('#edicola_container').height( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').height() : (_ORIENTATION == 'V' ? '100%' : '100%'));
					//$('#edicola_container').height($(pboxes[0]).outerHeight(true) * Math.ceil(_EDICOLA_PRODUCTS_COUNT / (_EDICOLA_CATALOGO_SMALL ? 1 : (_ORIENTATION == 'V' ? _EDICOLA_PRODUCTS_INLINE_V : _EDICOLA_PRODUCTS_INLINE_H))));
					$('#edicola_container').width($(pboxes[0]).outerWidth(true) * pboxes.length);
					//alert($('#edicola_container').height()+','+pboxes.length);
				} else {
					$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
					$('#edicola_container').height(($(pboxes[0]).outerHeight(true) * pboxes.length) + 40);
				}
			} else {
				$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
				//$('#edicola_container').height($(pboxes[0]).outerHeight(true) * Math.ceil(_EDICOLA_PRODUCTS_COUNT / (_EDICOLA_CATALOGO_SMALL ? 1 : (_ORIENTATION == 'V' ? _EDICOLA_PRODUCTS_INLINE_V : _EDICOLA_PRODUCTS_INLINE_H))));
				$('#edicola_container').height($(pboxes[0]).outerHeight(true) * Math.ceil(_EDICOLA_PRODUCTS_COUNT / ( _EDICOLA_CATALOGO_SMALL ? 1 : (_ORIENTATION == 'V' ? _EDICOLA_PRODUCTS_INLINE_V : _EDICOLA_PRODUCTS_INLINE_H))));
				//alert($('#edicola_container').height()+','+pboxes.length);

			}
		}
		if (_EDICOLA_PRODUCTS_ISCROLL == null) {
			// creo iscroll
			/*
			 _EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
			 hideScrollbar: false
			 });
			 */
			console.log("edicola_wrapper is " + $('#edicola_wrapper'));
			_EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
				bounce : false
			});

		} else {
			console.log("refresh scroll products");
			// aggiorno iscroll
			_EDICOLA_PRODUCTS_ISCROLL.refresh();
		}

		if (_EDICOLA_DESCR_ISCROLL != null) {
			console.log("refresh scroll descr")
			_EDICOLA_DESCR_ISCROLL.refresh();
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

var _PRODUCT_DETAILS_COVERFLOW = null;
function openProductDetails(productId) {
	console.log("openProductDetails " + productId);
	if (_EDICOLA_PRODUCTS_DETAILS[productId] == null)
		return;

	$('#edicola_prodotto').attr('class', 'edicola_prodotto_type_' + _EDICOLA_PRODUCTS_DETAILS[productId].type);

	$('.edicola_prodotto_box_icon').removeClass('edicola_prodotto_box_icon_selected');
	$('#edicola_prodotto_box_icon_' + productId).addClass('edicola_prodotto_box_icon_selected');
	if (!_EDICOLA_CATALOGO_SMALL) {
		edicolaCatalogoSwitchView();
	}

	if (_PRODUCT_DETAILS_COVERFLOW != null) {
		_PRODUCT_DETAILS_COVERFLOW.destroy();
		_PRODUCT_DETAILS_COVERFLOW = null;
	}

	$('#edicola_prodotto').hide();

	// elimino prodotto precedente
	$('#edicola_prodotto_titolo_content').empty();
	$('#edicola_prodotto_coverflow_box').empty();
	$('#edicola_prodotto_btns').empty();
	//$('#edicola_prodotto_descr').empty();
	$('#edicola_prodotto_descr_container').empty();
	$('#edicola_prodotto_adv_content').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> getProductDetails(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> getProductDetails(' + productId + ')');
			console.log('--RESP--> getProductDetails ' + JSON.stringify(p_response));

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				openProductDetails(productId);
			})) {
				//try{
				console.log("OK response openProductDetails " + /*JSON.stringify(*/
				p_response.Result.res/*)*/);
				//var risposta="{\"productName\":\"Il Sole 24 Ore\",\"productId\":\"a1\",\"productDescription\":\"Il Sole 24 ORE è il più autorevole strumento di informazione economica in Italia. Un resoconto chiaro e completo dei fatti che contano. Un aiuto insostituibile per orientarsi nel complesso mondo della finanza, delle normative e dei mercati economici mondiali. Il Sole 24 ORE: l'informazione va oltre il quotidiano!\",\"subscription\":true,\"free\":false,\"singleOffers\":[{\"offerId\":\"QUOTIDIANOSINGOLO\",\"offerDescription\":\"copia singola\",\"offerPrice\":1.59,\"offerItunesProductId\":\"MOBAPP_S24_SINGLE_S24_20120720\"}],\"testata\":\"S24\",\"showarchivio\":\"1\",\"editionId\":\"20120720\",\"editionDescription\":\"20 Luglio 2012\",\"pubDate\":\"20120720\",\"inserts\":[{\"description\":\"Il Sole 24 Ore\",\"insertId\":\"SOLE\",\"cover\":\"http://212.45.97.204/_deploy/S24/20120720/SOLE/cover_high.jpg\",\"anteprima\":0}],\"single\":true,\"demo\":false,\"editionTitle\":\"venerdì 20 luglio 2012\",\"subscriptionOffers\":[{\"offerId\":\"QOL_CANONE_7GG\",\"offerDescription\":\"alla settimana\",\"offerPrice\":9.99,\"offerItunesProductId\":\"http://shopping24.dlv.24orepro.in.ilsole24ore.it/sh4/mobile/android/addToCart.jsp?url_catalog_ref_id=sku1790109&url_product_id=prod1250025\"},{\"offerId\":\"QOL_ABBONAMENTO_MENSILE_PAG\",\"offerDescription\":\"all'anno mensilizzato\",\"offerPrice\":31.99,\"offerItunesProductId\":\"url1\"},{\"offerId\":\"QOL_CANONE_30GG\",\"offerDescription\":\"al mese\",\"offerPrice\":34.99,\"offerItunesProductId\":\"url2\"},{\"offerId\":\"QOL_ABBONAMENTO_ANNUALE_PAG\",\"offerDescription\":\"all'anno\",\"offerPrice\":319.99,\"offerItunesProductId\":\"url3\"}],\"serviceName\":\"products\",\"elapsedTime\":9}";
				schedaProdotto(p_response.Result.res);
				//schedaProdotto($.parseJSON(risposta));
				$('#edicola_prodotto').fadeIn();
				loadAdvCatalogo(productId);
				loadAdvTabbar(productId);
				window.product.setProduct(productId);
				//}catch(exc){
				//alert(exc.message);
				//}
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}

			//}catch(exc){
			//alert(exc.message);
			//}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

	//carico link store android
	loadlink(productId);
}

//carico i link dello store per gli offerItunesProductId
function loadlink(productId) {
	console.log("loadlink " + productId);

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> loadlink(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/links/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			//console.log('--RESP--> url_loadlink ' +  _SOLEGW_ENDPOINT + "products/links/" + productId + ".json?appKey="+_API24_APPKEY);
			console.log('--RESP--> loadlink(' + productId + ')');
			console.log('--RESP--> loadlink ' + p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				loadlink(productId);
			})) {
				//try{
				console.log("OK response loadlink "/*+JSON.stringify(p_response)*/);
				loadLinkProdotto(p_response.Result.res);
				//}catch(exc){
				//alert(exc.message);
				//}
			} else {
				console.log('Si è verificato un errore nella comunicazione con il server');
			}

			//}catch(exc){
			//alert(exc.message);
			//}
		},
		error : function() {
			console.log('Si è verificato un errore nella comunicazione con il server');
		}
	});

}

// Si popola _PRODUCTLINK per l'acquisto
_PRODUCTLINK = [];
function loadLinkProdotto(p_product) {
	console.log("loadLinkProdotto " + p_product.storeLinkItemsList.length + ',' + JSON.stringify(p_product.storeLinkItemsList));
	for (var i = 0; i < p_product.storeLinkItemsList.length; i++) {
		_PRODUCTLINK[i] = {};
		//name
		_PRODUCTLINK[i]['name'] = p_product.storeLinkItemsList[i]['name'];
		//url
		_PRODUCTLINK[i]['url'] = p_product.storeLinkItemsList[i]['url'];
		//productId
		_PRODUCTLINK[i]['productId'] = p_product.storeLinkItemsList[i]['productId'];
		//linkType
		_PRODUCTLINK[i]['linkType'] = p_product.storeLinkItemsList[i]['linkType'];
	}

	console.log("_PRODUCTLINK is  len ::: " + _PRODUCTLINK.length + " :::");
	console.log("_PRODUCTLINK[linkType] is " + ((_PRODUCTLINK) ? _PRODUCTLINK[0]['linkType'] : ""));
}

/**
 * Aggiorna la scheda del prodotto se necessario
 */
function refreshProductDetails() {
	if ((_EDICOLA_CATALOGO_SMALL == true) && (_PRODUCT_IN_EDICOLA != null)) {
		schedaProdotto(_PRODUCT_IN_EDICOLA);
	}
}

/**
 * Crea la scheda del prodotto
 */
//var _EDICOLA_DESCR_ISCROLL = null;
function schedaProdotto(p_product) {
	try {

		console.log("openProductDetails p_product is " + p_product + ',' + p_product.productId);

		if (_PRODUCT_DETAILS_COVERFLOW != null) {
			_PRODUCT_DETAILS_COVERFLOW.destroy();
			_PRODUCT_DETAILS_COVERFLOW = null;
		}
		$('#edicola_prodotto_titolo_content').empty();
		$('#edicola_prodotto_coverflow_box').empty();
		$('#edicola_prodotto_btns').empty();
		$('#edicola_prodotto_descr_container').empty();
		$('#edicola_prodotto_adv_content').empty();

		_PRODUCT_IN_EDICOLA = p_product;

		_HASH_MAP_TESTATA_PRODUCTID[p_product.testata] = p_product.productId;

		_MAP_CODICE_TESTATA[p_product.productId + ''] = p_product.testata;
		/* funzione non usata, messa direttamente nel codice più sotto in questa funzione
		function creaPulsanteAcquistoSingolo(p_offerta){
		$('<button class="button red24 prodotto_dettaglio_acquisto">' + p_offerta.offerPrice + ' €</button>').click(function(){
		acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId);
		}).appendTo('#edicola_prodotto_btns');
		}
		*/
		// titolo
		$('#edicola_prodotto_titolo_content').empty();
		$('<h1>' + p_product.productName + '</h1>').appendTo('#edicola_prodotto_titolo_content');
		$('<h2>' + (p_product.editionDescription != null ? 'Edizione del ' + p_product.editionDescription : '') + '</h2>').appendTo('#edicola_prodotto_titolo_content');

		// Coverflow
		$('#edicola_prodotto_coverflow_box').empty();
		var l_covers_list = [];
		var l_num_covers = p_product.inserts.length;
		for (var i = 0; i < l_num_covers; i++) {
			l_covers_list[i] = {
				'src' : p_product.inserts[i].cover,
				'code' : p_product.inserts[i].insertId,
				'description' : p_product.inserts[i].description,
				'anteprima' : p_product.inserts[i].anteprima && (parseInt(p_product.inserts[i].anteprima) > 0) && !(p_product.free || p_product.subscription),
				'abbonati' : p_product.inserts[i].premium && (parseInt(p_product.inserts[i].premium) > 0)
			}
		}
		_PRODUCT_DETAILS_COVERFLOW = new CoveerFlow('edicola_prodotto_coverflow_box', l_covers_list);

		console.log("_PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);

		// bottoni
		$('#edicola_prodotto_btns').empty();
		if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "store") {
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '" ><img src="imgs/edicola_catalogo_appstore_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				window.location = _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'];
			}
		} else if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "webpage") {
			//$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&deviceName=' + encodeURIComponent(device.name) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" class="button red24" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
		} else {
			// metto possibilità di tappare dirrettamente sulla cover dell'inserto
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				console.log('TAP ON COVERFLOW: ' + p_product.testata + ' ' + p_product.editionId + ' ' + p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				tapOnAnInsert(p_product);
			}
			// nascondo i bottoni, vengono mostrati quando si sa se è sfoglia o acquisto copia singola
			$('#edicola_prodotto_btns').css('display', 'none');

			console.log('verifica is ' + p_product.productId + ',' + p_product.subscriptionOffers.length + ',' + (p_product.subscriptionOffers && p_product.subscriptionOffers.length));

			// Se ci sono delle offerte
			if (p_product.subscriptionOffers && p_product.subscriptionOffers.length) {
				$('<button class="button medium red24 prodotto_dettaglio_abbonamenti">Abbonamenti</button>').click(function() {
					popupAcquistoAbbonamenti(p_product);
				}).appendTo('#edicola_prodotto_btns');

				for (var i = 0; i < p_product.subscriptionOffers.length; i++) {
					//appstoreReqProduct(p_product.subscriptionOffers[i].offerId, p_product.subscriptionOffers[i].offerItunesProductId)
				}
			}

			// Se c'è la possibilità di acquistare solo un numero viene aggiunto il pulsante per l'acquisto della singola copia
			console.log('productsingle is ' + JSON.stringify(p_product.single));
			if (p_product.single) {
				//for (var i = 0; i < p_product.singleOffers.length; i++) {
				for (var i = 0; i < p_product.singleOffers.length; i++) {
					//creaPulsanteAcquistoSingolo(p_product.singleOffers[i]);
					//$('<button class="button red24 prodotto_dettaglio_acquisto">' + p_product.singleOffers[i].offerPrice + ' €</button>').click(function(){
					$('<button class="button medium red24 prodotto_dettaglio_acquisto">' + ab_euro_formatter(p_product.singleOffers[i].offerPrice) + '</button>').click(function() {

						if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
							mostraPopupInsertoAbbonati();
						} else {
							acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);
						}

					}).appendTo('#edicola_prodotto_btns');

					//appstoreReqProduct(p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);

					break;
					// <--- visualizzo una sola offerta
				}
			}

			//appstoreReqProducts();

			$('<button class="button medium red24 prodotto_dettaglio_sfoglia">Sfoglia</button>').click(function() {
				var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);
				if ((!p_product.subscription) && l_edizione_premium) {
					sfogliaCheckPremium(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				} else {
					sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				}
			}).appendTo('#edicola_prodotto_btns');

			$('<br />').appendTo('#edicola_prodotto_btns');

			// Consultabile
			/* tolto ---> viene fatto da checkLocalProductForBtnsRender
			checkLocalProduct(p_product);
			_PRODUCT_DETAILS_COVERFLOW.on_end = function(){
			checkLocalProduct(p_product)
			};
			*/
			// Archivio
			$('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" width="15" height="14" /> Consulta l\'archivio</button>').click(function() {
				console.log("CLICK CONSULTA ARCHIVIO");
				//archivio standard al momento non utilizzato
				if (p_product.productId == _CODICE_PRODOTTO_QUOTIDIANO/*'3'*/) {//CORRETTO????
					// chiamata per aprire archivio STANDARD
					qarchivioOpen(p_product.productId);
				} else {
					// chiamata per aprire archivio QUOTIDIANO
					console.log('archivioOpen p_product.productId' + p_product.productId);
					archivioOpen(p_product.productId);
				}
			}).appendTo('#edicola_prodotto_btns');

			//alert('aaaaa'+$('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archivio_white.png" width="15" height="14" /> Consulta l\'archivio</button>').text());
			var consultaBtn = $('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" width="15" height="14" /> Consulta l\'archivio</button>');
			//alert($(consultaBtn).text());
			/*
			 consultaBtn.addEventListener("touchstart", function(e){
			 e.preventDefault();
			 alert(this);
			 }, false);
			 */

			checkLocalProductForBtnsRender(p_product);
			console.log(" _PRODUCT_DETAILS_COVERFLOW");
		}

		// Descrizione prodotto
		if (_EDICOLA_DESCR_ISCROLL != null) {
			_EDICOLA_DESCR_ISCROLL.destroy();
			_EDICOLA_DESCR_ISCROLL = null;
		}

		$('#edicola_prodotto_descr_container').empty();
		console.log("descr " + p_product.productDescription);
		//alert("descr "+p_product.productDescription);
		$('<p>' + p_product.productDescription + '</p>').appendTo('#edicola_prodotto_descr_container');
		//alert("aaa "+ document.getElementById('edicola_prodotto_descr').hasChildNodes()  + ',' + eval(document.getElementById('edicola_prodotto_descr_container')) );//document.getElementById('appmenu_inbox_count');
		/*
		if(!document.getElementById('edicola_prodotto_descr').hasChildNodes()){
		var $newdiv1 = $('<div id="edicola_prodotto_descr_container"/>'),
		newdiv2 = document.createElement('div'),
		existingdiv1 = document.getElementById('edicola_prodotto_descr');

		$('body').append($newdiv1, [newdiv2, existingdiv1]);

		}
		if(document.getElementById('edicola_prodotto_descr_container')!=null || document.getElementById('edicola_prodotto_descr_container')!=undefined)
		$('<p>' + p_product.productDescription + '</p>').appendTo('#edicola_prodotto_descr_container');
		alert("aaa "+ document.getElementById('edicola_prodotto_descr').hasChildNodes()  + ',' + document.getElementById('edicola_prodotto_descr_container').innerHTML );//document.getElementById('appmenu_inbox_count');
		//$('#edicola_prodotto_descr').
		*/
		/*
		if (p_product.productId == "1") {
		// Il Sole 24 Ore
		$("<p>Il Sole 24 ORE è il più autorevole strumento di informazione economica in Italia. Un resoconto chiaro e completo dei fatti che contano. Un aiuto insostituibile per orientarsi nel complesso mondo della finanza, delle normative e dei mercati economici mondiali. Il Sole 24 ORE: l'informazione va oltre il quotidiano!</p>").appendTo('#edicola_prodotto_descr_container');
		}
		else
		if (p_product.productId == "2") {
		// La Vita Nòva
		$("<p>La Vita Nòva</p>").appendTo('#edicola_prodotto_descr_container');
		}
		else
		if (p_product.productId == "9999") {
		// Conversione crediti
		$("<p>Gentile utente,<br />ti informiamo che in seguito all'aggiornamento dell'app non perderai il tuo attuale abbonamento e ti sarà inoltre concesso un bonus di estensione. Segui la procedura di registrazione indicata qui accanto e al termine consulta le impostazioni per verificare la durata del tuo nuovo abbonamento.<br /><br /><strong>Attenzione:</strong> se sei già utente del Sole 24 Ore online, sarà sufficiente inserire username e password con le quali accedi al sito www.ilsole24ore.com.</p>").appendTo('#edicola_prodotto_descr_container');
		}
		*/
		//console.log("edicola descr iscroll is " + $('#edicola_prodotto_descr') + "::: _EDICOLA_DESCR_ISCROLL "+_EDICOLA_DESCR_ISCROLL);
		//console.log("1edicola descr iscroll is " + $('#edicola_prodotto_descr_container').html());
		if (_EDICOLA_DESCR_ISCROLL == null) {
			setTimeout(function() {
				_EDICOLA_DESCR_ISCROLL.refresh();
			}, 100);
			//console.log("1edicolaSSSSSSSasd "+$('#edicola_prodotto_descr_container').outerHeight());
			_EDICOLA_DESCR_ISCROLL = new iScroll('edicola_prodotto_descr', {
				hScroll : false,
				vScroll : true,
				hScrollbar : false,
				bounce : false
			});
			//_EDICOLA_DESCR_ISCROLL.refresh();
		}
		console.log("2edicola descr iscroll is " + $('#edicola_prodotto_descr_container').html() + "::: _EDICOLA_DESCR_ISCROLL " + _EDICOLA_DESCR_ISCROLL);
		//alert("aaa "+ $('#edicola_prodotto_descr_container').html() );
		omnitureTrackApp('APP:edicola:loadProduct:' + p_product.productId, 'APP:edicola');

		console.log(" _PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);
	} catch (exc) {
		console.log(exc.message);
		//alert(exc.message);
	}
}

function checkLocalProductForBtnsRender(p_product) {
	try {
		var l_testata = p_product.testata;
		var l_issue = p_product.editionId;
		var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

		if (_DB) {
			/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
			var querySuccess = function(tx, p_results) {
				//alert('asd ' + JSON.stringify(p_results.rows));
				var len = p_results.rows.length;
				//console.log("checkLocalProductForBtnsRender: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);
				if ((len > 0) || p_product.free || p_product.subscription) {
					// solo bottone sfoglia
					$('#edicola_prodotto_btns .prodotto_dettaglio_acquisto').css('display', 'none');
					/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
					$('.coveerflow_anteprima').css('display', 'none');
					//alert('aaa_sed' + p_product.free +','+ p_product.subscription );
				} else {
					// acquisto copia singola
					$('#edicola_prodotto_btns .prodotto_dettaglio_sfoglia').css('display', 'none');
					$('.coveerflow_anteprima').css('display', 'inline-block');
				}

				$('#edicola_prodotto_btns').css('display', 'inline-block');
			}
			var queryError = function(p_error) {
				console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	} catch(exc) {
		console.log(exc.message);
	}
}

function mostraPopupInsertoAbbonati() {
	abutils.alert('Per poter leggere questo inserto devi essere abbonato.', 'Inserto per abbonati');
}

function sfogliaCheckPremium(p_testata, p_issue, p_edizione) {
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			if (len > 0) {
				sfoglia(p_testata, p_issue, p_edizione);
			} else {
				mostraPopupInsertoAbbonati();
			}
		}
		var queryError = function(p_error) {
			sfoglia(p_testata, p_issue, p_edizione);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [p_testata, p_issue, p_edizione], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function tapOnAnInsert(p_product) {
	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// se la issue è gratuita o è coperta da abbonamento...
			if (p_product.free || p_product.subscription) {
				// si apre lo sfoglio...
				sfoglia(l_testata, l_issue, l_edizione);
			} else {
				// se la issue è presente in locale (o lo è uno dei suoi inserti)...
				if (len > 0) {
					// controllo se è in locale proprio questa issue
					_DB.transaction(function(tx) {
						tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], function(tx, p_results) {
							var len = p_results.rows.length;
							if (len > 0) {
								// la copia è in locale
								sfoglia(l_testata, l_issue, l_edizione);
							} else {
								// la copia non è ancora in locale
								if (l_edizione_premium) {
									mostraPopupInsertoAbbonati();
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							}
						}, function() {
							sfoglia(l_testata, l_issue, l_edizione);
						});
					}, function() {
						sfoglia(l_testata, l_issue, l_edizione);
					});
					/*
					 if ((!p_product.subscription) && l_edizione_premium) {
					 sfogliaCheckPremium(l_testata, l_issue, l_edizione);
					 } else {
					 sfoglia(l_testata, l_issue, l_edizione);
					 }
					 */
				} else {
					// se è disponibile l'anteprima
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima) > 0)) {
						// apro l'anteprima
						openAnteprima(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima));
					} else {
						// altrimenti se sono presenti degli abbonamenti ...
						if (p_product.subscriptionOffers.length) {
							// si aprono le offerte commerciali ...
							popupAcquistoAbbonamenti(p_product);
						} else {
							// altrimenti se è presente la possibilità di acquisto come copia singola ...
							if (p_product.single && (p_product.singleOffers.length > 0)) {
								// si passa all'acquisto della copia singola ...
								if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
									mostraPopupInsertoAbbonati();
								} else {
									acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[0].offerId, p_product.singleOffers[0].offerItunesProductId);
								}
							} else {
								// niente da fare...
							}
						}
					}
				}
			}
		}
		var queryError = function(p_error) {

		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

// DA CAMBIAREEEEEEEEEEEEEEEEEEEEEEEEEE***************************************
function openAnteprima(p_testata, p_issue, p_edizione, p_anteprima) {
	//openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
	console.log('anteprimaaaa');
	openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
}

function sfoglia(p_testata, p_issue, p_edizione, p_pagina) {
	if (lockDoubleTap) {console.log('lockDoubleTap '+lockDoubleTap); return;}
	lockDoubleTap = true;
	//alert("Sfoglia testata: " + p_testata + " issue: " + p_issue+ " edizione: " + p_edizione);
	//openFlipper(p_testata, p_issue, p_edizione);
	/*
	 navigator.notification.loadingStart({
	 'labelText': "",
	 'backgroundOpacity': 0.5,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 'verticalAlign': 0.5
	 });
	 */
	if ( typeof p_pagina == undefined || p_pagina == null) {
		p_pagina = '1';
	}
	console.log('pagina sfoglia ' + p_pagina);

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	//APRO LO SFOGLIO ANDROID
	try {
		//window.loader.launchSfogliatore("S24", "SOLE", "20111011", "Descrizione");
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		//alert("style: "+node.style.display);
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		//window.location = 'progress.html';
		//window.loader.launchSfogliatore(p_testata, p_edizione, p_issue, "Descrizione"+valoutput);
		console.log("sfoglia " + p_testata + "," + p_edizione + "," + p_issue + "," + "Descrizione" + window.localStorage.getItem(keyinput) + "," + "aaaa" + "," + null);
		if (p_pagina != '1')
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null, p_pagina);
		else
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null);
	} catch(exc) {
		//alert(exc.message);
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}

	//Chiude eventuali schermate aperte

	setTimeout(function() {
		archivioClose();
		qarchivioClose();
	}, 1500);
	
	setTimeout(function() { lockDoubleTap = false; }, 2000);
}

function scarica(p_testata, p_issue, p_edizione) {
	//alert("Scarica testata: " + p_testata + " issue: " + p_issue+ " edizione: " + p_edizione);
	//openFlipper(p_testata, p_issue, p_edizione);
	sfoglia(p_testata, p_issue, p_edizione);
}

function eliminaCopiaLocale(p_testata, p_issue, p_edizione) {
	if (lockDoubleTap) return;
	lockDoubleTap = true;
	//alert("Elimina copia locale testata: " + p_testata + " issue: " + p_issue+ " edizione: " + p_edizione);
	//navigator.notification.confirm('Sei sicuro?', function(button){
	window.simulatePG.confirm('Sei sicuro?', 'eliminaCopiaLocaleSucc(\'' + p_testata + '\',\'' + p_issue + '\',\'' + p_edizione + '\')', 'Cancellazione issue', 'Si,No');

	setTimeout(function() { lockDoubleTap = false; }, 2000);
}

/*
 function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes){
 //alert("TODO ACQUISTO testata: " + p_testata + " issue: " + p_issue + " edizione: " + p_edizione + " offerta: " + p_offerta);
 //appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione); });
 sfoglia(p_testata, p_issue, p_edizione);
 }*/

function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina, p_forceSkipOneshotCheck) {
	if (!p_forceSkipOneshotCheck)
		p_forceSkipOneshotCheck = false;
	if (false/*_ONESHOT_CHECK_REGISTRATO && !_USERNAME && !p_forceSkipOneshotCheck*/) {
		_NEXT_ACTION = function() {
			acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
		}
		popupAcquistoRegistrazione(p_testata);
	} else {
		acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
	}
}

var _CURRENT_FLIPPER_TESTATA = null;
var _CURRENT_FLIPPER_ISSUE = null;
var _CURRENT_FLIPPER_EDIZIONE = null;
var _CURRENT_FLIPPER_PAGINA = null;
function setFlipperCurrentState(p_testata, p_issue, p_edizione, p_pagina) {
	if (p_testata == null)
		console.log('setFlipperCurrentState null*4');
	else
		console.log('setFlipperCurrentState ' + p_testata + ' ' + p_issue + ' ' + p_edizione + ' ' + p_pagina);
	_CURRENT_FLIPPER_TESTATA = p_testata;
	_CURRENT_FLIPPER_ISSUE = p_issue;
	_CURRENT_FLIPPER_EDIZIONE = p_edizione;
	_CURRENT_FLIPPER_PAGINA = p_pagina;
}

function openFlipper(testata, issue, edizione, pagina, anteprima) {
	if (lockDoubleTap) return;
	lockDoubleTap = true;
	try {

		if (anteprima == null || anteprima == 0)
			anteprima = false;
		else
			anteprima = true;

		console.log("openflipper");
		var l_fast_loading = false;
		/*
		 navigator.notification.loadingStart({
		 'labelText': "",
		 'backgroundOpacity': 0.5,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 'verticalAlign': 0.5
		 });
		 */
		if ((testata == null) && (issue == null) && (edizione == null)) {
			/*
			 var l_local_storage_testata = window.localStorage.getItem("flipper24_sfoglio_testata");
			 var l_local_storage_issue = window.localStorage.getItem("flipper24_sfoglio_issue");
			 var l_local_storage_edizione = window.localStorage.getItem("flipper24_sfoglio_edizione");
			 if ((l_local_storage_testata != null) && (l_local_storage_issue != null) && (l_local_storage_edizione != null)) {
			 testata = l_local_storage_testata;
			 issue = l_local_storage_issue;
			 edizione = l_local_storage_edizione;
			 }
			 */
			testata = _CURRENT_FLIPPER_TESTATA;
			issue = _CURRENT_FLIPPER_ISSUE;
			edizione = _CURRENT_FLIPPER_EDIZIONE;
			pagina = _CURRENT_FLIPPER_PAGINA;
			l_fast_loading = true;
		}

		if ((testata == null) || (issue == null) || (edizione == null)) {
			return false;
		}

		if (pagina == null)
			pagina = 1;
		/*
		 navigator.notification.loadingStart({
		 'labelText': "",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);

		setTimeout(function() {

			/*
			 window.localStorage.setItem("flipper24_sfoglio_testata", testata);
			 window.localStorage.setItem("flipper24_sfoglio_issue", issue);
			 window.localStorage.setItem("flipper24_sfoglio_edizione", edizione);
			 */

			if (anteprima) {
				_CURRENT_FLIPPER_TESTATA = null;
				_CURRENT_FLIPPER_ISSUE = null;
				_CURRENT_FLIPPER_EDIZIONE = null;
				_CURRENT_FLIPPER_PAGINA = null;
			} else {
				_CURRENT_FLIPPER_TESTATA = testata;
				_CURRENT_FLIPPER_ISSUE = issue;
				_CURRENT_FLIPPER_EDIZIONE = edizione;
				_CURRENT_FLIPPER_PAGINA = pagina;
			}
			//PhoneGap.exec("DownloadManagerCommand.removeAllIssuesFromDownloadQueue");
			//removeToDownloadQueue(testata, edizione, issue);
			//PhoneGap.exec("Flipper24Command.openFlipper24", testata, edizione, issue, pagina, l_fast_loading ? "FAST" : "SLOW");
			//window.plugins.flipper24.openFlipper24(null, null, testata, edizione, issue, pagina, l_fast_loading ? "FAST" : "SLOW");
			var keyinput = "unread_message_sole";
			var valoutput = 0;

			var node = document.getElementById('appmenu_inbox_count');
			if (node.style.display == 'block' || node.style.display == 'inline-block') {
				valoutput = 1;
			} else {
				valoutput = 0;
			}

			if ( typeof (window.localStorage) != 'undefined') {
				window.localStorage.setItem(keyinput, valoutput);
			} else {
				throw "window.localStorage, not defined";
			}

			// VERIFICA****************************************
			removeToDownloadQueue(testata, edizione, issue);

			console.log(_CURRENT_FLIPPER_TESTATA + ',' + _CURRENT_FLIPPER_EDIZIONE + ',' + _CURRENT_FLIPPER_ISSUE + ',' + _CURRENT_FLIPPER_PAGINA);

			/*if(_CURRENT_FLIPPER_TESTATA!=null && _CURRENT_FLIPPER_EDIZIONE!=null &&_CURRENT_FLIPPER_ISSUE!=null &&_CURRENT_FLIPPER_PAGINA!=null ){
			 */
			if (!anteprima) {
				window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
			} else {
				console.log('anteprima launch');
				window.soledownloader.launchAnteprimaSfogliatore(testata, edizione, issue, "Descrizione" + valoutput, null, null);
			}
			//}
			//window.soledownloader.launchDownload(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione"+valoutput, ""+"aaaa",null);

			/*
			 setTimeout(function(){
			 window.go.to(_CURRENT_FLIPPER_PAGINA);
			 },1300);
			 */
			setTimeout(function() {
				//window.go.to(_CURRENT_FLIPPER_PAGINA);

				// chiudo eventuali schermate aperte
				qarchivioClose();
				archivioClose();
				popupAcquistoAbbonamentiClose();
				popupAcquistoRegistrazioneClose();

				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				omnitureTrackApp('APP:edicola:open:' + testata + ':' + issue + ':' + edizione + ( anteprima ? ':PREVIEW' : ''), 'APP:edicola');
				nielsenCall('SFOGLIATORE');
			}, 3000);

		}, 250);

		return true;
	} catch (exc) {
		console.log(exc.message);
		return false;
	}
	
	lockDoubleTap = false;
}

/*
 * Controlla se un prodotto sia stato scaricato in locale ed in caso abilita il pulsante Sfoglia
 * @params p_product Prodotto
 */
function checkLocalProduct(p_product) {

	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("checkLocalProduct: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);

			if (len) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				creaPulsanteSfoglia(p_product, false);
				// Se il prodotto/inserto è presente in locale avrò il pulsante sfoglia in grigio
			} else if (p_product.free || p_product.subscription) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				// Se il prodotto/inserto non è presente in locale il pulsante sfoglia sarà rosso
				creaPulsanteSfoglia(p_product, true);
			} else {
				// Vengono mostrati gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeIn(200);
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			//tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], querySuccess, queryError);
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function creaPulsanteSfoglia(p_product, p_red) {
	var l_pulsante = $('#edicola_prodotto_sfoglia_btn');

	if (!l_pulsante.length) {

		l_pulsante = $('<button id ="edicola_prodotto_sfoglia_btn" class="button">Sfoglia</button>');

		if (p_red) {
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.addClass('gray');
		}

		l_pulsante.click(function() {
			sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
		});

		l_pulsante.appendTo('#edicola_prodotto_btns');

	} else {
		if (p_red) {
			l_pulsante.removeClass('gray');
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.removeClass('red24');
			l_pulsante.addClass('gray');
		}
	}
}

var _EDICOLA_CATALOGO_SMALL = false;
function edicolaCatalogoSwitchView() {

	_EDICOLA_CATALOGO_SMALL = !_EDICOLA_CATALOGO_SMALL;

	if (!_EDICOLA_CATALOGO_SMALL) {
		// L'utente ha deciso di chiudere il dettaglio del prodotto
		$('.edicola_prodotto_box_icon_selected').removeClass('edicola_prodotto_box_icon_selected');
		_PRODUCT_IN_EDICOLA = null;
	}

	$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
	$('#edicola_container > .edicola_prodotto_box').toggleClass('edicola_prodotto_box_small');
	$('#edicola_wrapper').toggleClass('edicola_wrapper_small');
	setTimeout(function() {
		updateEdicolaProductsIscroll();
	}, 0);
	if (!_EDICOLA_CATALOGO_SMALL) {
		// visualizzazione estesa ---> singola colonna
	} else {
		// singola colonna ---> visualizzazione estesa

	}

	if (_EDICOLA_DESCR_ISCROLL != null && !_EDICOLA_CATALOGO_SMALL) {
		_EDICOLA_DESCR_ISCROLL.destroy();
		_EDICOLA_DESCR_ISCROLL = null;
	}

	/*
	 //scrolling automatico al prodotto tolto, per pochi prodotti presenti
	 setTimeout(function() {
	 if (_EDICOLA_PRODUCTS_ISCROLL != null) {
	 var selectediv = document.querySelector('div.edicola_prodotto_box_icon_selected');
	 if ((selectediv != null) && (selectediv.parentNode != null)) {
	 _EDICOLA_PRODUCTS_ISCROLL.scrollToElement('#' + selectediv.parentNode.id, 100);
	 }
	 }
	 }, 500);

	 */

}

/**
 * Filtra i prodotti in edicola.
 */
function edicolaFiltroProdotti() {
	var l_selected_option = $('#edicola_titolo_btn_select option:selected');

	if (l_selected_option.val() == '') {
		$('#edicola_container .edicola_prodotto_box').fadeIn(200);
	} else {
		$('#edicola_container .edicola_prodotto_box').not('.' + l_selected_option.val()).css('display', 'none');
		$('#edicola_container .edicola_prodotto_box.' + l_selected_option.val()).fadeIn(200);
	}
}

/* --------- gestione drag&drop catalogo ----------- */
/*var _EDICOLA_TOUCH_START_POS_X = 0;
 var _EDICOLA_TOUCH_START_X = 0;
 var _EDICOLA_TOUCH_MOVE_X = 0;
 var _EDICOLA_TOUCH_STARTED = false;
 var _EDICOLA_TOUCH_MOVED = false;*/
var _EDICOLA_TOUCH_START_POS_X = 0;
var _EDICOLA_TOUCH_START_POS_Y = 0;
var _EDICOLA_TOUCH_START_Y = 0;
var _EDICOLA_TOUCH_START_X = 0;
var _EDICOLA_TOUCH_MOVE_Y = 0;
var _EDICOLA_TOUCH_MOVE_X = 0;
var _EDICOLA_TOUCH_STARTED = false;
var _EDICOLA_TOUCH_MOVED = false;
function edicolaTouchStart(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_STARTED = true;
		_EDICOLA_TOUCH_MOVED = false;
		_EDICOLA_TOUCH_START_POS_X = $('#edicola_catalogo').offset().left;
		/*_EDICOLA_TOUCH_START_X = _event.clientX;*/
		_EDICOLA_TOUCH_START_POS_Y = $('#edicola_catalogo').offset().top;
		_EDICOLA_TOUCH_START_X = _event.clientX;
		_EDICOLA_TOUCH_START_Y = _event.clientY;

	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMove(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_X = _event.clientX;
		document.getElementById('edicola_catalogo').style.webkitTransition = '-webkit-transform .01s linear';
		document.getElementById('edicola_catalogo').style.webkitTransform = 'translate3d(' + Math.max(0, Math.min(_EDICOLA_TOUCH_START_POS_X + $('#edicola_wrapper').position().left, (_EDICOLA_TOUCH_START_POS_X + _EDICOLA_TOUCH_MOVE_X - _EDICOLA_TOUCH_START_X))) + 'px, 0px, 0)';
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMoveVertical(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_Y = _event.clientY;
		document.getElementById('edicola_catalogo').style.webkitTransition = '-webkit-transform .01s linear';
		document.getElementById('edicola_catalogo').style.webkitTransform = 'translate3d( 0px, ' + Math.min(0, _EDICOLA_TOUCH_START_POS_Y + _EDICOLA_TOUCH_MOVE_Y - _EDICOLA_TOUCH_START_Y) + 'px, 0)';
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchEnd(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		if (!_EDICOLA_TOUCH_MOVED)
			return;
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		_EDICOLA_TOUCH_STARTED = false;
		if ((_EDICOLA_TOUCH_START_X - _EDICOLA_TOUCH_MOVE_X > 200) || (_EDICOLA_TOUCH_START_Y - _EDICOLA_TOUCH_MOVE_Y > 200)) {
			document.getElementById('edicola_catalogo').style.webkitTransition = '';
			document.getElementById('edicola_catalogo').style.webkitTransform = '';
			edicolaCatalogoSwitchView();
		} else {
			document.getElementById('edicola_catalogo').style.webkitTransition = '';
			document.getElementById('edicola_catalogo').style.webkitTransform = '';
			edicolaCatalogoSwitchView();
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

/*
function edicolaTouchEnd(event){
try {
var _event = _HAS_TOUCH ? event.touches[0] : event;
if (!_EDICOLA_TOUCH_MOVED)
return;
if (!_EDICOLA_TOUCH_STARTED)
return;
_EDICOLA_TOUCH_STARTED = false;
if (_EDICOLA_TOUCH_START_X - _EDICOLA_TOUCH_MOVE_X > 200) {
document.getElementById('edicola_catalogo').style.webkitTransition = '';
document.getElementById('edicola_catalogo').style.webkitTransform = '';
edicolaCatalogoSwitchView();
}
else {
document.getElementById('edicola_catalogo').style.webkitTransition = '';
document.getElementById('edicola_catalogo').style.webkitTransform = '';
$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
}
}
catch (exc) {
console.log(exc.message);
}
}
*/

/******************************************************
 Gestione demo
 ******************************************************/
/**
 * Verifica che l'utente possa utilizzare la demo
 */
function verifyDemo() {
	console.log("---REQ---> verifyDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	} else {
		_NEXT_ACTION = verifyDemo;
		//popupAccediRegistrati();
		popupAcquistoRegistrazione();
		return;
	}

	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> verifyDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, verifyDemo)) {
				if (p_response.Result.res.canUseDemo == true)
					useDemo();
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
			/*
			 else {
			 console.log('Errore durante l\'utilizzo della prova demo');
			 }
			 */
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

/**
 * Utilizza la demo
 */
function useDemo() {
	console.log("---REQ---> useDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		'userIdentity' : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		'username' : _USERNAME
	}

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		dataType : "json",
		processData : false,
		data : JSON.stringify(l_req_data),
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('----> useDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, useDemo)) {
				//&& p_response.Result.res.canUseDemo == true
				sfoglia(_PRODUCT_IN_EDICOLA.testata, _PRODUCT_IN_EDICOLA.editionId, _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				omnitureTrackApp('APP:edicola:demo:' + _PRODUCT_IN_EDICOLA.testata + ':' + _PRODUCT_IN_EDICOLA.editionId + ':' + _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, 'APP:edicola');
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
			/*
			 else {
			 alert('Attenzione, errore durante l\'utilizzo della prova demo');
			 }
			 */
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

_ABBONAMENTI_ISCROLL = null;
/* --------- gestione schermata acquisto ----------------- */
function popupAcquistoAbbonamenti(p_product_detail) {
	//$('#acquisto_abbonamenti').fadeIn();
	// Definizione nome del prodotto
	//$('#acquisto_abbonamenti_body_prodotto').text(p_product_detail.productDescription);

	function creaPulsanteAbbonamento(p_offerta) {
		console.log("p_offerta is " + _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][0]['linkType'] + ',' + JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']) + ',' + JSON.stringify(p_product_detail) + '::' + JSON.stringify(p_offerta));
		var linkPulsante = '';
		for (var x = 0; x < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; x++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['name'] == p_offerta.offerId) {
				linkPulsante = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['linkType'];
			}
		}

		if (!linkPulsante) {
			//_PRODUCTLINK
			console.log(JSON.stringify(_PRODUCTLINK));
			for (var x = 0; x < _PRODUCTLINK.length; x++) {
				if (_PRODUCTLINK[x]['name'] == p_offerta.offerId) {
					linkPulsante = _PRODUCTLINK[x]['linkType'];
				}
				_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x] = _PRODUCTLINK[x];
			}

		}

		if (linkPulsante && linkPulsante.toString().indexOf('nolink') != -1) {
			//niente
		} else {
			$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
				popupAcquistoAbbonamentiClose();
				if (_USERNAME) {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /*|| p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
						//console.log("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
						popupRiepilogoApri(p_product_detail, p_offerta);
					} else {
						//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
						//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
						window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
						console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
					}
				} else {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					_NEXT_ACTION = function() {
						if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /* || p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							popupRiepilogoApri(p_product_detail, p_offerta);
						} else {
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
							window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
							console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
						}
					}
					popupAcquistoRegistrazione(p_offerta.offerId);
				}
			}).appendTo('#acquisto_abbonamenti_offerte');
		}
	}

	function creaPulsanteCopiaSingola(p_offerta) {
		$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
			//acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			//alert("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
			popupAcquistoAbbonamentiClose();
			acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			console.log("offerItunesProductId " + p_offerta.offerItunesProductId);

		}).appendTo('#acquisto_abbonamenti_offerte');
	}


	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_others').css('display', p_product_detail.testata == 'S24' ? 'none' : 'inline-block');
	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_s24').css('display', p_product_detail.testata == 'S24' ? 'inline-block' : 'none');
	if (p_product_detail.testata == 'S24') {
		$('#acquisto_abbonamenti_body_prodotto').html('Il Sole 24 Ore Versione Digitale');
	} else {
		$('#acquisto_abbonamenti_body_prodotto').html(p_product_detail.productName);
	}
	// Inserimento offerte
	$('#acquisto_abbonamenti_offerte').empty();

	var l_inserto_premium = p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (!l_inserto_premium) {
		for (var i = 0; i < p_product_detail.singleOffers.length; i++) {
			creaPulsanteCopiaSingola(p_product_detail.singleOffers[i]);
			break;
			// <-- una sola offerta singola
		}
	}

	for (var i = 0; i < p_product_detail.subscriptionOffers.length; i++) {
		creaPulsanteAbbonamento(p_product_detail.subscriptionOffers[i]);
	}
	// Demo prodotto
	if ((!l_inserto_premium) && p_product_detail.demo == true)
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'none');
	/* ---- inizio modifica ---- */
	if (_USERNAME == null)
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'none');
	/* ---- fine modifica ---- */

	// Viene mostrato il popup
	$('#acquisto_abbonamenti').css('display', 'inline');

	//$('#acquisto_abbonamenti_wrapper').height($('#acquisto_abbonamenti_content').height());

	if (_ABBONAMENTI_ISCROLL == null /*_ORIENTATION == 'H'*/ ) {
		_ABBONAMENTI_ISCROLL = new iScroll('acquisto_abbonamenti_wrapper', {
			bounce : false
		});
		_ABBONAMENTI_ISCROLL.refresh();
	} else {
		_ABBONAMENTI_ISCROLL.refresh();
	}
	/*
	 if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
	 IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper');
	 } else {
	 IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	 }*/

}

function popupAcquistoAbbonamentiClose() {
	//$('#acquisto_abbonamenti').fadeOut();
	$('#acquisto_abbonamenti').css('display', 'none');
}

var _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = null;
function popupAcquistoRegistrazione(p_testata) {
	console.log("REGISTRAZIONE" + p_testata);
	//-------INIZIO
	if (p_testata == 'S24') {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'none');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'block');
		document.getElementById('acquisto_registrazione_body').className = '';
	} else {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'block');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'none');
		document.getElementById('acquisto_registrazione_body').className = 'acquisto_registrazione_type_others';
	}
	//-------FINE
	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	if (_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is " + _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL);
}

function popupAcquistoRegistrazioneClose() {
	//$('#acquisto_registrazione').fadeOut();
	console.log("REGISTRAZIONE chiusa");
	$('#acquisto_registrazione').css('display', 'none');
}

function acquistoAbbonamento(abbonamento) {
	popupAcquistoRegistrazione();
}

function popupAcquistoRegistrazioneRegistrati() {
	console.log("REGISTRAZIONE 1");
	popupRegistrazioneApri();
}

function procediAcquistoAbbonamento(p_product, p_offerta, p_itunes) {
	var l_testata = p_product.testata;
	if (!l_testata)
		l_testata = 'S24';
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	//alert("acquistoAbbonamento testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + " offerta: " + p_offerta);
	// TODO: acquisto ---> sfoglio
	//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(l_testata, l_issue, l_edizione); });
}

function acquistoAbbonamentiAgganciaAbbonamento() {

	_NEXT_ACTION = acquistoAbbonamentiAgganciaAbbonamento_done;

	popupLogin();

}

function acquistoAbbonamentiAgganciaAbbonamento_done() {
	/*
	 navigator.notification.loadingStart({
	 'labelText': "Aggancio abbonamento...",
	 'backgroundOpacity': 0.8,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 });
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggancio abbonamento..."]);
	// controllo stato abbonamento

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + _PRODUCT_IN_EDICOLA.productId);
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription/' + _PRODUCT_IN_EDICOLA.productId);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				acquistoAbbonamentiAgganciaAbbonamento_done();
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					//if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}

				if (l_attivo) {

					acquistoAbbonamentiAgganciaAbbonamento_complete('Aggancio abbonamento completato. Il tuo abbonamento scade il ' + l_date_end.format('dd/mm/yyyy'));
				} else {
					acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
				}

			} else {
				acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
			}
		},
		error : function() {
			acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
		}
	});

}

function acquistoAbbonamentiAgganciaAbbonamento_complete(p_msg) {
	abutils.alert(p_msg, 'Aggancia abbonamento');

	// chiudo schermata abbonamenti
	popupAcquistoAbbonamentiClose();
	// ricarico dettaglio prodotto
	openProductDetails(_PRODUCT_IN_EDICOLA.productId);

	/*navigator.notification.loadingStop();*/
	window.simulatePG.exec(null, null, "Notification", "activityStop", []);
}

function acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina) {
	if (lockDoubleTap) return;
	lockDoubleTap = true;
	
	if (!p_pagina)
		p_pagina = 1;
	var l_productid = _HASH_MAP_TESTATA_PRODUCTID[p_testata];

	//alert('aaa '+l_productid);
	if (!l_productid) {
		//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione, p_pagina); });
		//BUY
		var link_singola = '';
		for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
				link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
			}
		}

		if (!link_singola || link_singola == '') {
			_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] = _PRODUCTLINK;
			for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
				}
			}
		}

		if (link_singola != '') {
			window.payment.paySingle(p_testata, p_issue, p_edizione, p_offerta, p_itunes, link_singola);
		} else {
			abutils.alert('Errore su link!', 'Pagamento');
		}

	} else
		checkAcquisto(l_productid, p_issue, p_edizione, p_offerta, p_itunes, function() {
			sfoglia(p_testata, p_issue, p_edizione, p_pagina);
		});
	//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione); });
	
	setTimeout(function() { lockDoubleTap = false; }, 2000);
}

/************************************************************/

var _PRODOTTO_PRINCIPALE_DEFAULT = {
	id : (_debugIPADContent) ? "1" : "a1",
	descr : "Il Sole 24 ORE"
};

var _DEVICE_SETTINGS = {
	platform : "2",
	appname : (_debugIPADContent) ? "ITQUOIPAD" : "ITQUOANDROID", // DA CAMBIARE!!! //ITQUOANDROID ITQUOIPAD
	appversion : (_debugIPADContent) ? "2.2" : "1.5" //da cambiare in a2.0 2.2 1.0
}

var _MAP_CODICE_TESTATA = (_debugIPADContent) ? {
	'1' : 'S24'
} : {
	'a1' : 'S24'
};
var _CODICE_PRODOTTO_QUOTIDIANO = (_debugIPADContent) ? '1' : 'a1';

function setUserData(p_username, p_password, p_useridentity) {
	console.log('setUserData ' + p_username + ' ' + p_password + ' ' + p_useridentity);
	if (p_username == null || p_password == null || p_useridentity == null) {
		deleteUsername();
		deletePassword();
		_USERNAME = null;
		_USER_PASSWORD = null;
		_USER_IDENTITY = null;
		//PhoneGap.exec('AppStore.setUserInfo');
		//window.plugins.appstore.setUserInfo();
	} else {
		storeUsername(p_username);
		storePassword(p_password);
		_USERNAME = p_username;
		_USER_PASSWORD = p_password;
		_USER_IDENTITY = p_useridentity;
		//PhoneGap.exec('AppStore.setUserInfo', _USERNAME, _USER_IDENTITY);
		//window.plugins.appstore.setUserInfo(null, null, _USERNAME, _USER_IDENTITY);
		//console.log('logging  '+p_username+','+p_password);
	}

	//console.log('setUserData2 ' + _USERNAME + ' ' + _USER_PASSWORD + ' ' + _USER_IDENTITY);
}

function applicationWillEnterForeground() {
	console.log('JS|applicationWillEnterForeground');
	return "OK";
}

function applicationDidEnterBackground() {
	console.log('JS|applicationDidEnterBackground');

	return "OK";
}

var ROTATION_CLASSES = {

	"0" : "none",

	"90" : "right",

	"-90" : "left",

	"180" : "flipped"

};

function monitorOrientationChanges() {
	console.log('monitorOrientationChanges!!!');

	var canDetect = "onorientationchange" in window;

	var orientationTimer = 0;

	$(window).bind( canDetect ? "orientationchange" : "resize", function(evt) {

		clearTimeout(orientationTimer);

		orientationTimer = setTimeout(function() {

			// given we can only really rely on width and height at this stage,

			// calculate the orientation based on aspect ratio

			var aspectRatio = 1;

			if (window.innerHeight !== 0) {

				aspectRatio = window.innerWidth / window.innerHeight;

			}// if

			// determine the orientation based on aspect ratio

			var orientation = aspectRatio <= 1 ? "portrait" : "landscape";

			// if the event type is an orientation change event, we can rely on

			// the orientation angle

			var rotationText = null;

			if (evt.type == "orientationchange") {

				rotationText = ROTATION_CLASSES[window.orientation.toString()];
				console.log('rotationText is ' + rotationText);

			}// if

			$(window).trigger("reorient", [orientation, rotationText]);

		}, 500);

	});

}// monitorOrientationChanges

function search() {
	window.searchlaunch.launch();
}

var CURRENT_ORIENTATION = '';
function onBodyLoad() {
	//alert('version 61');
	document.addEventListener("deviceready", onDeviceReady, false);
	//document.addEventListener("orientationChanged", updateOrientation, false);
	//window.addEventListener("orientationchange", updateOrientation, false);
	document.addEventListener("touchmove", function(e) {
		e.preventDefault();
	}, false);

	//alert("screenWidth " + screen.width + ", screenHeight " + screen.height + ", dpi " + window.devicePixelRatio);

	if (_DEBUG_MODE) {
		document.getElementById('edicola_catalogo_tiro').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
	} else {
		document.getElementById('edicola_catalogo_tiro').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_MOVE_EV, edicolaTouchMove, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);

		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_MOVE_EV, edicolaTouchMoveVertical, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);
	}

	/* inizializzazione componenti grafiche */
	GalaxyCheckboxStyle.init();

	/* inizializzazione componenti grafiche */
	if ($(".registrazione_body_group :checkbox").iphoneStyle != null)
		$(".registrazione_body_group :checkbox").iphoneStyle({
			checkedLabel : 'SI',
			uncheckedLabel : 'NO'
		});

	//console.log("PASSSS FS!!!!!");
	monitorOrientationChanges();

	$(window).bind("reorient", function(evt, orientation, rotation) {

		// display the details we have determine from the display

		//$("#orientation").html(orientation);

		//$("#rotation-class").html(rotation);

		if (CURRENT_ORIENTATION != orientation) {

			CURRENT_ORIENTATION = orientation;

			if (orientation == 'landscape')
				_ORIENTATION = 'H';
			else
				_ORIENTATION = 'V';

			console.log("bind _ORIENTATION is " + _ORIENTATION);

			updateOrientation();

		}

	});
	document.addEventListener("backbutton", backKeyDown, true);

	/*
	<option value="" selected="selected">Tutti i prodotti</option>
	<option value="edicola_non_in_appstore">Prodotti in-app</option>
	<option value="edicola_in_appstore">Prodotti app-store</option>*/
	//alert(window.innerWidth);

	if (window.innerWidth < 790 || window.innerWidth == 1024) {

		var widthBtn = (window.innerWidth == 1024) ? '180' : '100';
		dhx.ui({
			view : "richselect",
			id : "prodottiRichselect",
			container : 'edicola_titolo_btn',
			popupWidth : 180,
			label : '',
			width : widthBtn,
			value : '1',
			options : [{
				value : '1',
				label : "Tutti i prodotti"
			}, {
				value : 'edicola_non_in_appstore',
				label : "Prodotti in-app"
			}, {
				value : 'edicola_in_appstore',
				label : "Prodotti app-store"
			}]
		});

		$('#edicola_titolo_btn_select').hide();

		$("#edicola_titolo_btn .dhx_el_box").css({
			'border' : '1px solid #212121'
		});
		$("#edicola_titolo_btn .dhx_el_box").css({
			'-webkit-border-radius' : '4px'
		});

		$("#edicola_titolo_btn .dhx_inp_list").css({
			'font-weight' : 'bolder'
		});

		$("#edicola_titolo_btn .dhx_inp_list").css({
			'background' : 'none'
		});
		$("#edicola_titolo_btn .dhx_inp_list").css({
			'background-image' : 'none'
		});
		//$("#edicola_titolo_btn .dhx_view").css({'background' : '-webkit-gradient(linear, left top, left bottom, from(rgba(220,220,220,0.6)), color-stop(0.5, rgba(100,100,100,0.2)), color-stop(0.5, rgba(0,0,0,0.21)), to(rgba(0, 0, 0, 1.0)))'});
		$("#edicola_titolo_btn .dhx_inp_list").css({
			'background' : 'transparent -webkit-gradient(linear, left top, left bottom, color-stop(0%,#585757), color-stop(23%,#515151), color-stop(74%,#3c3b3b), color-stop(100%,#333333))'/*'transparent -webkit-gradient(linear, left top, left bottom, from(rgba(255,255,255,0.6)), color-stop(0.5, rgba(255,255,255,0.15)), color-stop(0.5, rgba(255,255,255,0.01)), to(transparent))'*/
		});
		$("#edicola_titolo_btn .dhx_el_box").css({
			'background' : 'transparent -webkit-gradient(linear, left top, left bottom, color-stop(0%,#585757), color-stop(23%,#515151), color-stop(74%,#3c3b3b), color-stop(100%,#333333))'/*' -webkit-gradient(linear, left top, left bottom, color-stop(0%,#8E8E8E), color-stop(14%,#787878), color-stop(32%,#666565), color-stop(80%,#464646), color-stop(100%,#373737))'*//*'transparent -webkit-gradient(linear, left top, left bottom, from(rgba(255,255,255,0.6)), color-stop(0.5, rgba(255,255,255,0.15)), color-stop(0.5, rgba(255,255,255,0.01)), to(transparent))'*/
		});

		$("#edicola_titolo_btn .dhx_inp_list").css({
			'color' : 'white'
		});

		$("#edicola_titolo_btn .dhx_view").css({
			'background-color' : 'transparent'
		});
		//	$("#edicola_titolo_btn .dhx_inp_list").css({'background-color': '#323131'/*'#6c6c6c'*/});
		//	$("#edicola_titolo_btn .dhx_el_box").css({'background-color': '#323131'/*'#6c6c6c'*/});
		/*
		 * <option value="" selected="selected">Tutti i prodotti</option>
		 <option value="edicola_non_in_appstore">Prodotti in-app</option>
		 <option value="edicola_in_appstore">Prodotti app-store</option>
		 * */

		$$('prodottiRichselect').attachEvent("onchange", function(newv, oldv) {
			setTimeout(function() {
				//alert(oldv+','+newv);
				if (oldv != newv) {

					$('#edicola_titolo_btn_select option:selected').removeAttr('selected');
					// $('#'+select_id+' option[value='+option_val+']').attr('selected','selected');
					//alert(parseInt(newv)-1);
					if (newv == '1') {
						$("#edicola_titolo_btn_select option[value='']").attr('selected', 'selected');
					} else {
						$("#edicola_titolo_btn_select option[value='" + newv + "']").attr('selected', 'selected');
					}

				}
				edicolaFiltroProdotti();
			}, 200);

		});
	}

	if (_DEBUG_MODE) {
		device = {// ATTENZIONE, dati impostati anche in onDeviceReady
			platform : _DEVICE_SETTINGS.platform,
			appname : _DEVICE_SETTINGS.appname,
			appversion : _DEVICE_SETTINGS.appversion,
			name : 'Il mio Safari ;)',
			uuid : '201111111115'
		}

		PhoneGap = {};
		PhoneGap.exec = function(successCB, errorCB, namespace, method) {
			console.log('PG ' + namespace + ' . ' + method);
		};
		PhoneGap.windowEventHandler = function() {
		};
		if (navigator == null) {
			console.log("create navigator");
			navigator = {};
		}
		if (navigator.notification == null)
			navigator.notification = {};
		if (navigator.notification.loadingStart == null)
			navigator.notification.loadingStart = function() {
				console.log('loadingStart');
			};
		if (navigator.notification.loadingStop == null)
			navigator.notification.loadingStop = function() {
				console.log('loadingStop');
			};

		if (!window.plugins)
			window.plugins = {};
		window.plugins.flipper24 = new PGFlipper24();
		//window.plugins.appstore = new PGAppStore();
		navigator.plugins.notificationEx = new NotificationEx();
		window.plugins.pgaleberutils = new PGAleBerUtils();

		onDeviceReadyDeviceInfo(null);
	}

	device = {
		uuid : null,
		version : null,
		platform : null,
		name : null,
		phonegap : null
	};

	if (!device.uuid) {
		//alert('sasa 0ok');
		device.uuid = window.simulateDevice.getUuid();
		device.version = window.simulateDevice.getOSVersion();
		device.platform = window.simulateDevice.getPlatform();
		device.name = window.simulateDevice.getProductName();
		device.phonegap = window.simulateDevice.getPhonegapVersion();
	}

}

function backKeyDown() {
	// ALERT sei sicuro, se si esegui finish()
	window.runfunc.askandrun('Sei sicuro di voler uscire?', '');
}

function onDeviceReady() {
	//document.addEventListener("orientationchange", updateOrientation, true);
	if (_API24TEST_SWITCH) {
		console.log('************* PUNTAMENTO AD AMBIENTE DI TEST ***********************');
		_API24_APPKEY = _API24TEST_APPKEY;
		_API24_SIGNATURE_KEY = _API24TEST_SIGNATURE_KEY;
		_API24_SITECODE = _API24TEST_SITECODE;
		_API24_ENDPOINT = _API24TEST_ENDPOINT;
		_SOLEGW_ENDPOINT = _SOLEGWTEST_ENDPOINT;
		_ADV_PROXY = _ADVTEST_PROXY;
	}

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Caricamento in corso..."]);
	//window.plugins.pgaleberutils.activityStart();
	//window.plugins.pgaleberutils.deviceExtraInfo(onDeviceReadyDeviceInfo,onDeviceReadyDeviceInfo);
	onDeviceReadyDeviceInfo(null);
}

function onDeviceReadyDeviceInfo(extraInfo) {
	//mod 03012013
	//inizializziamo l'uuid
	device.uuid = window.infodroid.getuuid();

	window.infodroid.setuuid(device.uuid);
	//**********************FINE**
	device.orig_uuid = device.uuid;
	if (extraInfo != null && extraInfo.deviceid != null)
		device.uuid = extraInfo.deviceid;

	device.appname = (extraInfo == null || extraInfo.appname == null) ? "---" : extraInfo.appname;
	device.appversion = (extraInfo == null || extraInfo.appversion == null) ? "---" : extraInfo.appversion;
	device.name = window.infodroid.getDevice();
	//DA CAMBIARE
	//device.usedspace = (extraInfo == null || extraInfo.usedspace == null) ? "---" : extraInfo.usedspace;
	//device.usedspaceperc = (extraInfo == null || extraInfo.usedspaceperc == null) ? "---" : extraInfo.usedspaceperc;
	device.usedspace = (window.infodroid == null ) ? "---" : window.infodroid.dirSize("/S24/");
	device.usedspaceperc = (window.infodroid == null ) ? "---" : window.infodroid.dirSizePerc("/S24/");

	/*  MOD 03012013
	if (navigator == null)
	navigator = {};
	if (navigator.fileMgr == null)
	navigator.fileMgr = {};
	if (navigator.fileMgr.libFolderPath == null)
	navigator.fileMgr.libFolderPath = (extraInfo == null || extraInfo.libFolderPath == null) ? "" : extraInfo.libFolderPath;

	if (navigator.notification == null)
	navigator.notification = {};
	if (navigator.notification.loadingStart == null)
	navigator.notification.loadingStart = navigator.plugins.notificationEx.loadingStart;
	if (navigator.notification.loadingStop == null)
	navigator.notification.loadingStop = navigator.plugins.notificationEx.loadingStop;
	*/

	// DA VERIFICARE!!! forzo il device.platform a 1
	device.platform = _DEVICE_SETTINGS.platform;
	device.appversion = _DEVICE_SETTINGS.appversion;
	device.appname = _DEVICE_SETTINGS.appname;

	console.log = function(msg) {
	};

	/* inizializzazione prodotto principale */
	var l_local_storage_prodotto_principale = window.localStorage.getItem("prodotto_principale_id");
	console.log('prodotto principale settato: ' + l_local_storage_prodotto_principale);
	if (l_local_storage_prodotto_principale == null) {
		window.localStorage.setItem("prodotto_principale_id", _PRODOTTO_PRINCIPALE_DEFAULT.id);
		window.localStorage.setItem("prodotto_principale_descr", _PRODOTTO_PRINCIPALE_DEFAULT.descr);
	}

	// non piu' usato, ma può essere lasciato: all'avvio viene lasciata accesa l'edicola dello sfoglio, per forzare il loading di entrambe le immagini
	// qui viene ripristinata l'icona dell'edicola, e tolta quella dello sfoglio
	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');

	// setta il valore di _ORIENTATION
	initOrientation();

	// apertura db
	inizializzaDatabase();

	// controllo username
	controlloUsername();
}

function onDeviceReady_aux() {// viene richiamato da dentro controlloUsername()
	// carico prodotti
	//loadProducts(); <--- viene fatto dal controllo offline/online

	// inizializza timer per fare in modo che il reload del catalogo prodotti avvega ogni _INTERVALLO_CHECK_PRODUCTS ms
	initCheckProducts();

	//Controlla lo stato online/offline
	initCheckOnline();

	downloadManagerDBinit();

	inboxLoadMessages();
	//$('#splashscreen').fadeOut(1000);

	loadAdvTabbar();
	loadAdvCatalogo();

	setTimeout(function() {
		//$('#splashscreen').css('display', 'none');
		//window.plugins.pgaleberutils.activityStop();
		//window.plugins.pgaleberutils.splashScreenHide();
		//navigator.notification.loadingStop();
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		if (_API24TEST_SWITCH) {
			abutils.alert('Stai utilizzando l\'ambiente di test...');
		}
	}, 3000);
}

function loadAdvTabbar(product_id) {
	//alert("CALL ME!!!");
	//document.getElementById('advtabbar_close').style.display = 'none';
	document.getElementById('advtabbar_close_content').innerHTML = '';
	//$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){

	console.log(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);

	$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
		/*
		 setTimeout(function() {
		 var ret = false;
		 try {

		 var imgs = document.getElementById('advtabbar_close_content').getElementsByTagName('img');
		 if(imgs != null || imgs.length >= 0) {
		 for(var i = 0; i < imgs.length; i++) {
		 if(parseInt(imgs[i].height) > 10) {
		 ret = true;
		 }
		 }
		 }

		 } catch(exc) {
		 ret = false;
		 }

		 if (ret) {
		 $('#advtabbar_close').fadeIn();
		 }

		 }, 100);
		 */
	}).endCapture();
	document.getElementById('advtabbar_open_content').innerHTML = '';
	console.log(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);
	//$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
	$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
	}).endCapture();

}

var _TABBAR_ADV_IS_OPEN = false;
function handleAdvTabbarClick() {
	var _width_close = $('#advtabbar_close_content img').first().width();
	// evita di aprire il contenuto se non c'è nulla caricato
	if ((_width_close == null) || (_width_close < 5))
		return;
	//alert("CALL ME1!!!");
	_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
	document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
	document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
}

function loadAdvCatalogo(product_id) {
	//alert("CALL ME2!!!");
	document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
	//$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
	$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
	}).endCapture();
}

/**
 * Ottiene la signature per richiedere le informazioni al server API24
 * @params p_request_params Stringa contenente i parametri utili per la creazione della signature.
 * @see Doc_API24_vX.doc per maggiori info.
 */
function getSignature(p_request_params) {
	return Crypto.HMAC(Crypto.SHA1, p_request_params, _API24_SIGNATURE_KEY).toUpperCase();
}

var _ORIENTATION = '';
function initOrientation() {
	console.log('********init_Orientation********');
	/*
	 if(window.innerWidth > 790){
	 if (window.innerWidth > 900)
	 _ORIENTATION = 'H';
	 else
	 _ORIENTATION = 'V';
	 }else{
	 if (window.innerWidth > 500)
	 _ORIENTATION = 'H';
	 else
	 _ORIENTATION = 'V';

	 }
	 */
	if (window.innerWidth > window.innerHeight) {
		_ORIENTATION = 'H';
	} else {
		_ORIENTATION = 'V';
	}
	//updateOrientation();
}

var _UPDATE_ORIENTATION_RUNNING = false;
//function updateOrientation(event){
function updateOrientation() {
	//console.log('js updateOrientation');
	if (_UPDATE_ORIENTATION_RUNNING)
		return;
	_UPDATE_ORIENTATION_RUNNING = true;
	//console.log('js updateOrientation running');
	/*
	if(typeof window.orientation != "undefined"){
	//console.log(window.orientation);
	switch (window.orientation) {
	case 0:
	case 180:
	_ORIENTATION = 'V';
	break;
	case -90:
	case 90:
	_ORIENTATION = 'H';
	break;
	}
	} else {*/
	//_ORIENTATION = window.innerWidth > window.innerHeight ? "V" : "H";
	//}
	console.log('_ORIENTATION ' + _ORIENTATION);

	setTimeout(function() {
		updateEdicolaProductsIscroll();
		updateRichBtn();
		archivioUpdateIscroll();
		qarchivioUpdateIScroll();

		inboxUpdateOrientation();
		preferitiUpdateOrientation();
		impostazioniUpdateOrientation();

		if (_REGISTRAZIONE_ISCROLL != null) {
			_REGISTRAZIONE_ISCROLL.refresh();
		}

		if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
			_IMPOSTAZIONI_ISCROLL_PRIVACY.refresh();
		}

		if (_PRODUCT_DETAILS_COVERFLOW != null)
			_PRODUCT_DETAILS_COVERFLOW._display();

		_UPDATE_ORIENTATION_RUNNING = false;

	}, 200);
	//}, 500);

}

/******************************************************
 Gestione schermata di riepilogo abbonamento annuale
 ******************************************************/
var _RIEPILOGO_ISCROLL = null;
var _RIEPILOGO_PRODUCT = null;
var _RIEPILOGO_OFFER = null;
function popupRiepilogoApri(p_product_detail, p_offerta) {
	console.log('detail ' + /*JSON.stringify(*/
	p_product_detail['subscriptionOffers']/*)*/);
	_RIEPILOGO_PRODUCT = p_product_detail;
	_RIEPILOGO_OFFER = p_offerta;
	if (_RIEPILOGO_ISCROLL == null && _ORIENTATION == 'H') {
		_RIEPILOGO_ISCROLL = new iScroll('riepilogo_body', {
			bounce : false
		});
		_RIEPILOGO_ISCROLL.refresh();
	}

	_RIEPILOGO_OFFER = {};
	//p_product_detail['subscriptionOffers'];

	// alert("aaa "+p_product_detail['subscriptionOffers'].length);

	for (var j = 0; j < p_product_detail['subscriptionOffers'].length; j++) {
		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['annuale_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['annuale_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in unica soluzione.<BR/>L\'importo visualizzato a fianco si riferisce alla quota annuale di abbonamento';
			_RIEPILOGO_OFFER['annuale_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['annuale_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_MENSILE_PAG') {
			_RIEPILOGO_OFFER['mensile_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['mensile_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in rate mensili.<BR/>L\'importo visualizzato a fianco si riferisce al canone mensile di abbonamento';
			_RIEPILOGO_OFFER['mensile_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['mensile_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		//se i codici che mi arrivano non sono quelli attessi mi conservo quello che arriva
		if (p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_MENSILE_PAG' && p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['x_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['x_descr'] = 'Abbonamento a ' + p_product_detail.productName + '<BR/>in versione digitale.<BR/>';
			_RIEPILOGO_OFFER['x_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['x_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];

			//console.log(JSON.stringify(_RIEPILOGO_OFFER));
		}

	}

	//alert("aaa " + _RIEPILOGO_OFFER['annuale_price'] + "," + _RIEPILOGO_OFFER['mensile_price']);

	$('#riepilogo').css('display', 'inline-block');
	$('.prezzo_abbo_anno').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['annuale_price']/*p_offerta.offerPrice*/));
	$('.prezzo_abbo_mese').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['mensile_price']/*p_offerta.offerPrice*/));
	$('#prodotto_riepilogo').text(p_product_detail.productName);
	$('.abbo_mensile_text').html(_RIEPILOGO_OFFER['mensile_descr']);
	$('.abbo_annuale_text').html(_RIEPILOGO_OFFER['annuale_descr']);
}

function popupRiepilogoAnnulla() {
	$('#riepilogo').css('display', 'none');

}

function riepilogoProcedi() {
	var p_product_detail = _RIEPILOGO_PRODUCT;
	var p_offerta = _RIEPILOGO_OFFER;

	//alert('aaaa'+$('#riepilogo input[name=id_abbonamento]'));
	if ($('#riepilogo input[name=id_abbonamento]').attr('checked')) {
		console.log('hai selezionato ' + (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0 ? 'Ricorrrente' : 'One shot'));

		//Link se è ricorrente o oneshot
		if (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0) {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['mensile_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['mensile_url'];
			console.log('ricorrente ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'Ricorrrente' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		} else {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['annuale_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['annuale_url'];
			console.log('oneshot ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'One shot' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		}
		$('#riepilogo').css('display', 'none');
	} else {
		alert('Nessuna selezione');
	}
}

/******************************************************
 Gestione schermata di registrazione
 ******************************************************/
var _REGISTRAZIONE_ISCROLL = null;
function popupRegistrazioneApri() {

	// Inizializzazione dei vari campi della registrazione
	$('#registrazione #id_username').val('');
	$('#registrazione #id_password').val('');
	$('#registrazione #id_password_confirm').val('');
	$('#registrazione #id_email').val('');
	$('#registrazione #id_consenso_privacy').attr('checked', false);
	$('#registrazione #id_consenso_email').attr('checked', false);
	$('#registrazione #id_consenso_societa').attr('checked', false);
	$('#registrazione #id_consenso_privacy').change();
	$('#registrazione #id_consenso_email').change();
	$('#registrazione #id_consenso_societa').change();
	$('#registrazione_senza_email').css('display', 'inline-block');
	$('#registrazione_con_email').css('display', 'none');

	$('#registrazione').css('display', 'inline');

	if (_REGISTRAZIONE_ISCROLL == null) {
		_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
			bounce : false
		});
	} else {
		_REGISTRAZIONE_ISCROLL.refresh();
	}

	//Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
	$('#registrazione #id_email').unbind();
	$('#registrazione #id_email').keyup(function() {
		console.log('keyup');
		if ($('#registrazione #id_email').val() != '') {
			/*
			 $('#registrazione_senza_email').fadeOut(200, function(){
			 $('#registrazione_con_email').fadeIn(200, function() {
			 if (_REGISTRAZIONE_ISCROLL != null)
			 _REGISTRAZIONE_ISCROLL.refresh();
			 });
			 });
			 */
			$('#registrazione_senza_email').css('display', 'none');
			$('#registrazione_con_email').css('display', 'inline-block');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();

			if (_REGISTRAZIONE_ISCROLL == null && _ORIENTATION == 'H') {
				_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
					bounce : false
				});
				_REGISTRAZIONE_ISCROLL.refresh();
			}
		} else {
			/*
			 $('#registrazione_con_email').fadeOut(200, function(){
			 $('#registrazione_senza_email').fadeIn(200, function() {
			 if (_REGISTRAZIONE_ISCROLL != null)
			 _REGISTRAZIONE_ISCROLL.refresh();
			 });
			 });
			 */
			$('#registrazione_senza_email').css('display', 'inline-block');
			$('#registrazione_con_email').css('display', 'none');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();
		}
	});
}

function popupRegistrazioneChiudi() {
	//$('#registrazione').fadeOut();
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAnnulla() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneIndietro() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAvanti() {
	if (controlloDatiRegistrazione()) {

		// Definizione del profilo utente
		var l_username = $('#registrazione #id_username').val();
		var l_password = $('#registrazione #id_password').val();
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : l_username,
			"password" : l_password
		};

		var l_user_email = $('#registrazione #id_email').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#registrazione #id_consenso_privacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#registrazione #id_consenso_email').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#registrazione #id_consenso_societa').attr('checked') == "checked" ? '1' : '0');
		}

		var l_req_headers = {
			"appKey" : _API24_APPKEY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceName" : device.name,
			"deviceID" : device.uuid,
			"deviceType" : device.platform,
			"profile" : l_user_profile
		};
		console.log('---REQ---> createUser (' + l_username + ')');
		console.log(l_req_headers);
		console.log(l_req_data);
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Registrazione in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });*/
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Registrazione in corso..."]);
		$.ajax({
			type : "POST",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/createUserEDOI",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(res) {
				if ( typeof res == "string") {
					res = $.parseJSON(res);
				}

				console.log('---RESP--> createUser (' + l_username + ')');
				console.log(res);

				if (!res.Success) {
					//navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification", "activityStop", []);
					//Gestione messaggi di errore dal server
					if (res.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Uno o più campi inseriti non sono validi.', 'Registrazione');
					} else if (res.Exception.Name == 'ExistingUserException') {
						abutils.alert('Lo username è già utilizzato.', 'Registrazione');
					} else {
						//alert('Attenzione, ' + res.Exception.Description);
						abutils.alert(res.Exception.Description, 'Registrazione');
					}
				} else {
					//Salva profilo utente
					/*
					 _USERNAME = l_username;
					 _PASSWORD = l_password;
					 storeUsername(l_username);
					 storePassword(l_password);
					 */
					if (l_user_email == '') {
						abutils.alert("L'indirizzo email ti verrà richiesto al primo accesso al nostro sito web.", 'Registrazione completata');
					} else {
						abutils.alert("Ti abbiamo inviato una mail per attivare la tua utenza anche per il nostro sito web.", 'Registrazione completata');
					}
					/*
					 popupRegistrazioneChiudi();
					 gestisciProssimaAzione();
					 */
					eseguiLogin(l_username, l_password);
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				//console.log('ajax error');
				//console.log(textStatus);
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				abutils.alert('Si è verificato un errore durante la registrazione.', 'Registrazione');
			}
		});
	}
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in particolare:
 *  - la username non deve contenere caratteri speciali
 *  - le password devono coincidere e non devono avere caratteri speciali
 *  - l'indirizzo email, se presente, deve essere un indirizzo valido
 *  - l'utente deve acconsentire al trattamento dei dati personali in caso di presenza dell'indirizzo email
 */
function controlloDatiRegistrazione() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	var ck_username = /^[A-Za-z0-9_]{3,20}$/;
	/* Min 3 max 20 caratteri */
	var ck_password = /^[A-Za-z0-9!@#$%^*()_]{8,20}$/;
	/* Min 8 max 20 caratteri senza / \ e & */
	// Controllo username
	username = $('#registrazione #id_username').val();
	if (!ck_username.test(username)) {
		abutils.alert('Lo username non può contenere spazi e caratteri speciali. Deve essere lunga tra i 3 ed i 20 caratteri', 'Registrazione');
		return false;
	}

	// Controlli password
	password = $('#registrazione #id_password').val();
	if (password == '') {
		abutils.alert('La password è obbligatoria.', 'Registrazione');
		return false;
	}
	if (!ck_password.test(password)) {
		abutils.alert('La password inserita non è valida.', 'Registrazione');
		return false;
	}
	password_confirm = $('#registrazione #id_password_confirm').val();
	if (password_confirm != password) {
		abutils.alert('Le password inserite non coincidono.', 'Registrazione');
		return false;
	}

	// Controllo email
	email = $('#registrazione #id_email').val();

	// email obbilgatoria
	if (email == '') {
		abutils.alert("L'indirizzo email è obbligatorio.", 'Registrazione');
		return false;
	}

	if (email != '' && !ck_email.test(email)) {
		abutils.alert("L'indirizzo email inserito non è valido.", 'Registrazione');
		return false;
	}

	//console.log('aaa'+$('#registrazione input[name=id_consenso_privacy]').attr('checked'));
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#registrazione input[name=id_consenso_privacy]').attr('checked')) {
		abutils.alert("Per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Registrazione');
		return false;
	}

	return true;
}

/******************************************************
 Gestione popup di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per la login
 * @params p_username Parametro opzionale con il quale inizializzare il campo username
 *         p_force Se impostato a true forza l'utente a non poter uscire dalla login se non attraverso l'effettuazione della login stessa
 */
var _POPUP_LOGIN_USERNAME = null;
function popupLogin(p_username, p_force) {
	//alert('bbb');
	_POPUP_LOGIN_USERNAME = p_username;

	//Inizializza lo username se questo viene passato come parametro
	if (p_username) {
		$('#login #id_username').val(p_username);
		$('#login #login_body_message').text(p_username);
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'none');
		$('#login #id_password').val('');
	} else {
		$('#login #id_username').val('');
		$('#login #login_body_message').text('');
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'inline-block');
		$('#login #id_password').val('');
	}

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#login_back_button').css('visibility', 'hidden');
	} else {
		$('#login_back_button').css('visibility', 'visible');
	}
	//$('#riepilogo').css('visibility', 'hidden');
	$('#login').css('display', 'inline');
	//Disabilita le select
	$('select').attr('disabled', 'disabled');
	//$('#edicola_titolo_btn_select').attr('disabled','true');
	$('#impostazioni_prodotto_principale_select').attr('disabled', 'true');

}

function popupLoginChiudi() {
	//$('#login').fadeOut();
	$('#login').css('display', 'none');
	$('#login_body_message').text('');
	//Abilita le select
	$('select').removeAttr('disabled');
	//$('select').attr('disabled', 'false');
}

function popupLoginIndietro() {
	//$('#login').fadeOut();
	_NEXT_ACTION = null;
	$('#login').css('display', 'none');

	if (_POPUP_LOGIN_USERNAME != null) {
		// procedo ad una disassociazione del dispositivo
		disassociazioneSilenziosa(_POPUP_LOGIN_USERNAME);
	}
}

function disassociazioneSilenziosa(p_username) {
	if (p_username == null) {
		p_username = _USERNAME;
	}
	var l_request_data = {
		"username" : p_username, //_USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	var l_req_headers = {
		"appKey" : _API24_APPKEY//,
		//"userIdentity": _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice Silent Login');
	console.log(l_req_headers);
	console.log(l_request_data);

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice Silent Login');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {

			} else {

			}

		},
		error : function() {

		}
	});
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupLoginAvanti() {
	if (controlloDatiLogin()) {
		var l_username = $('#login #id_username').val();
		var l_password = $('#login #id_password').val();
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Login in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });*/
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Login in corso..."]);
		_EDICOLA_LAST_PRODUCT_LOAD = 0;
		eseguiLogin(l_username, l_password);
	}
}

/**
 * Esegue la chiamata di login verso il server
 */
function eseguiLogin(p_username, p_password, p_silent) {
	console.log('---REQ---> userLogin (' + p_username + ')');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"siteCode" : _API24_SITECODE,
		"username" : p_username,
		"password" : p_password
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/userLogin",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			setUserData(null, null, null);

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> userLogin');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {
				// procedo ad una associazione
				associaDevice(p_username, p_password, p_response.Result.res, p_silent);
				popupAcquistoRegistrazioneClose();
				//console.log('Utente ' + p_username + ' autenticato con successo.');
				/* è sbagliato, dopo la login ci va subito un associazione
				 storeUsername(p_username);
				 storePassword(p_password);
				 _USERNAME = p_username;
				 _USER_PASSWORD = p_password;
				 _USER_IDENTITY = p_response.Result.res;
				 popupLoginChiudi();
				 associaDevice();
				 gestisciProssimaAzione();
				 */
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				popupAcquistoRegistrazioneClose();
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// errore in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - login: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					// errore da mostrare
					abutils.alert('Si è verificato un errore durante la login. ' + l_exc_descr, 'Login');
				}

			}
		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - login: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare la login. Riprovare tra poco.', 'Login');
			}
		}
	});
}

/**
 * Associa l'utente al dispositivo
 */
function associaDevice(p_username, p_password, p_useridentity, p_silent) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : p_useridentity //_USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceName" : device.name,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : p_username //_USERNAME
	};

	console.log('---REQ---> associauserdevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "POST",
		cache : false,
		contentType : "application/json; charset=utf-8",
		//url: _API24_ENDPOINT + "Users/addUserDevice",
		url : _SOLEGW_ENDPOINT + "associauserdevice.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> associauserdevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, associaDevice) || (p_response.Exception.Name == 'UserDeviceRelationException')) {
				//console.log("Utente " + _USERNAME + " associato al device " + device.uuid)
				/*
				 storeUsername(p_username);
				 storePassword(p_password);
				 _USERNAME = p_username;
				 _USER_PASSWORD = p_password;
				 _USER_IDENTITY = p_useridentity;
				 */
				setUserData(p_username, p_password, p_useridentity);
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				if (p_silent) {
					onDeviceReady_aux();
				} else {
					popupLoginChiudi();
					popupRegistrazioneChiudi();
					gestisciProssimaAzione();
				}
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				//Gestione eccezioni
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// exception in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - associauserdevice: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					console.log('associaDevice EXCEPTION ' + p_response.Exception.Name + ': ' + p_response.Exception.Description);
					if ((p_response.Exception.Name != 'UserDeviceRelationException') && (p_response.Exception.Name != 'ExpiredUserIdentityException')) {
						abutils.alert(p_response.Exception.Description, 'Associazione device');
					}
				}

			}

		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - associauserdevice: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare l\'associazione del device. Riprovare tra poco.', 'Login');
			}
		}
	});
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in particolare:
 *  - lo username è obbligatoria e non deve contenere caratteri speciali
 *  - la password è obbligatoria e non deve contenere caratteri speciali
 */
/*
 function controlloDatiLogin(){
 //var ck_username = /^[A-Za-z0-9_]{3,50}$/; // Min 3 max 20 caratteri
 //var ck_password = /^[A-Za-z0-9!@#$%^*()_]{3,50}$/; // Min 8 max 20 caratteri senza / \ e &
 // Controllo username
 username = $('#login #id_username').val();
 if (!ck_username.test(username)) {
 abutils.alert('Lo username non può contenere spazi, caratteri speciali e deve essere lungo tra i 3 ed i 20 caratteri', 'Login');
 return false;
 }

 // Controlli password
 password = $('#login #id_password').val();
 if (password == '') {
 abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
 return false;
 }
 if (!ck_password.test(password)) {
 abutils.alert('Attenzione, la password inserita non è valida.', 'Login');
 return false;
 }

 return true;
 }*/

function controlloDatiLogin() {
	username = $('#login #id_username').val();
	if (username == '') {
		abutils.alert('Attenzione, lo username è obbligatorio.', 'Login');
		return false;
	}

	// Controlli password
	password = $('#login #id_password').val();
	if (password == '') {
		abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
		return false;
	}

	return true;
}

/******************************************************
 Gestione schermata di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per il controllo della password
 * @params p_force Se impostato a true forza l'utente a non poter annullare il controllo password
 */
function popupControlloPassword(p_force) {

	//Inizializza lo username
	$('#controllo_password #controllo_password_account_username').text(_USERNAME);

	$('#controllo_password #id_password').val('');

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#controllo_password_back_button').css('visibility', 'hidden');
	} else {
		$('#controllo_password_back_button').css('visibility', 'visible');
	}

	$('#controllo_password').css('display', 'inline');
	//Disabilita le select
	//$('select').attr('disabled', 'disabled');
	$('select').attr('disabled', 'disabled');
	$('#impostazioni_prodotto_principale_select').attr('disabled', 'true');

}

function popupControlloPasswordChiudi() {
	//$('#controllo_password').fadeOut();
	$('#controllo_password').css('display', 'none');
	//Abilita le select
	$('select').removeAttr('disabled');
	//$('select').attr('disabled', 'false');
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupControlloPasswordAvanti() {
	if ($('#controllo_password #id_password').val() != _USER_PASSWORD) {
		abutils.alert('La password non è corretta', 'Attenzione');
	} else {
		popupControlloPasswordChiudi();
		gestisciProssimaAzione();
	}
}

/******************************************************
 Gestione memorizzazione locale username
 ******************************************************/
/**
 * Elimina lo username dell'utente dal local storage
 */
function deleteUsername() {
	window.localStorage.removeItem("username");
}

/**
 * Memorizza lo username dell'utente nel local storage
 * @params p_username Lo username che deve essere memorizzato
 */
function storeUsername(p_username) {
	window.localStorage.setItem("username", p_username);
}

/**
 * Legge lo username dell'utente da local storage
 * @returns String Lo username dell'utente
 */
function getUsername() {
	return window.localStorage.getItem("username");
}

/******************************************************
 Gestione memorizzazione locale password
 ******************************************************/
/**
 * Elimina la password dell'utente dal local storage
 */
function deletePassword() {
	window.localStorage.removeItem("password");
}

/**
 * Memorizza la password dell'utente nel local storage
 * @params p_username La password che deve essere memorizzata
 */
function storePassword(p_password) {
	window.localStorage.setItem("password", p_password);
}

/**
 * Legge la password dell'utente da local storage
 * @returns String La password dell'utente
 */
function getPassword() {
	return window.localStorage.getItem("password");
}

/******************************************************
 Gestione controllo iniziale username
 ******************************************************/
/**
 * Controlla la presenza dello username nel local storage ed in caso controlla
 * che sia lo stesso username associato al dispositivo
 */
function controlloUsername() {
	var l_local_storage_username = getUsername();
	var l_local_storage_password = getPassword();
	console.log('Utente secondo IPAD: ' + l_local_storage_username);
	if (l_local_storage_username != null && l_local_storage_password != null) {
		// procedo direttamente alla login
		//setUserData(null, null, null);
		_NEXT_ACTION = onDeviceReady_aux;
		eseguiLogin(l_local_storage_username, l_local_storage_password, true);
		return;
	}

	// se non ci sono dati in locale chiedo l'eventuale utenza ad API24

	//console.log('Lettura utente associato al dispositivo');
	var l_signature = getSignature(device.uuid + ',' + device.platform);

	console.log('---REQ---> getUserFromDevice');
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	//Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserFromDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			console.log('---RESP--> getUserFromDevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				var l_api24_username = p_response.Result.res;
				console.log('Utente secondo API24: ' + l_api24_username);

				if (l_api24_username != '') {
					_NEXT_ACTION = loadProducts;
					popupLogin(l_api24_username);
					onDeviceReady_aux();
				} else {
					onDeviceReady_aux();
				}

				/*
				 var l_local_storage_username = getUsername();
				 var l_local_storage_password = getPassword();
				 console.log('Utente secondo IPAD:  ' + l_local_storage_username);

				 // Se API24 non ritorna nessun utente cancello i dati nel local storage
				 if (l_api24_username == '') {
				 console.log('Cancello eventuali dati utente da locale.');
				 //deleteUsername();
				 //deletePassword();
				 setUserData(null, null, null);
				 onDeviceReady_aux();
				 return;
				 }

				 // Se API24 ritorna lo stesso utente memorizzato in locale memorizzo l'utenza in una variabile globale ed eseguo il login
				 if (l_api24_username != '' && l_api24_username == l_local_storage_username) {
				 // viene fatto dalla eseguiLogin
				 //_USERNAME = l_api24_username;
				 //_USER_PASSWORD = getPassword();
				 _NEXT_ACTION = onDeviceReady_aux;
				 eseguiLogin(l_local_storage_username, l_local_storage_password, true);
				 return;
				 }

				 // Se API24 ritorna un utente ma nel local storage c'è un altro utente cancello i dati in locale e forzo la login
				 if (l_api24_username != '' && l_api24_username != l_local_storage_username) {
				 //deleteUsername();
				 //deletePassword();
				 setUserData(null, null, null);
				 popupLogin(l_api24_username);
				 onDeviceReady_aux();
				 //popupLogin(l_api24_username, true);
				 }
				 */
			} else {
				// Gestione eccezioni
				//setUserData(null, null, null);
				onDeviceReady_aux();
				return;
			}
		},
		error : function() {
			//setUserData(null, null, null);
			onDeviceReady_aux();
			return;
		}
	});
}

function popupInformativaPrivacy() {
	//$('#informativa_privacy').fadeIn();
	if (_IMPOSTAZIONI_PROFILO_ISCROLL != null) {
		_IMPOSTAZIONI_PROFILO_ISCROLL.destroy();
		_IMPOSTAZIONI_PROFILO_ISCROLL = null;
	}
	// Viene mostrato il popup
	$('#informativa_privacy').css('display', 'inline');
	if (_IMPOSTAZIONI_ISCROLL_PRIVACY == null)
		_IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
}

function popupInformativaPrivacyClose() {
	//$('#informativa_privacy').fadeOut();
	$('#informativa_privacy').css('display', 'none');
	if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
		console.log("_IMPOSTAZIONI_PROFILO_ISCROLL is null");
		_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper');
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	}
}

/******************************************************
 Gestione inizializzazione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 5 * 1024 * 1024;
var _DB = null;
var _DBFAIL = false;

/**
 * Inizializza il database associato all'applicazione
 */
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	
	if (!window.openDatabase)
    	console.log("Error: can't open local database");
	if (!localStorage)
    	console.log("Error: localstorage not usable");
    try{
    	if(!_DB){
    		console.log("opendatabase "+_DB_NAME +"," + "1.0"+ ","+_DB_NAME+","+ _DB_SIZE);
			_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
		}
	}catch(exc){
		console.log('Errore database '+exc.message);
			setTimeout(function(){
				try{
					if (window.openDatabase){
						_DB = null;
						_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);//window.simulateDB.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
						//window.location.assign('index.html');
					}else{
						_DBFAIL = true;
						
						if(!window.infodroid.isfoglioopen()){
							 window.simulatePG.relaod();
						}
					}
				}catch(exc){
					console.log('Errore simDB database ' + exc.message);
					_DBFAIL = true;
					if(!window.infodroid.isfoglioopen()){
						 window.simulatePG.relaod();
					}
				}
			},500);
	}
	console.log("Inizializzazione database OK");
}

/**
 * Funzione di gestione degli erorri delle operazioni sul database
 */
function dbErrorHandler(p_error) {
	console.log("Error processing SQL: " + p_error);
}

/* -------------------- DOWNLOAD MANAGER ----------------------------------- */
/* ricordarsi di mettere la downloadManagerDBinit() nel deviceready-bodyload */
function downloadManagerDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK downloadManagerDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO downloadManagerDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS issues (id unique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, dttm)', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function addToDownloadQueue(testata, issue, edizione) {
	renderDownloadQueue(testata, issue, edizione);
	//PhoneGap.exec("DownloadManagerCommand.addIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.addIssueToDownloadQueue(null, null, testata, issue, edizione);
	window.soledownloader.launchDownload(testata, edizione, issue, "Descrizione" + window.localStorage.getItem('unread_message_sole'), "" + "aaaa", "false");
	console.log("queue!!!")
}

function getUnreadMessage(testata, edizione, issue) {
	var unread = window.localStorage.getItem('unread_message_sole');
	//alert('aunread is '+unread);
	if (unread != null)
		window.runfunc.retMessage(testata, edizione, issue, unread);
	else
		window.runfunc.retMessage(testata, edizione, issue, 0);
}

function renderDownloadQueue(testata, issue, edizione) {
	// Modifica pulsante
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	btn.show();
	if (btn) {
		$(btn).val('Annulla');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			//alert(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			setTimeout(function() {
				removeToDownloadQueue(testata, issue, edizione);
			}, 0);
			/*
			 setTimeout(function(){
			 window.soledelete.deleteIssue(testata, issue, edizione);
			 },1000);
			 */
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'visible';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
}

function removeToDownloadQueue(testata, issue, edizione) {
	//PhoneGap.exec("DownloadManagerCommand.removeIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.removeIssueToDownloadQueue(null, null, testata, issue, edizione);
	window.soledownloader.cancelDownload(testata, edizione, issue, "", "", true);
	console.log("remove queue t: " + testata + " ed: " + edizione + " iss: " + issue);

	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	if (btn) {
		$(btn).val('Salva in locale');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; ADD2 TO QUEUE " + testata + " " + issue + " " + edizione);
			addToDownloadQueue(testata, issue, edizione);
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSingleFileComplete(testata, issue, edizione, progress) {
	if (!$('#progressbar_status_' + testata + '_' + issue + '_' + edizione).length) return;
	
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	$('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).show();
	
	if ($('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).val().indexOf('Salva') != -1) {
		renderDownloadQueue(testata, issue, edizione);
	}

	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'royalblue';
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(10,43,128) 0%, rgb(99,151,255) 100%)';

	//alert("is "+progress);
	console.log("progress is " + progress);
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = parseInt(progress) + '%';

}

function downloadManagerCallbackSingleFileError(testata, issue, edizione, progress) {
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'red';
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(92,13,13) 0%, rgb(252,0,0) 100%)';
		*/
		//document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = progress + '%';
	}
}

function downloadManagerCallbackSetComplete(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	if (document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione).className = 'qarchivio_container_box_txt_local_LIST';
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'green';
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(20,97,5) 0%, rgb(138,255,120) 100%)';
		*/
		//document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '100%';
	}
	downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr);
	omnitureTrackApp('APP:download:complete:' + testata + ':' + issue + ':' + edizione, 'APP:download');
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	console.log('downloadManagerCallbackSaveIssueDb!!!');
	if (_DB) {
		var querySuccess = function() {
			console.log('OK SAVE LOCAL DB');
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);

			// togliere pulsante scarica e mostrare sfoglia
			var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
			if (btn) {
				$(btn).unbind();
				$(btn).removeClass('gray24');
				$(btn).removeClass('qarchivio_free_copy_btn');
				$(btn).addClass('red24');
				$(btn).val('Sfoglia');
				$(btn).bind('click', function() {
					console.log(";;;;;;;;;; SFOGLIA " + testata + " " + issue + " " + edizione);
					sfoglia(testata, issue, edizione);
					console.log("sfoglia archivio");
					window.loader.local(true);
					//sfogliaArchivio(testata, issue, edizione);
					/*
					 var keyinput = "unread_message_sole";
					 var valoutput = 0;

					 var node = document.getElementById('appmenu_inbox_count');
					 //alert("style: "+node.style.display);
					 if(node.style.display == 'block' || node.style.display == 'inline-block'){
					 valoutput = 1;
					 }else{
					 valoutput = 0;
					 }

					 if(typeof(window.localStorage) != 'undefined'){
					 window.localStorage.setItem(keyinput,valoutput);
					 }
					 else{
					 throw "window.localStorage, not defined";
					 }

					 window.loader.launchSfogliatore(p_testata, p_edizione, p_issue, "Descrizione"+valoutput);
					 */
				});
			}

			// aggiorna dettaglio prodotto se necessario
			refreshProductDetails();
		}
		var queryError = function(tx, p_error) {
			console.log('KO SAVE LOCAL DB ' + p_error.message);
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);
		}
		var executeQuery = function(tx) {
			var idunique = testata + '_' + issue + '_' + edizione;
			console.log('INSERT INTO issues: ' + idunique);
			//tx.executeSql('INSERT INTO issues VALUES("' + idunique + '", "' + testata + '", "' + testata_descr + '", "' + issue + '", "' + issue_descr + '", "' + edizione + '", "' + edizione_descr + '", DATETIME(\'NOW\'));', [], querySuccess, queryError);
			tx.executeSql('INSERT INTO issues VALUES(?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'));', [idunique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function downloadManagerCallbackSetError(testata, issue, edizione) {
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'red';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '100%';
		 */
	}
	if (document.getElementById('stop_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('stop_' + testata + '_' + issue + '_' + edizione).style['display'] = 'none';
	if (document.getElementById('download_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('download_' + testata + '_' + issue + '_' + edizione).style['display'] = 'inline-block';
}

/* ------------------------- FINE DOWNLOAD MANAGER ---------------------- */

/******************************************************
 Gestione popup accedi/registrati
 ******************************************************/
function popupAccediRegistrati() {
	$('#accedi_registrati_menu').css('display', 'inline-block');
}

function popupAccediRegistratiChiudi() {
	$('#accedi_registrati_menu').css('display', 'none');
}

function popupAccediRegistratiAnnulla() {
	$('#accedi_registrati_menu').css('display', 'none');
	_NEXT_ACTION = null;
}

/******************************************************
 Ajax COMMONS
 ******************************************************/
/**
 * Gestisce il controllo del risultato proveniente dalle richieste Ajax.
 * Le risposte devono essere in formato JSON ed avere almeno l'attributo Success ed eventuali eccezioni.
 * @params p_result La risposta proveniente dal server
 * @returns Boolean False in caso di errori, True in caso di successo
 */
function checkAjaxResponse(p_response, p_callback) {
	if ( typeof p_response == "string") {
		p_response = $.parseJSON(p_response);
	}
	if (p_response.Success) {
		//console.log('Check ajax response OK');
		//console.log(p_response);
		return true;
	} else {
		console.log('Check ajax response KO: [' + p_response.Exception.Name + '] ' + p_response.Exception.Description);
		if (p_response.Exception.Name == 'ExpiredUserIdentityException') {
			if (_USERNAME == null && _USER_PASSWORD == null) {
				console.log('WARNING username e/o password non settati, impossibile procedere al rinnovo della useridentity');
				setUserData(null, null, null);
				return false;
			}
			console.log('GESTIONE ExpiredUserIdentityException');
			console.log('---REQ---> userLogin4ExpiredUserIdentityException(' + _USERNAME + ')');
			var l_username = _USERNAME;
			var l_user_password = _USER_PASSWORD;
			var l_req_headers = {
				"appKey" : _API24_APPKEY
			};
			var l_req_data = {
				"siteCode" : _API24_SITECODE,
				"username" : l_username,
				"password" : l_user_password
			};
			console.log(l_req_headers);
			console.log(l_req_data);
			// resetto username e password
			/*
			 _USERNAME = null;
			 _USER_PASSWORD = null;
			 */
			setUserData(null, null, null);

			$.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/userLogin",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					if ( typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> userLogin4ExpiredUserIdentityException');
					console.log(p_response);

					if (checkAjaxResponse(p_response)) {
						/*
						 _USER_IDENTITY = p_response.Result.res;
						 _USERNAME = l_username;
						 _USER_PASSWORD = l_user_password;
						 */
						setUserData(l_username, l_user_password, p_response.Result.res);
						if (p_callback != null)
							p_callback.call();
						else
							console.log('WARNING userLogin4ExpiredUserIdentityException completata, ma manca la callback');
					} else {
						console.log('WARNING userLogin4ExpiredUserIdentityException error');
					}
				},
				error : function() {
					console.log('WARNING userLogin4ExpiredUserIdentityException timeout');
				}
			});

			//$('#login_body_message').text('Attenzione, è passato troppo tempo da quando hai fatto accesso al sistema.');
			//popupLogin(_USERNAME, true);
		}
		return false;
	}
}

/**
 * Callback generica per la gestione degli errori di comunicazione verso le API24
 */
function ajaxErrorHandler(xmlHttpRequest, textStatus, errorThrown) {
	console.log('Ajax error: ' + textStatus);
	//enableOfflineMode();
}

/**
 * Inizializza il controllo per la gestione online/offline
 */
var _OFFLINE_COUNTER = null;
//var _PING_COUNTER = 0;
function testConnectionWorker() {
	//_PING_COUNTER++;
	if (_OFFLINE_COUNTER == null)
		_OFFLINE_COUNTER = 1;
	// al primo avvio il primo risultato è quello buono

	console.log('---REQ---> PING');
// 	var l_req_headers = {
// 		"appKey" : _API24_APPKEY
// 	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	//console.log(l_req_headers);
	//console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		//headers : l_req_headers,
		data : l_req_data,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + 'ping.json',
		dataType : "json",
		beforeSend: function (request) {
			request.setRequestHeader("appKey", _API24_APPKEY);
		},
		success : function(p_response) {
			//console.log('---RESP--> PING');
			console.log(p_response);
			try {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				if (checkAjaxResponse(p_response) && (p_response.Result.res.statusCode == 0)) {
					enableOnlineMode();
					_OFFLINE_COUNTER = 0;
				} else {
					_OFFLINE_COUNTER++;
					if (_OFFLINE_COUNTER >= 2) {
						enableOfflineMode();
					}
				}
			} catch (exc) {
				//console.log('errore formato risposta');
				_OFFLINE_COUNTER++;
				if (_OFFLINE_COUNTER >= 2) {
					enableOfflineMode();
				}
			}
		},
		error : function() {
			//console.log('ajax error');
			_OFFLINE_COUNTER++;
			if (_OFFLINE_COUNTER >= 2) {
				enableOfflineMode();
			}
		}
	});
}

function initCheckOnline() {
	testConnectionWorker();
	setInterval(function() {
		testConnectionWorker();
	}, _INTERVALLO_CHECK_ONLINE);
}

/**
 * Gestisce l'esecuzione della prossima azione. Alcune volte al termine delle azioni su una popup è necessario
 * eseguire un azione. Per fare ciò viene impostata la variabile _NEXT_ACTION alla funzione che deve essere richiamata.
 * La seguente funzione controlla che ci sia una prossima azione ed in caso la esegue.
 */
function gestisciProssimaAzione() {
	//Se la variabile _NEXT_ACTION è inizializzata chiama la funzione associata
	if (_NEXT_ACTION && typeof _NEXT_ACTION == "function") {
		var l_next_action = _NEXT_ACTION;
		_NEXT_ACTION = null;
		l_next_action.call();
	}
}

/* --------- gestione bottoni appmenu -------------------- */
function appmenuButtonReset() {
	$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
	$('#appmenu_edicola').removeClass('appmenu_edicola_on');
	$('#appmenu_preferiti').removeClass('appmenu_preferiti_on');
	$('#appmenu_inbox').removeClass('appmenu_inbox_on');
	$('#appmenu_impostazioni').removeClass('appmenu_impostazioni_on');
}

function appmenuSfoglioOpen() {
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
	var l_ret = openFlipper();
	if (!l_ret) {
		$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
		abutils.alert('Nessuna pubblicazione è ancora stata aperta.', 'Sfoglia');
		return;
	}
	appmenuButtonReset();
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
}

function appmenuEdicolaOpenWithIndice(testata, edizione) {
	appmenuEdicolaOpen(true);
	try {
		var l_product_id = _HASH_MAP_TESTATA_PRODUCTID[testata];
		console.log(testata + ' ---> ' + l_product_id);
		if (l_product_id == null)
			return;
		//qarchivioOpen(l_product_id, true, edizione);
		if (l_product_id == _CODICE_PRODOTTO_QUOTIDIANO)
			qarchivioOpen(l_product_id, true, edizione);
		else
			archivioOpen(l_product_id, true);
	} catch (exc) {

	}
}

function appmenuEdicolaOpen(skipFlipper) {

	if (!skipFlipper && _CURRENT_FLIPPER_TESTATA != null && _CURRENT_FLIPPER_ISSUE != null && _CURRENT_FLIPPER_EDIZIONE != null) {
		openFlipper();
		setTimeout(function() {
			appmenuEdicolaOpen(true);
		}, 2000);
		return;
	}

	/* si occupa la loadproduct di controllare se è necessario un reload dei prodotti
	 if (_EDICOLA_REFRESH_PRODUCTS) {
	 $('#edicola_container').hide();
	 $('#edicola_prodotto').hide();
	 loadProducts();
	 }
	 */
	if (_MOD_OFFLINE != true) {
		loadProducts();
	}

	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(0px, 0px, 0)');

	$('#edicola_titolo_btn_select').removeAttr('disabled');

	omnitureTrackApp("APP:edicola", "APP:edicola");
	nielsenCall('EDICOLA');
}

function appmenuPreferitiOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'true');
	preferitiLoadMenuProdotto();
	appmenuButtonReset();
	$('#appmenu_preferiti').addClass('appmenu_preferiti_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-1500px, 0px, 0)');

	omnitureTrackApp("APP:preferiti", "APP:preferiti");
	nielsenCall('PREFERITI');
}

function appmenuInboxOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'true');
	appmenuButtonReset();
	$('#appmenu_inbox').addClass('appmenu_inbox_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-3000px, 0px, 0)');

	omnitureTrackApp("APP:inbox", "APP:inbox");
	nielsenCall('INBOX');
}

function appmenuImpostazioniOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'true');
	appmenuButtonReset();
	impostazioniInizializza();
	impostazioniOpen();
	$('#appmenu_impostazioni').addClass('appmenu_impostazioni_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-4500px, 0px, 0)');

	omnitureTrackApp("APP:impostazioni", "APP:impostazioni");
}

/* ----------------------------------------------------------------- */
function injectAutoLogin(username, password) {
	if (username == null || password == null)
		return "KO";
	/*
	 navigator.notification.loadingStart({
	 'labelText': "Aggiornamento in corso...",
	 'backgroundOpacity': 0.8,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 });
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

	_NEXT_ACTION = function() {
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Aggiornamento in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });*/
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

		setTimeout(function() {
			window.location = 'galaxy.html';
		}, 1000);
	}
	eseguiLogin(username, password);

	return "OK";
}

function checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback) {
	console.log('--->checkAcquisto');
	//PhoneGap.exec(null, null, "Notification", "activityStart", ["Caricamento",""]);
	/*
	 navigator.notification.loadingStart({
	 //'labelText': "Acquisto in corso...",
	 'labelText': "",
	 'backgroundOpacity': 0.8,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 });
	 */
	if (p_prodotto24 == '1') {
		//android workaround temporaneo
		p_prodotto24 = 'a1';
	}

	var local = window.verify.Local(_MAP_CODICE_TESTATA[p_prodotto24 + ''], p_issue, p_edizione);
	console.log("local is " + local);
	if (local == '1') {
		if (callback && typeof callback == "function") {
			console.log("aaaa passsq");
			callback.call();
			return;
		}
	}
	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"date" : p_issue
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> checkAcquisto(' + p_prodotto24 + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "checkacquisto/" + p_prodotto24 + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> checkAcquisto(' + p_prodotto24 + ')');
			console.log('checkAcquisto resp ' + /*JSON.stringify(*/p_response/*)*/);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback);
			})) {
				console.log('check ' + p_response.Result.res);

				if (p_response.Result.res && p_response.Result.res.checkAcquisto && (p_response.Result.res.checkAcquisto == true)) {
					//navigator.notification.confirm('Hai già acquistato questa edizione: il nuovo download è gratuito.', function(button){
					if (callback && typeof callback == "function") {
						console.log("Aquisto-->pass to func");
						callback.call();
					}
					//}, 'Acquisto non necessario', 'Ok');
				} else {
					//appstoreBuy(id_shopping24, id_itunes, callback);
					//BUY-----------------------------------------------------------------------------------------

					console.log('buy');
					console.log("aaaa passsq1");
					var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
					var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
					var link_singola = '';
					console.log('productId ' + productId);
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
					// prova con i link
					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}
					}

					if (link_singola != '') {
						window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				}
			} else {
				if (p_response.Exception.Name == 'ExpiredUserIdentityException')
					return;
				//appstoreBuy(id_shopping24, id_itunes, callback);
				//BUY---------------------------------------------------------------------------------------------
				console.log('buy');
				console.log("aaaa passsq2");
				var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
				var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];

				var link_singola = '';
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}

				// prova con i link
				if (!link_singola || link_singola == '') {
					_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
				}
				//alert('aaaa');
				//alert('link: '+link_singola);
				//alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
				//p_prodotto24, p_issue, id_shopping24, id_itunes, callback
				//var testata = _MAP_CODICE_TESTATA[p_prodotto24+''];
				if (link_singola != '') {
					window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
				} else {
					abutils.alert('Errore su link!', 'Pagamento');
				}
			}
		},
		error : function() {
			//appstoreBuy(id_shopping24, id_itunes, callback);
			//BUY-------------------------------------------------------------------------------------------------
			console.log('buy');
			console.log("aaaa passsq3");
			var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
			var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
			var link_singola = '';
			for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
				if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
				}
			}
			// prova con i link
			if (!link_singola || link_singola == '') {
				_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}
			}
			if (link_singola != '') {
				window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
			} else {
				abutils.alert('Errore su link!', 'Pagamento');
			}
		}
	});

	//appstoreBuy(id_shopping24, id_itunes, callback);
}

/**
 * @author ABertacco, MConventi
 */
var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;
var _PREFERITI_ISCROLL_MENU = null;
var _PREFERITI_ISCROLL_VISTA = null;
var _PREFERITI_ISCROLL_DETTAGLIO = null;

// Lista di prodotti da inserire nel menu di sinistra tra i prodotti
/* viene calcolata in base agli articoli presenti in db
 var _PREFERITI_PRODUCTS_LIST = [
 {
 testata: 'S24',
 nome: "Il Sole 24 ORE",
 icon: 'imgs/fake/s24_small_icon.png'
 }
 ];
 */
var _PREFERITI_PRODUCTS_LIST = null;

function preferitiLoadMenuTag() {
	preferitiLoadMenu('TAG');
}

function preferitiLoadMenuProdotto() {
	preferitiLoadMenu('PRODOTTO');
}

function preferitiLoadMenu(mode) {
	$('#preferiti_titolo_menu_opzioni_prodotto').removeClass('newgray24');
	$('#preferiti_titolo_menu_opzioni_tag').removeClass('newgray24');
	$('#preferiti_body_menu_container').empty();

	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.destroy();
		_PREFERITI_ISCROLL_MENU = null;
	}

	if (mode == 'PRODOTTO') {
		$('#preferiti_titolo_menu_opzioni_prodotto').addClass('newgray24');
		preferitiInitProductList();
	} else {
		$('#preferiti_titolo_menu_opzioni_tag').addClass('newgray24');
		preferitiInitTagList();
	}

}

function searchPref(search) {
	console.log('search is ' + search);

	/*
	 db.transaction(function(tx) {
	 tx.executeSql("SELECT id FROM table LIMIT 1", [], function(tx, result) {
	 row = result.rows.item(0);
	 }, function(tx, error) {
	 });
	 });

	 return row;

	 */
	if (search == null)
		return;

	if (_DB) {
		_DB.transaction(function(tx) {
			//'occhiello text, titolo text, sottotitolo text, firma text, testo text';
			var l_query = 'occhiello like ? OR titolo like ? OR sottotitolo like ? OR firma like ? OR testo like ?';
			var tmpsearch = search.split(' ');
			var s = '';
			// GLOBAL REPLACE
			// DA FARE
			var args = new Array(tmpsearch.length * 5);
			for (var i = 0; i < tmpsearch.length; i++) {
				if (i > 0)
					l_query += " OR " + l_query;
				s = tmpsearch[i];
				//"4,250%";
				s = s.replace(/%/g, "\\%");
				s = s.replace(/_/g, "\\_");
				s = s.replace(/&rsquo;/g, "\'");
				s = s.replace(/&quot;/g, "\"");
				s = "%" + s + "%";
				for (var j = i * 5; j < (i + 1) * 5; j++)
					args[j] = s;
				console.log("search2323 selec " + s);
			}
			search = "%" + search + "%";
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE ' + l_query + " escape '" + "\\" + "' order by issue DESC, pagina ;", args, function(tx, p_results) {
				var row = null;
				if (p_results != null && p_results.rows.length != 0) {
					for (var irow = 0; irow < p_results.rows.length; irow++) {
						row = p_results.rows.item(irow);
						//console.log("testo[0] "+row.testo);
						//'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
						window.searchlaunch.addResult(row.artid, row.testata, row.testata_descr, row.issue, row.issue_descr, row.edizione, row.edizione_descr, row.sezione, row.pagina, row.occhiello, row.titolo, row.sottotitolo, row.firma, row.testo);
						row = null;
					}

					window.searchlaunch.broadcastResult();
				} else {
					console.log('search res ' + p_results);
					window.searchlaunch.broadcastResult();
				}

			}, function(tx, error) {
				alert(error);
			});

		});

		//_DB.transaction(querySearch);

	}
}

function getArticleFromId(artid) {
	if (_DB) {
		_DB.transaction(function(tx) {

			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid = ? ;', [artid], function(tx, p_results) {
				var row = null;
				if (p_results != null && p_results.rows.length != 0) {
					preferitiDettaglio(p_results.rows.item(0));
				} else {
					console.log('search res ' + p_results);
				}

			}, function(tx, error) {
				alert(error);
			});

		});

	}
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_vista_container').appendChild(box);
	box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
	box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
	box.onclick = function() {

		if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
			popupPreferitiUpdateArticle(p_article);
		} else {
			preferitiDettaglio(p_article);
		}
	};

	var boxtb = document.createElement('table');
	box.appendChild(boxtb);

	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);

	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);

	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);

	var status_box = document.createElement('div');
	boxtd1.appendChild(status_box);
	status_box.className = 'preferiti_body_vista_container_box_status';
	// Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
	status_box.onclick = function(p_event) {
		var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));

		if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
			l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
			l_message_header.addClass('preferiti_body_vista_container_box_status_selected');

		} else if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
			l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
			l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
		}

		p_event.stopPropagation();
	};

	if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
		status_box.style.display = 'block';
	}
	status_box = null;

	var title = document.createElement('div');
	boxtd2.appendChild(title);
	title.className = 'preferiti_body_vista_container_box_title';
	title.appendChild(document.createTextNode(p_article.titolo));
	title = null;

	var descr = document.createElement('div');
	boxtd2.appendChild(descr);
	descr.className = 'preferiti_body_vista_container_box_descr';
	descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
	descr = null;

	var tags = document.createElement('div');
	boxtd2.appendChild(tags);
	tags.className = 'preferiti_body_vista_container_box_tags';
	//tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
	tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
	tags = null;

	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei prodotti in base ai dati inseriti in _PREFERITI_PRODUCTS_LIST
 */
function preferitiInitProductList() {
	/*
	 for (var i=0; i < _PREFERITI_PRODUCTS_LIST.length; i++){
	 preferitiMenuRenderProduct(_PREFERITI_PRODUCTS_LIST[i]);
	 }
	 if (_PREFERITI_ISCROLL_MENU == null) {
	 _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
	 } else {
	 _PREFERITI_ISCROLL_MENU.refresh();
	 }
	 */
	_PREFERITI_PRODUCTS_LIST = [];

	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_row = p_results.rows.item(i);
				preferitiMenuRenderProduct({
					testata : l_row.testata,
					nome : l_row.testata_descr,
					icon : 'imgs/fake/s24_small_icon.png' // icona indipendente dalla testata
				});
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}

			if (p_results.rows.length > 0) {
				// apro il primo elemento nel menu
				//preferitiLoadArticlesByProduct(p_results.rows.item(0).testata);
				$('#preferiti_body_menu_container_box_id_' + p_results.rows.item(0).testata.replace(/[^a-zA-Z0-9]+/g, '')).click();
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiInitProductList: Error processing SQL: " + p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			var l_query = 'SELECT testata, testata_descr FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' GROUP BY testata, testata_descr ORDER BY testata_descr';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Crea un elemento prodotto nel menu a sinistra della finestra dei preferiti
 * @params p_product Oggetto tag così come presente in _PREFERITI_PRODUCTS_LIST
 */
function preferitiMenuRenderProduct(p_product) {

	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_box';
	box.id = 'preferiti_body_menu_container_box_id_' + p_product.testata.replace(/[^a-zA-Z 0-9]+/g, '');

	box.appendChild(document.createTextNode(p_product.nome));

	var icon = document.createElement('img');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_box_icon';
	icon.src = p_product.icon;

	box.onclick = (function() {
		preferitiLoadArticlesByProduct(p_product.testata);

		$('.preferiti_body_menu_container_box').removeClass('preferiti_body_menu_container_box_active');
		$(this).addClass('preferiti_body_menu_container_box_active');
	});
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei tag attualmente nel database dei preferiti
 */
function preferitiInitTagList() {

	// Inizializza la lista dei tag nel menu di sinistra
	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for (var i = 0; i < p_results.rows.length; i++) {
				preferitiMenuRenderTag(p_results.rows.item(i));
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}

			if (p_results.rows.length > 0) {
				// apro il primo elemento nel menu
				$('#preferiti_body_menu_container_boxtag_id_' + p_results.rows.item(0).nome.replace(/[^a-zA-Z0-9]+/g, '')).click();
			}
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
			//var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM '+_PREFERITI_TAG_DB_NAME+' GROUP BY nome ORDER BY num_articles';
			var l_query = 'SELECT nome FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY nome';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Crea un elemento tag nel menu a sinistra della finestra dei preferiti
 * @params p_tag Oggetto tag così come presente nel db _PREFERITI_TAG_DB_NAME
 */
function preferitiMenuRenderTag(p_tag) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_boxtag';
	box.id = 'preferiti_body_menu_container_boxtag_id_' + p_tag.nome.replace(/[^a-zA-Z0-9]+/g, '');
	box.appendChild(document.createTextNode(p_tag.nome));

	var icon = document.createElement('div');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_boxtag_icon';

	box.onclick = (function() {

		preferitiLoadArticlesByTag(p_tag.nome);

		//Setta il tag attivo nel menu di sinistra
		$('.preferiti_body_menu_container_boxtag').removeClass('preferiti_body_menu_container_boxtag_active');
		$('.preferiti_body_menu_container_boxtag_icon').removeClass('preferiti_body_menu_container_boxtag_icon_active');
		$(this).addClass('preferiti_body_menu_container_boxtag_active');
		var icon = this.querySelector('div.preferiti_body_menu_container_boxtag_icon');
		if (icon != null) {
			$(icon).addClass('preferiti_body_menu_container_boxtag_icon_active');
		}
	});
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
function preferitiOpenArticlesList(p_articles) {
	/*
	 if (_PREFERITI_ISCROLL_VISTA != null) {
	 _PREFERITI_ISCROLL_VISTA.destroy();
	 _PREFERITI_ISCROLL_VISTA = null;
	 }
	 */

	$('#preferiti_body_vista_container').empty();

	for (var i = 0; i < p_articles.length; i++) {
		renderPreferitiArticle(p_articles.item(i));
	}

	if (_PREFERITI_ISCROLL_VISTA == null) {
		_PREFERITI_ISCROLL_VISTA = new iScroll('preferiti_body_vista_wrapper');
	} else {
		_PREFERITI_ISCROLL_VISTA.refresh();
		//alert('aaaaa');
		_PREFERITI_ISCROLL_VISTA.scrollTo(0, -2, 0);
	}
}

/**
 * Passa alla modalità modifica preferiti
 */
function preferitiSwitchToModifyView() {
	$('#preferiti_list_modify_button').hide();
	$('#preferiti_list_show_button').show();
	$('#preferiti_body_vista_container').addClass('preferiti_modify_view');
	$('.preferiti_body_vista_container_box_status').fadeIn();
	$('#elimina_preferiti').fadeIn();

}

/**
 * Passa alla modalità visualizza preferiti
 */
function preferitiSwitchToShowView() {
	$('#preferiti_list_show_button').hide();
	$('#preferiti_list_modify_button').show();
	$('.preferiti_body_vista_container_box_status').fadeOut(function() {
		var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
		l_selected_items.removeClass('preferiti_body_vista_container_box_status_selected');
		l_selected_items.addClass('preferiti_body_vista_container_box_status_unselected');
	});
	$('#preferiti_body_vista_container').removeClass('preferiti_modify_view');
	$('#elimina_preferiti').fadeOut();
}

/******************************************************
 Gestione eliminazione preferiti
 ******************************************************/
/**
 * Elimina i record selezionati in modalità modifica
 */
function preferitiDeleteArticles() {
	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	var l_items = '';

	for (var i = 0; i < l_selected_items.length; i++) {
		var l_pid = l_selected_items[i].id.substring(35);
		if (i > 0)
			l_items += ',';
		l_items += '"' + l_pid + '"';
	}

	if (l_items != '') {
		deletePreferitiFromDB(l_items);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun articolo', 'Preferiti');
	}
}

/*
 * Elimina i record dal database
 * @params p_artids Lista dei identificativi degli articoli
 */
function deletePreferitiFromDB(p_artids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in locale
	if (_DB && p_artids.length > 0) {

		var queryArticleSuccess = function() {
			console.log('Deleted preferiti ' + p_artids);
			deletePreferitiElements();
		}
		var queryTagSuccess = function() {
			console.log('Deleted tags ' + p_artids);
		}
		var queryError = function(p_error) {
			console.log("deletePreferitiFromDB: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryArticleSuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryTagSuccess, queryError);

			//queryArticleSuccess();
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Elimina gli elementi html relativi agli articoli preferiti
 * @params p_pids Lista degli identificativi degli articoli che devono essere eliminati
 */
function deletePreferitiElements() {
	$('.preferiti_body_vista_container_box_status_selected').remove();
}

/******************************************************
 Gestione caricamento preferiti
 ******************************************************/
/*
 * Restituisce gli articoli preferiti presenti nel database locale
 * @params p_testata Identificativo del prodotto
 * @return Lista di articoli
 */
function preferitiLoadArticlesByProduct(p_testata) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_testata) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE testata=?', [p_testata], querySuccess, queryError);
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

/*
 * Restituisce gli articoli preferiti presenti nel database locale in base ad un tag
 * @params p_tag Il nome del tag
 * @return Lista di articoli
 */
function preferitiLoadArticlesByTag(p_tag) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_tag) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}
		var tagQuerySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " tags from the local TAG table.");
			var l_articles = '';
			for (var i = 0; i < p_results.rows.length; i++) {
				if (i > 0)
					l_articles += ',';
				l_articles += '"' + p_results.rows.item(i).artid + '"';
			}
			console.log("Read " + l_articles);

			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid IN (' + l_articles + ')', [], querySuccess, queryError);
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticlesByTag: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			console.log("tag: " + p_tag);
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
			tx.executeSql('SELECT artid FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE nome=?', [p_tag], tagQuerySuccess, queryError);
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {
	//$('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').text(p_article.titolo);
		$('#modifica_articolo_preferito_text').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
		//$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id_tags').val($('#preferiti_body_vista_container_box_tags_span_' + p_article.artid).html());
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for (var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
				}
			}
			var queryError = function(p_error) {
				console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();

	// Salva le modifiche
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
		}
		var updateQuerySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			/*
			 if (p_results.rowsAffected > 0) {
			 document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
			 }
			 */
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);

			var l_tags_array = l_tags.toLowerCase().split(',');
			for (var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, "");
				//TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
			}
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}

	var l_tags_el = document.getElementById('preferiti_body_vista_container_box_tags_span_' + l_artid);
	if (l_tags_el) {
		l_tags_el.innerHTML = l_tags;
	}
	l_tags_el = null;

	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	//$('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

/******************************************************
 Gestione Dettaglio Preferiti
 ******************************************************/
/**
 * Apre il dettaglio dei preferiti
 */
function preferitiDettaglio(p_article) {

	//Inizializzazione dati articolo
	$('#preferiti_dettaglio_titolo').text(p_article.titolo);
	$('#preferiti_dettaglio_occhiello').text(p_article.occhiello);
	$('#preferiti_dettaglio_sottotitolo').text(p_article.sottotitolo);
	$('#preferiti_dettaglio_other_info').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
	$('#preferiti_dettaglio_firma').text(p_article.firma);
	$('#preferiti_dettaglio_text').html(p_article.testo);
	$('#preferiti_dettaglio_header_modifica input').click(function() {
		popupPreferitiUpdateArticle(p_article);
	});

	//$('#preferiti_dettaglio').fadeIn(200, function(){
	$('#preferiti_dettaglio').css('display', 'inline-block');
	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	} else {
		_PREFERITI_ISCROLL_DETTAGLIO = new iScroll('preferiti_dettaglio_wrapper');
	}
	//});

	omnitureTrackApp('APP:preferiti:open:' + p_article.artid, 'APP:preferiti');
}

/**
 * Chiude il dettaglio dei preferiti
 */
function preferitiDettaglioChiudi() {
	//$('#preferiti_dettaglio').fadeOut(200);
	$('#preferiti_dettaglio').css('display', 'none');
}

function preferitiUpdateOrientation() {
	if (_PREFERITI_ISCROLL_VISTA != null) {
		_PREFERITI_ISCROLL_VISTA.refresh();
	}
	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.refresh();
	}
	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	}
}

/**
 * @author ABertacco FSantagada
 */
var _ARCHIVIO_ISOPEN = false;
var _ARCHIVIO_RENDERED_ITEMS = null;
var _PROID = null;
function archivioOpen(p_product_id, isFromSfoglio) {
	_ARCHIVIO_ISOPEN = true;

	_ARCHIVIO_ISOPEN = true;
	_PROID = p_product_id;

	archivioLoad(p_product_id);
	//archivioLoad();
	archivioLoadAdv(p_product_id);

	//Inizializzazione filtro edizioni
	archivioInitFilter();

	$('#archivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#archivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#archivio').fadeIn();
	$('#archivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function archivioClose() {
	//$('#archivio').fadeOut();
	$('#archivio').css('display', 'none');
	if (_ARCHIVIO_ISCROLL != null) {
		_ARCHIVIO_ISCROLL.destroy();
		_ARCHIVIO_ISCROLL = null;
	}
	_ARCHIVIO_ISOPEN = false;
}

function archivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	openFlipper();
}

function archivioLoadAdv(p_product_id) {
	document.getElementById('archivio_footer_adv').innerHTML = '';
	//$('#qarchivio_footer_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom', function(){
	//}).endCapture();
	// http://mobapp24.ilsole24ore.com/adv_proxy.php?z=SFO_INTERSTITIAL&t=S24&d=123

	//*********************DA SOSTITUIRE!!!!!!************************
	$('#archivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
	}).endCapture();
}

function archivioLoadTutti() {
	archivioModificaFine();
	archivioLoadMenu('TUTTI');
}

function archivioLoadAcquisti() {
	archivioLoadMenu('ACQUISTI');
}

function archivioLoadMenu(mode) {
	$('#archivio_subtitolo_opzioni_tutti').removeClass('gray24');
	$('#archivio_subtitolo_opzioni_acquisti').removeClass('gray24');
	if (mode == 'TUTTI') {
		$('#archivio_subtitolo_opzioni_tutti').addClass('gray24');
		$('.archivio_container_box').css('display', 'inline-block');
	} else {
		$('#archivio_subtitolo_opzioni_acquisti').addClass('gray24');
		$('.archivio_container_box_isremote').css('display', 'none');
	}

	archivioUpdateIscroll();
}

var _ARCHIVIO_IS_IN_MODIFICA = false;
function archivioModifica() {
	_ARCHIVIO_IS_IN_MODIFICA = true;
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'inline-block');
	archivioLoadAcquisti();
	$('.archivio_container_box > div > .archivio_button_sfoglia').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_elimina').css('display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('LOCAL');
}

function archivioModificaFine() {
	_ARCHIVIO_IS_IN_MODIFICA = false;
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	archivioLoadAcquisti();
	//alert($('#archivio_wrapper').html());
	$('.archivio_container_box > div > .archivio_button_elimina').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_sfoglia').css('display', 'inline-block');
	$('.archivio_container_box_isremote > div > .archivio_button_acquista').css('display', 'inline-block');
	
	$('#archivio_filtro_edizioni_tempo').val('');
	archivioAggiornaContenutoVisualizzato();
}

var _ARCHIVIO_ISCROLL = null;
function archivioUpdateIscroll() {
	if (!_ARCHIVIO_ISOPEN)
		return;
	setTimeout(function() {
		if (_ARCHIVIO_ISCROLL == null) {
			_ARCHIVIO_ISCROLL = new iScroll('archivio_wrapper', {
				hideScrollbar : false
			});
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		} else {
			_ARCHIVIO_ISCROLL.refresh();
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		}
	}, 100);
}

var _ARCHIVIO_BOXES_INLINE_V = 2;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _ARCHIVIO_BOXES_INLINE_H = 3;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _ARCHIVIO_COUNT = 0;
function archivioLoad(p_product_id) {
	/*
	 $('#archivio_subtitolo_prodotto').html('<div>Azienda Facile</div>');
	 _ARCHIVIO_COUNT = 20;
	 for (var i = 0; i < _ARCHIVIO_COUNT; i++) {
	 var pid = 'pid' + i;
	 //archivio_container
	 var box = document.createElement('div');
	 document.getElementById('archivio_container').appendChild(box);
	 box.className = 'archivio_container_box';

	 var img = document.createElement('img');
	 box.appendChild(img);
	 img.className = 'archivio_container_box_img';
	 img.src = 'imgs/fake/cover_issue_std.png';

	 var txt = document.createElement('div');
	 box.appendChild(txt);
	 txt.className = 'archivio_container_box_txt';

	 var txt_anteprima = document.createElement('div');
	 txt.appendChild(txt_anteprima);
	 txt_anteprima.className = 'button medium lightgray24';
	 txt_anteprima.style['width'] = '100px';
	 txt_anteprima.style['text-align'] = 'center';
	 txt_anteprima.appendChild(document.createTextNode('Anteprima'));
	 txt_anteprima.onclick = (function(pid){
	 return function(){
	 popupAnteprimaArchivioOpen(pid);
	 }
	 })(pid);
	 txt_anteprima = null;

	 if (i % 5 == 0) {
	 // se issue già presente in locale
	 var txt_sfoglia = document.createElement('div');
	 txt.appendChild(txt_sfoglia);
	 txt_sfoglia.className = 'button medium gray24';
	 txt_sfoglia.style['width'] = '100px';
	 txt_sfoglia.style['text-align'] = 'center';
	 txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	 txt_sfoglia = null;
	 }
	 else {
	 // se issue non presente in locale
	 var txt_acquista = document.createElement('div');
	 txt.appendChild(txt_acquista);
	 txt_acquista.className = 'button medium red24';
	 txt_acquista.style['width'] = '100px';
	 txt_acquista.style['text-align'] = 'center';
	 txt_acquista.appendChild(document.createTextNode('0,79 €'));
	 txt_acquista = null;
	 }

	 var txt_titolo = document.createElement('div');
	 txt.appendChild(txt_titolo);
	 txt_titolo.className = 'archivio_container_box_txt_titolo';
	 txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	 txt_titolo = null;

	 var txt_subtitolo = document.createElement('div');
	 txt.appendChild(txt_subtitolo);
	 txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	 txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	 txt_subtitolo = null;

	 var txt_descrizione = document.createElement('div');
	 txt.appendChild(txt_descrizione);
	 txt_descrizione.className = 'archivio_container_box_txt_descrizione';
	 txt_descrizione.appendChild(document.createTextNode('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin sit amet urna lorem, eu aliquam elit.'));
	 txt_descrizione = null;

	 txt = null;
	 img = null;
	 box = null;

	 }

	 archivioUpdateIscroll();

	 archivioLoadMenu('TUTTI');*/
	$('#archivio_container').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_ARCHIVIO_RENDERED_ITEMS = {};

	console.log('---REQ---> past-issues/' + p_product_id);
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> past-issues/' + p_product_id);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				archivioLoad(p_product_id);
			})) {
				var res = p_response.Result.res;

				_ARCHIVIO_PRODUCT = res;

				archivioRenderItems();

				for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
					var l_single_offers = _ARCHIVIO_PRODUCT.items[i].singleOffers;
					if (l_single_offers == null)
						continue;
					for (var j = 0; j < l_single_offers.length; j++) {
						//appstoreReqProduct(l_single_offers[j].offerId, l_single_offers[j].offerItunesProductId);
					}
				}
				//appstoreReqProducts();
			} else {
				console.log('archivioLoad: Error, ' + p_response.Exception.Description);
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_ARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				archivioRenderItems();
			}
		},
		error : function() {
			abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
			_ARCHIVIO_PRODUCT = {
				items : [],
				testata : _MAP_CODICE_TESTATA['' + p_product_id]
			};
			archivioRenderItems();
		}
	});

}

var _ARCHIVIO_LOCAL_ITEMS;
var _ARCHIVIO_LOCAL_ITEMS_ISSUE;
function archivioRenderItems() {
	_ARCHIVIO_LOCAL_ITEMS = [];
	_ARCHIVIO_LOCAL_ITEMS_ISSUE = [];
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioRenderItems: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				_ARCHIVIO_LOCAL_ITEMS.push(l_item_id);
				_ARCHIVIO_LOCAL_ITEMS_ISSUE.push(l_local_item.testata + '_' + l_local_item.issue);
			}

			archivioRenderItems_aux();
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function archivioRenderItems_aux() {
	console.log('archivioRenderItems...');
	console.log(_ARCHIVIO_LOCAL_ITEMS);

	_ARCHIVIO_RENDERED_ITEMS = {};
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId];
	console.log(_EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId]);
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#archivio_titolo_prodotto').text(l_product_details.name);

	//var l_sole_count_per_cover = 0;
	for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
		for (var j = 0; j < _ARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
			var l_item_id = _ARCHIVIO_PRODUCT.testata + '_' + _ARCHIVIO_PRODUCT.items[i].editionId + '_' + _ARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

			//if (_ARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
			//	l_sole_count_per_cover++;

			if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
				_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
				//archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, i < 30);
			}
		}
	}

	archivioLoadLocalData();
}

function archivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	console.log('archivioRenderAsIcon');

	archivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var item_full_id = _ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	var isLocal = $.inArray(item_full_id, _ARCHIVIO_LOCAL_ITEMS) != -1;
	var isLocalFree = $.inArray(_ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId, _ARCHIVIO_LOCAL_ITEMS_ISSUE) != -1;

	var l_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0) ? true : false;

	//console.log(item_full_id + ' ' + isLocal + ' ' + isLocalFree);

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_edizione_' + p_item.inserts[p_insert_index].insertId;
	//box.id = 'archivio_container_box_' + p_insert_index + '_' + p_item.editionId;
	box.id = 'archivio_container_box_' + item_full_id;
	//box.style['display'] = 'none';

	//console.log(item_full_id + "   " + (isLocal ? "LOCAL" : "REMOTE"));

	$(box).addClass( isLocal ? 'archivio_container_box_islocal' : 'archivio_container_box_isremote');

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = p_item.inserts[p_insert_index].cover;

	if (l_premium) {
		var premiumflag = document.createElement('img');
		imgdiv.appendChild(premiumflag);
		premiumflag.className = 'archivio_container_box_img_div_premiumflag';
		premiumflag.src = 'imgs/inserto_abbonati_archivio.png';
		//premiumflag.innerHTML = 'Inserto per abbonati';
	}

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	/*
	 var txt_anteprima = document.createElement('div');
	 txt.appendChild(txt_anteprima);
	 txt_anteprima.className = 'button medium gray24';
	 txt_anteprima.style['width'] = '100px';
	 txt_anteprima.style['text-align'] = 'center';
	 txt_anteprima.appendChild(document.createTextNode('Anteprima'));
	 txt_anteprima.onclick = (function(pid){
	 return function(){
	 popupAnteprimaArchivioOpen(pid);
	 }
	 })(pid);
	 txt_anteprima = null;
	 */

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	if (screen.width > 790)
		txt_elimina.style['width'] = '100px';
	else
		txt_elimina.style['width'] = '60px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		//eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	//if (isLocal) {
	// se issue già presente in locale
	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	if (screen.width > 790)
		txt_sfoglia.style['width'] = '100px';
	else
		txt_sfoglia.style['width'] = '60px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_sfoglia.style.display = isLocal ? 'inline-block' : 'none';
	txt_sfoglia = null;
	/*
	}
	else {
	*/
	// se issue non presente in locale
	var l_prezzo = "";
	if (p_item.free || p_item.subscription || (p_item.singleOffers && (p_item.singleOffers.length > 0))) {
		var txt_acquista = document.createElement('div');
		txt.appendChild(txt_acquista);
		txt_acquista.className = 'button medium red24 archivio_button_acquista';
		if (screen.width > 790)
			txt_acquista.style['width'] = '100px';
		else
			txt_acquista.style['width'] = '60px';
		txt_acquista.style['text-align'] = 'center';
		//txt_acquista.appendChild(document.createTextNode('0,79 €'));

		if (l_premium && (!p_item.subscription) && (!p_item.free)) {
			txt_acquista.innerHTML = 'Per abbonati';
			$(txt_acquista).bind('click', function() {
				mostraPopupInsertoAbbonati();
			});
		} else {

			if (p_item.free || p_item.subscription || isLocalFree) {
				txt_acquista.innerHTML = 'Sfoglia';
				$(txt_acquista).bind('click', function() {
					//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
					sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
				});
			} else {
				//txt_acquista.innerHTML = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				l_prezzo = "<br />" + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				txt_acquista.innerHTML = 'Seleziona';
				$(txt_acquista).bind('click', function() {
					//acquistoSingolo(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);

					var link_singola = '';
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
						//_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola'
						if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
						}
					}
					// prova con i link

					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
							}
						}
					}

					//alert('aaaa');
					//alert('link: '+link_singola);
					//alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
					if (link_singola != '') {
						window.payment.paySingle(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId, link_singola);
						console.log('offerItunesProductId ' + p_item.singleOffers[0].offerItunesProductId);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				});
			}
		}
		txt_acquista.style.display = !isLocal ? 'inline-block' : 'none';
		txt_acquista = null;
	}
	//}

	// ATTENZIONE:  solo per test
	//p_item.inserts[p_insert_index].anteprima = 5;
	if ((!isLocalFree) && (!p_item.free) && (!p_item.subscription) && p_item.inserts[p_insert_index].anteprima && (parseInt(p_item.inserts[p_insert_index].anteprima) > 0)) {
		var txt_anteprima = document.createElement('div');
		txt.appendChild(txt_anteprima);
		txt_anteprima.className = 'button medium gray24 archivio_button_anteprima';
		txt_anteprima.style['text-align'] = 'center';
		txt_anteprima.appendChild(document.createTextNode('Anteprima'));
		$(txt_anteprima).bind('click', function() {
			openAnteprima(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, parseInt(p_item.inserts[p_insert_index].anteprima));
		});
		/*
		 txt_anteprima.onclick = (function(pid){
		 return function(){
		 popupAnteprimaArchivioOpen(pid);
		 }
		 })(pid);
		 */
		txt_anteprima = null;
	}

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	//VERIFICA!!!!*************************************
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.inserts[p_insert_index].description;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	//txt_subtitolo.innerHTML = p_item.editionDescription;
	txt_subtitolo.innerHTML = p_item.editionDescription + (!(isLocal || isLocalFree) ? l_prezzo : "");
	txt_subtitolo = null;

	if (isLocal) {
		var l_localdiv = document.createElement('img');
		txt.appendChild(l_localdiv);
		l_localdiv.className = 'archivio_container_box_txt_local_ICONS';
		l_localdiv.style.paddingLeft = '10px';
		l_localdiv.src = 'imgs/qarchivio_locale_flag.png';
		l_localdiv = null;
	}

	/*
	var txt_descrizione = document.createElement('div');
	txt.appendChild(txt_descrizione);
	txt_descrizione.className = 'archivio_container_box_txt_descrizione';
	txt_descrizione.appendChild(document.createTextNode('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin sit amet urna lorem, eu aliquam elit.'));
	txt_descrizione = null;
	*/
	/* NUOVO COMMENTO VERIFICA ******************************************************
	var descr = document.createElement('div');
	box.appendChild(descr);
	descr.className = 'archivio_container_box_txt_descr';*/
	//descr.appendChild(document.createTextNode('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin sit amet urna lorem, eu aliquam elit.'));
	//descr.innerHTML = p_item.inserts[p_insert_index].description;
	/* NUOVO COMMENTO VERIFICA*******************************************************
	 descr.appendChild(txt_titolo);
	 descr.appendChild(txt_subtitolo);
	 txt_titolo = null;
	 txt_subtitolo = null;
	 descr = null;*/

	txt = null;
	box = null;

}

function archivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;
				//console.log(l_item_id);

				if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					archivioRenderLocalAsIcon(l_local_item);

				}

			}

			archivioLoadTutti();
			setTimeout(function() {
				$('#archivio_loading').css('display', 'none');
			}, 500);
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

function archivioRenderLocalAsIcon(p_item) {
	console.log('archivioRenderLocalAsIcon');

	archivioUpdateFilter(p_item.edizione, p_item.edizione_descr);

	var item_full_id = p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	var isLocal = true;

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_container_box_islocal archivio_edizione_' + p_item.edizione;
	box.id = 'archivio_container_box_' + item_full_id;

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//???? DA VERIFICARE******************************

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	/*
	 var txt_anteprima = document.createElement('div');
	 txt.appendChild(txt_anteprima);
	 txt_anteprima.className = 'button medium gray24';
	 txt_anteprima.style['width'] = '100px';
	 txt_anteprima.style['text-align'] = 'center';
	 txt_anteprima.appendChild(document.createTextNode('Anteprima'));
	 txt_anteprima.onclick = (function(pid){
	 return function(){
	 popupAnteprimaArchivioOpen(pid);
	 }
	 })(pid);
	 txt_anteprima = null;
	 */

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['width'] = '100px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['width'] = '100px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_sfoglia.style.display = 'inline-block';
	txt_sfoglia = null;

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.edizione_descr;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	txt_subtitolo.innerHTML = p_item.issue_descr;
	txt_subtitolo = null;

	/*
	 var txt_descrizione = document.createElement('div');
	 txt.appendChild(txt_descrizione);
	 txt_descrizione.className = 'archivio_container_box_txt_descrizione';
	 txt_descrizione.appendChild(document.createTextNode('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin sit amet urna lorem, eu aliquam elit.'));
	 txt_descrizione = null;
	 */

	txt = null;
	box = null;

}

var _ARCHIVIO_FILTRO_EDIZIONI = null;
function archivioInitFilter() {
	var l_filtro_tempo_select = $('#archivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_ARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#archivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	//var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);

}

function archivioUpdateFilter(p_edizione_id, p_edizione_descr) {
	if (jQuery.inArray(p_edizione_id, _ARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_ARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		var l_option = $('<option></option>');
		l_option.val(p_edizione_id);
		l_option.text(p_edizione_descr.replace('&igrave;', 'ì').replace('&#39;', '\''));
		$('#archivio_filtro_edizioni').append(l_option);
	}
}

function archivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#archivio_filtro_edizioni_tempo option:selected');

	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
			$('#archivio_container .archivio_container_box_islocal').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#archivio_container .archivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}
	}

	setTimeout(archivioUpdateIscroll, 100);
}

/*
function popupAnteprimaArchivioOpen(pid) {
$('#archivio_dettaglio_body').empty();

var txt_titolo = document.createElement('div');
document.getElementById('archivio_dettaglio_body').appendChild(txt_titolo);
txt_titolo.className = 'archivio_dettaglio_body_titolo';
txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
txt_titolo = null;

var txt_subtitolo = document.createElement('div');
document.getElementById('archivio_dettaglio_body').appendChild(txt_subtitolo);
txt_subtitolo.className = 'archivio_dettaglio_body_subtitolo';
txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
txt_subtitolo = null;

var txt_imgdiv = document.createElement('div');
document.getElementById('archivio_dettaglio_body').appendChild(txt_imgdiv);
txt_imgdiv.className = 'archivio_dettaglio_body_cover';
var txt_imgdiv_img = document.createElement('img');
txt_imgdiv.appendChild(txt_imgdiv_img);
txt_imgdiv_img.src = 'imgs/fake/cover_issue_std.png';
txt_imgdiv_img = null;
txt_imgdiv = null;

var txt_acquisto = document.createElement('div');
document.getElementById('archivio_dettaglio_body').appendChild(txt_acquisto);
txt_acquisto.className = 'archivio_dettaglio_body_acquisto';
var txt_acquisto_btn = document.createElement('div');
txt_acquisto.appendChild(txt_acquisto_btn);
txt_acquisto_btn.className = 'button red24';
txt_acquisto_btn.appendChild(document.createTextNode('0,79 €'));
txt_acquisto_btn = null;
txt_acquisto = null;

var txt_descrizione = document.createElement('div');
document.getElementById('archivio_dettaglio_body').appendChild(txt_descrizione);
txt_descrizione.className = 'archivio_dettaglio_body_descrizione';
txt_descrizione.appendChild(document.createTextNode('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin sit amet urna lorem, eu aliquam elit. Donec lobortis nunc vitae felis euismod dignissim. Nam nulla sem, consectetur eu blandit tincidunt, molestie a sapien. Etiam dapibus nisi eget quam tempus rutrum. Nullam quis velit arcu. Donec gravida libero eget metus ullamcorper volutpat.'));
txt_descrizione = null;

//$('#archivio_dettaglio').fadeIn();
$('#archivio_dettaglio').css('display', 'inline');
}

function popupAnteprimaArchivioClose() {

//$('#archivio_dettaglio').fadeOut();
$('#archivio_dettaglio').css('display', 'none');
}
*//**
 * @author ABertacco
 */
var _QARCHIVIO_ISOPEN = false;
var _QARCHIVIO_MODE = 'ICONS';
var _QARCHIVIO_RENDERED_ITEMS = null;

var _QARCHIVIO_DEFAULT_EDIZIONE = 'SOLE';

var _PROID = null;

function qarchivioOpen(p_product_id, isFromSfoglio, defaultEdizione) {
	_QARCHIVIO_ISOPEN = true;
	_QARCHIVIO_DEFAULT_EDIZIONE = (defaultEdizione == null ? 'SOLE' : defaultEdizione);
	console.log('p_product_id ' + p_product_id);
	$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'hidden');

	_PROID = p_product_id;
	//alert('aaa'+_PROID);
	qarchivioLoad('ICONS', p_product_id);
	qarchivioLoadAdv(p_product_id);
	//$('#qarchivio').fadeIn();

	$('#qarchivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#qarchivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_loading').css('display', 'inline-block');
	$('#qarchivio').css('display', 'inline');
	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

	if ((window.innerWidth < 790 || window.innerWidth == 1024) && $$('myRichselect1') == null && $$('myRichselect2') == null) {
		try {
			$("#qarchivio_filtro_edizioni").hide();
			$("#qarchivio_filtro_edizioni_tempo").hide();

		} catch(exc) {
			alert(exc.message);
		}
	}

}

function qarchivioClose() {
	//$('#qarchivio').fadeOut();
	$('#qarchivio').css('display', 'none');
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}
	_QARCHIVIO_ISOPEN = false;
}

function sfogliaArchivio(p_testata, p_issue, p_edizione) {
	var keyinput = "unread_message_sole";
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}

	if ( typeof (window.localStorage) != 'undefined') {
		window.localStorage.setItem(keyinput, valoutput);
	} else {
		throw "window.localStorage, not defined";
	}

	window.loader.launchSfogliatore(p_testata, p_edizione, p_issue, "Descrizione" + valoutput);

}

function qarchivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	//openFlipper();
	console.log("closesfoglia");
	/*
	 _CURRENT_FLIPPER_TESTATA = p_testata;
	 _CURRENT_FLIPPER_ISSUE = p_issue;
	 _CURRENT_FLIPPER_EDIZIONE = p_edizione;
	 _CURRENT_FLIPPER_PAGINA = p_pagina;
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	try {
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
		qarchivioClose();
		setTimeout(function() {
			console.log("launch page " + _CURRENT_FLIPPER_PAGINA);
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			//window.go.to(_CURRENT_FLIPPER_PAGINA);

		}, 1500);
	} catch(exc) {
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}
}

function qarchivioLoadAdv(p_product_id) {
	document.getElementById('qarchivio_footer_adv').innerHTML = '';
	//'http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
	$('#qarchivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function() {
	}).endCapture();
}

function updateRichBtn() {
	if (window.innerWidth < 790 || window.innerWidth == 1024) {
		if (_ORIENTATION == 'V') {
			$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_el_richselect").css({
				'width' : '120px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_inp_list").css({
				'width' : '90px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_el_richselect").css({
				'width' : '100px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_inp_list").css({
				'width' : '70px'
			});

			if (window.innerWidth >= 600 || window.innerWidth == 1024) {
				$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_el_richselect").css({
					'width' : '140px'
				});
				$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_inp_list").css({
					'width' : '130px'
				});
				$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_el_richselect").css({
					'width' : '130px'
				});
				$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_inp_list").css({
					'width' : '120px'
				});
			}
		} else {
			$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_el_richselect").css({
				'width' : '200px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_el_richselect").css({
				'width' : '200px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container1 .dhx_inp_list").css({
				'width' : '170px'
			});
			$("#qarchivio_subtitolo_opzioni_select_container2 .dhx_inp_list").css({
				'width' : '170px'
			});
		}
	}
}

var _QARCHIVIO_ISCROLL = null;
function qarchivioUpdateIScroll() {
	//updateRichBtn();
	if (!_QARCHIVIO_ISOPEN)
		return;
	if (_QARCHIVIO_ISCROLL == null) {
		_QARCHIVIO_ISCROLL = new iScroll('qarchivio_wrapper', {
			hideScrollbar : false
		});
	} else {
		_QARCHIVIO_ISCROLL.refresh();
		_QARCHIVIO_ISCROLL.scrollTo(0, -2, 0);
	}
}

function qarchivioLoad(mode, p_product_id) {
	console.log("qarchivioLoad p_product_id: " + p_product_id);

	// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
	if (_QARCHIVIO_IS_IN_MODIFICA)
		qarchivioVisualizza(true);

	$('#qarchivio_loading').css('display', 'inline-block');
	/*
	 setTimeout(function(){
	 $('#qarchivio_loading').css('display', 'none');
	 },1000);
	 */
	if (mode) {
		_QARCHIVIO_MODE = mode;
	} else {
		if (_QARCHIVIO_MODE == null) {
			_QARCHIVIO_MODE = 'ICONS';
		}
	}

	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}

	$('#qarchivio_container').empty();
	$('#qarchivio_subtitolo_opzioni_vista1').removeClass('qarchivio_subtitolo_opzioni_vista1_on');
	$('#qarchivio_subtitolo_opzioni_vista2').removeClass('qarchivio_subtitolo_opzioni_vista2_on');

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_QARCHIVIO_RENDERED_ITEMS = {};

	if (p_product_id && p_product_id != '') {

		//Inizializzazione filtro edizioni
		qarchivioInitFilter();

		console.log('---REQ---> past-issues/' + p_product_id);
		console.log(l_request_headers);
		console.log(l_request_data);

		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
			headers : l_request_headers,
			data : l_request_data,
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> past-issues/' + p_product_id);
				console.log(p_response);

				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, function() {
					qarchivioLoad(mode, p_product_id);
				})) {
					var res = p_response.Result.res;

					_QARCHIVIO_PRODUCT = res;

					qarchivioRenderItems();
				} else {
					console.log('qarchivioLoad: Error, ' + p_response.Exception.Description);
					abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
					_QARCHIVIO_PRODUCT = {
						items : [],
						testata : _MAP_CODICE_TESTATA['' + p_product_id]
					};
					qarchivioRenderItems();
				}
			},
			error : function() {
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_QARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				qarchivioRenderItems();
			}
		});
		//$$('myrichselect1').value = $('#qarchivio_filtro_edizioni option:selected').val();

	} else {
		//_QARCHIVIO_PRODUCT = { items: [], testata: _MAP_CODICE_TESTATA[''+p_product_id] };
		qarchivioRenderItems();
	}
	//alert('aaa '+$('#qarchivio_filtro_edizioni option:selected').val());
	if ($$('myRichselect1') != null) {
		$$('myRichselect1').setValue($('#qarchivio_filtro_edizioni option:selected').val());
	}
}

function qarchivioRenderItems() {
	console.log('qarchivioRenderItems...');
	_QARCHIVIO_RENDERED_ITEMS = {};
	//$('#qarchivio_titolo_prodotto').text(_QARCHIVIO_PRODUCT.productDescription);
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_QARCHIVIO_PRODUCT.productId];
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#qarchivio_titolo_prodotto').text(l_product_details.name);

	if (_QARCHIVIO_MODE == 'ICONS') {
		// modalità vista icone
		$('#qarchivio_subtitolo_opzioni_vista1').addClass('qarchivio_subtitolo_opzioni_vista1_on');

		var l_sole_count_per_cover = 0;

		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (_QARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
					l_sole_count_per_cover++;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsIcon(_QARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				}
			}
		}
		console.log('prima di qarchivioLoadLocalData');
		qarchivioLoadLocalData();
	} else {
		console.log("qarchivioRenderItems LIST");
		// modalità vista lista
		$('#qarchivio_subtitolo_opzioni_vista2').addClass('qarchivio_subtitolo_opzioni_vista2_on');

		qarchivioRenderItems_List_aux();
	}

	if (window.innerWidth < 790 || window.innerWidth == 1024)
		updateRichFilter();
}

function qarchivioRenderItems_List_aux() {
	console.log('qarchivioRenderItems_List_aux...' + _QARCHIVIO_PRODUCT.items.length);
	try {
		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsList(_QARCHIVIO_PRODUCT.items[i], j);
				}
			}
		}

		qarchivioLoadLocalData();
	} catch (exc) {
		console.log("qarchivioRenderItems_List_aux::error: " + exc.message);
	}
}

var _CURRENT_QUEUE_LIST;
function downloadManagerCallbackQueueList(p_queue) {
	console.log('downloadManagerCallbackQueueList...');
	_CURRENT_QUEUE_LIST = p_queue;
	qarchivioRenderItems_List_aux();
	return "OK";
}

function isInQueueList(testata, issue, edizione) {
	//console.log('isInQueueList?');
	//console.log(testata + ' ' + issue + ' ' + edizione);
	if (_CURRENT_QUEUE_LIST == null)
		return false;
	for (var i = 0; i < _CURRENT_QUEUE_LIST.length; i++) {
		var l_item = _CURRENT_QUEUE_LIST[i];
		//console.log(l_item.testata + ' ' + l_item.issue + ' ' + l_item.edizione);
		if ((l_item.testata == testata) && (l_item.issue == issue) && (l_item.edizione == edizione)) {
			return true;
		}
	}
	return false;
}

/**
 * Crea la rappresentazione di un arretrato come icona
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24') && (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var img_div = document.createElement('div');
	box.appendChild(img_div);
	img_div.className = 'qarchivio_container_box_img_div';
	img_div.id = 'qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	if (createCoverImg) {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = p_item.inserts[p_insert_index].cover;
	} else {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = 'imgs/fake/fake_cover.jpg';
	}

	if (p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0)) {
		var premium_flag = document.createElement('img');
		img_div.appendChild(premium_flag);
		premium_flag.src = 'imgs/inserto_abbonati_archivio.png';
		premium_flag.className = 'qarchivio_container_box_img_div_premiumflag';
	}

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
		}
	});
	checkLocalArretrato(p_item, p_insert_index);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	//txt.appendChild(document.createTextNode(p_item.editionTitle));
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong><br />' + p_item.editionDescription;
	//p_item.editionTitle;
}

/**
 * Crea la rappresentazione di un arretrato come lista
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsList(p_item, p_insert_index) {
	console.log('qarchivioRenderAsList');
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong> ' + p_item.editionDescription;
	//p_item.editionTitle;
	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	btndiv.id = 'qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	btn.type = 'button';
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'qarchivio_hidden_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);

	checkLocalArretrato(p_item, p_insert_index);

}

/******************************************************
 Gestione caricamento arretrati salvati in locale
 ******************************************************/
/**
 * Carica gli articoli salvati in locale
 */
function qarchivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("qarchivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					if (_QARCHIVIO_MODE == 'ICONS') {
						qarchivioRenderLocalAsIcon(l_local_item);
					} else {
						console.log("NO ICONS");
						qarchivioRenderLocalAsList(l_local_item);
					}
				}

				qarchivioUpdateFilter(l_local_item.edizione, l_local_item.edizione_descr);
			}

			//Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#qarchivio_filtro_edizioni').change();

			setTimeout(function() {
				//$('#qarchivio_container').css('visibility', 'hidden');
				$('#qarchivio_loading').css('display', 'none');
				//$('#qarchivio_container').css('visibility', 'visible');
				$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'visible');
				window.simulate.redraw();
			}, 500);

			setTimeout(function() {
				if (_QARCHIVIO_ISCROLL != null) {
					_QARCHIVIO_ISCROLL.refresh();
					_QARCHIVIO_ISCROLL.scrollTo(0, -2, 0);
				}
			}, 550);
			/*
			 setTimeout(function(){
			 window.scrollTo(0,0);
			 },560);
			 */

		}
		var queryError = function(p_error) {
			console.log("qarchivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_QARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un arretrato in locale come icona
 * @params p_item Arretrato in locale come salvato nel db issues
 */
function qarchivioRenderLocalAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'qarchivio_container_box_img_div';
	$(img_div).click(function() {
		if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			console.log("sfoglia LIST archivio");
			//window.loader.local(true);
		}
	});
	box.appendChild(img_div);

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	var img = document.createElement('img');
	img_div_crop.appendChild(img);
	img.className = 'qarchivio_container_box_img';
	//ANDROID MODDED
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
		}
	});

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	//txt.appendChild(document.createTextNode(p_item.issue_descr));
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong><br />' + p_item.issue_descr;
	//box.style['display'] = 'block';

}

/**
 * Crea la rappresentazione in lista di un arretrato salvato in locale
 * @params p_item Arretrato in locale come salvato nel db issues
 *
 */
function qarchivioRenderLocalAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + +p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
		console.log("sfoglia LIST archivio");
		window.loader.local(true);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);
}

/******************************************************
 Gestione filtro
 ******************************************************/
function qarchivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#qarchivio_filtro_edizioni_tempo option:selected');
	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#qarchivio_container .qarchivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}

	}

	setTimeout(qarchivioUpdateIScroll, 100);
}

/**
 * Inizializza il filtro sulle edizioni da mostrare.
 */
var _QARCHIVIO_FILTRO_EDIZIONI = null;
function qarchivioInitFilter() {
	var l_filtro_tempo_select = $('#qarchivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});
	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_QARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#qarchivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});

	//var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);
	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	//l_option = $('<option value="SOLE" selected="selected">Il Sole 24 Ore</option>');

	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore") + '" selected="selected">Il Sole 24 Ore</option>');
	l_filtro_edizioni_select.append(l_option);
	//_QARCHIVIO_FILTRO_EDIZIONI.push("SOLE", "Il Sole 24 Ore");
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore"), "Il Sole 24 Ore");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore"),
		label : "Il Sole 24 Ore"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);
	/*
	 l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore lunedì") + '" selected="selected">Il Sole 24 Ore lunedì</option>');
	 l_filtro_edizioni_select.append(l_option);
	 _QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore lunedì"), "Il Sole 24 Ore lunedì");

	 row = {
	 value : qarchivioLabelToValue("Il Sole 24 Ore lunedì"),
	 label : "Il Sole 24 Ore lunedì"
	 };
	 console.log('rich ' + row.value + ',' + row.label);
	 _QARCHIVIOFILTRORICH.push(row);
	 */
	l_filtro_edizioni_select.append($('<optgroup label="Altre testate" id="qarchivio_filtro_edizioni_optgroup"></optgroup>'));
}

function qarchivioLabelToValue(p_label) {
	//return p_label.toLowerCase(p_label.replace(/[^a-zA-Z0-9]/g,'x'));
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

/**
 * Gestisce la creazione del filtro sulle edizioni da mostrare.
 * @params p_edizione_id Identificativo dell'edizione
 *         p_edizione_descr descrizione dell'edizione
 */
function qarchivioUpdateFilter(p_edizione_id, p_edizione_descr) {

	if (jQuery.inArray(qarchivioLabelToValue(p_edizione_descr), _QARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue(p_edizione_descr), p_edizione_descr);
		var row = {
			value : qarchivioLabelToValue(p_edizione_descr),
			label : p_edizione_descr
		};
		_QARCHIVIOFILTRORICH.push(row);
		var l_option = $('<option></option>');
		l_option.val(qarchivioLabelToValue(p_edizione_descr));
		l_option.html(p_edizione_descr);
		$('#qarchivio_filtro_edizioni_optgroup').append(l_option);
	}

	if (_QARCHIVIO_DEFAULT_EDIZIONE == p_edizione_id) {
		$('#qarchivio_filtro_edizioni').val(qarchivioLabelToValue(p_edizione_descr));
	}
}

_QARCHIVIOFILTRORICH = new Array();
function updateRichFilter() {

	if ((window.innerWidth < 790 || window.innerWidth == 1024) && $$('myRichselect2') == null) {

		var arr1 = [{
			value : 1,
			label : "Tutti i prodotti"
		}, {
			value : 2,
			label : "Il Sole 24 Ore lunedì"
		}, {
			value : 3,
			label : "Altre testate"
		}];

		dhtmlx_listProductsSelect = arr1;
		var value_select = 0;

		var value_select = $('#qarchivio_filtro_edizioni option:selected').val();

		var dhtmlx_listProductsSelect1 = _QARCHIVIOFILTRORICH;
		dhx.ui({
			view : "richselect",
			id : "myRichselect1",
			container : 'qarchivio_subtitolo_opzioni_select_container1',
			label : '',
			popupWidth : 320,
			value : value_select,
			width : '150',
			yCount : "5",
			options : dhtmlx_listProductsSelect1
		});

		$$('myRichselect1').attachEvent("onchange",
		function(newv, oldv) {
			setTimeout(function() {
				if (oldv != newv) {

					$('#qarchivio_filtro_edizioni option:selected').removeAttr('selected');

					if (newv.indexOf('Tutti i prodotti') == -1) {
						$("#qarchivio_filtro_edizioni option[value='" + newv + "']").attr('selected', 'selected');
					} else {
						$("#qarchivio_filtro_edizioni option[value='']").attr('selected', 'selected');
					}

					console.log('changed');
					qarchivioAggiornaContenutoVisualizzato();
				}
			}, 200);

		});

		var arr1 = [{
			value : 1,
			label : "Ultimo mese"
		}, {
			value : "LOCAL",
			label : "Il mio archivio"
		}];

		dhtmlx_listProductsSelect1 = arr1;
		var value_select = 1;

		dhx.ui({
			view : "richselect",
			id : "myRichselect2",
			container : 'qarchivio_subtitolo_opzioni_select_container2',
			label : '',
			popupWidth : 220,
			value : value_select,
			width : '150',
			options : dhtmlx_listProductsSelect1
		});

		$$('myRichselect2').attachEvent("onchange",
		function(newv, oldv) {
			setTimeout(function() {
				if (oldv != newv) {
					$('#qarchivio_filtro_edizioni_tempo option:selected').removeAttr('selected');
					$("#qarchivio_filtro_edizioni_tempo option[value='" + newv + "']").attr('selected', 'selected');
					console.log('changed');
					qarchivioAggiornaContenutoVisualizzato();
				}
			}, 200);

		});

		updateRichBtn();
	}
}

/*
 * Controlla se un arretrato sia stato scaricato in locale
 * @params p_item Arretrato
 *         p_insert_index Indice dell'inserto
 */
function checkLocalArretrato(p_item, p_insert_index) {

	var l_testata = _QARCHIVIO_PRODUCT.testata;
	var l_issue = p_item.editionId;
	var l_edizione = p_item.inserts[p_insert_index].insertId;
	var l_edizione_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0);

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length <= 0)
				return;

			var l_query_result = p_results.rows.item(0);

			if (l_query_result.in_locale > 0) {
				$('#qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId).addClass('qarchivio_container_box_isinlocal');
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
			} else {
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE;
			}

			if (_QARCHIVIO_MODE == 'LIST') {
				var btn = document.getElementById('qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
					btn.value = 'Sfoglia';
					$(btn).click(function() {
						sfoglia(l_testata, l_issue, l_edizione);
						window.loader.local(true);
					});

					var del_btn = document.getElementById('qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
					del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
				} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
					// copia con download in corso
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					renderDownloadQueue(l_testata, l_issue, l_edizione);
				} else {
					if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
						if ((!p_item.subscription) && l_edizione_premium) {
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							btn.value = 'Solo per abbonati';
							$(btn).unbind();
							$(btn).bind('click', function() {
								mostraPopupInsertoAbbonati();
							});
						} else {
							// copia gratuita
							btn.className = 'button medium gray24 qarchivio_free_copy_btn';
							btn.value = 'Salva in locale';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ADD1 TO QUEUE " + l_testata + " " + l_issue + " " + l_edizione);
								addToDownloadQueue(l_testata, l_issue, l_edizione);
							});
						}
					} else if (l_edizione_premium) {
						btn.className = 'button medium red24 qarchivio_buy_copy_btn';
						btn.value = 'Solo per abbonati';
						$(btn).unbind();
						$(btn).bind('click', function() {
							mostraPopupInsertoAbbonati();
						});
					} else {
						if (p_item.single && (p_item.singleOffers.length > 0)) {
							// acquisto
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							//btn.value = 'Acquista ' + p_item.singleOffers[0].offerPrice + ' €';
							//btn.value = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
							btn.value = 'Seleziona';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ACQUISTO " + l_testata + " " + l_issue + " " + l_edizione);
								acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
							});
						} else {
							var btndiv = document.getElementById('qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
							btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
							btndiv.style['position'] = 'relative';
							btndiv.style['margin-right'] = '30px';
							btndiv.style['margin-top'] = '10px';
						}
					}
				}
			} else if (_QARCHIVIO_MODE == 'ICONS') {

				var icon = document.getElementById('qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					$(icon).click(function() {
						if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (_QARCHIVIO_PRODUCT.free || l_query_result.da_scaricare > 0) {
				if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
					// copia gratuita
					$(icon).click(function() {
						//scarica(l_testata, l_issue, l_edizione);
						if ((!p_item.subscription) && l_edizione_premium) {
							sfogliaCheckPremium(l_testata, l_issue, l_edizione);
						} else {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (p_item.subscription == false && p_item.single) {
				if (l_edizione_premium) {
					$(icon).click(function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					if (p_item.single && (p_item.singleOffers.length > 0)) {
						// acquisto
						$(icon).click(function() {
							acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
						});
					}
				}

			}
		}
		//try{
		var queryError = function(p_error) {
			console.log("checkLocalArretrato: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			var l_query = 'select * from (select count(*) as in_locale, 1 as id from issues where testata=? and issue=? and edizione=?) as a inner join (select count(*) as da_scaricare, 1 as id from issues where testata=? and issue=?) as b on (a.id = b.id)';
			tx.executeSql(l_query, [l_testata, l_issue, l_edizione, l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Passa alla modalità modifica
 */
var _QARCHIVIO_IS_IN_MODIFICA = false;
var _QARCHIVIO_PRE_MODIFICA_TEMPO = '';
function qarchivioModifica() {
	console.log("modifica");
	_QARCHIVIO_IS_IN_MODIFICA = true;
	$('#qarchivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#qarchivio_subtitolo_opzioni_visualizza').css('display', 'inline-block');

	$('#qarchivio_container').addClass('qarchivio_modify');

	_QARCHIVIO_PRE_MODIFICA_TEMPO = $('#qarchivio_filtro_edizioni_tempo').val();
	$('#qarchivio_filtro_edizioni_tempo').val("LOCAL");
	qarchivioAggiornaContenutoVisualizzato();

}

/**
 * Passa alla modalità visualizza
 */
function qarchivioVisualizza(light) {
	_QARCHIVIO_IS_IN_MODIFICA = false;
	$('#qarchivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	$('#qarchivio_subtitolo_opzioni_visualizza').css('display', 'none');

	$('#qarchivio_container').removeClass('qarchivio_modify');

	if (light == true)
		return;

	$('#qarchivio_filtro_edizioni_tempo').val(_QARCHIVIO_PRE_MODIFICA_TEMPO);
	qarchivioAggiornaContenutoVisualizzato();

	gestisciProssimaAzione();
	// <-- PERCHE'???

}

/**
 * @author ABertacco, MConventi
 */
var _USER_DEVICES = [];
var _IMPOSTAZIONI_MENU_ISCROLL = null;
var _IMPOSTAZIONI_VISTA_ISCROLL = null;

var _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};

function impostazioniInizializza() {

	if (_EDICOLA_USE_CATEGORIES) {

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts4Impostazioni");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts4Impostazioni");
				console.log(p_response);
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;

					_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};
					for (var i = 0; i < res.products.length; i++) {
						var pid = res.products[i].productId;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;
						if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "storeplus") {
							_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = "store";
							_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type_original'] = "storeplus";
						}
					}

					impostazioniInizializza_aux();

				}

			}
		});

	} else {
		_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = _EDICOLA_PRODUCTS_DETAILS;
		impostazioniInizializza_aux();
	}

}

function impostazioniInizializza_aux() {
	//Inizializza la lista dei prodotti disponibili
	inizializzaImpostazioniProdotti();
	// lista prodotti in select per selezione prodotto principale
	inizializzaListaProdottoPrincipale();

	// carico informativa privacy
	impostazioniLoadInformativaPrivacy();

}

var _IMPOSTAZIONI_ISCROLL_PRIVACY = null;
function impostazioniLoadInformativaPrivacy() {
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		url : 'http://du.ilsole24ore.com/utenti/Privacy.html',
		success : function(p_response) {
			if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
				_IMPOSTAZIONI_ISCROLL_PRIVACY.destroy();
				_IMPOSTAZIONI_ISCROLL_PRIVACY = null;
			}

			document.getElementById('informativa_privacy_body_container').innerHTML = p_response;

			// _IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
		},
		error : function() {

		}
	});
}

//corregge padding nel caso di monitor 10''
function adjustPadding() {
	//alert('aaaaaaa');
	if ((window.innerWidth > 790 && window.innerWidth < 900) || window.innerWidth > 1270) {
		$('#impostazioni_body_menu_container_box_generali').css('paddingLeft', '15px');
		$('#impostazioni_body_menu_container_box_codicepromozionale').css('paddingLeft', '15px');
		$('#impostazioni_body_menu_container_box_help').css('paddingLeft', '15px');
	}
}

function impostazioniOpen() {
	//alert('aaaaa');
	impostazioniInizializza();
	var l_impostazioni_current = $('.impostazioni_body_menu_container_box_active');
	//alert($('#impostazioni_prodotto_principale_select').html());
	//if (l_impostazioni_current.length == 0)
	impostazioniOpenGenerali();

	//aggiusto 10''
	adjustPadding();

}

function impostazioniVistaClose(event) {
	event.stopPropagation();

	$('#impostazioni_body_vista_wrapper').removeClass('impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').removeClass('impostazioni_body_vista_active');

	$('.impostazioni_body_menu_container_box_active').removeClass('impostazioni_body_menu_container_box_active');
}

function impostazioniInitOpen(menu, title) {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL = null;
	}

	$('#impostazioni_body_vista_wrapper').addClass('impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').addClass('impostazioni_body_vista_active');

	//$('#impostazioni_titolo_vista_back_button').css('display', 'none');
	$('#impostazioni_body_vista_container > div').css('display', 'none');
	$('.impostazioni_body_menu_container_box').removeClass('impostazioni_body_menu_container_box_active');
	$('#' + menu).addClass('impostazioni_body_menu_container_box_active');
	if (title.length > 22 && screen.width < 790)
		document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title.substring(0, 22) + "...";
	else
		document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title;

	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span><span style="left: -8px; position: relative;">Impostaz.</span>');
	l_back_button.unbind('click');
	l_back_button.click(impostazioniVistaClose);

}

function impostazioniUpdateOrientation() {
	if (_IMPOSTAZIONI_MENU_ISCROLL != null) {
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}

	if (_IMPOSTAZIONI_HELP_LOADED)
		hlpCreaLinea();

	$('#impostazioni_body_vista_container_generali_profilo').css({
		position : 'relative',
		left : ($('#impostazioni_body_vista_wrapper').width() - $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth()) / 2
	});

	$('#impostazioni_body_vista_container_codicepromozionale').children().each(function(i) {
		$(this).css({
			position : 'relative',
			left : ($('#impostazioni_body_vista_wrapper').width() - $(this).outerWidth()) / 2
		});
	});

}

function impostazioniOpenGenerali() {
	impostazioniInitOpen('impostazioni_body_menu_container_box_generali', 'Generali');

	// informazioni sul profilo utente
	inizializzaAgganciaProfilo();

	// memoria disponibile
	if (( typeof device != "undefined") && (device.usedspace != null) && (device.usedspaceperc != null))
		$('#impostazioni_body_vista_container_generali_memoria_value').html(device.usedspace + ' (' + device.usedspaceperc + ')');

	// carico informazioni sulle versioni
	$('#impostazioni_body_vista_container_generali_info_versione_app').text(device.appversion);
	$('#impostazioni_body_vista_container_generali_info_device_id').text(device.uuid);
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : true,
		url : 'VERSION',
		success : function(p_response) {
			$('#impostazioni_body_vista_container_generali_info_versione_gui').text(p_response);
		},
		error : function() {
			$('#impostazioni_body_vista_container_generali_info_versione_gui').text('---');
		}
	});

	$('#impostazioni_body_vista_container_generali').css('display', 'inline-block');

	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}

	omnitureTrackApp('APP:impostazioni:generali', 'APP:impostazioni');
}

/**
 * Inizializza la sezione di "Aggancia profilo" nelle impostazioni generali
 */
function inizializzaAgganciaProfilo() {
	if (_MOD_OFFLINE) {
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
		//alert('aaa'+_MOD_OFFLINE);
		return;
	}

	//Se l'utente ha effettuato la login viene mostrato il pulsante per accedere al profilo
	if (_USERNAME) {
		//alert('aaa'+_USERNAME);
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_profilo_value').text(_USERNAME);
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'inline-block');

		$('#impostazioni_body_vista_container_generali_profilo').css({
			position : 'relative',
			left : ($('#impostazioni_body_vista_wrapper').width() - $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth()) / 2
		});

		//alert($('#impostazioni_body_vista_wrapper').width()+','+ $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth());
	} else {
		//alert('aaa');
		// Altrimenti viene mostrato il pulsante per aprire il popup per la login
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'inline-block');
	}
}

IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = null
function impostazioniGeneraliRegistrazione() {
	//console.log("REGISTRAZIONE 2");
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupImpostazioniRegistratiDone;

	if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	//console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is "+IMP_ACQUISTO_REGISTRAZIONE_ISCROLL)

}

function impostazioniCodicePromoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	_NEXT_ACTION = popupCodicePromoRegistratiDone;
}

function impostazioniProdottoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupProdottoRegistratiDone;
}

function popupImpostazioniRegistrati() {
	//_NEXT_ACTION = popupImpostazioniRegistratiDone;
	popupRegistrazioneApri();
}

function popupImpostazioniRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}

function popupCodicePromoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenCodicePromozionale();
}

function popupProdottoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}

/******************************************************
 Gestione impostazioni codice promozionale
 ******************************************************/
/**
 * Apre la sezione delle impostazioni per l'attivazione di un codice promozionale
 * Nel caso in cui l'utente non sia autenticato viene richiesta la login o la registrazione
 */
function impostazioniOpenCodicePromozionale() {
	impostazioniInitOpen('impostazioni_body_menu_container_box_codicepromozionale', 'Codice promozionale');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'inline-block');
	} else {
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'inline-block');

	}
	$('#impostazioni_body_vista_container_codicepromozionale').css('display', 'inline-block');

	$('#impostazioni_body_vista_container_codicepromozionale').children().each(function(i) {
		$(this).css({
			position : 'relative',
			left : ($('#impostazioni_body_vista_wrapper').width() - $(this).outerWidth()) / 2
		});
	});
	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}

	omnitureTrackApp('APP:impostazioni:codice_promo', 'APP:impostazioni');
}

/**
 * Esegue la chiamata per l'attivazione di un codice promozionale
 */
function impostazioniOpenCodicePromozionaleAvanti() {
	var l_codice_promozionale = $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice #codice_promozionale').val();
	console.log('Sending the promotional code ' + l_codice_promozionale);

	if (l_codice_promozionale && l_codice_promozionale != '') {
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform,
			"username" : _USERNAME//,
			//"promo_code": l_codice_promozionale
		};
		console.log('---REQ---> promo-code');
		console.log(l_req_headers);
		console.log(l_req_data);
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Richiesta in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);

		$.ajax({
			type : "POST",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			//url: _SOLEGW_ENDPOINT + "promo-code.json",
			url : _SOLEGW_ENDPOINT + "promo/" + l_codice_promozionale + ".json",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> promo-code');
				console.log(p_response);

				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, impostazioniOpenCodicePromozionaleAvanti)) {
					abutils.alert('La tua promozione è stata attivata con successo', 'Codice promozionale');
				} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
					if (p_response.Exception.Description) {
						abutils.alert(p_response.Exception.Description, 'Codice promozionale');
					} else {
						abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale.', 'Codice promozionale');
					}
				}
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			},
			error : function() {
				abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale. Riprovare tra poco.', 'Codice promozionale');
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		});
	} else {
		abutils.alert('Attenzione, inserire un codice promozionale', 'Codice promozionale');
	}
}

var _IMPOSTAZIONI_HELP_LOADED = false;
var hlpTabsScr, hlpContScr, hlpFaqScr, strOr, hlpGlobNav;
function hlpNav(hli) {
	$('#hlp_tbs2_scroll .tbon').removeClass("tbon");
	$('#hlp_tbs2_scroll .hlp_tb:eq(' + hli + ')').addClass("tbon");
	$('#hlp_tot div[class^=hlp_slide]:visible').fadeOut(200);
	$('#hlp_cont_scroll > div:eq(' + hli + ')').delay(200).fadeIn(200);
	setTimeout(function() {
		hlpContScr.refresh();
		hlpCreaLinea();
	}, 410);
}

function hlpCreaLinea() {
	console.log('hlpCreaLinea()');
	console.log(window.orientation);
	/*verticale o orizzontale*/
	if ( typeof window.orientation != "undefined") {
		strOr = Math.abs(window.orientation) == 90 ? "l" : "p";
	} else {//temp non ipad
		strOr = window.innerWidth > window.innerHeight ? "l" : "p";
	}
	if (strOr == "l") {
		$('#hlp_mail').html('Desideri assistenza specifica? Contatta il Servizio Clienti all\'indirizzo <a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	} else {
		$('#hlp_mail').html('Contatta il Servizio Clienti:<br><a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	}
	if (hlpFaqScr != null)
		hlpFaqScr.refresh();
	setTimeout(function() {
		$("#hlp_cont_scroll canvas:visible").each(function(index, element) {
			var $c = $(this);
			var c = $(this)[0];
			$c.width(Number($c.data(strOr + "w")));
			$c.height(Number($c.data(strOr + "h")) + 15);
			c.width = Number($c.data(strOr + "w"));
			c.height = Number($c.data(strOr + "h") + 15);
			$c.css({
				'left' : "-" + c.width + "px",
				'top' : "-" + (c.height - 15) + "px"
			});
			var cxt = c.getContext("2d");
			cxt.strokeStyle = '#FF0000';
			cxt.lineWidth = 2;
			cxt.lineCap = 'round';
			cxt.moveTo(1, 1);
			cxt.lineTo(c.width - 7, c.height - 2);
			cxt.stroke();
		});
	}, 10);
}

function impostazioniOpenHelp() {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL == null;
	}

	impostazioniInitOpen('impostazioni_body_menu_container_box_help', 'Help');
	console.log('PASSS HELP');
	//window.location = 'ipad_help.html';
	/*
	 $('div').ajaxError(function(event, request, settings){
	 alert("Error requesting page " + settings.url );
	 });*/
	if (!_IMPOSTAZIONI_HELP_LOADED) {
		// carico il contenuto via ajax
		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : true,
			url : "ipad_help.html",
			success : function(p_response) {
				try {
					console.log('ipad_help.html letto');
					$('#impostazioni_body_vista_container_help_content').html(p_response);
					//console.log('asdadadasdasdas');
					$('#impostazioni_body_vista_container_help').css('display', 'inline-block');

					// ATTENZIONE ---> evento di aggiornamento in impostazioniUpdateOrientation
					console.log('carico help');

					$('#hlp_tbs2_scroll .hlp_tb').click(function(e) {
						e.preventDefault();
						if (!$(this).hasClass('tbon')) {
							var hli = $(this).index();
							hlpNav(hli);
						}
					});

					hlpNav(0);
					hlpTabsScr = new iScroll('hlp_tbs2', {
						snap : "a",
						hScrollbar : false
					});
					hlpContScr = new iScroll('hlp_cont', {
						vScrollbar : false
					});
					hlpFaqScr = new iScroll('hlp_faq', {
						vScrollbar : false
					});

					$('#hlp_faq').hide(0);

					$('#hlp_tbs1 .hlp_tb').click(function(e) {
						if (hlpGlobNav != $(this).data('nav')) {
							hlpGlobNav = $(this).data('nav');
							$('#hlp_tbs1 .hlp_tb').toggleClass("tbon");
							$('#hlp_glob_switch > div[id^=hlp_]').hide(0);
							hlpFaqScr.refresh();
							$('#hlp_glob_switch > #hlp_' + hlpGlobNav).fadeIn(300, function() {
								if (hlpGlobNav == "faq") {
									hlpFaqScr.refresh();
								}
							});
						}
					});
				} catch (exc) {
					console.log(exc.message);
				}

				_IMPOSTAZIONI_HELP_LOADED = true;
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				/*
				 * readyState
				 * status
				 * statusText
				 * responseXML and/or responseText when the underlying request responded with xml and/or text, respectively
				 * setRequestHeader(name, value) which departs from the standard by replacing the old value with the new one rather than concatenating the new value to the old one
				 * getAllResponseHeaders()
				 * getResponseHeader()
				 * abort()
				 */
				console.log("Error status :" + textStatus);
				console.log("Error type :" + errorThrown);
				console.log("Error message :" + XMLHttpRequest.status);
			}
		});
	}

	$('#impostazioni_body_vista_container_help').css('display', 'inline-block');

	/* lo fa il codice dell'help
	 if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
	 _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
	 }
	 else {
	 _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	 }
	 */

	omnitureTrackApp('APP:impostazioni:help', 'APP:impostazioni');
}

/******************************************************
 Gestione prodotto principale
 ******************************************************/
/**
 * Inizializza la lista dei prodotti tra i quali poter scegliere per selezionare il prodotto principale.
 */
function inizializzaListaProdottoPrincipale() {

	// Ottenere il prodotto principale da local storage
	var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
	var l_prodotto_principale_descr = window.localStorage.getItem("prodotto_principale_descr");

	var l_impostazioni_prodotto_principale_select = $('#impostazioni_prodotto_principale_select');
	l_impostazioni_prodotto_principale_select.empty();
	l_impostazioni_prodotto_principale_select.append($('<option value="">Nessun prodotto principale</option>'));

	//alert('_EDICOLA_PRODUCTS_DETAILS1: ' + _EDICOLA_PRODUCTS_DETAILS);
	/*
	 for (var key in _EDICOLA_PRODUCTS_DETAILS) {
	 if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {

	 var l_option = $('<option></option>');
	 l_option.val(_EDICOLA_PRODUCTS_DETAILS[key].productId);
	 l_option.text(_EDICOLA_PRODUCTS_DETAILS[key].name);
	 if (_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
	 l_option.attr('selected', 'selected');
	 }

	 l_impostazioni_prodotto_principale_select.append(l_option);

	 }
	 }*/
	for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {

			var l_option = $('<option></option>');
			l_option.val(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId);
			l_option.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
				l_option.attr('selected', 'selected');
			}

			l_impostazioni_prodotto_principale_select.append(l_option);

		}
	}

	if ((window.innerWidth < 790 || window.innerWidth == 1024) && $$('myRichselect') == null) {
		try {
			$("#impostazioni_prodotto_principale_select").hide();

			dhtmlx_listProductsSelect = [{
				value : 1,
				label : "Nessun prodotto principale"
			}, {
				value : 2,
				label : "Two"
			}, {
				value : 3,
				label : "Three"
			}];
			var arr1 = [{
				value : 1,
				label : "Nessun prodotto principale"
			}];
			//alert('_EDICOLA_PRODUCTS_DETAILS: ' + _EDICOLA_PRODUCTS_DETAILS);
			for (var key in _EDICOLA_PRODUCTS_DETAILS) {
				if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
					var obj = {
						value : _EDICOLA_PRODUCTS_DETAILS[key].productId,
						label : _EDICOLA_PRODUCTS_DETAILS[key].name
					};
					arr1.push(obj);
				}
			}

			dhtmlx_listProductsSelect = arr1;
			var value_select = 0;
			if (window.localStorage.getItem("prodotto_principale_id") != '' && window.localStorage.getItem("prodotto_principale_id") != null)
				value_select = window.localStorage.getItem("prodotto_principale_id");
			else
				value_select = 1;

			//var value_select_s = "'"+value_select+"'";
			//if ($$('myRichselect')) $$('myRichselect').destructor();
			
			dhx.ui({
				view : "richselect",
				id : "myRichselect",
				container : 'impostazioni_prodotto_principale_select_container',
				label : '',
				popupWidth : 320,
				value : value_select,
				iconCss : 'dhx_list_icon2',
				width : '36',
				options : dhtmlx_listProductsSelect
			});
			$('.dhx_inp_list').css('width', '90%');

			$("#impostazioni_prodotto_principale_select_container .dhx_inp_list").css({
				'background-color' : '#EFEFEF'
			});
			$("#impostazioni_prodotto_principale_select_container .dhx_el_box").css({
				'background-color' : '#EFEFEF'
			});

			$$('myRichselect').attachEvent("onchange",
			function(newv, oldv) {
				setTimeout(function() {
					//alert(oldv+';'+newv);
					$('#impostazioni_prodotto_principale_select option:selected').removeAttr('selected');
					$("#impostazioni_prodotto_principale_select option[value='" + newv + "']").attr('selected', 'selected');
					impostazioniProdottoPrincipaleSelectOnChange(newv);
				}, 200);
			});
			//alert($('body .dhx_window').css('left')+','+$('body .dhx_window').css('width'));
		} catch(exc) {
			alert(exc.message);
		}
	}
}

function impostazioniProdottoPrincipaleSelectOnChange(value) {
	var l_prodotto_principale_descr = $('#impostazioni_prodotto_principale_select option[value="' + value + '"]').text();
	window.localStorage.setItem("prodotto_principale_id", value);
	window.localStorage.setItem("prodotto_principale_descr", l_prodotto_principale_descr);
	//alert(value + ' - ' + l_prodotto_principale_descr);
}

/******************************************************
 Gestione impostazioni prodotti
 ******************************************************/
/**
 * Inizializza la lista dei prodotti nel pannello delle impostazioni
 */
function inizializzaImpostazioniProdotti() {
	var l_lista_prodotti_container = $('#impostazioni_body_menu_container_box_lista_prodotti');
	l_lista_prodotti_container.empty();
	/*
	 for (var key in _EDICOLA_PRODUCTS_DETAILS) {
	 if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
	 var pbox = $('<div></div>');
	 pbox.addClass('impostazioni_body_menu_container_box');
	 pbox.addClass('impostazioni_body_menu_container_box_prodotto');
	 pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
	 pbox.text(_EDICOLA_PRODUCTS_DETAILS[key].name);
	 pbox.bind('click', (function(p_key){
	 return function(){
	 impostazioniOpenProdotto(_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _EDICOLA_PRODUCTS_DETAILS[p_key].name);
	 }
	 })(key));
	 l_lista_prodotti_container.append(pbox);

	 //alert('aaa_ '+_EDICOLA_PRODUCTS_DETAILS[key].icon);

	 var img = document.createElement('img');
	 img.className = 'impostazioni_body_menu_container_box_icon';
	 img.src = _EDICOLA_PRODUCTS_DETAILS[key].icon;//'imgs/fake/s24_small_icon.png';
	 pbox.append(img);
	 img = null;

	 pbox = null;

	 }
	 }*/
	for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
			var pbox = $('<div></div>');
			pbox.addClass('impostazioni_body_menu_container_box');
			pbox.addClass('impostazioni_body_menu_container_box_prodotto');
			pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
			pbox.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			pbox.bind('click', (function(p_key) {
				return function() {
					impostazioniOpenProdotto(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].name);
				}
			})(key));
			l_lista_prodotti_container.append(pbox);

			var img = document.createElement('img');
			img.className = 'impostazioni_body_menu_container_box_icon';
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == _CODICE_PRODOTTO_QUOTIDIANO)
				img.src = 'imgs/fake/s24_small_icon.png';
			else
				img.src = _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].icon;
			pbox.append(img);
			img = null;

			pbox = null;

		}
	}

	if (_IMPOSTAZIONI_MENU_ISCROLL == null) {
		_IMPOSTAZIONI_MENU_ISCROLL = new iScroll('impostazioni_body_menu_wrapper', {
			bounce : false
		});
	} else {
		// aggiorno iscroll
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
}

/**
 * Apre il pannello di impostazioni di un prodotto
 * @params p_product_id Il codice del prodotto
 *         p_product_description La descrizione del prodotto
 */
function impostazioniOpenProdotto(p_product_id, p_product_description) {
	impostazioniInitOpen('impostazioni_body_menu_container_box_' + p_product_id, p_product_description);

	$('#cartaceo_codice_abbonato').val('');
	$('#cartaceo_cap').val('');
	$('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'none');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_prodotto_login').css('display', 'none');
		$('#impostazioni_body_vista_container_prodotto_info').css('display', 'inline');
		impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
	} else {
		$('#impostazioni_body_vista_container_prodotto_info').css('display', 'none');
		$('#impostazioni_body_vista_container_prodotto_login').css('display', 'inline-block');
		_NEXT_ACTION = function() {
			impostazioniOpenProdotto(p_product_id, p_product_description);
		}
	}

	$('#impostazioni_body_vista_container_prodotto').css('display', 'inline-block');

	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
	}

	omnitureTrackApp('APP:impostazioni:prodotto:' + p_product_id, 'APP:impostazioni');
}

/**
 * Carica le info sull'abbonamento
 */
function impostazioniProdottoCaricaInfoAbbonamento(p_product_id) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + p_product_id);
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + p_product_id + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription/' + p_product_id);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					//if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}

				if (l_attivo) {
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Attivo');
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text(l_date_end.format('dd/mm/yyyy'));
				} else {
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Non Attivo');
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
					/*
					 if (p_product_id == _CODICE_PRODOTTO_QUOTIDIANO) {
					 $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'inline-block');
					 }
					 */
					if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
						_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
					} else {
						_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
							bounce : false
						});
					}

				}

			} else {
				$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('---');
				$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
			}
		},
		error : ajaxErrorHandler
	});
}

/******************************************************
 Gestione impostazioni profilo
 ******************************************************/
/**
 * Apre il popup contenente le informazioni sul profilo utente
 */
var _IMPOSTAZIONI_PROFILO_ISCROLL = null;
var _IMPOSTAZIONI_PROFILO_INITIALIZED = false;
function popupImpostazioniProfilo() {

	window.location = 'http://du.ilsole24ore.com/utenti/areautente/ilmioprofilo.aspx';

	return;

	if (!_IMPOSTAZIONI_PROFILO_INITIALIZED) {
		//Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
		$('#impostazioni_profilo #id_email_address').unbind();
		$('#impostazioni_profilo #id_email_address').keyup(controlloSezioneConsensoEmail);
		//Inizializzazione campo data
		$('#id_birthdate').scroller({
			showOnFocus : false,
			theme : 'ios',
			mode : 'scroller',
			startYear : 1910
		});
		$('#id_birthdate').click(function() {
			$('#id_birthdate').scroller('show');
			return false;
		});
		_IMPOSTAZIONI_PROFILO_INITIALIZED = true;
	}

	$('#impostazioni_profilo').css('display', 'inline');
	$('#impostazioni_profilo_menu').css('display', 'none');

	//Inizializza i dati del profilo utente
	inizializzaProfilo();
}

/**
 * In base alla presenza dell'email mostra i campi per il consenso della privacy
 */
function controlloSezioneConsensoEmail() {
	if ($('#impostazioni_profilo #id_email_address').val() != '') {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeIn(200, function() {
			if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
				_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
					bounce : false
				});
			} else {
				_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
			}
		});
	} else {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeOut(200, function() {
			if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
				_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
					bounce : false
				});
			} else {
				_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
			}
		});
	}
}

/**
 * Inizializza i dati del profilo dell'utente che sta utilizzando l'applicativo
 */
var _PROFILE_FIELDS = [{
	id : 'email_address',
	type : 'text'
}, {
	id : 'ConsensoPrivacy',
	type : 'checkbox'
}, {
	id : 'ConsensoSocieta',
	type : 'checkbox'
}, {
	id : 'ConsensoMail',
	type : 'checkbox'
}, {
	id : 'first_name',
	type : 'text'
}, {
	id : 'last_name',
	type : 'text'
}, {
	id : 'birth_year',
	type : 'text'
}, {
	id : 'birth_month',
	type : 'text'
}, {
	id : 'birth_day',
	type : 'text'
}, {
	id : 'gender',
	type : 'select'
}, {
	id : 'address_street',
	type : 'text'
}, {
	id : 'city',
	type : 'text'
}, {
	id : 'provincia',
	type : 'text'
}, {
	id : 'state',
	type : 'text'
}, {
	id : 'zip_code',
	type : 'text'
}, {
	id : 'tel_number',
	type : 'text'
}, {
	id : 'mobile_phone',
	type : 'text'
}, {
	id : 'fax_number',
	type : 'text'
}, {
	id : 'societa_ente',
	type : 'text'
}, {
	id : 'professione',
	type : 'text'
}, {
	id : 'settore',
	type : 'text'
}, {
	id : 'codice_fiscale',
	type : 'text'
}, {
	id : 'partita_iva',
	type : 'text'
}];

function inizializzaProfilo() {
	console.log('Get profilo info for user ' + _USERNAME);

	$('#impostazioni_profilo #id_username').text(_USERNAME);

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};

	var l_req_data = {
		"username" : _USERNAME
	};

	console.log('---REQ---> getUserProfile');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserProfile",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getUserProfile');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, inizializzaProfilo)) {
				//Per tutti i campi definiti in _PROFILE_FIELDS vengono inizializzati i valori nel popup di impostazioni profilo
				for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
					//Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
					var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
					//Se l'elemento html esiste
					if (l_html_element) {
						//In base al tipo di elemento viene inizializzato il valore
						if (_PROFILE_FIELDS[i].type == 'text') {
							if (p_response.Result[_PROFILE_FIELDS[i].id]) {
								l_html_element.val(p_response.Result[_PROFILE_FIELDS[i].id]);
							} else {
								l_html_element.val('');
							}
						}

						if (_PROFILE_FIELDS[i].type == 'checkbox') {
							if (p_response.Result[_PROFILE_FIELDS[i].id]) {
								if (p_response.Result[_PROFILE_FIELDS[i].id] == '0') {
									l_html_element.attr('checked', false);
								} else if (p_response.Result[_PROFILE_FIELDS[i].id] == '1') {
									l_html_element.attr('checked', true);
								}
							} else {
								l_html_element.attr('checked', false);
							}

							l_html_element.change();
						}

						if (_PROFILE_FIELDS[i].type == 'select') {
							$('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').removeAttr('selected');
							l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option[value=' + p_response.Result[_PROFILE_FIELDS[i].id] + ']');
							l_html_element.attr('selected', 'selected');
						}
					}
				}
				//Inizializzazione campo data di nascita
				if (p_response.Result['birth_day'] && p_response.Result['birth_month'] && p_response.Result['birth_year']) {
					$('#id_birthdate').scroller('setDate', new Date(p_response.Result['birth_month'] + '/' + p_response.Result['birth_day'] + '/' + p_response.Result['birth_year']), true);
				}

				controlloSezioneConsensoEmail();
			}
			/*
			 else {
			 //Gestione eccezioni
			 //TODO
			 alert('Attenzione, ' + p_response.Exception.Description);
			 }
			 */
		},
		error : ajaxErrorHandler
	});
}

/**
 * Salva i dati del profilo
 */
function popupImpostazioniProfiloAvanti() {
	if (controlloDatiProfilo()) {

		// Definizione del profilo utente
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : _USERNAME,
			"disclaimer" : "1"
		};

		var l_user_email = $('#impostazioni_profilo #id_email_address').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#impostazioni_profilo #id_ConsensoMail').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#impostazioni_profilo #id_ConsensoSocieta').attr('checked') == "checked" ? '1' : '0');
		}

		//Imposta la data di nascita
		var l_birthdate = $('#id_birthdate').scroller('getDate');
		$('#impostazioni_profilo #id_birth_day').val(l_birthdate.getDate());
		$('#impostazioni_profilo #id_birth_month').val(l_birthdate.getMonth() + 1);
		$('#impostazioni_profilo #id_birth_year').val(l_birthdate.getFullYear());

		//Per tutti i campi definiti in _PROFILE_FIELDS vengono letti i nuovi valori dal popup di impostazioni profilo
		for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
			if (!(_PROFILE_FIELDS[i].id in {
				email_address : 1,
				ConsensoPrivacy : 1,
				ConsensoMail : 1,
				ConsensoSocieta : 1
			})) {
				//Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
				var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
				//Se l'elemento html esiste
				if (l_html_element) {
					//In base al tipo di elemento viene settato il nuovo valore
					if (_PROFILE_FIELDS[i].type == 'text') {
						l_user_profile[_PROFILE_FIELDS[i].id] = l_html_element.val();
					}

					if (_PROFILE_FIELDS[i].type == 'checkbox') {
						l_user_profile[_PROFILE_FIELDS[i].id] = (l_html_element.attr('checked') == "checked" ? '1' : '0');
					}
					if (_PROFILE_FIELDS[i].type == 'select') {
						l_user_profile[_PROFILE_FIELDS[i].id] = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').val();
					}
				}
			}
		}

		console.log('updateUserProfile call for ' + _USERNAME + ': ' + l_user_profile);

		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"profile" : l_user_profile
		};
		console.log('---REQ---> updateUserProfile');
		console.log(l_req_headers);
		console.log(l_req_data);

		$.ajax({
			type : "POST",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/updateUserProfile",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> updateUserProfile');
				console.log(p_response);

				if (checkAjaxResponse(p_response, popupImpostazioniProfiloAvanti)) {
					//Chiudi popup
					popupImpostazioniProfiloChiudi();
				} else {
					//Gestione messaggi di errore dal server
					if (p_response.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Attenzione, uno o più campi inseriti non sono validi.', 'Aggiornamento profilo')
					} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
						abutils.alert(p_response.Exception.Description, 'Aggiornamento profilo');
					}
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				/*
				 console.log('ajax error');
				 console.log(textStatus);
				 alert('Funzione non disponibile in assenza di connessione');
				 */
			}
		});
	}
}

/**
 * Controlla che i dati del profilo siano stati immessi correttamente
 */
function controlloDatiProfilo() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

	// Controllo email
	email = $('#impostazioni_profilo #id_email_address').val();
	if (email == '') {
		abutils.alert("Attenzione, inserire un indirizzo email valido.", 'Profilo utente');
		return false;
	}
	if (email != '' && !ck_email.test(email)) {
		abutils.alert("Attenzione, l'indirizzo email inserito non è valido.", 'Profilo utente');
		return false;
	}

	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked')) {
		abutils.alert("Attenzione, per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Profilo utente');
		return false;
	}

	return true;
}

/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloChiudi() {
	//$('#impostazioni_profilo').fadeOut();
	$('#impostazioni_profilo').css('display', 'none');
}

/******************************************************
 Gestione popup di account menu
 ******************************************************/
/**
 * Apre il popup contenente il menu delle azioni riguardanti il profilo utente
 * Da tale menu l'utente potrà:
 *   - Visualizzare informazioni del proprio profilo
 *   - Disassociare il proprio account
 */
function popupImpostazioniProfiloMenu() {
	//alert('is '+$('#impostazioni_prodotto_principale_select'));
	$('#impostazioni_prodotto_principale_select').attr('disabled', 'true');
	$('#impostazioni_profilo_menu_account_username').text(_USERNAME);
	$('#impostazioni_profilo_menu').css('display', 'inline');
}

/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloMenuChiudi() {
	//$('#impostazioni_profilo_menu').fadeOut();
	//alert('is '+$('#impostazioni_prodotto_principale_select').attr());
	$('#impostazioni_prodotto_principale_select').removeAttr('disabled');
	$('#impostazioni_profilo_menu').css('display', 'none');

}

/******************************************************
 Gestione pannello lista dispositivi
 ******************************************************/
/**
 * Apre la sezione per la gestione dei dispositivi associati all'utente
 */
function impostazioniGeneraliDispositivi() {
	$('#impostazioni_body_vista_container_dispositivi_lista').css('display', 'none');
	$('#impostazioni_body_vista_container_generali').css('display', 'none');
	$('#impostazioni_body_vista_container_dispositivi').css('display', 'inline-block');

	//Inizializza il pulsante di ritorno verso le impostazioni generali
	/*
	 var l_back_button = $('#impostazioni_titolo_vista_back_button');
	 l_back_button.html('<span></span>Generali');
	 l_back_button.css('display', 'inline-block');
	 l_back_button.click(impostazioniGeneraliDispositiviChiudi);
	 */
	$('#impostazioni_titolo_vista_txt').text('Dispositivi');

	inizializzaListaDispositivi();
}

/**
 * Ottiene dal server la lista dei dispositivi associati all'utente ed inizializza la sezione
 */
function inizializzaListaDispositivi() {

	if (_USERNAME) {
		//console.log('Get devices for user ' + _USERNAME);
		var l_section_body = $('#impostazioni_body_vista_container_dispositivi_lista');
		l_section_body.empty();

		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"username" : _USERNAME
		};
		console.log('---REQ---> getUserDevices');
		console.log(l_req_headers);
		console.log(l_req_data);

		//Ottengo i dispositivi associati all'utenza in base alle info date da API24
		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/getUserDevices",
			headers : l_req_headers,
			data : l_req_data,
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> getUserDevices');
				console.log(p_response);

				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, inizializzaListaDispositivi)) {
					//p_response.Result.res = [{"id":"1234567890","name":"Questo device","type":1},{"id":"222","name":"Device 2","type":2},{"id":"333","name":"Device 3","type":3}]; //TODO PER DEBUG
					for (var i = 0; i < p_response.Result.res.length; i++) {
						var l_device = p_response.Result.res[i];

						//I dispositivi associati vengono memorizzati in una variabile globale
						_USER_DEVICES[l_device.id] = l_device;

						//Viene creato l'elemento nella lista dei dispositivi
						var l_device_element_container = $('<div></div>');
						l_device_element_container.addClass('impostazioni_body_vista_container_label');
						if (l_device["name"] != '')
							l_device_element_container.html(decodeURIComponent(l_device["name"]) + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
						else
							l_device_element_container.html("Dispositivo senza nome" + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");

						if (l_device.id != device.uuid) {
							var l_device_element_button = $('<div></div>');
							l_device_element_button.addClass("button medium red24 impostazioni_body_vista_container_label_button");
							l_device_element_button.text("Disassocia");
							l_device_element_button.attr("onclick", '_NEXT_ACTION=impostazioniGeneraliDispositivi;popupDisassociaDispositivo("' + l_device.id + '")');

							/*
							 if(screen.width < 790){
							 l_device_element_button.width('30px');
							 }*/

							l_device_element_container.append(l_device_element_button);
						}
						/*
						 if(screen.width < 790){
						 l_device_element_container.width('10px');
						 }*/

						l_section_body.append(l_device_element_container);
					}
					l_section_body.fadeIn();

					if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
						_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
							bounce : false
						});
					} else {
						_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
					}

				} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
					abutils.alert(p_response.Exception.Description, 'Dispositivi');
				}
			},
			error : ajaxErrorHandler
		});

	} else {
		impostazioniGeneraliDispositiviChiudi();
		inizializzaAgganciaProfilo();
	}
}

/**
 * Chiude la sezione per la gestione dei dispositivi e riapre le impostazioni generali
 */
function impostazioniGeneraliDispositiviChiudi() {
	$('#impostazioni_titolo_vista_txt').text('Generali');

	//Inizializza il pulsante di ritorno verso le impostazioni generali
	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span>');
	l_back_button.css('display', 'none');

	$('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
	$('#impostazioni_body_vista_container_dispositivi').css('display', 'none');

	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
}

/******************************************************
 Gestione popup disassocia dispositivo
 ******************************************************/
/**
 * Apre il popup che permette di disassociare un dispositivo
 */
function popupDisassociaDispositivo(p_device_id) {
	$('#disassocia_dispositivo').css('display', 'inline');
	if (p_device_id) {
		$('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti("' + p_device_id + '");')
	} else {
		$('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti();')
	}
}

/**
 * Chiude il popup per disassociare un dispositivo
 */
function popupDisassociaDispositivoChiudi() {
	//$('#impostazioni_profilo_menu').fadeOut();
	$('#disassocia_dispositivo').css('display', 'none');
}

/**
 * Disassocia l'account dal dispositivo
 */
function popupDisassociaDispositivoAvanti(p_device_id) {
	console.log('Delete user association to the device');

	var l_request_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	//Se il device id è settato viene disassociato il device memorizzato in _USER_DEVICES[l_device.id]
	if (p_device_id) {
		l_request_data["deviceID"] = p_device_id;
		l_request_data["deviceType"] = _USER_DEVICES[p_device_id]["type"];
	} else {
		_EDICOLA_LAST_PRODUCT_LOAD = 0;
	}

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice');
	console.log(l_req_headers);
	console.log(l_request_data);
	/*
	 navigator.notification.loadingStart({
	 'labelText': "Disassociazione in corso...",
	 'backgroundOpacity': 0.8,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 });*/
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Disassociazione in corso..."]);

	//Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				popupDisassociaDispositivoAvanti(p_device_id);
			})) {
				if (!p_device_id) {
					abutils.alert('L\'account è stato disassociato dal dispositivo', 'Disassociazione dispositivo');
					setUserData(null, null, null);
					/*
					 _USERNAME = null;
					 _PASSWORD = null;
					 deleteUsername();
					 deletePassword();
					 */
					inizializzaAgganciaProfilo();
				}
				popupDisassociaDispositivoChiudi();

				gestisciProssimaAzione();
				openProductDetails(_PRODUCT_IN_EDICOLA.productId);

				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
				abutils.alert(p_response.Exception.Description, 'Disassociazione dispositivo');
			} else {
				abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		}
	});
}

/**
 * Cancella tutte le edizioni presenti in locale
 */
function impostazioniCancellaContenutoLocale() {
	//navigator.notification.confirm('Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?', function(button){
	window.simulatePG.confirm('Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?', 'impostazioniCancellaContenutoLocaleSucc()', 'Cancellazione contenuto locale', 'Si,No');
}

/*
 * Aggancio abbonamento cartaceo
 */
function impostazioniCartaceoAgganciaAbbonamento() {
	var l_sub_code = $('#cartaceo_codice_abbonato').val();
	var l_sub_cap = $('#cartaceo_cap').val();

	if ((l_sub_code.length <= 0) || (l_sub_cap.length <= 0)) {
		abutils.alert('Inserire il proprio Codice Abbonato e il CAP', 'Aggancio abbonamento');
		return;
	}

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform,
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"subscriptionCode" : l_sub_code,
		"subscriptionType" : "XXX",
		"cap" : l_sub_cap
	};

	console.log('---REQ---> subscription-paper');
	console.log(l_req_headers);
	console.log(l_req_data);
	/*
	 navigator.notification.loadingStart({
	 'labelText': "Richiesta in corso...",
	 'backgroundOpacity': 0.8,
	 'strokeOpacity': 0.25,
	 'strokeColor': "FFFFFF",
	 });
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription-paper.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription-paper');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, impostazioniCartaceoAgganciaAbbonamento)) {
				abutils.alert('Il tuo abbonamento cartaceo è stato associato al tuo profilo', 'Aggancio abbonamento');
				$('#impostazioni_body_menu_container_box_' + _CODICE_PRODOTTO_QUOTIDIANO).click();
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
				abutils.alert(p_response.Exception.Description, 'Aggancio abbonamento');
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Aggancio abbonamento');
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		}
	});

}

/**
 * @author mconventi
 */
_RICHOFFLINE_FILTRO_EDIZIONI = new Array();
var _MOD_OFFLINE = null;
var _EDICOLA_OFFLINE_MODE = 'ICONS';
//console.log('PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS');
function enableOfflineMode() {
	if (_MOD_OFFLINE != true) {
		_MOD_OFFLINE = true;

		//if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineOpen();
		//}
	}
}

function enableOnlineMode() {
	if (_MOD_OFFLINE != false) {

		var l_first_run = _MOD_OFFLINE == null;

		_MOD_OFFLINE = false;

		//if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineClose(!l_first_run);
		//}
	}
}

function edicolaOfflineOpen() {
	edicolaOfflineInitFilter();
	edicolaOfflineLoad('ICONS');
	$('#edicola_offline').css('display', 'inline-block');
	$('#edicola').css('display', 'none');
	
	// CLOSE OPENED ARCHIVES
	if ($('#archivio_titolo_chiudi_edicola').is(':visible')) $('#archivio_titolo_chiudi_edicola').trigger('click');
	if ($('#archivio_titolo_chiudi_sfoglio').is(':visible')) $('#archivio_titolo_chiudi_sfoglio').trigger('click');
	if ($('#qarchivio_titolo_chiudi_edicola').is(':visible')) $('#qarchivio_titolo_chiudi_edicola').trigger('click');
	if ($('#qarchivio_titolo_chiudi_sfoglio').is(':visible')) $('#qarchivio_titolo_chiudi_sfoglio').trigger('click');

	
	// disabilito impostazioni
	$('#impostazioni_body_menu_container_box_lista_prodotti').css('display', 'none');
	$('#impostazioni_body_menu_container_box_codicepromozionale').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_prodottoprincipale').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_memoria').hide();
	impostazioniOpenGenerali();

	if (window.innerWidth < 790 || window.innerWidth == 1024) {
		$("#edicola_offline_filtro").hide();
	}
}

function edicolaOfflineClose(reloadEdicola) {

	if (reloadEdicola) {
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Modalità on-line...",
		 'backgroundOpacity': 0.80,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Modalità on-line..."]);
		setTimeout(function() {

			window.location = 'galaxy.html';

		}, 1000);
	} else {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola').css('display', 'inline-block');
		$('#edicola_offline').css('display', 'none');
		loadProducts();
	}
	$('#impostazioni_body_vista_container_generali_memoria').show();
}

var _EDICOLA_OFFLINE_ISCROLL = null;
function edicolaOfflineUpdateIscroll() {
	if (!_MOD_OFFLINE)
		return;
	setTimeout(function() {
		if (_EDICOLA_OFFLINE_ISCROLL == null) {
			_EDICOLA_OFFLINE_ISCROLL = new iScroll('edicola_offline_wrapper', {
				hideScrollbar : false
			});
		} else {
			_EDICOLA_OFFLINE_ISCROLL.refresh();
		}
	}, 100);
}

/**
 * Carica gli articoli salvati in locale
 */
function edicolaOfflineLoad(mode) {

	_EDICOLA_OFFLINE_MODE = mode;

	if (_EDICOLA_OFFLINE_ISCROLL != null) {
		_EDICOLA_OFFLINE_ISCROLL.destroy();
		_EDICOLA_OFFLINE_ISCROLL = null;
	}

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			$('#edicola_offline_container').empty();
			$('#edicola_offline_subtitolo_opzioni_vista_ICONS').removeClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on');
			$('#edicola_offline_subtitolo_opzioni_vista_LIST').removeClass('edicola_offline_subtitolo_opzioni_vista_LIST_on');
			$('#edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE).addClass('edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE + '_on');

			var len = p_results.rows.length;
			console.log("edicolaOfflineLoad: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				if (_EDICOLA_OFFLINE_MODE == 'ICONS') {
					edicolaOfflineRenderAsIcon(p_results.rows.item(i));
				} else {
					edicolaOfflineRenderAsList(p_results.rows.item(i));
				}
				edicolaOfflineUpdateFilter(p_results.rows.item(i));
			}

			//Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#edicola_offline_filtro').change();

			edicolaOfflineUpdateIscroll();

			if (window.innerWidth < 790 || window.innerWidth == 1024) {
				//alert('1aaa '+_RICHOFFLINE_FILTRO_EDIZIONI.length);
				updateRichFiltroOff();
			}
		}
		var queryError = function(p_error) {
			console.log("edicolaOfflineLoad: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues order by issue DESC', [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un oggetto in locale come icona
 * @params p_item Oggetto in locale come salvato nel db issues
 */
function edicolaOfflineRenderAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	//box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'edicola_offline_container_box_img_div';
	img_div.id = 'edicola_offline_container_box_icon_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	$(img_div).click(function() {
		if (!$('#edicola_offline_container').hasClass('edicola_offline_modify'))
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	box.appendChild(img_div);

	var img = document.createElement('img');
	img_div.appendChild(img);
	img.className = 'edicola_offline_container_box_img';
	//img.src = navigator.fileMgr.docsFolderPath + '/issues/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//ANDROID MODDED
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';
	//console.log("path-off:: "+navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg');
	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'edicola_offline_container_box_txt_empty_' + _EDICOLA_OFFLINE_MODE;
	$(txt_local).click(function() {
		if ($('#edicola_offline_container').hasClass('edicola_offline_modify')) {
			eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
		}
	});

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
	txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong><br/>' + p_item.issue_descr + '<br />' + p_item.edizione_descr;
}

/**
 * Crea la rappresentazione in lista di un oggetto salvato in locale
 * @params p_item Oggetto salvato in locale
 *
 */
function edicolaOfflineRenderAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	//box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
	//txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong> ' + p_item.edizione_descr + ' ' + p_item.issue_descr;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	var btn = document.createElement('input');
	btn.id = 'edicola_offline_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 edicola_offline_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'edicola_offline_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 edicola_offline_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);
}

/**
 * Inizializza il filtro sulle testate/edizioni da mostrare.
 */
_EDICOLA_OFFLINE_FILTRO_EDIZIONI = null;
function edicolaOfflineInitFilter() {
	if (_EDICOLA_OFFLINE_FILTRO_EDIZIONI != null) {
		$(_EDICOLA_OFFLINE_FILTRO_EDIZIONI).empty();
	} else {
		_EDICOLA_OFFLINE_FILTRO_EDIZIONI = new Array();
	}
	var l_filtro_select = $('#edicola_offline_filtro');
	l_filtro_select.empty();

	l_filtro_select.change(function() {
		var l_selected_option = $('#edicola_offline_filtro option:selected');

		if (l_selected_option.val() == '') {
			//$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).css('display', 'inline-block');
		} else {
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).not('.edicola_offline_' + l_selected_option.val()).css('display', 'none');
			//$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).css('display', 'inline-block');
		}

		edicolaOfflineUpdateIscroll();
	});

	var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	l_filtro_select.append(l_option);

	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_RICHOFFLINE_FILTRO_EDIZIONI.push(row);
}

/**
 * Gestisce la creazione del filtro sui prodotti da mostrare.
 * @params p_item Oggetto salvato in locale
 */
function edicolaOfflineLabelToValue(p_label) {
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function edicolaOfflineUpdateFilter(p_item) {
	//var l_value = p_item.testata + '_' + p_item.edizione;
	var l_value = edicolaOfflineLabelToValue(p_item.edizione_descr);
	//var l_text = p_item.testata_descr + ' - ' + p_item.edizione_descr;
	var l_text = p_item.edizione_descr;
	//Se l'edizione non è presente nell'array _EDICOLA_OFFLINE_FILTRO_EDIZIONI crea un nuovo elemento nell'array ed aggiunge un opzione nel filtro
	if (jQuery.inArray(l_value, _EDICOLA_OFFLINE_FILTRO_EDIZIONI) == -1) {

		_EDICOLA_OFFLINE_FILTRO_EDIZIONI.push(l_value, l_text);

		var row = {
			value : l_value,
			label : l_text
		};
		console.log('rich ' + row.value + ',' + row.label);
		_RICHOFFLINE_FILTRO_EDIZIONI.push(row);

		//alert(_RICHOFFLINE_FILTRO_EDIZIONI.length);

		var l_option = $('<option></option>');
		l_option.val(l_value);
		l_option.text(l_text);
		$('#edicola_offline_filtro').append(l_option);
	}
}

function updateRichFiltroOff() {
	if ((window.innerWidth < 790 || window.innerWidth == 1024) && $$('myRichOffselect') == null) {
		var value_select = $('#edicola_offline_filtro option:selected').val();
		//alert('aaa \''+value_select+'\'');
		var dhtmlx_listProductsSelectOff = _RICHOFFLINE_FILTRO_EDIZIONI;

		//alert(dhtmlx_listProductsSelectOff[0].label+','+dhtmlx_listProductsSelectOff.length);

		dhx.ui({
			view : "richselect",
			id : "myRichOffselect",
			container : 'edicola_offline_filtro_container',
			label : '',
			popupWidth : 320,
			value : value_select,
			width : '25',
			yCount : "5",
			options : dhtmlx_listProductsSelectOff
		});
		$$('myRichOffselect').attachEvent("onchange",
		function(newv, oldv) {
			setTimeout(function() {
				//alert(oldv+','+newv);
				if (oldv != newv) {

					$('#edicola_offline_filtro option:selected').removeAttr('selected');

					if (newv.indexOf('Tutti i prodotti') == -1) {
						$("#edicola_offline_filtro option[value='" + newv + "']").attr('selected', 'selected');
					} else {
						//alert('aaa'+newv);
						$("#edicola_offline_filtro option[value='']").attr('selected', 'selected');
					}
					//}
					//alert('1aaa '+$$('myRichOffselect').getValue());
					console.log('changed');
					//qarchivioAggiornaContenutoVisualizzato();
					edicolaOfflineLoad(_EDICOLA_OFFLINE_MODE);
				}
			}, 200);

		});

		$('#edicola_offline_filtro_container .dhx_el_richselect').css({
			'width' : '180px'
		});
		$('#edicola_offline_filtro_container .dhx_inp_list').css({
			'width' : '150px'
		});

		if ($$('myRichOffselect') != null) {
			//alert('aaa '+$('#edicola_offline_filtro option:selected').val());
			$$('myRichOffselect').setValue('Tutti i prodotti');
			//alert('1aaa '+$$('myRichOffselect').getValue());
		}

	}
}

/**
 * Passa alla modalità modifica
 */
function edicolaOfflineModifica() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'none');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'inline-block');
	$('#edicola_offline_container').addClass('edicola_offline_modify');
}

/**
 * Passa alla modalità visualizza
 */
function edicolaOfflineVisualizza() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'inline-block');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'none');
	$('#edicola_offline_container').removeClass('edicola_offline_modify');
}

var _INBOX_LIST_ISCROLL = null;
var _INBOX_MESSAGES = {};
var _INBOX_NUM_UNREAD_MESSAGES = 0;

function inboxRefreshInCorso() {
	$('#inbox_list_refresh_button').css('display', 'none');
	$('#inbox_list_refresh_message').html('Aggiornamento in corso...');
}

function inboxRefreshCompletato() {
	setTimeout(function() {
		$('#inbox_list_refresh_button').css('display', 'inline');
		$('#inbox_list_refresh_message').html('<strong>Aggiornato</strong> ' + (new Date()).format('dd/mm/yyyy') + ' <strong>' + (new Date()).format('HH:MM:ss') + '</strong>');
	}, 1000);
}

/*
 * Restituisce i messaggi presenti nel database locale
 * @return Lista di messaggi
 */
function inboxLoadMessages() {

	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.destroy();
		_INBOX_LIST_ISCROLL = null;
	}

	$('#inbox_list_container').empty();

	// Controlla che il database sia stato inizializzato e carica i messaggi
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			//console.log("Read " + len + " messages from the local INBOX store.");

			inboxAddMessages(p_results.rows);

			inboxLoadUnreadMessages();

			//inboxOpenFirstMessageSilent();

			setInterval(inboxLoadUnreadMessages, _INTERVALLO_CHECK_INBOX);
		}
		var queryError = function(p_error) {
			console.log("inboxLoadMessages: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			//tx.executeSql('DROP TABLE IF EXISTS INBOX_MESSAGES_2');
			tx.executeSql('CREATE TABLE IF NOT EXISTS INBOX_MESSAGES_2 (id unique, date, subject, mabstract, body, status)');
			tx.executeSql('SELECT id, date, subject, mabstract, body, status FROM INBOX_MESSAGES_2 order by date asc, id asc', [], querySuccess, queryError);
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

function inboxCloseMsgView() {
	//$('#inbox_msg_container').css('display', 'none');
	$('#inbox_container').removeClass('inbox_container_open');
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
}

function inboxUpdateOrientation() {
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';

	console.log('inboxUpdateOrientation ' + $('#inbox_container').hasClass('inbox_container_open') + ',' + document.getElementById('inbox_container').className);

	//se aperto msg inbox lo riapro quando sono in verticale
	if ($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width < 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if ($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width > 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	}

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.refresh();
	}
	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function inboxAddMessages(p_messages_list) {

	for (var i = 0; i < p_messages_list.length; i++) {

		inboxAddMessage(p_messages_list.item(i));

	}

	/*
	 console.log('Messaggi presenti in locale:');
	 console.log(_INBOX_MESSAGES);
	 */
}

function inboxAddMessage(p_message) {
	_INBOX_MESSAGES['mid_' + p_message.id] = {
		id : p_message.id,
		subject : p_message.subject,
		mabstract : p_message.mabstract,
		date : p_message.date,
		body : p_message.body,
		status : p_message.status
	};

	inboxRenderHeader(p_message.id);

	inboxUpdateUnreadMessage();
}

/**
 * Carica i messaggi non letti in base al device
 */
var _INBOX_TOBEFETCH_MSGS = [];
var _INBOX_REFRESH_ISRUNNING = false;
function inboxLoadUnreadMessages() {

	if (_INBOX_REFRESH_ISRUNNING || (_INBOX_TOBEFETCH_MSGS.length > 0)) {
		console.log('Aggiornamento già in corso...');
		return;
	}

	_INBOX_REFRESH_ISRUNNING = true;

	inboxRefreshInCorso();

	//console.log('Retrieve unread messages');
	var l_signature = getSignature(device.uuid + ',' + device.platform);
	//console.log('Signature: ' + l_signature);

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> getUnreadMessagesDevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getUnreadMessagesDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getUnreadMessagesDevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				for (var i = 0; i < p_response.Result.messages.length; i++) {
					var l_message = p_response.Result.messages[i];
					_INBOX_TOBEFETCH_MSGS.push({
						id : l_message.id,
						subject : l_message.subject,
						mabstract : "",
						date : l_message.data,
						body : "",
						status : 1
					});
				}

				inboxFetchMessages();

			} else {
				inboxRefreshCompletato();
			}

			_INBOX_REFRESH_ISRUNNING = false;
		},
		error : function() {
			inboxRefreshCompletato();

			_INBOX_REFRESH_ISRUNNING = false;
		}
	});

}

function inboxFetchMessages() {
	var l_message = _INBOX_TOBEFETCH_MSGS.shift();
	if (l_message == null) {
		inboxRefreshCompletato();
		//inboxOpenFirstMessageSilent();
		return;
	}
	console.log(l_message);

	// scarico in locale il messaggio
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"messageId" : l_message.id
	};
	console.log('---REQ---> getMessageBody (' + l_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getMessageBody",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getMessageBody (' + l_message.id + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {

				l_message.body = p_response.Result.body;

				if (p_response.Result.preview) {
					l_message.mabstract = p_response.Result.preview;
				} else {
					l_message.mabstract = "";
				}

				inboxMarkAsReadMessageOnServer(l_message);

			} else {
				inboxFetchMessages();
			}
		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxMarkAsReadMessageOnServer(p_message) {
	var l_signature = getSignature(p_message.id + ',' + device.uuid + ',' + device.platform);
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"messageId" : p_message.id,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> markMessageReadDevice (' + p_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/markMessageReadDevice",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> markMessageReadDevice (' + p_message.id + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				// processo verso server completato, posso salvare il messaggio in locale
				inboxStoreMessageFromServer(p_message);
			} else {
				inboxFetchMessages();
			}

		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxStoreMessageFromServer(p_message) {
	// Controlla che il database sia stato inizializzato e salva il messaggio in locale
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxStoreMessageFromServer OK');
			inboxAddMessage(p_message);
			inboxFetchMessages();
		}
		var queryError = function(p_error) {
			console.log("inboxStoreMessageFromServer KO: Error processing SQL: " + p_error.message);
			inboxFetchMessages();
		}
		var executeQuery = function(tx) {
			tx.executeSql('INSERT INTO INBOX_MESSAGES_2 (id, date, subject, mabstract, body, status) VALUES (?,?,?,?,?,?)', [p_message.id, p_message.date, p_message.subject, p_message.mabstract, p_message.body, p_message.status], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function inboxRenderHeader(p_mid) {
	var box = document.createElement('div');

	var l_container = document.getElementById('inbox_list_container');
	l_container.insertBefore(box, l_container.childNodes[0]);

	if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
		box.className = 'inbox_list_container_box inbox_list_container_box_read';
	} else {
		box.className = 'inbox_list_container_box inbox_list_container_box_unread';
	}

	box.id = 'inbox_list_container_box_' + p_mid;

	var table = document.createElement('table');
	box.appendChild(table);
	table.className = 'inbox_list_container_box_table';

	/*
	 var tr1 = document.createElement('tr');
	 table.appendChild(tr1);

	 var td11 = document.createElement('td');
	 tr1.appendChild(td11);
	 td11.className = 'inbox_list_container_box_c1';
	 td11 = null;

	 var td12 = document.createElement('td');
	 */

	var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
	if (l_subject && l_subject != '') {
		if (screen.width < 790) {
			l_subject = l_subject.substring(0, 25);
		} else {
			l_subject = l_subject.substring(0, 40);
		}
		if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
			l_subject += '...'
	}

	/*
	 tr1.appendChild(td12);
	 td12.className = 'inbox_list_container_box_c2_title';
	 td12.innerHTML = '<h1>' + l_subject + '</h1>';
	 td12 = null;

	 var td13 = document.createElement('td');
	 tr1.appendChild(td13);
	 td13.className = 'inbox_list_container_box_c3';
	 td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	 td13 = null;
	 */

	var tr2 = document.createElement('tr');
	table.appendChild(tr2);

	var td21 = document.createElement('td');
	tr2.appendChild(td21);
	td21.className = 'inbox_list_container_box_c1_status';
	// Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
	td21.onclick = function(p_event) {
		var l_message_header = $('#inbox_list_container_box_' + p_mid);

		if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
			l_message_header.removeClass('inbox_list_container_box_unselected');
			l_message_header.addClass('inbox_list_container_box_selected');

		} else if (l_message_header.hasClass('inbox_list_container_box_selected')) {
			l_message_header.removeClass('inbox_list_container_box_selected');
			l_message_header.addClass('inbox_list_container_box_unselected');
		}

		p_event.stopPropagation();
	};
	td21 = null;

	var td22 = document.createElement('td');
	tr2.appendChild(td22);
	td22.className = 'inbox_list_container_box_c2';
	td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
	td22 = null;

	var td23 = document.createElement('td');
	tr2.appendChild(td23);
	td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	td23 = null;

	/*
	 var tr1 = document.createElement('tr');
	 table.appendChild(tr1);

	 var td11 = document.createElement('td');
	 tr1.appendChild(td11);
	 td11.className = 'inbox_list_container_box_c1';
	 td11 = null;

	 var td12 = document.createElement('td');

	 var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
	 if (l_subject && l_subject != '') {
	 l_subject = l_subject.substring(0, 40);
	 if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
	 l_subject += '...'
	 }

	 tr1.appendChild(td12);
	 td12.className = 'inbox_list_container_box_c2_title';
	 td12.innerHTML = '<h1>' + l_subject + '</h1>';
	 td12 = null;

	 var td13 = document.createElement('td');
	 tr1.appendChild(td13);
	 td13.className = 'inbox_list_container_box_c3';
	 td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	 td13 = null;

	 var tr2 = document.createElement('tr');
	 table.appendChild(tr2);

	 var td21 = document.createElement('td');
	 tr2.appendChild(td21);
	 td21.className = 'inbox_list_container_box_c1_status';
	 // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
	 td21.onclick = function(p_event){
	 var l_message_header = $('#inbox_list_container_box_' + p_mid);

	 if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
	 l_message_header.removeClass('inbox_list_container_box_unselected');
	 l_message_header.addClass('inbox_list_container_box_selected');

	 }
	 else
	 if (l_message_header.hasClass('inbox_list_container_box_selected')) {
	 l_message_header.removeClass('inbox_list_container_box_selected');
	 l_message_header.addClass('inbox_list_container_box_unselected');
	 }

	 p_event.stopPropagation();
	 };
	 td21 = null;

	 var td22 = document.createElement('td');
	 tr2.appendChild(td22);
	 td22.className = 'inbox_list_container_box_c2';
	 td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
	 td22 = null;

	 var td23 = document.createElement('td');
	 tr2.appendChild(td23);
	 td23.className = 'inbox_list_container_box_c3_goto';
	 td23 = null;
	 */

	box.onclick = (function(p_mid) {
		return function() {
			inboxOpenMessage(p_mid);
		}
	})(p_mid);

	box = null;

	if (_INBOX_LIST_ISCROLL == null) {
		_INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
	} else {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/*
 function inboxOpenFirstMessageSilent() {
 var l_opened = $('.inbox_list_container_box_active');
 if (l_opened.length == 0) {
 var l_boxes = $('.inbox_list_container_box');
 if (l_boxes.length > 0) {
 console.log(l_boxes);
 $(l_boxes[0]).click();
 inboxCloseMsgView();
 }
 }
 }
 */

var _INBOX_MSG_ISCROLL = null;
function inboxOpenMessage(mid) {

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.destroy();
		_INBOX_MSG_ISCROLL = null;
	}

	inboxInitNavButtons(mid);

	$('#inbox_msg_title_content_del').css('display', 'inline-block');
	$('#inbox_msg_container_empty').css('display', 'none');

	var l_message_container = $('#inbox_msg_container');
	l_message_container.css('display', 'inline-block');

	var box = document.getElementById('inbox_list_container_box_' + mid);
	$('.inbox_list_container_box').removeClass('inbox_list_container_box_active');
	$(box).addClass('inbox_list_container_box_active');
	$(box).removeClass('inbox_list_container_box_unread');
	$(box).addClass('inbox_list_container_box_read');
	box = null;

	/*
	 if (_ORIENTATION == 'V' && screen.width < 790){
	 document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-400px, 0px, 0)';
	 } else if (_ORIENTATION == 'V' && screen.width > 790){
	 document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-800px, 0px, 0)';
	 } else if(_ORIENTATION == 'H'){
	 document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	 }
	 */

	if (_ORIENTATION == 'V') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if (_ORIENTATION == 'H') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}

	//.className+=' newclass'
	//document.getElementById('inbox_container').className += 'inbox_container_open';
	//alert('aaa'+document.getElementById('inbox_container').className);
	$('#inbox_container').addClass('inbox_container_open');
	//alert('aaa'+document.getElementById('inbox_container').className);
	//document.getElementById('inbox_container').className += 'inbox_container_open';

	if (_INBOX_MESSAGES['mid_' + mid] == null)
		return;

	document.getElementById('inbox_msg_header_title').innerHTML = _INBOX_MESSAGES['mid_' + mid].subject;
	document.getElementById('inbox_msg_header_data').innerHTML = inboxFormatDate(_INBOX_MESSAGES['mid_' + mid].date);
	document.getElementById('inbox_msg_body').innerHTML = _INBOX_MESSAGES['mid_' + mid].body;
	_INBOX_MESSAGES['mid_' + mid].status = 0;
	inboxUpdateUnreadMessage();

	setTimeout(function() {
		if (_INBOX_MSG_ISCROLL == null) {
			_INBOX_MSG_ISCROLL = new iScroll('inbox_msg_wrapper');
		} else {
			_INBOX_MSG_ISCROLL.refresh();
		}
	}, 100);

	// marco il messaggio come letto sul db
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxOpenMessage OK');
		}
		var queryError = function(p_error) {
			console.log("inboxOpenMessage KO: Error processing SQL: " + p_error.message);
			inboxFetchMessages();
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE INBOX_MESSAGES_2 SET status=0 WHERE id=?', [mid], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

	omnitureTrackApp('APP:inbox:open:' + mid, 'APP:inbox');
}

function inboxUpdateUnreadMessage() {
	_INBOX_NUM_UNREAD_MESSAGES = 0;
	for (var key in _INBOX_MESSAGES) {
		var l_msg = _INBOX_MESSAGES[key];
		if (l_msg.status == 1)
			_INBOX_NUM_UNREAD_MESSAGES++;
	}

	if (_INBOX_NUM_UNREAD_MESSAGES > 0) {
		//$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
		//$('#appmenu_inbox_count').text('*');
		$('#appmenu_inbox_count').css('display', 'inline-block');
	} else {
		$('#appmenu_inbox_count').css('display', 'none');
	}
}

function inboxFormatDate(p_date) {
	if (p_date.length != 19)
		return "00 00 0000";
	var toks = p_date.split(' ');
	if (toks.length != 2)
		return "00 00 0000";
	var cals = toks[0].split('-');
	if (cals.length != 3)
		return "00 00 0000";
	return cals[2] + ' ' + cals[1] + ' ' + cals[0];
}

/**
 * Passa alla modalità modifica messaggi
 */
function inboxSwitchToModifyView() {
	$('#inbox_list_modify_button').hide();
	$('#inbox_list_show_button').show();
	$('.inbox_list_container_box').addClass('inbox_list_container_box_unselected');
	$('#elimina_messaggi').fadeIn();
}

/**
 * Passa alla modalità visualizza messaggi
 */
function inboxSwitchToShowView() {
	$('#inbox_list_show_button').hide();
	$('#inbox_list_modify_button').show();
	$('.inbox_list_container_box.inbox_list_container_box_unselected').removeClass('inbox_list_container_box_unselected');
	$('.inbox_list_container_box.inbox_list_container_box_selected').removeClass('inbox_list_container_box_selected');
	$('#elimina_messaggi').fadeOut();
}

/**
 * Inizializza lo stato dei pulsanti per la navigazione tra i messaggi
 */
function inboxInitNavButtons(p_header_id) {
	//console.log("inboxInitNavButton");
	var l_next_element = $('#inbox_msg_title_nav_next_btn');
	l_next_element.unbind('click');

	var l_prev_element = $('#inbox_msg_title_nav_prev_btn');
	l_prev_element.unbind('click');

	if ($('#inbox_list_container_box_' + p_header_id).prev().length) {
		l_next_element.removeClass('disabled');
		l_next_element.click(function() {
			inboxOpenPrevMsg(p_header_id);
		});
	} else {
		l_next_element.addClass('disabled');
	}

	if ($('#inbox_list_container_box_' + p_header_id).next().length) {
		$('#inbox_msg_title_nav_prev_btn').removeClass('disabled');
		l_prev_element.click(function() {
			inboxOpenNextMsg(p_header_id);
		});
	} else {
		$('#inbox_msg_title_nav_prev_btn').addClass('disabled');
	}
}

/**
 * Apre il messaggio successivo
 */
function inboxOpenPrevMsg(p_header_id) {
	var l_prev = $('#inbox_list_container_box_' + p_header_id).prev();
	if (l_prev.length) {
		var mid = l_prev[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}

/**
 * Apre il messaggio precedente
 */
function inboxOpenNextMsg(p_header_id) {
	var l_next = $('#inbox_list_container_box_' + p_header_id).next();
	if (l_next.length) {
		var mid = l_next[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}

/*
 * Elimina i messaggi dal database
 * @params p_mids Lista dei identificativi dei messaggi
 */
function deleteLocalMessages(p_mids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in locale
	if (_DB && p_mids.length > 0) {

		var querySuccess = function() {
			console.log('Deleted messages ' + p_mids.toString());
			deleteInboxElements(p_mids);
		}
		var queryError = function(p_error) {
			console.log("deleteLocalMessages: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM INBOX_MESSAGES_2 WHERE id in (' + p_mids.toString() + ')');
			//querySuccess();
		}

		_DB.transaction(executeQuery, queryError, querySuccess);
	}
}

/**
 * Elimina i messaggi selezionati in modalità modifica
 */
function inboxDeleteMessages() {
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	var l_all_messages = [];

	for (var i = 0; i < l_messages.length; i++) {
		var l_mid = l_messages[i].id.substring(25);
		l_all_messages.push(l_mid);
	}

	if (l_all_messages.length > 0) {
		deleteLocalMessages(l_all_messages);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun messaggio', 'Inbox');
	}

	/*
	 var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	 var l_remote_messages = [];
	 var l_all_messages = [];

	 for (var i = 0; i < l_messages.length; i++) {
	 var l_mid = l_messages[i].id.substring(25);
	 if (_INBOX_MESSAGES[l_mid]) {
	 l_all_messages.push(l_mid);

	 if (!_INBOX_MESSAGES[l_mid].body) {
	 l_remote_messages.push(l_mid);
	 }
	 }
	 }

	 // I messaggi non scaricati vengono segnalati come già letti
	 if (l_remote_messages.length > 0) {
	 markMessagesAsRead(l_remote_messages);
	 }

	 // Tutti i messaggi vengono eliminati dal database
	 // (per evitare problemi dovuti alla sincronizzazione con chiamate remote si cerca di eliminare anche quelli che non sembrano essere stati scaricati)
	 if (l_all_messages.length > 0) {
	 deleteLocalMessages(l_all_messages);
	 }
	 else {
	 alert('Attenzione, non è stato selezionato nessun messaggio');
	 }
	 */
}

/**
 * Elimina gli elementi html relativi ai messaggi
 * @params p_mids Lista degli identificativi dei messaggi che devono essere eliminati
 */
function deleteInboxElements(p_mids) {
	var l_active_message = $('.inbox_list_container_box_active');
	if (l_active_message.length > 0) {
		var l_active_message_id = l_active_message[0].id.substring(25);

		if (jQuery.inArray(l_active_message_id, p_mids) != -1) {
			//$('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
		}
	}
	$('.inbox_list_container_box.inbox_list_container_box_selected').remove();
}

/**
 * Elimina il messaggio aperto
 */
function inboxDeleteOpenedMessage() {
	//navigator.notification.confirm('Il messaggio verrà cancellato.\nSei sicuro?', function(button){
	window.simulatePG.confirm('Il messaggio verrà cancellato.\nSei sicuro?', 'inboxDeleteOpenedMessageSucc()', 'Cancellazione messaggio', 'Si,No');
}

(function() {
	var _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseout';

	var CoveerFlow = function(container, covers) {
		this._container = typeof container == 'object' ? container : document.getElementById(container);
		this._covers = covers;
		this._initialization();

	};

	CoveerFlow.prototype = {
		_startX : 0,
		_startY : 0,
		_moveX : 0,
		_moveY : 0,
		_galleryHeight : 0,
		_touching : false,
		_moved : false,
		_initialization : function() {
			try {
				this._current = 0;
				this._totals = this._covers.length;
				this._stepPercent = 30;
				//25;//15;
				this._currentSlidePaddingPercent = 50;
				//25;
				this._rotateAngle = 0;
				//65;
				this._loaded = 0;

				var gallery = document.createElement('div');
				this._container.appendChild(gallery);
				gallery.className = 'coveerflow';
				//gallery.style.visibility = 'hidden';
				console.log("gallery _ORIENTATION is " + _ORIENTATION);
				console.log("gallery " + parseInt(gallery.offsetHeight, 10) + "," + parseInt((window.innerHeight / 2) * 90 / 100));
				var galleryHeight = null;
				var slideHeight = null;
				if (_ORIENTATION == 'V') {
					galleryHeight = parseInt((window.innerHeight / 2) * 90 / 100);
					//573;//parseInt(gallery.offsetHeight, 10);
					slideHeight = galleryHeight;
					if (window.innerWidth == 600 || window.innerWidth == 1024)
						slideHeight = 410;
				} else {
					if (window.innerWidth > 400)
						galleryHeight = parseInt((window.innerWidth / 2) * 86 / 100);
					else
						galleryHeight = parseInt((window.innerWidth / 2) * 90 / 100);
					slideHeight = galleryHeight;
					if (window.innerWidth == 600 || window.innerWidth == 1024)
						slideHeight = 410;
				}

				this._galleryHeight = galleryHeight;
				//slideHeight = galleryHeight ;//- 20;/*50/*AB150;*/

				this._step = galleryHeight * this._stepPercent / 100;
				this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;

				console.log('gal1 galleryHeight ' + galleryHeight);
				console.log('gal1 slideHeight ' + slideHeight);
				console.log('gal1 _step ' + this._step);
				console.log('gal1 _currentSlidePadding ' + this._currentSlidePadding);

				for (var i = 0; i < this._totals; i++) {
					var coverdiv = document.createElement('div');
					gallery.appendChild(coverdiv);

					console.log('gal1 slideHeight ' + slideHeight);

					coverdiv.style.maxWidth = slideHeight + 'px';
					coverdiv.style.maxHeight = slideHeight + 'px';
					coverdiv.style.minHeight = slideHeight + 'px';

					var coverimg = document.createElement('img');
					coverdiv.appendChild(coverimg);
					//coverimg.src = this._covers[i]['src'];

					//var that = this;
					/* viene gestita nelle gesture
					 $(coverimg).click(function() {
					 if (typeof that.on_tap != "undefined")
					 that.on_tap.call();
					 });
					 */

					/*
					 coverimg.onload = (function(that) {
					 return function() {
					 that._loading();
					 }
					 })(this);
					 coverimg.onerror = (function(that) {
					 return function() {
					 that._loading();
					 }
					 })(this);
					 */
					if (this._covers[i]['anteprima']) {
						var anteprimaimg = document.createElement('img');
						anteprimaimg.className = 'coveerflow_anteprima';
						coverdiv.appendChild(anteprimaimg);
						anteprimaimg.src = 'imgs/coveerflow_anteprima.png';
						anteprimaimg = null;
					}

					if (this._covers[i]['abbonati']) {
						var abbonatiimg = document.createElement('img');
						abbonatiimg.className = 'coveerflow_abbonati';
						coverdiv.appendChild(abbonatiimg);
						abbonatiimg.src = 'imgs/coveerflow_abbonati2.png';
						abbonatiimg = null;
					}

					coverimg = null;
					coverdiv = null;
				}

				gallery = null;

				this._bind(_START_EV);
				this._bind(_MOVE_EV);
				this._bind(_END_EV);
				this._bind(_CANCEL_EV);

				// parte aggiunta per evitare l'attesa dell'onload delle immagini
				this._display();
				var that = this;
				setTimeout(function() {
					that._setAnimation();
				}, 100);
				//alert('ok'+_ORIENTATION);
			} catch(exc) {
				console.log(exc.message)
			}
		},
		/*
		 _loading: function() {
		 this._loaded++;
		 if (this._loaded == this._totals) {
		 this._loadingDone();
		 }
		 },
		 _loadingDone: function() {
		 this._display();
		 setTimeout((function(that) {
		 return function() {
		 that._setAnimation();
		 that._container.children[0].style.visibility = 'visible';
		 }
		 })(this), 100);
		 },
		 */
		_setAnimation : function() {
			var coverdivs = this._container.children[0].children;
			for (var i = 0; i < coverdivs.length; i++) {
				coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
			}
		},
		_display : function() {
			//var galleryCenter = parseInt(this._container.children[0].offsetWidth, 10) / 2;
			try {
				var galleryCenter = null;
				//600 / 2;
				if (_ORIENTATION == 'V') {
					if (window.innerWidth > 400) {
						galleryCenter = parseInt(window.innerWidth * 50 / 100);
						//600 / 2;
					} else {
						galleryCenter = parseInt(window.innerWidth * 58 / 100);
					}
					if (window.innerWidth == 600 || window.innerWidth == 1024)
						galleryCenter = window.innerWidth / 2;
				} else {
					if (window.innerWidth > 400) {
						galleryCenter = parseInt(window.innerWidth * 25 / 100);
						//600 / 2;
					} else {
						galleryCenter = parseInt(window.innerHeight * 37 / 100);
					}
					if (window.innerWidth == 600 || window.innerWidth == 1024)
						galleryCenter = window.innerWidth / 4;
				}
				console.log("gallcent: " + galleryCenter);
				var coverdivs = this._container.children[0].children;

				//alert("children  "+this._container.children[0].children);

				for (var i = 0; i < this._totals; i++) {
					//var l_cover_width = parseInt(coverdivs[i].offsetWidth, 10);
					console.log("cover#" + i + " " + parseInt(window.innerWidth / 2 + 10));
					var l_cover_width = null;
					if (_ORIENTATION == 'V') {
						l_cover_width = parseInt(window.innerWidth / 2) + 10;
						//409;
						//alert(window.innerWidth);
						if (window.innerWidth > 590 && window.innerWidth < 630)
							l_cover_width = window.innerWidth / 3;
					} else {
						l_cover_width = parseInt(window.innerHeight / 2) + 10;
						if (window.innerHeight > 1010 && window.innerHeight < 1030)
							l_cover_width = window.innerHeight / 3;
					}

					if (Math.abs(i - this._current) > 1) {
						coverdivs[i].style.display = 'none';
						coverdivs[i].children[0].src = null;

						coverdivs[i].style.webkitTransform = '';

					} else {
						if (i < this._current) {
							// precedenti - sinistra
							var leftPos = parseInt(galleryCenter - (this._current * this._step) + (i * this._step) - (l_cover_width / 2) - this._currentSlidePadding, 10);
							//coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, -' + parseInt((100 + l_cover_width / 1.5), 10) + 'px) rotateY(' + this._rotateAngle + 'deg)';
							//coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
							coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
						} else if (i == this._current) {
							// corrente - centrale
							var leftPos = parseInt(galleryCenter - (l_cover_width / 2), 10);
							//coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px,0px,0) rotateY(0deg)';
							coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
							//coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
						} else {
							// successivi - destra
							var leftPos = parseInt(galleryCenter + ((i - this._current) * this._step) - (l_cover_width / 2) + this._currentSlidePadding, 0);
							//coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, -' + parseInt((100 + parseInt(l_cover_width, 10) / 1.5), 10) + 'px) rotateY(-' + this._rotateAngle + 'deg)';
							//coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
							coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
						}

						coverdivs[i].style.display = 'inline-block';
						coverdivs[i].children[0].src = this._covers[i]['src'];
					}
				}
			} catch(exc) {
				console.log(exc.message);
			}
		},
		_bind : function(type, element, bubble) {
			(element || this._container).addEventListener(type, this, !!bubble);
		},
		_unbind : function(type, element, bubble) {
			(element || this._container).removeEventListener(type, this, !!bubble);
		},
		handleEvent : function(e) {
			switch(e.type) {
				case _START_EV:
					this._e_start(e);
					break;
				case _MOVE_EV:
					this._e_move(e);
					break;
				case _END_EV:
				case _CANCEL_EV:
					this._e_end(e);
					break;
			}
		},
		_e_start : function(e) {
			e.preventDefault();
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._startX = _e.clientX;
			this._startY = _e.clientY;
			this._touching = true;
			this._moved = false;
			/*
			 this._bind(_MOVE_EV);
			 this._bind(_END_EV);
			 this._bind(_CANCEL_EV);
			 this._unbind(_START_EV);
			 */
		},
		_e_move : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._moveX = _e.clientX;
			this._moveY = _e.clientY;
			this._moved = true;
		},
		_e_end : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;

			if (!this._moved) {
				if (this._touching) {
					if ( typeof this.on_tap != "undefined") {
						this.on_tap.call();
					}
				}
				return;
			}

			if (this._moveX - this._startX > 100)
				this._gotoPrev();
			else if (this._moveX - this._startX < -100)
				this._gotoNext();

			var that = this;
			setTimeout(function() {
				that._touching = false;
			}, 300);

			if (this.on_end) {
				this.on_end.call();
			}
			/*
			 this._unbind(_MOVE_EV);
			 this._unbind(_END_EV);
			 this._unbind(_CANCEL_EV);
			 */
		},
		_gotoNext : function() {
			if (this._current + 1 >= this._totals)
				return;
			this._current++;
			this._display();
		},
		_gotoPrev : function() {
			if (this._current <= 0)
				return;
			this._current--;
			this._display();
		},
		destroy : function() {
			this._unbind(_START_EV);
			this._unbind(_START_EV);
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
		}
	}

	window.CoveerFlow = CoveerFlow;
})();
/**
 * @author ABertacco
 */
var _NIELSEN_BASE_URL = "http://secure-it.imrworldwide.com/cgi-bin/m?ci=ilsole-app&cg=0&si=";

var _AREE = {
	'ALTRO' : 'http%3A//sfogliatoremobile.ilsole24ore.com',
	'EDICOLA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/edicola',
	'ARCHIVIO_PRODOTTI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/archivio_prodotti',
	'PREFERITI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/preferiti',
	'RICERCA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/ricerca',
	'INBOX' : 'http%3A//sfogliatoremobile.ilsole24ore.com/inbox',
	'REGISTRAZIONE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/registrazione',
	'SFOGLIATORE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/sfogliatore'
}

function nielsenCall(area) {
	try {
		if (_AREE[area] == null)
			area = 'ALTRO';
		document.getElementById('nielsen_wrapper').innerHTML = '';
		var img = document.createElement('img');
		document.getElementById('nielsen_wrapper').appendChild(img);
		$(img).load(function() {
			console.log('nielsen load ' + area);
		});
		$(img).error(function() {
			console.log('nielsen error ' + area);
		});
		img.src = _NIELSEN_BASE_URL + _AREE[area];
		img = null;
	} catch(exc) {
		console.log('nielsen exception: ' + exc.message);
	}
}

/**
 * @author ABertacco
 */
function omnitureTrackApp(pageName, channel) {
	try {

		//PhoneGap.exec("AppMeasurementCommand.trackApp", pageName, channel);
		//window.plugins.flipper24.trackApp(null, null, pageName, channel);
		console.log("omniture:: " + pageName + ', ' + channel);
		window.infodroid.track(null, null, pageName, channel);

	} catch (exc) {

		console.log("ERROR OMNI");
	}

}

/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];

	//PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();

	if ((id_shopping24 == null) || (id_itunes == null))
		return;

	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in _IAP_REQ_QUEUE
	//var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	//PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null)
				continue;
			console.log('OK ' + l_product.productIdentifier);
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}

		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}

		return "OK";
	} catch(exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}

	navigator.notification.loadingStart({
		'labelText' : "Acquisto in corso...",
		'backgroundOpacity' : 0.8,
		'strokeOpacity' : 0.25,
		'strokeColor' : "FFFFFF",
	});

	_APPSTORE_BUY_CALLBACK = callback;

	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({
			Success : false,
			Exception : {
				Name : 'ExpiredUserIdentityException',
				Description : 'Rinnovo useridentity pre-pagamento.'
			}
		}, function() {
			//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}



/**
 * @author ABertacco
 */
function ab_number_format(number, decimals, dec_point, thousands_sep){

    var n = number, prec = decimals;
    
    var toFixedFix = function(n, prec){
        var k = Math.pow(10, prec);
        return (Math.round(n * k) / k).toString();
    };
    
    n = !isFinite(+n) ? 0 : +n;
    prec = !isFinite(+prec) ? 0 : Math.abs(prec);
    var sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep;
    var dec = (typeof dec_point === 'undefined') ? '.' : dec_point;
    
    var s = (prec > 0) ? toFixedFix(n, prec) : toFixedFix(Math.round(n), prec); //fix for IE parseFloat(0.55).toFixed(0) = 0;
    var abs = toFixedFix(Math.abs(n), prec);
    var _, i;
    
    if (abs >= 1000) {
        _ = abs.split(/\D/);
        i = _[0].length % 3 || 3;
        
        _[0] = s.slice(0, i + (n < 0)) +
        _[0].slice(i).replace(/(\d{3})/g, sep + '$1');
        s = _.join(dec);
    }
    else {
        s = s.replace('.', dec);
    }
    
    var decPos = s.indexOf(dec);
    if (prec >= 1 && decPos !== -1 && (s.length - decPos - 1) < prec) {
        s += new Array(prec - (s.length - decPos - 1)).join(0) + '0';
    }
    else 
        if (prec >= 1 && decPos === -1) {
            s += dec + new Array(prec).join(0) + '0';
        }
    return s;
}

function ab_euro_formatter(number) {
	return ab_number_format(number, 2, ',', '.') + " €";
}

var dateFormat = function () {
	var	token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
		timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
		timezoneClip = /[^-+\dA-Z]/g,
		pad = function (val, len) {
			val = String(val);
			len = len || 2;
			while (val.length < len) val = "0" + val;
			return val;
		};

	// Regexes and supporting functions are cached through closure
	return function (date, mask, utc) {
		var dF = dateFormat;

		// You can't provide utc if you skip other args (use the "UTC:" mask prefix)
		if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
			mask = date;
			date = undefined;
		}

		// Passing date through Date applies Date.parse, if necessary
		date = date ? new Date(date) : new Date;
		if (isNaN(date)) throw SyntaxError("invalid date");

		mask = String(dF.masks[mask] || mask || dF.masks["default"]);

		// Allow setting the utc argument via the mask
		if (mask.slice(0, 4) == "UTC:") {
			mask = mask.slice(4);
			utc = true;
		}

		var	_ = utc ? "getUTC" : "get",
			d = date[_ + "Date"](),
			D = date[_ + "Day"](),
			m = date[_ + "Month"](),
			y = date[_ + "FullYear"](),
			H = date[_ + "Hours"](),
			M = date[_ + "Minutes"](),
			s = date[_ + "Seconds"](),
			L = date[_ + "Milliseconds"](),
			o = utc ? 0 : date.getTimezoneOffset(),
			flags = {
				d:    d,
				dd:   pad(d),
				ddd:  dF.i18n.dayNames[D],
				dddd: dF.i18n.dayNames[D + 7],
				m:    m + 1,
				mm:   pad(m + 1),
				mmm:  dF.i18n.monthNames[m],
				mmmm: dF.i18n.monthNames[m + 12],
				yy:   String(y).slice(2),
				yyyy: y,
				h:    H % 12 || 12,
				hh:   pad(H % 12 || 12),
				H:    H,
				HH:   pad(H),
				M:    M,
				MM:   pad(M),
				s:    s,
				ss:   pad(s),
				l:    pad(L, 3),
				L:    pad(L > 99 ? Math.round(L / 10) : L),
				t:    H < 12 ? "a"  : "p",
				tt:   H < 12 ? "am" : "pm",
				T:    H < 12 ? "A"  : "P",
				TT:   H < 12 ? "AM" : "PM",
				Z:    utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
				o:    (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
				S:    ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
			};

		return mask.replace(token, function ($0) {
			return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
		});
	};
}();

// Some common format strings
dateFormat.masks = {
	"default":      "ddd mmm dd yyyy HH:MM:ss",
	shortDate:      "m/d/yy",
	mediumDate:     "mmm d, yyyy",
	longDate:       "mmmm d, yyyy",
	fullDate:       "dddd, mmmm d, yyyy",
	shortTime:      "h:MM TT",
	mediumTime:     "h:MM:ss TT",
	longTime:       "h:MM:ss TT Z",
	isoDate:        "yyyy-mm-dd",
	isoTime:        "HH:MM:ss",
	isoDateTime:    "yyyy-mm-dd'T'HH:MM:ss",
	isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};

// Internationalization strings
dateFormat.i18n = {
	dayNames: [
		"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
		"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
	],
	monthNames: [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
		"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
	]
};

// For convenience...
Date.prototype.format = function (mask, utc) {
	return dateFormat(this, mask, utc);
};

function parseDateWithDbFormat(string) {
	var reggie = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/g;
	var tokens = reggie.exec(string);
	if (tokens.length != 7)
		return new Date();
	else 
		return new Date(
			tokens[1],
		    tokens[2] - 1, // mesi partono da 0 in js
		    tokens[3],
		    tokens[4],
		    tokens[5],
		    tokens[6]
		);
};

var abutils = {
	voidfunc : function() {},
	alert : function(msg, title, callback) {
		if (title == null) title = "Il Sole 24 ORE";
		if (callback == null) callback = abutils.voidfunc;
		try {
			
			navigator.notification.alert(msg, function(){
				callback.call();
			}, title, 'Ok');
		
		} catch (exc) {
			alert(msg);
			if (callback != null) {
				callback.call();
			}
		}
	}
};


var PGAleBerUtils = function() {
}
PGAleBerUtils.prototype.splashScreenHide = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'splashScreenHide', []);
}
PGAleBerUtils.prototype.activityStart = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStart', []);
}
PGAleBerUtils.prototype.activityStop = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStop', []);
}
PGAleBerUtils.prototype.deviceExtraInfo = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deviceExtraInfo', []);
}
PGAleBerUtils.prototype.deleteDirectoryAtAbsolutePath = function(successCB, errorCB, path) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deleteDirectoryAtAbsolutePath', [path]);
}
PGAleBerUtils.prototype.registerForRemoteNotification = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'registerForRemoteNotification', []);
}
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.pgaleberutils = new PGAleBerUtils();
});
*/
/* ------------------------------------------------------------- */

var PGFlipper24 = function() {}
PGFlipper24.prototype.trackApp = function(successCB, errorCB, pageName, channel) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.appmeasurement', 'trackApp', [pageName, channel]);
}
PGFlipper24.prototype.openFlipper24 = function(successCB, errorCB, testata, edizione, issue, startingPage, fastLoading) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.flipper24', 'openFlipper24', [testata, edizione, issue, startingPage, fastLoading]);
}
PGFlipper24.prototype.addIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'addIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.removeIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.getQueueDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'getQueueDownloadQueue', []);
}
PGFlipper24.prototype.removeAllIssuesFromDownloadQueue = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager', 'removeAllIssuesFromDownloadQueue', []);
}

var PGAppStore = function() {}
PGAppStore.prototype.setup = function(successCB, errorCB) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setup', []);
}
PGAppStore.prototype.setUserInfo = function(successCB, errorCB, username, useridentity) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setUserInfo', [username, useridentity]);
}
PGAppStore.prototype.productsListRequest = function(successCB, errorCB, productsIds) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'productsListRequest', [productsIds]);
}
PGAppStore.prototype.purchase = function(successCB, errorCB, productId, planS24) {
	//PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'purchase', [productId, planS24]);
}
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.flipper24 = new PGFlipper24();
	window.plugins.appstore = new PGAppStore();
});
*/

/* ------------------------------------------------------------- */
NotificationEx = function() {
};

NotificationEx.prototype.loadingStart = function(options) {
    //PhoneGap.exec(null, null, "NotificationEx","loadingStart", [options]);
};
NotificationEx.prototype.loadingStop = function() {
    //PhoneGap.exec(null, null, "NotificationEx","loadingStop", []);
};

NotificationEx.prototype.activityStart = function() {
    //PhoneGap.exec(null, null, "NotificationEx", "activityStart", []);
};

NotificationEx.prototype.activityStop = function() {
    //PhoneGap.exec(null, null, "NotificationEx", "activityStop", []);
};
/*
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
    navigator.plugins.notificationEx = new NotificationEx();
});*/
// Variabile contente l'identificativo del prodotto aperto in edicola
var _PRODUCT_IN_EDICOLA = null;
var _INTERVALLO_CHECK_PRODUCTS = 15 * 60 * 1000;
var _EDICOLA_PRODUCTS_ISCROLL = null;
var _EDICOLA_PRODUCTS_COUNT = 0;
var _EDICOLA_PRODUCTS_INLINE_V = 3;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _EDICOLA_PRODUCTS_INLINE_H = 4;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _EDICOLA_PRODUCTS_DETAILS = null;
var _EDICOLA_DESCR_ISCROLL = null;
// Flag utile per capire se i prodotti in edicola debbano essere aggiornati quando l'utente clicca sul relativo pulsante nella barra menu
var _EDICOLA_REFRESH_PRODUCTS = false;
// hash map tra testata e product id del sole, utilizzato per aprire l'archivio
var _HASH_MAP_TESTATA_PRODUCTID = {};

var _LockTap = false;

function loadCategories() {
	try {

		// svuoto categorie
		$('#edicola_titolo_btn').html('');

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getCategorie");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "categories.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getCategories");
				console.log(p_response);
				if (checkAjaxResponse(p_response)) {
					var res = p_response.Result.res;
					if ((!res.categoryList) || (res.categoryList.length <= 0)) {
						loadProductsByCategory(null);
						return;
					}
					var l_select = $('<select onchange="edicolaFiltroProdottiByCategory();" id="edicola_titolo_btn_select"></select>');
					for (var i = 0; i < res.categoryList.length; i++) {
						$('<option value="' + res.categoryList[i].categoryName + '">' + res.categoryList[i].categoryDescription + '</option>').appendTo(l_select);
					}

					$('#edicola_titolo_btn').html('');
					l_select.appendTo('#edicola_titolo_btn');

					loadProductsByCategory(res.categoryList[0].categoryName);
				} else {
					console.log('getCategories check ajax response error');
					loadProductsByCategory(null);
				}
			},
			error : function() {
				console.log('getCategories ajax error');
				loadProductsByCategory(null);
			}
		});
	} catch (exc) {
		console.log('getCategories exception ' + exc.message);
		loadProductsByCategory(null);
	}
}

function loadProductsByCategory(p_category) {
	console.log('loadProductsByCategory:' + p_category);
	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + JSON.stringify(p_response));
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if ( typeof _PRODUCTLINK[0] != 'undefined' && _PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});
	} catch(exc) {
		console.log("error::load: " + exc.message);
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}
}

/**
 * Gestisce il caricamento dell'anteprima dei prodotti nell'edicola
 * Utilizza le seguenti chiamate:
 *   - ajaxErrorHandler per la gestione degli errori di comunicazione con API24
 */
var _EDICOLA_LAST_PRODUCT_LOAD = null;
function loadProducts() {

	if ((_EDICOLA_LAST_PRODUCT_LOAD != null) && (Math.abs(_EDICOLA_LAST_PRODUCT_LOAD - (new Date().getTime())) < _INTERVALLO_CHECK_PRODUCTS )) {
		console.log('loadProducts NON necessario');
		return;
	}

	_EDICOLA_LAST_PRODUCT_LOAD = new Date().getTime();

	if (_EDICOLA_USE_CATEGORIES) {
		loadCategories();
		return;
	} else {
		loadProductsByCategory(null);
		return;
	}

	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};
		
		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + /*JSON.stringify(*/p_response/*)*/);
				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					//console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/*new Array();*/
						//_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] = res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if (_PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						//alert('is '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						//Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						//Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						//Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						//pbox_icon_img.src = i % 5 == 0 ? 'imgs/fake/prodotto_icon_appstore.png' : (i % 2 == 0 ? 'imgs/fake/prodotto_icon_standard.png' : 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						//Nel caso in cui il prodotto sia esterno viene creata l'icona appstore
						//if (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore']) {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						//Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						//Viene associato l'evento di apertura del dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						//Se il prodotto principale è stato impostato, viene aperto il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});

	} catch (exc) {
		_EDICOLA_LAST_PRODUCT_LOAD = null;
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}

}

/**
 * Inizializza il controllo per l'aggiornamento dei prodotti attivando un flag per l'aggiornamento dei dati quando l'utente clicca sul pulsante edicola della barra menu
 */
function initCheckProducts() {
	console.log("initCheckProducts");
}

function updateEdicolaProductsIscroll() {
	var pboxes = $('#edicola_container .edicola_prodotto_box');

	if ((pboxes.length == 0) || (_EDICOLA_PRODUCTS_COUNT == 0)) {
		$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
	} else {
		if (_ORIENTATION == 'V') {
			$('#edicola_catalogo').css('left', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('top', '-' + ($('#centrale').height() - 180) + 'px');
				$('#edicola_container').width($(pboxes[0]).outerWidth(true) * pboxes.length);
			} else {
				$('#edicola_catalogo').css('top', '1px');
				$('#edicola_container').width('100%');
			}
		} else {
			$('#edicola_catalogo').css('top', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('left', ($('#centrale').width() - 200) + 'px');
				$('#edicola_container').width($('#edicola_wrapper').width());
			} else {
				$('#edicola_catalogo').css('left', '1px');
				$('#edicola_container').width('100%');
			}
		}
	}
	
	if (_EDICOLA_PRODUCTS_ISCROLL == null) {
		_EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_PRODUCTS_ISCROLL.refresh();
	}

	if (_EDICOLA_DESCR_ISCROLL != null) _EDICOLA_DESCR_ISCROLL.refresh();
	if (_ABBONAMENTI_ISCROLL != null) _ABBONAMENTI_ISCROLL.refresh();
}

var _PRODUCT_DETAILS_COVERFLOW = null;
function openProductDetails(productId) {
	if (_LockTap) return;
	_LockTap = true;
	
	console.log("openProductDetails " + productId);
	if (_EDICOLA_PRODUCTS_DETAILS[productId] == null) {	
		_LockTap = false;
		return;
	}

	$('#edicola_prodotto').attr('class', 'edicola_prodotto_type_' + _EDICOLA_PRODUCTS_DETAILS[productId].type);

	$('.edicola_prodotto_box_icon').removeClass('edicola_prodotto_box_icon_selected');
	$('#edicola_prodotto_box_icon_' + productId).addClass('edicola_prodotto_box_icon_selected');
	if (!_EDICOLA_CATALOGO_SMALL) {
		edicolaCatalogoSwitchView();
	}

	if (_PRODUCT_DETAILS_COVERFLOW != null) {
		_PRODUCT_DETAILS_COVERFLOW.destroy();
		_PRODUCT_DETAILS_COVERFLOW = null;
	}

	$('#edicola_prodotto').hide();

	// elimino prodotto precedente
	$('#edicola_prodotto_titolo_content').empty();
	$('#edicola_prodotto_coverflow_box').empty();
	$('#edicola_prodotto_btns').empty();
	//$('#edicola_prodotto_descr').empty();
	$('#edicola_prodotto_descr_container').empty();
	$('#edicola_prodotto_adv_content').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> getProductDetails(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> getProductDetails(' + productId + ')');
			console.log('--RESP--> getProductDetails ' + JSON.stringify(p_response));
			
			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				_LockTap = false;
				openProductDetails(productId);
			})) {
				//try{
				console.log("OK response openProductDetails " + /*JSON.stringify(*/
				p_response.Result.res/*)*/);
				//var risposta="{\"productName\":\"Il Sole 24 Ore\",\"productId\":\"a1\",\"productDescription\":\"Il Sole 24 ORE è il più autorevole strumento di informazione economica in Italia. Un resoconto chiaro e completo dei fatti che contano. Un aiuto insostituibile per orientarsi nel complesso mondo della finanza, delle normative e dei mercati economici mondiali. Il Sole 24 ORE: l'informazione va oltre il quotidiano!\",\"subscription\":true,\"free\":false,\"singleOffers\":[{\"offerId\":\"QUOTIDIANOSINGOLO\",\"offerDescription\":\"copia singola\",\"offerPrice\":1.59,\"offerItunesProductId\":\"MOBAPP_S24_SINGLE_S24_20120720\"}],\"testata\":\"S24\",\"showarchivio\":\"1\",\"editionId\":\"20120720\",\"editionDescription\":\"20 Luglio 2012\",\"pubDate\":\"20120720\",\"inserts\":[{\"description\":\"Il Sole 24 Ore\",\"insertId\":\"SOLE\",\"cover\":\"http://212.45.97.204/_deploy/S24/20120720/SOLE/cover_high.jpg\",\"anteprima\":0}],\"single\":true,\"demo\":false,\"editionTitle\":\"venerdì 20 luglio 2012\",\"subscriptionOffers\":[{\"offerId\":\"QOL_CANONE_7GG\",\"offerDescription\":\"alla settimana\",\"offerPrice\":9.99,\"offerItunesProductId\":\"http://shopping24.dlv.24orepro.in.ilsole24ore.it/sh4/mobile/android/addToCart.jsp?url_catalog_ref_id=sku1790109&url_product_id=prod1250025\"},{\"offerId\":\"QOL_ABBONAMENTO_MENSILE_PAG\",\"offerDescription\":\"all'anno mensilizzato\",\"offerPrice\":31.99,\"offerItunesProductId\":\"url1\"},{\"offerId\":\"QOL_CANONE_30GG\",\"offerDescription\":\"al mese\",\"offerPrice\":34.99,\"offerItunesProductId\":\"url2\"},{\"offerId\":\"QOL_ABBONAMENTO_ANNUALE_PAG\",\"offerDescription\":\"all'anno\",\"offerPrice\":319.99,\"offerItunesProductId\":\"url3\"}],\"serviceName\":\"products\",\"elapsedTime\":9}";
				schedaProdotto(p_response.Result.res);
				//schedaProdotto($.parseJSON(risposta));
				$('#edicola_prodotto').fadeIn('normal', function(){
					_LockTap = false;
				});
				loadAdvCatalogo(productId);
				loadAdvTabbar(productId);
				window.product.setProduct(productId);
				//}catch(exc){
				//alert(exc.message);
				//}
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			_LockTap = false;
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

	//carico link store android
	loadlink(productId);
}

//carico i link dello store per gli offerItunesProductId
function loadlink(productId) {
	console.log("loadlink " + productId);

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> loadlink(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/links/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			//try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			//console.log('--RESP--> url_loadlink ' +  _SOLEGW_ENDPOINT + "products/links/" + productId + ".json?appKey="+_API24_APPKEY);
			console.log('--RESP--> loadlink(' + productId + ')');
			console.log('--RESP--> loadlink ' + p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				loadlink(productId);
			})) {
				console.log("OK response loadlink "/*+JSON.stringify(p_response)*/);
				loadLinkProdotto(p_response.Result.res);
			} else {
				console.log('Si è verificato un errore nella comunicazione con il server');
			}
		},
		error : function() {
			console.log('Si è verificato un errore nella comunicazione con il server');
		}
	});

}

// Si popola _PRODUCTLINK per l'acquisto
_PRODUCTLINK = [];
function loadLinkProdotto(p_product) {
	console.log("loadLinkProdotto " + p_product.storeLinkItemsList.length + ',' + JSON.stringify(p_product.storeLinkItemsList));
	for (var i = 0; i < p_product.storeLinkItemsList.length; i++) {
		_PRODUCTLINK[i] = {};
		//name
		_PRODUCTLINK[i]['name'] = p_product.storeLinkItemsList[i]['name'];
		//url
		_PRODUCTLINK[i]['url'] = p_product.storeLinkItemsList[i]['url'];
		//productId
		_PRODUCTLINK[i]['productId'] = p_product.storeLinkItemsList[i]['productId'];
		//linkType
		_PRODUCTLINK[i]['linkType'] = p_product.storeLinkItemsList[i]['linkType'];
	}

	console.log("_PRODUCTLINK is  len ::: " + _PRODUCTLINK.length + " :::");
	console.log("_PRODUCTLINK[linkType] is " + ((_PRODUCTLINK) ? _PRODUCTLINK[0]['linkType'] : ""));
}

/**
 * Aggiorna la scheda del prodotto se necessario
 */
function refreshProductDetails() {
	if ((_EDICOLA_CATALOGO_SMALL == true) && (_PRODUCT_IN_EDICOLA != null)) {
		schedaProdotto(_PRODUCT_IN_EDICOLA);
	}
}

/**
 * Crea la scheda del prodotto
 */
//var _EDICOLA_DESCR_ISCROLL = null;
function schedaProdotto(p_product) {
	try {

		console.log("openProductDetails p_product is " + p_product + ',' + p_product.productId);

		if (_PRODUCT_DETAILS_COVERFLOW != null) {
			_PRODUCT_DETAILS_COVERFLOW.destroy();
			_PRODUCT_DETAILS_COVERFLOW = null;
		}
		$('#edicola_prodotto_titolo_content').empty();
		$('#edicola_prodotto_coverflow_box').empty();
		$('#edicola_prodotto_btns').empty();
		$('#edicola_prodotto_descr_container').empty();
		$('#edicola_prodotto_adv_content').empty();

		_PRODUCT_IN_EDICOLA = p_product;

		_HASH_MAP_TESTATA_PRODUCTID[p_product.testata] = p_product.productId;

		_MAP_CODICE_TESTATA[p_product.productId + ''] = p_product.testata;
		
		// titolo
		$('#edicola_prodotto_titolo_content').empty();
		$('<h1>' + p_product.productName + '</h1>').appendTo('#edicola_prodotto_titolo_content');
		$('<h2>' + (p_product.editionDescription != null ? 'Edizione del ' + p_product.editionDescription : '') + '</h2>').appendTo('#edicola_prodotto_titolo_content');

		// Coverflow
		$('#edicola_prodotto_coverflow_box').empty();
		var l_covers_list = [];
		var l_num_covers = p_product.inserts.length;
		for (var i = 0; i < l_num_covers; i++) {
			l_covers_list[i] = {
				'src' : p_product.inserts[i].cover,
				'code' : p_product.inserts[i].insertId,
				'description' : p_product.inserts[i].description,
				'anteprima' : p_product.inserts[i].anteprima && (parseInt(p_product.inserts[i].anteprima) > 0) && !(p_product.free || p_product.subscription),
				'abbonati': p_product.inserts[i].premium && (parseInt(p_product.inserts[i].premium) > 0)
			}
		}
		_PRODUCT_DETAILS_COVERFLOW = new CoveerFlow('edicola_prodotto_coverflow_box', l_covers_list);

		console.log("_PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);

		// bottoni
		$('#edicola_prodotto_btns').empty();
		if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "store") {
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '" ><img src="imgs/edicola_catalogo_appstore_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				window.location = _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'];
			}
		} else if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "webpage") {
			//$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&deviceName=' + encodeURIComponent(device.name) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" class="button red24 commonGenericButton" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
		} else {
			// metto possibilità di tappare dirrettamente sulla cover dell'inserto
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				console.log('TAP ON COVERFLOW: ' + p_product.testata + ' ' + p_product.editionId + ' ' + p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				tapOnAnInsert(p_product);
			}
			// nascondo i bottoni, vengono mostrati quando si sa se è sfoglia o acquisto copia singola
			$('#edicola_prodotto_btns').css('display', 'none');

			console.log('verifica is ' + p_product.productId + ',' + p_product.subscriptionOffers.length + ',' + (p_product.subscriptionOffers && p_product.subscriptionOffers.length));

			// Se ci sono delle offerte
			if (p_product.subscriptionOffers && p_product.subscriptionOffers.length) {
				$('<button class="button medium red24 prodotto_dettaglio_abbonamenti">Abbonamenti</button>').click(function() {
					popupAcquistoAbbonamenti(p_product);
				}).appendTo('#edicola_prodotto_btns');

				for (var i = 0; i < p_product.subscriptionOffers.length; i++) {
					//appstoreReqProduct(p_product.subscriptionOffers[i].offerId, p_product.subscriptionOffers[i].offerItunesProductId)
				}
			}

			// Se c'è la possibilità di acquistare solo un numero viene aggiunto il pulsante per l'acquisto della singola copia
			console.log('productsingle is ' + JSON.stringify(p_product.single));
			if (p_product.single) {
				//for (var i = 0; i < p_product.singleOffers.length; i++) {
				for (var i = 0; i < p_product.singleOffers.length; i++) {
					//creaPulsanteAcquistoSingolo(p_product.singleOffers[i]);
					//$('<button class="button red24 prodotto_dettaglio_acquisto">' + p_product.singleOffers[i].offerPrice + ' €</button>').click(function(){
					$('<button class="button medium red24 prodotto_dettaglio_acquisto">' + ab_euro_formatter(p_product.singleOffers[i].offerPrice) + '</button>').click(function() {
					
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
						mostraPopupInsertoAbbonati();
					} else {	
						acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);
					}
                        
					}).appendTo('#edicola_prodotto_btns');

					//appstoreReqProduct(p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);

					break;
					// <--- visualizzo una sola offerta
				}
			}

			//appstoreReqProducts();

			$('<button class="button medium red24 prodotto_dettaglio_sfoglia">Sfoglia</button>').click(function() {var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);
				if ((!p_product.subscription) && l_edizione_premium) {
					sfogliaCheckPremium(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				} else {
					sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				}
			}).appendTo('#edicola_prodotto_btns');

			$('<br />').appendTo('#edicola_prodotto_btns');

			// Archivio
			$('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" /> Consulta l\'archivio</button>').click(function() {
				if (_LockTap) return;
				_LockTap = true;
				
				console.log("CLICK CONSULTA ARCHIVIO");
				//archivio standard al momento non utilizzato
				if (p_product.productId == _CODICE_PRODOTTO_QUOTIDIANO/*'3'*/) {//CORRETTO????
					// chiamata per aprire archivio STANDARD
					qarchivioOpen(p_product.productId);
				} else {
					// chiamata per aprire archivio QUOTIDIANO
					console.log('archivioOpen p_product.productId' + p_product.productId);
					archivioOpen(p_product.productId);
				}
				
				_LockTap = false;
			}).appendTo('#edicola_prodotto_btns');

			var consultaBtn = $('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" width="15" height="14" /> Consulta l\'archivio</button>');

			checkLocalProductForBtnsRender(p_product);
			console.log(" _PRODUCT_DETAILS_COVERFLOW");
		}

		// Descrizione prodotto
		if (_EDICOLA_DESCR_ISCROLL != null) {
			_EDICOLA_DESCR_ISCROLL.destroy();
			_EDICOLA_DESCR_ISCROLL = null;
		}

		$('#edicola_prodotto_descr_container').empty();
		console.log("descr " + p_product.productDescription);
		//alert("descr "+p_product.productDescription);
		$('<p>' + p_product.productDescription + '</p>').appendTo('#edicola_prodotto_descr_container');

		if (_EDICOLA_DESCR_ISCROLL == null) {
			setTimeout(function() {
				_EDICOLA_DESCR_ISCROLL.refresh();
			}, 100);
			//console.log("1edicolaSSSSSSSasd "+$('#edicola_prodotto_descr_container').outerHeight());
			_EDICOLA_DESCR_ISCROLL = new iScroll('edicola_prodotto_descr', {
				hScroll : false,
				vScroll : true,
				hScrollbar : false,
				bounce : false
			});
			//_EDICOLA_DESCR_ISCROLL.refresh();
		}
		console.log("2edicola descr iscroll is " + $('#edicola_prodotto_descr_container').html() + "::: _EDICOLA_DESCR_ISCROLL " + _EDICOLA_DESCR_ISCROLL);
		//alert("aaa "+ $('#edicola_prodotto_descr_container').html() );
		omnitureTrackApp('APP:edicola:loadProduct:' + p_product.productId, 'APP:edicola');

		console.log(" _PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);
	} catch (exc) {
		console.log(exc.message);
	}
}

function checkLocalProductForBtnsRender(p_product) {
	try {
		var l_testata = p_product.testata;
		var l_issue = p_product.editionId;
		var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

		if (_DB) {
			/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
			var querySuccess = function(tx, p_results) {
				//alert('asd ' + JSON.stringify(p_results.rows));
				var len = p_results.rows.length;
				//console.log("checkLocalProductForBtnsRender: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);
				if ((len > 0) || p_product.free || p_product.subscription) {
					// solo bottone sfoglia
					$('#edicola_prodotto_btns .prodotto_dettaglio_acquisto').css('display', 'none');
					/*console.log('aaa_ant '+$('.coveerflow_anteprima').html());*/
					$('.coveerflow_anteprima').css('display', 'none');
					//alert('aaa_sed' + p_product.free +','+ p_product.subscription );
				} else {
					// acquisto copia singola
					$('#edicola_prodotto_btns .prodotto_dettaglio_sfoglia').css('display', 'none');
					$('.coveerflow_anteprima').css('display', 'inline-block');
				}

				$('#edicola_prodotto_btns').css('display', 'inline-block');
			}
			var queryError = function(p_error) {
				console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	} catch(exc) {
		console.log(exc.message);
	}
}

function mostraPopupInsertoAbbonati() {
	abutils.alert('Per poter leggere questo inserto devi essere abbonato.', 'Inserto per abbonati');
}

function sfogliaCheckPremium(p_testata, p_issue, p_edizione) {
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			if (len > 0) {
				sfoglia(p_testata, p_issue, p_edizione);
			} else {
				mostraPopupInsertoAbbonati();
			}
		}
		var queryError = function(p_error) {
			sfoglia(p_testata, p_issue, p_edizione);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [p_testata, p_issue, p_edizione], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function tapOnAnInsert(p_product) {
	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// se la issue è gratuita o è coperta da abbonamento...
			if (p_product.free || p_product.subscription) {
				// si apre lo sfoglio...
				sfoglia(l_testata, l_issue, l_edizione);
			} else {
				// se la issue è presente in locale (o lo è uno dei suoi inserti)...
				if (len > 0) {
					// controllo se è in locale proprio questa issue
					_DB.transaction(function(tx) {
						tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], function(tx, p_results) {
							var len = p_results.rows.length;
							if (len > 0) {
								// la copia è in locale
								sfoglia(l_testata, l_issue, l_edizione);
							} else {
								// la copia non è ancora in locale
								if (l_edizione_premium) {
									mostraPopupInsertoAbbonati();
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							}
						}, function() {
							sfoglia(l_testata, l_issue, l_edizione);
						});
					}, function() {
						sfoglia(l_testata, l_issue, l_edizione);
					});
					/*
					 if ((!p_product.subscription) && l_edizione_premium) {
					 sfogliaCheckPremium(l_testata, l_issue, l_edizione);
					 } else {
					 sfoglia(l_testata, l_issue, l_edizione);
					 }
					 */
				} else {
					// se è disponibile l'anteprima
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima) > 0)) {
						// apro l'anteprima
						openAnteprima(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima));
					} else {
						// altrimenti se sono presenti degli abbonamenti ...
						if (p_product.subscriptionOffers.length) {
							// si aprono le offerte commerciali ...
							popupAcquistoAbbonamenti(p_product);
						} else {
							// altrimenti se è presente la possibilità di acquisto come copia singola ...
							if (p_product.single && (p_product.singleOffers.length > 0)) {
								// si passa all'acquisto della copia singola ...
								if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
									mostraPopupInsertoAbbonati();
								} else {
									acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[0].offerId, p_product.singleOffers[0].offerItunesProductId);
								}
							} else {
								// niente da fare...
							}
						}
					}
				}
			}
		}
		var queryError = function(p_error) {

		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

// DA CAMBIAREEEEEEEEEEEEEEEEEEEEEEEEEE***************************************
function openAnteprima(p_testata, p_issue, p_edizione, p_anteprima) {
	//openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
	console.log('anteprimaaaa');
	openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
}

function sfoglia(p_testata, p_issue, p_edizione, p_pagina) {
	if (_LockTap) return;
	_LockTap = true;
	
	if ( typeof p_pagina == undefined || p_pagina == null) {
		p_pagina = '1';
	}
	console.log('pagina sfoglia ' 	+ p_pagina);
	//alert('pagina sfoglia ' 	+ p_pagina);
	
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	//APRO LO SFOGLIO ANDROID
	try {
		//window.loader.launchSfogliatore("S24", "SOLE", "20111011", "Descrizione");
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		//alert("style: "+node.style.display);
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		console.log("sfoglia " + p_testata + "," + p_edizione + "," + p_issue + "," + "Descrizione" + window.localStorage.getItem(keyinput) + "," + "aaaa" + "," + null);
		
		if(p_pagina!='1')
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null, p_pagina);
		else
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null);
	} catch(exc) {
		//alert(exc.message);
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}

	//Chiude eventuali schermate aperte

	setTimeout(function() {

		qarchivioClose();
		_LockTap = false;
	}, 1500);

}

function scarica(p_testata, p_issue, p_edizione) {
	sfoglia(p_testata, p_issue, p_edizione);
}

function eliminaCopiaLocale(p_testata, p_issue, p_edizione) {
	//alert("Elimina copia locale testata: " + p_testata + " issue: " + p_issue+ " edizione: " + p_edizione);
	navigator.notification.confirm('Sei sicuro?', function(button) {
		if (button == 1 && _DB) {
			_DB.transaction(function(transaction) {
				transaction.executeSql("DELETE FROM issues WHERE testata=? and issue=? and edizione=?", [p_testata, p_issue, p_edizione], function(transaction) {
					console.log('delete ok');
					
					setTimeout(function() {
						window.soledownloader.cancelDownload(p_testata, p_edizione, p_issue, "", "", true);
					}, 0);

					setTimeout(function() {
						window.soledelete.deleteIssue(p_testata, p_issue, p_edizione);
					}, 1000);

					if (_QARCHIVIO_MODE) {
						//Modifica la visualizzazioni dello stato nell'archivio
						var l_status_el = $('#qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione);
						l_status_el.addClass('qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE);
						l_status_el.removeClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE);
						if (_QARCHIVIO_MODE == 'LIST') {
							$('#qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione).css('display', 'none');
						}
						_NEXT_ACTION = qarchivioLoad;
					}

					// gestione cancellazione da archivio standard
					if ($('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione)) {
						console.log('cancellazione da archivio standard');
						$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).removeClass('archivio_container_box_islocal');
						$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).addClass('archivio_container_box_isremote');
						$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + ' > div > .archivio_button_elimina').css('display', 'none');
					}
				}, function() {
					console.log('delete error');
				});
			});
		}
	}, 'Cancellazione issue', 'Si,No');

}

function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina, p_forceSkipOneshotCheck) {
	if (!p_forceSkipOneshotCheck)
		p_forceSkipOneshotCheck = false;
	if (false/*_ONESHOT_CHECK_REGISTRATO && !_USERNAME && !p_forceSkipOneshotCheck*/) {
		_NEXT_ACTION = function() {
			acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
		}
		popupAcquistoRegistrazione(p_testata);
	} else {
		acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
	}
}

var _CURRENT_FLIPPER_TESTATA = null;
var _CURRENT_FLIPPER_ISSUE = null;
var _CURRENT_FLIPPER_EDIZIONE = null;
var _CURRENT_FLIPPER_PAGINA = null;
function setFlipperCurrentState(p_testata, p_issue, p_edizione, p_pagina) {
	if (p_testata == null)
		console.log('setFlipperCurrentState null*4');
	else
		console.log('setFlipperCurrentState ' + p_testata + ' ' + p_issue + ' ' + p_edizione + ' ' + p_pagina);
	_CURRENT_FLIPPER_TESTATA = p_testata;
	_CURRENT_FLIPPER_ISSUE = p_issue;
	_CURRENT_FLIPPER_EDIZIONE = p_edizione;
	_CURRENT_FLIPPER_PAGINA = p_pagina;
}

function openFlipper(testata, issue, edizione, pagina, anteprima) {
	if (_LockTap) return;
	_LockTap = true;
	try {

		if (anteprima == null || anteprima == 0)
			anteprima = false;
		else
			anteprima = true;

		console.log("openflipper");
		var l_fast_loading = false;

		if ((testata == null) && (issue == null) && (edizione == null)) {
			testata = _CURRENT_FLIPPER_TESTATA;
			issue = _CURRENT_FLIPPER_ISSUE;
			edizione = _CURRENT_FLIPPER_EDIZIONE;
			pagina = _CURRENT_FLIPPER_PAGINA;
			l_fast_loading = true;
		}

		if ((testata == null) || (issue == null) || (edizione == null)) {
			return false;
		}

		if (pagina == null)
			pagina = 1;

		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);

		setTimeout(function() {

			if (anteprima) {
				_CURRENT_FLIPPER_TESTATA = null;
				_CURRENT_FLIPPER_ISSUE = null;
				_CURRENT_FLIPPER_EDIZIONE = null;
				_CURRENT_FLIPPER_PAGINA = null;
			} else {
				_CURRENT_FLIPPER_TESTATA = testata;
				_CURRENT_FLIPPER_ISSUE = issue;
				_CURRENT_FLIPPER_EDIZIONE = edizione;
				_CURRENT_FLIPPER_PAGINA = pagina;
			}
			
			var keyinput = "unread_message_sole";
			var valoutput = 0;

			var node = document.getElementById('appmenu_inbox_count');
			if (node.style.display == 'block' || node.style.display == 'inline-block') {
				valoutput = 1;
			} else {
				valoutput = 0;
			}

			if ( typeof (window.localStorage) != 'undefined') {
				window.localStorage.setItem(keyinput, valoutput);
			} else {
				throw "window.localStorage, not defined";
			}

			// VERIFICA****************************************
			removeToDownloadQueue(testata, edizione, issue);

			console.log(_CURRENT_FLIPPER_TESTATA + ',' + _CURRENT_FLIPPER_EDIZIONE + ',' + _CURRENT_FLIPPER_ISSUE + ',' + _CURRENT_FLIPPER_PAGINA);

			if (!anteprima) {
				window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
			} else {
				console.log('anteprima launch');
				window.soledownloader.launchAnteprimaSfogliatore(testata, edizione, issue, "Descrizione" + valoutput, null, null);
			}

			setTimeout(function() {
				//window.go.to(_CURRENT_FLIPPER_PAGINA);

				// chiudo eventuali schermate aperte
				qarchivioClose();
				archivioClose();
				popupAcquistoAbbonamentiClose();
				popupAcquistoRegistrazioneClose();

				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				omnitureTrackApp('APP:edicola:open:' + testata + ':' + issue + ':' + edizione + ( anteprima ? ':PREVIEW' : ''), 'APP:edicola');
				nielsenCall('SFOGLIATORE');
				_LockTap = false;
			}, 3000);

		}, 250);

		return true;
	} catch (exc) {
		console.log(exc.message);
		return false;
	}
}

/*
 * Controlla se un prodotto sia stato scaricato in locale ed in caso abilita il pulsante Sfoglia
 * @params p_product Prodotto
 */
function checkLocalProduct(p_product) {

	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("checkLocalProduct: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);

			if (len) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				creaPulsanteSfoglia(p_product, false);
				// Se il prodotto/inserto è presente in locale avrò il pulsante sfoglia in grigio
			} else if (p_product.free || p_product.subscription) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				// Se il prodotto/inserto non è presente in locale il pulsante sfoglia sarà rosso
				creaPulsanteSfoglia(p_product, true);
			} else {
				// Vengono mostrati gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeIn(200);
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			//tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], querySuccess, queryError);
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function creaPulsanteSfoglia(p_product, p_red) {
	var l_pulsante = $('#edicola_prodotto_sfoglia_btn');

	if (!l_pulsante.length) {

		l_pulsante = $('<button id ="edicola_prodotto_sfoglia_btn" class="button">Sfoglia</button>');

		if (p_red) {
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.addClass('gray');
		}

		l_pulsante.click(function() {
			sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
		});

		l_pulsante.appendTo('#edicola_prodotto_btns');

	} else {
		if (p_red) {
			l_pulsante.removeClass('gray');
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.removeClass('red24');
			l_pulsante.addClass('gray');
		}
	}
}

var _EDICOLA_CATALOGO_SMALL = false;
function edicolaCatalogoSwitchView() {

	var isPortrait = window.innerWidth < window.innerHeight;
	_EDICOLA_CATALOGO_SMALL = !_EDICOLA_CATALOGO_SMALL;

	if (!_EDICOLA_CATALOGO_SMALL) {
		$('.edicola_prodotto_box_icon_selected').removeClass('edicola_prodotto_box_icon_selected');
		_PRODUCT_IN_EDICOLA = null;
	}
	
	if (isPortrait) {
		if ($('#edicola_catalogo').css('top') == '1px') {
			$('#edicola_catalogo').animate({
				'top': '-' + ($('#centrale').height() - 180) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'top': '1px'
			});
		}
	} else {
		if ($('#edicola_catalogo').css('left') == '1px') {
			$('#edicola_catalogo').animate({
				'left': ($('#centrale').width() - 200) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'left': '1px'
			});
		}
	}

	$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
	$('#edicola_container > .edicola_prodotto_box').toggleClass('edicola_prodotto_box_small');
	$('#edicola_wrapper').toggleClass('edicola_wrapper_small');
	
	setTimeout(function() {
		updateEdicolaProductsIscroll();
	}, 0);

	if (_EDICOLA_DESCR_ISCROLL != null && !_EDICOLA_CATALOGO_SMALL) {
		_EDICOLA_DESCR_ISCROLL.destroy();
		_EDICOLA_DESCR_ISCROLL = null;
	}
}

/**
 * Filtra i prodotti in edicola.
 */
function edicolaFiltroProdotti() {
	var l_selected_option = $('#edicola_titolo_btn_select option:selected');

	if (l_selected_option.val() == '') {
		$('#edicola_container .edicola_prodotto_box').fadeIn(200);
	} else {
		$('#edicola_container .edicola_prodotto_box').not('.' + l_selected_option.val()).css('display', 'none');
		$('#edicola_container .edicola_prodotto_box.' + l_selected_option.val()).fadeIn(200);
	}
}

/* --------- gestione drag&drop catalogo ----------- */
var _EDICOLA_TOUCH_START_POS_X = 0;
var _EDICOLA_TOUCH_START_POS_Y = 0;
var _EDICOLA_TOUCH_START_Y = 0;
var _EDICOLA_TOUCH_START_X = 0;
var _EDICOLA_TOUCH_MOVE_Y = 0;
var _EDICOLA_TOUCH_MOVE_X = 0;
var _EDICOLA_TOUCH_STARTED = false;
var _EDICOLA_TOUCH_MOVED = false;
function edicolaTouchStart(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_STARTED = true;
		_EDICOLA_TOUCH_MOVED = false;
		_EDICOLA_TOUCH_START_POS_X = $('#edicola_catalogo').offset().left;
		/*_EDICOLA_TOUCH_START_X = _event.clientX;*/
		_EDICOLA_TOUCH_START_POS_Y = $('#edicola_catalogo').offset().top;
		_EDICOLA_TOUCH_START_X = _event.clientX;
		_EDICOLA_TOUCH_START_Y = _event.clientY;

	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMove(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_X = _event.clientX;
		var position = Math.max(0, Math.min(_EDICOLA_TOUCH_START_POS_X + $('#edicola_wrapper').position().left, (_EDICOLA_TOUCH_START_POS_X + _EDICOLA_TOUCH_MOVE_X - _EDICOLA_TOUCH_START_X)));
		if (position <  - ($('#centrale').height() - 180)) position = - ($('#centrale').height() - 180);
		$('#edicola_catalogo').css('left', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMoveVertical(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_Y = _event.clientY;
		var position = Math.min(0, _EDICOLA_TOUCH_START_POS_Y + _EDICOLA_TOUCH_MOVE_Y - _EDICOLA_TOUCH_START_Y);
		if (position <  - ($('#centrale').height() - 180)) position = - ($('#centrale').height() - 180);
		$('#edicola_catalogo').css('top', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchEnd(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		if (!_EDICOLA_TOUCH_MOVED)
			return;
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		_EDICOLA_TOUCH_STARTED = false;
		edicolaCatalogoSwitchView();
		
	} catch (exc) {
		console.log(exc.message);
	}
}

/******************************************************
 Gestione demo
 ******************************************************/
/**
 * Verifica che l'utente possa utilizzare la demo
 */
function verifyDemo() {
	console.log("---REQ---> verifyDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	} else {
		_NEXT_ACTION = verifyDemo;
		//popupAccediRegistrati();
		popupAcquistoRegistrazione();
		return;
	}

	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> verifyDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, verifyDemo)) {
				if (p_response.Result.res.canUseDemo == true)
					useDemo();
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

/**
 * Utilizza la demo
 */
function useDemo() {
	console.log("---REQ---> useDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		'userIdentity' : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		'username' : _USERNAME
	}

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		dataType : "json",
		processData : false,
		data : JSON.stringify(l_req_data),
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('----> useDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, useDemo)) {
				//&& p_response.Result.res.canUseDemo == true
				sfoglia(_PRODUCT_IN_EDICOLA.testata, _PRODUCT_IN_EDICOLA.editionId, _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				omnitureTrackApp('APP:edicola:demo:' + _PRODUCT_IN_EDICOLA.testata + ':' + _PRODUCT_IN_EDICOLA.editionId + ':' + _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, 'APP:edicola');
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

_ABBONAMENTI_ISCROLL = null;
/* --------- gestione schermata acquisto ----------------- */
function popupAcquistoAbbonamenti(p_product_detail) {

	function creaPulsanteAbbonamento(p_offerta) {
		console.log("p_offerta is " + _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][0]['linkType'] + ',' + JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']) + ',' + JSON.stringify(p_product_detail) + '::' + JSON.stringify(p_offerta));
		var linkPulsante = '';
		for (var x = 0; x < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; x++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['name'] == p_offerta.offerId) {
				linkPulsante = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['linkType'];
			}
		}

		if (!linkPulsante) {
			//_PRODUCTLINK
			console.log(JSON.stringify(_PRODUCTLINK));
			for (var x = 0; x < _PRODUCTLINK.length; x++) {
				if (_PRODUCTLINK[x]['name'] == p_offerta.offerId) {
					linkPulsante = _PRODUCTLINK[x]['linkType'];
				}
				_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x] = _PRODUCTLINK[x];
			}

		}

		if (linkPulsante && linkPulsante.toString().indexOf('nolink') != -1) {
			//niente
		} else {
			$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
				popupAcquistoAbbonamentiClose();
				if (_USERNAME) {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /*|| p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
						//console.log("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
						
						//alert(JSON.stringify(p_product_detail, null, 4));
						//alert(JSON.stringify(p_offerta, null, 4));
						
						popupRiepilogoApri(p_product_detail, p_offerta);
					} else {
						//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
						//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
						
						//alert(JSON.stringify(p_product_detail, null, 4));
						//alert(JSON.stringify(p_offerta, null, 4));
						
						window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
						console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
					}
				} else {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					_NEXT_ACTION = function() {
						if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /* || p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG') !=-1*/) {//in caso di abbo annuale altra maschera
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							popupRiepilogoApri(p_product_detail, p_offerta);
						} else {
							//console.log("p_product_detail is "+JSON.stringify(p_product_detail));
							//procediAcquistoAbbonamento(p_product_detail, p_offerta.offerId, p_offerta.offerItunesProductId);
							window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
							console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
						}
					}
					popupAcquistoRegistrazione(p_offerta.offerId);
				}
			}).appendTo('#acquisto_abbonamenti_offerte');
		}
	}

	function creaPulsanteCopiaSingola(p_offerta) {
		$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
			//acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			//alert("p_product_detail is "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
			popupAcquistoAbbonamentiClose();
			acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			console.log("offerItunesProductId " + p_offerta.offerItunesProductId);

		}).appendTo('#acquisto_abbonamenti_offerte');
	}


	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_others').css('display', p_product_detail.testata == 'S24' ? 'none' : 'inline-block');
	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_s24').css('display', p_product_detail.testata == 'S24' ? 'inline-block' : 'none');
	if (p_product_detail.testata == 'S24') {
		$('#acquisto_abbonamenti_body_prodotto').html('Il Sole 24 Ore Versione Digitale');
	} else {
		$('#acquisto_abbonamenti_body_prodotto').html(p_product_detail.productName);
	}
	// Inserimento offerte
	$('#acquisto_abbonamenti_offerte').empty();
	
	var l_inserto_premium = p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (!l_inserto_premium) {
		for (var i = 0; i < p_product_detail.singleOffers.length; i++) {
			creaPulsanteCopiaSingola(p_product_detail.singleOffers[i]);
			break;
			// <-- una sola offerta singola
		}
	}

	for (var i = 0; i < p_product_detail.subscriptionOffers.length; i++) {
		creaPulsanteAbbonamento(p_product_detail.subscriptionOffers[i]);
	}
	// Demo prodotto
	if ((!l_inserto_premium) && p_product_detail.demo == true)
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'none');
	/* ---- inizio modifica ---- */
	if (_USERNAME == null)
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'none');
	/* ---- fine modifica ---- */

	// Viene mostrato il popup
	$('#acquisto_abbonamenti').css('display', 'inline');

	//$('#acquisto_abbonamenti_wrapper').height($('#acquisto_abbonamenti_content').height());

	if (_ABBONAMENTI_ISCROLL == null /*_ORIENTATION == 'H'*/ ) {
		_ABBONAMENTI_ISCROLL = new iScroll('acquisto_abbonamenti_wrapper', {
			bounce : false
		});
		_ABBONAMENTI_ISCROLL.refresh();
	} else {
		_ABBONAMENTI_ISCROLL.refresh();
	}

	$('select').attr('disabled', 'disabled');
}

function popupAcquistoAbbonamentiClose() {
	//$('#acquisto_abbonamenti').fadeOut();
	$('#acquisto_abbonamenti').css('display', 'none');
	$('select').removeAttr('disabled');
}

var _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = null;
function popupAcquistoRegistrazione(p_testata) {
	console.log("REGISTRAZIONE" + p_testata);
	//-------INIZIO
	if (p_testata == 'S24') {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'none');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'block');
		document.getElementById('acquisto_registrazione_body').className = '';
	} else {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'block');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'none');
		document.getElementById('acquisto_registrazione_body').className = 'acquisto_registrazione_type_others';
	}
	//-------FINE
	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	if (_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is " + _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL);
}

function popupAcquistoRegistrazioneClose() {
	//$('#acquisto_registrazione').fadeOut();
	console.log("REGISTRAZIONE chiusa");
	$('#acquisto_registrazione').css('display', 'none');
}

function acquistoAbbonamento(abbonamento) {
	popupAcquistoRegistrazione();
}

function popupAcquistoRegistrazioneRegistrati() {
	console.log("REGISTRAZIONE 1");
	popupRegistrazioneApri();
}

function procediAcquistoAbbonamento(p_product, p_offerta, p_itunes) {
	var l_testata = p_product.testata;
	if (!l_testata)
		l_testata = 'S24';
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
}

function acquistoAbbonamentiAgganciaAbbonamento() {

	_NEXT_ACTION = acquistoAbbonamentiAgganciaAbbonamento_done;

	popupLogin();

}

function acquistoAbbonamentiAgganciaAbbonamento_done() {
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggancio abbonamento..."]);
	// controllo stato abbonamento

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + _PRODUCT_IN_EDICOLA.productId);
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription/' + _PRODUCT_IN_EDICOLA.productId);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				acquistoAbbonamentiAgganciaAbbonamento_done();
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					//if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}

				if (l_attivo) {

					acquistoAbbonamentiAgganciaAbbonamento_complete('Aggancio abbonamento completato. Il tuo abbonamento scade il ' + l_date_end.format('dd/mm/yyyy'));
				} else {
					acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
				}

			} else {
				acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
			}
		},
		error : function() {
			acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
		}
	});

}

function acquistoAbbonamentiAgganciaAbbonamento_complete(p_msg) {
	abutils.alert(p_msg, 'Aggancia abbonamento');

	// chiudo schermata abbonamenti
	popupAcquistoAbbonamentiClose();
	// ricarico dettaglio prodotto
	openProductDetails(_PRODUCT_IN_EDICOLA.productId);

	/*navigator.notification.loadingStop();*/
	window.simulatePG.exec(null, null, "Notification", "activityStop", []);
}

function acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina) {
	if (!p_pagina)
		p_pagina = 1;
	var l_productid = _HASH_MAP_TESTATA_PRODUCTID[p_testata];

	//alert('aaa '+l_productid);
	if (!l_productid) {
		//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione, p_pagina); });
		//BUY
		var link_singola = '';
		for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
				link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
			}
		}

		if (!link_singola || link_singola == '') {
			_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] = _PRODUCTLINK;
			for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
				}
			}
		}

		if (link_singola != '') {
			window.payment.paySingle(p_testata, p_issue, p_edizione, p_offerta, p_itunes, link_singola);
		} else {
			abutils.alert('Errore su link!', 'Pagamento');
		}

	} else
		checkAcquisto(l_productid, p_issue, p_edizione, p_offerta, p_itunes, function() {
			sfoglia(p_testata, p_issue, p_edizione, p_pagina);
		});
	//appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue, p_edizione); });
}

var _DEBUG_MODE = !('ontouchstart' in window), _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseup';
/*
 var _API24_APPKEY = "IpadQuot";//<- PRODUZIONE //// DA CAMBIARE!!! //DroidQuot
 //var _API24_APPKEY = "1123344";//<- NEURAL
 //var _API24_SIGNATURE_KEY = "qu0t$STG";//<- PRODUZIONE
 var _API24_SIGNATURE_KEY = "qu0t$PROD";//<- PRODUZIONE
 //var _API24_SIGNATURE_KEY = "pppppppp";//<- NEURAL
 var _API24_SITECODE = "MB"
 var _API24_ENDPOINT = "https://api24.ilsole24ore.com/"; //<- PRODUZIONE
 //var _API24_ENDPOINT = "http://10.5.4.166:400/";//<- NEURAL
 var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";

 var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
 */
 
var isPortrait = null, screenHeight = null, screenWidth = null;

var _SCREENADV = window.innerWidth;

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _debugIPADContent = false;

var _API24_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot' ;
//<- PRODUZIONE //DroidQuot iPadQuot
var _API24_SIGNATURE_KEY = "qu0t$PROD";
//<- PRODUZIONE
var _API24_SITECODE = "MB"
var _API24_ENDPOINT = "https://api24.ilsole24ore.com/";
//<- PRODUZIONE
var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";
var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php";

var _API24TEST_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot' ;
//<- STAGE //DroidQuot iPadQuot
var _API24TEST_SIGNATURE_KEY = "qu0t$STG";
//<- STAGE
var _API24TEST_SITECODE = "MB"
var _API24TEST_ENDPOINT = "http://api24test.ilsole24ore.com/";
//<- STAGE
var _SOLEGWTEST_ENDPOINT = _API24TEST_ENDPOINT + "SoleGateway/";
var _ADVTEST_PROXY = "http://212.45.97.204/adv_proxy_and.php";

// Variabile globale contenente lo username dell'utente che sta utilizzando l'applicativo
var _USERNAME = null;
// Variabile globale contenente la password dell'utente che sta utilizzando l'applicativo
var _USER_PASSWORD = null;
// Variabile globale contenente lo user identity associato all'utente
var _USER_IDENTITY = null;
// Variabile contenente la funzione da richiamare come prossima azione. Utile in diverse situazioni per esempio dopo aver fatto la login e proseguire con la prossima azione.
var _NEXT_ACTION = null;

var _AJAX_TIMEOUT = 15000;
var _INTERVALLO_CHECK_INBOX = 15 * 60 * 1000;
var _INTERVALLO_CHECK_ONLINE = 15 * 1000;

/*******************AGGIUNTA PER CHECKACQ*****************************************/
//metterlo a false se non si vogliono usare le categorie
//quotidiano --> false
//riviste professionali --> true
var _EDICOLA_USE_CATEGORIES = false;
//metterlo a true se si vuole chiedere la registrazione pre-acquisto one-shot
//quotidiano --> false
//riviste professionali --> true
var _ONESHOT_CHECK_REGISTRATO = true;

/************************************************************/
var _menuButtonsIndex = ['#appmenu_edicola', '#appmenu_preferiti', '#appmenu_inbox', '#appmenu_impostazioni'];

var _PRODOTTO_PRINCIPALE_DEFAULT = {
	id : (_debugIPADContent) ? "1" : "a1",
	descr : "Il Sole 24 ORE"
};

var _DEVICE_SETTINGS = {
	platform : "2",
	appname : (_debugIPADContent) ? "ITQUOIPAD" : "ITQUOANDROID", // DA CAMBIARE!!! //ITQUOANDROID ITQUOIPAD
	appversion : (_debugIPADContent) ? "2.2" : "1.1" //da cambiare in a2.0 2.2 1.0
}

var _MAP_CODICE_TESTATA = (_debugIPADContent) ? { '1' : 'S24' } : { 'a1' : 'S24' } ;
var _CODICE_PRODOTTO_QUOTIDIANO = (_debugIPADContent) ? '1' : 'a1' ;

function getQueryString(key) {
	key = key.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	var regex = new RegExp("[\\?&]"+key+"=([^&#]*)");
	var qs = regex.exec(window.location.href);
	if (qs == null) return ''; else return qs[1];
}

function setUserData(p_username, p_password, p_useridentity) {
	console.log('setUserData ' + p_username + ' ' + p_password + ' ' + p_useridentity);
	if (p_username == null || p_password == null || p_useridentity == null) {
		deleteUsername();
		deletePassword();
		_USERNAME = null;
		_USER_PASSWORD = null;
		_USER_IDENTITY = null;
		//PhoneGap.exec('AppStore.setUserInfo');
		//window.plugins.appstore.setUserInfo();
	} else {
		storeUsername(p_username);
		storePassword(p_password);
		_USERNAME = p_username;
		_USER_PASSWORD = p_password;
		_USER_IDENTITY = p_useridentity;
		//PhoneGap.exec('AppStore.setUserInfo', _USERNAME, _USER_IDENTITY);
		//window.plugins.appstore.setUserInfo(null, null, _USERNAME, _USER_IDENTITY);
		//console.log('logging  '+p_username+','+p_password);
	}

	//console.log('setUserData2 ' + _USERNAME + ' ' + _USER_PASSWORD + ' ' + _USER_IDENTITY);
}

function applicationWillEnterForeground() {
	console.log('JS|applicationWillEnterForeground');
	return "OK";
}

function applicationDidEnterBackground() {
	console.log('JS|applicationDidEnterBackground');
	return "OK";
}

var ROTATION_CLASSES = {

	"0" : "none",
	"90" : "right",
	"-90" : "left",
	"180" : "flipped"

};

/*
function detectOrientationEvent() {
	var orientationEvents = ['onorientationchange', 'reorient', 'resize'];
	var orientationEvent = null;
	for (var i = 0; i < orientationEvents.length; i++) {
		if (orientationEvents[i] in window) {
			orientationEvent = orientationEvents[i];
			break;
		}
	}
	return orientationEvent;
}
*/

function monitorOrientationChanges() {
	setInterval(function(){
		updateOrientation();
	}, 500);
}

function search() {
	window.searchlaunch.launch();
}

var CURRENT_ORIENTATION = null;
var _appPageIndex = 0;

function openAppPage(index) {
	_appPageIndex = index;
}

function onBodyLoad() {
	//alert('version 61');
	document.addEventListener("deviceready", onDeviceReady, false);
	document.addEventListener("touchmove", function(e) {
		e.preventDefault();
	}, false);

	if (_DEBUG_MODE) {
		document.getElementById('edicola_catalogo_tiro').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener('click', function() {
			edicolaCatalogoSwitchView();
		}, false);
	} else {
		document.getElementById('edicola_catalogo_tiro').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_MOVE_EV, edicolaTouchMove, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);

		//verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_MOVE_EV, edicolaTouchMoveVertical, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(_CANCEL_EV, edicolaTouchEnd, false);
	}

	/* inizializzazione componenti grafiche */
	GalaxyCheckboxStyle.init();

	/* inizializzazione componenti grafiche */
	if ($(".registrazione_body_group :checkbox").iphoneStyle != null)
		$(".registrazione_body_group :checkbox").iphoneStyle({
			checkedLabel : 'SI',
			uncheckedLabel : 'NO'
		});

	monitorOrientationChanges();

	setTimeout(function() {
		updateOrientation();
		//$(_menuButtonsIndex[_appPageIndex]).trigger('click');
	}, 200);

	document.addEventListener("backbutton", backKeyDown, true);

	if (_DEBUG_MODE) {
		device = {// ATTENZIONE, dati impostati anche in onDeviceReady
			platform : _DEVICE_SETTINGS.platform,
			appname : _DEVICE_SETTINGS.appname,
			appversion : _DEVICE_SETTINGS.appversion,
			name : 'Il mio Safari ;)',
			uuid : '201111111115'
		}

		PhoneGap = {};
		PhoneGap.exec = function(successCB, errorCB, namespace, method) {
			console.log('PG ' + namespace + ' . ' + method);
		};
		PhoneGap.windowEventHandler = function() {
		};
		if (navigator == null) {
			console.log("create navigator");
			navigator = {};
		}
		if (navigator.notification == null)
			navigator.notification = {};
		if (navigator.notification.loadingStart == null)
			navigator.notification.loadingStart = function() {
				console.log('loadingStart');
			};
		if (navigator.notification.loadingStop == null)
			navigator.notification.loadingStop = function() {
				console.log('loadingStop');
			};

		if (!window.plugins)
			window.plugins = {};
		window.plugins.flipper24 = new PGFlipper24();
		//window.plugins.appstore = new PGAppStore();
		navigator.plugins.notificationEx = new NotificationEx();
		//window.plugins.pgaleberutils = new PGAleBerUtils();

		onDeviceReadyDeviceInfo(null);
	}
	
	device = {
			uuid : null,
			version : null,
			platform : null,
			name : null,
			phonegap : null
	};

	if( !device.uuid ) {
    	//alert('sasa 0ok');
    	device.uuid = window.simulateDevice.getUuid();
		device.version =  window.simulateDevice.getOSVersion();
		device.platform = window.simulateDevice.getPlatform();
		device.name = window.simulateDevice.getProductName();
		device.phonegap = window.simulateDevice.getPhonegapVersion();
	}

}

function backKeyDown() {
	// ALERT sei sicuro, se si esegui finish()
	window.runfunc.askandrun('Sei sicuro di voler uscire?', '');
}

function onDeviceReady() {
	if (_API24TEST_SWITCH) {
		console.log('************* PUNTAMENTO AD AMBIENTE DI TEST ***********************');
		_API24_APPKEY = _API24TEST_APPKEY;
		_API24_SIGNATURE_KEY = _API24TEST_SIGNATURE_KEY;
		_API24_SITECODE = _API24TEST_SITECODE;
		_API24_ENDPOINT = _API24TEST_ENDPOINT;
		_SOLEGW_ENDPOINT = _SOLEGWTEST_ENDPOINT;
		_ADV_PROXY = _ADVTEST_PROXY;
	}

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Caricamento in corso..."]);
	//window.plugins.pgaleberutils.activityStart();
	//window.plugins.pgaleberutils.deviceExtraInfo(onDeviceReadyDeviceInfo, onDeviceReadyDeviceInfo);
	onDeviceReadyDeviceInfo(null);
}

function onDeviceReadyDeviceInfo(extraInfo) {
	//mod 03012013  
	//inizializziamo l'uuid
	device.uuid = window.infodroid.getuuid();
	
	window.infodroid.setuuid(device.uuid);
	//**********************FINE**
	device.orig_uuid = device.uuid;
	if (extraInfo != null && extraInfo.deviceid != null)
		device.uuid = extraInfo.deviceid;

	device.appname = (extraInfo == null || extraInfo.appname == null) ? "---" : extraInfo.appname;
	device.appversion = (extraInfo == null || extraInfo.appversion == null) ? "---" : extraInfo.appversion;
	//DA CAMBIARE
	//device.usedspace = (extraInfo == null || extraInfo.usedspace == null) ? "---" : extraInfo.usedspace;
	//device.usedspaceperc = (extraInfo == null || extraInfo.usedspaceperc == null) ? "---" : extraInfo.usedspaceperc;
	device.usedspace = (window.infodroid == null) ? "---" : window.infodroid.dirSize("/S24/");
	device.usedspaceperc = (window.infodroid == null) ? "---" : window.infodroid.dirSizePerc("/S24/");

	/*  MOD 03012013
	if (navigator == null)
		navigator = {};
	if (navigator.fileMgr == null)
		navigator.fileMgr = {};
	if (navigator.fileMgr.libFolderPath == null)
		navigator.fileMgr.libFolderPath = (extraInfo == null || extraInfo.libFolderPath == null) ? "" : extraInfo.libFolderPath;

	if (navigator.notification == null)
		navigator.notification = {};
	if (navigator.notification.loadingStart == null)
		navigator.notification.loadingStart = navigator.plugins.notificationEx.loadingStart;
	if (navigator.notification.loadingStop == null)
		navigator.notification.loadingStop = navigator.plugins.notificationEx.loadingStop;
	 */
	
	// DA VERIFICARE!!! forzo il device.platform a 1
	device.platform = _DEVICE_SETTINGS.platform;
	device.appversion = _DEVICE_SETTINGS.appversion;
	device.appname = _DEVICE_SETTINGS.appname;
	
	console.log = function(msg) {
	};
	
	/* inizializzazione prodotto principale */
	var l_local_storage_prodotto_principale = window.localStorage.getItem("prodotto_principale_id");
	console.log('prodotto principale settato: ' + l_local_storage_prodotto_principale);
	if (l_local_storage_prodotto_principale == null) {
		window.localStorage.setItem("prodotto_principale_id", _PRODOTTO_PRINCIPALE_DEFAULT.id);
		window.localStorage.setItem("prodotto_principale_descr", _PRODOTTO_PRINCIPALE_DEFAULT.descr);
	}

	// non piu' usato, ma può essere lasciato: all'avvio viene lasciata accesa l'edicola dello sfoglio, per forzare il loading di entrambe le immagini
	// qui viene ripristinata l'icona dell'edicola, e tolta quella dello sfoglio
	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');

	// setta il valore di _ORIENTATION
	initOrientation();

	// apertura db
	inizializzaDatabase();
	
	// controllo username
	controlloUsername();
	
}

function onDeviceReady_aux() {

	initCheckProducts();

	//Controlla lo stato online/offline
	initCheckOnline();

	downloadManagerDBinit();

	inboxLoadMessages();

	loadAdvTabbar();
	loadAdvCatalogo();

	setTimeout(function() {
		//$('#splashscreen').css('display', 'none');
		//window.plugins.pgaleberutils.activityStop();
		//window.plugins.pgaleberutils.splashScreenHide();
		//navigator.notification.loadingStop();
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		if (_API24TEST_SWITCH) {
			abutils.alert('Stai utilizzando l\'ambiente di test...');
		}
	}, 3000);
}

function loadAdvTabbar(product_id) {
	//alert("CALL ME!!!");
	//document.getElementById('advtabbar_close').style.display = 'none';
	document.getElementById('advtabbar_close_content').innerHTML = '';
	//$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){

	console.log(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);

	$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {

	}).endCapture();
	document.getElementById('advtabbar_open_content').innerHTML = '';
	console.log(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);
	//$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
	$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();

}

var _TABBAR_ADV_IS_OPEN = false;

function handleAdvTabbarClick() {
	var _width_close = $('#advtabbar_close_content img').first().width();
	// evita di aprire il contenuto se non c'è nulla caricato
	if ((_width_close == null) || (_width_close < 5))
		return;
	//alert("CALL ME1!!!");
	_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
	document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
	document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
}

function loadAdvCatalogo(product_id) {
	//alert("CALL ME2!!!");
	document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
	//$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
	$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();
}

function getSignature(p_request_params) {
	return Crypto.HMAC(Crypto.SHA1, p_request_params, _API24_SIGNATURE_KEY).toUpperCase();
}

var _ORIENTATION = '';

function initOrientation() {
	console.log('********init_Orientation********');

	if (window.innerWidth > window.innerHeight) {
		_ORIENTATION = 'H';
	} else {
		_ORIENTATION = 'V';
	}
}

var _UPDATE_ORIENTATION_RUNNING = false;

function updateOrientation() {
	var that = this;
	setTimeout(function(){
		screenHeight = (_DEBUG_MODE) ? window.innerHeight : document.documentElement.clientHeight ;
		screenWidth = (_DEBUG_MODE) ? window.innerWidth : document.documentElement.clientWidth ;
		isPortrait = screenWidth < screenHeight;
		//alert("screenWidth " + screenWidth + ", screenHeight " + screenHeight);
		
		var orientation = isPortrait ? 1 : 2 ;
		if (CURRENT_ORIENTATION == orientation) return;
		CURRENT_ORIENTATION = orientation;
				
		if (_UPDATE_ORIENTATION_RUNNING) return;
		_UPDATE_ORIENTATION_RUNNING = true;
		console.log('_ORIENTATION ' + _ORIENTATION);
		
		if (!isPortrait) {
			_ORIENTATION = 'H';
		} else {
			_ORIENTATION = 'V';
		}
			
		$('#wrapper').width(screenWidth).height(screenHeight);
	
		// FONT SIZE CALCULATION
		var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.013) : Math.round(screenWidth * 0.013);
		$('body').css('font-size', fontSizeRatio + 'px');
		fontSizeRatio = null;
		
		var edicolaSmallHeight = 180;
		$('#centrale').height(screenHeight - $('#appmenu').height());
		$('#inbox_list_wrapper').height(screenHeight - $('#inbox_list_title').height() - $('#appmenu').height() - $('#inbox_list_refresh').height());
			
		if (isPortrait) {
			// PORTRAIT
			$('#edicola_prodotto').height($('#edicola').height() - edicolaSmallHeight).width('100%');
			$('#edicola_prodotto_coverflow').width('100%');
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_subtitolo_prodotto').height() - $('#archivio_subtitolo_opzioni').height() - $('#archivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(50);
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_subtitolo_prodotto').height() - $('#qarchivio_subtitolo_opzioni').height() - $('#qarchivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width('100%');
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width('100%');
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height() - $('#edicola_offline_subtitolo_opzioni').height());
			$('#qarchivio_label_local_v').show();
			$('#qarchivio_label_local_h').hide();
		} else {
			// LANDSCAPE
			$('#edicola_prodotto').height('100%').width(screenWidth - 200);
			$('#edicola_prodotto_coverflow').width(screenWidth - 200 - ((screenWidth - 200) * 0.3));
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(screenHeight - $('#qarchivio_titolo').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width(screenWidth - $('#qarchivio_subtitolo_prodotto').width());
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width(screenWidth - $('#archivio_subtitolo_prodotto').width());
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height());
			$('#qarchivio_label_local').css('top', (screenHeight - 40) + 'px');
			$('#qarchivio_label_local_h').show();
			$('#qarchivio_label_local_v').hide();
		}
		
		// COMMON
		$('.commonContentWithTopBar').height(Math.round((screenHeight * 0.9) - 50));
		$('.commonWindowWithTopBar').height(screenHeight - 50);
		$('.commonWindowWithAppBar').height(screenHeight - 50 - $('#appmenu').height());
		$('.commonMaxContentWithTopBar').css('max-height', (screenHeight * 0.9) - 50);
		
		updateEdicolaProductsIscroll();
		if (_PRODUCT_DETAILS_COVERFLOW != null) _PRODUCT_DETAILS_COVERFLOW._display();
		
		qarchivioUpdateIScroll();
		inboxUpdateOrientation();
		preferitiUpdateOrientation();
		impostazioniUpdateOrientation();
	
		if (_REGISTRAZIONE_ISCROLL != null) _REGISTRAZIONE_ISCROLL.refresh();
		if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) _IMPOSTAZIONI_ISCROLL_PRIVACY.refresh();
	
		_UPDATE_ORIENTATION_RUNNING = false;
	}, 100);
}

/******************************************************
 Gestione schermata di riepilogo abbonamento annuale
 ******************************************************/
var _RIEPILOGO_ISCROLL = null;
var _RIEPILOGO_PRODUCT = null;
var _RIEPILOGO_OFFER = null;

function popupRiepilogoApri(p_product_detail, p_offerta) {
	console.log('detail ' + /*JSON.stringify(*/
	p_product_detail['subscriptionOffers'] /*)*/ );
	_RIEPILOGO_PRODUCT = p_product_detail;
	_RIEPILOGO_OFFER = p_offerta;
	if (_RIEPILOGO_ISCROLL == null && _ORIENTATION == 'H') {
		_RIEPILOGO_ISCROLL = new iScroll('riepilogo_body', {
			bounce : false
		});
		_RIEPILOGO_ISCROLL.refresh();
	}

	_RIEPILOGO_OFFER = {};
	//p_product_detail['subscriptionOffers'];

	// alert("aaa "+p_product_detail['subscriptionOffers'].length);

	for (var j = 0; j < p_product_detail['subscriptionOffers'].length; j++) {
		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['annuale_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['annuale_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in unica soluzione.<BR/>L\'importo visualizzato a fianco si riferisce alla quota annuale di abbonamento';
			_RIEPILOGO_OFFER['annuale_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['annuale_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_MENSILE_PAG') {
			_RIEPILOGO_OFFER['mensile_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['mensile_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in rate mensili.<BR/>L\'importo visualizzato a fianco si riferisce al canone mensile di abbonamento';
			_RIEPILOGO_OFFER['mensile_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['mensile_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		//se i codici che mi arrivano non sono quelli attessi mi conservo quello che arriva
		if (p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_MENSILE_PAG' && p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['x_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['x_descr'] = 'Abbonamento a ' + p_product_detail.productName + '<BR/>in versione digitale.<BR/>';
			_RIEPILOGO_OFFER['x_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['x_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];

			//console.log(JSON.stringify(_RIEPILOGO_OFFER));
		}

	}

	//alert("aaa " + _RIEPILOGO_OFFER['annuale_price'] + "," + _RIEPILOGO_OFFER['mensile_price']);

	$('#riepilogo').css('display', 'inline-block');
	$('.prezzo_abbo_anno').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['annuale_price'] /*p_offerta.offerPrice*/ ));
	$('.prezzo_abbo_mese').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['mensile_price'] /*p_offerta.offerPrice*/ ));
	$('#prodotto_riepilogo').text(p_product_detail.productName);
	$('.abbo_mensile_text').html(_RIEPILOGO_OFFER['mensile_descr']);
	$('.abbo_annuale_text').html(_RIEPILOGO_OFFER['annuale_descr']);
}

function popupRiepilogoAnnulla() {
	$('#riepilogo').css('display', 'none');

}

function riepilogoProcedi() {
	var p_product_detail = _RIEPILOGO_PRODUCT;
	var p_offerta = _RIEPILOGO_OFFER;

	//alert('aaaa'+$('#riepilogo input[name=id_abbonamento]'));
	if ($('#riepilogo input[name=id_abbonamento]').attr('checked')) {
		console.log('hai selezionato ' + (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0 ? 'Ricorrrente' : 'One shot'));

		//Link se è ricorrente o oneshot
		if (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0) {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['mensile_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['mensile_url'];
			console.log('ricorrente ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'Ricorrrente' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		} else {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['annuale_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['annuale_url'];
			console.log('oneshot ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			//'One shot' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		}
		$('#riepilogo').css('display', 'none');
	} else {
		alert('Nessuna selezione');
	}
}

/******************************************************
 Gestione schermata di registrazione
 ******************************************************/
var _REGISTRAZIONE_ISCROLL = null;

function popupRegistrazioneApri() {

	// Inizializzazione dei vari campi della registrazione
	$('#registrazione #id_username').val('');
	$('#registrazione #id_password').val('');
	$('#registrazione #id_password_confirm').val('');
	$('#registrazione #id_email').val('');
	$('#registrazione #id_consenso_privacy').attr('checked', false);
	$('#registrazione #id_consenso_email').attr('checked', false);
	$('#registrazione #id_consenso_societa').attr('checked', false);
	$('#registrazione #id_consenso_privacy').change();
	$('#registrazione #id_consenso_email').change();
	$('#registrazione #id_consenso_societa').change();
	$('#registrazione_senza_email').css('display', 'inline-block');
	$('#registrazione_con_email').css('display', 'none');

	$('#registrazione').css('display', 'inline');

	if (_REGISTRAZIONE_ISCROLL == null) {
		_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
			bounce : false
		});
	} else {
		_REGISTRAZIONE_ISCROLL.refresh();
	}

	//Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
	$('#registrazione #id_email').unbind();
	$('#registrazione #id_email').keyup(function() {
		console.log('keyup');
		if ($('#registrazione #id_email').val() != '') {
			$('#registrazione_senza_email').css('display', 'none');
			$('#registrazione_con_email').css('display', 'inline-block');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();

			if (_REGISTRAZIONE_ISCROLL == null && _ORIENTATION == 'H') {
				_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
					bounce : false
				});
				_REGISTRAZIONE_ISCROLL.refresh();
			}
		} else {
			$('#registrazione_senza_email').css('display', 'inline-block');
			$('#registrazione_con_email').css('display', 'none');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();
		}
	});
}

function popupRegistrazioneChiudi() {
	//$('#registrazione').fadeOut();
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAnnulla() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneIndietro() {
	//$('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAvanti() {
	if (controlloDatiRegistrazione()) {

		// Definizione del profilo utente
		var l_username = $('#registrazione #id_username').val();
		var l_password = $('#registrazione #id_password').val();
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : l_username,
			"password" : l_password
		};

		var l_user_email = $('#registrazione #id_email').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#registrazione #id_consenso_privacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#registrazione #id_consenso_email').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#registrazione #id_consenso_societa').attr('checked') == "checked" ? '1' : '0');
		}

		var l_req_headers = {
			"appKey" : _API24_APPKEY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceName" : device.name,
			"deviceID" : device.uuid,
			"deviceType" : device.platform,
			"profile" : l_user_profile
		};
		console.log('---REQ---> createUser (' + l_username + ')');
		console.log(l_req_headers);
		console.log(l_req_data);
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Registrazione in corso..."]);
		$.ajax({
			type : "POST",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/createUserEDOI",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(res) {
				if ( typeof res == "string") {
					res = $.parseJSON(res);
				}

				console.log('---RESP--> createUser (' + l_username + ')');
				console.log(res);

				if (!res.Success) {
					//navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification", "activityStop", []);
					//Gestione messaggi di errore dal server
					if (res.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Uno o più campi inseriti non sono validi.', 'Registrazione');
					} else if (res.Exception.Name == 'ExistingUserException') {
						abutils.alert('Lo username è già utilizzato.', 'Registrazione');
					} else {
						//alert('Attenzione, ' + res.Exception.Description);
						abutils.alert(res.Exception.Description, 'Registrazione');
					}
				} else {
					if (l_user_email == '') {
						abutils.alert("L'indirizzo email ti verrà richiesto al primo accesso al nostro sito web.", 'Registrazione completata');
					} else {
						abutils.alert("Ti abbiamo inviato una mail per attivare la tua utenza anche per il nostro sito web.", 'Registrazione completata');
					}
					eseguiLogin(l_username, l_password);
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				abutils.alert('Si è verificato un errore durante la registrazione.', 'Registrazione');
			}
		});
	}
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in particolare:
 *  - la username non deve contenere caratteri speciali
 *  - le password devono coincidere e non devono avere caratteri speciali
 *  - l'indirizzo email, se presente, deve essere un indirizzo valido
 *  - l'utente deve acconsentire al trattamento dei dati personali in caso di presenza dell'indirizzo email
 */
function controlloDatiRegistrazione() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	var ck_username = /^[A-Za-z0-9_]{3,20}$/;
	/* Min 3 max 20 caratteri */
	var ck_password = /^[A-Za-z0-9!@#$%^*()_]{8,20}$/;
	/* Min 8 max 20 caratteri senza / \ e & */
	// Controllo username
	username = $('#registrazione #id_username').val();
	if (!ck_username.test(username)) {
		abutils.alert('Lo username non può contenere spazi e caratteri speciali. Deve essere lunga tra i 3 ed i 20 caratteri', 'Registrazione');
		return false;
	}

	// Controlli password
	password = $('#registrazione #id_password').val();
	if (password == '') {
		abutils.alert('La password è obbligatoria.', 'Registrazione');
		return false;
	}
	if (!ck_password.test(password)) {
		abutils.alert('La password inserita non è valida.', 'Registrazione');
		return false;
	}
	password_confirm = $('#registrazione #id_password_confirm').val();
	if (password_confirm != password) {
		abutils.alert('Le password inserite non coincidono.', 'Registrazione');
		return false;
	}

	// Controllo email
	email = $('#registrazione #id_email').val();

	// email obbilgatoria
	if (email == '') {
		abutils.alert("L'indirizzo email è obbligatorio.", 'Registrazione');
		return false;
	}

	if (email != '' && !ck_email.test(email)) {
		abutils.alert("L'indirizzo email inserito non è valido.", 'Registrazione');
		return false;
	}

	//console.log('aaa'+$('#registrazione input[name=id_consenso_privacy]').attr('checked'));
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#registrazione input[name=id_consenso_privacy]').attr('checked')) {
		abutils.alert("Per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Registrazione');
		return false;
	}

	return true;
}

/******************************************************
 Gestione popup di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per la login
 * @params p_username Parametro opzionale con il quale inizializzare il campo username
 *         p_force Se impostato a true forza l'utente a non poter uscire dalla login se non attraverso l'effettuazione della login stessa
 */
var _POPUP_LOGIN_USERNAME = null;

function popupLogin(p_username, p_force) {
	//alert('bbb');
	_POPUP_LOGIN_USERNAME = p_username;

	//Inizializza lo username se questo viene passato come parametro
	if (p_username) {
		$('#login #id_username').val(p_username);
		$('#login #login_body_message').text(p_username);
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'none');
		$('#login #id_password').val('');
	} else {
		$('#login #id_username').val('');
		$('#login #login_body_message').text('');
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'inline-block');
		$('#login #id_password').val('');
	}

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#login_back_button').css('visibility', 'hidden');
	} else {
		$('#login_back_button').css('visibility', 'visible');
	}
	//$('#riepilogo').css('visibility', 'hidden');
	$('#login').css('display', 'inline');
	
	$('select').attr('disabled', 'disabled');
}

function popupLoginChiudi() {
	//$('#login').fadeOut();
	$('#login').css('display', 'none');
	$('#login_body_message').text('');
	
	$('select').removeAttr('disabled');
}

function popupLoginIndietro() {
	//$('#login').fadeOut();
	_NEXT_ACTION = null;
	$('#login').css('display', 'none');

	if (_POPUP_LOGIN_USERNAME != null) {
		// procedo ad una disassociazione del dispositivo
		disassociazioneSilenziosa(_POPUP_LOGIN_USERNAME);
	}
	
	$('select').removeAttr('disabled');
}

function disassociazioneSilenziosa(p_username) {
	if (p_username == null) {
		p_username = _USERNAME;
	}
	var l_request_data = {
		"username" : p_username, //_USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	var l_req_headers = {
		"appKey" : _API24_APPKEY //,
		//"userIdentity": _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice Silent Login');
	console.log(l_req_headers);
	console.log(l_request_data);

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice Silent Login');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {

			} else {

			}

		},
		error : function() {

		}
	});
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupLoginAvanti() {
	if (controlloDatiLogin()) {
		var l_username = $('#login #id_username').val();
		var l_password = $('#login #id_password').val();
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Login in corso..."]);
		_EDICOLA_LAST_PRODUCT_LOAD = 0;
		eseguiLogin(l_username, l_password);
	}
}

/**
 * Esegue la chiamata di login verso il server
 */
function eseguiLogin(p_username, p_password, p_silent) {
	console.log('---REQ---> userLogin (' + p_username + ')');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"siteCode" : _API24_SITECODE,
		"username" : p_username,
		"password" : p_password
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/userLogin",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			setUserData(null, null, null);

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> userLogin');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {
				// procedo ad una associazione
				associaDevice(p_username, p_password, p_response.Result.res, p_silent);
				popupAcquistoRegistrazioneClose();
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				popupAcquistoRegistrazioneClose();
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// errore in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - login: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					// errore da mostrare
					abutils.alert('Si è verificato un errore durante la login. ' + l_exc_descr, 'Login');
				}

			}
		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - login: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare la login. Riprovare tra poco.', 'Login');
			}
		}
	});
}

/**
 * Associa l'utente al dispositivo
 */
function associaDevice(p_username, p_password, p_useridentity, p_silent) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : p_useridentity //_USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceName" : device.name,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : p_username //_USERNAME
	};

	console.log('---REQ---> associauserdevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "POST",
		cache : false,
		contentType : "application/json; charset=utf-8",
		//url: _API24_ENDPOINT + "Users/addUserDevice",
		url : _SOLEGW_ENDPOINT + "associauserdevice.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> associauserdevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, associaDevice) || (p_response.Exception.Name == 'UserDeviceRelationException')) {
				setUserData(p_username, p_password, p_useridentity);
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				if (p_silent) {
					onDeviceReady_aux();
				} else {
					popupLoginChiudi();
					popupRegistrazioneChiudi();
					gestisciProssimaAzione();
				}
			} else {
				//navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				//Gestione eccezioni
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// exception in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - associauserdevice: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					console.log('associaDevice EXCEPTION ' + p_response.Exception.Name + ': ' + p_response.Exception.Description);
					if ((p_response.Exception.Name != 'UserDeviceRelationException') && (p_response.Exception.Name != 'ExpiredUserIdentityException')) {
						abutils.alert(p_response.Exception.Description, 'Associazione device');
					}
				}

			}

		},
		error : function() {
			//navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - associauserdevice: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare l\'associazione del device. Riprovare tra poco.', 'Login');
			}
		}
	});
}

function controlloDatiLogin() {
	username = $('#login #id_username').val();
	if (username == '') {
		abutils.alert('Attenzione, lo username è obbligatorio.', 'Login');
		return false;
	}

	// Controlli password
	password = $('#login #id_password').val();
	if (password == '') {
		abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
		return false;
	}

	return true;
}

/******************************************************
 Gestione schermata di login
 ******************************************************/
/**
 * Inizializza e mostra il popup per il controllo della password
 * @params p_force Se impostato a true forza l'utente a non poter annullare il controllo password
 */
function popupControlloPassword(p_force) {

	//Inizializza lo username
	$('#controllo_password #controllo_password_account_username').text(_USERNAME);
	$('#controllo_password #id_password').val('');

	//Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#controllo_password_back_button').css('visibility', 'hidden');
	} else {
		$('#controllo_password_back_button').css('visibility', 'visible');
	}

	$('#controllo_password').css('display', 'inline');
	
	$('select').attr('disabled', 'disabled');
}

function popupControlloPasswordChiudi() {
	//$('#controllo_password').fadeOut();
	$('#controllo_password').css('display', 'none');
	
	$('select').removeAttr('disabled');
}

/**
 * Cerca di effettuare la login.
 * In caso di successo memorizza i dati dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupControlloPasswordAvanti() {
	if ($('#controllo_password #id_password').val() != _USER_PASSWORD) {
		abutils.alert('La password non è corretta', 'Attenzione');
	} else {
		popupControlloPasswordChiudi();
		gestisciProssimaAzione();
	}
}

/******************************************************
 Gestione memorizzazione locale username
 ******************************************************/
/**
 * Elimina lo username dell'utente dal local storage
 */
function deleteUsername() {
	window.localStorage.removeItem("username");
}

/**
 * Memorizza lo username dell'utente nel local storage
 * @params p_username Lo username che deve essere memorizzato
 */
function storeUsername(p_username) {
	window.localStorage.setItem("username", p_username);
}

/**
 * Legge lo username dell'utente da local storage
 * @returns String Lo username dell'utente
 */
function getUsername() {
	return window.localStorage.getItem("username");
}

/******************************************************
 Gestione memorizzazione locale password
 ******************************************************/
/**
 * Elimina la password dell'utente dal local storage
 */
function deletePassword() {
	window.localStorage.removeItem("password");
}

/**
 * Memorizza la password dell'utente nel local storage
 * @params p_username La password che deve essere memorizzata
 */
function storePassword(p_password) {
	window.localStorage.setItem("password", p_password);
}

/**
 * Legge la password dell'utente da local storage
 * @returns String La password dell'utente
 */
function getPassword() {
	return window.localStorage.getItem("password");
}

/******************************************************
 Gestione controllo iniziale username
 ******************************************************/
/**
 * Controlla la presenza dello username nel local storage ed in caso controlla
 * che sia lo stesso username associato al dispositivo
 */
function controlloUsername() {
	var l_local_storage_username = getUsername();
	var l_local_storage_password = getPassword();
	console.log('Utente secondo IPAD: ' + l_local_storage_username);
	if (l_local_storage_username != null && l_local_storage_password != null) {
		// procedo direttamente alla login
		//setUserData(null, null, null);
		_NEXT_ACTION = onDeviceReady_aux;
		eseguiLogin(l_local_storage_username, l_local_storage_password, true);
		return;
	}

	// se non ci sono dati in locale chiedo l'eventuale utenza ad API24

	//console.log('Lettura utente associato al dispositivo');
	var l_signature = getSignature(device.uuid + ',' + device.platform);

	console.log('---REQ---> getUserFromDevice');
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	//Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserFromDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			console.log('---RESP--> getUserFromDevice');
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				var l_api24_username = p_response.Result.res;
				console.log('Utente secondo API24: ' + l_api24_username);

				if (l_api24_username != '') {
					_NEXT_ACTION = loadProducts;
					popupLogin(l_api24_username);
					onDeviceReady_aux();
				} else {
					onDeviceReady_aux();
				}
			} else {
				// Gestione eccezioni
				//setUserData(null, null, null);
				onDeviceReady_aux();
				return;
			}
		},
		error : function() {
			//setUserData(null, null, null);
			onDeviceReady_aux();
			return;
		}
	});
}

function popupInformativaPrivacy() {
	//$('#informativa_privacy').fadeIn();
	if (_IMPOSTAZIONI_PROFILO_ISCROLL != null) {
		_IMPOSTAZIONI_PROFILO_ISCROLL.destroy();
		_IMPOSTAZIONI_PROFILO_ISCROLL = null;
	}
	// Viene mostrato il popup
	$('#informativa_privacy').css('display', 'inline');
	if (_IMPOSTAZIONI_ISCROLL_PRIVACY == null)
		_IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
}

function popupInformativaPrivacyClose() {
	//$('#informativa_privacy').fadeOut();
	$('#informativa_privacy').css('display', 'none');
	if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
		console.log("_IMPOSTAZIONI_PROFILO_ISCROLL is null");
		_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper');
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	}
}

/******************************************************
 Gestione inizializzazione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 5 * 1024 * 1024;
var _DB = null;

/**
 * Inizializza il database associato all'applicazione
 */
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	
	if (!window.openDatabase)
    	console.log("Error: can't open local database");
	if (!localStorage)
    	console.log("Error: localstorage not usable");
    try{
		_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
	}catch(exc){
		console.log('Errore DB '+exc.message);
	}
	console.log("Inizializzazione database OK");
}

/**
 * Funzione di gestione degli erorri delle operazioni sul database
 */
function dbErrorHandler(p_error) {
	console.log("Error processing SQL: " + p_error);
}

/* -------------------- DOWNLOAD MANAGER ----------------------------------- */
/* ricordarsi di mettere la downloadManagerDBinit() nel deviceready-bodyload */
function downloadManagerDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK downloadManagerDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO downloadManagerDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS issues (id unique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, dttm)', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function addToDownloadQueue(testata, issue, edizione) {
	renderDownloadQueue(testata, issue, edizione);
	//PhoneGap.exec("DownloadManagerCommand.addIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.addIssueToDownloadQueue(null, null, testata, issue, edizione);
	window.soledownloader.launchDownload(testata, edizione, issue, "Descrizione" + window.localStorage.getItem('unread_message_sole'), "" + "aaaa", "false");
	console.log("queue!!!")
}

function getUnreadMessage(testata, edizione, issue) {
	var unread = window.localStorage.getItem('unread_message_sole');
	//alert('aunread is '+unread);
	if (unread != null)
		window.runfunc.retMessage(testata, edizione, issue, unread);
	else
		window.runfunc.retMessage(testata, edizione, issue, 0);
}

function renderDownloadQueue(testata, issue, edizione) {
	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	if (btn) {
		$(btn).val('Annulla');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			//alert(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			setTimeout(function() {
				removeToDownloadQueue(testata, issue, edizione);
			}, 0);
			/*
			 setTimeout(function(){
			 window.soledelete.deleteIssue(testata, issue, edizione);
			 },1000);
			 */
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'visible';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
}

function removeToDownloadQueue(testata, issue, edizione) {
	//PhoneGap.exec("DownloadManagerCommand.removeIssueToDownloadQueue", testata, issue, edizione);
	//window.plugins.flipper24.removeIssueToDownloadQueue(null, null, testata, issue, edizione);
	window.soledownloader.cancelDownload(testata, edizione, issue, "", "", true);
	console.log("remove queue t: " + testata + " ed: " + edizione + " iss: " + issue);

	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	if (btn) {
		$(btn).val('Salva in locale');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log(";;;;;;;;;; ADD2 TO QUEUE " + testata + " " + issue + " " + edizione);
			addToDownloadQueue(testata, issue, edizione);
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'white';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%, rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
}

function downloadManagerCallbackSingleFileComplete(testata, issue, edizione, progress) {
	//alert("is "+progress);
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {

		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'royalblue';
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(10,43,128) 0%, rgb(99,151,255) 100%)';

		//alert("is "+progress);
		console.log("progress is " + progress);
		document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = parseInt(progress) + '%';

	}
}

function downloadManagerCallbackSingleFileError(testata, issue, edizione, progress) {
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
}

function downloadManagerCallbackSetComplete(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	if (document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione).className = 'qarchivio_container_box_txt_local_LIST';
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
	downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr);
	omnitureTrackApp('APP:download:complete:' + testata + ':' + issue + ':' + edizione, 'APP:download');
}

function downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	console.log('downloadManagerCallbackSaveIssueDb!!!');
	if (_DB) {
		var querySuccess = function() {
			console.log('OK SAVE LOCAL DB');
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);

			// togliere pulsante scarica e mostrare sfoglia
			var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
			if (btn) {
				$(btn).unbind();
				$(btn).removeClass('gray24');
				$(btn).addClass('red24');
				$(btn).val('Sfoglia');
				$(btn).bind('click', function() {
					console.log(";;;;;;;;;; SFOGLIA " + testata + " " + issue + " " + edizione);
					sfoglia(testata, issue, edizione);
					console.log("sfoglia archivio");
					window.loader.local(true);
				});
			}

			// aggiorna dettaglio prodotto se necessario
			refreshProductDetails();
		}
		var queryError = function(tx, p_error) {
			console.log('KO SAVE LOCAL DB ' + p_error.message);
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);
		}
		var executeQuery = function(tx) {
			var idunique = testata + '_' + issue + '_' + edizione;
			console.log('INSERT INTO issues: ' + idunique);
			//tx.executeSql('INSERT INTO issues VALUES("' + idunique + '", "' + testata + '", "' + testata_descr + '", "' + issue + '", "' + issue_descr + '", "' + edizione + '", "' + edizione_descr + '", DATETIME(\'NOW\'));', [], querySuccess, queryError);
			tx.executeSql('INSERT INTO issues VALUES(?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'));', [idunique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function downloadManagerCallbackSetError(testata, issue, edizione) {
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'red';
		 document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '100%';
		 */
	}
	if (document.getElementById('stop_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('stop_' + testata + '_' + issue + '_' + edizione).style['display'] = 'none';
	if (document.getElementById('download_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('download_' + testata + '_' + issue + '_' + edizione).style['display'] = 'inline-block';
}

/* ------------------------- FINE DOWNLOAD MANAGER ---------------------- */

/******************************************************
 Gestione popup accedi/registrati
 ******************************************************/
function popupAccediRegistrati() {
	$('#accedi_registrati_menu').css('display', 'inline-block');
}

function popupAccediRegistratiChiudi() {
	$('#accedi_registrati_menu').css('display', 'none');
}

function popupAccediRegistratiAnnulla() {
	$('#accedi_registrati_menu').css('display', 'none');
	_NEXT_ACTION = null;
}

/******************************************************
 Ajax COMMONS
 ******************************************************/
/**
 * Gestisce il controllo del risultato proveniente dalle richieste Ajax.
 * Le risposte devono essere in formato JSON ed avere almeno l'attributo Success ed eventuali eccezioni.
 * @params p_result La risposta proveniente dal server
 * @returns Boolean False in caso di errori, True in caso di successo
 */
function checkAjaxResponse(p_response, p_callback) {
	if ( typeof p_response == "string") {
		p_response = $.parseJSON(p_response);
	}
	if (p_response.Success) {
		//console.log('Check ajax response OK');
		//console.log(p_response);
		return true;
	} else {
		console.log('Check ajax response KO: [' + p_response.Exception.Name + '] ' + p_response.Exception.Description);
		if (p_response.Exception.Name == 'ExpiredUserIdentityException') {
			if (_USERNAME == null && _USER_PASSWORD == null) {
				console.log('WARNING username e/o password non settati, impossibile procedere al rinnovo della useridentity');
				setUserData(null, null, null);
				return false;
			}
			console.log('GESTIONE ExpiredUserIdentityException');
			console.log('---REQ---> userLogin4ExpiredUserIdentityException(' + _USERNAME + ')');
			var l_username = _USERNAME;
			var l_user_password = _USER_PASSWORD;
			var l_req_headers = {
				"appKey" : _API24_APPKEY
			};
			var l_req_data = {
				"siteCode" : _API24_SITECODE,
				"username" : l_username,
				"password" : l_user_password
			};
			console.log(l_req_headers);
			console.log(l_req_data);
			// resetto username e password
			/*
			 _USERNAME = null;
			 _USER_PASSWORD = null;
			 */
			setUserData(null, null, null);

			$.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/userLogin",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					if ( typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> userLogin4ExpiredUserIdentityException');
					console.log(p_response);

					if (checkAjaxResponse(p_response)) {
						setUserData(l_username, l_user_password, p_response.Result.res);
						if (p_callback != null)
							p_callback.call();
						else
							console.log('WARNING userLogin4ExpiredUserIdentityException completata, ma manca la callback');
					} else {
						console.log('WARNING userLogin4ExpiredUserIdentityException error');
					}
				},
				error : function() {
					console.log('WARNING userLogin4ExpiredUserIdentityException timeout');
				}
			});
		}
		return false;
	}
}

/**
 * Callback generica per la gestione degli errori di comunicazione verso le API24
 */
function ajaxErrorHandler(xmlHttpRequest, textStatus, errorThrown) {
	console.log('Ajax error: ' + textStatus);
	//enableOfflineMode();
}

/**
 * Inizializza il controllo per la gestione online/offline
 */
var _OFFLINE_COUNTER = null;
//var _PING_COUNTER = 0;
function testConnectionWorker() {
	//_PING_COUNTER++;
	if (_OFFLINE_COUNTER == null)
		_OFFLINE_COUNTER = 1;
	// al primo avvio il primo risultato è quello buono

	console.log('---REQ---> PING');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	//console.log(l_req_headers);
	//console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		headers : l_req_headers,
		data : l_req_data,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + 'ping.json',
		dataType : "json",
		success : function(p_response) {
			//console.log('---RESP--> PING');
			console.log(p_response);
			try {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				if (checkAjaxResponse(p_response) && (p_response.Result.res.statusCode == 0)) {
					enableOnlineMode();
					_OFFLINE_COUNTER = 0;
				} else {
					_OFFLINE_COUNTER++;
					if (_OFFLINE_COUNTER >= 2) {
						enableOfflineMode();
					}
				}
			} catch (exc) {
				//console.log('errore formato risposta');
				_OFFLINE_COUNTER++;
				if (_OFFLINE_COUNTER >= 2) {
					enableOfflineMode();
				}
			}
		},
		error : function() {
			//console.log('ajax error');
			_OFFLINE_COUNTER++;
			if (_OFFLINE_COUNTER >= 2) {
				enableOfflineMode();
			}
		}
	});
}

function initCheckOnline() {
	testConnectionWorker();
	setInterval(function() {
		testConnectionWorker();
	}, _INTERVALLO_CHECK_ONLINE);
}

/**
 * Gestisce l'esecuzione della prossima azione. Alcune volte al termine delle azioni su una popup è necessario
 * eseguire un azione. Per fare ciò viene impostata la variabile _NEXT_ACTION alla funzione che deve essere richiamata.
 * La seguente funzione controlla che ci sia una prossima azione ed in caso la esegue.
 */
function gestisciProssimaAzione() {
	//Se la variabile _NEXT_ACTION è inizializzata chiama la funzione associata
	if (_NEXT_ACTION && typeof _NEXT_ACTION == "function") {
		var l_next_action = _NEXT_ACTION;
		_NEXT_ACTION = null;
		l_next_action.call();
	}
}

/* --------- gestione bottoni appmenu -------------------- */
function appmenuButtonReset() {
	$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
	$('#appmenu_edicola').removeClass('appmenu_edicola_on');
	$('#appmenu_preferiti').removeClass('appmenu_preferiti_on');
	$('#appmenu_inbox').removeClass('appmenu_inbox_on');
	$('#appmenu_impostazioni').removeClass('appmenu_impostazioni_on');
}

function appmenuSfoglioOpen() {
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
	var l_ret = openFlipper();
	if (!l_ret) {
		$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
		abutils.alert('Nessuna pubblicazione è ancora stata aperta.', 'Sfoglia');
		return;
	}
	appmenuButtonReset();
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
}

function appmenuEdicolaOpenWithIndice(testata, edizione) {
	appmenuEdicolaOpen(true);
	try {
		var l_product_id = _HASH_MAP_TESTATA_PRODUCTID[testata];
		console.log(testata + ' ---> ' + l_product_id);
		if (l_product_id == null)
			return;
		//qarchivioOpen(l_product_id, true, edizione);
		if (l_product_id == _CODICE_PRODOTTO_QUOTIDIANO)
			qarchivioOpen(l_product_id, true, edizione);
		else
			archivioOpen(l_product_id, true);
	} catch (exc) {

	}
}

function appmenuEdicolaOpen(skipFlipper) {

	if (!skipFlipper && _CURRENT_FLIPPER_TESTATA != null && _CURRENT_FLIPPER_ISSUE != null && _CURRENT_FLIPPER_EDIZIONE != null) {
		openFlipper();
		setTimeout(function() {
			appmenuEdicolaOpen(true);
		}, 2000);
		return;
	}

	if (_MOD_OFFLINE != true) {
		loadProducts();
	}

	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(0px, 0px, 0)');

	$('#edicola_titolo_btn_select').removeAttr('disabled');

	omnitureTrackApp("APP:edicola", "APP:edicola");
	nielsenCall('EDICOLA');
}

function appmenuPreferitiOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	preferitiLoadMenuProdotto();
	appmenuButtonReset();
	$('#appmenu_preferiti').addClass('appmenu_preferiti_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-3000px, 0px, 0)');

	omnitureTrackApp("APP:preferiti", "APP:preferiti");
	nielsenCall('PREFERITI');
}

function appmenuInboxOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	$('#appmenu_inbox').addClass('appmenu_inbox_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-6000px, 0px, 0)');

	omnitureTrackApp("APP:inbox", "APP:inbox");
	nielsenCall('INBOX');
}

function appmenuImpostazioniOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	impostazioniInizializza();
	impostazioniOpen();
	$('#appmenu_impostazioni').addClass('appmenu_impostazioni_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-9000px, 0px, 0)');

	omnitureTrackApp("APP:impostazioni", "APP:impostazioni");
}

/* ----------------------------------------------------------------- */
function injectAutoLogin(username, password) {
	if (username == null || password == null)
		return "KO";
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

	_NEXT_ACTION = function() {
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

		setTimeout(function() {
			window.location = 'galaxy.html';
		}, 1000);
	}
	eseguiLogin(username, password);

	return "OK";
}

function checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback) {
	console.log('--->checkAcquisto');
	if (p_prodotto24 == '1') {
		//android workaround temporaneo
		p_prodotto24 = 'a1';
	}

	var local = window.verify.Local(_MAP_CODICE_TESTATA[p_prodotto24 + ''], p_issue, p_edizione);
	console.log("local is " + local);
	if (local == '1') {
		if (callback && typeof callback == "function") {
			console.log("aaaa passsq");
			callback.call();
			return;
		}
	}
	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"date" : p_issue
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> checkAcquisto(' + p_prodotto24 + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "checkacquisto/" + p_prodotto24 + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> checkAcquisto(' + p_prodotto24 + ')');
			console.log('checkAcquisto resp ' + /*JSON.stringify(*/p_response /*)*/ );

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback);
			})) {
				console.log('check ' + p_response.Result.res);

				if (p_response.Result.res && p_response.Result.res.checkAcquisto && (p_response.Result.res.checkAcquisto == true)) {
					//navigator.notification.confirm('Hai già acquistato questa edizione: il nuovo download è gratuito.', function(button){
					if (callback && typeof callback == "function") {
						console.log("Aquisto-->pass to func");
						callback.call();
					}
					//}, 'Acquisto non necessario', 'Ok');
				} else {
					//appstoreBuy(id_shopping24, id_itunes, callback);
					//BUY-----------------------------------------------------------------------------------------

					console.log('buy');
					console.log("aaaa passsq1");
					var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
					var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
					var link_singola = '';
					console.log('productId ' + productId);
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
					// prova con i link
					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}
					}

					if (link_singola != '') {
						window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				}
			} else {
				if (p_response.Exception.Name == 'ExpiredUserIdentityException')
					return;
				//appstoreBuy(id_shopping24, id_itunes, callback);
				//BUY---------------------------------------------------------------------------------------------
				console.log('buy');
				console.log("aaaa passsq2");
				var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
				var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];

				var link_singola = '';
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}

				// prova con i link
				if (!link_singola || link_singola == '') {
					_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
				}
				if (link_singola != '') {
					window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
				} else {
					abutils.alert('Errore su link!', 'Pagamento');
				}
			}
		},
		error : function() {
			//appstoreBuy(id_shopping24, id_itunes, callback);
			//BUY-------------------------------------------------------------------------------------------------
			console.log('buy');
			console.log("aaaa passsq3");
			var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
			var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
			var link_singola = '';
			for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
				if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
				}
			}
			// prova con i link
			if (!link_singola || link_singola == '') {
				_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}
			}
			if (link_singola != '') {
				window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
			} else {
				abutils.alert('Errore su link!', 'Pagamento');
			}
		}
	});
}/**
 * @author ABertacco, MConventi
 */
var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;
var _PREFERITI_ISCROLL_MENU = null;
var _PREFERITI_ISCROLL_VISTA = null;
var _PREFERITI_ISCROLL_DETTAGLIO = null;

// Lista di prodotti da inserire nel menu di sinistra tra i prodotti
/* viene calcolata in base agli articoli presenti in db
 var _PREFERITI_PRODUCTS_LIST = [
 {
 testata: 'S24',
 nome: "Il Sole 24 ORE",
 icon: 'imgs/fake/s24_small_icon.png'
 }
 ];
 */
var _PREFERITI_PRODUCTS_LIST = null;


function preferitiLoadMenuTag(){
    preferitiLoadMenu('TAG');
}

function preferitiLoadMenuProdotto(){
    preferitiLoadMenu('PRODOTTO');
}

function preferitiLoadMenu(mode){
    $('#preferiti_titolo_menu_opzioni_prodotto').removeClass('newgray24');
    $('#preferiti_titolo_menu_opzioni_tag').removeClass('newgray24');
    $('#preferiti_body_menu_container').empty();
    
    if (_PREFERITI_ISCROLL_MENU != null) {
        _PREFERITI_ISCROLL_MENU.destroy();
        _PREFERITI_ISCROLL_MENU = null;
    }
    
    if (mode == 'PRODOTTO') {
        $('#preferiti_titolo_menu_opzioni_prodotto').addClass('newgray24');
        preferitiInitProductList();
    }
    else {
        $('#preferiti_titolo_menu_opzioni_tag').addClass('newgray24');
        preferitiInitTagList();
    }
    
}


	function searchPref(search) {
		console.log('search is '+search);
		
		/*
		db.transaction(function(tx) {
    		tx.executeSql("SELECT id FROM table LIMIT 1", [], function(tx, result) {
      			row = result.rows.item(0);
    		}, function(tx, error) {
    		});
  		});

  		return row;

		 */
		if(search == null)
			return;
		
		if(_DB){
			_DB.transaction(function(tx) { 
				//'occhiello text, titolo text, sottotitolo text, firma text, testo text';
				var l_query = 'occhiello like ? OR titolo like ? OR sottotitolo like ? OR firma like ? OR testo like ?';
				var tmpsearch = search.split(' ');
				var s = '';
				// GLOBAL REPLACE
				// DA FARE
				var args = new Array(tmpsearch.length * 5);
				for(var i = 0; i < tmpsearch.length; i++){
					   if(i > 0)
						   l_query += " OR " + l_query;
					   s = tmpsearch[i];//"4,250%";
					   s = s.replace(/%/g, "\\%");
					   s = s.replace(/_/g, "\\_");
					   s = s.replace(/&rsquo;/g,"\'");
					   s = s.replace(/&quot;/g,"\"");
					   s = "%" + s + "%";
					   for(var j = i*5; j < (i+1)*5; j++)
						   args[j] = s;
					   console.log("search2323 selec "+s);
				   }
				search = "%"+search+"%";
	            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE ' + l_query + " escape '"+"\\"+"' order by issue DESC, pagina ;" , args, function(tx, p_results) {
		            var row = null;
		            if(p_results != null && p_results.rows.length != 0){
		            	for(var irow = 0; irow < p_results.rows.length; irow++){
			            	row = p_results.rows.item(irow);
			            	//console.log("testo[0] "+row.testo);
			            	//'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
			            	window.searchlaunch.addResult(row.artid, row.testata, row.testata_descr, row.issue, row.issue_descr, row.edizione, row.edizione_descr,row.sezione, row.pagina, row.occhiello, row.titolo, row.sottotitolo, row.firma, row.testo);
			            	row = null;
		            	}
		            	
		            	window.searchlaunch.broadcastResult();
		            }else{
		            	console.log('search res '+p_results);
		            	window.searchlaunch.broadcastResult();
		            }
	            	
	            }, function(tx, error) {
	            	alert(error);
	            });
	            
			});
		       
	        //_DB.transaction(querySearch);
	 
		}
	}



	function getArticleFromId(artid){
		if(_DB){
			_DB.transaction(function(tx) { 

				tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid = ? ;' , [artid], function(tx, p_results) {
		            var row = null;
		            if(p_results != null && p_results.rows.length != 0){
		            	preferitiDettaglio(p_results.rows.item(0));
		            }else{
		            	console.log('search res '+p_results);
		            }
	            	
	            }, function(tx, error) {
	            	alert(error);
	            });
	            
			});
		
		}	
	}
	
/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('preferiti_body_vista_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            preferitiDettaglio(p_article);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.appendChild(document.createTextNode(p_article.titolo));
    title = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei prodotti in base ai dati inseriti in _PREFERITI_PRODUCTS_LIST
 */
function preferitiInitProductList(){
    /*
     for (var i=0; i < _PREFERITI_PRODUCTS_LIST.length; i++){
     preferitiMenuRenderProduct(_PREFERITI_PRODUCTS_LIST[i]);
     }
     if (_PREFERITI_ISCROLL_MENU == null) {
     _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
     } else {
     _PREFERITI_ISCROLL_MENU.refresh();
     }
     */
    _PREFERITI_PRODUCTS_LIST = [];
    
    if (_DB) {
        var querySuccess = function(tx, p_results){
        
            if (p_results.rows.length == 0) {
                document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
            }
            
            for (var i = 0; i < p_results.rows.length; i++) {
                var l_row = p_results.rows.item(i);
                preferitiMenuRenderProduct({
                    testata: l_row.testata,
                    nome: l_row.testata_descr,
                    icon: 'imgs/fake/s24_small_icon.png' // icona indipendente dalla testata
                });
            }
            
            if (_PREFERITI_ISCROLL_MENU == null) {
                _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
            }
            else {
                _PREFERITI_ISCROLL_MENU.refresh();
            }
			
			if (p_results.rows.length > 0) {
                // apro il primo elemento nel menu
				//preferitiLoadArticlesByProduct(p_results.rows.item(0).testata);
				$('#preferiti_body_menu_container_box_id_' + p_results.rows.item(0).testata.replace(/[^a-zA-Z0-9]+/g,'')).click();
            }
        }
        
        var queryError = function(p_error){
            console.log("preferitiInitProductList: Error processing SQL: " + p_error.message);
            document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            var l_query = 'SELECT testata, testata_descr FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' GROUP BY testata, testata_descr ORDER BY testata_descr';
            tx.executeSql(l_query, [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Crea un elemento prodotto nel menu a sinistra della finestra dei preferiti
 * @params p_product Oggetto tag così come presente in _PREFERITI_PRODUCTS_LIST
 */
function preferitiMenuRenderProduct(p_product){

    var box = document.createElement('div');
    document.getElementById('preferiti_body_menu_container').appendChild(box);
    box.className = 'preferiti_body_menu_container_box';
	box.id = 'preferiti_body_menu_container_box_id_' + p_product.testata.replace(/[^a-zA-Z 0-9]+/g, '');
    
    box.appendChild(document.createTextNode(p_product.nome));
    
    var icon = document.createElement('img');
    box.appendChild(icon);
    icon.className = 'preferiti_body_menu_container_box_icon';
    icon.src = p_product.icon;
    
    box.onclick = (function(){
        preferitiLoadArticlesByProduct(p_product.testata);
        
        $('.preferiti_body_menu_container_box').removeClass('preferiti_body_menu_container_box_active');
        $(this).addClass('preferiti_body_menu_container_box_active');
    });
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei tag attualmente nel database dei preferiti
 */
function preferitiInitTagList(){

    // Inizializza la lista dei tag nel menu di sinistra
    if (_DB) {
        var querySuccess = function(tx, p_results){
        
            if (p_results.rows.length == 0) {
                document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
            }
            
            for (var i = 0; i < p_results.rows.length; i++) {
                preferitiMenuRenderTag(p_results.rows.item(i));
            }
            
            if (_PREFERITI_ISCROLL_MENU == null) {
                _PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
            }
            else {
                _PREFERITI_ISCROLL_MENU.refresh();
            }
			
			if (p_results.rows.length > 0) {
                // apro il primo elemento nel menu
				$('#preferiti_body_menu_container_boxtag_id_' + p_results.rows.item(0).nome.replace(/[^a-zA-Z0-9]+/g,'')).click();
            }
        }
        
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
            //var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM '+_PREFERITI_TAG_DB_NAME+' GROUP BY nome ORDER BY num_articles';
            var l_query = 'SELECT nome FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY nome';
            tx.executeSql(l_query, [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Crea un elemento tag nel menu a sinistra della finestra dei preferiti
 * @params p_tag Oggetto tag così come presente nel db _PREFERITI_TAG_DB_NAME
 */
function preferitiMenuRenderTag(p_tag){
    var box = document.createElement('div');
    document.getElementById('preferiti_body_menu_container').appendChild(box);
    box.className = 'preferiti_body_menu_container_boxtag';
	box.id = 'preferiti_body_menu_container_boxtag_id_' + p_tag.nome.replace(/[^a-zA-Z0-9]+/g,'');
    box.appendChild(document.createTextNode(p_tag.nome));
    
    var icon = document.createElement('div');
    box.appendChild(icon);
    icon.className = 'preferiti_body_menu_container_boxtag_icon';
    
    box.onclick = (function(){
    
        preferitiLoadArticlesByTag(p_tag.nome);
        
        //Setta il tag attivo nel menu di sinistra
        $('.preferiti_body_menu_container_boxtag').removeClass('preferiti_body_menu_container_boxtag_active');
        $('.preferiti_body_menu_container_boxtag_icon').removeClass('preferiti_body_menu_container_boxtag_icon_active');
        $(this).addClass('preferiti_body_menu_container_boxtag_active');
        var icon = this.querySelector('div.preferiti_body_menu_container_boxtag_icon');
        if (icon != null) {
            $(icon).addClass('preferiti_body_menu_container_boxtag_icon_active');
        }
    });
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles.item(i));
    }
    
    if (_PREFERITI_ISCROLL_VISTA == null) {
        _PREFERITI_ISCROLL_VISTA = new iScroll('preferiti_body_vista_wrapper');
    }
    else {
        _PREFERITI_ISCROLL_VISTA.refresh();
        //alert('aaaaa');
        _PREFERITI_ISCROLL_VISTA.scrollTo(0, -2, 0);
    }
}

/**
 * Passa alla modalità modifica preferiti
 */
function preferitiSwitchToModifyView(){
    $('#preferiti_list_modify_button').hide();
    $('#preferiti_list_show_button').show();
    $('#preferiti_body_vista_container').addClass('preferiti_modify_view');
    $('.preferiti_body_vista_container_box_status').fadeIn();
    $('#elimina_preferiti').fadeIn();  
}

/**
 * Passa alla modalità visualizza preferiti
 */
function preferitiSwitchToShowView(){
   $('#preferiti_list_show_button').hide();
   $('#preferiti_list_modify_button').show();
   $('.preferiti_body_vista_container_box_status').hide();
   
	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	l_selected_items.removeClass('preferiti_body_vista_container_box_status_selected');
	l_selected_items.addClass('preferiti_body_vista_container_box_status_unselected');

   $('#preferiti_body_vista_container').removeClass('preferiti_modify_view');
   $('#elimina_preferiti').fadeOut();
}



/******************************************************
 Gestione eliminazione preferiti
 ******************************************************/
/**
 * Elimina i record selezionati in modalità modifica
 */
function preferitiDeleteArticles(){
    var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
    var l_items = '';
    
    for (var i = 0; i < l_selected_items.length; i++) {
        var l_pid = l_selected_items[i].id.substring(35);
        if (i > 0) 
            l_items += ',';
        l_items += '"' + l_pid + '"';
    }
    
    if (l_items != '') {
        deletePreferitiFromDB(l_items);
    }
    else {
        abutils.alert('Attenzione, non è stato selezionato nessun articolo', 'Preferiti');
    }
}

/*
 * Elimina i record dal database
 * @params p_artids Lista dei identificativi degli articoli
 */
function deletePreferitiFromDB(p_artids){

    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB && p_artids.length > 0) {
    
        var queryArticleSuccess = function(){
            console.log('Deleted preferiti ' + p_artids);
            deletePreferitiElements();
        }
        
        var queryTagSuccess = function(){
            console.log('Deleted tags ' + p_artids);
        }
        
        var queryError = function(p_error){
            console.log("deletePreferitiFromDB: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryArticleSuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryTagSuccess, queryError);
            
            //queryArticleSuccess();
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Elimina gli elementi html relativi agli articoli preferiti
 * @params p_pids Lista degli identificativi degli articoli che devono essere eliminati
 */
function deletePreferitiElements(){
    $('.preferiti_body_vista_container_box_status_selected').remove();
}


/******************************************************
 Gestione caricamento preferiti
 ******************************************************/
/*
 * Restituisce gli articoli preferiti presenti nel database locale
 * @params p_testata Identificativo del prodotto
 * @return Lista di articoli
 */
function preferitiLoadArticlesByProduct(p_testata){

    // Controlla che il database sia stato inizializzato e carica gli articoli
    if (_DB && p_testata) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " articles from the local PREFERITI store.");
            
            preferitiOpenArticlesList(p_results.rows);
        }
        
        var queryError = function(p_error){
            console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE testata=?', [p_testata], querySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

/*
 * Restituisce gli articoli preferiti presenti nel database locale in base ad un tag
 * @params p_tag Il nome del tag
 * @return Lista di articoli
 */
function preferitiLoadArticlesByTag(p_tag){

    // Controlla che il database sia stato inizializzato e carica gli articoli
    if (_DB && p_tag) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " articles from the local PREFERITI store.");
            
            preferitiOpenArticlesList(p_results.rows);
        }
        
        var tagQuerySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            console.log("Read " + len + " tags from the local TAG table.");
            var l_articles = '';
            for (var i = 0; i < p_results.rows.length; i++) {
                if (i > 0) 
                    l_articles += ',';
                l_articles += '"' + p_results.rows.item(i).artid + '"';
            }
            console.log("Read " + l_articles);
            
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid IN (' + l_articles + ')', [], querySuccess, queryError);
        }
        
        var queryError = function(p_error){
            console.log("preferitiLoadArticlesByTag: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            console.log("tag: " + p_tag);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
            tx.executeSql('SELECT artid FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE nome=?', [p_tag], tagQuerySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){
    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').text(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        //$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id_tags').val($('#preferiti_body_vista_container_box_tags_span_' + p_article.artid).html());
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    
    // Salva le modifiche
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			/*
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
            */
        }
        
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
	
	var l_tags_el = document.getElementById('preferiti_body_vista_container_box_tags_span_' + l_artid);
	if (l_tags_el) {
		l_tags_el.innerHTML = l_tags;
	}
	l_tags_el = null;
	
    popupPreferitiUpdateArticleChiudi();
}


/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


/******************************************************
 Gestione Dettaglio Preferiti
 ******************************************************/
/**
 * Apre il dettaglio dei preferiti
 */
function preferitiDettaglio(p_article){

    //Inizializzazione dati articolo
    $('#preferiti_dettaglio_titolo').text(p_article.titolo);
    $('#preferiti_dettaglio_occhiello').text(p_article.occhiello);
    $('#preferiti_dettaglio_sottotitolo').text(p_article.sottotitolo);
    $('#preferiti_dettaglio_other_info').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
    $('#preferiti_dettaglio_firma').text(p_article.firma);
    $('#preferiti_dettaglio_text').html(p_article.testo);
    $('#preferiti_dettaglio_header_modifica input').click(function(){
        popupPreferitiUpdateArticle(p_article);
    });
    
    //$('#preferiti_dettaglio').fadeIn(200, function(){
	$('#preferiti_dettaglio').css('display', 'inline-block');
	
	  if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
			_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	  } else {
			_PREFERITI_ISCROLL_DETTAGLIO = new iScroll('preferiti_dettaglio_wrapper');
	  }
    //});
	
	omnitureTrackApp('APP:preferiti:open:' + p_article.artid, 'APP:preferiti');
}

/**
 * Chiude il dettaglio dei preferiti
 */
function preferitiDettaglioChiudi(){
    //$('#preferiti_dettaglio').fadeOut(200);
	$('#preferiti_dettaglio').css('display', 'none');
}

function preferitiUpdateOrientation(){
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.refresh();
    }
    if (_PREFERITI_ISCROLL_MENU != null) {
        _PREFERITI_ISCROLL_MENU.refresh();
    }
    if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
        _PREFERITI_ISCROLL_DETTAGLIO.refresh();
    }
}

/**
 * @author ABertacco FSantagada
 */
var _ARCHIVIO_ISOPEN = false;
var _ARCHIVIO_RENDERED_ITEMS = null;
var _PROID = null;
function archivioOpen(p_product_id, isFromSfoglio) {
	_ARCHIVIO_ISOPEN = true;

	_ARCHIVIO_ISOPEN = true;
	_PROID = p_product_id;

	archivioLoad(p_product_id);
	//archivioLoad();
	archivioLoadAdv(p_product_id);

	//Inizializzazione filtro edizioni
	archivioInitFilter();

	$('#archivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#archivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#archivio').fadeIn();
	$('#archivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function archivioClose() {
	//$('#archivio').fadeOut();
	$('#archivio').css('display', 'none');
	if (_ARCHIVIO_ISCROLL != null) {
		_ARCHIVIO_ISCROLL.destroy();
		_ARCHIVIO_ISCROLL = null;
	}
	_ARCHIVIO_ISOPEN = false;
}

function archivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	openFlipper();
}

function archivioLoadAdv(p_product_id) {
	document.getElementById('archivio_footer_adv').innerHTML = '';
	//$('#qarchivio_footer_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom', function(){
	//}).endCapture();
	// http://mobapp24.ilsole24ore.com/adv_proxy.php?z=SFO_INTERSTITIAL&t=S24&d=123

	//*********************DA SOSTITUIRE!!!!!!************************
	$('#archivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();
}

function archivioLoadTutti() {
	archivioModificaFine();
	archivioLoadMenu('TUTTI');
}

function archivioLoadAcquisti() {
	archivioLoadMenu('ACQUISTI');
}

function archivioLoadMenu(mode) {
	$('#archivio_subtitolo_opzioni_tutti').removeClass('gray24');
	$('#archivio_subtitolo_opzioni_acquisti').removeClass('gray24');
	if (mode == 'TUTTI') {
		$('#archivio_subtitolo_opzioni_tutti').addClass('gray24');
		$('.archivio_container_box').css('display', 'inline-block');
	} else {
		$('#archivio_subtitolo_opzioni_acquisti').addClass('gray24');
		$('.archivio_container_box_isremote').css('display', 'none');
	}

	archivioUpdateIscroll();
}

var _ARCHIVIO_IS_IN_MODIFICA = false;
function archivioModifica() {
	_ARCHIVIO_IS_IN_MODIFICA = true;
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'inline-block');
	archivioLoadAcquisti();
	$('.archivio_container_box > div > .archivio_button_sfoglia').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_elimina').css('display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('LOCAL');
}

function archivioModificaFine() {
	_ARCHIVIO_IS_IN_MODIFICA = false;
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	archivioLoadAcquisti();
	//alert($('#archivio_wrapper').html());
	$('.archivio_container_box > div > .archivio_button_elimina').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_sfoglia').css('display', 'inline-block');
	$('.archivio_container_box_isremote > div > .archivio_button_acquista').css('display', 'inline-block');
}

var _ARCHIVIO_ISCROLL = null;
function archivioUpdateIscroll() {
	if (!_ARCHIVIO_ISOPEN)
		return;
	setTimeout(function() {
		if (_ARCHIVIO_ISCROLL == null) {
			_ARCHIVIO_ISCROLL = new iScroll('archivio_wrapper', {
				hideScrollbar : false
			});
		} else {
			_ARCHIVIO_ISCROLL.refresh();
		}
	}, 100);
}

var _ARCHIVIO_BOXES_INLINE_V = 2;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _ARCHIVIO_BOXES_INLINE_H = 3;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _ARCHIVIO_COUNT = 0;
function archivioLoad(p_product_id) {
	$('#archivio_container').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_ARCHIVIO_RENDERED_ITEMS = {};

	console.log('---REQ---> past-issues/' + p_product_id);
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> past-issues/' + p_product_id);
			console.log(p_response);

			//Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				archivioLoad(p_product_id);
			})) {
				var res = p_response.Result.res;

				_ARCHIVIO_PRODUCT = res;

				archivioRenderItems();

				for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
					var l_single_offers = _ARCHIVIO_PRODUCT.items[i].singleOffers;
					if (l_single_offers == null)
						continue;
					for (var j = 0; j < l_single_offers.length; j++) {
						//appstoreReqProduct(l_single_offers[j].offerId, l_single_offers[j].offerItunesProductId);
					}
				}
				//appstoreReqProducts();
			} else {
				console.log('archivioLoad: Error, ' + p_response.Exception.Description);
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_ARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				archivioRenderItems();
			}
		},
		error : function() {
			abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
			_ARCHIVIO_PRODUCT = {
				items : [],
				testata : _MAP_CODICE_TESTATA['' + p_product_id]
			};
			archivioRenderItems();
		}
	});

}

var _ARCHIVIO_LOCAL_ITEMS;
var _ARCHIVIO_LOCAL_ITEMS_ISSUE;
function archivioRenderItems() {
	_ARCHIVIO_LOCAL_ITEMS = [];
	_ARCHIVIO_LOCAL_ITEMS_ISSUE = [];
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioRenderItems: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				_ARCHIVIO_LOCAL_ITEMS.push(l_item_id);
				_ARCHIVIO_LOCAL_ITEMS_ISSUE.push(l_local_item.testata + '_' + l_local_item.issue);
			}

			archivioRenderItems_aux();
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function archivioRenderItems_aux() {
	console.log('archivioRenderItems...');
	console.log(_ARCHIVIO_LOCAL_ITEMS);

	_ARCHIVIO_RENDERED_ITEMS = {};
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId];
	console.log(_EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId]);
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#archivio_titolo_prodotto').text(l_product_details.name);

	//var l_sole_count_per_cover = 0;
	for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
		for (var j = 0; j < _ARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
			var l_item_id = _ARCHIVIO_PRODUCT.testata + '_' + _ARCHIVIO_PRODUCT.items[i].editionId + '_' + _ARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

			if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
				_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
				//archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, i < 30);
			}
		}
	}

	archivioLoadLocalData();
}

function archivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	console.log('archivioRenderAsIcon');

	archivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var item_full_id = _ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	var isLocal = $.inArray(item_full_id, _ARCHIVIO_LOCAL_ITEMS) != -1;
	var isLocalFree = $.inArray(_ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId, _ARCHIVIO_LOCAL_ITEMS_ISSUE) != -1;

	var l_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0) ? true : false;

	//console.log(item_full_id + ' ' + isLocal + ' ' + isLocalFree);

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box ' + p_item.inserts[p_insert_index].insertId;
	//box.id = 'archivio_container_box_' + p_insert_index + '_' + p_item.editionId;
	box.id = 'archivio_container_box_' + item_full_id;
	//box.style['display'] = 'none';

	//console.log(item_full_id + "   " + (isLocal ? "LOCAL" : "REMOTE"));

	$(box).addClass( isLocal ? 'archivio_container_box_islocal' : 'archivio_container_box_isremote');

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = p_item.inserts[p_insert_index].cover;

	if (l_premium) {
		var premiumflag = document.createElement('img');
		imgdiv.appendChild(premiumflag);
		premiumflag.className = 'archivio_container_box_img_div_premiumflag';
		premiumflag.src = 'imgs/inserto_abbonati_archivio.png';
		//premiumflag.innerHTML = 'Inserto per abbonati';
	}

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	if (screen.width > 790)
		txt_elimina.style['width'] = '100px';
	else
		txt_elimina.style['width'] = '60px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		//eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	// se issue già presente in locale
	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	if (screen.width > 790)
		txt_sfoglia.style['width'] = '100px';
	else
		txt_sfoglia.style['width'] = '60px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
		sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_sfoglia.style.display = isLocal ? 'inline-block' : 'none';
	txt_sfoglia = null;

	// se issue non presente in locale
	var l_prezzo = "";
	if (p_item.free || p_item.subscription || (p_item.singleOffers && (p_item.singleOffers.length > 0))) {
		var txt_acquista = document.createElement('div');
		txt.appendChild(txt_acquista);
		txt_acquista.className = 'button medium red24 archivio_button_acquista';
		txt_acquista.style['text-align'] = 'center';
		//txt_acquista.appendChild(document.createTextNode('0,79 €'));
		
		if (l_premium && (!p_item.subscription) && (!p_item.free)) {
			txt_acquista.innerHTML = 'Per abbonati';
			$(txt_acquista).bind('click', function() {
				mostraPopupInsertoAbbonati();
			});
		} else {

			if (p_item.free || p_item.subscription || isLocalFree) {
				txt_acquista.innerHTML = 'Sfoglia';
				$(txt_acquista).bind('click', function() {
					//sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
					sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
				});
			} else {
				//txt_acquista.innerHTML = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				l_prezzo = "<br />" + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				txt_acquista.innerHTML = 'Seleziona';
				$(txt_acquista).bind('click', function() {
					//acquistoSingolo(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);

					var link_singola = '';
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
						//_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola'
						if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
						}
					}
					// prova con i link

					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
							}
						}
					}

					//alert('aaaa');
					//alert('link: '+link_singola);
					//alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
					if (link_singola != '') {
						window.payment.paySingle(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId, link_singola);
						console.log('offerItunesProductId ' + p_item.singleOffers[0].offerItunesProductId);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				});
			}
		}
		txt_acquista.style.display = !isLocal ? 'inline-block' : 'none';
		txt_acquista = null;
	}
	//}

	// ATTENZIONE:  solo per test
	//p_item.inserts[p_insert_index].anteprima = 5;
	if ((!isLocalFree) && (!p_item.free) && (!p_item.subscription) && p_item.inserts[p_insert_index].anteprima && (parseInt(p_item.inserts[p_insert_index].anteprima) > 0)) {
		var txt_anteprima = document.createElement('div');
		txt.appendChild(txt_anteprima);
		txt_anteprima.className = 'button medium gray24 archivio_button_anteprima';
		txt_anteprima.style['text-align'] = 'center';
		txt_anteprima.appendChild(document.createTextNode('Anteprima'));
		$(txt_anteprima).bind('click', function() {
			openAnteprima(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, parseInt(p_item.inserts[p_insert_index].anteprima));
		});
		txt_anteprima = null;
	}

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	//VERIFICA!!!!*************************************
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.inserts[p_insert_index].description;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	//txt_subtitolo.innerHTML = p_item.editionDescription;
	txt_subtitolo.innerHTML = p_item.editionDescription + (!(isLocal || isLocalFree) ? l_prezzo : "");
	txt_subtitolo = null;

	if (isLocal) {
		var l_localdiv = document.createElement('img');
		txt.appendChild(l_localdiv);
		l_localdiv.style.paddingLeft = '10px';
		l_localdiv.src = 'imgs/qarchivio_locale_flag.png';
		l_localdiv = null;
	}

	txt = null;
	box = null;

}

function archivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;
				//console.log(l_item_id);

				if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					archivioRenderLocalAsIcon(l_local_item);

				}

			}

			archivioLoadTutti();
			setTimeout(function() {
				$('#archivio_loading').css('display', 'none');
			}, 500);
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

function archivioRenderLocalAsIcon(p_item) {
	console.log('archivioRenderLocalAsIcon');

	archivioUpdateFilter(p_item.edizione, p_item.edizione_descr);

	var item_full_id = p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	var isLocal = true;

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_container_box_islocal archivio_edizione_' + p_item.edizione;
	box.id = 'archivio_container_box_' + item_full_id;

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//???? DA VERIFICARE******************************

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['width'] = '100px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['width'] = '100px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_sfoglia.style.display = 'inline-block';
	txt_sfoglia = null;

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	//txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.edizione_descr;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	//txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre 2011'));
	txt_subtitolo.innerHTML = p_item.issue_descr;
	txt_subtitolo = null;

	txt = null;
	box = null;

}

var _ARCHIVIO_FILTRO_EDIZIONI = null;
function archivioInitFilter() {
	var l_filtro_tempo_select = $('#archivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_ARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#archivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	//var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);

}

function archivioUpdateFilter(p_edizione_id, p_edizione_descr) {
	if (jQuery.inArray(p_edizione_id, _ARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_ARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		var l_option = $('<option></option>');
		l_option.val(p_edizione_id);
		l_option.text(p_edizione_descr.replace('&igrave;', 'ì').replace('&#39;', '\''));
		$('#archivio_filtro_edizioni').append(l_option);
	}
}

function archivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#archivio_filtro_edizioni_tempo option:selected');

	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
			$('#archivio_container .archivio_container_box_islocal').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#archivio_container .archivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}
	}

	setTimeout(archivioUpdateIscroll, 100);
}/**
 * @author ABertacco
 */
var _QARCHIVIO_ISOPEN = false;
var _QARCHIVIO_MODE = 'ICONS';
var _QARCHIVIO_RENDERED_ITEMS = null;

var _QARCHIVIO_DEFAULT_EDIZIONE = 'SOLE';

var _PROID = null;

function qarchivioOpen(p_product_id, isFromSfoglio, defaultEdizione) {
	_QARCHIVIO_ISOPEN = true;
	_QARCHIVIO_DEFAULT_EDIZIONE = (defaultEdizione == null ? 'SOLE' : defaultEdizione);
	console.log('p_product_id ' + p_product_id);
	$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'hidden');

	_PROID = p_product_id;
	//alert('aaa'+_PROID);
	qarchivioLoad('ICONS', p_product_id);
	qarchivioLoadAdv(p_product_id);
	//$('#qarchivio').fadeIn();

	$('#qarchivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#qarchivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	//$('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_loading').css('display', 'inline-block');
	$('#qarchivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function qarchivioClose() {
	//$('#qarchivio').fadeOut();
	$('#qarchivio').css('display', 'none');
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}
	_QARCHIVIO_ISOPEN = false;
}

function sfogliaArchivio(p_testata, p_issue, p_edizione) {
	var keyinput = "unread_message_sole";
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}

	if ( typeof (window.localStorage) != 'undefined') {
		window.localStorage.setItem(keyinput, valoutput);
	} else {
		throw "window.localStorage, not defined";
	}

	window.loader.launchSfogliatore(p_testata, p_edizione, p_issue, "Descrizione" + valoutput);

}

function qarchivioCloseSfoglia() {
	//appmenuSfoglioOpen();
	//openFlipper();
	console.log("closesfoglia");

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	try {
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
		qarchivioClose();
		setTimeout(function() {
			console.log("launch page " + _CURRENT_FLIPPER_PAGINA);
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			//window.go.to(_CURRENT_FLIPPER_PAGINA);

		}, 1500);
	} catch(exc) {
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}
}

function qarchivioLoadAdv(p_product_id) {
	document.getElementById('qarchivio_footer_adv').innerHTML = '';
	//'http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
	$('#qarchivio_footer_adv').writeCapture().load(/*'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Bottom'*/_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();
}

function updateRichBtn() {
}

var _QARCHIVIO_ISCROLL = null;
function qarchivioUpdateIScroll() {
	//updateRichBtn();
	if (!_QARCHIVIO_ISOPEN)
		return;
	if (_QARCHIVIO_ISCROLL == null) {
		_QARCHIVIO_ISCROLL = new iScroll('qarchivio_wrapper', {
			hideScrollbar : false
		});
	} else {
		_QARCHIVIO_ISCROLL.refresh();
	}
}

function qarchivioLoad(mode, p_product_id) {
	console.log("qarchivioLoad p_product_id: " + p_product_id);

	// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
	if (_QARCHIVIO_IS_IN_MODIFICA)
		qarchivioVisualizza(true);

	$('#qarchivio_loading').css('display', 'inline-block');
	if (mode) {
		_QARCHIVIO_MODE = mode;
	} else {
		if (_QARCHIVIO_MODE == null) {
			_QARCHIVIO_MODE = 'ICONS';
		}
	}

	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}

	$('#qarchivio_container').empty();
	$('#qarchivio_subtitolo_opzioni_vista1').removeClass('qarchivio_subtitolo_opzioni_vista1_on');
	$('#qarchivio_subtitolo_opzioni_vista2').removeClass('qarchivio_subtitolo_opzioni_vista2_on');

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_QARCHIVIO_RENDERED_ITEMS = {};

	if (p_product_id && p_product_id != '') {

		//Inizializzazione filtro edizioni
		qarchivioInitFilter();

		console.log('---REQ---> past-issues/' + p_product_id);
		console.log(l_request_headers);
		console.log(l_request_data);

		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
			headers : l_request_headers,
			data : l_request_data,
			dataType : "json",
			success : function(p_response) {

				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}

				console.log('---RESP--> past-issues/' + p_product_id);
				console.log(p_response);

				//Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, function() {
					qarchivioLoad(mode, p_product_id);
				})) {
					var res = p_response.Result.res;

					_QARCHIVIO_PRODUCT = res;

					qarchivioRenderItems();
				} else {
					console.log('qarchivioLoad: Error, ' + p_response.Exception.Description);
					abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
					_QARCHIVIO_PRODUCT = {
						items : [],
						testata : _MAP_CODICE_TESTATA['' + p_product_id]
					};
					qarchivioRenderItems();
				}
			},
			error : function() {
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_QARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				qarchivioRenderItems();
			}
		});

	} else {
		//_QARCHIVIO_PRODUCT = { items: [], testata: _MAP_CODICE_TESTATA[''+p_product_id] };
		qarchivioRenderItems();
	}
	//alert('aaa '+$('#qarchivio_filtro_edizioni option:selected').val());
}

function qarchivioRenderItems() {
	console.log('qarchivioRenderItems...');
	_QARCHIVIO_RENDERED_ITEMS = {};
	//$('#qarchivio_titolo_prodotto').text(_QARCHIVIO_PRODUCT.productDescription);
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_QARCHIVIO_PRODUCT.productId];
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#qarchivio_titolo_prodotto').text(l_product_details.name);

	if (_QARCHIVIO_MODE == 'ICONS') {
		// modalità vista icone
		$('#qarchivio_subtitolo_opzioni_vista1').addClass('qarchivio_subtitolo_opzioni_vista1_on');

		var l_sole_count_per_cover = 0;

		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (_QARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
					l_sole_count_per_cover++;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsIcon(_QARCHIVIO_PRODUCT.items[i], j, (l_sole_count_per_cover <= 12) && (i <= 20));
				}
			}
		}
		console.log('prima di qarchivioLoadLocalData');
		//setTimeout("qarchivioLoadLocalData()",0);
		qarchivioLoadLocalData();
	} else {
		console.log("qarchivioRenderItems LIST");
		// modalità vista lista
		$('#qarchivio_subtitolo_opzioni_vista2').addClass('qarchivio_subtitolo_opzioni_vista2_on');

		qarchivioRenderItems_List_aux();
	}
}

function qarchivioRenderItems_List_aux() {
	console.log('qarchivioRenderItems_List_aux...' + _QARCHIVIO_PRODUCT.items.length);
	try {
		for (var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for (var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_' + _QARCHIVIO_PRODUCT.items[i].editionId + '_' + _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsList(_QARCHIVIO_PRODUCT.items[i], j);
				}
			}
		}

		qarchivioLoadLocalData();
	} catch (exc) {
		console.log("qarchivioRenderItems_List_aux::error: " + exc.message);
	}
}

var _CURRENT_QUEUE_LIST;
function downloadManagerCallbackQueueList(p_queue) {
	console.log('downloadManagerCallbackQueueList...');
	_CURRENT_QUEUE_LIST = p_queue;
	qarchivioRenderItems_List_aux();
	return "OK";
}

function isInQueueList(testata, issue, edizione) {
	//console.log('isInQueueList?');
	//console.log(testata + ' ' + issue + ' ' + edizione);
	if (_CURRENT_QUEUE_LIST == null)
		return false;
	for (var i = 0; i < _CURRENT_QUEUE_LIST.length; i++) {
		var l_item = _CURRENT_QUEUE_LIST[i];
		//console.log(l_item.testata + ' ' + l_item.issue + ' ' + l_item.edizione);
		if ((l_item.testata == testata) && (l_item.issue == issue) && (l_item.edizione == edizione)) {
			return true;
		}
	}
	return false;
}

/**
 * Crea la rappresentazione di un arretrato come icona
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24') && (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var img_div = document.createElement('div');
	box.appendChild(img_div);
	img_div.className = 'qarchivio_container_box_img_div';
	img_div.id = 'qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	if (createCoverImg) {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = p_item.inserts[p_insert_index].cover;
	} else {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = 'imgs/fake/fake_cover.jpg';
	}

	if (p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0)) {
		var premium_flag = document.createElement('img');
		img_div.appendChild(premium_flag);
		premium_flag.src = 'imgs/inserto_abbonati_archivio.png';
		premium_flag.className = 'qarchivio_container_box_img_div_premiumflag';
	}

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong><br />' + p_item.editionDescription;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
		}
	});
	checkLocalArretrato(p_item, p_insert_index);
}

/**
 * Crea la rappresentazione di un arretrato come lista
 * @params p_item Oggetto rappresentante l'arretrato
 *         p_insert_index Indice dell'inserto
 */
function qarchivioRenderAsList(p_item, p_insert_index) {
	console.log('qarchivioRenderAsList');
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + ' qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.inserts[p_insert_index].description) + ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24') && (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description + '</strong> ' + p_item.editionDescription;
	//p_item.editionTitle;
	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	btndiv.id = 'qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId;
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	btn.type = 'button';
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_' + p_item.inserts[p_insert_index].insertId;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'qarchivio_hidden_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + _QARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);

	checkLocalArretrato(p_item, p_insert_index);

}

/******************************************************
 Gestione caricamento arretrati salvati in locale
 ******************************************************/
/**
 * Carica gli articoli salvati in locale
 */
function qarchivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("qarchivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					if (_QARCHIVIO_MODE == 'ICONS') {
						qarchivioRenderLocalAsIcon(l_local_item);
					} else {
						console.log("NO ICONS");
						qarchivioRenderLocalAsList(l_local_item);
					}
				}

				qarchivioUpdateFilter(l_local_item.edizione, l_local_item.edizione_descr);
			}

			//Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#qarchivio_filtro_edizioni').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.qarchivio_container_box_ICONS').height(Math.round(window.innerHeight / 7));
			} else {
				$('.qarchivio_container_box_ICONS').height(Math.round(window.innerHeight / 4));
			}

			setTimeout(function() {
				//$('#qarchivio_container').css('visibility', 'hidden');
				$('#qarchivio_loading').css('display', 'none');
				//$('#qarchivio_container').css('visibility', 'visible');
				$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'visible');
				window.simulate.redraw();
			}, 500);

			setTimeout(function() {
				if (_QARCHIVIO_ISCROLL != null) {
					_QARCHIVIO_ISCROLL.refresh();
					_QARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
				}
			}, 550);
			/*
			 setTimeout(function(){
			 window.scrollTo(0,0);
			 },560);
			 */

		}
		var queryError = function(p_error) {
			console.log("qarchivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_QARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un arretrato in locale come icona
 * @params p_item Arretrato in locale come salvato nel db issues
 */
function qarchivioRenderLocalAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'qarchivio_container_box_img_div';
	$(img_div).click(function() {
		if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			console.log("sfoglia LIST archivio");
			//window.loader.local(true);
		}
	});
	box.appendChild(img_div);

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	var img = document.createElement('img');
	img_div_crop.appendChild(img);
	img.className = 'qarchivio_container_box_img';
	//ANDROID MODDED
	img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong><br />' + p_item.issue_descr;
	
	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	$(txt_local).click(function() {
		if ($('#qarchivio_container').hasClass('qarchivio_modify') && ($(this).hasClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE))) {
			eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
		}
	});

}

/**
 * Crea la rappresentazione in lista di un arretrato salvato in locale
 * @params p_item Arretrato in locale come salvato nel db issues
 *
 */
function qarchivioRenderLocalAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	//box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + p_item.edizione + ' qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + ' qarchivio_edizione_' + qarchivioLabelToValue(p_item.edizione_descr) + ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_' + qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + +p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
		console.log("sfoglia LIST archivio");
		window.loader.local(true);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + p_item.testata + "_" + p_item.edizione + "_" + p_item.issue;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);
}

/******************************************************
 Gestione filtro
 ******************************************************/
function qarchivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#qarchivio_filtro_edizioni_tempo option:selected');
	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_isremote').css('display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css('display', 'inline-block');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).css('display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_' + _QARCHIVIO_MODE).not('.qarchivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#qarchivio_container .qarchivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}

	}

	setTimeout(qarchivioUpdateIScroll, 100);
}

/**
 * Inizializza il filtro sulle edizioni da mostrare.
 */
var _QARCHIVIO_FILTRO_EDIZIONI = null;
function qarchivioInitFilter() {
	var l_filtro_tempo_select = $('#qarchivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});
	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_QARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#qarchivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});

	//var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);
	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	//l_option = $('<option value="SOLE" selected="selected">Il Sole 24 Ore</option>');
	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore") + '" selected="selected">Il Sole 24 Ore</option>');
	l_filtro_edizioni_select.append(l_option);
	//_QARCHIVIO_FILTRO_EDIZIONI.push("SOLE", "Il Sole 24 Ore");
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore"), "Il Sole 24 Ore");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore"),
		label : "Il Sole 24 Ore"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	/*
	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore lunedì") + '" selected="selected">Il Sole 24 Ore lunedì</option>');
	l_filtro_edizioni_select.append(l_option);
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore lunedì"), "Il Sole 24 Ore lunedì");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore lunedì"),
		label : "Il Sole 24 Ore lunedì"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);
	*/

	l_filtro_edizioni_select.append($('<optgroup label="Altre testate" id="qarchivio_filtro_edizioni_optgroup"></optgroup>'));
}

function qarchivioLabelToValue(p_label) {
	//return p_label.toLowerCase(p_label.replace(/[^a-zA-Z0-9]/g,'x'));
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function qarchivioUpdateFilter(p_edizione_id, p_edizione_descr) {

	if (jQuery.inArray(qarchivioLabelToValue(p_edizione_descr), _QARCHIVIO_FILTRO_EDIZIONI) == -1) {
		//_QARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue(p_edizione_descr), p_edizione_descr);
		var row = {
			value : qarchivioLabelToValue(p_edizione_descr),
			label : p_edizione_descr
		};
		//console.log('rich '+row.value+','+row.label);
		_QARCHIVIOFILTRORICH.push(row);
		//console.log('rich '+_QARCHIVIOFILTRORICH[0].value);
		var l_option = $('<option></option>');

		l_option.val(qarchivioLabelToValue(p_edizione_descr));
		l_option.html(p_edizione_descr);
		//$('#qarchivio_filtro_edizioni').append(l_option);
		//console.log('append-->'+l_option.html());
		$('#qarchivio_filtro_edizioni_optgroup').append(l_option);
	}

	if (_QARCHIVIO_DEFAULT_EDIZIONE == p_edizione_id) {
		$('#qarchivio_filtro_edizioni').val(qarchivioLabelToValue(p_edizione_descr));
	}
}

_QARCHIVIOFILTRORICH = new Array();
function updateRichFilter() {
}

/*
 * Controlla se un arretrato sia stato scaricato in locale
 * @params p_item Arretrato
 *         p_insert_index Indice dell'inserto
 */
function checkLocalArretrato(p_item, p_insert_index) {

	var l_testata = _QARCHIVIO_PRODUCT.testata;
	var l_issue = p_item.editionId;
	var l_edizione = p_item.inserts[p_insert_index].insertId;
	var l_edizione_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0);

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length <= 0)
				return;

			var l_query_result = p_results.rows.item(0);

			if (l_query_result.in_locale > 0) {
				$('#qarchivio_container_box_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId).addClass('qarchivio_container_box_isinlocal');
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE;
			} else {
				document.getElementById('qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione).className = 'qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE;
			}

			if (_QARCHIVIO_MODE == 'LIST') {
				var btn = document.getElementById('qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
					btn.value = 'Sfoglia';
					$(btn).click(function() {
						sfoglia(l_testata, l_issue, l_edizione);
						window.loader.local(true);
					});

					var del_btn = document.getElementById('qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue + '_' + l_edizione);
					del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
				} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
					// copia con download in corso
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					renderDownloadQueue(l_testata, l_issue, l_edizione);
				} else {
					if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
						if ((!p_item.subscription) && l_edizione_premium) {
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							btn.value = 'Solo per abbonati';
							$(btn).unbind();
							$(btn).bind('click', function() {
								mostraPopupInsertoAbbonati();
							});
						} else {
							// copia gratuita
							btn.className = 'button medium gray24 qarchivio_free_copy_btn';
							btn.value = 'Salva in locale';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ADD1 TO QUEUE " + l_testata + " " + l_issue + " " + l_edizione);
								addToDownloadQueue(l_testata, l_issue, l_edizione);
							});
						}
					} else if (l_edizione_premium) {
						btn.className = 'button medium red24 qarchivio_buy_copy_btn';
						btn.value = 'Solo per abbonati';
						$(btn).unbind();
						$(btn).bind('click', function() {
							mostraPopupInsertoAbbonati();
						});
					} else {
						if (p_item.single && (p_item.singleOffers.length > 0)) {
							// acquisto
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							//btn.value = 'Acquista ' + p_item.singleOffers[0].offerPrice + ' €';
							//btn.value = 'Acquista ' + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
							btn.value = 'Seleziona';
							$(btn).unbind();
							$(btn).bind('click', function() {
								console.log(";;;;;;;;;; ACQUISTO " + l_testata + " " + l_issue + " " + l_edizione);
								acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
							});
						} else {
							var btndiv = document.getElementById('qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
							btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
							btndiv.style['position'] = 'relative';
							btndiv.style['margin-right'] = '30px';
							btndiv.style['margin-top'] = '10px';
						}
					}
				}
			} else if (_QARCHIVIO_MODE == 'ICONS') {
			
				var icon = document.getElementById('qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_' + p_insert_index + '_' + p_item.editionId);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					$(icon).click(function() {
						if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (_QARCHIVIO_PRODUCT.free || l_query_result.da_scaricare > 0) {
				if (p_item.free || l_query_result.da_scaricare > 0 || p_item.subscription == true) {
					// copia gratuita
					$(icon).click(function() {
						//scarica(l_testata, l_issue, l_edizione);
						if ((!p_item.subscription) && l_edizione_premium) {
							sfogliaCheckPremium(l_testata, l_issue, l_edizione);
						} else {
							sfoglia(l_testata, l_issue, l_edizione);
						}
					});
				} else
				//if (p_item.subscription == false && p_item.single) {
				if (l_edizione_premium) {
					$(icon).click(function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					if (p_item.single && (p_item.singleOffers.length > 0)) {
						// acquisto
						$(icon).click(function() {
							acquistoSingolo(l_testata, l_issue, l_edizione, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId);
						});
					}
				}

			}
		}
		//try{
		var queryError = function(p_error) {
			console.log("checkLocalArretrato: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			var l_query = 'select * from (select count(*) as in_locale, 1 as id from issues where testata=? and issue=? and edizione=?) as a inner join (select count(*) as da_scaricare, 1 as id from issues where testata=? and issue=?) as b on (a.id = b.id)';
			tx.executeSql(l_query, [l_testata, l_issue, l_edizione, l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Passa alla modalità modifica
 */
var _QARCHIVIO_IS_IN_MODIFICA = false;
var _QARCHIVIO_PRE_MODIFICA_TEMPO = '';
function qarchivioModifica() {
	console.log("modifica");
	_QARCHIVIO_IS_IN_MODIFICA = true;
	$('#qarchivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#qarchivio_subtitolo_opzioni_visualizza').css('display', 'inline-block');

	$('#qarchivio_container').addClass('qarchivio_modify');

	_QARCHIVIO_PRE_MODIFICA_TEMPO = $('#qarchivio_filtro_edizioni_tempo').val();
	$('#qarchivio_filtro_edizioni_tempo').val("LOCAL");
	qarchivioAggiornaContenutoVisualizzato();
}

/**
 * Passa alla modalità visualizza
 */
function qarchivioVisualizza(light) {
	_QARCHIVIO_IS_IN_MODIFICA = false;
	$('#qarchivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	$('#qarchivio_subtitolo_opzioni_visualizza').css('display', 'none');

	$('#qarchivio_container').removeClass('qarchivio_modify');

	if (light == true)
		return;

	$('#qarchivio_filtro_edizioni_tempo').val(_QARCHIVIO_PRE_MODIFICA_TEMPO);
	qarchivioAggiornaContenutoVisualizzato();

	gestisciProssimaAzione();
	// <-- PERCHE'???

}
/**
 * @author ABertacco, MConventi
 */
var _USER_DEVICES = [];
var _IMPOSTAZIONI_MENU_ISCROLL = null;
var _IMPOSTAZIONI_VISTA_ISCROLL = null;
var _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};

function impostazioniInizializza() {
   if (_EDICOLA_USE_CATEGORIES) {
      var req_headers = {
         "appKey": _API24_APPKEY
      };
      var req_data = {
         "appName": device.appname,
         "appVersion": device.appversion,
         "deviceId": device.uuid,
         "deviceType": device.platform
      };
      console.log("--REQ---> getProducts4Impostazioni");
      console.log(req_headers);
      console.log(req_data);
      $.ajax({
         type: "GET",
         cache: false,
         timeout: _AJAX_TIMEOUT,
         contentType: "application/json; charset=utf-8",
         url: _SOLEGW_ENDPOINT + "products.json",
         headers: req_headers,
         data: req_data,
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log("--RESP--> getProducts4Impostazioni");
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
               //console.log('ajax success');
               var res = p_response.Result.res;
               _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};
               for (var i = 0; i < res.products.length; i++) {
                  var pid = res.products[i].productId;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid] = {};
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;
                  _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;
                  if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "storeplus") {
                     _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = "store";
                     _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type_original'] = "storeplus";
                  }
               }
               impostazioniInizializza_aux();
            }
         }
      });
   } else {
      _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = _EDICOLA_PRODUCTS_DETAILS;
      impostazioniInizializza_aux();
   }
}

function impostazioniInizializza_aux() {
   //Inizializza la lista dei prodotti disponibili
   inizializzaImpostazioniProdotti();
   // lista prodotti in select per selezione prodotto principale
   inizializzaListaProdottoPrincipale();
   // carico informativa privacy
   impostazioniLoadInformativaPrivacy();
}
var _IMPOSTAZIONI_ISCROLL_PRIVACY = null;

function impostazioniLoadInformativaPrivacy() {
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      url: 'http://du.ilsole24ore.com/utenti/Privacy.html',
      success: function (p_response) {
         if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
            _IMPOSTAZIONI_ISCROLL_PRIVACY.destroy();
            _IMPOSTAZIONI_ISCROLL_PRIVACY = null;
         }
         document.getElementById('informativa_privacy_body_container').innerHTML = p_response;
         // _IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
      },
      error: function () {}
   });
}
//corregge padding nel caso di monitor 10''
function adjustPadding() {
	$('#impostazioni_body_menu_container_box_generali, #impostazioni_body_menu_container_box_codicepromozionale, #impostazioni_body_menu_container_box_help').css({
		'paddingLeft': '5%'
	});
}

function impostazioniOpen() {
   //alert('aaaaa');
   impostazioniInizializza();
   var l_impostazioni_current = $('.impostazioni_body_menu_container_box_active');
   //alert($('#impostazioni_prodotto_principale_select').html());
   //if (l_impostazioni_current.length == 0)
   impostazioniOpenGenerali();
   //aggiusto 10''
   adjustPadding();
}

function impostazioniVistaClose(event) {
   event.stopPropagation();
   $('#impostazioni_body_vista_wrapper').removeClass('impostazioni_body_vista_active');
   $('#impostazioni_titolo_vista').removeClass('impostazioni_body_vista_active');
   $('.impostazioni_body_menu_container_box_active').removeClass('impostazioni_body_menu_container_box_active');
}

function impostazioniInitOpen(menu, title) {
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.destroy();
      _IMPOSTAZIONI_VISTA_ISCROLL = null;
   }
   $('#impostazioni_body_vista_wrapper').addClass('impostazioni_body_vista_active');
   $('#impostazioni_titolo_vista').addClass('impostazioni_body_vista_active');
   //$('#impostazioni_titolo_vista_back_button').css('display', 'none');
   $('#impostazioni_body_vista_container > div').css('display', 'none');
   $('.impostazioni_body_menu_container_box').removeClass('impostazioni_body_menu_container_box_active');
   $('#' + menu).addClass('impostazioni_body_menu_container_box_active');
   document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title;
   var l_back_button = $('#impostazioni_titolo_vista_back_button');
   l_back_button.html('<span></span><span>Impostaz.</span>');
   l_back_button.unbind('click');
   l_back_button.click(impostazioniVistaClose);
}

function impostazioniUpdateOrientation() {
   if (_IMPOSTAZIONI_MENU_ISCROLL != null) {
      _IMPOSTAZIONI_MENU_ISCROLL.refresh();
   }
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   if (_IMPOSTAZIONI_HELP_LOADED) hlpCreaLinea();
}

function impostazioniOpenGenerali() {
   impostazioniInitOpen('impostazioni_body_menu_container_box_generali', 'Generali');
   // informazioni sul profilo utente
   inizializzaAgganciaProfilo();
   // memoria disponibile
   if ((typeof device != "undefined") && (device.usedspace != null) && (device.usedspaceperc != null)) $('#impostazioni_body_vista_container_generali_memoria_value').html(device.usedspace + ' (' + device.usedspaceperc + ')');
   // carico informazioni sulle versioni
   $('#impostazioni_body_vista_container_generali_info_versione_app').text(device.appversion);
   $('#impostazioni_body_vista_container_generali_info_device_id').text(device.uuid);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: true,
      url: 'VERSION',
      success: function (p_response) {
         $('#impostazioni_body_vista_container_generali_info_versione_gui').text(p_response);
      },
      error: function () {
         $('#impostazioni_body_vista_container_generali_info_versione_gui').text('---');
      }
   });
   $('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   omnitureTrackApp('APP:impostazioni:generali', 'APP:impostazioni');
}
/**
 * Inizializza la sezione di "Aggancia profilo" nelle impostazioni generali
 */
function inizializzaAgganciaProfilo() {
   if (_MOD_OFFLINE) {
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
      //alert('aaa'+_MOD_OFFLINE);
      return;
   }
   //Se l'utente ha effettuato la login viene mostrato il pulsante per accedere al profilo
   if (_USERNAME) {
      //alert('aaa'+_USERNAME);
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_profilo_value').text(_USERNAME);
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'inline-block');
      //alert($('#impostazioni_body_vista_wrapper').width()+','+ $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth());
   } else {
      //alert('aaa');
      // Altrimenti viene mostrato il pulsante per aprire il popup per la login
      $('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
      $('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'inline-block');
   }
}
IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = null

function impostazioniGeneraliRegistrazione() {
   //console.log("REGISTRAZIONE 2");
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupImpostazioniRegistratiDone;
   if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
      IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
         bounce: false
      });
   } else {
      IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
   }
   //console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is "+IMP_ACQUISTO_REGISTRAZIONE_ISCROLL)
}

function impostazioniCodicePromoRegistrazione() {
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupCodicePromoRegistratiDone;
}

function impostazioniProdottoRegistrazione() {
   $('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
   $('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
   $('#acquisto_registrazione').css('display', 'inline');
   _NEXT_ACTION = popupProdottoRegistratiDone;
}

function popupImpostazioniRegistrati() {
   //_NEXT_ACTION = popupImpostazioniRegistratiDone;
   popupRegistrazioneApri();
}

function popupImpostazioniRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenGenerali();
}

function popupCodicePromoRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenCodicePromozionale();
}

function popupProdottoRegistratiDone() {
   $('#acquisto_registrazione').css('display', 'none');
   impostazioniOpenGenerali();
}
/******************************************************
 Gestione impostazioni codice promozionale
 ******************************************************/
/**
 * Apre la sezione delle impostazioni per l'attivazione di un codice promozionale
 * Nel caso in cui l'utente non sia autenticato viene richiesta la login o la registrazione
 */
function impostazioniOpenCodicePromozionale() {
   impostazioniInitOpen('impostazioni_body_menu_container_box_codicepromozionale', 'Codice promozionale');
   if (_USERNAME) {
      $('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'none');
      $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'inline-block');
   } else {
      $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'none');
      $('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'inline-block');
   }
   $('#impostazioni_body_vista_container_codicepromozionale').css('display', 'inline-block');
   
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
   omnitureTrackApp('APP:impostazioni:codice_promo', 'APP:impostazioni');
}
/**
 * Esegue la chiamata per l'attivazione di un codice promozionale
 */
function impostazioniOpenCodicePromozionaleAvanti() {
   var l_codice_promozionale = $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice #codice_promozionale').val();
   console.log('Sending the promotional code ' + l_codice_promozionale);
   if (l_codice_promozionale && l_codice_promozionale != '') {
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "appName": device.appname,
         "appVersion": device.appversion,
         "deviceId": device.uuid,
         "deviceType": device.platform,
         "username": _USERNAME //,
         //"promo_code": l_codice_promozionale
      };
      console.log('---REQ---> promo-code');
      console.log(l_req_headers);
      console.log(l_req_data);
      /*
 navigator.notification.loadingStart({
 'labelText': "Richiesta in corso...",
 'backgroundOpacity': 0.8,
 'strokeOpacity': 0.25,
 'strokeColor': "FFFFFF",
 });
 */
      window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
      $.ajax({
         type: "POST",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         //url: _SOLEGW_ENDPOINT + "promo-code.json",
         url: _SOLEGW_ENDPOINT + "promo/" + l_codice_promozionale + ".json",
         headers: l_req_headers,
         processData: false,
         data: JSON.stringify(l_req_data),
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> promo-code');
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response, impostazioniOpenCodicePromozionaleAvanti)) {
               abutils.alert('La tua promozione è stata attivata con successo', 'Codice promozionale');
            } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
               if (p_response.Exception.Description) {
                  abutils.alert(p_response.Exception.Description, 'Codice promozionale');
               } else {
                  abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale.', 'Codice promozionale');
               }
            }
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         },
         error: function () {
            abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale. Riprovare tra poco.', 'Codice promozionale');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      });
   } else {
      abutils.alert('Attenzione, inserire un codice promozionale', 'Codice promozionale');
   }
}
var _IMPOSTAZIONI_HELP_LOADED = false;
var hlpTabsScr, hlpContScr, hlpFaqScr, strOr, hlpGlobNav;

function hlpNav(hli) {
   $('#hlp_tbs2_scroll .tbon').removeClass("tbon");
   $('#hlp_tbs2_scroll .hlp_tb:eq(' + hli + ')').addClass("tbon");
   $('#hlp_tot div[class^=hlp_slide]:visible').fadeOut(200);
   $('#hlp_cont_scroll > div:eq(' + hli + ')').delay(200).fadeIn(200);
   setTimeout(function () {
      hlpContScr.refresh();
      hlpCreaLinea();
   }, 410);
}

function hlpCreaLinea() {
   console.log('hlpCreaLinea()');
   console.log(window.orientation);
   /*verticale o orizzontale*/
   if (typeof window.orientation != "undefined") {
      strOr = Math.abs(window.orientation) == 90 ? "l" : "p";
   } else { //temp non ipad
      strOr = window.innerWidth > window.innerHeight ? "l" : "p";
   }
   if (strOr == "l") {
      $('#hlp_mail').html('Desideri assistenza specifica? Contatta il Servizio Clienti all\'indirizzo <a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
   } else {
      $('#hlp_mail').html('Contatta il Servizio Clienti:<br><a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
   }
   if (hlpFaqScr != null) hlpFaqScr.refresh();
   setTimeout(function () {
      $("#hlp_cont_scroll canvas:visible").each(function (index, element) {
         var $c = $(this);
         var c = $(this)[0];
         $c.width(Number($c.data(strOr + "w")));
         $c.height(Number($c.data(strOr + "h")) + 15);
         c.width = Number($c.data(strOr + "w"));
         c.height = Number($c.data(strOr + "h") + 15);
         $c.css({
            'left': "-" + c.width + "px",
            'top': "-" + (c.height - 15) + "px"
         });
         var cxt = c.getContext("2d");
         cxt.strokeStyle = '#FF0000';
         cxt.lineWidth = 2;
         cxt.lineCap = 'round';
         cxt.moveTo(1, 1);
         cxt.lineTo(c.width - 7, c.height - 2);
         cxt.stroke();
      });
   }, 10);
}

function impostazioniOpenHelp() {
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.destroy();
      _IMPOSTAZIONI_VISTA_ISCROLL == null;
   }
   impostazioniInitOpen('impostazioni_body_menu_container_box_help', 'Help');
   console.log('PASSS HELP');
   //window.location = 'ipad_help.html';
   /*
 $('div').ajaxError(function(event, request, settings){
 alert("Error requesting page " + settings.url );
 });*/
   if (!_IMPOSTAZIONI_HELP_LOADED) {
      // carico il contenuto via ajax
      $.ajax({
         type: "GET",
         timeout: _AJAX_TIMEOUT,
         cache: true,
         url: "ipad_help.html",
         success: function (p_response) {
            try {
               console.log('ipad_help.html letto');
               $('#impostazioni_body_vista_container_help_content').html(p_response);
               //console.log('asdadadasdasdas');
               $('#impostazioni_body_vista_container_help').css('display', 'inline-block');
               // ATTENZIONE ---> evento di aggiornamento in impostazioniUpdateOrientation
               console.log('carico help');
               $('#hlp_tbs2_scroll .hlp_tb').click(function (e) {
                  e.preventDefault();
                  if (!$(this).hasClass('tbon')) {
                     var hli = $(this).index();
                     hlpNav(hli);
                  }
               });
               hlpNav(0);
               hlpTabsScr = new iScroll('hlp_tbs2', {
                  snap: "a",
                  hScrollbar: false
               });
               hlpContScr = new iScroll('hlp_cont', {
                  vScrollbar: false
               });
               hlpFaqScr = new iScroll('hlp_faq', {
                  vScrollbar: false
               });
               $('#hlp_faq').hide(0);
               $('#hlp_tbs1 .hlp_tb').click(function (e) {
                  if (hlpGlobNav != $(this).data('nav')) {
                     hlpGlobNav = $(this).data('nav');
                     $('#hlp_tbs1 .hlp_tb').toggleClass("tbon");
                     $('#hlp_glob_switch > div[id^=hlp_]').hide(0);
                     hlpFaqScr.refresh();
                     $('#hlp_glob_switch > #hlp_' + hlpGlobNav).fadeIn(300, function () {
                        if (hlpGlobNav == "faq") {
                           hlpFaqScr.refresh();
                        }
                     });
                  }
               });
            } catch (exc) {
               console.log(exc.message);
            }
            _IMPOSTAZIONI_HELP_LOADED = true;
         },
         error: function (XMLHttpRequest, textStatus, errorThrown) {
            /*
             * readyState
             * status
             * statusText
             * responseXML and/or responseText when the underlying request responded with xml and/or text, respectively
             * setRequestHeader(name, value) which departs from the standard by replacing the old value with the new one rather than concatenating the new value to the old one
             * getAllResponseHeaders()
             * getResponseHeader()
             * abort()
             */
            console.log("Error status :" + textStatus);
            console.log("Error type :" + errorThrown);
            console.log("Error message :" + XMLHttpRequest.status);
         }
      });
   }
   $('#impostazioni_body_vista_container_help').css('display', 'inline-block');
   /* lo fa il codice dell'help
 if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
 _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
 }
 else {
 _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
 }
 */
   omnitureTrackApp('APP:impostazioni:help', 'APP:impostazioni');
}
/******************************************************
 Gestione prodotto principale
 ******************************************************/
/**
 * Inizializza la lista dei prodotti tra i quali poter scegliere per selezionare il prodotto principale.
 */
function inizializzaListaProdottoPrincipale() {
   // Ottenere il prodotto principale da local storage
   var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
   var l_prodotto_principale_descr = window.localStorage.getItem("prodotto_principale_descr");
   var l_impostazioni_prodotto_principale_select = $('#impostazioni_prodotto_principale_select');
   l_impostazioni_prodotto_principale_select.empty();
   l_impostazioni_prodotto_principale_select.append($('<option value="">Nessun prodotto principale</option>'));
   for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
      if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
         var l_option = $('<option></option>');
         l_option.val(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId);
         l_option.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
         if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
            l_option.attr('selected', 'selected');
         }
         l_impostazioni_prodotto_principale_select.append(l_option);
      }
   }
}

function impostazioniProdottoPrincipaleSelectOnChange() {
   //alert('CIAO');
   console.log('impostazioniProdottoPrincipaleSelectOnChange...');
   var l_selected_option = $('#impostazioni_prodotto_principale_select option:selected');
   l_prodotto_principale_id = l_selected_option.val();
   l_prodotto_principale_descr = l_selected_option.text();
   window.localStorage.setItem("prodotto_principale_id", l_prodotto_principale_id);
   window.localStorage.setItem("prodotto_principale_descr", l_prodotto_principale_descr);
   //console.log('impostazioniProdottoPrincipaleSelectOnChange ---> '+l_selected_option.val()+':::'+ l_selected_option.text());
}
/******************************************************
 Gestione impostazioni prodotti
 ******************************************************/
/**
 * Inizializza la lista dei prodotti nel pannello delle impostazioni
 */
function inizializzaImpostazioniProdotti() {
   var l_lista_prodotti_container = $('#impostazioni_body_menu_container_box_lista_prodotti');
   l_lista_prodotti_container.empty();
   /*
 for (var key in _EDICOLA_PRODUCTS_DETAILS) {
 if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
 var pbox = $('<div></div>');
 pbox.addClass('impostazioni_body_menu_container_box');
 pbox.addClass('impostazioni_body_menu_container_box_prodotto');
 pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
 pbox.text(_EDICOLA_PRODUCTS_DETAILS[key].name);
 pbox.bind('click', (function(p_key){
 return function(){
 impostazioniOpenProdotto(_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _EDICOLA_PRODUCTS_DETAILS[p_key].name);
 }
 })(key));
 l_lista_prodotti_container.append(pbox);
 //alert('aaa_ '+_EDICOLA_PRODUCTS_DETAILS[key].icon);
 var img = document.createElement('img');
 img.className = 'impostazioni_body_menu_container_box_icon';
 img.src = _EDICOLA_PRODUCTS_DETAILS[key].icon;//'imgs/fake/s24_small_icon.png';
 pbox.append(img);
 img = null;
 pbox = null;
 }
 }*/
   for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
      if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
         var pbox = $('<div></div>');
         pbox.addClass('impostazioni_body_menu_container_box');
         pbox.addClass('impostazioni_body_menu_container_box_prodotto');
         pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
         pbox.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
         pbox.bind('click', (function (p_key) {
            return function () {
               impostazioniOpenProdotto(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].name);
            }
         })(key));
         l_lista_prodotti_container.append(pbox);
         var img = document.createElement('img');
         img.className = 'impostazioni_body_menu_container_box_icon';
         if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == _CODICE_PRODOTTO_QUOTIDIANO) img.src = 'imgs/fake/s24_small_icon.png';
         else img.src = _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].icon;
         pbox.append(img);
         img = null;
         pbox = null;
      }
   }
   if (_IMPOSTAZIONI_MENU_ISCROLL == null) {
      _IMPOSTAZIONI_MENU_ISCROLL = new iScroll('impostazioni_body_menu_wrapper', {
         bounce: false
      });
   } else {
      // aggiorno iscroll
      _IMPOSTAZIONI_MENU_ISCROLL.refresh();
   }
}
/**
 * Apre il pannello di impostazioni di un prodotto
 * @params p_product_id Il codice del prodotto
 *         p_product_description La descrizione del prodotto
 */
function impostazioniOpenProdotto(p_product_id, p_product_description) {
   impostazioniInitOpen('impostazioni_body_menu_container_box_' + p_product_id, p_product_description);
   $('#cartaceo_codice_abbonato').val('');
   $('#cartaceo_cap').val('');
   $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'none');
   if (_USERNAME) {
      $('#impostazioni_body_vista_container_prodotto_login').css('display', 'none');
      $('#impostazioni_body_vista_container_prodotto_info').css('display', 'inline');
      impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
   } else {
      $('#impostazioni_body_vista_container_prodotto_info').css('display', 'none');
      $('#impostazioni_body_vista_container_prodotto_login').css('display', 'inline-block');
      _NEXT_ACTION = function () {
         impostazioniOpenProdotto(p_product_id, p_product_description);
      }
   }
   $('#impostazioni_body_vista_container_prodotto').css('display', 'inline-block');
   if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
   }
   omnitureTrackApp('APP:impostazioni:prodotto:' + p_product_id, 'APP:impostazioni');
}
/**
 * Carica le info sull'abbonamento
 */
function impostazioniProdottoCaricaInfoAbbonamento(p_product_id) {
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "appName": device.appname,
      "appVersion": device.appversion,
      "deviceId": device.uuid,
      "deviceType": device.platform,
      "username": _USERNAME
   };
   console.log('---REQ---> subscription/' + p_product_id);
   console.log(l_req_headers);
   console.log(l_req_data);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _SOLEGW_ENDPOINT + "subscription/" + p_product_id + ".json",
      headers: l_req_headers,
      data: l_req_data,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> subscription/' + p_product_id);
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, function () {
            impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
         })) {
            var l_attivo = false;
            var l_date_end = null;
            try {
               //if (p_response.Result.res.endDate == null)
               if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
                  l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);
                  l_attivo = l_date_end > new Date();
               } else {
                  throw {
                     message: "endDate non valorizzato"
                  };
               }
            } catch (exc) {
               console.log(exc.message);
               console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
               l_attivo = false;
               l_date_end = null;
            }
            if (l_attivo) {
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Attivo');
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text(l_date_end.format('dd/mm/yyyy'));
            } else {
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Non Attivo');
               $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
               /*
 if (p_product_id == _CODICE_PRODOTTO_QUOTIDIANO) {
 $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'inline-block');
 }
 */
               if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
                  _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
               } else {
                  _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
                     bounce: false
                  });
               }
            }
         } else {
            $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('---');
            $('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
         }
      },
      error: ajaxErrorHandler
   });
}
/******************************************************
 Gestione impostazioni profilo
 ******************************************************/
/**
 * Apre il popup contenente le informazioni sul profilo utente
 */
var _IMPOSTAZIONI_PROFILO_ISCROLL = null;
var _IMPOSTAZIONI_PROFILO_INITIALIZED = false;

function popupImpostazioniProfilo() {
   window.location = 'http://du.ilsole24ore.com/utenti/areautente/ilmioprofilo.aspx';
   return;
   if (!_IMPOSTAZIONI_PROFILO_INITIALIZED) {
      //Se l'utente inserisce l'indirizzo email deve comparire il link all'informativa sulla privacy
      $('#impostazioni_profilo #id_email_address').unbind();
      $('#impostazioni_profilo #id_email_address').keyup(controlloSezioneConsensoEmail);
      //Inizializzazione campo data
      $('#id_birthdate').scroller({
         showOnFocus: false,
         theme: 'ios',
         mode: 'scroller',
         startYear: 1910
      });
      $('#id_birthdate').click(function () {
         $('#id_birthdate').scroller('show');
         return false;
      });
      _IMPOSTAZIONI_PROFILO_INITIALIZED = true;
   }
   $('#impostazioni_profilo').css('display', 'inline');
   $('#impostazioni_profilo_menu').css('display', 'none');
   //Inizializza i dati del profilo utente
   inizializzaProfilo();
}
/**
 * In base alla presenza dell'email mostra i campi per il consenso della privacy
 */
function controlloSezioneConsensoEmail() {
   if ($('#impostazioni_profilo #id_email_address').val() != '') {
      $('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeIn(200, function () {
         if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
            _IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
               bounce: false
            });
         } else {
            _IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
         }
      });
   } else {
      $('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeOut(200, function () {
         if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
            _IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
               bounce: false
            });
         } else {
            _IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
         }
      });
   }
}
/**
 * Inizializza i dati del profilo dell'utente che sta utilizzando l'applicativo
 */
var _PROFILE_FIELDS = [{
   id: 'email_address',
   type: 'text'
}, {
   id: 'ConsensoPrivacy',
   type: 'checkbox'
}, {
   id: 'ConsensoSocieta',
   type: 'checkbox'
}, {
   id: 'ConsensoMail',
   type: 'checkbox'
}, {
   id: 'first_name',
   type: 'text'
}, {
   id: 'last_name',
   type: 'text'
}, {
   id: 'birth_year',
   type: 'text'
}, {
   id: 'birth_month',
   type: 'text'
}, {
   id: 'birth_day',
   type: 'text'
}, {
   id: 'gender',
   type: 'select'
}, {
   id: 'address_street',
   type: 'text'
}, {
   id: 'city',
   type: 'text'
}, {
   id: 'provincia',
   type: 'text'
}, {
   id: 'state',
   type: 'text'
}, {
   id: 'zip_code',
   type: 'text'
}, {
   id: 'tel_number',
   type: 'text'
}, {
   id: 'mobile_phone',
   type: 'text'
}, {
   id: 'fax_number',
   type: 'text'
}, {
   id: 'societa_ente',
   type: 'text'
}, {
   id: 'professione',
   type: 'text'
}, {
   id: 'settore',
   type: 'text'
}, {
   id: 'codice_fiscale',
   type: 'text'
}, {
   id: 'partita_iva',
   type: 'text'
}];

function inizializzaProfilo() {
   console.log('Get profilo info for user ' + _USERNAME);
   $('#impostazioni_profilo #id_username').text(_USERNAME);
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "username": _USERNAME
   };
   console.log('---REQ---> getUserProfile');
   console.log(l_req_headers);
   console.log(l_req_data);
   $.ajax({
      type: "GET",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _API24_ENDPOINT + "Users/getUserProfile",
      headers: l_req_headers,
      data: l_req_data,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> getUserProfile');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, inizializzaProfilo)) {
            //Per tutti i campi definiti in _PROFILE_FIELDS vengono inizializzati i valori nel popup di impostazioni profilo
            for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
               //Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
               var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
               //Se l'elemento html esiste
               if (l_html_element) {
                  //In base al tipo di elemento viene inizializzato il valore
                  if (_PROFILE_FIELDS[i].type == 'text') {
                     if (p_response.Result[_PROFILE_FIELDS[i].id]) {
                        l_html_element.val(p_response.Result[_PROFILE_FIELDS[i].id]);
                     } else {
                        l_html_element.val('');
                     }
                  }
                  if (_PROFILE_FIELDS[i].type == 'checkbox') {
                     if (p_response.Result[_PROFILE_FIELDS[i].id]) {
                        if (p_response.Result[_PROFILE_FIELDS[i].id] == '0') {
                           l_html_element.attr('checked', false);
                        } else if (p_response.Result[_PROFILE_FIELDS[i].id] == '1') {
                           l_html_element.attr('checked', true);
                        }
                     } else {
                        l_html_element.attr('checked', false);
                     }
                     l_html_element.change();
                  }
                  if (_PROFILE_FIELDS[i].type == 'select') {
                     $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').removeAttr('selected');
                     l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option[value=' + p_response.Result[_PROFILE_FIELDS[i].id] + ']');
                     l_html_element.attr('selected', 'selected');
                  }
               }
            }
            //Inizializzazione campo data di nascita
            if (p_response.Result['birth_day'] && p_response.Result['birth_month'] && p_response.Result['birth_year']) {
               $('#id_birthdate').scroller('setDate', new Date(p_response.Result['birth_month'] + '/' + p_response.Result['birth_day'] + '/' + p_response.Result['birth_year']), true);
            }
            controlloSezioneConsensoEmail();
         }
         /*
 else {
 //Gestione eccezioni
 //TODO
 alert('Attenzione, ' + p_response.Exception.Description);
 }
 */
      },
      error: ajaxErrorHandler
   });
}
/**
 * Salva i dati del profilo
 */
function popupImpostazioniProfiloAvanti() {
   if (controlloDatiProfilo()) {
      // Definizione del profilo utente
      var l_user_profile = {
         "siteCode": _API24_SITECODE,
         "username": _USERNAME,
         "disclaimer": "1"
      };
      var l_user_email = $('#impostazioni_profilo #id_email_address').val();
      // Nel caso in cui sia presente l'indirizzo email devono essere aggiunti i campi sul consenso
      if (l_user_email != '') {
         l_user_profile['email_address'] = l_user_email;
         l_user_profile['consensoPrivacy'] = ($('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked') == "checked" ? '1' : '0');
         l_user_profile['consensoMail'] = ($('#impostazioni_profilo #id_ConsensoMail').attr('checked') == "checked" ? '1' : '0');
         l_user_profile['consensoSocieta'] = ($('#impostazioni_profilo #id_ConsensoSocieta').attr('checked') == "checked" ? '1' : '0');
      }
      //Imposta la data di nascita
      var l_birthdate = $('#id_birthdate').scroller('getDate');
      $('#impostazioni_profilo #id_birth_day').val(l_birthdate.getDate());
      $('#impostazioni_profilo #id_birth_month').val(l_birthdate.getMonth() + 1);
      $('#impostazioni_profilo #id_birth_year').val(l_birthdate.getFullYear());
      //Per tutti i campi definiti in _PROFILE_FIELDS vengono letti i nuovi valori dal popup di impostazioni profilo
      for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
         if (!(_PROFILE_FIELDS[i].id in {
            email_address: 1,
            ConsensoPrivacy: 1,
            ConsensoMail: 1,
            ConsensoSocieta: 1
         })) {
            //Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
            var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
            //Se l'elemento html esiste
            if (l_html_element) {
               //In base al tipo di elemento viene settato il nuovo valore
               if (_PROFILE_FIELDS[i].type == 'text') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = l_html_element.val();
               }
               if (_PROFILE_FIELDS[i].type == 'checkbox') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = (l_html_element.attr('checked') == "checked" ? '1' : '0');
               }
               if (_PROFILE_FIELDS[i].type == 'select') {
                  l_user_profile[_PROFILE_FIELDS[i].id] = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').val();
               }
            }
         }
      }
      console.log('updateUserProfile call for ' + _USERNAME + ': ' + l_user_profile);
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "profile": l_user_profile
      };
      console.log('---REQ---> updateUserProfile');
      console.log(l_req_headers);
      console.log(l_req_data);
      $.ajax({
         type: "POST",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         url: _API24_ENDPOINT + "Users/updateUserProfile",
         headers: l_req_headers,
         processData: false,
         data: JSON.stringify(l_req_data),
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> updateUserProfile');
            console.log(p_response);
            if (checkAjaxResponse(p_response, popupImpostazioniProfiloAvanti)) {
               //Chiudi popup
               popupImpostazioniProfiloChiudi();
            } else {
               //Gestione messaggi di errore dal server
               if (p_response.Exception.Name == 'InvalidParameterException') {
                  abutils.alert('Attenzione, uno o più campi inseriti non sono validi.', 'Aggiornamento profilo')
               } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
                  abutils.alert(p_response.Exception.Description, 'Aggiornamento profilo');
               }
            }
         },
         error: function (xmlHttpRequest, textStatus, errorThrown) {
            /*
 console.log('ajax error');
 console.log(textStatus);
 alert('Funzione non disponibile in assenza di connessione');
 */
         }
      });
   }
}
/**
 * Controlla che i dati del profilo siano stati immessi correttamente
 */
function controlloDatiProfilo() {
   var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
   // Controllo email
   email = $('#impostazioni_profilo #id_email_address').val();
   if (email == '') {
      abutils.alert("Attenzione, inserire un indirizzo email valido.", 'Profilo utente');
      return false;
   }
   if (email != '' && !ck_email.test(email)) {
      abutils.alert("Attenzione, l'indirizzo email inserito non è valido.", 'Profilo utente');
      return false;
   }
   // Controllo consenso alla privacy solo in caso di email non vuota
   if (email != '' && !$('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked')) {
      abutils.alert("Attenzione, per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Profilo utente');
      return false;
   }
   return true;
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloChiudi() {
   //$('#impostazioni_profilo').fadeOut();
   $('#impostazioni_profilo').css('display', 'none');
}
/******************************************************
 Gestione popup di account menu
 ******************************************************/
/**
 * Apre il popup contenente il menu delle azioni riguardanti il profilo utente
 * Da tale menu l'utente potrà:
 *   - Visualizzare informazioni del proprio profilo
 *   - Disassociare il proprio account
 */
function popupImpostazioniProfiloMenu() {
   //alert('is '+$('#impostazioni_prodotto_principale_select'));
   $('#impostazioni_prodotto_principale_select').attr('disabled', 'true');
   $('#impostazioni_profilo_menu_account_username').text(_USERNAME);
   $('#impostazioni_profilo_menu').css('display', 'inline');
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloMenuChiudi() {
   //$('#impostazioni_profilo_menu').fadeOut();
   //alert('is '+$('#impostazioni_prodotto_principale_select').attr());
   $('#impostazioni_prodotto_principale_select').removeAttr('disabled');
   $('#impostazioni_profilo_menu').css('display', 'none');
}
/******************************************************
 Gestione pannello lista dispositivi
 ******************************************************/
/**
 * Apre la sezione per la gestione dei dispositivi associati all'utente
 */
function impostazioniGeneraliDispositivi() {
   $('#impostazioni_body_vista_container_dispositivi_lista').css('display', 'none');
   $('#impostazioni_body_vista_container_generali').css('display', 'none');
   $('#impostazioni_body_vista_container_dispositivi').css('display', 'inline-block');
   //Inizializza il pulsante di ritorno verso le impostazioni generali
   /*
 var l_back_button = $('#impostazioni_titolo_vista_back_button');
 l_back_button.html('<span></span>Generali');
 l_back_button.css('display', 'inline-block');
 l_back_button.click(impostazioniGeneraliDispositiviChiudi);
 */
   $('#impostazioni_titolo_vista_txt').text('Dispositivi');
   inizializzaListaDispositivi();
}
/**
 * Ottiene dal server la lista dei dispositivi associati all'utente ed inizializza la sezione
 */
function inizializzaListaDispositivi() {
   if (_USERNAME) {
      //console.log('Get devices for user ' + _USERNAME);
      var l_section_body = $('#impostazioni_body_vista_container_dispositivi_lista');
      l_section_body.empty();
      var l_req_headers = {
         "appKey": _API24_APPKEY,
         "userIdentity": _USER_IDENTITY
      };
      var l_req_data = {
         "username": _USERNAME
      };
      console.log('---REQ---> getUserDevices');
      console.log(l_req_headers);
      console.log(l_req_data);
      //Ottengo i dispositivi associati all'utenza in base alle info date da API24
      $.ajax({
         type: "GET",
         timeout: _AJAX_TIMEOUT,
         cache: false,
         contentType: "application/json; charset=utf-8",
         url: _API24_ENDPOINT + "Users/getUserDevices",
         headers: l_req_headers,
         data: l_req_data,
         dataType: "json",
         success: function (p_response) {
            if (typeof p_response == "string") {
               p_response = $.parseJSON(p_response);
            }
            console.log('---RESP--> getUserDevices');
            console.log(p_response);
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response, inizializzaListaDispositivi)) {
               //p_response.Result.res = [{"id":"1234567890","name":"Questo device","type":1},{"id":"222","name":"Device 2","type":2},{"id":"333","name":"Device 3","type":3}]; //TODO PER DEBUG
               for (var i = 0; i < p_response.Result.res.length; i++) {
                  var l_device = p_response.Result.res[i];
                  //I dispositivi associati vengono memorizzati in una variabile globale
                  _USER_DEVICES[l_device.id] = l_device;
                  //Viene creato l'elemento nella lista dei dispositivi
                  var l_device_element_container = $('<div></div>');
                  l_device_element_container.addClass('impostazioni_body_vista_container_label');
                  if (l_device["name"] != '') l_device_element_container.html(l_device["name"] + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
                  else l_device_element_container.html("Dispositivo senza nome" + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
                  if (l_device.id != device.uuid) {
                     var l_device_element_button = $('<div></div>');
                     l_device_element_button.addClass("button medium red24 impostazioni_body_vista_container_label_button");
                     l_device_element_button.text("Disassocia");
                     l_device_element_button.attr("onclick", '_NEXT_ACTION=impostazioniGeneraliDispositivi;popupDisassociaDispositivo("' + l_device.id + '")');
                     l_device_element_container.append(l_device_element_button);
                  }
                  l_section_body.append(l_device_element_container);
               }
               l_section_body.fadeIn();
               if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
                  _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
                     bounce: false
                  });
               } else {
                  _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
               }
            } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
               abutils.alert(p_response.Exception.Description, 'Dispositivi');
            }
         },
         error: ajaxErrorHandler
      });
   } else {
      impostazioniGeneraliDispositiviChiudi();
      inizializzaAgganciaProfilo();
   }
}
/**
 * Chiude la sezione per la gestione dei dispositivi e riapre le impostazioni generali
 */
function impostazioniGeneraliDispositiviChiudi() {
   $('#impostazioni_titolo_vista_txt').text('Generali');
   //Inizializza il pulsante di ritorno verso le impostazioni generali
   var l_back_button = $('#impostazioni_titolo_vista_back_button');
   l_back_button.html('<span></span>');
   l_back_button.css('display', 'none');
   $('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
   $('#impostazioni_body_vista_container_dispositivi').css('display', 'none');
   if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
      _IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
         bounce: false
      });
   } else {
      _IMPOSTAZIONI_VISTA_ISCROLL.refresh();
   }
}
/******************************************************
 Gestione popup disassocia dispositivo
 ******************************************************/
/**
 * Apre il popup che permette di disassociare un dispositivo
 */
function popupDisassociaDispositivo(p_device_id) {
   $('#disassocia_dispositivo').css('display', 'inline');
   if (p_device_id) {
      $('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti("' + p_device_id + '");')
   } else {
      $('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti();')
   }
}
/**
 * Chiude il popup per disassociare un dispositivo
 */
function popupDisassociaDispositivoChiudi() {
   //$('#impostazioni_profilo_menu').fadeOut();
   $('#disassocia_dispositivo').css('display', 'none');
}
/**
 * Disassocia l'account dal dispositivo
 */
function popupDisassociaDispositivoAvanti(p_device_id) {
   console.log('Delete user association to the device');
   var l_request_data = {
      "username": _USERNAME,
      "deviceID": device.uuid,
      "deviceType": device.platform
   };
   //Se il device id è settato viene disassociato il device memorizzato in _USER_DEVICES[l_device.id]
   if (p_device_id) {
      l_request_data["deviceID"] = p_device_id;
      l_request_data["deviceType"] = _USER_DEVICES[p_device_id]["type"];
   } else {
      _EDICOLA_LAST_PRODUCT_LOAD = 0;
   }
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   console.log('---REQ---> removeUserDevice');
   console.log(l_req_headers);
   console.log(l_request_data);
   /*
 navigator.notification.loadingStart({
 'labelText': "Disassociazione in corso...",
 'backgroundOpacity': 0.8,
 'strokeOpacity': 0.25,
 'strokeColor': "FFFFFF",
 });*/
   window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Disassociazione in corso..."]);
   //Ottengo la username associata al device in base alle info date da API24
   $.ajax({
      type: "POST",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _API24_ENDPOINT + "Users/removeUserDevice",
      headers: l_req_headers,
      data: JSON.stringify(l_request_data),
      processData: false,
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> removeUserDevice');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, function () {
            popupDisassociaDispositivoAvanti(p_device_id);
         })) {
            if (!p_device_id) {
               abutils.alert('L\'account è stato disassociato dal dispositivo', 'Disassociazione dispositivo');
               setUserData(null, null, null);
               /*
 _USERNAME = null;
 _PASSWORD = null;
 deleteUsername();
 deletePassword();
 */
               inizializzaAgganciaProfilo();
            }
            popupDisassociaDispositivoChiudi();
            gestisciProssimaAzione();
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
            abutils.alert(p_response.Exception.Description, 'Disassociazione dispositivo');
         } else {
            abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      },
      error: function () {
         abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
         navigator.notification.loadingStop();
      }
   });
}
/**
 * Cancella tutte le edizioni presenti in locale
 */
function impostazioniCancellaContenutoLocale() {
   navigator.notification.confirm('Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?', function (button) {
      if (button == 1 && _DB) {
    	  window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Cancellazione in corso..."]);
         _DB.transaction(function (transaction) {
            transaction.executeSql("DELETE FROM issues", [], function (transaction) {
               console.log('delete db ok');
               window.soledelete.deleteAll('/S24/');
               console.log('delete fs ok');
               navigator.notification.alert('Tutte le edizioni presenti sono state cancellate.', function () {
                  //navigator.notification.loadingStop();
            	   window.simulatePG.exec(null, null, "Notification", "activityStop", []);
               }, 'Cancellazione contenuto locale', 'Ok');
            }, function () {
               console.log('delete error');
               navigator.notification.alert('Si è verificato un errore durante la cancellazione.', function () {
                  //navigator.notification.loadingStop();
            	   window.simulatePG.exec(null, null, "Notification", "activityStop", []);
               }, 'Cancellazione contenuto locale', 'Ok');
            });
         });
      }
   }, 'Cancellazione contenuto locale', 'Si,No');
}
/*
 * Aggancio abbonamento cartaceo
 */
function impostazioniCartaceoAgganciaAbbonamento() {
   var l_sub_code = $('#cartaceo_codice_abbonato').val();
   var l_sub_cap = $('#cartaceo_cap').val();
   if ((l_sub_code.length <= 0) || (l_sub_cap.length <= 0)) {
      abutils.alert('Inserire il proprio Codice Abbonato e il CAP', 'Aggancio abbonamento');
      return;
   }
   var l_req_headers = {
      "appKey": _API24_APPKEY,
      "userIdentity": _USER_IDENTITY
   };
   var l_req_data = {
      "username": _USERNAME,
      "deviceID": device.uuid,
      "deviceType": device.platform,
      "appName": device.appname,
      "appVersion": device.appversion,
      "subscriptionCode": l_sub_code,
      "subscriptionType": "XXX",
      "cap": l_sub_cap
   };
   console.log('---REQ---> subscription-paper');
   console.log(l_req_headers);
   console.log(l_req_data);
   window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
   $.ajax({
      type: "POST",
      timeout: _AJAX_TIMEOUT,
      cache: false,
      contentType: "application/json; charset=utf-8",
      url: _SOLEGW_ENDPOINT + "subscription-paper.json",
      headers: l_req_headers,
      processData: false,
      data: JSON.stringify(l_req_data),
      dataType: "json",
      success: function (p_response) {
         if (typeof p_response == "string") {
            p_response = $.parseJSON(p_response);
         }
         console.log('---RESP--> subscription-paper');
         console.log(p_response);
         //Controlla la risposta avuta dal server
         if (checkAjaxResponse(p_response, impostazioniCartaceoAgganciaAbbonamento)) {
            abutils.alert('Il tuo abbonamento cartaceo è stato associato al tuo profilo', 'Aggancio abbonamento');
            $('#impostazioni_body_menu_container_box_' + _CODICE_PRODOTTO_QUOTIDIANO).click();
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         } else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
            abutils.alert(p_response.Exception.Description, 'Aggancio abbonamento');
            //navigator.notification.loadingStop();
            window.simulatePG.exec(null, null, "Notification", "activityStop", []);
         }
      },
      error: function () {
         abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Aggancio abbonamento');
         navigator.notification.loadingStop();
      }
   });
}/**
 * @author mconventi
 */
_RICHOFFLINE_FILTRO_EDIZIONI = new Array();
var _MOD_OFFLINE = null;
var _EDICOLA_OFFLINE_MODE = 'ICONS';
//console.log('PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS');
function enableOfflineMode(){
    if (_MOD_OFFLINE != true) {
        _MOD_OFFLINE = true;
		
        //if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
            edicolaOfflineOpen();
        //}
    }
}

function enableOnlineMode(){
    if (_MOD_OFFLINE != false) {
    	
    	var l_first_run = _MOD_OFFLINE == null;
    	
        _MOD_OFFLINE = false;
        
        //if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
            edicolaOfflineClose(!l_first_run);
        //}
    }
}

function edicolaOfflineOpen(){
    edicolaOfflineInitFilter();
    edicolaOfflineLoad('ICONS');
    $('#edicola_offline').css('display', 'inline-block');
    $('#edicola').css('display', 'none');
    
    // disabilito impostazioni
    $('#impostazioni_body_menu_container_box_lista_prodotti').css('display', 'none');
    $('#impostazioni_body_menu_container_box_codicepromozionale').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
   	$('#impostazioni_body_vista_container_generali_prodottoprincipale').css('display', 'none');
    impostazioniOpenGenerali();
    
    if(window.innerWidth < 790 || window.innerWidth == 1024){
    	$("#edicola_offline_filtro").hide();
    }
}

function edicolaOfflineClose(reloadEdicola){
	
	if (reloadEdicola) {
		/*
		navigator.notification.loadingStart({
	        'labelText': "Modalità on-line...",
	        'backgroundOpacity': 0.80,
	        'strokeOpacity': 0.25,
	        'strokeColor': "FFFFFF",
	    });
	    */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento","Modalità on-line..."]);
	    setTimeout(function() {
	    	
	    	window.location = 'galaxy.html';
	    	
	    }, 1000);
   	} else {
   		$('#edicola_container').hide();
	    $('#edicola_prodotto').hide();
	    $('#edicola').css('display', 'inline-block');
	    $('#edicola_offline').css('display', 'none');
	    loadProducts();
   	}
}


var _EDICOLA_OFFLINE_ISCROLL = null;
function edicolaOfflineUpdateIscroll(){
    if (!_MOD_OFFLINE) 
        return;
    setTimeout(function(){
        if (_EDICOLA_OFFLINE_ISCROLL == null) {
            _EDICOLA_OFFLINE_ISCROLL = new iScroll('edicola_offline_wrapper', {
                hideScrollbar: false
            });
        }
        else {
            _EDICOLA_OFFLINE_ISCROLL.refresh();
        }
    }, 100);
}

/**
 * Carica gli articoli salvati in locale
 */
function edicolaOfflineLoad(mode){


    _EDICOLA_OFFLINE_MODE = mode;
    
    if (_EDICOLA_OFFLINE_ISCROLL != null) {
        _EDICOLA_OFFLINE_ISCROLL.destroy();
        _EDICOLA_OFFLINE_ISCROLL = null;
    }
    
    
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
        
            $('#edicola_offline_container').empty();
            $('#edicola_offline_subtitolo_opzioni_vista_ICONS').removeClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on');
            $('#edicola_offline_subtitolo_opzioni_vista_LIST').removeClass('edicola_offline_subtitolo_opzioni_vista_LIST_on');
            $('#edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE).addClass('edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE + '_on');
            
            var len = p_results.rows.length;
            console.log("edicolaOfflineLoad: read items:" + len);
            
            for (var i = 0; i < p_results.rows.length; i++) {
                if (_EDICOLA_OFFLINE_MODE == 'ICONS') {
                    edicolaOfflineRenderAsIcon(p_results.rows.item(i));
                }
                else {
                    edicolaOfflineRenderAsList(p_results.rows.item(i));
                }
                edicolaOfflineUpdateFilter(p_results.rows.item(i));
            }
            
            //Eseguendo l'evento di change del filtro prodotti, anche in caso di switch della vista si otterrà
            // sempre una visualizzazione coerente in base al prodotto filtrato
            $('#edicola_offline_filtro').change();
					
				var isPortrait = window.innerWidth < window.innerHeight;
				if (isPortrait) {
					$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 7));
				} else {
					$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 4));
				}
            
            edicolaOfflineUpdateIscroll();
				updateRichFiltroOff();
        }
        
        var queryError = function(p_error){
            console.log("edicolaOfflineLoad: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM issues order by issue DESC', [], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
    
}

/**
 * Crea la rappresentazione di un oggetto in locale come icona
 * @params p_item Oggetto in locale come salvato nel db issues
 */
function edicolaOfflineRenderAsIcon(p_item){
    var box = document.createElement('div');
    document.getElementById('edicola_offline_container').appendChild(box);
    //box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
    box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    box.style['display'] = 'none';
    
    var img_div = document.createElement('div');
    img_div.className = 'edicola_offline_container_box_img_div';
    img_div.id = 'edicola_offline_container_box_icon_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    $(img_div).click(function(){
		if (!$('#edicola_offline_container').hasClass('edicola_offline_modify')) 
        	sfoglia(p_item.testata, p_item.issue, p_item.edizione);
    });
    box.appendChild(img_div);
    
    var img = document.createElement('img');
    img_div.appendChild(img);
    img.className = 'edicola_offline_container_box_img';
    //img.src = navigator.fileMgr.docsFolderPath + '/issues/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	//ANDROID MODDED
    img.src = window.folder.getDir() + /*navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/'*/ '/'  + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';
    //console.log("path-off:: "+navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg');
    // flag stato edizione
    var txt_local = document.createElement('div');
    box.appendChild(txt_local);
    txt_local.id = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    txt_local.className = 'edicola_offline_container_box_txt_empty_' + _EDICOLA_OFFLINE_MODE;
    $(txt_local).click(function(){
        if ($('#edicola_offline_container').hasClass('edicola_offline_modify')) {
            eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
        }
    });
    
    var txt = document.createElement('div');
    box.appendChild(txt);
    txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
    txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong><br/>' + p_item.issue_descr + '<br />' + p_item.edizione_descr;
}

/**
 * Crea la rappresentazione in lista di un oggetto salvato in locale
 * @params p_item Oggetto salvato in locale
 *
 */
function edicolaOfflineRenderAsList(p_item){

    var box = document.createElement('div');
    document.getElementById('edicola_offline_container').appendChild(box);
    //box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
    box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    box.style['display'] = 'none';
    
    var txt = document.createElement('div');
    box.appendChild(txt);
    txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
    //txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong> ' + p_item.edizione_descr + ' ' + p_item.issue_descr;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;
    
    // bottone
    var btndiv = document.createElement('div');
    box.appendChild(btndiv);
    btndiv.style['float'] = 'right';
    var btn = document.createElement('input');
    btn.id = 'edicola_offline_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    btn.type = 'button';
    btn.className = 'button medium red24 edicola_offline_show_local_copy_btn';
    btn.value = 'Sfoglia';
    $(btn).click(function(){
        sfoglia(p_item.testata, p_item.issue, p_item.edizione);
    });
    btndiv.appendChild(btn);
    
    // delete
    var del_btn = document.createElement('input');
    del_btn.id = 'edicola_offline_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
    del_btn.type = 'button';
    del_btn.value = 'Elimina';
    del_btn.className = 'button medium red24 edicola_offline_delete_local_copy_btn';
    
    $(del_btn).click(function(){
        eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
    });
    
    btndiv.appendChild(del_btn);
}

/**
 * Inizializza il filtro sulle testate/edizioni da mostrare.
 */
_EDICOLA_OFFLINE_FILTRO_EDIZIONI = null;
function edicolaOfflineInitFilter(){
    if (_EDICOLA_OFFLINE_FILTRO_EDIZIONI != null) {
        $(_EDICOLA_OFFLINE_FILTRO_EDIZIONI).empty();
    }
    else {
        _EDICOLA_OFFLINE_FILTRO_EDIZIONI = new Array();
    }
    var l_filtro_select = $('#edicola_offline_filtro');
    l_filtro_select.empty();
    
    l_filtro_select.change(function(){
        var l_selected_option = $('#edicola_offline_filtro option:selected');
        
        if (l_selected_option.val() == '') {
            //$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).css('display', 'inline-block');
        }
        else {
            $('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).not('.edicola_offline_' + l_selected_option.val()).css('display', 'none');
            //$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).css('display', 'inline-block');
        }
		
		edicolaOfflineUpdateIscroll();
    });
    
    var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
    l_filtro_select.append(l_option);
    
    var row = {
			value : "", 
			label: "Tutti i prodotti"
    }
	console.log('rich '+row.value+','+row.label);
    _RICHOFFLINE_FILTRO_EDIZIONI.push(row);
}

/**
 * Gestisce la creazione del filtro sui prodotti da mostrare.
 * @params p_item Oggetto salvato in locale
 */
function edicolaOfflineLabelToValue(p_label) {
	return p_label.replace(/[^a-zA-Z0-9]/g,'x').toLowerCase();
}
function edicolaOfflineUpdateFilter(p_item){
    //var l_value = p_item.testata + '_' + p_item.edizione;
	var l_value = edicolaOfflineLabelToValue(p_item.edizione_descr);
    //var l_text = p_item.testata_descr + ' - ' + p_item.edizione_descr;
	var l_text = p_item.edizione_descr;
    //Se l'edizione non è presente nell'array _EDICOLA_OFFLINE_FILTRO_EDIZIONI crea un nuovo elemento nell'array ed aggiunge un opzione nel filtro
    if (jQuery.inArray(l_value, _EDICOLA_OFFLINE_FILTRO_EDIZIONI) == -1) {
    
        _EDICOLA_OFFLINE_FILTRO_EDIZIONI.push(l_value, l_text);
		
        var row = {	
				value : l_value, 
				label: l_text
			};
		console.log('rich '+row.value+','+row.label);
        _RICHOFFLINE_FILTRO_EDIZIONI.push(row);
        
        //alert(_RICHOFFLINE_FILTRO_EDIZIONI.length);
        
        var l_option = $('<option></option>');
        l_option.val(l_value);
        l_option.text(l_text);
        $('#edicola_offline_filtro').append(l_option);
    }
}

function updateRichFiltroOff(){
		var value_select = $('#edicola_offline_filtro option:selected').val();
		var dhtmlx_listProductsSelectOff = _RICHOFFLINE_FILTRO_EDIZIONI;
		
		$$('myRichOffselect').attachEvent("onchange",/*impostazioniProdottoPrincipaleSelectOnChange()*/function(newv,oldv){
			setTimeout(function(){
				if(oldv != newv){
					
							$('#edicola_offline_filtro option:selected').removeAttr('selected');

						if(newv.indexOf('Tutti i prodotti')==-1){
							$("#edicola_offline_filtro option[value='"+newv+"']").attr('selected', 'selected');
						}else{
							//alert('aaa'+newv);
							$("#edicola_offline_filtro option[value='']").attr('selected', 'selected');
						}
						console.log('changed');
						edicolaOfflineLoad(_EDICOLA_OFFLINE_MODE);
				}
			}, 200);

		});
		
}


/**
 * Passa alla modalità modifica
 */
function edicolaOfflineModifica(){
    $('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'none');
    $('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'inline-block');
    $('#edicola_offline_container').addClass('edicola_offline_modify');
}

/**
 * Passa alla modalità visualizza
 */
function edicolaOfflineVisualizza(){
    $('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'inline-block');
    $('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'none');
    $('#edicola_offline_container').removeClass('edicola_offline_modify');
}


var _INBOX_LIST_ISCROLL = null;
var _INBOX_MESSAGES = {};
var _INBOX_NUM_UNREAD_MESSAGES = 0;

function inboxRefreshInCorso() {
	$('#inbox_list_refresh_button').css('display', 'none');
	$('#inbox_list_refresh_message').html('Aggiornamento in corso...');
}

function inboxRefreshCompletato() {
	setTimeout(function() {
		$('#inbox_list_refresh_button').css('display', 'inline');
		$('#inbox_list_refresh_message').html('<strong>Aggiornato</strong> ' + (new Date()).format('dd/mm/yyyy') + ' <strong>' + (new Date()).format('HH:MM:ss') + '</strong>');
	}, 1000);
}

/*
 * Restituisce i messaggi presenti nel database locale
 * @return Lista di messaggi
 */
function inboxLoadMessages(){

    if (_INBOX_LIST_ISCROLL != null) {
        _INBOX_LIST_ISCROLL.destroy();
        _INBOX_LIST_ISCROLL = null;
    }
    
    $('#inbox_list_container').empty();
    
    // Controlla che il database sia stato inizializzato e carica i messaggi
    if (_DB) {
    
        var querySuccess = function(tx, p_results){
            var len = p_results.rows.length;
            //console.log("Read " + len + " messages from the local INBOX store.");
            
            inboxAddMessages(p_results.rows);
            
            inboxLoadUnreadMessages();
			
			//inboxOpenFirstMessageSilent();
			
			setInterval(inboxLoadUnreadMessages, _INTERVALLO_CHECK_INBOX);
        }
        
        var queryError = function(p_error){
            console.log("inboxLoadMessages: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            //tx.executeSql('DROP TABLE IF EXISTS INBOX_MESSAGES_2');
            tx.executeSql('CREATE TABLE IF NOT EXISTS INBOX_MESSAGES_2 (id unique, date, subject, mabstract, body, status)');
            tx.executeSql('SELECT id, date, subject, mabstract, body, status FROM INBOX_MESSAGES_2 order by date asc, id asc', [], querySuccess, queryError);
        }
        
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
}

function inboxCloseMsgView(){
	//$('#inbox_msg_container').css('display', 'none');
    $('#inbox_container').removeClass('inbox_container_open');
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
}

function inboxUpdateOrientation(){
    document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    
    console.log('inboxUpdateOrientation '+$('#inbox_container').hasClass('inbox_container_open')+','+document.getElementById('inbox_container').className);
    
    //se aperto msg inbox lo riapro quando sono in verticale
    if($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width < 790){
    	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
    }else if($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width > 790){
    	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
    }
    
    if (_INBOX_MSG_ISCROLL != null) {
        _INBOX_MSG_ISCROLL.refresh();
    }
    if (_INBOX_LIST_ISCROLL != null) {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function inboxAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
        inboxAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function inboxAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	inboxUpdateUnreadMessage();
}

/**
 * Carica i messaggi non letti in base al device
 */
var _INBOX_TOBEFETCH_MSGS = [];
var _INBOX_REFRESH_ISRUNNING = false;
function inboxLoadUnreadMessages(){
	
	if (_INBOX_REFRESH_ISRUNNING || (_INBOX_TOBEFETCH_MSGS.length > 0)) {
		console.log('Aggiornamento già in corso...');
		return;
	}
	
	_INBOX_REFRESH_ISRUNNING = true;

	inboxRefreshInCorso();

    //console.log('Retrieve unread messages');
    var l_signature = getSignature(device.uuid + ',' + device.platform);
    //console.log('Signature: ' + l_signature);
    
    var l_req_headers = {
        "appKey": _API24_APPKEY,
        "Signature": l_signature
    };
    var l_req_data = {
        "deviceID": device.uuid,
        "deviceType": device.platform
    };
    console.log('---REQ---> getUnreadMessagesDevice');
    console.log(l_req_headers);
    console.log(l_req_data);
    
    $.ajax({
        type: "GET",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/getUnreadMessagesDevice",
        headers: l_req_headers,
        data: l_req_data,
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> getUnreadMessagesDevice');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
                for (var i = 0; i < p_response.Result.messages.length; i++) {
                    var l_message = p_response.Result.messages[i];
                    _INBOX_TOBEFETCH_MSGS.push({
                        id: l_message.id,
                        subject: l_message.subject,
                        mabstract: "",
                        date: l_message.data,
                        body: "",
                        status: 1
                    });
                }
                
                inboxFetchMessages();
                
            }
            else {
                inboxRefreshCompletato();
            }
			
			_INBOX_REFRESH_ISRUNNING = false;
        },
        error: function() {
			inboxRefreshCompletato();
			
			_INBOX_REFRESH_ISRUNNING = false;
		}
    });
    
}

function inboxFetchMessages(){
    var l_message = _INBOX_TOBEFETCH_MSGS.shift();
    if (l_message == null) {
		inboxRefreshCompletato();
		//inboxOpenFirstMessageSilent();
		return;
	}
    console.log(l_message);
    
    // scarico in locale il messaggio
    var l_req_headers = {
        "appKey": _API24_APPKEY
    };
    var l_req_data = {
        "messageId": l_message.id
    };
    console.log('---REQ---> getMessageBody (' + l_message.id + ')');
    console.log(l_req_headers);
    console.log(l_req_data);
    
    $.ajax({
        type: "GET",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/getMessageBody",
        headers: l_req_headers,
        data: l_req_data,
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> getMessageBody (' + l_message.id + ')');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
				
                l_message.body = p_response.Result.body;
				
				if (p_response.Result.preview) {
					l_message.mabstract = p_response.Result.preview;
				} else {
					l_message.mabstract = "";
				}
                
                inboxMarkAsReadMessageOnServer(l_message);
                
            }
            else {
                inboxFetchMessages();
            }
        },
        error: function(){
            inboxFetchMessages();
        }
    });
}

function inboxMarkAsReadMessageOnServer(p_message){
    var l_signature = getSignature(p_message.id + ',' + device.uuid + ',' + device.platform);
    var l_req_headers = {
        "appKey": _API24_APPKEY,
        "Signature": l_signature
    };
    var l_req_data = {
        "messageId": p_message.id,
        "deviceId": device.uuid,
        "deviceType": device.platform
    };
    console.log('---REQ---> markMessageReadDevice (' + p_message.id + ')');
    console.log(l_req_headers);
    console.log(l_req_data);
    $.ajax({
        type: "POST",
        timeout: _AJAX_TIMEOUT,
        cache: false,
        contentType: "application/json; charset=utf-8",
        url: _API24_ENDPOINT + "MessageBroadcasting/markMessageReadDevice",
        headers: l_req_headers,
        processData: false,
        data: JSON.stringify(l_req_data),
        dataType: "json",
        success: function(p_response){
        
            if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
            
            console.log('---RESP--> markMessageReadDevice (' + p_message.id + ')');
            console.log(p_response);
            
            //Controlla la risposta avuta dal server
            if (checkAjaxResponse(p_response)) {
                // processo verso server completato, posso salvare il messaggio in locale
                inboxStoreMessageFromServer(p_message);
            }
            else {
                inboxFetchMessages();
            }
            
            
        },
        error: function(){
            inboxFetchMessages();
        }
    });
}

function inboxStoreMessageFromServer(p_message){
    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB) {
    
        var querySuccess = function(){
            console.log('inboxStoreMessageFromServer OK');
            inboxAddMessage(p_message);
            inboxFetchMessages();
        }
        
        var queryError = function(p_error){
            console.log("inboxStoreMessageFromServer KO: Error processing SQL: " + p_error.message);
            inboxFetchMessages();
        }
        
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO INBOX_MESSAGES_2 (id, date, subject, mabstract, body, status) VALUES (?,?,?,?,?,?)', [p_message.id, p_message.date, p_message.subject, p_message.mabstract, p_message.body, p_message.status], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
}

/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function inboxRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
    	if(screen.width < 790){
    		l_subject = l_subject.substring(0, 25);
    	}else{
    		l_subject = l_subject.substring(0, 40);
    	}
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            inboxOpenMessage(p_mid);
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

/*
function inboxOpenFirstMessageSilent() {
	var l_opened = $('.inbox_list_container_box_active');
	if (l_opened.length == 0) {
		var l_boxes = $('.inbox_list_container_box');
		if (l_boxes.length > 0) {
			console.log(l_boxes);
			$(l_boxes[0]).click();
			inboxCloseMsgView();
		}
	}
}
*/

var _INBOX_MSG_ISCROLL = null;
function inboxOpenMessage(mid){
	
    if (_INBOX_MSG_ISCROLL != null) {
        _INBOX_MSG_ISCROLL.destroy();
        _INBOX_MSG_ISCROLL = null;
    }
    
    inboxInitNavButtons(mid);
    
	$('#inbox_msg_title_content_del').css('display', 'inline-block');
	$('#inbox_msg_container_empty').css('display', 'none');
	
    var l_message_container = $('#inbox_msg_container');
    l_message_container.css('display', 'inline-block');
	
    var box = document.getElementById('inbox_list_container_box_' + mid);
    $('.inbox_list_container_box').removeClass('inbox_list_container_box_active');
    $(box).addClass('inbox_list_container_box_active');
    $(box).removeClass('inbox_list_container_box_unread');
    $(box).addClass('inbox_list_container_box_read');
    box = null;
	
	/*
	if (_ORIENTATION == 'V' && screen.width < 790){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-400px, 0px, 0)';
	} else if (_ORIENTATION == 'V' && screen.width > 790){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-800px, 0px, 0)';
	} else if(_ORIENTATION == 'H'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}
	*/
	
	if (_ORIENTATION == 'V'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if(_ORIENTATION == 'H'){
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}
	
	//.className+=' newclass'
	//document.getElementById('inbox_container').className += 'inbox_container_open';
	//alert('aaa'+document.getElementById('inbox_container').className);
    $('#inbox_container').addClass('inbox_container_open');
    //alert('aaa'+document.getElementById('inbox_container').className);
    //document.getElementById('inbox_container').className += 'inbox_container_open';
    
    if (_INBOX_MESSAGES['mid_' + mid] == null) return;
	 
    document.getElementById('inbox_msg_header_title').innerHTML = _INBOX_MESSAGES['mid_' + mid].subject;
    document.getElementById('inbox_msg_header_data').innerHTML = inboxFormatDate(_INBOX_MESSAGES['mid_' + mid].date);
	document.getElementById('inbox_msg_body').innerHTML = _INBOX_MESSAGES['mid_' + mid].body;
	_INBOX_MESSAGES['mid_' + mid].status = 0;
	inboxUpdateUnreadMessage();
    
    setTimeout(function(){
        if (_INBOX_MSG_ISCROLL == null) {
            _INBOX_MSG_ISCROLL = new iScroll('inbox_msg_wrapper');
        }
        else {
            _INBOX_MSG_ISCROLL.refresh();
        }
    }, 100);
	
	// marco il messaggio come letto sul db
    if (_DB) {
    
        var querySuccess = function(){
            console.log('inboxOpenMessage OK');
        }
        
        var queryError = function(p_error){
            console.log("inboxOpenMessage KO: Error processing SQL: " + p_error.message);
            inboxFetchMessages();
        }
        
        var executeQuery = function(tx){
            tx.executeSql('UPDATE INBOX_MESSAGES_2 SET status=0 WHERE id=?', [mid], querySuccess, queryError);
        }
        
        _DB.transaction(executeQuery, queryError);
    }
	
	omnitureTrackApp('APP:inbox:open:' + mid, 'APP:inbox');
}

function inboxUpdateUnreadMessage(){
	_INBOX_NUM_UNREAD_MESSAGES = 0;
	for (var key in _INBOX_MESSAGES) {
		var l_msg = _INBOX_MESSAGES[key];
		if (l_msg.status == 1)
			_INBOX_NUM_UNREAD_MESSAGES++;
	}
	
    if (_INBOX_NUM_UNREAD_MESSAGES > 0) {
        //$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
        //$('#appmenu_inbox_count').text('*');
        $('#appmenu_inbox_count').css('display', 'inline-block');
    }
    else {
        $('#appmenu_inbox_count').css('display', 'none');
    }
}

function inboxFormatDate(p_date) {
	if (p_date.length != 19) return "00 00 0000";
	var toks = p_date.split(' ');
	if (toks.length != 2) return "00 00 0000";
	var cals = toks[0].split('-');
	if (cals.length != 3) return "00 00 0000";
	return cals[2] + ' ' + cals[1] + ' ' + cals[0];
}

/**
 * Passa alla modalità modifica messaggi
 */
function inboxSwitchToModifyView(){
    $('#inbox_list_modify_button').hide();
    $('#inbox_list_show_button').show();
    $('.inbox_list_container_box').addClass('inbox_list_container_box_unselected');
    $('#elimina_messaggi').fadeIn();
}

/**
 * Passa alla modalità visualizza messaggi
 */
function inboxSwitchToShowView(){
    $('#inbox_list_show_button').hide();
    $('#inbox_list_modify_button').show();
    $('.inbox_list_container_box.inbox_list_container_box_unselected').removeClass('inbox_list_container_box_unselected');
    $('.inbox_list_container_box.inbox_list_container_box_selected').removeClass('inbox_list_container_box_selected');
    $('#elimina_messaggi').fadeOut();
}



/**
 * Inizializza lo stato dei pulsanti per la navigazione tra i messaggi
 */
function inboxInitNavButtons(p_header_id){
	//console.log("inboxInitNavButton");
    var l_next_element = $('#inbox_msg_title_nav_next_btn');
    l_next_element.unbind('click');

    var l_prev_element = $('#inbox_msg_title_nav_prev_btn');
    l_prev_element.unbind('click');

    if ($('#inbox_list_container_box_'+p_header_id).prev().length){
        l_next_element.removeClass('disabled');
        l_next_element.click(function(){
            inboxOpenPrevMsg(p_header_id);
        });
    }else{
        l_next_element.addClass('disabled');
    }

    if ($('#inbox_list_container_box_'+p_header_id).next().length){
        $('#inbox_msg_title_nav_prev_btn').removeClass('disabled');
        l_prev_element.click(function(){
            inboxOpenNextMsg(p_header_id);
        });
    }else{
        $('#inbox_msg_title_nav_prev_btn').addClass('disabled');
    }
}

/**
 * Apre il messaggio successivo
 */
function inboxOpenPrevMsg(p_header_id){
    var l_prev = $('#inbox_list_container_box_'+p_header_id).prev();
    if (l_prev.length) {
        var mid = l_prev[0].id.substr(25);
        inboxOpenMessage(mid);
    }
}
/**
 * Apre il messaggio precedente
 */
function inboxOpenNextMsg(p_header_id){
    var l_next = $('#inbox_list_container_box_'+p_header_id).next();
    if (l_next.length) {
        var mid = l_next[0].id.substr(25);
        inboxOpenMessage(mid);
    }
}




/*
 * Elimina i messaggi dal database
 * @params p_mids Lista dei identificativi dei messaggi
 */
function deleteLocalMessages(p_mids){

    // Controlla che il database sia stato inizializzato e salva il messaggio in locale
    if (_DB && p_mids.length > 0) {
    
        var querySuccess = function(){
            console.log('Deleted messages ' + p_mids.toString());
            deleteInboxElements(p_mids);
        }
        
        var queryError = function(p_error){
            console.log("deleteLocalMessages: Error processing SQL: " + p_error.message);
        }
        
        var executeQuery = function(tx){
            tx.executeSql('DELETE FROM INBOX_MESSAGES_2 WHERE id in (' + p_mids.toString() + ')');
            //querySuccess();
        }
        
        _DB.transaction(executeQuery, queryError, querySuccess);
    }
}

/**
 * Elimina i messaggi selezionati in modalità modifica
 */
function inboxDeleteMessages(){
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	var l_all_messages = [];
	
	for (var i = 0; i < l_messages.length; i++) {
		var l_mid = l_messages[i].id.substring(25);
		l_all_messages.push(l_mid);
	}
	
	if (l_all_messages.length > 0) {
        deleteLocalMessages(l_all_messages);
    }
	else {
        abutils.alert('Attenzione, non è stato selezionato nessun messaggio', 'Inbox');
    }
	
	/*
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
    var l_remote_messages = [];
    var l_all_messages = [];
    
    for (var i = 0; i < l_messages.length; i++) {
        var l_mid = l_messages[i].id.substring(25);
        if (_INBOX_MESSAGES[l_mid]) {
            l_all_messages.push(l_mid);
            
            if (!_INBOX_MESSAGES[l_mid].body) {
                l_remote_messages.push(l_mid);
            }
        }
    }
    
    // I messaggi non scaricati vengono segnalati come già letti
    if (l_remote_messages.length > 0) {
        markMessagesAsRead(l_remote_messages);
    }
    
    // Tutti i messaggi vengono eliminati dal database
    // (per evitare problemi dovuti alla sincronizzazione con chiamate remote si cerca di eliminare anche quelli che non sembrano essere stati scaricati)
    if (l_all_messages.length > 0) {
        deleteLocalMessages(l_all_messages);
    }
    else {
        alert('Attenzione, non è stato selezionato nessun messaggio');
    }
    */
}

/**
 * Elimina gli elementi html relativi ai messaggi
 * @params p_mids Lista degli identificativi dei messaggi che devono essere eliminati
 */
function deleteInboxElements(p_mids){
    var l_active_message = $('.inbox_list_container_box_active');
    if (l_active_message.length > 0) {
        var l_active_message_id = l_active_message[0].id.substring(25);
        
        if (jQuery.inArray(l_active_message_id, p_mids) != -1) {
            //$('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
        }
    }
    $('.inbox_list_container_box.inbox_list_container_box_selected').remove();
}

/**
 * Elimina il messaggio aperto
 */
function inboxDeleteOpenedMessage(){
	navigator.notification.confirm('Il messaggio verrà cancellato.\nSei sicuro?', function(button){
        if (button == 1) {
            var l_active_message = $('.inbox_list_container_box_active');
		    if (l_active_message.length > 0) {
		        var l_active_message_id = l_active_message[0].id.substring(25);
		        
		        if (_INBOX_MESSAGES['mid_' + l_active_message_id]) {
		        	/*
		            if (!_INBOX_MESSAGES[l_active_message_id].body) {
		                markMessagesAsRead([l_active_message_id]);
		            }
		            */
		            deleteLocalMessages([l_active_message_id]);
		        }
		        
		        //$('#inbox_msg_container').css('display', 'none');
				inboxCloseMsgView();
		        l_active_message.remove();
		    }
        }
    }, 'Cancellazione messaggio', 'Si,No');
}


(function() {
	var
		_HAS_TOUCH = 'ontouchstart' in window,
		_START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown',
		_MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove',
		_END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup',
		_CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseout';
	
	var CoveerFlow = function(container, covers) {
		this._container = typeof container == 'object' ? container : document.getElementById(container);
		this._covers = covers;
		this._initialization();
		
	};
	
	CoveerFlow.prototype = {
		_startX: 0,
		_startY: 0,
		_moveX: 0,
		_moveY: 0,
		_galleryHeight: 0,
		_touching: false,
		_moved: false,
		_initialization: function() {
			try{
			this._current = 0;
			this._totals = this._covers.length;
			this._stepPercent = 30;//25;//15;
			this._currentSlidePaddingPercent = 50;//25;
			this._rotateAngle = 0;//65;
			this._loaded = 0;
			
			var gallery = document.createElement('div');
			this._container.appendChild(gallery);
			gallery.className = 'coveerflow';
			//gallery.style.visibility = 'hidden';
			console.log("gallery _ORIENTATION is "+_ORIENTATION);
			console.log("gallery "+parseInt(gallery.offsetHeight, 10)+","+parseInt((window.innerHeight/2)*90/100));
			var galleryHeight = null;
			var slideHeight = null;
			if (_ORIENTATION == 'V'){
				galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
				slideHeight = galleryHeight ;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());		
				slideHeight = galleryHeight ;
			}
			
			this._galleryHeight = galleryHeight;
			//slideHeight = galleryHeight ;//- 20;/*50/*AB150;*/
			
			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;
			
			
			console.log('gal1 galleryHeight ' + galleryHeight);
			console.log('gal1 slideHeight ' + slideHeight);
			console.log('gal1 _step ' + this._step);
			console.log('gal1 _currentSlidePadding ' + this._currentSlidePadding);
			
			
			for (var i = 0; i < this._totals; i++) {
				var coverdiv = document.createElement('div');
				gallery.appendChild(coverdiv);
				
				console.log('gal1 slideHeight ' + slideHeight);
				
				coverdiv.style.height = '100%';
				
				var coverimg = document.createElement('img');
				coverdiv.appendChild(coverimg);
				
				if (this._covers[i]['anteprima']) {
					var anteprimaimg = document.createElement('img');
					anteprimaimg.className = 'coveerflow_anteprima';
					coverdiv.appendChild(anteprimaimg);
					anteprimaimg.src = 'imgs/coveerflow_anteprima.png';
					anteprimaimg = null;
				}
				
				if (this._covers[i]['abbonati']) {
					var abbonatiimg = document.createElement('img');
					abbonatiimg.className = 'coveerflow_abbonati';
					coverdiv.appendChild(abbonatiimg);
					abbonatiimg.src = 'imgs/coveerflow_abbonati2.png';
					abbonatiimg = null;
				}
				
				
				coverimg = null;
				coverdiv = null;
			}
			
			gallery = null;
			
			this._bind(_START_EV);
			this._bind(_MOVE_EV);
			this._bind(_END_EV);
			this._bind(_CANCEL_EV);
			
			// parte aggiunta per evitare l'attesa dell'onload delle immagini
			this._display();
			var that = this;
			setTimeout(function() {
				that._setAnimation();
			}, 100);
			//alert('ok'+_ORIENTATION);
			}catch(exc){
				console.log(exc.message)
			}
		},
		_setAnimation: function() {
			var coverdivs = this._container.children[0].children;
			for (var i = 0; i < coverdivs.length; i++) {
				coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
			}
		},
		_display: function() {
			if (_ORIENTATION == 'V'){
				galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
				slideHeight = galleryHeight ;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());		
				slideHeight = galleryHeight ;
			}
			this._galleryHeight = galleryHeight;
			
			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;
			
			var galleryCenter = null;//600 / 2;
			if (_ORIENTATION == 'V'  ){
				galleryCenter = Math.round(window.innerWidth * 0.5);
			} else {
				galleryCenter = Math.round($('#edicola_prodotto_coverflow').width() * 0.5);
			}
			console.log("gallcent: "+galleryCenter);
			var coverdivs = this._container.children[0].children;
			
			//alert("children  "+this._container.children[0].children);
			
			for (var i = 0; i < this._totals; i++) {
				//var l_cover_width = parseInt(coverdivs[i].offsetWidth, 10);
				console.log("cover#"+i+" "+parseInt(window.innerWidth/2+10));
				var l_cover_width = null;
				if(_ORIENTATION == 'V'){
					l_cover_width = Math.round(window.innerWidth * 0.5);
					//alert(window.innerWidth);
				}else{
					l_cover_width = Math.round(window.innerWidth * 0.3);
				}
				$(coverdivs[i]).width(l_cover_width);
				
				this._step = $(coverdivs[i]).width() / 2;
				
				if (i < this._current) {
					// precedenti - sinistra
					var leftPos = parseInt(galleryCenter - (this._current * this._step) + (i * this._step) - (l_cover_width / 2) - this._currentSlidePadding, 10);
					coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
				} else {
					if (i == this._current) {
						// corrente - centrale
						var leftPos = galleryCenter - (l_cover_width / 2);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					} else {
						// successivi - destra
						var leftPos = parseInt(galleryCenter + ((i - this._current) * this._step) - (l_cover_width / 2) + this._currentSlidePadding, 0);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					}
					
					coverdivs[i].style.display = 'inline-block';
					coverdivs[i].children[0].src = this._covers[i]['src'];
				}
			}
			
			if (_ORIENTATION == 'V') {
				$('.coveerflow img').each(function(){
					var that = this;
					$(that).css('margin-top', Math.round((($('#edicola_prodotto').height() * 0.48) - $(that).height()) / 2));
					$(that).load(function(){
						$(that).css('margin-top', Math.round((($('#edicola_prodotto').height() * 0.48) - $(that).height()) / 2));
					});
				});
			} else {
				$('.coveerflow img').each(function(){
					var that = this;
					$(that).css('margin-top', Math.round(($('#centrale').height() - $(that).height()) / 2));
					$(that).load(function(){
						$(that).css('margin-top', Math.round(($('#centrale').height() - $(that).height()) / 2));
					});
				});
			}
		},
		_bind: function(type, element, bubble) {
			(element || this._container).addEventListener(type, this, !!bubble);
		},
		_unbind: function(type, element, bubble) {
			(element || this._container).removeEventListener(type, this, !!bubble);
		},
		handleEvent: function(e) {
			switch(e.type) {
				case _START_EV: 
					this._e_start(e); 
					break;
				case _MOVE_EV: 
					this._e_move(e);
					break;
				case _END_EV:
				case _CANCEL_EV: 
					this._e_end(e); 
					break;
			}
		},
		_e_start: function(e) {
			e.preventDefault();
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._startX = _e.clientX;
			this._startY = _e.clientY;
			this._touching = true;
			this._moved = false;
			/*
			this._bind(_MOVE_EV);
			this._bind(_END_EV);
			this._bind(_CANCEL_EV);
			this._unbind(_START_EV);
			*/
		},
		_e_move: function(e) {
			e.preventDefault();
			if (!this._touching) return;
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._moveX = _e.clientX;
			this._moveY = _e.clientY;
			this._moved = true;
		},
		_e_end: function(e) {
			e.preventDefault();
			if (!this._touching) return;
			
			if (!this._moved) {
				if (this._touching) {
					if (typeof this.on_tap != "undefined") {
						this.on_tap.call();
					}
				}
				return;
			}
			
			if (this._moveX - this._startX > 100)
				this._gotoPrev();
			else if (this._moveX - this._startX < -100)
				this._gotoNext();
			
			var that = this;
			setTimeout(function() {
				that._touching = false;
			}, 300);
			
                        
                        if (this.on_end){
                            this.on_end.call();
                        }
			/*
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
			*/
		},
		_gotoNext: function() {
			if (this._current + 1 >= this._totals) return;
			this._current++;
			this._display();
		},
		_gotoPrev: function() {
			if (this._current <= 0) return;
			this._current--;
			this._display();
		},
		destroy: function() {
			this._unbind(_START_EV);
			this._unbind(_START_EV);
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
		}
	}
	
	window.CoveerFlow = CoveerFlow;
})();
/**
 * @author ABertacco
 */
var _NIELSEN_BASE_URL = "http://secure-it.imrworldwide.com/cgi-bin/m?ci=ilsole-app&cg=0&si=";

var _AREE = {
	'ALTRO' 			: 'http%3A//sfogliatoremobile.ilsole24ore.com',
	'EDICOLA' 			: 'http%3A//sfogliatoremobile.ilsole24ore.com/edicola',
	'ARCHIVIO_PRODOTTI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/archivio_prodotti',
	'PREFERITI'			: 'http%3A//sfogliatoremobile.ilsole24ore.com/preferiti',
	'RICERCA'			: 'http%3A//sfogliatoremobile.ilsole24ore.com/ricerca',
	'INBOX'				: 'http%3A//sfogliatoremobile.ilsole24ore.com/inbox',
	'REGISTRAZIONE'		: 'http%3A//sfogliatoremobile.ilsole24ore.com/registrazione',
	'SFOGLIATORE'		: 'http%3A//sfogliatoremobile.ilsole24ore.com/sfogliatore'
}
 
 function nielsenCall(area) {
 try {
 	if (_AREE[area] == null) area = 'ALTRO';
 	document.getElementById('nielsen_wrapper').innerHTML = '';
	var img = document.createElement('img');
	document.getElementById('nielsen_wrapper').appendChild(img);
	$(img).load(function() {
		console.log('nielsen load ' + area);
	});
	$(img).error(function() {
		console.log('nielsen error ' + area);
	});
	img.src = _NIELSEN_BASE_URL + _AREE[area];
	img = null;
 } catch(exc) {
 	console.log('nielsen exception: ' + exc.message);
 }
 }
/**
 * @author ABertacco
 */
function omnitureTrackApp(pageName, channel) {
	try {
		
		//PhoneGap.exec("AppMeasurementCommand.trackApp", pageName, channel);
		//window.plugins.flipper24.trackApp(null, null, pageName, channel);
		console.log("omniture:: "+pageName+', '+channel);
		window.infodroid.track(null, null, pageName, channel);
		
	} catch (exc) {
		
		//alert("ERROR OMNI");
	}
	
}
/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	
	//PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();
		
	if ((id_shopping24 == null) || (id_itunes == null)) return;
	
	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in _IAP_REQ_QUEUE
	//var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	//PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null) 
				continue;
			console.log('OK ' + l_product.productIdentifier); 
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}
		
		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}
		
		return "OK";
	} catch(exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}	
	
	navigator.notification.loadingStart({
        'labelText': "Acquisto in corso...",
        'backgroundOpacity': 0.8,
        'strokeOpacity': 0.25,
        'strokeColor': "FFFFFF",
    });
	
	_APPSTORE_BUY_CALLBACK = callback;
	
	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({Success: false, Exception: { Name: 'ExpiredUserIdentityException', Description: 'Rinnovo useridentity pre-pagamento.'}}, function() {
			//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else 
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}




var checkboxHeight = "26";
var radioHeight = "26";

var GalaxyCheckboxStyle = {
	init: function() {
		var inputs = document.getElementsByTagName("input"), span = Array(), textnode, option, active;
		for(a = 0; a < inputs.length; a++) {
			if((inputs[a].type == "checkbox" || inputs[a].type == "radio") && inputs[a].className == "galaxy_style") {
				span[a] = document.createElement("span");
				span[a].className = inputs[a].type;

				if(inputs[a].checked == true) {
					if(inputs[a].type == "checkbox") {
						position = "0 -" + (checkboxHeight) + "px";
						span[a].style.backgroundPosition = position;
					} else {
						position = "0 -" + (radioHeight) + "px";
						span[a].style.backgroundPosition = position;
					}
				}
				inputs[a].parentNode.insertBefore(span[a], inputs[a]);
				inputs[a].onchange = GalaxyCheckboxStyle.clear;
				if(!inputs[a].getAttribute("disabled")) {
					if(_DEBUG_MODE){
						span[a].onmousedown = GalaxyCheckboxStyle.pushed;
						span[a].onmouseup = GalaxyCheckboxStyle.check;
					}else{
						span[a].ontouchstart = GalaxyCheckboxStyle.pushed;
						span[a].ontouchend = GalaxyCheckboxStyle.check;
					}
				} else {
					span[a].className = span[a].className += " disabled";
				}
			}
		}
		// verifico touch
		if(_DEBUG_MODE){
			document.onmouseup = GalaxyCheckboxStyle.clear;
		}else{
			document.ontouchend = GalaxyCheckboxStyle.clear;
		}
	},
	pushed: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "radio") {
			this.style.backgroundPosition = "0 -" + radioHeight + "px";
		}
	},
	check: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "checkbox") {
			this.style.backgroundPosition = "0 0";
			element.checked = false;
		} else {
			if(element.type == "checkbox") {
				this.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else {
				this.style.backgroundPosition = "0 -" + radioHeight + "px";
				group = this.nextSibling.name;
				inputs = document.getElementsByTagName("input");
				for(a = 0; a < inputs.length; a++) {
					if(inputs[a].name == group && inputs[a] != this.nextSibling) {
						inputs[a].previousSibling.style.backgroundPosition = "0 0";
					}
				}
			}
			element.checked = true;
		}
	},
	clear: function() {
		inputs = document.getElementsByTagName("input");
		for(var b = 0; b < inputs.length; b++) {
			if(inputs[b].type == "checkbox" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else if(inputs[b].type == "checkbox" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			} else if(inputs[b].type == "radio" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + radioHeight + "px";
			} else if(inputs[b].type == "radio" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			}
		}
	}
}

(function() {
  var iOSCheckbox;
  iOSCheckbox = (function() {
    function iOSCheckbox(elem, options) {
      var key, opts, value;
      this.elem = $(elem);
      opts = $.extend({}, iOSCheckbox.defaults, options);
      for (key in opts) {
        value = opts[key];
        this[key] = value;
      }
      this.wrapCheckboxWithDivs();
      this.attachEvents();
      this.disableTextSelection();
      if (this.resizeHandle) {
        this.optionallyResize('handle');
      }
      if (this.resizeContainer) {
        this.optionallyResize('container');
      }
      this.initialPosition();
    }
    iOSCheckbox.prototype.isDisabled = function() {
      return this.elem.is(':disabled');
    };
    iOSCheckbox.prototype.wrapCheckboxWithDivs = function() {
      this.elem.wrap("<div class='" + this.containerClass + "' />");
      this.container = this.elem.parent();
      this.offLabel = $("<label style=\"width:40px;\" class='" + this.labelOffClass + "'>\n  <span>" + this.uncheckedLabel + "</span>\n</label>").appendTo(this.container);
      this.offSpan = this.offLabel.children('span');
      this.onLabel = $("<label style=\"width: 40px;\" class='" + this.labelOnClass + "'>\n  <span>" + this.checkedLabel + "</span>\n</label>").appendTo(this.container);
      this.onSpan = this.onLabel.children('span');
      return this.handle = $("<div class='" + this.handleClass + "'>\n  <div class='" + this.handleRightClass + "'>\n    <div class='" + this.handleCenterClass + "' />\n  </div>\n</div>").appendTo(this.container);
    };
    iOSCheckbox.prototype.disableTextSelection = function() {
      if ($.browser.msie) {
        return $([this.handle, this.offLabel, this.onLabel, this.container]).attr("unselectable", "on");
      }
    };
    iOSCheckbox.prototype.optionallyResize = function(mode) {
      var newWidth, offLabelWidth, onLabelWidth;
      //onLabelWidth = this.onLabel.width();
      onLabelWidth = parseInt($(this.onLabel).css('width'));
      //offLabelWidth = this.offLabel.width();
      offLabelWidth = parseInt($(this.offLabel).css('width'));
      if (mode === "container") {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        //newWidth += this.handle.width() + this.handleMargin;
        newWidth += parseInt($(this.handle).css('width')) + this.handleMargin;
        return this.container.css({
          width: newWidth
        });
      } else {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        return this.handle.css({
          width: newWidth
        });
      }
    };
    iOSCheckbox.prototype.onMouseDown = function(event) {
      var x;
      event.preventDefault();
      if (this.isDisabled()) {
        return;
      }
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      iOSCheckbox.currentlyClicking = this.handle;
      iOSCheckbox.dragStartPosition = x;
      return iOSCheckbox.handleLeftOffset = parseInt(this.handle.css('left'), 10) || 0;
    };
    iOSCheckbox.prototype.onDragMove = function(event, x) {
      var newWidth, p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      p = (x + iOSCheckbox.handleLeftOffset - iOSCheckbox.dragStartPosition) / this.rightSide;
      if (p < 0) {
        p = 0;
      }
      if (p > 1) {
        p = 1;
      }
      newWidth = p * this.rightSide;
      this.handle.css({
        left: newWidth
      });
      this.onLabel.css({
        width: newWidth + this.handleRadius
      });
      this.offSpan.css({
        marginRight: -newWidth
      });
      return this.onSpan.css({
        marginLeft: -(1 - p) * this.rightSide
      });
    };
    iOSCheckbox.prototype.onDragEnd = function(event, x) {
      var p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      if (this.isDisabled()) {
        return;
      }
      if (iOSCheckbox.dragging) {
        p = (x - iOSCheckbox.dragStartPosition) / this.rightSide;
        this.elem.prop('checked', p >= 0.5);
      } else {
        this.elem.prop('checked', !this.elem.prop('checked'));
      }
      iOSCheckbox.currentlyClicking = null;
      iOSCheckbox.dragging = null;
      return this.elem.change();
    };
    iOSCheckbox.prototype.onChange = function() {
      var new_left;
      if (this.isDisabled()) {
        this.container.addClass(this.disabledClass);
        return false;
      } else {
        this.container.removeClass(this.disabledClass);
      }
      new_left = this.elem.prop('checked') ? this.rightSide : 0;
      this.handle.animate({
        left: new_left
      }, this.duration);
      this.onLabel.animate({
        width: new_left + this.handleRadius
      }, this.duration);
      this.offSpan.animate({
        marginRight: -new_left
      }, this.duration);
      return this.onSpan.animate({
        marginLeft: new_left - this.rightSide
      }, this.duration);
    };
    iOSCheckbox.prototype.attachEvents = function() {
      var localMouseMove, localMouseUp, self;
      self = this;
      localMouseMove = function(event) {
        return self.onGlobalMove.apply(self, arguments);
      };
      localMouseUp = function(event) {
        self.onGlobalUp.apply(self, arguments);
        $(document).unbind('mousemove touchmove', localMouseMove);
        return $(document).unbind('mouseup touchend', localMouseUp);
      };
      this.container.bind('mousedown touchstart', function(event) {
        self.onMouseDown.apply(self, arguments);
        $(document).bind('mousemove touchmove', localMouseMove);
        return $(document).bind('mouseup touchend', localMouseUp);
      });
      return this.elem.bind("change", function() {
        return self.onChange.apply(self, arguments);
      });
    };
    iOSCheckbox.prototype.initialPosition = function() {
      var offset;
      this.offLabel.css({
        //width: this.container.width() - this.containerRadius
        width: parseInt($(this.container).css('width')) - this.containerRadius
      });
      offset = this.containerRadius + 1;
      if ($.browser.msie && $.browser.version < 7) {
        offset -= 3;
      }
      //this.rightSide = this.container.width() - this.handle.width() - offset;
      this.rightSide = parseInt($(this.container).css('width')) - parseInt($(this.handle).css('width')) - offset;
      if (this.elem.is(':checked')) {
        this.handle.css({
          left: this.rightSide
        });
        this.onLabel.css({
          width: this.rightSide + this.handleRadius
        });
        this.offSpan.css({
          marginRight: -this.rightSide
        });
      } else {
        this.onLabel.css({
          width: 0
        });
        this.onSpan.css({
          marginLeft: -this.rightSide
        });
      }
      if (this.isDisabled()) {
        return this.container.addClass(this.disabledClass);
      }
    };
    iOSCheckbox.prototype.onGlobalMove = function(event) {
      var x;
      if (!(!this.isDisabled() && iOSCheckbox.currentlyClicking)) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      if (!iOSCheckbox.dragging && (Math.abs(iOSCheckbox.dragStartPosition - x) > this.dragThreshold)) {
        iOSCheckbox.dragging = true;
      }
      return this.onDragMove(event, x);
    };
    iOSCheckbox.prototype.onGlobalUp = function(event) {
      var x;
      if (!iOSCheckbox.currentlyClicking) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      return this.onDragEnd(event, x);
    };
    iOSCheckbox.defaults = {
      duration: 200,
      checkedLabel: 'ON',
      uncheckedLabel: 'OFF',
      resizeHandle: true,
      resizeContainer: true,
      disabledClass: 'iPhoneCheckDisabled',
      containerClass: 'iPhoneCheckContainer',
      labelOnClass: 'iPhoneCheckLabelOn',
      labelOffClass: 'iPhoneCheckLabelOff',
      handleClass: 'iPhoneCheckHandle',
      handleCenterClass: 'iPhoneCheckHandleCenter',
      handleRightClass: 'iPhoneCheckHandleRight',
      dragThreshold: 5,
      handleMargin: 15,
      handleRadius: 4,
      containerRadius: 5
    };
    return iOSCheckbox;
  })();
  $.iphoneStyle = this.iOSCheckbox = iOSCheckbox;
  $.fn.iphoneStyle = function(options) {
    var checkbox, _i, _len, _ref;
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iphoneStyle", new iOSCheckbox(checkbox, options));
    }
    return this;
  };
  $.fn.iOSCheckbox = function(options) {
    var checkbox, opts, _i, _len, _ref;
    if (options == null) {
      options = {};
    }
    opts = $.extend({}, options, {
      resizeHandle: false,
      disabledClass: 'iOSCheckDisabled',
      containerClass: 'iOSCheckContainer',
      labelOnClass: 'iOSCheckLabelOn',
      labelOffClass: 'iOSCheckLabelOff',
      handleClass: 'iOSCheckHandle',
      handleCenterClass: 'iOSCheckHandleCenter',
      handleRightClass: 'iOSCheckHandleRight'
    });
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iOSCheckbox", new iOSCheckbox(checkbox, opts));
    }
    return this;
  };
}).call(this);


(function(E,a){var j=a.document;function A(Q){var Z=j.createElement("div");j.body.insertBefore(Z,null);E.replaceWith(Z,'<script type="text/javascript">'+Q+"<\/script>")}E=E||(function(Q){return{ajax:Q.ajax,$:function(Z){return Q(Z)[0]},replaceWith:function(Z,ad){var ac=Q(Z)[0];var ab=ac.nextSibling,aa=ac.parentNode;Q(ac).remove();if(ab){Q(ab).before(ad)}else{Q(aa).append(ad)}},onLoad:function(Z){Q(Z)},copyAttrs:function(af,ab){var ad=Q(ab),aa=af.attributes;for(var ac=0,Z=aa.length;ac<Z;ac++){if(aa[ac]&&aa[ac].value){try{ad.attr(aa[ac].name,aa[ac].value)}catch(ae){}}}}}})(a.jQuery);E.copyAttrs=E.copyAttrs||function(){};E.onLoad=E.onLoad||function(){throw"error: autoAsync cannot be used without jQuery or defining writeCaptureSupport.onLoad"};function P(ab,aa){for(var Z=0,Q=ab.length;Z<Q;Z++){if(aa(ab[Z])===false){return}}}function v(Q){return Object.prototype.toString.call(Q)==="[object Function]"}function p(Q){return Object.prototype.toString.call(Q)==="[object String]"}function u(aa,Z,Q){return Array.prototype.slice.call(aa,Z||0,Q||aa&&aa.length)}function D(ab,aa){var Q=false;P(ab,Z);function Z(ac){return !(Q=aa(ac))}return Q}function L(Q){this._queue=[];this._children=[];this._parent=Q;if(Q){Q._addChild(this)}}L.prototype={_addChild:function(Q){this._children.push(Q)},push:function(Q){this._queue.push(Q);this._bubble("_doRun")},pause:function(){this._bubble("_doPause")},resume:function(){this._bubble("_doResume")},_bubble:function(Z){var Q=this;while(!Q[Z]){Q=Q._parent}return Q[Z]()},_next:function(){if(D(this._children,Q)){return true}function Q(aa){return aa._next()}var Z=this._queue.shift();if(Z){Z()}return !!Z}};function i(Q){if(Q){return new L(Q)}L.call(this);this.paused=0}i.prototype=(function(){function Q(){}Q.prototype=L.prototype;return new Q()})();i.prototype._doRun=function(){if(!this.running){this.running=true;try{while(this.paused<1&&this._next()){}}finally{this.running=false}}};i.prototype._doPause=function(){this.paused++};i.prototype._doResume=function(){this.paused--;this._doRun()};function M(){}M.prototype={_html:"",open:function(){this._opened=true;if(this._delegate){this._delegate.open()}},write:function(Q){if(this._closed){return}this._written=true;if(this._delegate){this._delegate.write(Q)}else{this._html+=Q}},writeln:function(Q){this.write(Q+"\n")},close:function(){this._closed=true;if(this._delegate){this._delegate.close()}},copyTo:function(Q){this._delegate=Q;Q.foobar=true;if(this._opened){Q.open()}if(this._written){Q.write(this._html)}if(this._closed){Q.close()}}};var e=(function(){var Q={f:j.getElementById};try{Q.f.call(j,"abc");return true}catch(Z){return false}})();function I(Q){P(Q,function(Z){var aa=j.getElementById(Z.id);if(!aa){l("<proxyGetElementById - finish>","no element in writen markup with id "+Z.id);return}P(Z.el.childNodes,function(ab){aa.appendChild(ab)});if(aa.contentWindow){a.setTimeout(function(){Z.el.contentWindow.document.copyTo(aa.contentWindow.document)},1)}E.copyAttrs(Z.el,aa)})}function s(Z,Q){if(Q&&Q[Z]===false){return false}return Q&&Q[Z]||o[Z]}function x(Z,ai){var ae=[],ad=s("proxyGetElementById",ai),ag=s("writeOnGetElementById",ai),Q={write:j.write,writeln:j.writeln,finish:function(){},out:""};Z.state=Q;j.write=ah;j.writeln=aa;if(ad||ag){Q.getEl=j.getElementById;j.getElementById=ab;if(ag){findEl=af}else{findEl=ac;Q.finish=function(){I(ae)}}}function ah(aj){Q.out+=aj}function aa(aj){Q.out+=aj+"\n"}function ac(ak){var aj=j.createElement("div");ae.push({id:ak,el:aj});aj.contentWindow={document:new M()};return aj}function af(al){var aj=E.$(Z.target);var ak=j.createElement("div");aj.parentNode.insertBefore(ak,aj);E.replaceWith(ak,Q.out);Q.out="";return e?Q.getEl.call(j,al):Q.getEl(al)}function ab(ak){var aj=e?Q.getEl.call(j,ak):Q.getEl(ak);return aj||findEl(ak)}return Q}function V(Q){j.write=Q.write;j.writeln=Q.writeln;if(Q.getEl){j.getElementById=Q.getEl}return Q.out}function N(Q){return Q&&Q.replace(/^\s*<!(\[CDATA\[|--)/,"").replace(/(\]\]|--)>\s*$/,"")}function b(){}function d(Z,Q){console.error("Error",Q,"executing code:",Z)}var l=v(a.console&&console.error)?d:b;function S(aa,Z,Q){var ab=x(Z,Q);try{A(N(aa))}catch(ac){l(aa,ac)}finally{V(ab)}return ab}function O(Z){var Q=/^(\w+:)?\/\/([^\/?#]+)/.exec(Z);return Q&&(Q[1]&&Q[1]!=location.protocol||Q[2]!=location.host)}function T(Q){return new RegExp(Q+"=(?:([\"'])([\\s\\S]*?)\\1|([^\\s>]+))","i")}function k(Q){var Z=T(Q);return function(aa){var ab=Z.exec(aa)||[];return ab[2]||ab[3]}}var r=/(<script[\s\S]*?>)([\s\S]*?)<\/script>/ig,n=T("src"),X=k("src"),q=k("type"),Y=k("language"),C="__document_write_ajax_callbacks__",B="__document_write_ajax_div-",g="window['"+C+"']['%d']();",m=a[C]={},w='<script type="text/javascript">'+g+"<\/script>",H=0;function c(){return(++H).toString()}function G(Z,aa){var Q;if(v(Z)){Q=Z;Z=null}Z=Z||{};Q=Q||Z&&Z.done;Z.done=aa?function(){aa(Q)}:Q;return Z}var z=new i();var y=[];var f=window._debugWriteCapture?function(){}:function(Q,aa,Z){y.push({type:Q,src:aa,data:Z})};var K=window._debugWriteCapture?function(){}:function(){y.push(arguments)};function W(Q){var Z=c();m[Z]=function(){Q();delete m[Z]};return Z}function J(Q){return w.replace(/%d/,W(Q))}function R(ac,ag,aa,ae){var ad=aa&&new i(aa)||z;ag=G(ag);var ab=s("done",ag);var Q="";var Z=s("fixUrls",ag);if(!v(Z)){Z=function(ah){return ah}}if(v(ab)){Q=J(function(){ad.push(ab)})}return ac.replace(r,af)+Q;function af(aj,av,ai){var an=X(av),am=q(av)||"",aB=Y(av)||"",aA=(!am&&!aB)||am.toLowerCase().indexOf("javascript")!==-1||aB.toLowerCase().indexOf("javascript")!==-1;f("replace",an,aj);if(!aA){return aj}var aw=W(ap),ao=B+aw,au,al={target:"#"+ao,parent:ae};function ap(){ad.push(au)}if(an){an=Z(an);av=av.replace(n,"");if(O(an)){au=az}else{if(s("asyncAll",ag)){au=ay()}else{au=at}}}else{au=ax}function ax(){ah(ai)}function at(){E.ajax({url:an,type:"GET",dataType:"text",async:false,success:function(aC){ah(aC)}})}function ak(aE,aC,aD){l("<XHR for "+an+">",aD);ad.resume()}function aq(){return J(function(){ad.resume()})}function ay(){var aE,aD;function aC(aG,aF){if(!aE){aD=aG;return}try{ah(aG,aq())}catch(aH){l(aG,aH)}}E.ajax({url:an,type:"GET",dataType:"text",async:true,success:aC,error:ak});return function(){aE=true;if(aD){ah(aD)}else{ad.pause()}}}function az(aC){var aE=x(al,ag);ad.pause();f("pause",an);E.ajax({url:an,type:"GET",dataType:"script",success:aD,error:ak});function aD(aH,aG,aF){f("out",an,aE.out);ar(V(aE),J(aE.finish)+aq());f("resume",an)}}function ah(aD,aC){var aE=S(aD,al,ag);aC=J(aE.finish)+(aC||"");ar(aE.out,aC)}function ar(aD,aC){E.replaceWith(al.target,R(aD,null,ad,al)+(aC||""))}return'<div style="display: none" id="'+ao+'"></div>'+av+g.replace(/%d/,aw)+"<\/script>"}}function F(Z,aa){var Q=z;P(Z,function(ab){Q.push(ac);function ac(){ab.action(R(ab.html,ab.options,Q),ab)}});if(aa){Q.push(aa)}}function U(Q){var Z=Q;while(Z&&Z.nodeType===1){Q=Z;Z=Z.lastChild;while(Z&&Z.nodeType!==1){Z=Z.previousSibling}}return Q}function h(Q){var aa=j.write,ad=j.writeln,Z,ab=[];j.writeln=function(ae){j.write(ae+"\n")};var ac;j.write=function(af){var ae=U(j.body);if(ae!==Z){Z=ae;ab.push(ac={el:ae,out:[]})}ac.out.push(af)};E.onLoad(function(){var ah,ak,af,aj,ai;Q=G(Q);ai=Q.done;Q.done=function(){j.write=aa;j.writeln=ad;if(ai){ai()}};for(var ag=0,ae=ab.length;ag<ae;ag++){ah=ab[ag].el;ak=j.createElement("div");ah.parentNode.insertBefore(ak,ah.nextSibling);af=ab[ag].out.join("");aj=ae-ag===1?R(af,Q):R(af);E.replaceWith(ak,aj)}})}var t="writeCapture";var o=a[t]={_original:a[t],fixUrls:function(Q){return Q.replace(/&amp;/g,"&")},noConflict:function(){a[t]=this._original;return this},debug:y,proxyGetElementById:false,_forTest:{Q:i,GLOBAL_Q:z,$:E,matchAttr:k,slice:u,capture:x,uncapture:V,captureWrite:S},replaceWith:function(Q,aa,Z){E.replaceWith(Q,R(aa,Z))},html:function(Q,ab,Z){var aa=E.$(Q);aa.innerHTML="<span/>";E.replaceWith(aa.firstChild,R(ab,Z))},load:function(Q,aa,Z){E.ajax({url:aa,dataType:"text",type:"GET",success:function(ab){o.html(Q,ab,Z)}})},autoAsync:h,sanitize:R,sanitizeSerial:F}})(this.writeCaptureSupport,this);(function(g,d,n){var c={html:h};g.each(["append","prepend","after","before","wrap","wrapAll","replaceWith","wrapInner"],function(){c[this]=i(this)});function a(q){return Object.prototype.toString.call(q)=="[object String]"}function p(u,t,s,r){if(arguments.length==0){return o.call(this)}var q=c[u];if(u=="load"){return l.call(this,t,s,r)}if(!q){j(u)}return b.call(this,t,s,q)}g.fn.writeCapture=p;var k="__writeCaptureJsProxied-fghebd__";function o(){if(this[k]){return this}var r=this;function q(){var t=this,s=false;this[k]=true;g.each(c,function(v){var u=r[v];if(!u){return}t[v]=function(y,x,w){if(!s&&a(y)){try{s=true;return p.call(t,v,y,x,w)}finally{s=false}}return u.apply(t,arguments)}});this.pushStack=function(){return o.call(r.pushStack.apply(t,arguments))};this.endCapture=function(){return r}}q.prototype=r;return new q()}function b(t,s,u){var q,r=this;if(s&&s.done){q=s.done;delete s.done}else{if(g.isFunction(s)){q=s;s=null}}d.sanitizeSerial(g.map(this,function(v){return{html:t,options:s,action:function(w){u.call(v,w)}}}),q&&function(){q.call(r)}||q);return this}function h(q){g(this).html(q)}function i(q){return function(r){g(this)[q](r)}}function l(t,s,v){var r=this,q,u=t.indexOf(" ");if(u>=0){q=t.slice(u,t.length);t=t.slice(0,u)}if(g.isFunction(v)){s=s||{};s.done=v}return g.ajax({url:t,type:s&&s.type||"GET",dataType:"html",data:s&&s.params,complete:f(r,s,q)})}function f(r,s,q){return function(u,t){if(t=="success"||t=="notmodified"){var v=m(u.responseText,q);b.call(r,v,s,h)}}}var e=/jquery-writeCapture-script-placeholder-(\d+)-wc/g;function m(s,r){if(!r||!s){return s}var t=0,q={};return g("<div/>").append(s.replace(/<script(.|\s)*?\/script>/g,function(u){q[t]=u;return"jquery-writeCapture-script-placeholder-"+(t++)+"-wc"})).find(r).html().replace(e,function(u,v){return q[v]})}function j(q){throw"invalid method parameter "+q}g.writeCapture=d})(jQuery,writeCapture.noConflict());

(function(b){function s(B,h,y){var z=this,D=y,A,C,m,x=false;this.settings=D;this.values=null;this.val=null;this.temp=null;this.setDefaults=function(E){b.extend(f,E)};this.enable=function(){D.disabled=false;if(b(B).is(":input")){b(B).prop("disabled",false)}};this.disable=function(){D.disabled=true;if(b(B).is(":input")){b(B).prop("disabled",true)}};this.formatDate=function(N,F,G){if(!F){return null}var O=b.extend({},this.settings,G),L=function(P){var Q=0;while(J+1<N.length&&N.charAt(J+1)==P){Q++;J++}return Q},I=function(Q,R,P){var S=""+R;if(L(Q)){while(S.length<P){S="0"+S}}return S},H=function(P,S,R,Q){return(L(P)?Q[S]:R[S])},E="",M=false;for(var J=0;J<N.length;J++){if(M){if(N.charAt(J)=="'"&&!L("'")){M=false}else{E+=N.charAt(J)}}else{switch(N.charAt(J)){case"d":E+=I("d",F.getDate(),2);break;case"D":E+=H("D",F.getDay(),O.dayNamesShort,O.dayNames);break;case"o":E+=I("o",(F.getTime()-new Date(F.getFullYear(),0,0).getTime())/86400000,3);break;case"m":E+=I("m",F.getMonth()+1,2);break;case"M":E+=H("M",F.getMonth(),O.monthNamesShort,O.monthNames);break;case"y":E+=(L("y")?F.getFullYear():(F.getYear()%100<10?"0":"")+F.getYear()%100);break;case"h":var K=F.getHours();E+=I("h",(K>12?(K-12):(K==0?12:K)),2);break;case"H":E+=I("H",F.getHours(),2);break;case"i":E+=I("i",F.getMinutes(),2);break;case"s":E+=I("s",F.getSeconds(),2);break;case"a":E+=F.getHours()>11?"pm":"am";break;case"A":E+=F.getHours()>11?"PM":"AM";break;case"'":if(L("'")){E+="'"}else{M=true}break;default:E+=N.charAt(J)}}}return E};this.parseDate=function(U,N,W){var I=new Date();if(!U||!N){return I}N=(typeof N=="object"?N.toString():N+"");var K=b.extend({},this.settings,W),F=I.getFullYear(),Y=I.getMonth(),S=I.getDate(),H=-1,V=I.getHours(),O=I.getMinutes(),G=I.getSeconds(),L=0,R=false,M=function(aa){var ab=(E+1<U.length&&U.charAt(E+1)==aa);if(ab){E++}return ab},Z=function(ab){M(ab);var ac=(ab=="@"?14:(ab=="!"?20:(ab=="y"?4:(ab=="o"?3:2))));var ad=new RegExp("^\\d{1,"+ac+"}");var aa=N.substr(T).match(ad);if(!aa){throw"Missing number at position "+T}T+=aa[0].length;return parseInt(aa[0],10)},J=function(ab,ad,aa){var ae=(M(ab)?aa:ad);for(var ac=0;ac<ae.length;ac++){if(N.substr(T,ae[ac].length).toLowerCase()==ae[ac].toLowerCase()){T+=ae[ac].length;return ac+1}}throw"Unknown name at position "+T},Q=function(){if(N.charAt(T)!=U.charAt(E)){throw"Unexpected literal at position "+T}T++},T=0;for(var E=0;E<U.length;E++){if(R){if(U.charAt(E)=="'"&&!M("'")){R=false}else{Q()}}else{switch(U.charAt(E)){case"d":S=Z("d");break;case"D":J("D",K.dayNamesShort,K.dayNames);break;case"o":H=Z("o");break;case"m":Y=Z("m");break;case"M":Y=J("M",K.monthNamesShort,K.monthNames);break;case"y":F=Z("y");break;case"H":V=Z("H");break;case"h":V=Z("h");break;case"i":O=Z("i");break;case"s":G=Z("s");break;case"a":L=J("a",["am","pm"],["am","pm"])-1;break;case"A":L=J("A",["am","pm"],["am","pm"])-1;break;case"'":if(M("'")){Q()}else{R=true}break;default:Q()}}}if(F<100){F+=new Date().getFullYear()-new Date().getFullYear()%100+(F<=K.shortYearCutoff?0:-100)}if(H>-1){Y=1;S=H;do{var P=32-new Date(F,Y-1,32).getDate();if(S<=P){break}Y++;S-=P}while(true)}if(L&&V<12){V+=12}var X=new Date(F,Y-1,S,V,O,G);if(X.getFullYear()!=F||X.getMonth()+1!=Y||X.getDate()!=S){throw"Invalid date"}return X};this.setValue=function(F){if(F==undefined){F=true}var E=this.formatResult();this.val=E;this.values=this.temp.slice(0);if(F&&b(B).is(":input")){b(B).val(E).change()}};this.getDate=function(){var F=this.values;if(D.preset=="date"){return new Date(F[A],F[C],F[m])}if(D.preset=="time"){var E=(D.ampm&&F[D.seconds?3:2]=="PM"&&(F[0]-0)<12)?(F[0]-0+12):F[0];return new Date(1970,0,1,E,F[1],D.seconds?F[2]:null)}if(D.preset=="datetime"){var E=(D.ampm&&F[D.seconds?6:5]=="PM"&&(F[3]-0)<12)?(F[3]-0+12):F[3];return new Date(F[A],F[C],F[m],E,F[4],D.seconds?F[5]:null)}};this.setDate=function(G,F){if(D.preset.match(/date/i)){this.temp[A]=G.getFullYear();this.temp[C]=G.getMonth();this.temp[m]=G.getDate()}if(D.preset=="time"){var E=G.getHours();this.temp[0]=(D.ampm)?(E>12?(E-12):(E==0?12:E)):E;this.temp[1]=G.getMinutes();if(D.seconds){this.temp[2]=G.getSeconds()}if(D.ampm){this.temp[D.seconds?3:2]=E>11?"PM":"AM"}}if(D.preset=="datetime"){var E=G.getHours();this.temp[3]=(D.ampm)?(E>12?(E-12):(E==0?12:E)):E;this.temp[4]=G.getMinutes();if(D.seconds){this.temp[5]=G.getSeconds()}if(D.ampm){this.temp[D.seconds?6:5]=E>11?"PM":"AM"}}this.setValue(F)};this.parseValue=function(I){if(this.preset){var E=[];if(D.preset=="date"){try{var H=this.parseDate(D.dateFormat,I,D)}catch(G){var H=new Date()}E[A]=H.getFullYear();E[C]=H.getMonth();E[m]=H.getDate()}else{if(D.preset=="time"){try{var H=this.parseDate(D.timeFormat,I,D)}catch(G){var H=new Date()}var F=H.getHours();E[0]=(D.ampm)?(F>12?(F-12):(F==0?12:F)):F;E[1]=H.getMinutes();if(D.seconds){E[2]=H.getSeconds()}if(D.ampm){E[D.seconds?3:2]=F>11?"PM":"AM"}}else{if(D.preset=="datetime"){try{var H=this.parseDate(D.dateFormat+" "+D.timeFormat,I,D)}catch(G){var H=new Date()}var F=H.getHours();E[A]=H.getFullYear();E[C]=H.getMonth();E[m]=H.getDate();E[3]=(D.ampm)?(F>12?(F-12):(F==0?12:F)):F;E[4]=H.getMinutes();if(D.seconds){E[5]=H.getSeconds()}if(D.ampm){E[D.seconds?6:5]=F>11?"PM":"AM"}}}}return E}return D.parseValue(I)};this.formatResult=function(){var F=this.temp;if(this.preset){if(D.preset=="date"){return this.formatDate(D.dateFormat,new Date(F[A],F[C],F[m]),D)}else{if(D.preset=="datetime"){var E=(D.ampm)?((F[D.seconds?6:5]=="PM"&&(F[3]-0)<12)?(F[3]-0+12):(F[D.seconds?6:5]=="AM"&&(F[3]==12)?0:F[3])):F[3];return this.formatDate(D.dateFormat+" "+D.timeFormat,new Date(F[A],F[C],F[m],E,F[4],D.seconds?F[5]:null),D)}else{if(D.preset=="time"){var E=(D.ampm)?((F[D.seconds?3:2]=="PM"&&(F[0]-0)<12)?(F[0]-0+12):(F[D.seconds?3:2]=="AM"&&(F[0]==12)?0:F[0])):F[0];return this.formatDate(D.timeFormat,new Date(1970,0,1,E,F[1],D.seconds?F[2]:null),D)}}}}return D.formatResult(F)};this.validate=function(F){if(this.preset&&D.preset.match(/date/i)&&((F==A)||(F==C)||(F==-1))){var G=32-new Date(this.temp[A],this.temp[C],32).getDate()-1;var E=b("ul:eq("+m+")",h);b("li",E).show();b("li:gt("+G+")",E).hide();if(this.temp[m]>G){E.addClass("dwa").css("top",(r*(n-G-1))+"px");this.temp[m]=b("li:eq("+G+")",E).data("val")}}else{D.validate(F)}};this.hide=function(){if(D.onClose(this.val,this)===false){return false}b(".dwtd").prop("disabled",false).removeClass("dwtd");b(B).blur();h.hide();i.hide();x=false;if(this.preset){D.wheels=null}b(window).unbind("resize.dw")};this.show=function(){if(D.disabled||x){return false}D.beforeShow(B,this);r=D.height;n=Math.round(D.rows/2);a=this;this.init();if(this.preset){D.wheels=new Array();if(D.preset.match(/date/i)){var E={};for(var G=0;G<3;G++){if(G==A){E[D.yearText]={};for(var J=D.startYear;J<=D.endYear;J++){E[D.yearText][J]=D.dateOrder.search(/yy/i)<0?J.toString().substr(2,2):J.toString()}}else{if(G==C){E[D.monthText]={};for(var J=0;J<12;J++){E[D.monthText][J]=(D.dateOrder.search(/MM/)<0?(D.dateOrder.search(/M/)<0?(D.dateOrder.search(/mm/)<0?(J+1):(J<9)?("0"+(J+1)):(J+1)):D.monthNamesShort[J]):D.monthNames[J])}}else{if(G==m){E[D.dayText]={};for(var J=1;J<32;J++){E[D.dayText][J]=D.dateOrder.search(/dd/i)<0?J:(J<10)?("0"+J):J}}}}}D.wheels.push(E)}if(D.preset.match(/time/i)){D.stepHour=(D.stepHour<1)?1:parseInt(D.stepHour);D.stepMinute=(D.stepMinute<1)?1:parseInt(D.stepMinute);D.stepSecond=(D.stepSecond<1)?1:parseInt(D.stepSecond);var E={};E[D.hourText]={};for(var J=0;J<(D.ampm?13:24);J+=D.stepHour){E[D.hourText][J]=(J<10)?("0"+J):J}E[D.minuteText]={};for(var J=0;J<60;J+=D.stepMinute){E[D.minuteText][J]=(J<10)?("0"+J):J}if(D.seconds){E[D.secText]={};for(var J=0;J<60;J+=D.stepSecond){E[D.secText][J]=(J<10)?("0"+J):J}}if(D.ampm){E[D.ampmText]={};E[D.ampmText]["AM"]="AM";E[D.ampmText]["PM"]="PM"}D.wheels.push(E)}}b(".dwc",h).remove();for(var J=0;J<D.wheels.length;J++){var F=b('<div class="dwc'+(D.mode=="clickpick"?" dwpm":"")+'"><div class="dwwc dwrc"><div class="clear" style="clear:both;"></div></div>').insertBefore(b(".dwbc",h));for(var I in D.wheels[J]){var K=b(".dwwc .clear",F);var E=b('<div class="dwwl dwrc">'+(D.mode=="clickpick"?'<div class="dwwb dwwbp">+</div><div class="dwwb dwwbm">&ndash;</div>':"")+'<div class="dwl">'+I+'</div><div class="dww dwrc"><ul></ul><div class="dwwo"></div></div><div class="dwwol"></div></div>').insertBefore(K);for(var H in D.wheels[J][I]){b('<li class="val_'+H+'">'+D.wheels[J][I][H]+"</li>").data("val",H).appendTo(b("ul",E))}}}b(".dww ul",h).each(function(M){var L=b("li",this).index(b("li.val_"+z.temp[M],this));while((L<0)&&(--z.temp[M]>=0)){L=b("li",this).index(b("li.val_"+z.temp[M],this))}var N=r*(n-(L<0?0:L)-1);b(this).css("top",N)});b(".dwv",h).html(this.formatResult());z.validate(-1);b("#dw_set",h).text(D.setText).unbind().bind("click",function(L){z.setValue();D.onSelect(z.val,a);z.hide();return false});b("#dw_cancel",h).text(D.cancelText).unbind().bind("click",function(L){D.onCancel(z.val,a);z.hide();return false});b(":input:not(:disabled)").addClass("dwtd");b(":input").prop("disabled",true);i.show();h.attr("class","dw "+D.theme).show();x=true;b(".dww, .dwwl",h).height(D.rows*r);b(".dww",h).each(function(){b(this).width(b(this).parent().width()<D.width?D.width:b(this).parent().width())});b(".dwbc a",h).attr("class",D.btnClass);b(".dww li, .dwwb",h).css({height:r,lineHeight:r+"px"});b(".dwwc",h).each(function(){var L=0;b(".dwwl",this).each(function(){L+=b(this).outerWidth(true)});b(this).width(L)});b(".dwc",h).each(function(){b(this).width(b(".dwwc",this).outerWidth(true))});this.pos();b(window).bind("resize.dw",function(){z.pos()})};this.pos=function(){var E=0,H=0,K=b(window).width(),G=b(window).height(),I=b(window).scrollTop(),F,J;b(".dwc",h).each(function(){F=b(this).outerWidth(true);E+=F;H=(F>H)?F:H});F=E>K?H:E;h.width(F);F=h.outerWidth();J=h.outerHeight();h.css({left:(K-F)/2,top:I+(G-J)/2});i.height(0);i.height(b(document).height())};this.init=function(){var E=D.dateOrder.search(/y/i),F=D.dateOrder.search(/m/i),G=D.dateOrder.search(/d/i);A=(E<F)?(E<G?0:1):(E<G?1:2);C=(F<E)?(F<G?0:1):(F<G?1:2);m=(G<E)?(G<F?0:1):(G<F?1:2);this.preset=(D.wheels===null);this.temp=this.parseValue(b(B).val()?b(B).val():"");this.setValue(false)};this.init();if(b(B).is(":input")&&D.showOnFocus){b(B).data("dwro",b(B).prop("readonly")).prop("readonly",true)}b(B).addClass("scroller").unbind("focus.dw").bind("focus.dw",function(E){if(D.showOnFocus){z.show()}})}var j,i,r,n,a,g={},v=new Date(),q=v.getTime(),l=false,w=null,c,o,d,e=("ontouchstart" in window),p=e?"touchstart":"mousedown",u=e?"touchmove":"mousemove",k=e?"touchend":"mouseup",f={width:90,height:40,rows:3,disabled:false,showOnFocus:true,wheels:null,theme:"",mode:"scroller",preset:"date",dateFormat:"mm/dd/yy",dateOrder:"mmddy",ampm:true,seconds:false,timeFormat:"hh:ii A",startYear:v.getFullYear()-10,endYear:v.getFullYear()+10,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortYearCutoff:"+10",monthText:"Month",dayText:"Day",yearText:"Year",hourText:"Hours",minuteText:"Minutes",secText:"Seconds",ampmText:"&nbsp;",setText:"Set",cancelText:"Cancel",btnClass:"dwb",stepHour:1,stepMinute:1,stepSecond:1,beforeShow:function(){},onClose:function(){},onSelect:function(){},onCancel:function(){},formatResult:function(x){var h="";for(var m=0;m<x.length;m++){h+=(m>0?" ":"")+x[m]}return h},parseValue:function(h){return h.split(" ")},validate:function(){return true}},t={init:function(y){if(y===undefined){y={}}var h={};if(y.theme=="ios"){h.dateOrder="MMdyy";h.rows=5;h.height=30;h.width=55}if(y.mode=="clickpick"){h.height=50;h.rows=3}var z=b.extend({},f,h,y),B=false,m=false;if(b(".dw").length){i=b(".dwo");j=b(".dw")}else{i=b('<div class="dwo"></div>').hide().appendTo("body");j=b('<div class="dw"><div class="dwv">&nbsp;</div><div class="dwbc" style="clear:both;"><span class="dwbw dwb-s"><a id="dw_set" href="#"></a></span><span class="dwbw dwb-c"><a id="dw_cancel" href="#"></a></span></div></div>');j.hide().appendTo("body");b(document).bind(u,function(D){if(l){o=e?D.originalEvent.changedTouches[0].pageY:D.pageY;w.removeClass("dwa").css("top",(d+o-c)+"px");D.preventDefault();D.stopPropagation();return false}});function x(F,G){var E=b("ul",j).index(F),D=b("li:visible",F).length;G=G>(n-1)?(n-1):G;G=G<(n-D)?(n-D):G;F.addClass("dwa").css("top",G*r);a.temp[E]=b("li:eq("+(n-1-G)+")",F).data("val");a.validate(E);b(".dwv",j).html(a.formatResult())}function C(D){if(B){var E=D.css("top").replace(/px/i,"")-0,F=(E-r)/r;F=F<(n-b("li:visible",D).length)?(n-1):F;x(D,F)}else{clearInterval(B)}}function A(D){if(m){var E=D.css("top").replace(/px/i,"")-0,F=(E+r)/r;F=F>(n-1)?(n-b("li:visible",D).length):F;x(D,F)}else{clearInterval(m)}}b(document).bind(k,function(D){if(l){var E=Math.round((d+o-c)/r);x(w,E);l=false;w=null;D.preventDefault();D.stopPropagation()}clearInterval(B);clearInterval(m);B=false;m=false;b(".dwb-a").removeClass("dwb-a")});j.delegate(".dwwl","DOMMouseScroll mousewheel",function(F){var H=F.wheelDelta?(F.wheelDelta/120):(F.detail?(-F.detail/3):0),D=b("ul",this),E=D.css("top").replace(/px/i,"")-0,G=Math.round((E+H*r)/r);x(D,G);F.preventDefault();F.stopPropagation()}).delegate(".dwb, .dwwb",p,function(D){b(this).addClass("dwb-a")}).delegate(".dwwbp",p,function(E){E.preventDefault();var D=b(this).closest(".dwwl").find("ul");clearInterval(B);B=setInterval(function(){C(D)},200);C(D)}).delegate(".dwwbm",p,function(E){E.preventDefault();var D=b(this).closest(".dwwl").find("ul");clearInterval(m);m=setInterval(function(){A(D)},200);A(D)}).delegate(".dwwl",p,function(F){if(!l&&a.settings.mode=="scroller"){var E=e?F.originalEvent.changedTouches[0].pageX:F.pageX,D=b(this).offset().left;l=true;w=b("ul",this);d=w.css("top").replace(/px/i,"")-0;c=e?F.originalEvent.changedTouches[0].pageY:F.pageY;o=c;F.preventDefault();F.stopPropagation()}})}return this.each(function(){if(!this.id){q+=1;this.id="scoller"+q}g[this.id]=new s(this,j,z)})},enable:function(){return this.each(function(){if(g[this.id]){g[this.id].enable()}})},disable:function(){return this.each(function(){if(g[this.id]){g[this.id].disable()}})},isDisabled:function(){if(g[this[0].id]){return g[this[0].id].settings.disabled}},option:function(h,m){return this.each(function(){if(g[this.id]){if(typeof h==="object"){b.extend(g[this.id].settings,h)}else{g[this.id].settings[h]=m}g[this.id].init()}})},setValue:function(m,h){if(h==undefined){h=false}return this.each(function(){if(g[this.id]){g[this.id].temp=m;g[this.id].setValue(m,h)}})},getValue:function(){if(g[this[0].id]){return g[this[0].id].values}},setDate:function(m,h){if(h==undefined){h=false}return this.each(function(){if(g[this.id]){g[this.id].setDate(m,h)}})},getDate:function(){if(g[this[0].id]){return g[this[0].id].getDate()}},show:function(){if(g[this[0].id]){return g[this[0].id].show()}},hide:function(){return this.each(function(){if(g[this.id]){g[this.id].hide()}})},destroy:function(){return this.each(function(){if(g[this.id]){b(this).unbind("focus.dw").removeClass("scroller");if(b(this).is(":input")){b(this).prop("readonly",b(this).data("dwro"))}delete g[this.id]}})}};b.fn.scroller=function(h){if(t[h]){return t[h].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof h==="object"||!h){return t.init.apply(this,arguments)}else{b.error("Unknown method")}}};b.scroller=new s(null,null,f)})(jQuery);





		function onbodyload(){
			var cities = [
				{id:3, value:"London"},
				{id:1, value:"Stockholm"},
				{id:4, value:"Berlin"},
				{id:2, value:"Moscow"}
			];
			
			dhx.ui({
				view:"popup",
				id:"cities",
				body:{
					view:"list", 
					template: "<div>#value#</div>",
					data:cities,
					type:{
						width:160
					},
					yCount:3
				}
			}).hide();
			/*
			dhx.ui({
				cols:[
				
				{
					rows:[
					
					{ 	view:"toolbar", type:"MainBar",  elements:[{ view:"richselect", name: "from", id:'myrich', label: 'From', value: 1, popup:"cities" }]}
				
				]}
				]
			});
			*/
			dhx.ui({ view:"richselect",id: "myRichselect", container:'jack', options:[
			                                    					{ value:1, label:"One"   }, 
			                                    					{ value:2, label:"Two"   }, 
			                                    					{ value:3, label:"Three" }]
			                                    });
			try{
				
				var item = $$('myRichselect');
				alert('item '+item);
				
				$('#jack').append($('.dhx_view dhx_el_richselect').html());
				
				alert($('.dhx_view dhx_el_richselect').css());
				alert($('#jack').html());
			}catch(exc){
				alert(exc.message);
			}
		}
		












	var dhtmlx_listProductsSelect = null;
	function onbodyload12(){
		var cities = [
			{id:3, value:"London"},
			{id:1, value:"Stockholm"},
			{id:4, value:"Berlin"},
			{id:2, value:"Moscow"}
		];
		
		dhx.ui({
			view:"popup",
			id:"cities",
			body:{
				view:"list", 
				template: "<div>#value#</div>",
				data:cities,
				type:{
					width:160
				},
				yCount:4
			}
		}).hide();
		
		

		
		dhtmlx_listProductsSelect = [
    					{ value:1, label:"Nessun prodotto principale"}, 
      					{ value:2, label:"Two"   }, 
      					{ value:3, label:"Thre2e" }
      					
      				];
		//dhx.ui({ view:"richselect",id: "myRichselect", container:'impostazioni_body_vista_container_generali_info',label:'', value:"1", iconCss:'dhx_list_icon2', width:'36', options: dhtmlx_listProductsSelect});
		$('.dhx_inp_list').css('width','90%');
		/*
        $$('myRichselect').options:[
                                    {value:1, label:"Nessun prodotto principale1"},
                                    {value:2, label:"Nessun prodotto principale1"},
                                    {value:3, label:"Nessun prodotto principale1"}
                                   ];
    */
    
    	//listProductsSelect = [ ;
    	var arr1 = [{ value:1, label:"Nessun prodotto principale"}];
    	//alert('_EDICOLA_PRODUCTS_DETAILS: ' + _EDICOLA_PRODUCTS_DETAILS);
	    for (var key in _EDICOLA_PRODUCTS_DETAILS) {
	        if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
	        	/*
	            var l_option = $('<option></option>');
	            l_option.val(_EDICOLA_PRODUCTS_DETAILS[key].productId);
	            l_option.text(_EDICOLA_PRODUCTS_DETAILS[key].name);
	            if (_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
	                l_option.attr('selected', 'selected');
	            }
	            
	            l_impostazioni_prodotto_principale_select.append(l_option);
	            */
	        	
	            //listProductsSelect += { value:parseInt(_EDICOLA_PRODUCTS_DETAILS[key].productId+1), label:"Nessun prodotto principale"+_EDICOLA_PRODUCTS_DETAILS[key].productId},
			    console.log(_EDICOLA_PRODUCTS_DETAILS[key].productId+1);
	            console.log(_EDICOLA_PRODUCTS_DETAILS[key].name);
	            var obj = {
			    		value: _EDICOLA_PRODUCTS_DETAILS[key].productId+1,
			    		label: _EDICOLA_PRODUCTS_DETAILS[key].name
			    };
			    arr1.push(obj);
                     
	    	}
	        
		}
	    dhtmlx_listProductsSelect = arr1;
	    //alert(dhtmlx_listProductsSelect);
	    //alert('aa '+arr);
	    $$('myRichselect').refresh();
	    /*
		var arr = [];
		var len = 4;
		for (var i = 0; i < len; i++) {
		    var obj = {
		    		value: _EDICOLA_PRODUCTS_DETAILS[key].productId,
		    		label: _EDICOLA_PRODUCTS_DETAILS[key].name
		    };
		    arr.push(obj);
		}
	*/
	    /*
	    listProductsSelect = listProductsSelect.substring(0, listProductsSelect.lastIndexOf(','));
	    listProductsSelect += ];
    	alert(listProductsSelect);*/
    	//$$('myRichselect').refresh();
    }
	




		_INBOX_NUM_UNREAD_MESSAGES = 0;
		var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
		var _ADV_PROXY_TEST = "http://212.45.97.204/adv_proxy_and.php";
		var _API24TEST_SWITCH = false; // se a true, l'app utilizza la configurazione di stage
		
		var uuid_device = window.infodroid.getUUID();
		var PRODUCT_ID = 0;
		var SCREEN = 0;
		
		//alert(uuid_device);
		function upFromDB(){
    		var valoutput ;
    		console.log('passed... ');
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    			_INBOX_NUM_UNREAD_MESSAGES=valoutput;
    			
    		} 
    		else{
    			console.log('error');
    			throw "window.localStorage, not defined"; 
    		}

		}
		
		function updateUnreadMessage() {
			try{
			//upFromDB();
				setTimeout(function (){
					console.log('updateUnreadMessage:::passed... ');
				    if (_INBOX_NUM_UNREAD_MESSAGES > 0 ){
				        //$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
				        //$('#appmenu_inbox_count').css('display', 'block');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'block';
				    } else {
				        //$('#appmenu_inbox_count').css('display', 'none');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'none';
		
				    }
				},1000);
			}catch(exc){
				console.log(exc.message);
			}
		}
		
		
		function loadExtra(){
			if(_API24TEST_SWITCH){
				_ADV_PROXY = _ADV_PROXY_TEST;
			}
			try{
				if(SCREEN == 0)
					SCREEN = window.innerWidth;
			    loadAdvTabbar(PRODUCT_ID);
			    loadAdvCatalogo();
			}catch(exc){
				alert(exc.message);
			}
		}
		
		function loadAdvTabbar(product_id){
			//alert("CALL ME!!!");
			//document.getElementById('advtabbar_close').style.display = 'none';
			try{
		    document.getElementById('advtabbar_close_content').innerHTML = '';
		    //$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){
			$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + uuid_device+ "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
		        /*
				setTimeout(function() {
					var ret = false;
					try {

						var imgs = document.getElementById('advtabbar_close_content').getElementsByTagName('img');
						if(imgs != null || imgs.length >= 0) {
							for(var i = 0; i < imgs.length; i++) {
								if(parseInt(imgs[i].height) > 10) {
									ret = true;
								}
							}	
						}
						
					} catch(exc) {
						ret = false;
					}
					
					if (ret) {
						$('#advtabbar_close').fadeIn();
					}

				}, 100);
		        */
		        setTimeout(function() {
		        	removeHref();
		        }, 100);
		    }).endCapture();
		    document.getElementById('advtabbar_open_content').innerHTML = '';
		    //$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
			$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + uuid_device+ "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
		    			        setTimeout(function() {
		        	overwriteClick();
		        }, 100);
		    }).endCapture();
		    }catch(exc){
		    	alert(exc.message);
		    }
		}

		var _TABBAR_ADV_IS_OPEN = false;
		function handleAdvTabbarClick(){
			var _width_close = $('#advtabbar_close_content img').first().width();
			var _height_close = $('#advtabbar_close_content img').first().height();
			// evita di aprire il contenuto se non c'è nulla caricato
			if ((_width_close == null) || (_height_close==null) || (_width_close < 5) || _height_close < 25) return;
			//alert("CALL ME1!!!");
		    _TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
		    document.getElementById('advtabbar_close').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_open').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    window.resize.resizeweb(200, !_TABBAR_ADV_IS_OPEN);
			return true;
		}

		function loadAdvCatalogo(product_id){
			//alert("CALL ME2!!!");
		    document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
		    //$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
			$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + uuid_device+ "&s=" + SCREEN + "&m=" + window.infodroid.getDevice() + "&vapp=" +  window.infodroid.getVersion(), function(){
		    }).endCapture();
		}


		function removeHref(){
			var node = document.getElementById('advtabbar_close_content');
			for(var i=0; i<node.childNodes.length;i++){
				var child = node.childNodes[i];
				if(child.href){
					child.setAttribute('href','');
				}
			}
		}
		
		function overwriteClick(){
			$('#advtabbar_open_content').bind( "click", function(e) {
			
				var _height_close = $('#advtabbar_close_content img').first().height();
				if(_height_close==null || _height_close < 25) return;
				
				if(document.getElementById('advtabbar_open').style['-webkit-transform'] != 'translate3d(0px, -160px, 0px)') return;
				
				var url = $("#advtabbar_open_content div[style*='display: inline-block;'] a").attr('href'); 
				console.log('href ' + url);
				if(url){
					window.location = url;
				}
				return false;
			});
		}
		

	





	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);

	}
	
	function onDeviceReady()
	{
		
		
       	console.log("NO IOS BRIDGE CALLBACK.");
       	console.log("Load green droid OS file!");
        	
            setTimeout(function(){
	            $('#splashscreen').css('display', 'none');

	    		window.location = 'galaxy.html';

            },3000);
        /*
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
        */
	}
    
    




function load() {
	try{   
		$("#progressbar").reportprogress(0);
		$("#progressbar1").reportprogress(0);
		$("#progressbar2").reportprogress(0);
		$("#progressbar3").reportprogress(0);
		$("#progressbar4").reportprogress(0);
		$("#progressbar5").reportprogress(0);
		
		PhoneGap.exec(null, null, "Notification", "activityStop", []);
	}catch(exc){
		alert(exc.message);
	}
}

var pct=0;
var pct1=0;
var pct2=0;
var pct3=0;
var pct4=0;
var pct5=0;
var handle=0;
var handle1=0;
var handle2=0;
var handle3=0;
var handle4=0;
var handle5=0;
function update(increment_var){
	
	if(increment_var == 'pct'){
        $("#progressbar").reportprogress(++pct);
        if(pct==100){
                clearInterval(handle);
                $("#run").val("sfoglia");
                pct=0;
        }
   }else if(increment_var == 'pct1'){
       $("#progressbar1").reportprogress(++pct1);
       if(pct1==100){
               clearInterval(handle1);
               $("#run1").val("sfoglia");
               //pct1=0;
       }
	}else if(increment_var == 'pct2'){
	       $("#progressbar2").reportprogress(++pct2);
	       if(pct2==100){
	               clearInterval(handle2);
	               $("#run2").val("sfoglia");
	               pct2=0;
	       }
	}else if(increment_var == 'pct3'){
	       $("#progressbar3").reportprogress(++pct3);
	       if(pct3==100){
	               clearInterval(handle3);
	               $("#run3").val("sfoglia");
	               pct3=0;
	       }
	}else if(increment_var == 'pct4'){
	       $("#progressbar4").reportprogress(++pct4);
	       if(pct4==100){
	               clearInterval(handle4);
	               $("#run4").val("sfoglia");
	               pct4=0;
	       }
	}else if(increment_var == 'pct5'){
	       $("#progressbar4").reportprogress(++pct5);
	       if(pct5==100){
	               clearInterval(handle5);
	               $("#run5").val("sfoglia");
	               pct5=0;
	       }
	}else{
		//niente
		console.log("increment_var: "+increment_var);
		if(increment_var == null){
	        $("#progressbar").reportprogress(++pct);
	        if(pct==100){
	                clearInterval(handle2);
	                $("#run").val("sfoglia");
	                pct=0;
			
			}
		}
	}
}

function updateBar(idprogress, value){
	//console.log(" passed!!!!!! " + idprogress + "____" + value);
	if(idprogress != null && value >= 0){
		//console.log(" passed2!!!!!! " + idprogress.id + "____" + value);
        $("#"+idprogress.id).reportprogress(parseInt(value));
        if(value == 100){
                //clearInterval(handle);
                $("#run_"+idprogress.id).val("sfoglia");
                //pct=0;

		}
    }
}



jQuery(function($){
        $("#run_progressbar").click(function(){
                if(this.value=="start"){
                        //handle=setInterval("update(\'pct\')",100);
						//LAUNCH DOWNLOAD
						var temp = this.id.split('_');
						var prog_id = temp[1];
						console.log(prog_id);
						
						window.soledownloader.launchDownload("S24", "SOLE", "20110925", "Descrizione", ""+prog_id);
                        
                        this.value="annulla";
                }else if(this.value=="sfoglia"){
                	console.log("SFOGLIA S24 SOLE 20110925");
                    //CALL A JAVASCRIPT INTERFACE
                	window.loader.launchSfogliatore("S24", "SOLE", "20110925", "Descrizione");
                	//window.location = 'ipad.html';
                }else{
                    clearInterval(handle);
					pct=0;
					$("#progressbar").reportprogress(0);

                    this.value="start";
                    }
        });
        $("#reset").click(function(){
                pct=0;
                $("#progressbar").reportprogress(0);
        });
        $("#run_progressbar1").click(function(){
            if(this.value=="start"){
                    //handle1=setInterval("update(\'pct1\')",100);
                    //this.value="annulla";
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111006", "Descrizione", ""+prog_id);
                
                this.value="annulla";
                
            }else if(this.value=="sfoglia"){
            	console.log("SFOGLIA S24 SOLE 20111007");
                //CALL A JAVASCRIPT INTERFACE
            	window.loader.launchSfogliatore("S24", "SOLE", "20111006", "Descrizione");
            }else{
                clearInterval(handle1);
				pct1=0;
				$("#progressbar1").reportprogress(0);

                this.value="start";
                }
    });
        $("#run_progressbar2").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111115", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111115");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle2);
				pct2=0;
				$("#progressbar2").reportprogress(0);

                this.value="start";
            }
    });
        $("#run_progressbar3").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111109", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111109");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111109", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle3);
				pct3=0;
				$("#progressbar3").reportprogress(0);

                this.value="start";
            }
    });

        $("#run_progressbar4").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111129", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111129");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111129", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle4);
				pct4=0;
				$("#progressbar4").reportprogress(0);

                this.value="start";
            }
    });
        
        $("#run_progressbar5").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "LUNEDI", "20111114", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111114");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "LUNEDI", "20111114", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle5);
				pct5=0;
				$("#progressbar5").reportprogress(0);

                this.value="start";
            }
    });
        
});

	function loadQuick(){
		var valoutput ;
		if(typeof(window.localStorage) != 'undefined'){ 
			valoutput = window.localStorage.getItem ("unread_message_sole"); 
		} 
		else{ 
			throw "window.localStorage, not defined"; 
		}
		window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
    	setTimeout("history.go(-1)", 1500);
	}






	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	function onDeviceReady()
	{
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
	}
    
    

function eliminaCopiaLocaleSucc(p_testata, p_issue, p_edizione) {
	//alert('aaa1');
	if (_DB) {
		_DB.transaction(function(transaction) {
			transaction.executeSql("DELETE FROM issues WHERE testata=? and issue=? and edizione=?", [p_testata, p_issue, p_edizione], function(transaction) {
				console.log('delete ok');
				//navigator.fileMgr.deleteDirectory('issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
				//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
				//window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);

				setTimeout(function() {
					window.soledownloader.cancelDownload(p_testata, p_edizione, p_issue, "", "", true);
				}, 0);

				setTimeout(function() {
					window.soledelete.deleteIssue(p_testata, p_issue, p_edizione);
				}, 1000);

				if (_QARCHIVIO_MODE) {
					//Modifica la visualizzazioni dello stato nell'archivio
					var l_status_el = $('#qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione);
					l_status_el.addClass('qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE);
					l_status_el.removeClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE);
					if (_QARCHIVIO_MODE == 'LIST') {
						$('#qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione).css('display', 'none');
					}
					_NEXT_ACTION = qarchivioLoad;
				}

				// gestione cancellazione da archivio standard
				if ($('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione)) {
					console.log('cancellazione da archivio standard');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).removeClass('archivio_container_box_islocal');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).addClass('archivio_container_box_isremote');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + ' > div > .archivio_button_elimina').css('display', 'none');
					$('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + " .archivio_container_box_txt_local_ICONS").remove();
				}
			}, function() {
				console.log('delete error');
			});
		});
	}
}

function impostazioniCancellaContenutoLocaleSucc() {
	if (_DB) {
		/*
		 navigator.notification.loadingStart({
		 'labelText': "Cancellazione in corso...",
		 'backgroundOpacity': 0.8,
		 'strokeOpacity': 0.25,
		 'strokeColor': "FFFFFF",
		 });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Cancellazione in corso..."]);
		_DB.transaction(function(transaction) {
			transaction.executeSql("DELETE FROM issues", [], function(transaction) {
				console.log('delete db ok');
				//navigator.fileMgr.deleteDirectory('issues');
				//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues');

				//window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues');
				window.soledelete.deleteAll('/S24/');
				console.log('delete fs ok');
				window.simulatePG.alert('Tutte le edizioni presenti sono state cancellate.', 'window.simulatePG.exec(null, null, "Notification", "activityStop", [])', 'Cancellazione contenuto locale', 'Ok');
				openProductDetails(_PRODUCT_IN_EDICOLA.productId);
			}, function() {
				console.log('delete error');
				window.simulatePG.alert('Si è verificato un errore durante la cancellazione.', 'window.simulatePG.exec(null, null, "Notification", "activityStop", [])', 'Cancellazione contenuto locale', 'Ok');
			});
		});
	}
}

function inboxDeleteOpenedMessageSucc() {
	if (true) {
		var l_active_message = $('.inbox_list_container_box_active');
		if (l_active_message.length > 0) {
			var l_active_message_id = l_active_message[0].id.substring(25);

			if (_INBOX_MESSAGES['mid_' + l_active_message_id]) {
				/*
				 if (!_INBOX_MESSAGES[l_active_message_id].body) {
				 markMessagesAsRead([l_active_message_id]);
				 }
				 */
				deleteLocalMessages([l_active_message_id]);
			}

			//$('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
			l_active_message.remove();
		}
	}
}

var PGCheckVersion = function() {
}
PGCheckVersion.prototype.checkVersion = function(successCB, errorCB) {
	PhoneGap.exec(successCB, errorCB, 'it.alebeer.checkversion', 'checkVersion', []);
}
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.pgcheckversion = new PGCheckVersion();
});



/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
    
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
	
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.artid);
        	window.searchdb.display(p_article.artid);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}

		var res = null;//new Array();
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}







/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
//var _DEPLOY_BASE_URL = 'http://212.45.97.204/_deploy/';
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';
var _ADV_PROXY = 'http://mobapp24.ilsole24ore.com/adv_proxy_and.php';
var _ADV_PROXY_TEST = 'http://212.45.97.204/adv_proxy_and.php';

var _API24TEST_SWITCH = false; // se a true, l'app utilizza la configurazione di stage

var _SCREENADV = screen.width;

function onBodyLoad(){

    //mostraTopbar();
	
	if(_API24TEST_SWITCH){
		_ADV_PROXY = _ADV_PROXY_TEST;
	}
    articoloZoomAuxText(0);
	
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    $('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    $('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				$('#container_adv').writeCapture().load(_ADV_PROXY + '?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime()+'&s='+_SCREENADV+ '&m=' + window.infodroid.getDevice() + '&vapp=' +  window.infodroid.getVersion(), function(){}).endCapture();
				console.log('adv is '+_ADV_PROXY +'?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime());
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();*/
				//console.log('adv '+'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04');
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                //alert("aaa "+_CURRENT_ARTICLE.sommari[i][0] );
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = new iScroll('wrapper_articolo', {});
        /*
        $('.article_table_inline').click(function(event) {
        	event.stopPropagation();
        	try {
        		var idTable = $(this).attr('idTable');
        		if ((idTable != null) && (idTable.length >= 1)){
        		//window.location = 'dsh://tabella.open/' + idTable;
        			alert('aaaa1');
        		}
        	} catch (exc) {
        		//alert(exc.message);
        	}
        });
        */
        $('#articolo_body_text table').click(function(event) {
        	event.stopPropagation();
        	try {
        		ARTICOLO_BODY_TEXT_TABLE_CONTENT = $(this)[0].outerHTML;
        		if ((ARTICOLO_BODY_TEXT_TABLE_CONTENT != null) && (ARTICOLO_BODY_TEXT_TABLE_CONTENT.length >= 1)){
        		//window.location = 'dsh://tabella.open/HTML';
        			//alert('aaaa12');
        			window.opentabella.open(JSON.stringify(ARTICOLO_BODY_TEXT_TABLE_CONTENT));
        		}
        	} catch (exc) {
        		console.log(exc.message);
        	}
        });
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var ARTICOLO_BODY_TEXT_TABLE_CONTENT = '';
function getArticoloBodyTextTableContent() {
	return ARTICOLO_BODY_TEXT_TABLE_CONTENT;
}

function updateOrientation(){
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}


//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
	//alert(JSON.stringify(sezioniJson));
	
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        if(_ISCROLL_ARTICOLI!=null)
        	_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
        if(_ISCROLL_SEZIONI!=null){
        	_ISCROLL_SEZIONI.scrollTo(0, 0, 10);
        }
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        //alert(JSON.stringify(articoliJson));
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
    	//console.log('erroreeee ');
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}

function decodeHtml(value) {
	return $('<div />').html(value).text();
}

function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';
    
    var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;
    
    //window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
    //window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent(l_url) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';
    
    var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;
    
    //window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
    //window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent(l_url) + '&text=' + encodeURIComponent(l_titolo));
}
/*
function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}

*/
var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		$('#articolo_body_media_correlati').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
function articoloZoomAuxText(p_zoomstep) {
	try {
		var l_currtextzoom = null;
		if(typeof(window.localStorage) != 'undefined'){ 
			l_currtextzoom = window.localStorage.getItem("currtxtzoom");
		}
		if (!l_currtextzoom) l_currtextzoom = 100;
		else l_currtextzoom = parseInt(l_currtextzoom);
		switch (l_currtextzoom) {
			case 80:
			case 100:
			case 120:
			case 140:
			case 160:
			
				break;
			default:
				l_currtextzoom = 100;
		}
		l_currtextzoom = Math.max(80, Math.min(160, l_currtextzoom + p_zoomstep));
		window.localStorage.setItem("currtxtzoom", l_currtextzoom);
		$('#articolo_body_text').css('font-size', l_currtextzoom + '%');
		$('#articolo_body_text').css('line-height', (l_currtextzoom + 10) + '%');
		
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function articoloZoomInText() {
	articoloZoomAuxText(20);
	//console.log("aaaaaaaa1a");
}

function articoloZoomOutText() {
	articoloZoomAuxText(-20);
	//console.log("aaaaaaaaa");
}

function shareMy24(){
	try{
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_my24.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;
    
    window.open.openUrl(l_url);
	}catch(exc){
		alert(exc.message);
	}
}

function setBackground(color){
	$('#wrapper_articolo').css("background-color", color);
	$('#wrapper_articolo').css("background-image","none");
}

/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';


function doCerca() {
	if ($('#search_input').val() == '') return;
	if ($('#searchkeyword_option').val() == 'LOCAL')
		searchDb();
	else
		remoteSearch();
}


var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_ISCROLL_ARTICOLI != null) {
		_ISCROLL_ARTICOLI.destroy();
		_ISCROLL_ARTICOLI = null;
	}
	
	document.getElementById('articoli_container').innerHTML = '';
	
	if (articoliJson.length == 0)
		document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';
	
	for (var i = 0; i < articoliJson.length; i++) {
		
		var box = document.createElement('div');
		box.className = 'box_articolo';
		document.getElementById('articoli_container').appendChild(box);
		box.id = 'box_articolo_' + i;
		
		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;
		
		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;
		
		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr + '</strong> del ' + articoliJson[i].issue_descr + ' (pag. ' + articoliJson[i].pagina + ')';
		
		box.onclick = (function(articoloJson, domid) {
			return function(){
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(function() {
					that.className = 'box_articolo';
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;
					
					//window.location = 'dsh://remotecerca.goto';
					//alert(articoloJson.testata + ' ' + articoloJson.issue + ' ' + articoloJson.edizione + ' ' + articoloJson.itunes);
				}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);
		
		pagina = null;
		snippet = null;
		titolo = null;
		box = null;
		
	}
	
	setTimeout(function() {
		_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', { hScroll: false, vScroll: true });
		_ISCROLL_ARTICOLI.scrollTo(0,0,100);
		
	}, 200);
}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata': _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA, 
			'issue': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE, 
			'edizione': _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE, 
			'itunes': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url': _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}


function onBodyLoad(){

    //mostraTopbar();
    
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    $('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    $('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

function updateOrientation(){
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
        inboxAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

function searchDb(){
	//alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	if (toSearch == '') {
		alert('Inserisci una chiave di ricerca');
		return;
	}

	//Array res = window.searchdb.search(toSearch);
	//searchAddMessages(res);
}

function remoteSearch(){
	//alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	//alert('remote!!!' + toSearch);
	//Array res = window.searchdb.search(toSearch);
	//searchAddMessages(res);
}

//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}






		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_03', function() { }).endCapture();
		}
	

/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

function doCerca() {
	if ($('#search_input').val() == '') return;
	/*if ($('#searchkeyword_option') == null){
		searchDb();
		return;
	}*/
	if ($('#searchkeyword_option').val() == 'REMOTE')
		remoteSearch();
	else
		searchDb();
}


var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_RICERCA_ISCROLL_VISTA != null) {
		_RICERCA_ISCROLL_VISTA.destroy();
		_RICERCA_ISCROLL_VISTA = null;
	}
	
	if((articoliJson == null) || (typeof articoliJson == undefined)){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	//preferitiOpenArticlesList(res);
	 $('#preferiti_body_vista_container').empty();
	
	//alert(JSON.stringify(articoliJson)+","+articoliJson.length);
	
	//articoliJson = JSON.parse( JSON.stringify( articoliJson ) );
	
	//alert('aaa' + articoliJson.length);
	
	document.getElementById('search_list_container').innerHTML = '';
	
	if (articoliJson.length == 0)
		document.getElementById('search_list_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';
	
	for (var i = 0; i < articoliJson.length; i++) {
		
		var box = document.createElement('div');
		box.className = 'box_articolo_remote';
		document.getElementById('search_list_container').appendChild(box);
		box.id = 'box_articolo_' + i;
		
		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;
		
		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;
		
		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr + '</strong> del ' + articoliJson[i].issue_descr + ' (pag. ' + articoliJson[i].pagina + ')';
		
		box.onclick = (function(articoloJson, domid) {
			return function(){
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(function() {
					that.className = 'box_articolo_remote';
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;
					
					//window.location = 'dsh://remotecerca.goto';
					//alert(articoloJson.testata + ',' + articoloJson.issue + ',' + articoloJson.edizione + ',' + articoloJson.itunes);
					
					//window.searchdb.display(articoloJson.idart);
					
					//checkaquisto
					//var para = new Array();//[articoloJson.testata,articoloJson.issue,articoloJson.edizione,articoloJson.pagina];
					/*para[0] =  articoloJson.testata ;
					para[1] =   articoloJson.issue;
					para[2] =  articoloJson.edizione ;
					para[3]=  articoloJson.pagina ;
					*/
					var para = articoloJson.testata + "|" + articoloJson.issue + "|" +  articoloJson.edizione + "|" + articoloJson.pagina;
					//alert( "asdce "+JSON.stringify(para));
					window.searchdb.check(articoloJson.productid,  articoloJson.issue, articoloJson.edizione,articoloJson.accounting, articoloJson.itunes, "sfoglia", para);
					//checkAcquisto(articoloJson.productid,  articoloJson.issue, articoloJson.accounting, articoloJson.itunes, function() { sfoglia(articoloJson.testata, articoloJson.issue, articoloJson.edizione, articoloJson.pagina); });
					//poi apro pagina
				}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);
		
		pagina = null;
		snippet = null;
		titolo = null;
		box = null;
		
	}
	
	setTimeout(function() {
		
		
		
		_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');// = new iScroll('search_list_wrapper', { hScroll: false, vScroll: true });
		_RICERCA_ISCROLL_VISTA.scrollTo(0,0,0);
		
		
	    $('#search_list_container').css("background-color","white");
	    //$('#search_list_container').css("height","400px")
	    $('#search_list_wrapper').css("position","relative");
	   // $('#search_list_wrapper').css("height","460px");
	    $('#search_list_wrapper').css("overflow","hidden");
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html(articoliJson.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    
	    _RICERCA_ISCROLL_VISTA.refresh();

		
	}, 200);
	

}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata': _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA, 
			'issue': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE, 
			'edizione': _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE, 
			'itunes': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url': _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}



var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
	
	//window.searchdb.remoteSearch('abc');
	//window.searchdb.search3('abc');
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
	 	$("#search_input").keydown( function(event) {
            if (event.keyCode == 13) {
            	doCerca();
            }
    });

}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
	
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.pagina);
        	//alert('pag '+p_article.pagina);
        	window.searchdb.display(p_article.artid);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + '<strong>' + p_article.sezione + '</strong> ' + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}

		
		var res = null;//new Array();
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function remoteSearch(){
	try{
		//alert($('#search_input').val());
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
		
		window.searchdb.remoteSearch(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert('remote!!!' + toSearch);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.5';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}








		function ipadFlipperTopBarEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuPreferiti() {
			window.location = 'dsh://preferiti.open';
		}
		function ipadFlipper24AppmenuInbox() {
			window.location = 'dsh://inbox.open';
		}
		function ipadFlipper24AppmenuImpostazioni() {
			window.location = 'dsh://impostazioni.open';
		}
		function ipadFlipper24Thumb() {
			window.location = 'dsh://thumb.open';
		}
		function ipadFlipper24UpdatePgnum(current, total) {
			document.getElementById('flipper24_topbar_thumb').innerHTML = current + ' di ' + total;
			return "OK";
		}
		function ipadFlipper24AppmenuIndice() {
			window.location = 'dsh://indice.open';
		}
	


    	function loadTabella(p_tabella) {
    		if (!p_tabella) return;
    		//alert(JSON.stringify(p_tabella));
    		if (p_tabella.titolo) {
    			document.getElementById('flipper24_tab_titolo').innerHTML = p_tabella.titolo;
    		} else {
    			document.getElementById('flipper24_tab_titolo').style.display = 'none';
    		}
    		if (p_tabella.contenuto) {
    			document.getElementById('flipper24_tab_contenuto').innerHTML = p_tabella.contenuto;
    		} else {
    			document.getElementById('flipper24_tab_contenuto').style.display = 'none';
    		}
    	}
    




		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_02', function() { }).endCapture();
		}
	











		var _ISCROLL_SEZIONI = null;
		var _ISCROLL_ARTICOLI = null;
		
		function updateOrientation(screenWidth, screenHeight) {
		}
		
		function loadSezioni(sezioniJson) {
			if (_ISCROLL_SEZIONI != null) {
				_ISCROLL_SEZIONI.destroy();
				_ISCROLL_SEZIONI = null;
			}
			
			document.getElementById('sezioni_container').innerHTML = '';
			/*
			if(screen.width > 790){
				document.getElementById('sezioni_container').style.width = 160 * parseInt(sezioniJson.length) + 'px';
			}
			else{
				document.getElementById('sezioni_container').style.width = 100 * sezioniJson.length + 'px';
				
			}*/
			/*
			setTimeout(function() {
				if(screen.width > 790){
					$('#sezioni_container').css("width",""+parseInt(160 * parseInt(sezioniJson.length)));
				}else
					$('#sezioni_container').css("width",""+parseInt(100 * parseInt(sezioniJson.length)));
			}, 200);*/

			
			//alert('aaa'+sezioniJson.length+","+(160 * sezioniJson.length)+","+document.getElementById('sezioni_container').style.width);
			var last_width = 0;
			for (var i = 0; i < sezioniJson.length; i++) {
				
				var box = document.createElement('div');
				box.id = 'box_section_' + sezioniJson[i].section;
				box.className = 'box_sezione';
				document.getElementById('sezioni_container').appendChild(box);
				
				var inner = document.createElement('div');
				box.appendChild(inner);
				
				inner.innerHTML = sezioniJson[i].description;
				
				box.onclick = (function(sid) {
					return function(){
						sezioneSelected(sid);
					}
				})(sezioniJson[i].section);
				
				inner = null;
				box = null;
				
			}

			last_width = $('#sezioni_container .box_sezione:last-child').outerWidth(true);

			if (sezioniJson.length > 0 ) {
					var scrollerWidth = 0;
					$('#sezioni_container .box_sezione').each(function(){
						scrollerWidth += $(this).width();
					});
					$('#sezioni_container').width(scrollerWidth);
					scrollerWidth = null;
			}
			
			/*
			setTimeout(function() {
				_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', { hScroll: true, vScroll: false });
				_ISCROLL_SEZIONI.scrollTo(0,0,100);
			}, 200);
			
			
			return "OK";
			
		}*/
		/*
			for (var i = 0; i < sezioniJson.length; i++) {
				
				var box = document.createElement('div');
				box.id = 'box_section_' + sezioniJson[i].section;
				box.className = 'box_sezione';
				document.getElementById('sezioni_container').appendChild(box);
				
				var inner = document.createElement('div');
				box.appendChild(inner);
				
				inner.innerText = sezioniJson[i].description;
				//alert(i+","+inner.innerText);
				box.onclick = (function(sid) {
					return function(){
						sezioneSelected(sid);
					}
				})(sezioniJson[i].section);
				
				inner = null;
				box = null;
				
			}*/
			/*if (sezioniJson.length > 0) {
				var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
				if (last_stection_box)
					$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
			}*/
			
			setTimeout(function() {
				_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', { hScroll: true, vScroll: false });
				_ISCROLL_SEZIONI.scrollTo(0,0,100);
				_ISCROLL_SEZIONI.refresh();
				
				$('#sezioni_container .box_sezione').eq(0).trigger('click');
			}, 200);
			/*
			setTimeout(function() {
				if(_ISCROLL_SEZIONI != null){
					console.log('width '+$('#sezioni_container').css("width"));
					$('#sezioni_container').css("width",'80%');
					_ISCROLL_SEZIONI.refresh();
				}
			}, 300);
			*/
			return "OK";
			
		}
		
		function sezioneSelected(sid) {
			$('.box_sezione_selected').removeClass('box_sezione_selected');
			//window.location = 'dsh://indice.load/' + sid;
			console.log("sezioneSelected  "+sid);
			window.indice.load(sid);
		}
		
		function loadListaArticoliSezione(sid, articoliJson) {
			$('#box_section_' + sid).addClass('box_sezione_selected');
			
			if (_ISCROLL_ARTICOLI != null) {
				_ISCROLL_ARTICOLI.destroy();
				_ISCROLL_ARTICOLI = null;
			}
			
			document.getElementById('articoli_container').innerHTML = '';
			
			if (articoliJson.length == 0) return "VUOTO";
			
			for (var i = 0; i < articoliJson.length; i++) {
				
				var box = document.createElement('div');
				box.className = 'box_articolo';
				box.id = 'box_articolo'+new Date().getTime();
				document.getElementById('articoli_container').appendChild(box);
				
				var titolo = document.createElement('h1');
				box.appendChild(titolo);
				titolo.innerHTML = articoliJson[i].titolo;
				
				var pagina = document.createElement('h3');
				box.appendChild(pagina);
				pagina.innerHTML = 'pag. ' + articoliJson[i].pagina;
				
				console.log('indice box1 '+box.id);
				
				box.onclick = (function(pagina) {
					return function(){
						//window.location = 'dsh://indice.goto/' + pagina;
						    
        					
            					
            					//console.log('indice box '+this.id);
            					
            					$('#'+this.id).addClass('box_articolo_selected');
            					
            					setTimeout(function() {
            						//console.log('indice box '+$('.box_articolo_selected'));
            						$('.box_articolo_selected').removeClass('box_articolo_selected');
 
            					}, 120);
            					
            					setTimeout(function() {
            						console.log("vai a "+pagina); //Da USARE GOTO THUMB
            						window.go.to(pagina);	

            					}, 150);


					}
				})(articoliJson[i].pagina);
				
				pagina = null;
				titolo = null;
				box = null;
				
			}
			
			setTimeout(function() {
				_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', { hScroll: false, vScroll: true });
				_ISCROLL_ARTICOLI.scrollTo(0,0,100);
				
			}, 200);
			
			return "OK";
			
		}
		
		  function verifyScreen(){
			
			setTimeout(function(){
			 //alert(screen.width+", "+screen.height);
			 if(window.innerWidth < 610 && screen.width < 790){
			  link = document.getElementsByTagName("link")[0];
			  link.href = "ipad7_flipper24_indice.css";
			  try{
				$('.button medium gray24').removeClass('button medium gray24');
				$('#titolo > input').addClass('button small gray24');
			  }catch(exc){
				alert(exc.message);
			  }
			 }
			 },500);
		  }
	

/**
 * @author ABertacco
 */
function ab_number_format(number, decimals, dec_point, thousands_sep) {

	var n = number, prec = decimals;

	var toFixedFix = function(n, prec) {
		var k = Math.pow(10, prec);
		return (Math.round(n * k) / k).toString();
	};

	n = !isFinite(+n) ? 0 : +n;
	prec = !isFinite(+prec) ? 0 : Math.abs(prec);
	var sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep;
	var dec = (typeof dec_point === 'undefined') ? '.' : dec_point;

	var s = (prec > 0) ? toFixedFix(n, prec) : toFixedFix(Math.round(n), prec); // fix
																				// for
																				// IE
																				// parseFloat(0.55).toFixed(0)
																				// = 0;
	var abs = toFixedFix(Math.abs(n), prec);
	var _, i;

	if (abs >= 1000) {
		_ = abs.split(/\D/);
		i = _[0].length % 3 || 3;

		_[0] = s.slice(0, i + (n < 0))
				+ _[0].slice(i).replace(/(\d{3})/g, sep + '$1');
		s = _.join(dec);
	} else {
		s = s.replace('.', dec);
	}

	var decPos = s.indexOf(dec);
	if (prec >= 1 && decPos !== -1 && (s.length - decPos - 1) < prec) {
		s += new Array(prec - (s.length - decPos - 1)).join(0) + '0';
	} else if (prec >= 1 && decPos === -1) {
		s += dec + new Array(prec).join(0) + '0';
	}
	return s;
}

function ab_euro_formatter(number) {
	return ab_number_format(number, 2, ',', '.') + " €";
}

var dateFormat = function() {
	var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g, timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g, timezoneClip = /[^-+\dA-Z]/g, pad = function(
			val, len) {
		val = String(val);
		len = len || 2;
		while (val.length < len)
			val = "0" + val;
		return val;
	};

	// Regexes and supporting functions are cached through closure
	return function(date, mask, utc) {
		var dF = dateFormat;

		// You can't provide utc if you skip other args (use the "UTC:" mask
		// prefix)
		if (arguments.length == 1
				&& Object.prototype.toString.call(date) == "[object String]"
				&& !/\d/.test(date)) {
			mask = date;
			date = undefined;
		}

		// Passing date through Date applies Date.parse, if necessary
		date = date ? new Date(date) : new Date;
		if (isNaN(date))
			throw SyntaxError("invalid date");

		mask = String(dF.masks[mask] || mask || dF.masks["default"]);

		// Allow setting the utc argument via the mask
		if (mask.slice(0, 4) == "UTC:") {
			mask = mask.slice(4);
			utc = true;
		}

		var _ = utc ? "getUTC" : "get", d = date[_ + "Date"](), D = date[_
				+ "Day"](), m = date[_ + "Month"](), y = date[_ + "FullYear"](), H = date[_
				+ "Hours"](), M = date[_ + "Minutes"](), s = date[_ + "Seconds"]
				(), L = date[_ + "Milliseconds"](), o = utc ? 0 : date
				.getTimezoneOffset(), flags = {
			d : d,
			dd : pad(d),
			ddd : dF.i18n.dayNames[D],
			dddd : dF.i18n.dayNames[D + 7],
			m : m + 1,
			mm : pad(m + 1),
			mmm : dF.i18n.monthNames[m],
			mmmm : dF.i18n.monthNames[m + 12],
			yy : String(y).slice(2),
			yyyy : y,
			h : H % 12 || 12,
			hh : pad(H % 12 || 12),
			H : H,
			HH : pad(H),
			M : M,
			MM : pad(M),
			s : s,
			ss : pad(s),
			l : pad(L, 3),
			L : pad(L > 99 ? Math.round(L / 10) : L),
			t : H < 12 ? "a" : "p",
			tt : H < 12 ? "am" : "pm",
			T : H < 12 ? "A" : "P",
			TT : H < 12 ? "AM" : "PM",
			Z : utc ? "UTC" : (String(date).match(timezone) || [ "" ]).pop()
					.replace(timezoneClip, ""),
			o : (o > 0 ? "-" : "+")
					+ pad(
							Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o)
									% 60, 4),
			S : [ "th", "st", "nd", "rd" ][d % 10 > 3 ? 0
					: (d % 100 - d % 10 != 10) * d % 10]
		};

		return mask.replace(token, function($0) {
			return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
		});
	};
}();

// Some common format strings
dateFormat.masks = {
	"default" : "ddd mmm dd yyyy HH:MM:ss",
	shortDate : "m/d/yy",
	mediumDate : "mmm d, yyyy",
	longDate : "mmmm d, yyyy",
	fullDate : "dddd, mmmm d, yyyy",
	shortTime : "h:MM TT",
	mediumTime : "h:MM:ss TT",
	longTime : "h:MM:ss TT Z",
	isoDate : "yyyy-mm-dd",
	isoTime : "HH:MM:ss",
	isoDateTime : "yyyy-mm-dd'T'HH:MM:ss",
	isoUtcDateTime : "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};

// Internationalization strings
dateFormat.i18n = {
	dayNames : [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday",
			"Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ],
	monthNames : [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug",
			"Sep", "Oct", "Nov", "Dec", "January", "February", "March",
			"April", "May", "June", "July", "August", "September", "October",
			"November", "December" ]
};

// For convenience...
Date.prototype.format = function(mask, utc) {
	return dateFormat(this, mask, utc);
};

function parseDateWithDbFormat(string) {
	var reggie = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/g;
	var tokens = reggie.exec(string);
	if (tokens.length != 7)
		return new Date();
	else
		return new Date(tokens[1], tokens[2] - 1, // mesi partono da 0 in js
		tokens[3], tokens[4], tokens[5], tokens[6]);
};

var abutils = {
	voidfunc : function() {
	},
	alert : function(msg, title, callback) {
		if (title == null)
			title = "Il Sole 24 ORE";
		if (callback == null)
			callback = abutils.voidfunc;
		try {

			navigator.notification.alert(msg, function() {
				callback.call();
			}, title, 'Ok');

		} catch (exc) {
			alert(msg);
			if (callback != null) {
				callback.call();
			}
		}
	}
};

var PGAleBerUtils = function() {
}
PGAleBerUtils.prototype.splashScreenHide = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'splashScreenHide',
	// []);
}
PGAleBerUtils.prototype.activityStart = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStart',
	// []);
}
PGAleBerUtils.prototype.activityStop = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStop',
	// []);
}
PGAleBerUtils.prototype.deviceExtraInfo = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deviceExtraInfo',
	// []);
}
PGAleBerUtils.prototype.deleteDirectoryAtAbsolutePath = function(successCB,
		errorCB, path) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils',
	// 'deleteDirectoryAtAbsolutePath', [path]);
}
PGAleBerUtils.prototype.registerForRemoteNotification = function(successCB,
		errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils',
	// 'registerForRemoteNotification', []);
}
/*
 * PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
 * window.plugins.pgaleberutils = new PGAleBerUtils(); });
 */
/* ------------------------------------------------------------- */

var PGFlipper24 = function() {
}
PGFlipper24.prototype.trackApp = function(successCB, errorCB, pageName, channel) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.appmeasurement',
	// 'trackApp', [pageName, channel]);
}
PGFlipper24.prototype.openFlipper24 = function(successCB, errorCB, testata,
		edizione, issue, startingPage, fastLoading) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.flipper24',
	// 'openFlipper24', [testata, edizione, issue, startingPage, fastLoading]);
}
PGFlipper24.prototype.addIssueToDownloadQueue = function(successCB, errorCB,
		testata, issue, edizione) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'addIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.removeIssueToDownloadQueue = function(successCB, errorCB,
		testata, issue, edizione) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'removeIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.getQueueDownloadQueue = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'getQueueDownloadQueue', []);
}
PGFlipper24.prototype.removeAllIssuesFromDownloadQueue = function(successCB,
		errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'removeAllIssuesFromDownloadQueue', []);
}

var PGAppStore = function() {
}
PGAppStore.prototype.setup = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setup', []);
}
PGAppStore.prototype.setUserInfo = function(successCB, errorCB, username,
		useridentity) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setUserInfo',
	// [username, useridentity]);
}
PGAppStore.prototype.productsListRequest = function(successCB, errorCB,
		productsIds) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore',
	// 'productsListRequest', [productsIds]);
}
PGAppStore.prototype.purchase = function(successCB, errorCB, productId, planS24) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'purchase',
	// [productId, planS24]);
}
/*
 * PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
 * window.plugins.flipper24 = new PGFlipper24(); window.plugins.appstore = new
 * PGAppStore(); });
 */

/* ------------------------------------------------------------- */
NotificationEx = function() {
};

NotificationEx.prototype.loadingStart = function(options) {
	// PhoneGap.exec(null, null, "NotificationEx","loadingStart", [options]);
};
NotificationEx.prototype.loadingStop = function() {
	// PhoneGap.exec(null, null, "NotificationEx","loadingStop", []);
};

NotificationEx.prototype.activityStart = function() {
	// PhoneGap.exec(null, null, "NotificationEx", "activityStart", []);
};

NotificationEx.prototype.activityStop = function() {
	// PhoneGap.exec(null, null, "NotificationEx", "activityStop", []);
};
/*
 * PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
 * navigator.plugins.notificationEx = new NotificationEx(); });
 */
// Variabile contente l'identificativo del prodotto aperto in edicola
var _PRODUCT_IN_EDICOLA = null;
var _INTERVALLO_CHECK_PRODUCTS = 15 * 60 * 1000;
var _EDICOLA_PRODUCTS_ISCROLL = null;
var _EDICOLA_PRODUCTS_COUNT = 0;
var _EDICOLA_PRODUCTS_INLINE_V = 3;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _EDICOLA_PRODUCTS_INLINE_H = 4;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _EDICOLA_PRODUCTS_DETAILS = null;
var _EDICOLA_DESCR_ISCROLL = null;
// Flag utile per capire se i prodotti in edicola debbano essere aggiornati
// quando l'utente clicca sul relativo pulsante nella barra menu
var _EDICOLA_REFRESH_PRODUCTS = false;
// hash map tra testata e product id del sole, utilizzato per aprire l'archivio
var _HASH_MAP_TESTATA_PRODUCTID = {};

var _LockTap = false;

function loadCategories() {
	try {

		// svuoto categorie
		$('#edicola_titolo_btn').html('');

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getCategorie");
		console.log(req_headers);
		console.log(req_data);

		$
				.ajax({
					type : "GET",
					cache : false,
					timeout : _AJAX_TIMEOUT,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "categories.json",
					headers : req_headers,
					data : req_data,
					dataType : "json",
					success : function(p_response) {
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log("--RESP--> getCategories");
						console.log(p_response);
						if (checkAjaxResponse(p_response)) {
							var res = p_response.Result.res;
							if ((!res.categoryList)
									|| (res.categoryList.length <= 0)) {
								loadProductsByCategory(null);
								return;
							}
							var l_select = $('<select onchange="edicolaFiltroProdottiByCategory();" id="edicola_titolo_btn_select"></select>');
							for ( var i = 0; i < res.categoryList.length; i++) {
								$(
										'<option value="'
												+ res.categoryList[i].categoryName
												+ '">'
												+ res.categoryList[i].categoryDescription
												+ '</option>').appendTo(
										l_select);
							}

							$('#edicola_titolo_btn').html('');
							l_select.appendTo('#edicola_titolo_btn');

							loadProductsByCategory(res.categoryList[0].categoryName);
						} else {
							console
									.log('getCategories check ajax response error');
							loadProductsByCategory(null);
						}
					},
					error : function() {
						console.log('getCategories ajax error');
						loadProductsByCategory(null);
					}
				});
	} catch (exc) {
		console.log('getCategories exception ' + exc.message);
		loadProductsByCategory(null);
	}
}

function loadProductsByCategory(p_category) {
	console.log('loadProductsByCategory:' + p_category);
	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$
				.ajax({
					type : "GET",
					cache : false,
					timeout : _AJAX_TIMEOUT,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "products.json",
					headers : req_headers,
					data : req_data,
					dataType : "json",
					success : function(p_response) {
						$('#edicola_container').empty();
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log("--RESP--> getProducts");
						console
								.log("getProducts "
										+ JSON.stringify(p_response));
						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response)) {
							// console.log('ajax success');
							var res = p_response.Result.res;
							_EDICOLA_REFRESH_PRODUCTS = false;
							_EDICOLA_PRODUCTS_COUNT = res.products.length;
							var l_edicola_container = document
									.getElementById('edicola_container');
							for ( var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
								var pid = res.products[i].productId;
								_EDICOLA_PRODUCTS_DETAILS[pid] = {};
								/* new Array(); */
								// _EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] =
								// res.products[i].inApp != true;
								_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
								_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
								_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
								_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

								if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']
										&& _PRODUCTLINK) {
									if (typeof _PRODUCTLINK[0] != 'undefined'
											&& _PRODUCTLINK[0]['linkType'])
										_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
								}

								// alert('is
								// '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

								// Creazione elemento "edicola_prodotto_box"
								var pbox = document.createElement('div');
								pbox.id = 'edicola_prodotto_box_' + pid;
								if (_EDICOLA_CATALOGO_SMALL) {
									pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
								} else {
									pbox.className = 'edicola_prodotto_box';
								}
								l_edicola_container.appendChild(pbox);

								var pbox_container = document
										.createElement('div');
								pbox.appendChild(pbox_container);
								pbox_container.className = 'edicola_prodotto_box_container';

								// Creazione container icona prodotto
								var pbox_icon = document.createElement('div');
								pbox_container.appendChild(pbox_icon);
								pbox_icon.className = 'edicola_prodotto_box_icon';
								pbox_icon.id = 'edicola_prodotto_box_icon_'
										+ pid;

								// Creazione immagine icona prodotto
								var pbox_icon_img = document
										.createElement('img');
								pbox_icon.appendChild(pbox_icon_img);
								// pbox_icon_img.src = i % 5 == 0 ?
								// 'imgs/fake/prodotto_icon_appstore.png' : (i %
								// 2 == 0 ?
								// 'imgs/fake/prodotto_icon_standard.png' :
								// 'imgs/fake/prodotto_icon_quotidiano.png');
								pbox_icon_img.src = res.products[i].icon;
								pbox_icon_img = null;

								_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

								// Nel caso in cui il prodotto sia esterno viene
								// creata l'icona appstore
								// if
								// (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'])
								// {
								if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
									// icona small appstore
									var pbox_icon_appstore = document
											.createElement('div');
									pbox_icon.appendChild(pbox_icon_appstore);
									pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
									pbox_icon_appstore = null;

									_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_in_appstore';
								} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

									_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_prodotto_webpage';
								} else {
									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_non_in_appstore';
								}

								// Titolo del prodotto
								var pbox_text = document.createElement('div');
								pbox_text.id = 'edicola_prodotto_box_text_'
										+ pid;
								pbox_text.className = 'edicola_prodotto_box_text';
								pbox_container.appendChild(pbox_text);
								pbox_text
										.appendChild(document
												.createTextNode(res.products[i].productName));

								// Viene associato l'evento di apertura del
								// dettaglio prodotto
								pbox.onclick = (function(pid) {
									return function() {
										openProductDetails(pid);
									}
								})(pid);

								pbox_text = null;
								pbox_icon = null;
								pbox_container = null;
								pbox = null;
							}

							$('#edicola_container')
									.fadeIn(
											200,
											function() {
												updateEdicolaProductsIscroll();

												// Se il prodotto principale è
												// stato impostato, viene aperto
												// il relativo dettaglio
												var l_prodotto_principale_id = window.localStorage
														.getItem("prodotto_principale_id");
												if (l_prodotto_principale_id
														&& l_prodotto_principale_id != '') {
													openProductDetails(l_prodotto_principale_id);
												} else if (_PRODUCT_IN_EDICOLA != null) {
													openProductDetails(_PRODUCT_IN_EDICOLA.productId);
												}
											});

							omnitureTrackApp('APP:edicola:loadProducts',
									'APP:edicola');

							// aggiornamento impostazioni in base a risultato
							// getProducts
							impostazioniInizializza();
						} else {

							// c'è un errore nella risposta
							_EDICOLA_LAST_PRODUCT_LOAD = null;
							abutils
									.alert(
											'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
											'Errore');

						}

					},
					error : function() {

						// probabile timeout
						_EDICOLA_LAST_PRODUCT_LOAD = null;
						abutils
								.alert(
										'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
										'Errore');

					}
				});
	} catch (exc) {
		console.log("error::load: " + exc.message);
		abutils
				.alert(
						'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
						'Errore');
	}
}

/**
 * Gestisce il caricamento dell'anteprima dei prodotti nell'edicola Utilizza le
 * seguenti chiamate: - ajaxErrorHandler per la gestione degli errori di
 * comunicazione con API24
 */
var _EDICOLA_LAST_PRODUCT_LOAD = null;
function loadProducts() {

	if ((_EDICOLA_LAST_PRODUCT_LOAD != null)
			&& (Math.abs(_EDICOLA_LAST_PRODUCT_LOAD - (new Date().getTime())) < _INTERVALLO_CHECK_PRODUCTS)) {
		console.log('loadProducts NON necessario per data');
		return;
	}

	_EDICOLA_LAST_PRODUCT_LOAD = new Date().getTime();

	if (_EDICOLA_USE_CATEGORIES) {
		loadCategories();
		return;
	} else {
		loadProductsByCategory(null);
		return;
	}

	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$
				.ajax({
					type : "GET",
					cache : false,
					timeout : _AJAX_TIMEOUT,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "products.json",
					headers : req_headers,
					data : req_data,
					dataType : "json",
					success : function(p_response) {
						$('#edicola_container').empty();
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log("--RESP--> getProducts");
						console.log("getProducts "
								+ /* JSON.stringify( */p_response/* ) */);
						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response)) {
							// console.log('ajax success');
							var res = p_response.Result.res;
							_EDICOLA_REFRESH_PRODUCTS = false;
							_EDICOLA_PRODUCTS_COUNT = res.products.length;
							var l_edicola_container = document
									.getElementById('edicola_container');
							for ( var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
								var pid = res.products[i].productId;
								_EDICOLA_PRODUCTS_DETAILS[pid] = {};
								/* new Array(); */
								// _EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] =
								// res.products[i].inApp != true;
								_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
								_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
								_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
								_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

								if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']
										&& _PRODUCTLINK) {
									if (_PRODUCTLINK[0]['linkType'])
										_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
								}

								// alert('is
								// '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

								// Creazione elemento "edicola_prodotto_box"
								var pbox = document.createElement('div');
								pbox.id = 'edicola_prodotto_box_' + pid;
								if (_EDICOLA_CATALOGO_SMALL) {
									pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
								} else {
									pbox.className = 'edicola_prodotto_box';
								}
								l_edicola_container.appendChild(pbox);

								var pbox_container = document
										.createElement('div');
								pbox.appendChild(pbox_container);
								pbox_container.className = 'edicola_prodotto_box_container';

								// Creazione container icona prodotto
								var pbox_icon = document.createElement('div');
								pbox_container.appendChild(pbox_icon);
								pbox_icon.className = 'edicola_prodotto_box_icon';
								pbox_icon.id = 'edicola_prodotto_box_icon_'
										+ pid;

								// Creazione immagine icona prodotto
								var pbox_icon_img = document
										.createElement('img');
								pbox_icon.appendChild(pbox_icon_img);
								// pbox_icon_img.src = i % 5 == 0 ?
								// 'imgs/fake/prodotto_icon_appstore.png' : (i %
								// 2 == 0 ?
								// 'imgs/fake/prodotto_icon_standard.png' :
								// 'imgs/fake/prodotto_icon_quotidiano.png');
								pbox_icon_img.src = res.products[i].icon;
								pbox_icon_img = null;

								_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

								// Nel caso in cui il prodotto sia esterno viene
								// creata l'icona appstore
								// if
								// (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'])
								// {
								if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
									// icona small appstore
									var pbox_icon_appstore = document
											.createElement('div');
									pbox_icon.appendChild(pbox_icon_appstore);
									pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
									pbox_icon_appstore = null;

									_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_in_appstore';
								} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

									_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_prodotto_webpage';
								} else {
									// Viene aggiunta una classe utile per il
									// filtraggio dei prodotti
									pbox.className += ' edicola_non_in_appstore';
								}

								// Titolo del prodotto
								var pbox_text = document.createElement('div');
								pbox_text.id = 'edicola_prodotto_box_text_'
										+ pid;
								pbox_text.className = 'edicola_prodotto_box_text';
								pbox_container.appendChild(pbox_text);
								pbox_text
										.appendChild(document
												.createTextNode(res.products[i].productName));

								// Viene associato l'evento di apertura del
								// dettaglio prodotto
								pbox.onclick = (function(pid) {
									return function() {
										openProductDetails(pid);
									}
								})(pid);

								pbox_text = null;
								pbox_icon = null;
								pbox_container = null;
								pbox = null;
							}

							$('#edicola_container')
									.fadeIn(
											200,
											function() {
												updateEdicolaProductsIscroll();

												// Se il prodotto principale è
												// stato impostato, viene aperto
												// il relativo dettaglio
												var l_prodotto_principale_id = window.localStorage
														.getItem("prodotto_principale_id");
												if (l_prodotto_principale_id
														&& l_prodotto_principale_id != '') {
													openProductDetails(l_prodotto_principale_id);
												} else if (_PRODUCT_IN_EDICOLA != null) {
													openProductDetails(_PRODUCT_IN_EDICOLA.productId);
												}
											});

							omnitureTrackApp('APP:edicola:loadProducts',
									'APP:edicola');

							// aggiornamento impostazioni in base a risultato
							// getProducts
							impostazioniInizializza();
						} else {

							// c'è un errore nella risposta
							_EDICOLA_LAST_PRODUCT_LOAD = null;
							abutils
									.alert(
											'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
											'Errore');

						}

					},
					error : function() {

						// probabile timeout
						_EDICOLA_LAST_PRODUCT_LOAD = null;
						abutils
								.alert(
										'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
										'Errore');

					}
				});

	} catch (exc) {
		_EDICOLA_LAST_PRODUCT_LOAD = null;
		abutils
				.alert(
						'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
						'Errore');
	}

}

/**
 * Inizializza il controllo per l'aggiornamento dei prodotti attivando un flag
 * per l'aggiornamento dei dati quando l'utente clicca sul pulsante edicola
 * della barra menu
 */
function initCheckProducts() {
	console.log("initCheckProducts");
}

function updateEdicolaProductsIscroll() {
	var pboxes = $('#edicola_container .edicola_prodotto_box');

	if ((pboxes.length == 0) || (_EDICOLA_PRODUCTS_COUNT == 0)) {
		$('#edicola_container').width(
				_EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width()
						: (_ORIENTATION == 'V' ? '100%' : '100%'));
	} else {
		if (_ORIENTATION == 'V') {
			$('#edicola_catalogo').css('left', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('top',
						'-' + ($('#centrale').height() - 180) + 'px');
				$('#edicola_container').width(
						$(pboxes[0]).outerWidth(true) * pboxes.length);
			} else {
				$('#edicola_catalogo').css('top', '1px');
				$('#edicola_container').width('100%');
			}
		} else {
			$('#edicola_catalogo').css('top', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('left',
						($('#centrale').width() - 200) + 'px');
				$('#edicola_container').width($('#edicola_wrapper').width());
			} else {
				$('#edicola_catalogo').css('left', '1px');
				$('#edicola_container').width('100%');
			}
		}
	}

	if (_EDICOLA_PRODUCTS_ISCROLL == null) {
		_EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_PRODUCTS_ISCROLL.refresh();
	}

	if (_EDICOLA_DESCR_ISCROLL != null)
		_EDICOLA_DESCR_ISCROLL.refresh();
	if (_ABBONAMENTI_ISCROLL != null)
		_ABBONAMENTI_ISCROLL.refresh();
}

var _PRODUCT_DETAILS_COVERFLOW = null;
function openProductDetails(productId) {

	if (_LockTap)
		return;
	_LockTap = true;

	console.log("openProductDetails " + productId);
	if (_EDICOLA_PRODUCTS_DETAILS[productId] == null) {
		_LockTap = false;
		return;
	}

	$('#edicola_prodotto').attr(
			'class',
			'edicola_prodotto_type_'
					+ _EDICOLA_PRODUCTS_DETAILS[productId].type);

	$('.edicola_prodotto_box_icon').removeClass(
			'edicola_prodotto_box_icon_selected');
	$('#edicola_prodotto_box_icon_' + productId).addClass(
			'edicola_prodotto_box_icon_selected');
	if (!_EDICOLA_CATALOGO_SMALL) {
		edicolaCatalogoSwitchView();
	}

	if (_PRODUCT_DETAILS_COVERFLOW != null) {
		_PRODUCT_DETAILS_COVERFLOW.destroy();
		_PRODUCT_DETAILS_COVERFLOW = null;
	}

	$('#edicola_prodotto').hide();

	// elimino prodotto precedente
	$('#edicola_prodotto_titolo_content').empty();
	$('#edicola_prodotto_coverflow_box').empty();
	$('#edicola_prodotto_btns').empty();
	// $('#edicola_prodotto_descr').empty();
	$('#edicola_prodotto_descr_container').empty();
	$('#edicola_prodotto_adv_content').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> getProductDetails(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "products/" + productId + ".json",
				headers : l_request_headers,
				data : l_request_data,
				dataType : "json",
				success : function(p_response) {
					// try{
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('--RESP--> getProductDetails(' + productId
							+ ')');
					console.log('--RESP--> getProductDetails '
							+ JSON.stringify(p_response));

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						_LockTap = false;
						openProductDetails(productId);
					})) {
						// try{
						console.log("OK response openProductDetails " + /* JSON.stringify( */
						p_response.Result.res/* ) */);
						// var risposta="{\"productName\":\"Il Sole 24
						// Ore\",\"productId\":\"a1\",\"productDescription\":\"Il
						// Sole 24 ORE è il più autorevole strumento di
						// informazione economica in Italia. Un resoconto chiaro
						// e completo dei fatti che contano. Un aiuto
						// insostituibile per orientarsi nel complesso mondo
						// della finanza, delle normative e dei mercati
						// economici mondiali. Il Sole 24 ORE: l'informazione va
						// oltre il
						// quotidiano!\",\"subscription\":true,\"free\":false,\"singleOffers\":[{\"offerId\":\"QUOTIDIANOSINGOLO\",\"offerDescription\":\"copia
						// singola\",\"offerPrice\":1.59,\"offerItunesProductId\":\"MOBAPP_S24_SINGLE_S24_20120720\"}],\"testata\":\"S24\",\"showarchivio\":\"1\",\"editionId\":\"20120720\",\"editionDescription\":\"20
						// Luglio
						// 2012\",\"pubDate\":\"20120720\",\"inserts\":[{\"description\":\"Il
						// Sole 24
						// Ore\",\"insertId\":\"SOLE\",\"cover\":\"http://212.45.97.204/_deploy/S24/20120720/SOLE/cover_high.jpg\",\"anteprima\":0}],\"single\":true,\"demo\":false,\"editionTitle\":\"venerdì
						// 20 luglio
						// 2012\",\"subscriptionOffers\":[{\"offerId\":\"QOL_CANONE_7GG\",\"offerDescription\":\"alla
						// settimana\",\"offerPrice\":9.99,\"offerItunesProductId\":\"http://shopping24.dlv.24orepro.in.ilsole24ore.it/sh4/mobile/android/addToCart.jsp?url_catalog_ref_id=sku1790109&url_product_id=prod1250025\"},{\"offerId\":\"QOL_ABBONAMENTO_MENSILE_PAG\",\"offerDescription\":\"all'anno
						// mensilizzato\",\"offerPrice\":31.99,\"offerItunesProductId\":\"url1\"},{\"offerId\":\"QOL_CANONE_30GG\",\"offerDescription\":\"al
						// mese\",\"offerPrice\":34.99,\"offerItunesProductId\":\"url2\"},{\"offerId\":\"QOL_ABBONAMENTO_ANNUALE_PAG\",\"offerDescription\":\"all'anno\",\"offerPrice\":319.99,\"offerItunesProductId\":\"url3\"}],\"serviceName\":\"products\",\"elapsedTime\":9}";
						schedaProdotto(p_response.Result.res);
						// schedaProdotto($.parseJSON(risposta));
						$('#edicola_prodotto').fadeIn('normal', function() {
							_LockTap = false;
						});
						loadAdvCatalogo(productId);
						loadAdvTabbar(productId);
						window.product.setProduct(productId);
						// }catch(exc){
						// alert(exc.message);
						// }
					} else {
						abutils
								.alert(
										'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
										'Errore');
					}
				},
				error : function() {
					_LockTap = false;
					abutils
							.alert(
									'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
									'Errore');
				}
			});

	// carico link store android
	loadlink(productId);
}

// carico i link dello store per gli offerItunesProductId
function loadlink(productId) {
	console.log("loadlink " + productId);

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> loadlink(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "products/links/" + productId
						+ ".json",
				headers : l_request_headers,
				data : l_request_data,
				dataType : "json",
				success : function(p_response) {
					// try{
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					// console.log('--RESP--> url_loadlink ' + _SOLEGW_ENDPOINT
					// + "products/links/" + productId +
					// ".json?appKey="+_API24_APPKEY);
					console.log('--RESP--> loadlink(' + productId + ')');
					console.log('--RESP--> loadlink ' + p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						loadlink(productId);
					})) {
						console
								.log("OK response loadlink "/* +JSON.stringify(p_response) */);
						loadLinkProdotto(p_response.Result.res);
					} else {
						console
								.log('Si è verificato un errore nella comunicazione con il server');
					}
				},
				error : function() {
					console
							.log('Si è verificato un errore nella comunicazione con il server');
				}
			});

}

// Si popola _PRODUCTLINK per l'acquisto
_PRODUCTLINK = [];
function loadLinkProdotto(p_product) {
	console.log("loadLinkProdotto " + p_product.storeLinkItemsList.length + ','
			+ JSON.stringify(p_product.storeLinkItemsList));
	for ( var i = 0; i < p_product.storeLinkItemsList.length; i++) {
		_PRODUCTLINK[i] = {};
		// name
		_PRODUCTLINK[i]['name'] = p_product.storeLinkItemsList[i]['name'];
		// url
		_PRODUCTLINK[i]['url'] = p_product.storeLinkItemsList[i]['url'];
		// productId
		_PRODUCTLINK[i]['productId'] = p_product.storeLinkItemsList[i]['productId'];
		// linkType
		_PRODUCTLINK[i]['linkType'] = p_product.storeLinkItemsList[i]['linkType'];
	}

	console.log("_PRODUCTLINK is  len ::: " + _PRODUCTLINK.length + " :::");
	console.log("_PRODUCTLINK[linkType] is "
			+ ((_PRODUCTLINK) ? _PRODUCTLINK[0]['linkType'] : ""));
}

/**
 * Aggiorna la scheda del prodotto se necessario
 */
function refreshProductDetails() {
	if ((_EDICOLA_CATALOGO_SMALL == true) && (_PRODUCT_IN_EDICOLA != null)) {
		schedaProdotto(_PRODUCT_IN_EDICOLA);
	}
}

/**
 * Crea la scheda del prodotto
 */
// var _EDICOLA_DESCR_ISCROLL = null;
function schedaProdotto(p_product) {
	try {

		console.log("openProductDetails p_product is " + p_product + ','
				+ p_product.productId);

		if (_PRODUCT_DETAILS_COVERFLOW != null) {
			_PRODUCT_DETAILS_COVERFLOW.destroy();
			_PRODUCT_DETAILS_COVERFLOW = null;
		}
		$('#edicola_prodotto_titolo_content').empty();
		$('#edicola_prodotto_coverflow_box').empty();
		$('#edicola_prodotto_btns').empty();
		$('#edicola_prodotto_descr_container').empty();
		$('#edicola_prodotto_adv_content').empty();

		_PRODUCT_IN_EDICOLA = p_product;

		_HASH_MAP_TESTATA_PRODUCTID[p_product.testata] = p_product.productId;

		_MAP_CODICE_TESTATA[p_product.productId + ''] = p_product.testata;

		// titolo
		$('#edicola_prodotto_titolo_content').empty();
		$('<h1>' + p_product.productName + '</h1>').appendTo(
				'#edicola_prodotto_titolo_content');
		$(
				'<h2>'
						+ (p_product.editionDescription != null ? 'Edizione del '
								+ p_product.editionDescription
								: '') + '</h2>').appendTo(
				'#edicola_prodotto_titolo_content');

		// Coverflow
		$('#edicola_prodotto_coverflow_box').empty();
		var l_covers_list = [];
		var l_num_covers = p_product.inserts.length;
		for ( var i = 0; i < l_num_covers; i++) {
			l_covers_list[i] = {
				'src' : p_product.inserts[i].cover,
				'code' : p_product.inserts[i].insertId,
				'description' : p_product.inserts[i].description,
				'anteprima' : p_product.inserts[i].anteprima
						&& (parseInt(p_product.inserts[i].anteprima) > 0)
						&& !(p_product.free || p_product.subscription),
				'abbonati' : p_product.inserts[i].premium
						&& (parseInt(p_product.inserts[i].premium) > 0)
			}
		}
		_PRODUCT_DETAILS_COVERFLOW = new CoveerFlow(
				'edicola_prodotto_coverflow_box', l_covers_list);

		console.log("_PRODUCT_DETAILS_COVERFLOW is "
				+ _PRODUCT_DETAILS_COVERFLOW);

		// bottoni
		$('#edicola_prodotto_btns').empty();
		if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "store") {
			$(
					'<a href="'
							+ _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link']
							+ '" ><img src="imgs/edicola_catalogo_appstore_logo.png" /></a>')
					.appendTo('#edicola_prodotto_btns');
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				window.location = _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'];
			}
		} else if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "webpage") {
			// $('<a href="' +
			// _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] +
			// '?deviceId=' + encodeURIComponent(device.uuid) + '&appname=' +
			// encodeURIComponent(device.appname) + '&appversion=' +
			// encodeURIComponent(device.appversion) + '&deviceType=' +
			// encodeURIComponent(device.platform) + '" ><img
			// src="imgs/edicola_catalogo_webpage_logo.png"
			// /></a>').appendTo('#edicola_prodotto_btns');
			$(
					'<a href="'
							+ _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link']
							+ '?deviceId='
							+ encodeURIComponent(device.uuid)
							+ '&deviceName='
							+ encodeURIComponent(device.name)
							+ '&appname='
							+ encodeURIComponent(device.appname)
							+ '&appversion='
							+ encodeURIComponent(device.appversion)
							+ '&deviceType='
							+ encodeURIComponent(device.platform)
							+ '" class="button red24 commonGenericButton" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>')
					.appendTo('#edicola_prodotto_btns');
		} else {
			// metto possibilità di tappare dirrettamente sulla cover
			// dell'inserto
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				console
						.log('TAP ON COVERFLOW: '
								+ p_product.testata
								+ ' '
								+ p_product.editionId
								+ ' '
								+ p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				tapOnAnInsert(p_product);
			}
			// nascondo i bottoni, vengono mostrati quando si sa se è sfoglia o
			// acquisto copia singola
			$('#edicola_prodotto_btns').css('display', 'none');

			console
					.log('verifica is '
							+ p_product.productId
							+ ','
							+ p_product.subscriptionOffers.length
							+ ','
							+ (p_product.subscriptionOffers && p_product.subscriptionOffers.length));

			// Se ci sono delle offerte
			if (p_product.subscriptionOffers
					&& p_product.subscriptionOffers.length) {
				$(
						'<button class="button medium red24 prodotto_dettaglio_abbonamenti">Abbonamenti</button>')
						.click(function() {
							popupAcquistoAbbonamenti(p_product);
						}).appendTo('#edicola_prodotto_btns');

				for ( var i = 0; i < p_product.subscriptionOffers.length; i++) {
					// appstoreReqProduct(p_product.subscriptionOffers[i].offerId,
					// p_product.subscriptionOffers[i].offerItunesProductId)
				}
			}

			// Se c'è la possibilità di acquistare solo un numero viene aggiunto
			// il pulsante per l'acquisto della singola copia
			console.log('productsingle is ' + JSON.stringify(p_product.single));
			if (p_product.single) {
				// for (var i = 0; i < p_product.singleOffers.length; i++) {
				for ( var i = 0; i < p_product.singleOffers.length; i++) {
					// creaPulsanteAcquistoSingolo(p_product.singleOffers[i]);
					// $('<button class="button red24
					// prodotto_dettaglio_acquisto">' +
					// p_product.singleOffers[i].offerPrice + '
					// €</button>').click(function(){
					$(
							'<button class="button medium red24 prodotto_dettaglio_acquisto">'
									+ ab_euro_formatter(p_product.singleOffers[i].offerPrice)
									+ '</button>')
							.click(
									function() {

										if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium
												&& (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
											mostraPopupInsertoAbbonati();
										} else {
											acquistoSingolo(
													p_product.testata,
													p_product.editionId,
													p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId,
													p_product.singleOffers[i].offerId,
													p_product.singleOffers[i].offerItunesProductId);
										}

									}).appendTo('#edicola_prodotto_btns');

					// appstoreReqProduct(p_product.singleOffers[i].offerId,
					// p_product.singleOffers[i].offerItunesProductId);

					break;
					// <--- visualizzo una sola offerta
				}
			}

			// appstoreReqProducts();

			$(
					'<button class="button medium red24 prodotto_dettaglio_sfoglia">Sfoglia</button>')
					.click(
							function() {
								var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium
										&& (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);
								if ((!p_product.subscription)
										&& l_edizione_premium) {
									sfogliaCheckPremium(
											p_product.testata,
											p_product.editionId,
											p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
								} else {
									sfoglia(
											p_product.testata,
											p_product.editionId,
											p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
								}
							}).appendTo('#edicola_prodotto_btns');

			$('<br />').appendTo('#edicola_prodotto_btns');

			// Archivio
			$(
					'<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" /> Consulta l\'archivio</button>')
					.click(
							function() {
								if (_LockTap)
									return;
								_LockTap = true;

								console.log("CLICK CONSULTA ARCHIVIO");
								// archivio standard al momento non utilizzato
								if (p_product.productId == _CODICE_PRODOTTO_QUOTIDIANO/* '3' */) {// CORRETTO????
									// chiamata per aprire archivio STANDARD
									qarchivioOpen(p_product.productId);
								} else {
									// chiamata per aprire archivio QUOTIDIANO
									console
											.log('archivioOpen p_product.productId'
													+ p_product.productId);
									archivioOpen(p_product.productId);
								}

								_LockTap = false;
							}).appendTo('#edicola_prodotto_btns');

			var consultaBtn = $('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;"><img src="imgs/archive2.png" width="15" height="14" /> Consulta l\'archivio</button>');

			checkLocalProductForBtnsRender(p_product);
			console.log(" _PRODUCT_DETAILS_COVERFLOW");
		}

		// Descrizione prodotto
		if (_EDICOLA_DESCR_ISCROLL != null) {
			_EDICOLA_DESCR_ISCROLL.destroy();
			_EDICOLA_DESCR_ISCROLL = null;
		}

		$('#edicola_prodotto_descr_container').empty();
		console.log("descr " + p_product.productDescription);
		// alert("descr "+p_product.productDescription);
		$('<p>' + p_product.productDescription + '</p>').appendTo(
				'#edicola_prodotto_descr_container');

		if (_EDICOLA_DESCR_ISCROLL == null) {
			setTimeout(function() {
				_EDICOLA_DESCR_ISCROLL.refresh();
			}, 100);
			// console.log("1edicolaSSSSSSSasd
			// "+$('#edicola_prodotto_descr_container').outerHeight());
			_EDICOLA_DESCR_ISCROLL = new iScroll('edicola_prodotto_descr', {
				hScroll : false,
				vScroll : true,
				hScrollbar : false,
				bounce : false
			});
			// _EDICOLA_DESCR_ISCROLL.refresh();
		}
		console.log("2edicola descr iscroll is "
				+ $('#edicola_prodotto_descr_container').html()
				+ "::: _EDICOLA_DESCR_ISCROLL " + _EDICOLA_DESCR_ISCROLL);
		// alert("aaa "+ $('#edicola_prodotto_descr_container').html() );
		omnitureTrackApp('APP:edicola:loadProduct:' + p_product.productId,
				'APP:edicola');

		console.log(" _PRODUCT_DETAILS_COVERFLOW is "
				+ _PRODUCT_DETAILS_COVERFLOW);
	} catch (exc) {
		console.log(exc.message);
	}
}

function checkLocalProductForBtnsRender(p_product) {
	try {

		var l_testata = p_product.testata;
		var l_issue = p_product.editionId;
		var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

		console.log('xok0');

		if (_DB) {
			console.log('xok');
			/* console.log('aaa_ant '+$('.coveerflow_anteprima').html()); */
			var querySuccess = function(tx, p_results) {
				// alert('asd ' + JSON.stringify(p_results.rows));
				var len = p_results.rows.length;
				// console.log("checkLocalProductForBtnsRender: testata: " +
				// l_testata + " issue: " + l_issue + " edizione: " + l_edizione
				// + ", letti record: " + len);
				if ((len > 0) || p_product.free || p_product.subscription) {
					// solo bottone sfoglia
					$('#edicola_prodotto_btns .prodotto_dettaglio_acquisto')
							.css('display', 'none');
					/*
					 * console.log('aaa_ant
					 * '+$('.coveerflow_anteprima').html());
					 */
					$('.coveerflow_anteprima').css('display', 'none');
					// alert('aaa_sed' + p_product.free +','+
					// p_product.subscription );
				} else {
					// acquisto copia singola
					$('#edicola_prodotto_btns .prodotto_dettaglio_sfoglia')
							.css('display', 'none');
					$('.coveerflow_anteprima').css('display', 'inline-block');
				}
				console.log('xok1');
				$('#edicola_prodotto_btns').css('display', 'inline-block');
			}
			var queryError = function(p_error) {
				console.log("preferitiLoadArticles: Error processing SQL: "
						+ p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql(
						'SELECT * FROM issues WHERE testata=? and issue=?', [
								l_testata, l_issue ], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function mostraPopupInsertoAbbonati() {
	abutils.alert('Per poter leggere questo inserto devi essere abbonato.',
			'Inserto per abbonati');
}

function sfogliaCheckPremium(p_testata, p_issue, p_edizione) {
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			if (len > 0) {
				sfoglia(p_testata, p_issue, p_edizione);
			} else {
				mostraPopupInsertoAbbonati();
			}
		}
		var queryError = function(p_error) {
			sfoglia(p_testata, p_issue, p_edizione);
		}
		var executeQuery = function(tx) {
			tx
					.executeSql(
							'SELECT * FROM issues WHERE testata=? and issue=? and edizione=?',
							[ p_testata, p_issue, p_edizione ], querySuccess,
							queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function tapOnAnInsert(p_product) {
	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium
			&& (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// se la issue è gratuita o è coperta da abbonamento...
			if (p_product.free || p_product.subscription) {
				// si apre lo sfoglio...
				sfoglia(l_testata, l_issue, l_edizione);
			} else {
				// se la issue è presente in locale (o lo è uno dei suoi
				// inserti)...
				if (len > 0) {
					// controllo se è in locale proprio questa issue
					_DB
							.transaction(
									function(tx) {
										tx
												.executeSql(
														'SELECT * FROM issues WHERE testata=? and issue=? and edizione=?',
														[ l_testata, l_issue,
																l_edizione ],
														function(tx, p_results) {
															var len = p_results.rows.length;
															if (len > 0) {
																// la copia è in
																// locale
																sfoglia(
																		l_testata,
																		l_issue,
																		l_edizione);
															} else {
																// la copia non
																// è ancora in
																// locale
																if (l_edizione_premium) {
																	mostraPopupInsertoAbbonati();
																} else {
																	sfoglia(
																			l_testata,
																			l_issue,
																			l_edizione);
																}
															}
														},
														function() {
															sfoglia(l_testata,
																	l_issue,
																	l_edizione);
														});
									},
									function() {
										sfoglia(l_testata, l_issue, l_edizione);
									});
					/*
					 * if ((!p_product.subscription) && l_edizione_premium) {
					 * sfogliaCheckPremium(l_testata, l_issue, l_edizione); }
					 * else { sfoglia(l_testata, l_issue, l_edizione); }
					 */
				} else {
					// se è disponibile l'anteprima
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima
							&& (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima) > 0)) {
						// apro l'anteprima
						openAnteprima(
								p_product.testata,
								p_product.editionId,
								p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId,
								parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima));
					} else {
						// altrimenti se sono presenti degli abbonamenti ...
						if (p_product.subscriptionOffers.length) {
							// si aprono le offerte commerciali ...
							popupAcquistoAbbonamenti(p_product);
						} else {
							// altrimenti se è presente la possibilità di
							// acquisto come copia singola ...
							if (p_product.single
									&& (p_product.singleOffers.length > 0)) {
								// si passa all'acquisto della copia singola ...
								if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium
										&& (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
									mostraPopupInsertoAbbonati();
								} else {
									acquistoSingolo(
											p_product.testata,
											p_product.editionId,
											p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId,
											p_product.singleOffers[0].offerId,
											p_product.singleOffers[0].offerItunesProductId);
								}
							} else {
								// niente da fare...
							}
						}
					}
				}
			}
		}
		var queryError = function(p_error) {

		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [
					l_testata, l_issue ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

// DA CAMBIAREEEEEEEEEEEEEEEEEEEEEEEEEE***************************************
function openAnteprima(p_testata, p_issue, p_edizione, p_anteprima) {
	// openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
	console.log('anteprimaaaa');
	openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
}

function sfoglia(p_testata, p_issue, p_edizione, p_pagina) {
	if (_LockTap)
		return;
	_LockTap = true;

	if (typeof p_pagina == undefined || p_pagina == null) {
		p_pagina = '1';
	}
	console.log('pagina sfoglia ' + p_pagina);
	// alert('pagina sfoglia ' + p_pagina);

	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Attendere..." ]);
	// APRO LO SFOGLIO ANDROID
	try {
		// window.loader.launchSfogliatore("S24", "SOLE", "20111011",
		// "Descrizione");
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		// alert("style: "+node.style.display);
		if (node.style.display == 'block'
				|| node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if (typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		console.log("sfoglia " + p_testata + "," + p_edizione + "," + p_issue
				+ "," + "Descrizione" + window.localStorage.getItem(keyinput)
				+ "," + "aaaa" + "," + null);

		if (p_pagina != '1')
			window.soledownloader.launchDownload(p_testata, p_edizione,
					p_issue, "Descrizione"
							+ window.localStorage.getItem(keyinput), ""
							+ "aaaa", null, p_pagina);
		else
			window.soledownloader.launchDownload(p_testata, p_edizione,
					p_issue, "Descrizione"
							+ window.localStorage.getItem(keyinput), ""
							+ "aaaa", null);
	} catch (exc) {
		// alert(exc.message);
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}

	// Chiude eventuali schermate aperte

	setTimeout(function() {

		qarchivioClose();
		_LockTap = false;
	}, 1500);

}

function scarica(p_testata, p_issue, p_edizione) {
	sfoglia(p_testata, p_issue, p_edizione);
}

function eliminaCopiaLocale(p_testata, p_issue, p_edizione) {
	if (_LockTap)
		return;
	_LockTap = true;

	var type = ($('#edicola_offline_subtitolo_opzioni_vista_ICONS')
			.hasClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on')) ? 'ICONS'
			: 'LIST';
	// alert("Elimina copia locale testata: " + p_testata + " issue: " +
	// p_issue+ " edizione: " + p_edizione);
	window.simulatePG.confirm('Sei sicuro?', "eliminaCopiaLocaleSucc('"
			+ p_testata + "','" + p_issue + "','" + p_edizione + "', '" + type
			+ "')", 'Cancellazione issue', 'Si,No');

	setTimeout(function() {
		_LockTap = false;
	}, 2000);
}

function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes,
		p_pagina, p_forceSkipOneshotCheck) {
	if (!p_forceSkipOneshotCheck)
		p_forceSkipOneshotCheck = false;
	if (false/*
				 * _ONESHOT_CHECK_REGISTRATO && !_USERNAME &&
				 * !p_forceSkipOneshotCheck
				 */) {
		_NEXT_ACTION = function() {
			acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta,
					p_itunes, p_pagina);
		}
		popupAcquistoRegistrazione(p_testata);
	} else {
		acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta,
				p_itunes, p_pagina);
	}
}

var _CURRENT_FLIPPER_TESTATA = null;
var _CURRENT_FLIPPER_ISSUE = null;
var _CURRENT_FLIPPER_EDIZIONE = null;
var _CURRENT_FLIPPER_PAGINA = null;
function setFlipperCurrentState(p_testata, p_issue, p_edizione, p_pagina) {
	if (p_testata == null)
		console.log('setFlipperCurrentState null*4');
	else
		console.log('setFlipperCurrentState ' + p_testata + ' ' + p_issue + ' '
				+ p_edizione + ' ' + p_pagina);
	_CURRENT_FLIPPER_TESTATA = p_testata;
	_CURRENT_FLIPPER_ISSUE = p_issue;
	_CURRENT_FLIPPER_EDIZIONE = p_edizione;
	_CURRENT_FLIPPER_PAGINA = p_pagina;
}

function openFlipper(testata, issue, edizione, pagina, anteprima) {
	if (_LockTap)
		return;
	_LockTap = true;
	try {

		if (anteprima == null || anteprima == 0)
			anteprima = false;
		else
			anteprima = true;

		console.log("openflipper");
		var l_fast_loading = false;

		if ((testata == null) && (issue == null) && (edizione == null)) {
			testata = _CURRENT_FLIPPER_TESTATA;
			issue = _CURRENT_FLIPPER_ISSUE;
			edizione = _CURRENT_FLIPPER_EDIZIONE;
			pagina = _CURRENT_FLIPPER_PAGINA;
			l_fast_loading = true;
		}

		if ((testata == null) || (issue == null) || (edizione == null)) {
			return false;
		}

		if (pagina == null)
			pagina = 1;

		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Attendere..." ]);

		setTimeout(
				function() {

					if (anteprima) {
						_CURRENT_FLIPPER_TESTATA = null;
						_CURRENT_FLIPPER_ISSUE = null;
						_CURRENT_FLIPPER_EDIZIONE = null;
						_CURRENT_FLIPPER_PAGINA = null;
					} else {
						_CURRENT_FLIPPER_TESTATA = testata;
						_CURRENT_FLIPPER_ISSUE = issue;
						_CURRENT_FLIPPER_EDIZIONE = edizione;
						_CURRENT_FLIPPER_PAGINA = pagina;
					}

					var keyinput = "unread_message_sole";
					var valoutput = 0;

					var node = document.getElementById('appmenu_inbox_count');
					if (node.style.display == 'block'
							|| node.style.display == 'inline-block') {
						valoutput = 1;
					} else {
						valoutput = 0;
					}

					if (typeof (window.localStorage) != 'undefined') {
						window.localStorage.setItem(keyinput, valoutput);
					} else {
						throw "window.localStorage, not defined";
					}

					// VERIFICA****************************************
					removeToDownloadQueue(testata, edizione, issue);

					console.log(_CURRENT_FLIPPER_TESTATA + ','
							+ _CURRENT_FLIPPER_EDIZIONE + ','
							+ _CURRENT_FLIPPER_ISSUE + ','
							+ _CURRENT_FLIPPER_PAGINA);

					if (!anteprima) {
						window.loader.launchSfogliatore(
								_CURRENT_FLIPPER_TESTATA,
								_CURRENT_FLIPPER_EDIZIONE,
								_CURRENT_FLIPPER_ISSUE, "Descrizione"
										+ valoutput, _CURRENT_FLIPPER_PAGINA,
								'true');
					} else {
						console.log('anteprima launch');
						window.soledownloader.launchAnteprimaSfogliatore(
								testata, edizione, issue, "Descrizione"
										+ valoutput, null, null);
					}

					setTimeout(
							function() {
								// window.go.to(_CURRENT_FLIPPER_PAGINA);

								// chiudo eventuali schermate aperte
								qarchivioClose();
								archivioClose();
								popupAcquistoAbbonamentiClose();
								popupAcquistoRegistrazioneClose();

								window.simulatePG.exec(null, null,
										"Notification", "activityStop", []);
								omnitureTrackApp('APP:edicola:open:' + testata
										+ ':' + issue + ':' + edizione
										+ (anteprima ? ':PREVIEW' : ''),
										'APP:edicola');
								nielsenCall('SFOGLIATORE');
								_LockTap = false;
							}, 3000);

				}, 250);

		return true;
	} catch (exc) {
		console.log(exc.message);
		return false;
	}
}

/*
 * Controlla se un prodotto sia stato scaricato in locale ed in caso abilita il
 * pulsante Sfoglia @params p_product Prodotto
 */
function checkLocalProduct(p_product) {

	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("checkLocalProduct: testata: " + l_testata + " issue: "
					+ l_issue + " edizione: " + l_edizione + ", letti record: "
					+ len);

			if (len) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				creaPulsanteSfoglia(p_product, false);
				// Se il prodotto/inserto è presente in locale avrò il pulsante
				// sfoglia in grigio
			} else if (p_product.free || p_product.subscription) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				// Se il prodotto/inserto non è presente in locale il pulsante
				// sfoglia sarà rosso
				creaPulsanteSfoglia(p_product, true);
			} else {
				// Vengono mostrati gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeIn(200);
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			// tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?
			// and edizione=?', [l_testata, l_issue, l_edizione], querySuccess,
			// queryError);
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [
					l_testata, l_issue ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function creaPulsanteSfoglia(p_product, p_red) {
	var l_pulsante = $('#edicola_prodotto_sfoglia_btn');

	if (!l_pulsante.length) {

		l_pulsante = $('<button id ="edicola_prodotto_sfoglia_btn" class="button">Sfoglia</button>');

		if (p_red) {
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.addClass('gray');
		}

		l_pulsante
				.click(function() {
					sfoglia(
							p_product.testata,
							p_product.editionId,
							p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				});

		l_pulsante.appendTo('#edicola_prodotto_btns');

	} else {
		if (p_red) {
			l_pulsante.removeClass('gray');
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.removeClass('red24');
			l_pulsante.addClass('gray');
		}
	}
}

var _EDICOLA_CATALOGO_SMALL = false;
function edicolaCatalogoSwitchView() {

	var isPortrait = window.innerWidth < window.innerHeight;
	_EDICOLA_CATALOGO_SMALL = !_EDICOLA_CATALOGO_SMALL;

	if (!_EDICOLA_CATALOGO_SMALL) {
		$('.edicola_prodotto_box_icon_selected').removeClass(
				'edicola_prodotto_box_icon_selected');
		_PRODUCT_IN_EDICOLA = null;
	}

	if (isPortrait) {
		if ($('#edicola_catalogo').css('top') == '1px') {
			$('#edicola_catalogo').animate({
				'top' : '-' + ($('#centrale').height() - 180) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'top' : '1px'
			});
		}
	} else {
		if ($('#edicola_catalogo').css('left') == '1px') {
			$('#edicola_catalogo').animate({
				'left' : ($('#centrale').width() - 200) + 'px'
			});
		} else {
			$('#edicola_catalogo').animate({
				'left' : '1px'
			});
		}
	}

	$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
	$('#edicola_container > .edicola_prodotto_box').toggleClass(
			'edicola_prodotto_box_small');
	$('#edicola_wrapper').toggleClass('edicola_wrapper_small');

	setTimeout(function() {
		updateEdicolaProductsIscroll();
	}, 0);

	if (_EDICOLA_DESCR_ISCROLL != null && !_EDICOLA_CATALOGO_SMALL) {
		_EDICOLA_DESCR_ISCROLL.destroy();
		_EDICOLA_DESCR_ISCROLL = null;
	}
}

/**
 * Filtra i prodotti in edicola.
 */
function edicolaFiltroProdotti() {
	var l_selected_option = $('#edicola_titolo_btn_select option:selected');

	if (l_selected_option.val() == '') {
		$('#edicola_container .edicola_prodotto_box').fadeIn(200);
	} else {
		$('#edicola_container .edicola_prodotto_box').not(
				'.' + l_selected_option.val()).css('display', 'none');
		$('#edicola_container .edicola_prodotto_box.' + l_selected_option.val())
				.fadeIn(200);
	}
}

/* --------- gestione drag&drop catalogo ----------- */
var _EDICOLA_TOUCH_START_POS_X = 0;
var _EDICOLA_TOUCH_START_POS_Y = 0;
var _EDICOLA_TOUCH_START_Y = 0;
var _EDICOLA_TOUCH_START_X = 0;
var _EDICOLA_TOUCH_MOVE_Y = 0;
var _EDICOLA_TOUCH_MOVE_X = 0;
var _EDICOLA_TOUCH_STARTED = false;
var _EDICOLA_TOUCH_MOVED = false;
function edicolaTouchStart(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_STARTED = true;
		_EDICOLA_TOUCH_MOVED = false;
		_EDICOLA_TOUCH_START_POS_X = $('#edicola_catalogo').offset().left;
		/* _EDICOLA_TOUCH_START_X = _event.clientX; */
		_EDICOLA_TOUCH_START_POS_Y = $('#edicola_catalogo').offset().top;
		_EDICOLA_TOUCH_START_X = _event.clientX;
		_EDICOLA_TOUCH_START_Y = _event.clientY;

	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMove(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_X = _event.clientX;
		var position = Math
				.max(
						0,
						Math
								.min(
										_EDICOLA_TOUCH_START_POS_X
												+ $('#edicola_wrapper')
														.position().left,
										(_EDICOLA_TOUCH_START_POS_X
												+ _EDICOLA_TOUCH_MOVE_X - _EDICOLA_TOUCH_START_X)));
		if (position < -($('#centrale').height() - 180))
			position = -($('#centrale').height() - 180);
		$('#edicola_catalogo').css('left', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMoveVertical(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_Y = _event.clientY;
		var position = Math.min(0, _EDICOLA_TOUCH_START_POS_Y
				+ _EDICOLA_TOUCH_MOVE_Y - _EDICOLA_TOUCH_START_Y);
		if (position < -($('#centrale').height() - 180))
			position = -($('#centrale').height() - 180);
		$('#edicola_catalogo').css('top', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchEnd(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		if (!_EDICOLA_TOUCH_MOVED)
			return;
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		_EDICOLA_TOUCH_STARTED = false;
		edicolaCatalogoSwitchView();

	} catch (exc) {
		console.log(exc.message);
	}
}

/*******************************************************************************
 * Gestione demo
 ******************************************************************************/
/**
 * Verifica che l'utente possa utilizzare la demo
 */
function verifyDemo() {
	console
			.log("---REQ---> verifyDemo (" + _PRODUCT_IN_EDICOLA.productId
					+ ")");

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	} else {
		_NEXT_ACTION = verifyDemo;
		// popupAccediRegistrati();
		popupAcquistoRegistrazione();
		return;
	}

	console.log(l_request_headers);
	console.log(l_request_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "products/demo/"
						+ _PRODUCT_IN_EDICOLA.productId + ".json",
				headers : l_request_headers,
				data : l_request_data,
				dataType : "json",
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> verifyDemo('
							+ _PRODUCT_IN_EDICOLA.productId + ')');
					console.log(p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, verifyDemo)) {
						if (p_response.Result.res.canUseDemo == true)
							useDemo();
					} else {
						abutils
								.alert(
										'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
										'Errore');
					}
				},
				error : function() {
					abutils
							.alert(
									'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
									'Errore');
				}
			});

}

/**
 * Utilizza la demo
 */
function useDemo() {
	console.log("---REQ---> useDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		'userIdentity' : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		'username' : _USERNAME
	}

	$
			.ajax({
				type : "POST",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "products/demo/"
						+ _PRODUCT_IN_EDICOLA.productId + ".json",
				headers : l_req_headers,
				dataType : "json",
				processData : false,
				data : JSON.stringify(l_req_data),
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('----> useDemo('
							+ _PRODUCT_IN_EDICOLA.productId + ')');
					console.log(p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, useDemo)) {
						// && p_response.Result.res.canUseDemo == true
						sfoglia(
								_PRODUCT_IN_EDICOLA.testata,
								_PRODUCT_IN_EDICOLA.editionId,
								_PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
						omnitureTrackApp(
								'APP:edicola:demo:'
										+ _PRODUCT_IN_EDICOLA.testata
										+ ':'
										+ _PRODUCT_IN_EDICOLA.editionId
										+ ':'
										+ _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId,
								'APP:edicola');
					} else {
						abutils
								.alert(
										'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
										'Errore');
					}
				},
				error : function() {
					abutils
							.alert(
									'Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.',
									'Errore');
				}
			});

}

_ABBONAMENTI_ISCROLL = null;
/* --------- gestione schermata acquisto ----------------- */

function popupAcquistoAbbonamentiClose() {
	// $('#acquisto_abbonamenti').fadeOut();
	$('#acquisto_abbonamenti').css('display', 'none');
	$('select').removeAttr('disabled');
}

var _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = null;
function popupAcquistoRegistrazione(p_testata) {
	console.log("REGISTRAZIONE" + p_testata);
	// -------INIZIO
	if (p_testata == 'S24') {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css(
				'display', 'none');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css(
				'display', 'block');
		document.getElementById('acquisto_registrazione_body').className = '';
	} else {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css(
				'display', 'block');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css(
				'display', 'none');
		document.getElementById('acquisto_registrazione_body').className = 'acquisto_registrazione_type_others';
	}
	// -------FINE
	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione_opzioni_acquisto')
			.css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	if (_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll(
				'acquisto_registrazione_wrapper', {
					bounce : false
				});
	} else {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is "
			+ _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL);
}

function popupAcquistoRegistrazioneClose() {
	// $('#acquisto_registrazione').fadeOut();
	console.log("REGISTRAZIONE chiusa");
	$('#acquisto_registrazione').css('display', 'none');
}

function acquistoAbbonamento(abbonamento) {
	popupAcquistoRegistrazione();
}

function popupAcquistoRegistrazioneRegistrati() {
	console.log("REGISTRAZIONE 1");
	popupRegistrazioneApri();
}

function procediAcquistoAbbonamento(p_product, p_offerta, p_itunes) {
	var l_testata = p_product.testata;
	if (!l_testata)
		l_testata = 'S24';
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
}

function acquistoAbbonamentiAgganciaAbbonamento() {

	_NEXT_ACTION = acquistoAbbonamentiAgganciaAbbonamento_done;

	popupLogin();

}

function acquistoAbbonamentiAgganciaAbbonamento_done() {
	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Aggancio abbonamento..." ]);
	// controllo stato abbonamento

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + _PRODUCT_IN_EDICOLA.productId);
	console.log(l_req_headers);
	console.log(l_req_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "subscription/"
						+ _PRODUCT_IN_EDICOLA.productId + ".json",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> subscription/'
							+ _PRODUCT_IN_EDICOLA.productId);
					console.log(p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						acquistoAbbonamentiAgganciaAbbonamento_done();
					})) {
						var l_attivo = false;
						var l_date_end = null;
						try {
							// if (p_response.Result.res.endDate == null)
							if (p_response.Result.res
									&& p_response.Result.res.details
									&& (p_response.Result.res.details.length > 0)
									&& p_response.Result.res.details[0].endDate) {
								l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

								l_attivo = l_date_end > new Date();
							} else {
								throw {
									message : "endDate non valorizzato"
								};
							}
						} catch (exc) {
							console.log(exc.message);
							console
									.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
							l_attivo = false;
							l_date_end = null;
						}

						if (l_attivo) {

							acquistoAbbonamentiAgganciaAbbonamento_complete('Aggancio abbonamento completato. Il tuo abbonamento scade il '
									+ l_date_end.format('dd/mm/yyyy'));
						} else {
							acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente '
									+ _USERNAME
									+ ', ma non risulta nessun abbonamento attivo.');
						}

					} else {
						acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente '
								+ _USERNAME
								+ ', ma non risulta nessun abbonamento attivo.');
					}
				},
				error : function() {
					acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente '
							+ _USERNAME
							+ ', ma non risulta nessun abbonamento attivo.');
				}
			});

}

function acquistoAbbonamentiAgganciaAbbonamento_complete(p_msg) {
	abutils.alert(p_msg, 'Aggancia abbonamento');

	// chiudo schermata abbonamenti
	popupAcquistoAbbonamentiClose();
	// ricarico dettaglio prodotto
	openProductDetails(_PRODUCT_IN_EDICOLA.productId);

	/* navigator.notification.loadingStop(); */
	window.simulatePG.exec(null, null, "Notification", "activityStop", []);
}

function acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta,
		p_itunes, p_pagina) {
	if (!p_pagina)
		p_pagina = 1;
	var l_productid = _HASH_MAP_TESTATA_PRODUCTID[p_testata];

	// alert('aaa '+l_productid);
	if (!l_productid) {
		// appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata,
		// p_issue, p_edizione, p_pagina); });
		// BUY
		var link_singola = '';
		for ( var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
				link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
			}
		}

		if (!link_singola || link_singola == '') {
			_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] = _PRODUCTLINK;
			for ( var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
				}
			}
		}

		if (link_singola != '') {
			window.payment.paySingle(p_testata, p_issue, p_edizione, p_offerta,
					p_itunes, link_singola);
		} else {
			abutils.alert('Errore su link!', 'Pagamento');
		}

	} else
		checkAcquisto(l_productid, p_issue, p_edizione, p_offerta, p_itunes,
				function() {
					sfoglia(p_testata, p_issue, p_edizione, p_pagina);
				});
	// appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue,
	// p_edizione); });
}

var _DEBUG_MODE = !('ontouchstart' in window), _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart'
		: 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend'
		: 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseup';
/*
 * var _API24_APPKEY = "IpadQuot";//<- PRODUZIONE //// DA CAMBIARE!!!
 * //DroidQuot //var _API24_APPKEY = "1123344";//<- NEURAL //var
 * _API24_SIGNATURE_KEY = "qu0t$STG";//<- PRODUZIONE var _API24_SIGNATURE_KEY =
 * "qu0t$PROD";//<- PRODUZIONE //var _API24_SIGNATURE_KEY = "pppppppp";//<-
 * NEURAL var _API24_SITECODE = "MB" var _API24_ENDPOINT =
 * "https://api24.ilsole24ore.com/"; //<- PRODUZIONE //var _API24_ENDPOINT =
 * "http://10.5.4.166:400/";//<- NEURAL var _SOLEGW_ENDPOINT = _API24_ENDPOINT +
 * "SoleGateway/";
 * 
 * var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy.php"; // è da
 * cambiare anche dentro allo sfogliatore e a Flipper24
 */

var isPortrait = null, screenHeight = null, screenWidth = null;

var _SCREENADV = window.innerWidth;

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _debugIPADContent = true;

var _API24_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
// <- PRODUZIONE //DroidQuot iPadQuot
var _API24_SIGNATURE_KEY = "qu0t$PROD";
// <- PRODUZIONE
var _API24_SITECODE = "MB"
var _API24_ENDPOINT = "https://api24.ilsole24ore.com/";
// <- PRODUZIONE
var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";
var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php";

var _API24TEST_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
// <- STAGE //DroidQuot iPadQuot
var _API24TEST_SIGNATURE_KEY = "qu0t$STG";
// <- STAGE
var _API24TEST_SITECODE = "MB"
var _API24TEST_ENDPOINT = "http://api24test.ilsole24ore.com/";
// <- STAGE
var _SOLEGWTEST_ENDPOINT = _API24TEST_ENDPOINT + "SoleGateway/";
var _ADVTEST_PROXY = "http://212.45.97.204/adv_proxy_and.php";

// Variabile globale contenente lo username dell'utente che sta utilizzando
// l'applicativo
var _USERNAME = null;
// Variabile globale contenente la password dell'utente che sta utilizzando
// l'applicativo
var _USER_PASSWORD = null;
// Variabile globale contenente lo user identity associato all'utente
var _USER_IDENTITY = null;
// Variabile contenente la funzione da richiamare come prossima azione. Utile in
// diverse situazioni per esempio dopo aver fatto la login e proseguire con la
// prossima azione.
var _NEXT_ACTION = null;

var _AJAX_TIMEOUT = 15000;
var _INTERVALLO_CHECK_INBOX = 15 * 60 * 1000;
var _INTERVALLO_CHECK_ONLINE = 15 * 1000;

/**
 * *****************AGGIUNTA PER
 * CHECKACQ****************************************
 */
// metterlo a false se non si vogliono usare le categorie
// quotidiano --> false
// riviste professionali --> true
var _EDICOLA_USE_CATEGORIES = false;
// metterlo a true se si vuole chiedere la registrazione pre-acquisto one-shot
// quotidiano --> false
// riviste professionali --> true
var _ONESHOT_CHECK_REGISTRATO = true;

/** ********************************************************* */
var _menuButtonsIndex = [ '#appmenu_edicola', '#appmenu_preferiti',
		'#appmenu_inbox', '#appmenu_impostazioni' ];

var _PRODOTTO_PRINCIPALE_DEFAULT = {
	id : (_debugIPADContent) ? "1" : "a1",
	descr : "Il Sole 24 ORE"
};

var _DEVICE_SETTINGS = {
	platform : "2",
	appname : (_debugIPADContent) ? "ITQUOIPAD" : "ITQUOANDROID", // DA
																	// CAMBIARE!!!
																	// //ITQUOANDROID
																	// ITQUOIPAD
	appversion : (_debugIPADContent) ? "2.2" : "1.1" // da cambiare in a2.0
														// 2.2 1.0
}

var _MAP_CODICE_TESTATA = (_debugIPADContent) ? {
	'1' : 'S24'
} : {
	'a1' : 'S24'
};
var _CODICE_PRODOTTO_QUOTIDIANO = (_debugIPADContent) ? '1' : 'a1';

function getQueryString(key) {
	key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
	var qs = regex.exec(window.location.href);
	if (qs == null)
		return '';
	else
		return qs[1];
}

function setUserData(p_username, p_password, p_useridentity) {
	console.log('setUserData ' + p_username + ' ' + p_password + ' '
			+ p_useridentity);
	if (p_username == null || p_password == null || p_useridentity == null) {
		deleteUsername();
		deletePassword();
		_USERNAME = null;
		_USER_PASSWORD = null;
		_USER_IDENTITY = null;
		// PhoneGap.exec('AppStore.setUserInfo');
		// window.plugins.appstore.setUserInfo();
	} else {
		storeUsername(p_username);
		storePassword(p_password);
		_USERNAME = p_username;
		_USER_PASSWORD = p_password;
		_USER_IDENTITY = p_useridentity;
		// PhoneGap.exec('AppStore.setUserInfo', _USERNAME, _USER_IDENTITY);
		// window.plugins.appstore.setUserInfo(null, null, _USERNAME,
		// _USER_IDENTITY);
		// console.log('logging '+p_username+','+p_password);
	}

	// console.log('setUserData2 ' + _USERNAME + ' ' + _USER_PASSWORD + ' ' +
	// _USER_IDENTITY);
}

function applicationWillEnterForeground() {
	console.log('JS|applicationWillEnterForeground');
	return "OK";
}

function applicationDidEnterBackground() {
	console.log('JS|applicationDidEnterBackground');
	return "OK";
}

var ROTATION_CLASSES = {

	"0" : "none",
	"90" : "right",
	"-90" : "left",
	"180" : "flipped"

};

/*
 * function detectOrientationEvent() { var orientationEvents =
 * ['onorientationchange', 'reorient', 'resize']; var orientationEvent = null;
 * for (var i = 0; i < orientationEvents.length; i++) { if (orientationEvents[i]
 * in window) { orientationEvent = orientationEvents[i]; break; } } return
 * orientationEvent; }
 */

function monitorOrientationChanges() {
	setInterval(function() {
		updateOrientation();
	}, 500);
}

function search() {
	window.searchlaunch.launch();
}

var CURRENT_ORIENTATION = null;
var _appPageIndex = 0;

function openAppPage(index) {
	_appPageIndex = index;
}

function onBodyLoad() {
	// alert('version 61');
	document.addEventListener("deviceready", onDeviceReady, false);
	document.addEventListener("touchmove", function(e) {
		e.preventDefault();
	}, false);

	if (_DEBUG_MODE) {
		document.getElementById('edicola_catalogo_tiro').addEventListener(
				'click', function() {
					edicolaCatalogoSwitchView();
				}, false);
		// verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(
				'click', function() {
					edicolaCatalogoSwitchView();
				}, false);
	} else {
		document.getElementById('edicola_catalogo_tiro').addEventListener(
				_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(
				_MOVE_EV, edicolaTouchMove, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(
				_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro').addEventListener(
				_CANCEL_EV, edicolaTouchEnd, false);

		// verticale
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(
				_START_EV, edicolaTouchStart, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(
				_MOVE_EV, edicolaTouchMoveVertical, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(
				_END_EV, edicolaTouchEnd, false);
		document.getElementById('edicola_catalogo_tiro_v').addEventListener(
				_CANCEL_EV, edicolaTouchEnd, false);
	}

	/* inizializzazione componenti grafiche */
	GalaxyCheckboxStyle.init();

	/* inizializzazione componenti grafiche */
	if ($(".registrazione_body_group :checkbox").iphoneStyle != null)
		$(".registrazione_body_group :checkbox").iphoneStyle({
			checkedLabel : 'SI',
			uncheckedLabel : 'NO'
		});

	monitorOrientationChanges();

	setTimeout(function() {
		updateOrientation();
		// $(_menuButtonsIndex[_appPageIndex]).trigger('click');
	}, 200);

	document.addEventListener("backbutton", backKeyDown, true);

	if (_DEBUG_MODE) {
		device = {// ATTENZIONE, dati impostati anche in onDeviceReady
			platform : _DEVICE_SETTINGS.platform,
			appname : _DEVICE_SETTINGS.appname,
			appversion : _DEVICE_SETTINGS.appversion,
			name : 'Il mio Safari ;)',
			uuid : '201111111115'
		}

		PhoneGap = {};
		PhoneGap.exec = function(successCB, errorCB, namespace, method) {
			console.log('PG ' + namespace + ' . ' + method);
		};
		PhoneGap.windowEventHandler = function() {
		};
		if (navigator == null) {
			console.log("create navigator");
			navigator = {};
		}
		if (navigator.notification == null)
			navigator.notification = {};
		if (navigator.notification.loadingStart == null)
			navigator.notification.loadingStart = function() {
				console.log('loadingStart');
			};
		if (navigator.notification.loadingStop == null)
			navigator.notification.loadingStop = function() {
				console.log('loadingStop');
			};

		if (!window.plugins)
			window.plugins = {};
		window.plugins.flipper24 = new PGFlipper24();
		// window.plugins.appstore = new PGAppStore();
		navigator.plugins.notificationEx = new NotificationEx();
		// window.plugins.pgaleberutils = new PGAleBerUtils();

		onDeviceReadyDeviceInfo(null);
	}

	device = {
		uuid : null,
		version : null,
		platform : null,
		name : null,
		phonegap : null
	};

	if (!device.uuid) {
		// alert('sasa 0ok');
		device.uuid = window.simulateDevice.getUuid();
		device.version = window.simulateDevice.getOSVersion();
		device.platform = window.simulateDevice.getPlatform();
		device.name = window.simulateDevice.getProductName();
		device.phonegap = window.simulateDevice.getPhonegapVersion();
	}

}

function backKeyDown() {
	// ALERT sei sicuro, se si esegui finish()
	window.runfunc.askandrun('Sei sicuro di voler uscire?', '');
}

function onDeviceReady() {
	if (_API24TEST_SWITCH) {
		console
				.log('************* PUNTAMENTO AD AMBIENTE DI TEST ***********************');
		_API24_APPKEY = _API24TEST_APPKEY;
		_API24_SIGNATURE_KEY = _API24TEST_SIGNATURE_KEY;
		_API24_SITECODE = _API24TEST_SITECODE;
		_API24_ENDPOINT = _API24TEST_ENDPOINT;
		_SOLEGW_ENDPOINT = _SOLEGWTEST_ENDPOINT;
		_ADV_PROXY = _ADVTEST_PROXY;
	}

	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Caricamento in corso..." ]);
	// window.plugins.pgaleberutils.activityStart();
	// window.plugins.pgaleberutils.deviceExtraInfo(onDeviceReadyDeviceInfo,
	// onDeviceReadyDeviceInfo);
	onDeviceReadyDeviceInfo(null);
}

function onDeviceReadyDeviceInfo(extraInfo) {
	// mod 03012013
	// inizializziamo l'uuid
	device.uuid = window.infodroid.getuuid();

	window.infodroid.setuuid(device.uuid);
	// **********************FINE**
	device.orig_uuid = device.uuid;
	if (extraInfo != null && extraInfo.deviceid != null)
		device.uuid = extraInfo.deviceid;

	device.appname = (extraInfo == null || extraInfo.appname == null) ? "---"
			: extraInfo.appname;
	device.appversion = (extraInfo == null || extraInfo.appversion == null) ? "---"
			: extraInfo.appversion;
	// DA CAMBIARE
	// device.usedspace = (extraInfo == null || extraInfo.usedspace == null) ?
	// "---" : extraInfo.usedspace;
	// device.usedspaceperc = (extraInfo == null || extraInfo.usedspaceperc ==
	// null) ? "---" : extraInfo.usedspaceperc;
	device.usedspace = (window.infodroid == null) ? "---" : window.infodroid
			.dirSize("/S24/");
	device.usedspaceperc = (window.infodroid == null) ? "---"
			: window.infodroid.dirSizePerc("/S24/");

	/*
	 * MOD 03012013 if (navigator == null) navigator = {}; if (navigator.fileMgr ==
	 * null) navigator.fileMgr = {}; if (navigator.fileMgr.libFolderPath ==
	 * null) navigator.fileMgr.libFolderPath = (extraInfo == null ||
	 * extraInfo.libFolderPath == null) ? "" : extraInfo.libFolderPath;
	 * 
	 * if (navigator.notification == null) navigator.notification = {}; if
	 * (navigator.notification.loadingStart == null)
	 * navigator.notification.loadingStart =
	 * navigator.plugins.notificationEx.loadingStart; if
	 * (navigator.notification.loadingStop == null)
	 * navigator.notification.loadingStop =
	 * navigator.plugins.notificationEx.loadingStop;
	 */

	// DA VERIFICARE!!! forzo il device.platform a 1
	device.platform = _DEVICE_SETTINGS.platform;
	device.appversion = _DEVICE_SETTINGS.appversion;
	device.appname = _DEVICE_SETTINGS.appname;
	/*
	 * console.log = function(msg) { };
	 */

	/* inizializzazione prodotto principale */
	var l_local_storage_prodotto_principale = window.localStorage
			.getItem("prodotto_principale_id");
	console.log('prodotto principale settato: '
			+ l_local_storage_prodotto_principale);
	if (l_local_storage_prodotto_principale == null) {
		window.localStorage.setItem("prodotto_principale_id",
				_PRODOTTO_PRINCIPALE_DEFAULT.id);
		window.localStorage.setItem("prodotto_principale_descr",
				_PRODOTTO_PRINCIPALE_DEFAULT.descr);
	}

	// non piu' usato, ma può essere lasciato: all'avvio viene lasciata accesa
	// l'edicola dello sfoglio, per forzare il loading di entrambe le immagini
	// qui viene ripristinata l'icona dell'edicola, e tolta quella dello sfoglio
	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');

	// setta il valore di _ORIENTATION
	initOrientation();

	// apertura db
	inizializzaDatabase();

	// controllo username
	controlloUsername();

}

function onDeviceReady_aux() {

	initCheckProducts();

	// Controlla lo stato online/offline
	initCheckOnline();

	downloadManagerDBinit();

	inboxLoadMessages();

	loadAdvTabbar();
	loadAdvCatalogo();

	setTimeout(function() {
		// $('#splashscreen').css('display', 'none');
		// window.plugins.pgaleberutils.activityStop();
		// window.plugins.pgaleberutils.splashScreenHide();
		// navigator.notification.loadingStop();
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		if (_API24TEST_SWITCH) {
			abutils.alert('Stai utilizzando l\'ambiente di test...');
		}
	}, 3000);
}

function loadAdvTabbar(product_id) {
	// alert("CALL ME!!!");
	// document.getElementById('advtabbar_close').style.display = 'none';
	document.getElementById('advtabbar_close_content').innerHTML = '';
	// $('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_02', function(){

	console.log(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d='
			+ device.uuid + '&s=' + _SCREENADV);

	$('#advtabbar_close_content').writeCapture().load(
			_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d='
					+ device.uuid + '&s=' + _SCREENADV, function() {

			}).endCapture();
	document.getElementById('advtabbar_open_content').innerHTML = '';
	console.log(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d='
			+ device.uuid + '&s=' + _SCREENADV);
	// $('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_03', function(){
	$('#advtabbar_open_content').writeCapture().load(
			_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d='
					+ device.uuid + '&s=' + _SCREENADV, function() {
			}).endCapture();

}

var _TABBAR_ADV_IS_OPEN = false;

function handleAdvTabbarClick() {
	var _width_close = $('#advtabbar_close_content img').first().width();
	// evita di aprire il contenuto se non c'è nulla caricato
	if ((_width_close == null) || (_width_close < 5))
		return;
	// alert("CALL ME1!!!");
	_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
	document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, '
			+ (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
	document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, '
			+ (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
}

function loadAdvCatalogo(product_id) {
	// alert("CALL ME2!!!");
	document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
	// $('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_01', function(){
	$('#edicola_prodotto_adv_content').writeCapture().load(
			_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + device.uuid
					+ '&s=' + _SCREENADV, function() {
			}).endCapture();
}

function getSignature(p_request_params) {
	return Crypto.HMAC(Crypto.SHA1, p_request_params, _API24_SIGNATURE_KEY)
			.toUpperCase();
}

var _ORIENTATION = '';

function initOrientation() {
	console.log('********init_Orientation********');

	if (window.innerWidth > window.innerHeight) {
		_ORIENTATION = 'H';
	} else {
		_ORIENTATION = 'V';
	}
}

var _UPDATE_ORIENTATION_RUNNING = false;

function updateOrientation() {
	var that = this;
	setTimeout(
			function() {
				screenHeight = (_DEBUG_MODE) ? window.innerHeight
						: document.documentElement.clientHeight;
				screenWidth = (_DEBUG_MODE) ? window.innerWidth
						: document.documentElement.clientWidth;
				isPortrait = screenWidth < screenHeight;
				// alert("screenWidth " + screenWidth + ", screenHeight " +
				// screenHeight);

				var orientation = isPortrait ? 1 : 2;
				if (CURRENT_ORIENTATION == orientation)
					return;
				CURRENT_ORIENTATION = orientation;

				if (_UPDATE_ORIENTATION_RUNNING)
					return;
				_UPDATE_ORIENTATION_RUNNING = true;
				console.log('_ORIENTATION ' + _ORIENTATION);

				if (!isPortrait) {
					_ORIENTATION = 'H';
				} else {
					_ORIENTATION = 'V';
				}

				$('#wrapper').width(screenWidth).height(screenHeight);

				// FONT SIZE CALCULATION
				var fontSizeRatio = (isPortrait) ? Math
						.round(screenHeight * 0.013) : Math
						.round(screenWidth * 0.013);
				$('body').css('font-size', fontSizeRatio + 'px');
				fontSizeRatio = null;

				var edicolaSmallHeight = 180;
				$('#centrale').height(screenHeight - $('#appmenu').height());
				$('#inbox_list_wrapper').height(
						screenHeight - $('#inbox_list_title').height()
								- $('#appmenu').height()
								- $('#inbox_list_refresh').height());

				if (isPortrait) {
					// PORTRAIT
					$('#edicola_prodotto').height(
							$('#edicola').height() - edicolaSmallHeight).width(
							'100%');
					$('#edicola_prodotto_coverflow').width('100%');
					$('#archivio_wrapper, #archivio_loading').height(
							screenHeight
									- $('#archivio_titolo').height()
									- $('#archivio_subtitolo_prodotto')
											.height()
									- $('#archivio_subtitolo_opzioni').height()
									- $('#archivio_footer').height());
					$('#qarchivio_subtitolo_prodotto').height(50);
					$('#qarchivio_wrapper, #qarchivio_loading').height(
							screenHeight
									- $('#qarchivio_titolo').height()
									- $('#qarchivio_subtitolo_prodotto')
											.height()
									- $('#qarchivio_subtitolo_opzioni')
											.height()
									- $('#qarchivio_footer').height());
					$(
							'#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer')
							.width('100%');
					$('#archivio_wrapper, #archivio_loading, #archivio_footer')
							.width('100%');
					$('#edicola_offline_wrapper').height(
							screenHeight
									- $('#edicola_offline_titolo').height()
									- $('#edicola_offline_subtitolo_opzioni')
											.height());
					$('#qarchivio_label_local_v').show();
					$('#qarchivio_label_local_h').hide();
				} else {
					// LANDSCAPE
					$('#edicola_prodotto').height('100%').width(
							screenWidth - 200);
					$('#edicola_prodotto_coverflow').width(
							screenWidth - 200 - ((screenWidth - 200) * 0.3));
					$('#archivio_wrapper, #archivio_loading').height(
							screenHeight - $('#archivio_titolo').height()
									- $('#archivio_footer').height());
					$('#qarchivio_wrapper, #qarchivio_loading').height(
							screenHeight - $('#qarchivio_titolo').height()
									- $('#qarchivio_footer').height());
					$('#qarchivio_subtitolo_prodotto').height(
							screenHeight - $('#qarchivio_titolo').height());
					$(
							'#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer')
							.width(
									screenWidth
											- $('#qarchivio_subtitolo_prodotto')
													.width());
					$('#archivio_wrapper, #archivio_loading, #archivio_footer')
							.width(
									screenWidth
											- $('#archivio_subtitolo_prodotto')
													.width());
					$('#edicola_offline_wrapper').height(
							screenHeight
									- $('#edicola_offline_titolo').height());
					$('#qarchivio_label_local').css('top',
							(screenHeight - 40) + 'px');
					$('#qarchivio_label_local_h').show();
					$('#qarchivio_label_local_v').hide();
				}

				// COMMON
				$('.commonContentWithTopBar').height(
						Math.round((screenHeight * 0.9) - 50));
				$('.commonWindowWithTopBar').height(screenHeight - 50);
				$('.commonWindowWithAppBar').height(
						screenHeight - 50 - $('#appmenu').height());
				$('.commonMaxContentWithTopBar').css('max-height',
						(screenHeight * 0.9) - 50);

				updateEdicolaProductsIscroll();
				if (_PRODUCT_DETAILS_COVERFLOW != null)
					_PRODUCT_DETAILS_COVERFLOW._display();

				qarchivioUpdateIScroll();
				archivioUpdateIscroll();
				inboxUpdateOrientation();
				preferitiUpdateOrientation();
				impostazioniUpdateOrientation();

				if (_REGISTRAZIONE_ISCROLL != null)
					_REGISTRAZIONE_ISCROLL.refresh();
				if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null)
					_IMPOSTAZIONI_ISCROLL_PRIVACY.refresh();

				_UPDATE_ORIENTATION_RUNNING = false;
			}, 100);
}

/*******************************************************************************
 * Gestione schermata di riepilogo abbonamento annuale
 ******************************************************************************/
var _RIEPILOGO_ISCROLL = null;
var _RIEPILOGO_PRODUCT = null;
var _RIEPILOGO_OFFER = null;

function popupRiepilogoApri(p_product_detail, p_offerta) {
	console.log('detail ' + /* JSON.stringify( */
	p_product_detail['subscriptionOffers'] /* ) */);
	_RIEPILOGO_PRODUCT = p_product_detail;
	_RIEPILOGO_OFFER = p_offerta;
	if (_RIEPILOGO_ISCROLL == null && _ORIENTATION == 'H') {
		_RIEPILOGO_ISCROLL = new iScroll('riepilogo_body', {
			bounce : false
		});
		_RIEPILOGO_ISCROLL.refresh();
	}

	_RIEPILOGO_OFFER = {};
	// p_product_detail['subscriptionOffers'];

	// alert("aaa "+p_product_detail['subscriptionOffers'].length);

	for ( var j = 0; j < p_product_detail['subscriptionOffers'].length; j++) {
		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['annuale_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['annuale_descr'] = 'Abbonamento annuale a '
					+ p_product_detail.productName
					+ '<BR/>in versione digitale con pagamento in unica soluzione.<BR/>L\'importo visualizzato a fianco si riferisce alla quota annuale di abbonamento';
			_RIEPILOGO_OFFER['annuale_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['annuale_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_MENSILE_PAG') {
			_RIEPILOGO_OFFER['mensile_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['mensile_descr'] = 'Abbonamento annuale a '
					+ p_product_detail.productName
					+ '<BR/>in versione digitale con pagamento in rate mensili.<BR/>L\'importo visualizzato a fianco si riferisce al canone mensile di abbonamento';
			_RIEPILOGO_OFFER['mensile_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['mensile_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		// se i codici che mi arrivano non sono quelli attessi mi conservo
		// quello che arriva
		if (p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_MENSILE_PAG'
				&& p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['x_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['x_descr'] = 'Abbonamento a '
					+ p_product_detail.productName
					+ '<BR/>in versione digitale.<BR/>';
			_RIEPILOGO_OFFER['x_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['x_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];

			// console.log(JSON.stringify(_RIEPILOGO_OFFER));
		}

	}

	// alert("aaa " + _RIEPILOGO_OFFER['annuale_price'] + "," +
	// _RIEPILOGO_OFFER['mensile_price']);

	$('#riepilogo').css('display', 'inline-block');
	$('.prezzo_abbo_anno')
			.text(
					'Prezzo '
							+ ab_euro_formatter(_RIEPILOGO_OFFER['annuale_price'] /* p_offerta.offerPrice */));
	$('.prezzo_abbo_mese')
			.text(
					'Prezzo '
							+ ab_euro_formatter(_RIEPILOGO_OFFER['mensile_price'] /* p_offerta.offerPrice */));
	$('#prodotto_riepilogo').text(p_product_detail.productName);
	$('.abbo_mensile_text').html(_RIEPILOGO_OFFER['mensile_descr']);
	$('.abbo_annuale_text').html(_RIEPILOGO_OFFER['annuale_descr']);
}

function popupRiepilogoAnnulla() {
	$('#riepilogo').css('display', 'none');

}

function riepilogoProcedi() {
	var p_product_detail = _RIEPILOGO_PRODUCT;
	var p_offerta = _RIEPILOGO_OFFER;

	// alert('aaaa'+$('#riepilogo input[name=id_abbonamento]'));
	if ($('#riepilogo input[name=id_abbonamento]').attr('checked')) {
		console.log('hai selezionato '
				+ (parseInt($('#riepilogo input[name=id_abbonamento]:checked')
						.val()) == 0 ? 'Ricorrrente' : 'One shot'));

		// Link se è ricorrente o oneshot
		if (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0) {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['mensile_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['mensile_url'];
			console.log('ricorrente ' + p_offerta.offerId + ","
					+ p_offerta.offerItunesProductId);
			// 'Ricorrrente' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail),
					p_offerta.offerId, p_offerta.offerItunesProductId,
					_USER_IDENTITY);
		} else {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['annuale_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['annuale_url'];
			console.log('oneshot ' + p_offerta.offerId + ","
					+ p_offerta.offerItunesProductId);
			// 'One shot' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail),
					p_offerta.offerId, p_offerta.offerItunesProductId,
					_USER_IDENTITY);
		}
		$('#riepilogo').css('display', 'none');
	} else {
		alert('Nessuna selezione');
	}
}

/*******************************************************************************
 * Gestione schermata di registrazione
 ******************************************************************************/
var _REGISTRAZIONE_ISCROLL = null;

function popupRegistrazioneApri() {

	// Inizializzazione dei vari campi della registrazione
	$('#registrazione #id_username').val('');
	$('#registrazione #id_password').val('');
	$('#registrazione #id_password_confirm').val('');
	$('#registrazione #id_email').val('');
	$('#registrazione #id_consenso_privacy').attr('checked', false);
	$('#registrazione #id_consenso_email').attr('checked', false);
	$('#registrazione #id_consenso_societa').attr('checked', false);
	$('#registrazione #id_consenso_privacy').change();
	$('#registrazione #id_consenso_email').change();
	$('#registrazione #id_consenso_societa').change();
	$('#registrazione_senza_email').css('display', 'inline-block');
	$('#registrazione_con_email').css('display', 'none');

	$('#registrazione').css('display', 'inline');

	if (_REGISTRAZIONE_ISCROLL == null) {
		_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
			bounce : false
		});
	} else {
		_REGISTRAZIONE_ISCROLL.refresh();
	}

	// Se l'utente inserisce l'indirizzo email deve comparire il link
	// all'informativa sulla privacy
	$('#registrazione #id_email').unbind();
	$('#registrazione #id_email').keyup(function() {
		console.log('keyup');
		if ($('#registrazione #id_email').val() != '') {
			$('#registrazione_senza_email').css('display', 'none');
			$('#registrazione_con_email').css('display', 'inline-block');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();

			if (_REGISTRAZIONE_ISCROLL == null && _ORIENTATION == 'H') {
				_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
					bounce : false
				});
				_REGISTRAZIONE_ISCROLL.refresh();
			}
		} else {
			$('#registrazione_senza_email').css('display', 'inline-block');
			$('#registrazione_con_email').css('display', 'none');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();
		}
	});
}

function popupRegistrazioneChiudi() {
	// $('#registrazione').fadeOut();
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAnnulla() {
	// $('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneIndietro() {
	// $('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAvanti() {
	if (controlloDatiRegistrazione()) {

		// Definizione del profilo utente
		var l_username = $('#registrazione #id_username').val();
		var l_password = $('#registrazione #id_password').val();
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : l_username,
			"password" : l_password
		};

		var l_user_email = $('#registrazione #id_email').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti
		// i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($(
					'#registrazione #id_consenso_privacy').attr('checked') == "checked" ? '1'
					: '0');
			l_user_profile['consensoMail'] = ($(
					'#registrazione #id_consenso_email').attr('checked') == "checked" ? '1'
					: '0');
			l_user_profile['consensoSocieta'] = ($(
					'#registrazione #id_consenso_societa').attr('checked') == "checked" ? '1'
					: '0');
		}

		var l_req_headers = {
			"appKey" : _API24_APPKEY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceName" : device.name,
			"deviceID" : device.uuid,
			"deviceType" : device.platform,
			"profile" : l_user_profile
		};
		console.log('---REQ---> createUser (' + l_username + ')');
		console.log(l_req_headers);
		console.log(l_req_data);
		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Registrazione in corso..." ]);
		$
				.ajax({
					type : "POST",
					cache : false,
					timeout : _AJAX_TIMEOUT,
					contentType : "application/json; charset=utf-8",
					url : _API24_ENDPOINT + "Users/createUserEDOI",
					headers : l_req_headers,
					processData : false,
					data : JSON.stringify(l_req_data),
					dataType : "json",
					success : function(res) {
						if (typeof res == "string") {
							res = $.parseJSON(res);
						}

						console.log('---RESP--> createUser (' + l_username
								+ ')');
						console.log(res);

						if (!res.Success) {
							// navigator.notification.loadingStop();
							window.simulatePG.exec(null, null, "Notification",
									"activityStop", []);
							// Gestione messaggi di errore dal server
							if (res.Exception.Name == 'InvalidParameterException') {
								abutils
										.alert(
												'Uno o più campi inseriti non sono validi.',
												'Registrazione');
							} else if (res.Exception.Name == 'ExistingUserException') {
								abutils.alert('Lo username è già utilizzato.',
										'Registrazione');
							} else {
								// alert('Attenzione, ' +
								// res.Exception.Description);
								abutils.alert(res.Exception.Description,
										'Registrazione');
							}
						} else {
							if (l_user_email == '') {
								abutils
										.alert(
												"L'indirizzo email ti verrà richiesto al primo accesso al nostro sito web.",
												'Registrazione completata');
							} else {
								abutils
										.alert(
												"Ti abbiamo inviato una mail per attivare la tua utenza anche per il nostro sito web.",
												'Registrazione completata');
							}
							eseguiLogin(l_username, l_password);
						}
					},
					error : function(xmlHttpRequest, textStatus, errorThrown) {
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
						abutils
								.alert(
										'Si è verificato un errore durante la registrazione.',
										'Registrazione');
					}
				});
	}
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in
 * particolare: - la username non deve contenere caratteri speciali - le
 * password devono coincidere e non devono avere caratteri speciali -
 * l'indirizzo email, se presente, deve essere un indirizzo valido - l'utente
 * deve acconsentire al trattamento dei dati personali in caso di presenza
 * dell'indirizzo email
 */
function controlloDatiRegistrazione() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	var ck_username = /^[A-Za-z0-9_]{3,20}$/;
	/* Min 3 max 20 caratteri */
	var ck_password = /^[A-Za-z0-9!@#$%^*()_]{8,20}$/;
	/* Min 8 max 20 caratteri senza / \ e & */
	// Controllo username
	username = $('#registrazione #id_username').val();
	if (!ck_username.test(username)) {
		abutils
				.alert(
						'Lo username non può contenere spazi e caratteri speciali. Deve essere lunga tra i 3 ed i 20 caratteri',
						'Registrazione');
		return false;
	}

	// Controlli password
	password = $('#registrazione #id_password').val();
	if (password == '') {
		abutils.alert('La password è obbligatoria.', 'Registrazione');
		return false;
	}
	if (!ck_password.test(password)) {
		abutils.alert('La password inserita non è valida.', 'Registrazione');
		return false;
	}
	password_confirm = $('#registrazione #id_password_confirm').val();
	if (password_confirm != password) {
		abutils.alert('Le password inserite non coincidono.', 'Registrazione');
		return false;
	}

	// Controllo email
	email = $('#registrazione #id_email').val();

	// email obbilgatoria
	if (email == '') {
		abutils.alert("L'indirizzo email è obbligatorio.", 'Registrazione');
		return false;
	}

	if (email != '' && !ck_email.test(email)) {
		abutils.alert("L'indirizzo email inserito non è valido.",
				'Registrazione');
		return false;
	}

	// console.log('aaa'+$('#registrazione
	// input[name=id_consenso_privacy]').attr('checked'));
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != ''
			&& !$('#registrazione input[name=id_consenso_privacy]').attr(
					'checked')) {
		abutils
				.alert(
						"Per proseguire devi acconsentire al trattamento dei tuoi dati personali.",
						'Registrazione');
		return false;
	}

	return true;
}

/*******************************************************************************
 * Gestione popup di login
 ******************************************************************************/
/**
 * Inizializza e mostra il popup per la login
 * 
 * @params p_username Parametro opzionale con il quale inizializzare il campo
 *         username p_force Se impostato a true forza l'utente a non poter
 *         uscire dalla login se non attraverso l'effettuazione della login
 *         stessa
 */
var _POPUP_LOGIN_USERNAME = null;

function popupLogin(p_username, p_force) {
	// alert('bbb');
	_POPUP_LOGIN_USERNAME = p_username;

	// Inizializza lo username se questo viene passato come parametro
	if (p_username) {
		$('#login #id_username').val(p_username);
		$('#login #login_body_message').text(p_username);
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'none');
		$('#login #id_password').val('');
	} else {
		$('#login #id_username').val('');
		$('#login #login_body_message').text('');
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display',
				'inline-block');
		$('#login #id_password').val('');
	}

	// Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#login_back_button').css('visibility', 'hidden');
	} else {
		$('#login_back_button').css('visibility', 'visible');
	}
	// $('#riepilogo').css('visibility', 'hidden');
	$('#login').css('display', 'inline');

	$('select').attr('disabled', 'disabled');
}

function popupLoginChiudi() {
	// $('#login').fadeOut();
	$('#login').css('display', 'none');
	$('#login_body_message').text('');

	$('select').removeAttr('disabled');
}

function popupLoginIndietro() {
	// $('#login').fadeOut();
	_NEXT_ACTION = null;
	$('#login').css('display', 'none');

	if (_POPUP_LOGIN_USERNAME != null) {
		// procedo ad una disassociazione del dispositivo
		disassociazioneSilenziosa(_POPUP_LOGIN_USERNAME);
	}

	$('select').removeAttr('disabled');
}

function disassociazioneSilenziosa(p_username) {
	if (p_username == null) {
		p_username = _USERNAME;
	}
	var l_request_data = {
		"username" : p_username, // _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	var l_req_headers = {
		"appKey" : _API24_APPKEY
	// ,
	// "userIdentity": _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice Silent Login');
	console.log(l_req_headers);
	console.log(l_request_data);

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if (typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice Silent Login');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {

			} else {

			}

		},
		error : function() {

		}
	});
}

/**
 * Cerca di effettuare la login. In caso di successo memorizza i dati
 * dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupLoginAvanti() {
	if (controlloDatiLogin()) {
		var l_username = $('#login #id_username').val();
		var l_password = $('#login #id_password').val();
		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Login in corso..." ]);
		//_EDICOLA_LAST_PRODUCT_LOAD = 0;
		eseguiLogin(l_username, l_password);
	}
}

/**
 * Esegue la chiamata di login verso il server
 */
function eseguiLogin(p_username, p_password, p_silent) {
	console.log('---REQ---> userLogin (' + p_username + ')');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"siteCode" : _API24_SITECODE,
		"username" : p_username,
		"password" : p_password
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/userLogin",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					setUserData(null, null, null);

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> userLogin');
					console.log(p_response);

					if (checkAjaxResponse(p_response)) {
						// procedo ad una associazione
						associaDevice(p_username, p_password,
								p_response.Result.res, p_silent);
						popupAcquistoRegistrazioneClose();
					} else {
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
						popupAcquistoRegistrazioneClose();
						var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description
								: '';
						if (p_silent) {
							// errore in fase di inizializzazione
							console
									.log('Errore in fase di inizializzazione - login: '
											+ l_exc_descr);
							abutils.alert(
									'Si è verificato un errore di accesso per l\'utente '
											+ p_username, 'Errore');
							popupLogin(p_username);
							onDeviceReady_aux();
						} else {
							// errore da mostrare
							abutils.alert(
									'Si è verificato un errore durante la login. '
											+ l_exc_descr, 'Login');
						}

					}
				},
				error : function() {
					// navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification",
							"activityStop", []);
					// probabile errore di timeout
					if (p_silent) {
						// timeout in fase di inizializzazione
						console
								.log('Errore in fase di inizializzazione - login: TIMEOUT');
						onDeviceReady_aux();
					} else {
						// errore da mostrare
						abutils
								.alert(
										'Impossibile effettuare la login. Riprovare tra poco.',
										'Login');
					}
				}
			});
}

/**
 * Associa l'utente al dispositivo
 */
function associaDevice(p_username, p_password, p_useridentity, p_silent) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : p_useridentity
	// _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceName" : device.name,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : p_username
	// _USERNAME
	};

	console.log('---REQ---> associauserdevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$
			.ajax({
				type : "POST",
				cache : false,
				contentType : "application/json; charset=utf-8",
				// url: _API24_ENDPOINT + "Users/addUserDevice",
				url : _SOLEGW_ENDPOINT + "associauserdevice.json",
				headers : l_req_headers,
				processData : false,
				data : JSON.stringify(l_req_data),
				dataType : "json",
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> associauserdevice');
					console.log(p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, associaDevice)
							|| (p_response.Exception.Name == 'UserDeviceRelationException')) {
						setUserData(p_username, p_password, p_useridentity);
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
						if (p_silent) {
							onDeviceReady_aux();
						} else {
							popupLoginChiudi();
							popupRegistrazioneChiudi();
							gestisciProssimaAzione();
						}
					} else {
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
						// Gestione eccezioni
						var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description
								: '';
						if (p_silent) {
							// exception in fase di inizializzazione
							console
									.log('Errore in fase di inizializzazione - associauserdevice: '
											+ l_exc_descr);
							abutils.alert(
									'Si è verificato un errore di accesso per l\'utente '
											+ p_username, 'Errore');
							popupLogin(p_username);
							onDeviceReady_aux();
						} else {
							console.log('associaDevice EXCEPTION '
									+ p_response.Exception.Name + ': '
									+ p_response.Exception.Description);
							if ((p_response.Exception.Name != 'UserDeviceRelationException')
									&& (p_response.Exception.Name != 'ExpiredUserIdentityException')) {
								abutils.alert(p_response.Exception.Description,
										'Associazione device');
							}
						}

					}

				},
				error : function() {
					// navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification",
							"activityStop", []);
					// probabile errore di timeout
					if (p_silent) {
						// timeout in fase di inizializzazione
						console
								.log('Errore in fase di inizializzazione - associauserdevice: TIMEOUT');
						onDeviceReady_aux();
					} else {
						// errore da mostrare
						abutils
								.alert(
										'Impossibile effettuare l\'associazione del device. Riprovare tra poco.',
										'Login');
					}
				}
			});
}

function controlloDatiLogin() {
	username = $('#login #id_username').val();
	if (username == '') {
		abutils.alert('Attenzione, lo username è obbligatorio.', 'Login');
		return false;
	}

	// Controlli password
	password = $('#login #id_password').val();
	if (password == '') {
		abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
		return false;
	}

	return true;
}

/*******************************************************************************
 * Gestione schermata di login
 ******************************************************************************/
/**
 * Inizializza e mostra il popup per il controllo della password
 * 
 * @params p_force Se impostato a true forza l'utente a non poter annullare il
 *         controllo password
 */
function popupControlloPassword(p_force) {

	// Inizializza lo username
	$('#controllo_password #controllo_password_account_username').text(
			_USERNAME);
	$('#controllo_password #id_password').val('');

	// Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#controllo_password_back_button').css('visibility', 'hidden');
	} else {
		$('#controllo_password_back_button').css('visibility', 'visible');
	}

	$('#controllo_password').css('display', 'inline');

	$('select').attr('disabled', 'disabled');
}

function popupControlloPasswordChiudi() {
	// $('#controllo_password').fadeOut();
	$('#controllo_password').css('display', 'none');

	$('select').removeAttr('disabled');
}

/**
 * Cerca di effettuare la login. In caso di successo memorizza i dati
 * dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupControlloPasswordAvanti() {
	if ($('#controllo_password #id_password').val() != _USER_PASSWORD) {
		abutils.alert('La password non è corretta', 'Attenzione');
	} else {
		popupControlloPasswordChiudi();
		gestisciProssimaAzione();
	}
}

/*******************************************************************************
 * Gestione memorizzazione locale username
 ******************************************************************************/
/**
 * Elimina lo username dell'utente dal local storage
 */
function deleteUsername() {
	window.localStorage.removeItem("username");
}

/**
 * Memorizza lo username dell'utente nel local storage
 * 
 * @params p_username Lo username che deve essere memorizzato
 */
function storeUsername(p_username) {
	window.localStorage.setItem("username", p_username);
}

/**
 * Legge lo username dell'utente da local storage
 * 
 * @returns String Lo username dell'utente
 */
function getUsername() {
	return window.localStorage.getItem("username");
}

/*******************************************************************************
 * Gestione memorizzazione locale password
 ******************************************************************************/
/**
 * Elimina la password dell'utente dal local storage
 */
function deletePassword() {
	window.localStorage.removeItem("password");
}

/**
 * Memorizza la password dell'utente nel local storage
 * 
 * @params p_username La password che deve essere memorizzata
 */
function storePassword(p_password) {
	window.localStorage.setItem("password", p_password);
}

/**
 * Legge la password dell'utente da local storage
 * 
 * @returns String La password dell'utente
 */
function getPassword() {
	return window.localStorage.getItem("password");
}

/*******************************************************************************
 * Gestione controllo iniziale username
 ******************************************************************************/
/**
 * Controlla la presenza dello username nel local storage ed in caso controlla
 * che sia lo stesso username associato al dispositivo
 */
function controlloUsername() {
	var l_local_storage_username = getUsername();
	var l_local_storage_password = getPassword();
	console.log('Utente secondo IPAD: ' + l_local_storage_username);
	if (l_local_storage_username != null && l_local_storage_password != null) {
		// procedo direttamente alla login
		// setUserData(null, null, null);
		_NEXT_ACTION = onDeviceReady_aux;
		eseguiLogin(l_local_storage_username, l_local_storage_password, true);
		return;
	}

	// se non ci sono dati in locale chiedo l'eventuale utenza ad API24

	// console.log('Lettura utente associato al dispositivo');
	var l_signature = getSignature(device.uuid + ',' + device.platform);

	console.log('---REQ---> getUserFromDevice');
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	// Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserFromDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			console.log('---RESP--> getUserFromDevice');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				var l_api24_username = p_response.Result.res;
				console.log('Utente secondo API24: ' + l_api24_username);

				if (l_api24_username != '') {
					_NEXT_ACTION = loadProducts;
					popupLogin(l_api24_username);
					onDeviceReady_aux();
				} else {
					onDeviceReady_aux();
				}
			} else {
				// Gestione eccezioni
				// setUserData(null, null, null);
				onDeviceReady_aux();
				return;
			}
		},
		error : function() {
			// setUserData(null, null, null);
			onDeviceReady_aux();
			return;
		}
	});
}

function popupInformativaPrivacy() {
	// $('#informativa_privacy').fadeIn();
	if (_IMPOSTAZIONI_PROFILO_ISCROLL != null) {
		_IMPOSTAZIONI_PROFILO_ISCROLL.destroy();
		_IMPOSTAZIONI_PROFILO_ISCROLL = null;
	}
	// Viene mostrato il popup
	$('#informativa_privacy').css('display', 'inline');
	if (_IMPOSTAZIONI_ISCROLL_PRIVACY == null)
		_IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
}

function popupInformativaPrivacyClose() {
	// $('#informativa_privacy').fadeOut();
	$('#informativa_privacy').css('display', 'none');
	if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
		console.log("_IMPOSTAZIONI_PROFILO_ISCROLL is null");
		_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll(
				'impostazioni_profilo_body_wrapper');
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	}
}

/*******************************************************************************
 * Gestione inizializzazione database
 ******************************************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 10 * 1024 * 1024;
var _DB = null;
var _DBFAIL = false;

/**
 * Inizializza il database associato all'applicazione
 */
function inizializzaDatabase() {
	console.log("Inizializzazione database");

	if (!window.openDatabase)
		console.log("Error: can't open local database");
	if (!localStorage)
		console.log("Error: localstorage not usable");
	try {
		if (!_DB) {
			console.log("opendatabase " + _DB_NAME + "," + "1.0" + ","
					+ _DB_NAME + "," + _DB_SIZE);
			_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
		}
	} catch (exc) {
		console.log('Errore database ' + exc.message);
		setTimeout(function() {
			try {
				if (window.openDatabase) {
					_DB = null;
					_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME,
							_DB_SIZE);// window.simulateDB.openDatabase(_DB_NAME,
										// "1.0", _DB_NAME, _DB_SIZE);
					// window.location.assign('index.html');
				} else {
					_DBFAIL = true;

					if (!window.infodroid.isfoglioopen()) {
						window.simulatePG.relaod();
					}
				}
			} catch (exc) {
				console.log('Errore simDB database ' + exc.message);
				_DBFAIL = true;
				if (!window.infodroid.isfoglioopen()) {
					window.simulatePG.relaod();
				}
			}
		}, 500);
	}
	console.log("Inizializzazione database OK");
}

/**
 * Funzione di gestione degli erorri delle operazioni sul database
 */
function dbErrorHandler(p_error) {
	console.log("Error processing SQL: " + p_error);
}

/* -------------------- DOWNLOAD MANAGER ----------------------------------- */
/* ricordarsi di mettere la downloadManagerDBinit() nel deviceready-bodyload */
function downloadManagerDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK downloadManagerDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO downloadManagerDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx
					.executeSql(
							'CREATE TABLE IF NOT EXISTS issues (id unique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, dttm)',
							[], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function addToDownloadQueue(testata, issue, edizione) {
	renderDownloadQueue(testata, issue, edizione);
	// PhoneGap.exec("DownloadManagerCommand.addIssueToDownloadQueue", testata,
	// issue, edizione);
	// window.plugins.flipper24.addIssueToDownloadQueue(null, null, testata,
	// issue, edizione);
	window.soledownloader.launchDownload(testata, edizione, issue,
			"Descrizione" + window.localStorage.getItem('unread_message_sole'),
			"" + "aaaa", "false");
	console.log("queue!!!")
}

function getUnreadMessage(testata, edizione, issue) {
	var unread = window.localStorage.getItem('unread_message_sole');
	// alert('aunread is '+unread);
	if (unread != null)
		window.runfunc.retMessage(testata, edizione, issue, unread);
	else
		window.runfunc.retMessage(testata, edizione, issue, 0);
}

function renderDownloadQueue(testata, issue, edizione) {
	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue
			+ '_' + edizione);
	if (btn) {
		$(btn).val('Annulla');
		$(btn).unbind();
		$(btn).bind(
				'click',
				function() {
					console.log(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " "
							+ issue + " " + edizione);
					// alert(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " +
					// issue + " " + edizione);
					setTimeout(function() {
						removeToDownloadQueue(testata, issue, edizione);
					}, 0);
					/*
					 * setTimeout(function(){
					 * window.soledelete.deleteIssue(testata, issue, edizione);
					 * },1000);
					 */
				});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_'
				+ edizione).style['visibility'] = 'visible';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue
			+ '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'white';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-image'] =
		 * '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%,
		 * rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue
				+ '_' + edizione).style['width'] = '0%';
	}
}

function removeToDownloadQueue(testata, issue, edizione) {
	// PhoneGap.exec("DownloadManagerCommand.removeIssueToDownloadQueue",
	// testata, issue, edizione);
	// window.plugins.flipper24.removeIssueToDownloadQueue(null, null, testata,
	// issue, edizione);
	window.soledownloader
			.cancelDownload(testata, edizione, issue, "", "", true);
	console.log("remove queue t: " + testata + " ed: " + edizione + " iss: "
			+ issue);

	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue
			+ '_' + edizione);
	if (btn) {
		$(btn).val('Salva in locale');
		$(btn).unbind();
		$(btn).bind(
				'click',
				function() {
					console.log(";;;;;;;;;; ADD2 TO QUEUE " + testata + " "
							+ issue + " " + edizione);
					addToDownloadQueue(testata, issue, edizione);
				});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_'
				+ edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue
			+ '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'white';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-image'] =
		 * '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%,
		 * rgb(255,255,255) 100%)';
		 */
		document.getElementById('progressbar_status_' + testata + '_' + issue
				+ '_' + edizione).style['width'] = '0%';
	}
}

function downloadManagerCallbackSingleFileComplete(testata, issue, edizione, progress) {
	if (!$('#progressbar_status_' + testata + '_' + issue + '_' + edizione).length) return;
	
	renderDownloadQueue(testata, issue, edizione);

	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'royalblue';
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(10,43,128) 0%, rgb(99,151,255) 100%)';

	//alert("is "+progress);
	console.log("progress is " + progress);
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = parseInt(progress) + '%';
}

function downloadManagerCallbackSingleFileError(testata, issue, edizione,
		progress) {
	if (document.getElementById('progressbar_status_' + testata + '_' + issue
			+ '_' + edizione)) {
	}
}

function downloadManagerCallbackSetComplete(testata, testata_descr, issue,
		issue_descr, edizione, edizione_descr) {
	if (document.getElementById('qarchivio_container_box_txt_LIST_' + testata
			+ '_' + issue + '_' + edizione))
		document.getElementById('qarchivio_container_box_txt_LIST_' + testata
				+ '_' + issue + '_' + edizione).className = 'qarchivio_container_box_txt_local_LIST';
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_'
				+ edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue
			+ '_' + edizione)) {
	}
	downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue,
			issue_descr, edizione, edizione_descr);
	omnitureTrackApp('APP:download:complete:' + testata + ':' + issue + ':'
			+ edizione, 'APP:download');
}

function downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue,
		issue_descr, edizione, edizione_descr) {
	console.log('downloadManagerCallbackSaveIssueDb!!!');
	if (_DB) {
		var querySuccess = function() {
			console.log('OK SAVE LOCAL DB');
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);

			// togliere pulsante scarica e mostrare sfoglia
			var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_'
					+ issue + '_' + edizione);
			if (btn) {
				$(btn).unbind();
				$(btn).removeClass('gray24');
				$(btn).addClass('red24');
				$(btn).val('Sfoglia');
				$(btn).bind(
						'click',
						function() {
							console.log(";;;;;;;;;; SFOGLIA " + testata + " "
									+ issue + " " + edizione);
							sfoglia(testata, issue, edizione);
							console.log("sfoglia archivio");
							window.loader.local(true);
						});
			}

			// aggiorna dettaglio prodotto se necessario
			refreshProductDetails();
		}
		var queryError = function(tx, p_error) {
			console.log('KO SAVE LOCAL DB ' + p_error.message);
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);
		}
		var executeQuery = function(tx) {
			var idunique = testata + '_' + issue + '_' + edizione;
			console.log('INSERT INTO issues: ' + idunique);
			// tx.executeSql('INSERT INTO issues VALUES("' + idunique + '", "' +
			// testata + '", "' + testata_descr + '", "' + issue + '", "' +
			// issue_descr + '", "' + edizione + '", "' + edizione_descr + '",
			// DATETIME(\'NOW\'));', [], querySuccess, queryError);
			tx
					.executeSql(
							'INSERT INTO issues VALUES(?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'));',
							[ idunique, testata, testata_descr, issue,
									issue_descr, edizione, edizione_descr ],
							querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function downloadManagerCallbackSetError(testata, issue, edizione) {
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('progressbar_' + testata + '_' + issue + '_'
				+ edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue
			+ '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'red';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['width'] = '100%';
		 */
	}
	if (document.getElementById('stop_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('stop_' + testata + '_' + issue + '_'
				+ edizione).style['display'] = 'none';
	if (document.getElementById('download_' + testata + '_' + issue + '_'
			+ edizione))
		document.getElementById('download_' + testata + '_' + issue + '_'
				+ edizione).style['display'] = 'inline-block';
}

/* ------------------------- FINE DOWNLOAD MANAGER ---------------------- */

/*******************************************************************************
 * Gestione popup accedi/registrati
 ******************************************************************************/
function popupAccediRegistrati() {
	$('#accedi_registrati_menu').css('display', 'inline-block');
}

function popupAccediRegistratiChiudi() {
	$('#accedi_registrati_menu').css('display', 'none');
}

function popupAccediRegistratiAnnulla() {
	$('#accedi_registrati_menu').css('display', 'none');
	_NEXT_ACTION = null;
}

/*******************************************************************************
 * Ajax COMMONS
 ******************************************************************************/
/**
 * Gestisce il controllo del risultato proveniente dalle richieste Ajax. Le
 * risposte devono essere in formato JSON ed avere almeno l'attributo Success ed
 * eventuali eccezioni.
 * 
 * @params p_result La risposta proveniente dal server
 * @returns Boolean False in caso di errori, True in caso di successo
 */
function checkAjaxResponse(p_response, p_callback) {
	if (typeof p_response == "string") {
		p_response = $.parseJSON(p_response);
	}
	if (p_response.Success) {
		// console.log('Check ajax response OK');
		// console.log(p_response);
		return true;
	} else {
		console.log('Check ajax response KO: [' + p_response.Exception.Name
				+ '] ' + p_response.Exception.Description);
		if (p_response.Exception.Name == 'ExpiredUserIdentityException') {
			if (_USERNAME == null && _USER_PASSWORD == null) {
				console
						.log('WARNING username e/o password non settati, impossibile procedere al rinnovo della useridentity');
				setUserData(null, null, null);
				return false;
			}
			console.log('GESTIONE ExpiredUserIdentityException');
			console.log('---REQ---> userLogin4ExpiredUserIdentityException('
					+ _USERNAME + ')');
			var l_username = _USERNAME;
			var l_user_password = _USER_PASSWORD;
			var l_req_headers = {
				"appKey" : _API24_APPKEY
			};
			var l_req_data = {
				"siteCode" : _API24_SITECODE,
				"username" : l_username,
				"password" : l_user_password
			};
			console.log(l_req_headers);
			console.log(l_req_data);
			// resetto username e password
			/*
			 * _USERNAME = null; _USER_PASSWORD = null;
			 */
			setUserData(null, null, null);

			$
					.ajax({
						type : "GET",
						timeout : _AJAX_TIMEOUT,
						cache : false,
						contentType : "application/json; charset=utf-8",
						url : _API24_ENDPOINT + "Users/userLogin",
						headers : l_req_headers,
						data : l_req_data,
						dataType : "json",
						success : function(p_response) {

							if (typeof p_response == "string") {
								p_response = $.parseJSON(p_response);
							}

							console
									.log('---RESP--> userLogin4ExpiredUserIdentityException');
							console.log(p_response);

							if (checkAjaxResponse(p_response)) {
								setUserData(l_username, l_user_password,
										p_response.Result.res);
								if (p_callback != null)
									p_callback.call();
								else
									console
											.log('WARNING userLogin4ExpiredUserIdentityException completata, ma manca la callback');
							} else {
								console
										.log('WARNING userLogin4ExpiredUserIdentityException error');
							}
						},
						error : function() {
							console
									.log('WARNING userLogin4ExpiredUserIdentityException timeout');
						}
					});
		}
		return false;
	}
}

/**
 * Callback generica per la gestione degli errori di comunicazione verso le
 * API24
 */
function ajaxErrorHandler(xmlHttpRequest, textStatus, errorThrown) {
	console.log('Ajax error: ' + textStatus);
	// enableOfflineMode();
}

/**
 * Inizializza il controllo per la gestione online/offline
 */
var _OFFLINE_COUNTER = null;
// var _PING_COUNTER = 0;
function testConnectionWorker() {
	// _PING_COUNTER++;
	if (_OFFLINE_COUNTER == null)
		_OFFLINE_COUNTER = 1;
	// al primo avvio il primo risultato è quello buono

	console.log('---REQ---> PING');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	// console.log(l_req_headers);
	// console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		headers : l_req_headers,
		data : l_req_data,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + 'ping.json',
		dataType : "json",
		success : function(p_response) {
			// console.log('---RESP--> PING');
			console.log(p_response);
			try {
				if (typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				if (checkAjaxResponse(p_response)
						&& (p_response.Result.res.statusCode == 0)) {
					enableOnlineMode();
					_OFFLINE_COUNTER = 0;
				} else {
					_OFFLINE_COUNTER++;
					if (_OFFLINE_COUNTER >= 2) {
						enableOfflineMode();
					}
				}
			} catch (exc) {
				// console.log('errore formato risposta');
				_OFFLINE_COUNTER++;
				if (_OFFLINE_COUNTER >= 2) {
					enableOfflineMode();
				}
			}
		},
		error : function() {
			// console.log('ajax error');
			_OFFLINE_COUNTER++;
			if (_OFFLINE_COUNTER >= 2) {
				enableOfflineMode();
			}
		}
	});
}

function initCheckOnline() {
	testConnectionWorker();
	setInterval(function() {
		testConnectionWorker();
	}, _INTERVALLO_CHECK_ONLINE);
}

/**
 * Gestisce l'esecuzione della prossima azione. Alcune volte al termine delle
 * azioni su una popup è necessario eseguire un azione. Per fare ciò viene
 * impostata la variabile _NEXT_ACTION alla funzione che deve essere richiamata.
 * La seguente funzione controlla che ci sia una prossima azione ed in caso la
 * esegue.
 */
function gestisciProssimaAzione() {
	// Se la variabile _NEXT_ACTION è inizializzata chiama la funzione associata
	if (_NEXT_ACTION && typeof _NEXT_ACTION == "function") {
		var l_next_action = _NEXT_ACTION;
		_NEXT_ACTION = null;
		l_next_action.call();
	}
}

/* --------- gestione bottoni appmenu -------------------- */
function appmenuButtonReset() {
	$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
	$('#appmenu_edicola').removeClass('appmenu_edicola_on');
	$('#appmenu_preferiti').removeClass('appmenu_preferiti_on');
	$('#appmenu_inbox').removeClass('appmenu_inbox_on');
	$('#appmenu_impostazioni').removeClass('appmenu_impostazioni_on');
}

function appmenuSfoglioOpen() {
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
	var l_ret = openFlipper();
	if (!l_ret) {
		$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
		abutils
				.alert('Nessuna pubblicazione è ancora stata aperta.',
						'Sfoglia');
		return;
	}
	appmenuButtonReset();
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
}

function appmenuEdicolaOpenWithIndice(testata, edizione) {
	appmenuEdicolaOpen(true);
	try {
		var l_product_id = _HASH_MAP_TESTATA_PRODUCTID[testata];
		console.log(testata + ' ---> ' + l_product_id);
		if (l_product_id == null)
			return;
		// qarchivioOpen(l_product_id, true, edizione);
		if (l_product_id == _CODICE_PRODOTTO_QUOTIDIANO)
			qarchivioOpen(l_product_id, true, edizione);
		else
			archivioOpen(l_product_id, true);
	} catch (exc) {

	}
}

function appmenuEdicolaOpen(skipFlipper) {

	if (!skipFlipper && _CURRENT_FLIPPER_TESTATA != null
			&& _CURRENT_FLIPPER_ISSUE != null
			&& _CURRENT_FLIPPER_EDIZIONE != null) {
		openFlipper();
		setTimeout(function() {
			appmenuEdicolaOpen(true);
		}, 2000);
		return;
	}

	if (_MOD_OFFLINE != true) {
		loadProducts();
	}

	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');
	$('#centrale_container').css('-webkit-transform',
			'translate3d(0px, 0px, 0)');

	$('#edicola_titolo_btn_select').removeAttr('disabled');

	omnitureTrackApp("APP:edicola", "APP:edicola");
	nielsenCall('EDICOLA');
}

function appmenuPreferitiOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	preferitiLoadMenuProdotto();
	appmenuButtonReset();
	$('#appmenu_preferiti').addClass('appmenu_preferiti_on');
	$('#centrale_container').css('-webkit-transform',
			'translate3d(-3000px, 0px, 0)');

	omnitureTrackApp("APP:preferiti", "APP:preferiti");
	nielsenCall('PREFERITI');
}

function appmenuInboxOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	$('#appmenu_inbox').addClass('appmenu_inbox_on');
	$('#centrale_container').css('-webkit-transform',
			'translate3d(-6000px, 0px, 0)');

	omnitureTrackApp("APP:inbox", "APP:inbox");
	nielsenCall('INBOX');
}

function appmenuImpostazioniOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	impostazioniInizializza();
	impostazioniOpen();
	$('#appmenu_impostazioni').addClass('appmenu_impostazioni_on');
	$('#centrale_container').css('-webkit-transform',
			'translate3d(-9000px, 0px, 0)');

	omnitureTrackApp("APP:impostazioni", "APP:impostazioni");
}

/* ----------------------------------------------------------------- */
function injectAutoLogin(username, password) {
	if (username == null || password == null)
		return "KO";
	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Aggiornamento in corso..." ]);

	_NEXT_ACTION = function() {
		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Aggiornamento in corso..." ]);

		setTimeout(function() {
			window.location = 'galaxy.html';
		}, 1000);
	}
	eseguiLogin(username, password);

	return "OK";
}

function checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24,
		id_itunes, callback) {
	console.log('--->checkAcquisto');
	if (p_prodotto24 == '1') {
		// android workaround temporaneo
		p_prodotto24 = 'a1';
	}

	var local = window.verify.Local(_MAP_CODICE_TESTATA[p_prodotto24 + ''],
			p_issue, p_edizione);
	console.log("local is " + local);
	if (local == '1') {
		if (callback && typeof callback == "function") {
			console.log("aaaa passsq");
			callback.call();
			return;
		}
	}
	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"date" : p_issue
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> checkAcquisto(' + p_prodotto24 + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "checkacquisto/" + p_prodotto24
						+ ".json",
				headers : l_request_headers,
				data : l_request_data,
				dataType : "json",
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console
							.log('--RESP--> checkAcquisto(' + p_prodotto24
									+ ')');
					console.log('checkAcquisto resp '
							+ /* JSON.stringify( */p_response /* ) */);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						checkAcquisto(p_prodotto24, p_issue, p_edizione,
								id_shopping24, id_itunes, callback);
					})) {
						console.log('check ' + p_response.Result.res);

						if (p_response.Result.res
								&& p_response.Result.res.checkAcquisto
								&& (p_response.Result.res.checkAcquisto == true)) {
							// navigator.notification.confirm('Hai già
							// acquistato questa edizione: il nuovo download è
							// gratuito.', function(button){
							if (callback && typeof callback == "function") {
								console.log("Aquisto-->pass to func");
								callback.call();
							}
							// }, 'Acquisto non necessario', 'Ok');
						} else {
							// appstoreBuy(id_shopping24, id_itunes, callback);
							// BUY-----------------------------------------------------------------------------------------

							console.log('buy');
							console.log("aaaa passsq1");
							var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
							var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
							var link_singola = '';
							console.log('productId ' + productId);
							for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
								if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
									link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
								}
							}
							// prova con i link
							if (!link_singola || link_singola == '') {
								_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
								for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
									if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
										link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
									}
								}
							}

							if (link_singola != '') {
								window.payment.paySingle(testata, p_edizione,
										p_issue, id_shopping24, id_itunes,
										link_singola);
							} else {
								abutils.alert('Errore su link!', 'Pagamento');
							}

						}
					} else {
						if (p_response.Exception.Name == 'ExpiredUserIdentityException')
							return;
						// appstoreBuy(id_shopping24, id_itunes, callback);
						// BUY---------------------------------------------------------------------------------------------
						console.log('buy');
						console.log("aaaa passsq2");
						var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
						var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];

						var link_singola = '';
						for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}

						// prova con i link
						if (!link_singola || link_singola == '') {
							_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
							for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
								if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
									link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
								}
							}
						}
						if (link_singola != '') {
							window.payment.paySingle(testata, p_edizione,
									p_issue, id_shopping24, id_itunes,
									link_singola);
						} else {
							abutils.alert('Errore su link!', 'Pagamento');
						}
					}
				},
				error : function() {
					// appstoreBuy(id_shopping24, id_itunes, callback);
					// BUY-------------------------------------------------------------------------------------------------
					console.log('buy');
					console.log("aaaa passsq3");
					var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
					var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
					var link_singola = '';
					for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
					// prova con i link
					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
						for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}
					}
					if (link_singola != '') {
						window.payment.paySingle(testata, p_edizione, p_issue,
								id_shopping24, id_itunes, link_singola);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}
				}
			});
}/**
	 * @author ABertacco, MConventi
	 */
var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;
var _PREFERITI_ISCROLL_MENU = null;
var _PREFERITI_ISCROLL_VISTA = null;
var _PREFERITI_ISCROLL_DETTAGLIO = null;

// Lista di prodotti da inserire nel menu di sinistra tra i prodotti
/*
 * viene calcolata in base agli articoli presenti in db var
 * _PREFERITI_PRODUCTS_LIST = [ { testata: 'S24', nome: "Il Sole 24 ORE", icon:
 * 'imgs/fake/s24_small_icon.png' } ];
 */
var _PREFERITI_PRODUCTS_LIST = null;

function preferitiLoadMenuTag() {
	preferitiLoadMenu('TAG');
}

function preferitiLoadMenuProdotto() {
	preferitiLoadMenu('PRODOTTO');
}

function preferitiLoadMenu(mode) {
	$('#preferiti_titolo_menu_opzioni_prodotto').removeClass('newgray24');
	$('#preferiti_titolo_menu_opzioni_tag').removeClass('newgray24');
	$('#preferiti_body_menu_container').empty();

	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.destroy();
		_PREFERITI_ISCROLL_MENU = null;
	}

	if (mode == 'PRODOTTO') {
		$('#preferiti_titolo_menu_opzioni_prodotto').addClass('newgray24');
		preferitiInitProductList();
	} else {
		$('#preferiti_titolo_menu_opzioni_tag').addClass('newgray24');
		preferitiInitTagList();
	}

}

function searchPref(search) {
	console.log('search is ' + search);

	/*
	 * db.transaction(function(tx) { tx.executeSql("SELECT id FROM table LIMIT
	 * 1", [], function(tx, result) { row = result.rows.item(0); }, function(tx,
	 * error) { }); });
	 * 
	 * return row;
	 * 
	 */
	if (search == null)
		return;

	if (_DB) {
		_DB
				.transaction(function(tx) {
					// 'occhiello text, titolo text, sottotitolo text, firma
					// text, testo text';
					var l_query = 'occhiello like ? OR titolo like ? OR sottotitolo like ? OR firma like ? OR testo like ?';
					var tmpsearch = search.split(' ');
					var s = '';
					// GLOBAL REPLACE
					// DA FARE
					var args = new Array(tmpsearch.length * 5);
					for ( var i = 0; i < tmpsearch.length; i++) {
						if (i > 0)
							l_query += " OR " + l_query;
						s = tmpsearch[i];// "4,250%";
						s = s.replace(/%/g, "\\%");
						s = s.replace(/_/g, "\\_");
						s = s.replace(/&rsquo;/g, "\'");
						s = s.replace(/&quot;/g, "\"");
						s = "%" + s + "%";
						for ( var j = i * 5; j < (i + 1) * 5; j++)
							args[j] = s;
						console.log("search2323 selec " + s);
					}
					search = "%" + search + "%";
					tx
							.executeSql(
									'SELECT * FROM '
											+ _PREFERITI_ARTICLE_DB_NAME
											+ ' WHERE ' + l_query + " escape '"
											+ "\\"
											+ "' order by issue DESC, pagina ;",
									args,
									function(tx, p_results) {
										var row = null;
										if (p_results != null
												&& p_results.rows.length != 0) {
											for ( var irow = 0; irow < p_results.rows.length; irow++) {
												row = p_results.rows.item(irow);
												// console.log("testo[0]
												// "+row.testo);
												// 'artid text unique, testata
												// text, testata_descr text,
												// issue text, issue_descr text,
												// edizione text, edizione_descr
												// text, sezione text, pagina
												// text, occhiello text, titolo
												// text, sottotitolo text, firma
												// text, testo text, dttm, tags
												// text';
												window.searchlaunch.addResult(
														row.artid, row.testata,
														row.testata_descr,
														row.issue,
														row.issue_descr,
														row.edizione,
														row.edizione_descr,
														row.sezione,
														row.pagina,
														row.occhiello,
														row.titolo,
														row.sottotitolo,
														row.firma, row.testo);
												row = null;
											}

											window.searchlaunch
													.broadcastResult();
										} else {
											console.log('search res '
													+ p_results);
											window.searchlaunch
													.broadcastResult();
										}

									}, function(tx, error) {
										alert(error);
									});

				});

		// _DB.transaction(querySearch);

	}
}

function getArticleFromId(artid) {
	if (_DB) {
		_DB.transaction(function(tx) {

			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' WHERE artid = ? ;', [ artid ], function(tx, p_results) {
				var row = null;
				if (p_results != null && p_results.rows.length != 0) {
					preferitiDettaglio(p_results.rows.item(0));
				} else {
					console.log('search res ' + p_results);
				}

			}, function(tx, error) {
				alert(error);
			});

		});

	}
}

/**
 * Crea gli elementi per un singolo articolo
 * 
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_vista_container').appendChild(box);
	box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
	box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
	box.onclick = function() {

		if ($('#preferiti_body_vista_container').hasClass(
				'preferiti_modify_view')) {
			popupPreferitiUpdateArticle(p_article);
		} else {
			preferitiDettaglio(p_article);
		}
	};

	var boxtb = document.createElement('table');
	box.appendChild(boxtb);

	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);

	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);

	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);

	var status_box = document.createElement('div');
	boxtd1.appendChild(status_box);
	status_box.className = 'preferiti_body_vista_container_box_status';
	// Gestisce la selezione dei preferiti quando l'utente si trova nella
	// tipologia "modifica"
	status_box.onclick = function(p_event) {
		var l_message_header = $(document
				.getElementById('preferiti_body_vista_container_box_'
						+ p_article.artid));

		if (l_message_header
				.hasClass('preferiti_body_vista_container_box_status_unselected')) {
			l_message_header
					.removeClass('preferiti_body_vista_container_box_status_unselected');
			l_message_header
					.addClass('preferiti_body_vista_container_box_status_selected');

		} else if (l_message_header
				.hasClass('preferiti_body_vista_container_box_status_selected')) {
			l_message_header
					.removeClass('preferiti_body_vista_container_box_status_selected');
			l_message_header
					.addClass('preferiti_body_vista_container_box_status_unselected');
		}

		p_event.stopPropagation();
	};

	if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
		status_box.style.display = 'block';
	}
	status_box = null;

	var title = document.createElement('div');
	boxtd2.appendChild(title);
	title.className = 'preferiti_body_vista_container_box_title';
	title.appendChild(document.createTextNode(p_article.titolo));
	title = null;

	var descr = document.createElement('div');
	boxtd2.appendChild(descr);
	descr.className = 'preferiti_body_vista_container_box_descr';
	descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> '
			+ p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
	descr = null;

	var tags = document.createElement('div');
	boxtd2.appendChild(tags);
	tags.className = 'preferiti_body_vista_container_box_tags';
	// tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags
	// + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_'
			+ p_article.artid + '">' + p_article.tags + '</span>';
	tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
	tags = null;

	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei prodotti in base ai
 * dati inseriti in _PREFERITI_PRODUCTS_LIST
 */
function preferitiInitProductList() {
	/*
	 * for (var i=0; i < _PREFERITI_PRODUCTS_LIST.length; i++){
	 * preferitiMenuRenderProduct(_PREFERITI_PRODUCTS_LIST[i]); } if
	 * (_PREFERITI_ISCROLL_MENU == null) { _PREFERITI_ISCROLL_MENU = new
	 * iScroll('preferiti_body_menu_wrapper'); } else {
	 * _PREFERITI_ISCROLL_MENU.refresh(); }
	 */
	_PREFERITI_PRODUCTS_LIST = [];

	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for ( var i = 0; i < p_results.rows.length; i++) {
				var l_row = p_results.rows.item(i);
				preferitiMenuRenderProduct({
					testata : l_row.testata,
					nome : l_row.testata_descr,
					icon : 'imgs/fake/s24_small_icon.png' // icona
															// indipendente
															// dalla testata
				});
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll(
						'preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}

			if (p_results.rows.length > 0) {
				// apro il primo elemento nel menu
				// preferitiLoadArticlesByProduct(p_results.rows.item(0).testata);
				$(
						'#preferiti_body_menu_container_box_id_'
								+ p_results.rows.item(0).testata.replace(
										/[^a-zA-Z0-9]+/g, '')).click();
			}
		}

		var queryError = function(p_error) {
			console.log("preferitiInitProductList: Error processing SQL: "
					+ p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}

		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_ARTICLE_DB_NAME + ' ('
					+ _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			var l_query = 'SELECT testata, testata_descr FROM '
					+ _PREFERITI_ARTICLE_DB_NAME
					+ ' GROUP BY testata, testata_descr ORDER BY testata_descr';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Crea un elemento prodotto nel menu a sinistra della finestra dei preferiti
 * 
 * @params p_product Oggetto tag così come presente in _PREFERITI_PRODUCTS_LIST
 */
function preferitiMenuRenderProduct(p_product) {

	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_box';
	box.id = 'preferiti_body_menu_container_box_id_'
			+ p_product.testata.replace(/[^a-zA-Z 0-9]+/g, '');

	box.appendChild(document.createTextNode(p_product.nome));

	var icon = document.createElement('img');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_box_icon';
	icon.src = p_product.icon;

	box.onclick = (function() {
		preferitiLoadArticlesByProduct(p_product.testata);

		$('.preferiti_body_menu_container_box').removeClass(
				'preferiti_body_menu_container_box_active');
		$(this).addClass('preferiti_body_menu_container_box_active');
	});
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei tag attualmente nel
 * database dei preferiti
 */
function preferitiInitTagList() {

	// Inizializza la lista dei tag nel menu di sinistra
	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for ( var i = 0; i < p_results.rows.length; i++) {
				preferitiMenuRenderTag(p_results.rows.item(i));
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll(
						'preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}

			if (p_results.rows.length > 0) {
				// apro il primo elemento nel menu
				$(
						'#preferiti_body_menu_container_boxtag_id_'
								+ p_results.rows.item(0).nome.replace(
										/[^a-zA-Z0-9]+/g, '')).click();
			}
		}

		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticle: Error processing SQL: "
					+ p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}

		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS
					+ ')');
			// var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM
			// '+_PREFERITI_TAG_DB_NAME+' GROUP BY nome ORDER BY num_articles';
			var l_query = 'SELECT nome FROM ' + _PREFERITI_TAG_DB_NAME
					+ ' GROUP BY nome ORDER BY nome';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Crea un elemento tag nel menu a sinistra della finestra dei preferiti
 * 
 * @params p_tag Oggetto tag così come presente nel db _PREFERITI_TAG_DB_NAME
 */
function preferitiMenuRenderTag(p_tag) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_boxtag';
	box.id = 'preferiti_body_menu_container_boxtag_id_'
			+ p_tag.nome.replace(/[^a-zA-Z0-9]+/g, '');
	box.appendChild(document.createTextNode(p_tag.nome));

	var icon = document.createElement('div');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_boxtag_icon';

	box.onclick = (function() {

		preferitiLoadArticlesByTag(p_tag.nome);

		// Setta il tag attivo nel menu di sinistra
		$('.preferiti_body_menu_container_boxtag').removeClass(
				'preferiti_body_menu_container_boxtag_active');
		$('.preferiti_body_menu_container_boxtag_icon').removeClass(
				'preferiti_body_menu_container_boxtag_icon_active');
		$(this).addClass('preferiti_body_menu_container_boxtag_active');
		var icon = this
				.querySelector('div.preferiti_body_menu_container_boxtag_icon');
		if (icon != null) {
			$(icon)
					.addClass(
							'preferiti_body_menu_container_boxtag_icon_active');
		}
	});
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * 
 * @params p_articles Array di articoli così come definiti nel db locale
 *         _PREFERITI_ARTICLE_DB_NAME
 */
function preferitiOpenArticlesList(p_articles) {
	/*
	 * if (_PREFERITI_ISCROLL_VISTA != null) {
	 * _PREFERITI_ISCROLL_VISTA.destroy(); _PREFERITI_ISCROLL_VISTA = null; }
	 */

	$('#preferiti_body_vista_container').empty();

	for ( var i = 0; i < p_articles.length; i++) {
		renderPreferitiArticle(p_articles.item(i));
	}

	if (_PREFERITI_ISCROLL_VISTA == null) {
		_PREFERITI_ISCROLL_VISTA = new iScroll('preferiti_body_vista_wrapper');
	} else {
		_PREFERITI_ISCROLL_VISTA.refresh();
		// alert('aaaaa');
		_PREFERITI_ISCROLL_VISTA.scrollTo(0, -2, 0);
	}
}

/**
 * Passa alla modalità modifica preferiti
 */
function preferitiSwitchToModifyView() {
	$('#preferiti_list_modify_button').hide();
	$('#preferiti_list_show_button').show();
	$('#preferiti_body_vista_container').addClass('preferiti_modify_view');
	$('.preferiti_body_vista_container_box_status').fadeIn();
	$('#elimina_preferiti').fadeIn();
}

/**
 * Passa alla modalità visualizza preferiti
 */
function preferitiSwitchToShowView() {
	$('#preferiti_list_show_button').hide();
	$('#preferiti_list_modify_button').show();
	$('.preferiti_body_vista_container_box_status').hide();

	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	l_selected_items
			.removeClass('preferiti_body_vista_container_box_status_selected');
	l_selected_items
			.addClass('preferiti_body_vista_container_box_status_unselected');

	$('#preferiti_body_vista_container').removeClass('preferiti_modify_view');
	$('#elimina_preferiti').fadeOut();
}

/*******************************************************************************
 * Gestione eliminazione preferiti
 ******************************************************************************/
/**
 * Elimina i record selezionati in modalità modifica
 */
function preferitiDeleteArticles() {
	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	var l_items = '';

	for ( var i = 0; i < l_selected_items.length; i++) {
		var l_pid = l_selected_items[i].id.substring(35);
		if (i > 0)
			l_items += ',';
		l_items += '"' + l_pid + '"';
	}

	if (l_items != '') {
		deletePreferitiFromDB(l_items);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun articolo',
				'Preferiti');
	}
}

/*
 * Elimina i record dal database @params p_artids Lista dei identificativi degli
 * articoli
 */
function deletePreferitiFromDB(p_artids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB && p_artids.length > 0) {

		var queryArticleSuccess = function() {
			console.log('Deleted preferiti ' + p_artids);
			deletePreferitiElements();
		}

		var queryTagSuccess = function() {
			console.log('Deleted tags ' + p_artids);
		}

		var queryError = function(p_error) {
			console.log("deletePreferitiFromDB: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' WHERE artid in (' + p_artids + ')', [],
					queryArticleSuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME
					+ ' WHERE artid in (' + p_artids + ')', [],
					queryTagSuccess, queryError);

			// queryArticleSuccess();
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Elimina gli elementi html relativi agli articoli preferiti
 * 
 * @params p_pids Lista degli identificativi degli articoli che devono essere
 *         eliminati
 */
function deletePreferitiElements() {
	$('.preferiti_body_vista_container_box_status_selected').remove();
}

/*******************************************************************************
 * Gestione caricamento preferiti
 ******************************************************************************/
/*
 * Restituisce gli articoli preferiti presenti nel database locale @params
 * p_testata Identificativo del prodotto @return Lista di articoli
 */
function preferitiLoadArticlesByProduct(p_testata) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_testata) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len
					+ " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}

		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_ARTICLE_DB_NAME + ' ('
					+ _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' WHERE testata=?', [ p_testata ], querySuccess,
					queryError);
		}

		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

/*
 * Restituisce gli articoli preferiti presenti nel database locale in base ad un
 * tag @params p_tag Il nome del tag @return Lista di articoli
 */
function preferitiLoadArticlesByTag(p_tag) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_tag) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len
					+ " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}

		var tagQuerySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " tags from the local TAG table.");
			var l_articles = '';
			for ( var i = 0; i < p_results.rows.length; i++) {
				if (i > 0)
					l_articles += ',';
				l_articles += '"' + p_results.rows.item(i).artid + '"';
			}
			console.log("Read " + l_articles);

			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_ARTICLE_DB_NAME + ' ('
					+ _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' WHERE artid IN (' + l_articles + ')', [], querySuccess,
					queryError);
		}

		var queryError = function(p_error) {
			console.log("preferitiLoadArticlesByTag: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			console.log("tag: " + p_tag);
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS
					+ ')');
			tx.executeSql('SELECT artid FROM ' + _PREFERITI_TAG_DB_NAME
					+ ' WHERE nome=?', [ p_tag ], tagQuerySuccess, queryError);
		}

		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

/*******************************************************************************
 * Gestione popup modifica preferiti
 ******************************************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * 
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {
	// $('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').text(p_article.titolo);
		$('#modifica_articolo_preferito_text').html(
				'<strong>' + p_article.edizione_descr + '</strong> '
						+ p_article.issue_descr + ' - pag. '
						+ parseInt(p_article.pagina));
		// $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id_tags').val(
				$(
						'#preferiti_body_vista_container_box_tags_span_'
								+ p_article.artid).html());
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for ( var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help
								.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\''
										+ tag.nome
										+ '\', this)" value="'
										+ tag.nome + '" />');
				}
			}

			var queryError = function(p_error) {
				console
						.log("popupPreferitiUpdateArticle: Error processing SQL: "
								+ p_error.message);
			}

			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS '
						+ _PREFERITI_TAG_DB_NAME + ' ('
						+ _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM '
						+ _PREFERITI_TAG_DB_NAME
						+ ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,'
						+ _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo
 * preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();

	// Salva le modifiche
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: "
							+ p_results.rowsAffected);
		}

		var updateQuerySuccess = function(tx, p_results) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Update article success");
			/*
			 * if (p_results.rowsAffected > 0) {
			 * document.getElementById('preferiti_body_vista_container_box_tags_' +
			 * l_artid).innerHTML = 'Tags: ' + l_tags; }
			 */
		}

		var queryError = function(p_error) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: "
							+ p_error.message);
		}

		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' SET tags=? WHERE artid=?', [ l_tags, l_artid ],
					updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME
					+ ' WHERE artid=? OR artid=""', [ l_artid ], querySuccess,
					queryError);

			var l_tags_array = l_tags.toLowerCase().split(',');
			for ( var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); // TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME
						+ ' (nome, artid) VALUES(?,?)', [ l_tag, l_artid ],
						querySuccess, queryError);
			}
		}

		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}

	var l_tags_el = document
			.getElementById('preferiti_body_vista_container_box_tags_span_'
					+ l_artid);
	if (l_tags_el) {
		l_tags_el.innerHTML = l_tags;
	}
	l_tags_el = null;

	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	// $('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

/*******************************************************************************
 * Gestione Dettaglio Preferiti
 ******************************************************************************/
/**
 * Apre il dettaglio dei preferiti
 */
function preferitiDettaglio(p_article) {

	// Inizializzazione dati articolo
	$('#preferiti_dettaglio_titolo').text(p_article.titolo);
	$('#preferiti_dettaglio_occhiello').text(p_article.occhiello);
	$('#preferiti_dettaglio_sottotitolo').text(p_article.sottotitolo);
	$('#preferiti_dettaglio_other_info').html(
			'<strong>' + p_article.edizione_descr + '</strong> '
					+ p_article.issue_descr + ' - pag. '
					+ parseInt(p_article.pagina));
	$('#preferiti_dettaglio_firma').text(p_article.firma);
	$('#preferiti_dettaglio_text').html(p_article.testo);
	$('#preferiti_dettaglio_header_modifica input').click(function() {
		popupPreferitiUpdateArticle(p_article);
	});

	// $('#preferiti_dettaglio').fadeIn(200, function(){
	$('#preferiti_dettaglio').css('display', 'inline-block');

	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	} else {
		_PREFERITI_ISCROLL_DETTAGLIO = new iScroll(
				'preferiti_dettaglio_wrapper');
	}
	// });

	omnitureTrackApp('APP:preferiti:open:' + p_article.artid, 'APP:preferiti');
}

/**
 * Chiude il dettaglio dei preferiti
 */
function preferitiDettaglioChiudi() {
	// $('#preferiti_dettaglio').fadeOut(200);
	$('#preferiti_dettaglio').css('display', 'none');
}

function preferitiUpdateOrientation() {
	if (_PREFERITI_ISCROLL_VISTA != null) {
		_PREFERITI_ISCROLL_VISTA.refresh();
	}
	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.refresh();
	}
	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	}
}

/**
 * @author ABertacco FSantagada
 */
var _ARCHIVIO_ISOPEN = false;
var _ARCHIVIO_RENDERED_ITEMS = null;
var _PROID = null;
function archivioOpen(p_product_id, isFromSfoglio) {
	_ARCHIVIO_ISOPEN = true;

	_PROID = p_product_id;

	archivioLoad(p_product_id);
	// archivioLoad();
	archivioLoadAdv(p_product_id);

	// Inizializzazione filtro edizioni
	archivioInitFilter();

	$('#archivio_titolo_chiudi_edicola').css('display',
			(isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#archivio_titolo_chiudi_sfoglio').css('display',
			(isFromSfoglio == true ? 'inline-block' : 'none'));

	// $('#archivio').fadeIn();
	$('#archivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function archivioClose() {
	// $('#archivio').fadeOut();
	$('#archivio').css('display', 'none');
	if (_ARCHIVIO_ISCROLL != null) {
		_ARCHIVIO_ISCROLL.destroy();
		_ARCHIVIO_ISCROLL = null;
	}
	_ARCHIVIO_ISOPEN = false;
}

function archivioCloseSfoglia() {
	// appmenuSfoglioOpen();
	openFlipper();
}

function archivioLoadAdv(p_product_id) {
	document.getElementById('archivio_footer_adv').innerHTML = '';
	// $('#qarchivio_footer_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Bottom', function(){
	// }).endCapture();
	// http://mobapp24.ilsole24ore.com/adv_proxy.php?z=SFO_INTERSTITIAL&t=S24&d=123

	// *********************DA SOSTITUIRE!!!!!!************************
	$('#archivio_footer_adv')
			.writeCapture()
			.load(
					/*
					 * 'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' +
					 * device.uuid + '@Bottom'
					 */_ADV_PROXY
							+ '?z=ARC_BOTTOM&p='
							+ p_product_id
							+ '&d='
							+ device.uuid + '&s=' + _SCREENADV, function() {
					}).endCapture();
}

function archivioLoadTutti() {
	archivioModificaFine();
	archivioLoadMenu('TUTTI');
}

function archivioLoadAcquisti() {
	archivioLoadMenu('ACQUISTI');
}

function archivioLoadMenu(mode) {
	$('#archivio_subtitolo_opzioni_tutti').removeClass('gray24');
	$('#archivio_subtitolo_opzioni_acquisti').removeClass('gray24');
	if (mode == 'TUTTI') {
		$('#archivio_subtitolo_opzioni_tutti').addClass('gray24');
		$('.archivio_container_box').css('display', 'inline-block');
	} else {
		$('#archivio_subtitolo_opzioni_acquisti').addClass('gray24');
		$('.archivio_container_box_isremote').css('display', 'none');
	}

	archivioUpdateIscroll();
}

var _ARCHIVIO_IS_IN_MODIFICA = false;
function archivioModifica() {
	_ARCHIVIO_IS_IN_MODIFICA = true;
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display',
			'inline-block');
	archivioLoadAcquisti();
	$('.archivio_container_box > div > .archivio_button_sfoglia').css(
			'display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_elimina').css(
			'display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('LOCAL');
}

function archivioModificaFine() {
	_ARCHIVIO_IS_IN_MODIFICA = false;
	$('#archivio_subtitolo_opzioni_modifica_fine').css('display', 'none');
	$('#archivio_subtitolo_opzioni_modifica').css('display', 'inline-block');
	archivioLoadAcquisti();
	// alert($('#archivio_wrapper').html());
	$('.archivio_container_box > div > .archivio_button_elimina').css(
			'display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_sfoglia').css(
			'display', 'inline-block');
	$('.archivio_container_box_isremote > div > .archivio_button_acquista')
			.css('display', 'inline-block');
	
	$('#archivio_filtro_edizioni_tempo').val(_PROID);
	archivioAggiornaContenutoVisualizzato();
}

var _ARCHIVIO_ISCROLL = null;
function archivioUpdateIscroll() {
	if (!_ARCHIVIO_ISOPEN)
		return;
	setTimeout(function() {
		if (_ARCHIVIO_ISCROLL == null) {
			_ARCHIVIO_ISCROLL = new iScroll('archivio_wrapper', {
				hideScrollbar : false
			});
		} else {
			_ARCHIVIO_ISCROLL.refresh();
		}
	}, 100);
}

var _ARCHIVIO_BOXES_INLINE_V = 2;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _ARCHIVIO_BOXES_INLINE_H = 3;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _ARCHIVIO_COUNT = 0;
function archivioLoad(p_product_id) {
	$('#archivio_container').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_ARCHIVIO_RENDERED_ITEMS = {};

	console.log('---REQ---> past-issues/' + p_product_id);
	console.log(l_request_headers);
	console.log(l_request_data);

	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id
						+ ".json",
				headers : l_request_headers,
				data : l_request_data,
				dataType : "json",
				success : function(p_response) {

					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> past-issues/' + p_product_id);
					console.log(p_response);

					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						archivioLoad(p_product_id);
					})) {
						var res = p_response.Result.res;

						_ARCHIVIO_PRODUCT = res;

						archivioRenderItems();

						for ( var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
							var l_single_offers = _ARCHIVIO_PRODUCT.items[i].singleOffers;
							if (l_single_offers == null)
								continue;
							for ( var j = 0; j < l_single_offers.length; j++) {
								// appstoreReqProduct(l_single_offers[j].offerId,
								// l_single_offers[j].offerItunesProductId);
							}
						}
						// appstoreReqProducts();
					} else {
						console.log('archivioLoad: Error, '
								+ p_response.Exception.Description);
						abutils
								.alert(
										'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
										'Arretrati');
						_ARCHIVIO_PRODUCT = {
							items : [],
							testata : _MAP_CODICE_TESTATA['' + p_product_id]
						};
						archivioRenderItems();
					}
				},
				error : function() {
					abutils
							.alert(
									'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
									'Arretrati');
					_ARCHIVIO_PRODUCT = {
						items : [],
						testata : _MAP_CODICE_TESTATA['' + p_product_id]
					};
					archivioRenderItems();
				}
			});

}

var _ARCHIVIO_LOCAL_ITEMS;
var _ARCHIVIO_LOCAL_ITEMS_ISSUE;
function archivioRenderItems() {
	_ARCHIVIO_LOCAL_ITEMS = [];
	_ARCHIVIO_LOCAL_ITEMS_ISSUE = [];
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioRenderItems: read items:" + len);

			for ( var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue
						+ '_' + l_local_item.edizione;

				_ARCHIVIO_LOCAL_ITEMS.push(l_item_id);
				_ARCHIVIO_LOCAL_ITEMS_ISSUE.push(l_local_item.testata + '_'
						+ l_local_item.issue);
			}

			archivioRenderItems_aux();
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql(
					'SELECT * FROM issues WHERE testata=? ORDER BY issue DESC',
					[ _ARCHIVIO_PRODUCT.testata ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function archivioRenderItems_aux() {
	console.log('archivioRenderItems...');
	console.log(_ARCHIVIO_LOCAL_ITEMS);

	_ARCHIVIO_RENDERED_ITEMS = {};
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId];
	console.log(_EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId]);
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#archivio_titolo_prodotto').text(l_product_details.name);

	// var l_sole_count_per_cover = 0;
	for ( var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
		for ( var j = 0; j < _ARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
			var l_item_id = _ARCHIVIO_PRODUCT.testata + '_'
					+ _ARCHIVIO_PRODUCT.items[i].editionId + '_'
					+ _ARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

			if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
				_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
				// archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j,
				// (l_sole_count_per_cover <= 12) && (i <= 20));
				archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, i < 30);
			}
		}
	}

	archivioLoadLocalData();
}

function archivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	console.log('archivioRenderAsIcon');

	archivioUpdateFilter(p_item.inserts[p_insert_index].insertId,
			p_item.inserts[p_insert_index].description);

	var item_full_id = _ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_"
			+ p_item.inserts[p_insert_index].insertId;
	var isLocal = $.inArray(item_full_id, _ARCHIVIO_LOCAL_ITEMS) != -1;
	var isLocalFree = $.inArray(_ARCHIVIO_PRODUCT.testata + "_"
			+ p_item.editionId, _ARCHIVIO_LOCAL_ITEMS_ISSUE) != -1;

	var l_premium = p_item.inserts[p_insert_index].premium
			&& (parseInt(p_item.inserts[p_insert_index].premium) > 0) ? true
			: false;

	// console.log(item_full_id + ' ' + isLocal + ' ' + isLocalFree);

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box '
			+ p_item.inserts[p_insert_index].insertId;
	// box.id = 'archivio_container_box_' + p_insert_index + '_' +
	// p_item.editionId;
	box.id = 'archivio_container_box_' + item_full_id;
	// box.style['display'] = 'none';

	// console.log(item_full_id + " " + (isLocal ? "LOCAL" : "REMOTE"));

	$(box).addClass(
			isLocal ? 'archivio_container_box_islocal'
					: 'archivio_container_box_isremote');

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = p_item.inserts[p_insert_index].cover;

	if (l_premium) {
		var premiumflag = document.createElement('img');
		imgdiv.appendChild(premiumflag);
		premiumflag.className = 'archivio_container_box_img_div_premiumflag';
		premiumflag.src = 'imgs/inserto_abbonati_archivio.png';
		// premiumflag.innerHTML = 'Inserto per abbonati';
	}

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	if (screen.width > 790)
		txt_elimina.style['width'] = '100px';
	else
		txt_elimina.style['width'] = '60px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind(
			'click',
			function() {
				// eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata,
				// p_item.editionId, p_item.inserts[p_insert_index].insertId,
				// p_item.singleOffers[0].offerId,
				// p_item.singleOffers[0].offerItunesProductId);
				eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId,
						p_item.inserts[p_insert_index].insertId);
			});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	// se issue già presente in locale
	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	if (screen.width < 790)
		txt_sfoglia.style['width'] = '60px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind(
			'click',
			function() {
				// sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId,
				// p_item.inserts[p_insert_index].insertId,
				// p_item.singleOffers[0].offerId,
				// p_item.singleOffers[0].offerItunesProductId);
				sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId,
						p_item.inserts[p_insert_index].insertId);
			});
	txt_sfoglia.style.display = isLocal ? 'inline-block' : 'none';
	txt_sfoglia = null;

	// se issue non presente in locale
	var l_prezzo = "";
	if (p_item.free || p_item.subscription
			|| (p_item.singleOffers && (p_item.singleOffers.length > 0))) {
		var txt_acquista = document.createElement('div');
		txt.appendChild(txt_acquista);
		txt_acquista.className = 'button medium red24 archivio_button_acquista';
		txt_acquista.style['text-align'] = 'center';
		// txt_acquista.appendChild(document.createTextNode('0,79 €'));

		if (l_premium && (!p_item.subscription) && (!p_item.free)) {
			txt_acquista.innerHTML = 'Per abbonati';
			$(txt_acquista).bind('click', function() {
				mostraPopupInsertoAbbonati();
			});
		} else {

			if (p_item.free || p_item.subscription || isLocalFree) {
				txt_acquista.innerHTML = 'Sfoglia';
				$(txt_acquista).bind(
						'click',
						function() {
							// sfoglia(_ARCHIVIO_PRODUCT.testata,
							// p_item.editionId,
							// p_item.inserts[p_insert_index].insertId,
							// p_item.singleOffers[0].offerId,
							// p_item.singleOffers[0].offerItunesProductId);
							sfoglia(_ARCHIVIO_PRODUCT.testata,
									p_item.editionId,
									p_item.inserts[p_insert_index].insertId);
						});
			} else {
				// txt_acquista.innerHTML = 'Acquista ' +
				// ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				l_prezzo = "<br />"
						+ ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				txt_acquista.innerHTML = 'Seleziona';
				$(txt_acquista)
						.bind(
								'click',
								function() {
									// acquistoSingolo(_ARCHIVIO_PRODUCT.testata,
									// p_item.editionId,
									// p_item.inserts[p_insert_index].insertId,
									// p_item.singleOffers[0].offerId,
									// p_item.singleOffers[0].offerItunesProductId);

									var link_singola = '';
									for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
										// _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType']
										// == 'link_singola'
										if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
											link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
										}
									}
									// prova con i link

									if (!link_singola || link_singola == '') {
										_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'] = _PRODUCTLINK;
										for ( var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
											if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
												link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
											}
										}
									}

									// alert('aaaa');
									// alert('link: '+link_singola);
									// alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
									if (link_singola != '') {
										window.payment
												.paySingle(
														_ARCHIVIO_PRODUCT.testata,
														p_item.editionId,
														p_item.inserts[p_insert_index].insertId,
														p_item.singleOffers[0].offerId,
														p_item.singleOffers[0].offerItunesProductId,
														link_singola);
										console
												.log('offerItunesProductId '
														+ p_item.singleOffers[0].offerItunesProductId);
									} else {
										abutils.alert('Errore su link!',
												'Pagamento');
									}

								});
			}
		}
		txt_acquista.style.display = !isLocal ? 'inline-block' : 'none';
		txt_acquista = null;
	}
	// }

	// ATTENZIONE: solo per test
	// p_item.inserts[p_insert_index].anteprima = 5;
	if ((!isLocalFree) && (!p_item.free) && (!p_item.subscription)
			&& p_item.inserts[p_insert_index].anteprima
			&& (parseInt(p_item.inserts[p_insert_index].anteprima) > 0)) {
		var txt_anteprima = document.createElement('div');
		txt.appendChild(txt_anteprima);
		txt_anteprima.className = 'button medium gray24 archivio_button_anteprima';
		txt_anteprima.style['text-align'] = 'center';
		txt_anteprima.appendChild(document.createTextNode('Anteprima'));
		$(txt_anteprima)
				.bind(
						'click',
						function() {
							openAnteprima(
									_ARCHIVIO_PRODUCT.testata,
									p_item.editionId,
									p_item.inserts[p_insert_index].insertId,
									parseInt(p_item.inserts[p_insert_index].anteprima));
						});
		txt_anteprima = null;
	}

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	// VERIFICA!!!!*************************************
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	// txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.inserts[p_insert_index].description;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	// txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre
	// 2011'));
	// txt_subtitolo.innerHTML = p_item.editionDescription;
	txt_subtitolo.innerHTML = p_item.editionDescription
			+ (!(isLocal || isLocalFree) ? l_prezzo : "");
	txt_subtitolo = null;

	if (isLocal) {
		var l_localdiv = document.createElement('img');
		txt.appendChild(l_localdiv);
		l_localdiv.className = 'archivio_container_box_txt_local_ICONS';
		l_localdiv.src = 'imgs/qarchivio_locale_flag.png';
		l_localdiv = null;
	}

	txt = null;
	box = null;

}

function archivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioLoadLocalData: read items:" + len);

			for ( var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue
						+ '_' + l_local_item.edizione;
				// console.log(l_item_id);

				if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					archivioRenderLocalAsIcon(l_local_item);

				}

			}

			archivioLoadTutti();
			setTimeout(function() {
				$('#archivio_loading').css('display', 'none');
			}, 500);
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql(
					'SELECT * FROM issues WHERE testata=? ORDER BY issue DESC',
					[ _ARCHIVIO_PRODUCT.testata ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

function archivioRenderLocalAsIcon(p_item) {
	console.log('archivioRenderLocalAsIcon');

	archivioUpdateFilter(p_item.edizione, p_item.edizione_descr);

	var item_full_id = p_item.testata + '_' + p_item.issue + '_'
			+ p_item.edizione;
	var isLocal = true;

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_container_box_islocal archivio_edizione_'
			+ p_item.edizione;
	box.id = 'archivio_container_box_' + item_full_id;

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = window.folder.getDir()
			+ /* navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' */'/'
			+ p_item.testata + '/' + p_item.issue + '/' + p_item.edizione
			+ '/cover.jpg';
	// ???? DA VERIFICARE******************************

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['width'] = '100px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['width'] = '100px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_sfoglia.style.display = 'inline-block';
	txt_sfoglia = null;

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	// txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.edizione_descr;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	// txt_subtitolo.appendChild(document.createTextNode('Lunedì 12 settembre
	// 2011'));
	txt_subtitolo.innerHTML = p_item.issue_descr;
	txt_subtitolo = null;

	txt = null;
	box = null;

}

var _ARCHIVIO_FILTRO_EDIZIONI = null;
function archivioInitFilter() {
	var l_filtro_tempo_select = $('#archivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_ARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#archivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	// var l_option = $('<option value="" selected="selected">Tutti i
	// prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);

}

function archivioUpdateFilter(p_edizione_id, p_edizione_descr) {
	if (jQuery.inArray(p_edizione_id, _ARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_ARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		var l_option = $('<option></option>');
		l_option.val(p_edizione_id);
		l_option.text(p_edizione_descr.replace('&igrave;', 'ì').replace(
				'&#39;', '\''));
		$('#archivio_filtro_edizioni').append(l_option);
	}
}

function archivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#archivio_filtro_edizioni_tempo option:selected');

	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box_isremote').css(
					'display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css(
					'display', 'inline-block');
		} else {
			/*
			$('#archivio_container .archivio_container_box_isremote').css(
					'display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css(
					'display', 'inline-block');
			$('#archivio_container .archivio_container_box_islocal').not(
					'.archivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');*/
			$('#archivio_container .archivio_container_box_isremote').css(
					'display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css(
					'display', 'inline-block');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box').css('display',
					'inline-block');
		} else {
			/*
			$('#archivio_container .archivio_container_box').not(
					'.archivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');
			$('#archivio_container .archivio_edizione_'
					+ l_selected_option.val()).css('display',
					'inline-block');*/
			$('#archivio_container .archivio_container_box').css('display',
			'inline-block');
		}
	}

	setTimeout(archivioUpdateIscroll, 100);
}/**
	 * @author ABertacco
	 */
var _QARCHIVIO_ISOPEN = false;
var _QARCHIVIO_MODE = 'ICONS';
var _QARCHIVIO_RENDERED_ITEMS = null;

var _QARCHIVIO_DEFAULT_EDIZIONE = 'SOLE';

var _PROID = null;

function qarchivioOpen(p_product_id, isFromSfoglio, defaultEdizione) {
	_QARCHIVIO_ISOPEN = true;
	_QARCHIVIO_DEFAULT_EDIZIONE = (defaultEdizione == null ? 'SOLE'
			: defaultEdizione);
	console.log('p_product_id ' + p_product_id);
	$('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'hidden');

	_PROID = p_product_id;
	// alert('aaa'+_PROID);
	qarchivioLoad('ICONS', p_product_id);
	qarchivioLoadAdv(p_product_id);
	// $('#qarchivio').fadeIn();

	$('#qarchivio_titolo_chiudi_edicola').css('display',
			(isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#qarchivio_titolo_chiudi_sfoglio').css('display',
			(isFromSfoglio == true ? 'inline-block' : 'none'));

	// $('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_loading').css('display', 'inline-block');
	$('#qarchivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function qarchivioClose() {
	// $('#qarchivio').fadeOut();
	$('#qarchivio').css('display', 'none');
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}
	_QARCHIVIO_ISOPEN = false;
}

function sfogliaArchivio(p_testata, p_issue, p_edizione) {
	var keyinput = "unread_message_sole";
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}

	if (typeof (window.localStorage) != 'undefined') {
		window.localStorage.setItem(keyinput, valoutput);
	} else {
		throw "window.localStorage, not defined";
	}

	window.loader.launchSfogliatore(p_testata, p_edizione, p_issue,
			"Descrizione" + valoutput);

}

function qarchivioCloseSfoglia() {
	// appmenuSfoglioOpen();
	// openFlipper();
	console.log("closesfoglia");

	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Attendere..." ]);

	try {
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		if (node.style.display == 'block'
				|| node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if (typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA,
				_CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE,
				"Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');

		qarchivioClose();
		setTimeout(function() {
			console.log("launch page " + _CURRENT_FLIPPER_PAGINA);
			window.simulatePG.exec(null, null, "Notification", "activityStop",
					[]);
			// window.go.to(_CURRENT_FLIPPER_PAGINA);

		}, 1500);
	} catch (exc) {
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}
}

function qarchivioLoadAdv(p_product_id) {
	document.getElementById('qarchivio_footer_adv').innerHTML = '';
	// 'http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
	$('#qarchivio_footer_adv')
			.writeCapture()
			.load(
					/*
					 * 'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' +
					 * device.uuid + '@Bottom'
					 */_ADV_PROXY
							+ '?z=ARC_BOTTOM&p='
							+ p_product_id
							+ '&d='
							+ device.uuid + '&s=' + _SCREENADV, function() {
					}).endCapture();
}

function updateRichBtn() {
}

var _QARCHIVIO_ISCROLL = null;
function qarchivioUpdateIScroll() {
	// updateRichBtn();
	if (!_QARCHIVIO_ISOPEN)
		return;
	if (_QARCHIVIO_ISCROLL == null) {
		_QARCHIVIO_ISCROLL = new iScroll('qarchivio_wrapper', {
			hideScrollbar : false
		});
	} else {
		_QARCHIVIO_ISCROLL.refresh();
	}
}

function qarchivioLoad(mode, p_product_id) {
	console.log("qarchivioLoad p_product_id: " + p_product_id);
	// se si cerca di cambiare vista e si è in modifica allora si toglie la
	// modifica
	if ($('#qarchivio_subtitolo_opzioni_visualizza').is(':visible'))
		qarchivioVisualizza();

	$('#qarchivio_loading').css('display', 'inline-block');
	if (mode) {
		_QARCHIVIO_MODE = mode;
	} else {
		if (_QARCHIVIO_MODE == null) {
			_QARCHIVIO_MODE = 'ICONS';
		}
	}

	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}

	$('#qarchivio_container').empty();
	$('#qarchivio_subtitolo_opzioni_vista1').removeClass(
			'qarchivio_subtitolo_opzioni_vista1_on');
	$('#qarchivio_subtitolo_opzioni_vista2').removeClass(
			'qarchivio_subtitolo_opzioni_vista2_on');

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_QARCHIVIO_RENDERED_ITEMS = {};

	if (p_product_id && p_product_id != '') {

		// Inizializzazione filtro edizioni
		qarchivioInitFilter();

		console.log('---REQ---> past-issues/' + p_product_id);
		console.log(l_request_headers);
		console.log(l_request_data);

		$
				.ajax({
					type : "GET",
					timeout : _AJAX_TIMEOUT,
					cache : false,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "products/past-issues/"
							+ p_product_id + ".json",
					headers : l_request_headers,
					data : l_request_data,
					dataType : "json",
					success : function(p_response) {

						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}

						console.log('---RESP--> past-issues/' + p_product_id);
						console.log(p_response);

						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response, function() {
							qarchivioLoad(mode, p_product_id);
						})) {
							var res = p_response.Result.res;

							_QARCHIVIO_PRODUCT = res;

							qarchivioRenderItems();
						} else {
							console.log('qarchivioLoad: Error, '
									+ p_response.Exception.Description);
							abutils
									.alert(
											'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
											'Arretrati');
							_QARCHIVIO_PRODUCT = {
								items : [],
								testata : _MAP_CODICE_TESTATA['' + p_product_id]
							};
							qarchivioRenderItems();
						}
					},
					error : function() {
						abutils
								.alert(
										'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
										'Arretrati');
						_QARCHIVIO_PRODUCT = {
							items : [],
							testata : _MAP_CODICE_TESTATA['' + p_product_id]
						};
						qarchivioRenderItems();
					}
				});

	} else {
		// _QARCHIVIO_PRODUCT = { items: [], testata:
		// _MAP_CODICE_TESTATA[''+p_product_id] };
		qarchivioRenderItems();
	}
	// alert('aaa '+$('#qarchivio_filtro_edizioni option:selected').val());
}

function qarchivioRenderItems() {
	console.log('qarchivioRenderItems...');
	_QARCHIVIO_RENDERED_ITEMS = {};
	// $('#qarchivio_titolo_prodotto').text(_QARCHIVIO_PRODUCT.productDescription);
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_QARCHIVIO_PRODUCT.productId];
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#qarchivio_titolo_prodotto').text(l_product_details.name);

	if (_QARCHIVIO_MODE == 'ICONS') {
		// modalità vista icone
		$('#qarchivio_subtitolo_opzioni_vista1').addClass(
				'qarchivio_subtitolo_opzioni_vista1_on');

		var l_sole_count_per_cover = 0;

		for ( var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for ( var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_'
						+ _QARCHIVIO_PRODUCT.items[i].editionId + '_'
						+ _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (_QARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
					l_sole_count_per_cover++;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsIcon(_QARCHIVIO_PRODUCT.items[i], j,
							(l_sole_count_per_cover <= 12) && (i <= 20));
				}
			}
		}
		console.log('prima di qarchivioLoadLocalData');
		// setTimeout("qarchivioLoadLocalData()",0);
		qarchivioLoadLocalData();
	} else {
		console.log("qarchivioRenderItems LIST");
		// modalità vista lista
		$('#qarchivio_subtitolo_opzioni_vista2').addClass(
				'qarchivio_subtitolo_opzioni_vista2_on');

		qarchivioRenderItems_List_aux();
	}
}

function qarchivioRenderItems_List_aux() {
	console.log('qarchivioRenderItems_List_aux...'
			+ _QARCHIVIO_PRODUCT.items.length);
	try {
		for ( var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for ( var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_'
						+ _QARCHIVIO_PRODUCT.items[i].editionId + '_'
						+ _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsList(_QARCHIVIO_PRODUCT.items[i], j);
				}
			}
		}

		qarchivioLoadLocalData();
	} catch (exc) {
		console.log("qarchivioRenderItems_List_aux::error: " + exc.message);
	}
}

var _CURRENT_QUEUE_LIST;
function downloadManagerCallbackQueueList(p_queue) {
	console.log('downloadManagerCallbackQueueList...');
	_CURRENT_QUEUE_LIST = p_queue;
	qarchivioRenderItems_List_aux();
	return "OK";
}

function isInQueueList(testata, issue, edizione) {
	// console.log('isInQueueList?');
	// console.log(testata + ' ' + issue + ' ' + edizione);
	if (_CURRENT_QUEUE_LIST == null)
		return false;
	for ( var i = 0; i < _CURRENT_QUEUE_LIST.length; i++) {
		var l_item = _CURRENT_QUEUE_LIST[i];
		// console.log(l_item.testata + ' ' + l_item.issue + ' ' +
		// l_item.edizione);
		if ((l_item.testata == testata) && (l_item.issue == issue)
				&& (l_item.edizione == edizione)) {
			return true;
		}
	}
	return false;
}

/**
 * Crea la rappresentazione di un arretrato come icona
 * 
 * @params p_item Oggetto rappresentante l'arretrato p_insert_index Indice
 *         dell'inserto
 */
function qarchivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + '
	// qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.inserts[p_insert_index].description)
			+ ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24')
			&& (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId,
			p_item.inserts[p_insert_index].description);

	var img_div = document.createElement('div');
	box.appendChild(img_div);
	img_div.className = 'qarchivio_container_box_img_div';
	img_div.id = 'qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	if (createCoverImg) {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = p_item.inserts[p_insert_index].cover;
	} else {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = 'imgs/fake/fake_cover.jpg';
	}

	if (p_item.inserts[p_insert_index].premium
			&& (parseInt(p_item.inserts[p_insert_index].premium) > 0)) {
		var premium_flag = document.createElement('img');
		img_div.appendChild(premium_flag);
		premium_flag.src = 'imgs/inserto_abbonati_archivio.png';
		premium_flag.className = 'qarchivio_container_box_img_div_premiumflag';
	}

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description
			+ '</strong><br />' + p_item.editionDescription;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	$(txt_local).click(
			function() {
				if ($('#qarchivio_container').hasClass('qarchivio_modify')
						&& ($(this)
								.hasClass('qarchivio_container_box_txt_local_'
										+ _QARCHIVIO_MODE))) {
					eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata,
							p_item.editionId,
							p_item.inserts[p_insert_index].insertId);
				}
			});
	checkLocalArretrato(p_item, p_insert_index);
}

/**
 * Crea la rappresentazione di un arretrato come lista
 * 
 * @params p_item Oggetto rappresentante l'arretrato p_insert_index Indice
 *         dell'inserto
 */
function qarchivioRenderAsList(p_item, p_insert_index) {
	console.log('qarchivioRenderAsList');
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + '
	// qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.inserts[p_insert_index].description)
			+ ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24')
			&& (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId,
			p_item.inserts[p_insert_index].description);

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description
			+ '</strong> ' + p_item.editionDescription;
	// p_item.editionTitle;
	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	btndiv.id = 'qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	btn.type = 'button';
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'qarchivio_hidden_btn';

	$(del_btn).click(
			function() {
				eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata,
						p_item.editionId,
						p_item.inserts[p_insert_index].insertId);
			});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + _QARCHIVIO_PRODUCT.testata + "_"
			+ p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + _QARCHIVIO_PRODUCT.testata
			+ "_" + p_item.editionId + "_"
			+ p_item.inserts[p_insert_index].insertId;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);

	checkLocalArretrato(p_item, p_insert_index);

}

/*******************************************************************************
 * Gestione caricamento arretrati salvati in locale
 ******************************************************************************/
/**
 * Carica gli articoli salvati in locale
 */
function qarchivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("qarchivioLoadLocalData: read items:" + len);

			for ( var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue
						+ '_' + l_local_item.edizione;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					if (_QARCHIVIO_MODE == 'ICONS') {
						qarchivioRenderLocalAsIcon(l_local_item);
					} else {
						console.log("NO ICONS");
						qarchivioRenderLocalAsList(l_local_item);
					}
				}

				qarchivioUpdateFilter(l_local_item.edizione,
						l_local_item.edizione_descr);
			}

			// Eseguendo l'evento di change del filtro prodotti, anche in caso
			// di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#qarchivio_filtro_edizioni').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.qarchivio_container_box_ICONS').height(
						Math.round(window.innerHeight / 7));
			} else {
				$('.qarchivio_container_box_ICONS').height(
						Math.round(window.innerHeight / 4));
			}

			setTimeout(function() {
				// $('#qarchivio_container').css('visibility', 'hidden');
				$('#qarchivio_loading').css('display', 'none');
				// $('#qarchivio_container').css('visibility', 'visible');
				$('#qarchivio_subtitolo_opzioni_mode').css('visibility',
						'visible');
				// window.simulate.redraw();

				if (_QARCHIVIO_ISCROLL != null) {
					_QARCHIVIO_ISCROLL.refresh();
					// FIX REDRAW
					_QARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
				}

			}, 500);

			/*
			 * setTimeout(function(){ window.scrollTo(0,0); },560);
			 */

		}
		var queryError = function(p_error) {
			console.log("qarchivioLoadLocalData: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql(
					'SELECT * FROM issues WHERE testata=? ORDER BY issue DESC',
					[ _QARCHIVIO_PRODUCT.testata ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un arretrato in locale come icona
 * 
 * @params p_item Arretrato in locale come salvato nel db issues
 */
function qarchivioRenderLocalAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.edizione + '
	// qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.edizione_descr)
			+ ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'qarchivio_container_box_img_div';
	$(img_div).click(function() {
		if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			console.log("sfoglia LIST archivio");
			// window.loader.local(true);
		}
	});
	box.appendChild(img_div);

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	var img = document.createElement('img');
	img_div_crop.appendChild(img);
	img.className = 'qarchivio_container_box_img';
	// ANDROID MODDED
	img.src = window.folder.getDir()
			+ /* navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' */'/'
			+ p_item.testata + '/' + p_item.issue + '/' + p_item.edizione
			+ '/cover_low.jpg';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong><br />'
			+ p_item.issue_descr;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_'
			+ _QARCHIVIO_MODE;
	$(txt_local).click(
			function() {
				if ($('#qarchivio_container').hasClass('qarchivio_modify')
						&& ($(this)
								.hasClass('qarchivio_container_box_txt_local_'
										+ _QARCHIVIO_MODE))) {
					eliminaCopiaLocale(p_item.testata, p_item.issue,
							p_item.edizione);
				}
			});

}

/**
 * Crea la rappresentazione in lista di un arretrato salvato in locale
 * 
 * @params p_item Arretrato in locale come salvato nel db issues
 * 
 */
function qarchivioRenderLocalAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.edizione + '
	// qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.edizione_descr)
			+ ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ +p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_'
			+ _QARCHIVIO_MODE;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> '
			+ p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + p_item.testata + '_'
			+ p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
		console.log("sfoglia LIST archivio");
		window.loader.local(true);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + p_item.testata + '_'
			+ p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + p_item.testata + "_" + p_item.edizione + "_"
			+ p_item.issue;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + p_item.testata + "_"
			+ p_item.edizione + "_" + p_item.issue;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);
}

/*******************************************************************************
 * Gestione filtro
 ******************************************************************************/
function qarchivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#qarchivio_filtro_edizioni_tempo option:selected');
	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_isremote').css(
					'display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css(
					'display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_isremote').css(
					'display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css(
					'display', 'inline-block');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').not(
					'.qarchivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$(
					'#qarchivio_container .qarchivio_container_box_'
							+ _QARCHIVIO_MODE).css('display', 'inline-block');
		} else {
			$(
					'#qarchivio_container .qarchivio_container_box_'
							+ _QARCHIVIO_MODE).not(
					'.qarchivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');
			$(
					'#qarchivio_container .qarchivio_edizione_'
							+ l_selected_option.val()).css('display',
					'inline-block');
		}

	}

	setTimeout(qarchivioUpdateIScroll, 100);
}

/**
 * Inizializza il filtro sulle edizioni da mostrare.
 */
var _QARCHIVIO_FILTRO_EDIZIONI = null;
function qarchivioInitFilter() {
	var l_filtro_tempo_select = $('#qarchivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});
	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_QARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#qarchivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});

	// var l_option = $('<option value="" selected="selected">Tutti i
	// prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);
	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	// l_option = $('<option value="SOLE" selected="selected">Il Sole 24
	// Ore</option>');
	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore")
			+ '" selected="selected">Il Sole 24 Ore</option>');
	l_filtro_edizioni_select.append(l_option);
	// _QARCHIVIO_FILTRO_EDIZIONI.push("SOLE", "Il Sole 24 Ore");
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore"),
			"Il Sole 24 Ore");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore"),
		label : "Il Sole 24 Ore"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	/*
	 * l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore
	 * lunedì") + '" selected="selected">Il Sole 24 Ore lunedì</option>');
	 * l_filtro_edizioni_select.append(l_option);
	 * _QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore
	 * lunedì"), "Il Sole 24 Ore lunedì");
	 * 
	 * row = { value : qarchivioLabelToValue("Il Sole 24 Ore lunedì"), label :
	 * "Il Sole 24 Ore lunedì" }; console.log('rich ' + row.value + ',' +
	 * row.label); _QARCHIVIOFILTRORICH.push(row);
	 */

	l_filtro_edizioni_select
			.append($('<optgroup label="Altre testate" id="qarchivio_filtro_edizioni_optgroup"></optgroup>'));
}

function qarchivioLabelToValue(p_label) {
	// return p_label.toLowerCase(p_label.replace(/[^a-zA-Z0-9]/g,'x'));
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function qarchivioUpdateFilter(p_edizione_id, p_edizione_descr) {

	if (jQuery.inArray(qarchivioLabelToValue(p_edizione_descr),
			_QARCHIVIO_FILTRO_EDIZIONI) == -1) {
		// _QARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		_QARCHIVIO_FILTRO_EDIZIONI.push(
				qarchivioLabelToValue(p_edizione_descr), p_edizione_descr);
		var row = {
			value : qarchivioLabelToValue(p_edizione_descr),
			label : p_edizione_descr
		};
		// console.log('rich '+row.value+','+row.label);
		_QARCHIVIOFILTRORICH.push(row);
		// console.log('rich '+_QARCHIVIOFILTRORICH[0].value);
		var l_option = $('<option></option>');

		l_option.val(qarchivioLabelToValue(p_edizione_descr));
		l_option.html(p_edizione_descr);
		// $('#qarchivio_filtro_edizioni').append(l_option);
		// console.log('append-->'+l_option.html());
		$('#qarchivio_filtro_edizioni_optgroup').append(l_option);
	}

	if (_QARCHIVIO_DEFAULT_EDIZIONE == p_edizione_id) {
		$('#qarchivio_filtro_edizioni').val(
				qarchivioLabelToValue(p_edizione_descr));
	}
}

_QARCHIVIOFILTRORICH = new Array();
function updateRichFilter() {
}

/*
 * Controlla se un arretrato sia stato scaricato in locale @params p_item
 * Arretrato p_insert_index Indice dell'inserto
 */
function checkLocalArretrato(p_item, p_insert_index) {

	var l_testata = _QARCHIVIO_PRODUCT.testata;
	var l_issue = p_item.editionId;
	var l_edizione = p_item.inserts[p_insert_index].insertId;
	var l_edizione_premium = p_item.inserts[p_insert_index].premium
			&& (parseInt(p_item.inserts[p_insert_index].premium) > 0);

	// Controlla se il prodotto sia stato già scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length <= 0)
				return;

			var l_query_result = p_results.rows.item(0);

			if (l_query_result.in_locale > 0) {
				$(
						'#qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
								+ p_insert_index + '_' + p_item.editionId)
						.addClass('qarchivio_container_box_isinlocal');
				document.getElementById('qarchivio_container_box_txt_'
						+ _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue
						+ '_' + l_edizione).className = 'qarchivio_container_box_txt_local_'
						+ _QARCHIVIO_MODE;
			} else {
				document.getElementById('qarchivio_container_box_txt_'
						+ _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue
						+ '_' + l_edizione).className = 'qarchivio_container_box_txt_empty_'
						+ _QARCHIVIO_MODE;
			}

			if (_QARCHIVIO_MODE == 'LIST') {
				var btn = document
						.getElementById('qarchivio_container_box_btn_'
								+ _QARCHIVIO_MODE + '_' + l_testata + '_'
								+ l_issue + '_' + l_edizione);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
					btn.value = 'Sfoglia';
					$(btn).click(function() {
						sfoglia(l_testata, l_issue, l_edizione);
						window.loader.local(true);
					});

					var del_btn = document
							.getElementById('qarchivio_container_box_del_btn_'
									+ _QARCHIVIO_MODE + '_' + l_testata + '_'
									+ l_issue + '_' + l_edizione);
					del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
				} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
					// copia con download in corso
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					renderDownloadQueue(l_testata, l_issue, l_edizione);
				} else {
					if (p_item.free || l_query_result.da_scaricare > 0
							|| p_item.subscription == true) {
						if ((!p_item.subscription) && l_edizione_premium) {
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							btn.value = 'Solo per abbonati';
							$(btn).unbind();
							$(btn).bind('click', function() {
								mostraPopupInsertoAbbonati();
							});
						} else {
							// copia gratuita
							btn.className = 'button medium gray24 qarchivio_free_copy_btn';
							btn.value = 'Salva in locale';
							$(btn).unbind();
							$(btn).bind(
									'click',
									function() {
										console.log(";;;;;;;;;; ADD1 TO QUEUE "
												+ l_testata + " " + l_issue
												+ " " + l_edizione);
										addToDownloadQueue(l_testata, l_issue,
												l_edizione);
									});
						}
					} else if (l_edizione_premium) {
						btn.className = 'button medium red24 qarchivio_buy_copy_btn';
						btn.value = 'Solo per abbonati';
						$(btn).unbind();
						$(btn).bind('click', function() {
							mostraPopupInsertoAbbonati();
						});
					} else {
						if (p_item.single && (p_item.singleOffers.length > 0)) {
							// acquisto
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							// btn.value = 'Acquista ' +
							// p_item.singleOffers[0].offerPrice + ' €';
							// btn.value = 'Acquista ' +
							// ab_euro_formatter(p_item.singleOffers[0].offerPrice);
							btn.value = 'Seleziona';
							$(btn).unbind();
							$(btn)
									.bind(
											'click',
											function() {
												console
														.log(";;;;;;;;;; ACQUISTO "
																+ l_testata
																+ " "
																+ l_issue
																+ " "
																+ l_edizione);
												acquistoSingolo(
														l_testata,
														l_issue,
														l_edizione,
														p_item.singleOffers[0].offerId,
														p_item.singleOffers[0].offerItunesProductId);
											});
						} else {
							var btndiv = document
									.getElementById('qarchivio_container_btndiv_'
											+ _QARCHIVIO_MODE
											+ '_'
											+ p_insert_index
											+ '_'
											+ p_item.editionId);
							btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
							btndiv.style['position'] = 'relative';
							btndiv.style['margin-right'] = '30px';
							btndiv.style['margin-top'] = '10px';
						}
					}
				}
			} else if (_QARCHIVIO_MODE == 'ICONS') {

				var icon = document
						.getElementById('qarchivio_container_box_icon_'
								+ _QARCHIVIO_MODE + '_' + p_insert_index + '_'
								+ p_item.editionId);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					$(icon).click(
							function() {
								if (!$('#qarchivio_container').hasClass(
										'qarchivio_modify')) {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							});
				} else
				// if (_QARCHIVIO_PRODUCT.free || l_query_result.da_scaricare >
				// 0) {
				if (p_item.free || l_query_result.da_scaricare > 0
						|| p_item.subscription == true) {
					// copia gratuita
					$(icon).click(
							function() {
								// scarica(l_testata, l_issue, l_edizione);
								if ((!p_item.subscription)
										&& l_edizione_premium) {
									sfogliaCheckPremium(l_testata, l_issue,
											l_edizione);
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							});
				} else
				// if (p_item.subscription == false && p_item.single) {
				if (l_edizione_premium) {
					$(icon).click(function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					if (p_item.single && (p_item.singleOffers.length > 0)) {
						// acquisto
						$(icon)
								.click(
										function() {
											acquistoSingolo(
													l_testata,
													l_issue,
													l_edizione,
													p_item.singleOffers[0].offerId,
													p_item.singleOffers[0].offerItunesProductId);
										});
					}
				}

			}
		}
		// try{
		var queryError = function(p_error) {
			console.log("checkLocalArretrato: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			var l_query = 'select * from (select count(*) as in_locale, 1 as id from issues where testata=? and issue=? and edizione=?) as a inner join (select count(*) as da_scaricare, 1 as id from issues where testata=? and issue=?) as b on (a.id = b.id)';
			tx.executeSql(l_query, [ l_testata, l_issue, l_edizione, l_testata,
					l_issue ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Passa alla modalità modifica
 */
var _QARCHIVIO_IS_IN_MODIFICA = false;
var _QARCHIVIO_PRE_MODIFICA_TEMPO = '';
function qarchivioModifica() {
	console.log("modifica");
	_QARCHIVIO_IS_IN_MODIFICA = true;
	$('#qarchivio_subtitolo_opzioni_modifica').hide();
	$('#qarchivio_subtitolo_opzioni_visualizza').show();

	$('#qarchivio_container').addClass('qarchivio_modify');

	_QARCHIVIO_PRE_MODIFICA_TEMPO = $('#qarchivio_filtro_edizioni_tempo').val();
	$('#qarchivio_filtro_edizioni_tempo').val("LOCAL");
	qarchivioAggiornaContenutoVisualizzato();
}

/**
 * Passa alla modalità visualizza
 */
function qarchivioVisualizza(light) {
	_QARCHIVIO_IS_IN_MODIFICA = false;
	$('#qarchivio_subtitolo_opzioni_modifica').show();
	$('#qarchivio_subtitolo_opzioni_visualizza').hide();

	$('#qarchivio_container').removeClass('qarchivio_modify');

	if (light == true)
		return;

	$('#qarchivio_filtro_edizioni_tempo').val(_QARCHIVIO_PRE_MODIFICA_TEMPO);
	qarchivioAggiornaContenutoVisualizzato();

	gestisciProssimaAzione();
	// <-- PERCHE'???

}
/**
 * @author ABertacco, MConventi
 */
var _USER_DEVICES = [];
var _IMPOSTAZIONI_MENU_ISCROLL = null;
var _IMPOSTAZIONI_VISTA_ISCROLL = null;
var _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};

function impostazioniInizializza() {
	if (_EDICOLA_USE_CATEGORIES) {
		var req_headers = {
			"appKey" : _API24_APPKEY
		};
		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};
		console.log("--REQ---> getProducts4Impostazioni");
		console.log(req_headers);
		console.log(req_data);
		$
				.ajax({
					type : "GET",
					cache : false,
					timeout : _AJAX_TIMEOUT,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "products.json",
					headers : req_headers,
					data : req_data,
					dataType : "json",
					success : function(p_response) {
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log("--RESP--> getProducts4Impostazioni");
						console.log(p_response);
						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response)) {
							// console.log('ajax success');
							var res = p_response.Result.res;
							_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};
							for ( var i = 0; i < res.products.length; i++) {
								var pid = res.products[i].productId;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid] = {};
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;
								_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;
								if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "storeplus") {
									_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = "store";
									_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type_original'] = "storeplus";
								}
							}
							impostazioniInizializza_aux();
						}
					}
				});
	} else {
		_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = _EDICOLA_PRODUCTS_DETAILS;
		impostazioniInizializza_aux();
	}
}

function impostazioniInizializza_aux() {
	// Inizializza la lista dei prodotti disponibili
	inizializzaImpostazioniProdotti();
	// lista prodotti in select per selezione prodotto principale
	inizializzaListaProdottoPrincipale();
	// carico informativa privacy
	impostazioniLoadInformativaPrivacy();
}
var _IMPOSTAZIONI_ISCROLL_PRIVACY = null;

function impostazioniLoadInformativaPrivacy() {
	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				url : 'http://du.ilsole24ore.com/utenti/Privacy.html',
				success : function(p_response) {
					if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
						_IMPOSTAZIONI_ISCROLL_PRIVACY.destroy();
						_IMPOSTAZIONI_ISCROLL_PRIVACY = null;
					}
					document
							.getElementById('informativa_privacy_body_container').innerHTML = p_response;
					// _IMPOSTAZIONI_ISCROLL_PRIVACY = new
					// iScroll('informativa_privacy_body');
				},
				error : function() {
				}
			});
}
// corregge padding nel caso di monitor 10''
function adjustPadding() {
	$(
			'#impostazioni_body_menu_container_box_generali, #impostazioni_body_menu_container_box_codicepromozionale, #impostazioni_body_menu_container_box_help')
			.css({
				'paddingLeft' : '5%'
			});
}

function impostazioniOpen() {
	// alert('aaaaa');
	impostazioniInizializza();
	var l_impostazioni_current = $('.impostazioni_body_menu_container_box_active');
	// alert($('#impostazioni_prodotto_principale_select').html());
	// if (l_impostazioni_current.length == 0)
	impostazioniOpenGenerali();
	// aggiusto 10''
	adjustPadding();
}

function impostazioniVistaClose(event) {
	event.stopPropagation();
	$('#impostazioni_body_vista_wrapper').removeClass(
			'impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').removeClass(
			'impostazioni_body_vista_active');
	$('.impostazioni_body_menu_container_box_active').removeClass(
			'impostazioni_body_menu_container_box_active');
}

function impostazioniInitOpen(menu, title) {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL = null;
	}
	$('#impostazioni_body_vista_wrapper').addClass(
			'impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').addClass('impostazioni_body_vista_active');
	// $('#impostazioni_titolo_vista_back_button').css('display', 'none');
	$('#impostazioni_body_vista_container > div').css('display', 'none');
	$('.impostazioni_body_menu_container_box').removeClass(
			'impostazioni_body_menu_container_box_active');
	$('#' + menu).addClass('impostazioni_body_menu_container_box_active');
	document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title;
	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span><span>Impostaz.</span>');
	l_back_button.unbind('click');
	l_back_button.click(impostazioniVistaClose);
}

function impostazioniUpdateOrientation() {
	if (_IMPOSTAZIONI_MENU_ISCROLL != null) {
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	if (_IMPOSTAZIONI_HELP_LOADED)
		hlpCreaLinea();
}

function impostazioniOpenGenerali() {
	impostazioniInitOpen('impostazioni_body_menu_container_box_generali',
			'Generali');
	// informazioni sul profilo utente
	inizializzaAgganciaProfilo();
	// memoria disponibile
	if ((typeof device != "undefined") && (device.usedspace != null)
			&& (device.usedspaceperc != null))
		$('#impostazioni_body_vista_container_generali_memoria_value').html(
				device.usedspace + ' (' + device.usedspaceperc + ')');
	// carico informazioni sulle versioni
	$('#impostazioni_body_vista_container_generali_info_versione_app').text(
			device.appversion);
	$('#impostazioni_body_vista_container_generali_info_device_id').text(
			device.uuid);
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : true,
		url : 'VERSION',
		success : function(p_response) {
			$('#impostazioni_body_vista_container_generali_info_versione_gui')
					.text(p_response);
		},
		error : function() {
			$('#impostazioni_body_vista_container_generali_info_versione_gui')
					.text('---');
		}
	});
	$('#impostazioni_body_vista_container_generali').css('display',
			'inline-block');
	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
				'impostazioni_body_vista_wrapper', {
					bounce : false
				});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	omnitureTrackApp('APP:impostazioni:generali', 'APP:impostazioni');
}
/**
 * Inizializza la sezione di "Aggancia profilo" nelle impostazioni generali
 */
function inizializzaAgganciaProfilo() {
	if (_MOD_OFFLINE) {
		$('#impostazioni_body_vista_container_generali_profilo').css('display',
				'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css(
				'display', 'none');
		// alert('aaa'+_MOD_OFFLINE);
		return;
	}
	// Se l'utente ha effettuato la login viene mostrato il pulsante per
	// accedere al profilo
	if (_USERNAME) {
		// alert('aaa'+_USERNAME);
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css(
				'display', 'none');
		$('#impostazioni_body_vista_container_generali_profilo_value').text(
				_USERNAME);
		$('#impostazioni_body_vista_container_generali_profilo').css('display',
				'inline-block');
		// alert($('#impostazioni_body_vista_wrapper').width()+','+
		// $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth());
	} else {
		// alert('aaa');
		// Altrimenti viene mostrato il pulsante per aprire il popup per la
		// login
		$('#impostazioni_body_vista_container_generali_profilo').css('display',
				'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css(
				'display', 'inline-block');
	}
}
IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = null

function impostazioniGeneraliRegistrazione() {
	// console.log("REGISTRAZIONE 2");
	$('#acquisto_registrazione_opzioni_impostazioni').css('display',
			'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupImpostazioniRegistratiDone;
	if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll(
				'acquisto_registrazione_wrapper', {
					bounce : false
				});
	} else {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}
	// console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is
	// "+IMP_ACQUISTO_REGISTRAZIONE_ISCROLL)
}

function impostazioniCodicePromoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display',
			'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupCodicePromoRegistratiDone;
}

function impostazioniProdottoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display',
			'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupProdottoRegistratiDone;
}

function popupImpostazioniRegistrati() {
	// _NEXT_ACTION = popupImpostazioniRegistratiDone;
	popupRegistrazioneApri();
}

function popupImpostazioniRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}

function popupCodicePromoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenCodicePromozionale();
}

function popupProdottoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}
/*******************************************************************************
 * Gestione impostazioni codice promozionale
 ******************************************************************************/
/**
 * Apre la sezione delle impostazioni per l'attivazione di un codice
 * promozionale Nel caso in cui l'utente non sia autenticato viene richiesta la
 * login o la registrazione
 */
function impostazioniOpenCodicePromozionale() {
	impostazioniInitOpen(
			'impostazioni_body_menu_container_box_codicepromozionale',
			'Codice promozionale');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_codicepromozionale_login').css(
				'display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice')
				.css('display', 'inline-block');
	} else {
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice')
				.css('display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_login').css(
				'display', 'inline-block');
	}
	$('#impostazioni_body_vista_container_codicepromozionale').css('display',
			'inline-block');

	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
				'impostazioni_body_vista_wrapper', {
					bounce : false
				});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	omnitureTrackApp('APP:impostazioni:codice_promo', 'APP:impostazioni');
}
/**
 * Esegue la chiamata per l'attivazione di un codice promozionale
 */
function impostazioniOpenCodicePromozionaleAvanti() {
	var l_codice_promozionale = $(
			'#impostazioni_body_vista_container_codicepromozionale_attiva_codice #codice_promozionale')
			.val();
	console.log('Sending the promotional code ' + l_codice_promozionale);
	if (l_codice_promozionale && l_codice_promozionale != '') {
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform,
			"username" : _USERNAME
		// ,
		// "promo_code": l_codice_promozionale
		};
		console.log('---REQ---> promo-code');
		console.log(l_req_headers);
		console.log(l_req_data);
		/*
		 * navigator.notification.loadingStart({ 'labelText': "Richiesta in
		 * corso...", 'backgroundOpacity': 0.8, 'strokeOpacity': 0.25,
		 * 'strokeColor': "FFFFFF", });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Richiesta in corso..." ]);
		$
				.ajax({
					type : "POST",
					timeout : _AJAX_TIMEOUT,
					cache : false,
					contentType : "application/json; charset=utf-8",
					// url: _SOLEGW_ENDPOINT + "promo-code.json",
					url : _SOLEGW_ENDPOINT + "promo/" + l_codice_promozionale
							+ ".json",
					headers : l_req_headers,
					processData : false,
					data : JSON.stringify(l_req_data),
					dataType : "json",
					success : function(p_response) {
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log('---RESP--> promo-code');
						console.log(p_response);
						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response,
								impostazioniOpenCodicePromozionaleAvanti)) {
							abutils
									.alert(
											'La tua promozione è stata attivata con successo',
											'Codice promozionale');
						} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
							if (p_response.Exception.Description) {
								abutils.alert(p_response.Exception.Description,
										'Codice promozionale');
							} else {
								abutils
										.alert(
												'Si è verificato un errore durante l\'invio del codice promozionale.',
												'Codice promozionale');
							}
						}
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					},
					error : function() {
						abutils
								.alert(
										'Si è verificato un errore durante l\'invio del codice promozionale. Riprovare tra poco.',
										'Codice promozionale');
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					}
				});
	} else {
		abutils.alert('Attenzione, inserire un codice promozionale',
				'Codice promozionale');
	}
}
var _IMPOSTAZIONI_HELP_LOADED = false;
var hlpTabsScr, hlpContScr, hlpFaqScr, strOr, hlpGlobNav;

function hlpNav(hli) {
	$('#hlp_tbs2_scroll .tbon').removeClass("tbon");
	$('#hlp_tbs2_scroll .hlp_tb:eq(' + hli + ')').addClass("tbon");
	$('#hlp_tot div[class^=hlp_slide]:visible').fadeOut(200);
	$('#hlp_cont_scroll > div:eq(' + hli + ')').delay(200).fadeIn(200);
	setTimeout(function() {
		hlpContScr.refresh();
		hlpCreaLinea();
	}, 410);
}

function hlpCreaLinea() {
	console.log('hlpCreaLinea()');
	console.log(window.orientation);
	/* verticale o orizzontale */
	if (typeof window.orientation != "undefined") {
		strOr = Math.abs(window.orientation) == 90 ? "l" : "p";
	} else { // temp non ipad
		strOr = window.innerWidth > window.innerHeight ? "l" : "p";
	}
	if (strOr == "l") {
		$('#hlp_mail')
				.html(
						'Desideri assistenza specifica? Contatta il Servizio Clienti all\'indirizzo <a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	} else {
		$('#hlp_mail')
				.html(
						'Contatta il Servizio Clienti:<br><a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	}
	if (hlpFaqScr != null)
		hlpFaqScr.refresh();
	setTimeout(function() {
		$("#hlp_cont_scroll canvas:visible").each(function(index, element) {
			var $c = $(this);
			var c = $(this)[0];
			$c.width(Number($c.data(strOr + "w")));
			$c.height(Number($c.data(strOr + "h")) + 15);
			c.width = Number($c.data(strOr + "w"));
			c.height = Number($c.data(strOr + "h") + 15);
			$c.css({
				'left' : "-" + c.width + "px",
				'top' : "-" + (c.height - 15) + "px"
			});
			var cxt = c.getContext("2d");
			cxt.strokeStyle = '#FF0000';
			cxt.lineWidth = 2;
			cxt.lineCap = 'round';
			cxt.moveTo(1, 1);
			cxt.lineTo(c.width - 7, c.height - 2);
			cxt.stroke();
		});
	}, 10);
}

function impostazioniOpenHelp() {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL == null;
	}
	impostazioniInitOpen('impostazioni_body_menu_container_box_help', 'Help');
	console.log('PASSS HELP');
	// window.location = 'ipad_help.html';
	/*
	 * $('div').ajaxError(function(event, request, settings){ alert("Error
	 * requesting page " + settings.url ); });
	 */
	if (!_IMPOSTAZIONI_HELP_LOADED) {
		// carico il contenuto via ajax
		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : true,
			url : "ipad_help.html",
			success : function(p_response) {
				try {
					console.log('ipad_help.html letto');
					$('#impostazioni_body_vista_container_help_content').html(
							p_response);
					// console.log('asdadadasdasdas');
					$('#impostazioni_body_vista_container_help').css('display',
							'inline-block');
					// ATTENZIONE ---> evento di aggiornamento in
					// impostazioniUpdateOrientation
					console.log('carico help');
					$('#hlp_tbs2_scroll .hlp_tb').click(function(e) {
						e.preventDefault();
						if (!$(this).hasClass('tbon')) {
							var hli = $(this).index();
							hlpNav(hli);
						}
					});
					hlpNav(0);
					hlpTabsScr = new iScroll('hlp_tbs2', {
						snap : "a",
						hScrollbar : false
					});
					hlpContScr = new iScroll('hlp_cont', {
						vScrollbar : false
					});
					hlpFaqScr = new iScroll('hlp_faq', {
						vScrollbar : false
					});
					$('#hlp_faq').hide(0);
					$('#hlp_tbs1 .hlp_tb').click(
							function(e) {
								if (hlpGlobNav != $(this).data('nav')) {
									hlpGlobNav = $(this).data('nav');
									$('#hlp_tbs1 .hlp_tb').toggleClass("tbon");
									$('#hlp_glob_switch > div[id^=hlp_]').hide(
											0);
									hlpFaqScr.refresh();
									$('#hlp_glob_switch > #hlp_' + hlpGlobNav)
											.fadeIn(300, function() {
												if (hlpGlobNav == "faq") {
													hlpFaqScr.refresh();
												}
											});
								}
							});
				} catch (exc) {
					console.log(exc.message);
				}
				_IMPOSTAZIONI_HELP_LOADED = true;
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				/*
				 * readyState status statusText responseXML and/or responseText
				 * when the underlying request responded with xml and/or text,
				 * respectively setRequestHeader(name, value) which departs from
				 * the standard by replacing the old value with the new one
				 * rather than concatenating the new value to the old one
				 * getAllResponseHeaders() getResponseHeader() abort()
				 */
				console.log("Error status :" + textStatus);
				console.log("Error type :" + errorThrown);
				console.log("Error message :" + XMLHttpRequest.status);
			}
		});
	}
	$('#impostazioni_body_vista_container_help').css('display', 'inline-block');
	/*
	 * lo fa il codice dell'help if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
	 * _IMPOSTAZIONI_VISTA_ISCROLL = new
	 * iScroll('impostazioni_body_vista_wrapper'); } else {
	 * _IMPOSTAZIONI_VISTA_ISCROLL.refresh(); }
	 */
	omnitureTrackApp('APP:impostazioni:help', 'APP:impostazioni');
}
/*******************************************************************************
 * Gestione prodotto principale
 ******************************************************************************/
/**
 * Inizializza la lista dei prodotti tra i quali poter scegliere per selezionare
 * il prodotto principale.
 */
function inizializzaListaProdottoPrincipale() {
	// Ottenere il prodotto principale da local storage
	var l_prodotto_principale_id = window.localStorage
			.getItem("prodotto_principale_id");
	var l_prodotto_principale_descr = window.localStorage
			.getItem("prodotto_principale_descr");
	var l_impostazioni_prodotto_principale_select = $('#impostazioni_prodotto_principale_select');
	l_impostazioni_prodotto_principale_select.empty();
	l_impostazioni_prodotto_principale_select
			.append($('<option value="">Nessun prodotto principale</option>'));
	for ( var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
			var l_option = $('<option></option>');
			l_option.val(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId);
			l_option.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
				l_option.attr('selected', 'selected');
			}
			l_impostazioni_prodotto_principale_select.append(l_option);
		}
	}
}

function impostazioniProdottoPrincipaleSelectOnChange() {
	// alert('CIAO');
	console.log('impostazioniProdottoPrincipaleSelectOnChange...');
	var l_selected_option = $('#impostazioni_prodotto_principale_select option:selected');
	l_prodotto_principale_id = l_selected_option.val();
	l_prodotto_principale_descr = l_selected_option.text();
	window.localStorage.setItem("prodotto_principale_id",
			l_prodotto_principale_id);
	window.localStorage.setItem("prodotto_principale_descr",
			l_prodotto_principale_descr);
	// console.log('impostazioniProdottoPrincipaleSelectOnChange --->
	// '+l_selected_option.val()+':::'+ l_selected_option.text());
}
/*******************************************************************************
 * Gestione impostazioni prodotti
 ******************************************************************************/
/**
 * Inizializza la lista dei prodotti nel pannello delle impostazioni
 */
function inizializzaImpostazioniProdotti() {
	var l_lista_prodotti_container = $('#impostazioni_body_menu_container_box_lista_prodotti');
	l_lista_prodotti_container.empty();
	/*
	 * for (var key in _EDICOLA_PRODUCTS_DETAILS) { if
	 * (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") { var pbox = $('<div></div>');
	 * pbox.addClass('impostazioni_body_menu_container_box');
	 * pbox.addClass('impostazioni_body_menu_container_box_prodotto');
	 * pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
	 * pbox.text(_EDICOLA_PRODUCTS_DETAILS[key].name); pbox.bind('click',
	 * (function(p_key){ return function(){
	 * impostazioniOpenProdotto(_EDICOLA_PRODUCTS_DETAILS[p_key].productId,
	 * _EDICOLA_PRODUCTS_DETAILS[p_key].name); } })(key));
	 * l_lista_prodotti_container.append(pbox); //alert('aaa_
	 * '+_EDICOLA_PRODUCTS_DETAILS[key].icon); var img =
	 * document.createElement('img'); img.className =
	 * 'impostazioni_body_menu_container_box_icon'; img.src =
	 * _EDICOLA_PRODUCTS_DETAILS[key].icon;//'imgs/fake/s24_small_icon.png';
	 * pbox.append(img); img = null; pbox = null; } }
	 */
	for ( var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
			var pbox = $('<div></div>');
			pbox.addClass('impostazioni_body_menu_container_box');
			pbox.addClass('impostazioni_body_menu_container_box_prodotto');
			pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
			pbox.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			pbox
					.bind(
							'click',
							(function(p_key) {
								return function() {
									impostazioniOpenProdotto(
											_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].productId,
											_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].name);
								}
							})(key));
			l_lista_prodotti_container.append(pbox);
			var img = document.createElement('img');
			img.className = 'impostazioni_body_menu_container_box_icon';
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == _CODICE_PRODOTTO_QUOTIDIANO)
				img.src = 'imgs/fake/s24_small_icon.png';
			else
				img.src = _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].icon;
			pbox.append(img);
			img = null;
			pbox = null;
		}
	}
	if (_IMPOSTAZIONI_MENU_ISCROLL == null) {
		_IMPOSTAZIONI_MENU_ISCROLL = new iScroll(
				'impostazioni_body_menu_wrapper', {
					bounce : false
				});
	} else {
		// aggiorno iscroll
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
}
/**
 * Apre il pannello di impostazioni di un prodotto
 * 
 * @params p_product_id Il codice del prodotto p_product_description La
 *         descrizione del prodotto
 */
function impostazioniOpenProdotto(p_product_id, p_product_description) {
	impostazioniInitOpen(
			'impostazioni_body_menu_container_box_' + p_product_id,
			p_product_description);
	$('#cartaceo_codice_abbonato').val('');
	$('#cartaceo_cap').val('');
	$('#impostazioni_body_vista_container_prodotto_info_cartaceo').css(
			'display', 'none');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_prodotto_login').css('display',
				'none');
		$('#impostazioni_body_vista_container_prodotto_info').css('display',
				'inline');
		impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
	} else {
		$('#impostazioni_body_vista_container_prodotto_info').css('display',
				'none');
		$('#impostazioni_body_vista_container_prodotto_login').css('display',
				'inline-block');
		_NEXT_ACTION = function() {
			impostazioniOpenProdotto(p_product_id, p_product_description);
		}
	}
	$('#impostazioni_body_vista_container_prodotto').css('display',
			'inline-block');
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
				'impostazioni_body_vista_wrapper');
	}
	omnitureTrackApp('APP:impostazioni:prodotto:' + p_product_id,
			'APP:impostazioni');
}
/**
 * Carica le info sull'abbonamento
 */
function impostazioniProdottoCaricaInfoAbbonamento(p_product_id) {
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + p_product_id);
	console.log(l_req_headers);
	console.log(l_req_data);
	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "subscription/" + p_product_id
						+ ".json",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}
					console.log('---RESP--> subscription/' + p_product_id);
					console.log(p_response);
					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(
							p_response,
							function() {
								impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
							})) {
						var l_attivo = false;
						var l_date_end = null;
						try {
							// if (p_response.Result.res.endDate == null)
							if (p_response.Result.res
									&& p_response.Result.res.details
									&& (p_response.Result.res.details.length > 0)
									&& p_response.Result.res.details[0].endDate) {
								l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);
								l_attivo = l_date_end > new Date();
							} else {
								throw {
									message : "endDate non valorizzato"
								};
							}
						} catch (exc) {
							console.log(exc.message);
							console
									.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
							l_attivo = false;
							l_date_end = null;
						}
						if (l_attivo) {
							$(
									'#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value')
									.text('Attivo');
							$(
									'#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value')
									.text(l_date_end.format('dd/mm/yyyy'));
						} else {
							$(
									'#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value')
									.text('Non Attivo');
							$(
									'#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value')
									.text('');
							/*
							 * if (p_product_id == _CODICE_PRODOTTO_QUOTIDIANO) {
							 * $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display',
							 * 'inline-block'); }
							 */
							if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
								_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
							} else {
								_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
										'impostazioni_body_vista_wrapper', {
											bounce : false
										});
							}
						}
					} else {
						$(
								'#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value')
								.text('---');
						$(
								'#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value')
								.text('');
					}
				},
				error : ajaxErrorHandler
			});
}
/*******************************************************************************
 * Gestione impostazioni profilo
 ******************************************************************************/
/**
 * Apre il popup contenente le informazioni sul profilo utente
 */
var _IMPOSTAZIONI_PROFILO_ISCROLL = null;
var _IMPOSTAZIONI_PROFILO_INITIALIZED = false;

function popupImpostazioniProfilo() {
	window.location = 'http://du.ilsole24ore.com/utenti/areautente/ilmioprofilo.aspx';
	return;
	if (!_IMPOSTAZIONI_PROFILO_INITIALIZED) {
		// Se l'utente inserisce l'indirizzo email deve comparire il link
		// all'informativa sulla privacy
		$('#impostazioni_profilo #id_email_address').unbind();
		$('#impostazioni_profilo #id_email_address').keyup(
				controlloSezioneConsensoEmail);
		// Inizializzazione campo data
		$('#id_birthdate').scroller({
			showOnFocus : false,
			theme : 'ios',
			mode : 'scroller',
			startYear : 1910
		});
		$('#id_birthdate').click(function() {
			$('#id_birthdate').scroller('show');
			return false;
		});
		_IMPOSTAZIONI_PROFILO_INITIALIZED = true;
	}
	$('#impostazioni_profilo').css('display', 'inline');
	$('#impostazioni_profilo_menu').css('display', 'none');
	// Inizializza i dati del profilo utente
	inizializzaProfilo();
}
/**
 * In base alla presenza dell'email mostra i campi per il consenso della privacy
 */
function controlloSezioneConsensoEmail() {
	if ($('#impostazioni_profilo #id_email_address').val() != '') {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email')
				.fadeIn(
						200,
						function() {
							if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
								_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll(
										'impostazioni_profilo_body_wrapper', {
											bounce : false
										});
							} else {
								_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
							}
						});
	} else {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email')
				.fadeOut(
						200,
						function() {
							if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
								_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll(
										'impostazioni_profilo_body_wrapper', {
											bounce : false
										});
							} else {
								_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
							}
						});
	}
}
/**
 * Inizializza i dati del profilo dell'utente che sta utilizzando l'applicativo
 */
var _PROFILE_FIELDS = [ {
	id : 'email_address',
	type : 'text'
}, {
	id : 'ConsensoPrivacy',
	type : 'checkbox'
}, {
	id : 'ConsensoSocieta',
	type : 'checkbox'
}, {
	id : 'ConsensoMail',
	type : 'checkbox'
}, {
	id : 'first_name',
	type : 'text'
}, {
	id : 'last_name',
	type : 'text'
}, {
	id : 'birth_year',
	type : 'text'
}, {
	id : 'birth_month',
	type : 'text'
}, {
	id : 'birth_day',
	type : 'text'
}, {
	id : 'gender',
	type : 'select'
}, {
	id : 'address_street',
	type : 'text'
}, {
	id : 'city',
	type : 'text'
}, {
	id : 'provincia',
	type : 'text'
}, {
	id : 'state',
	type : 'text'
}, {
	id : 'zip_code',
	type : 'text'
}, {
	id : 'tel_number',
	type : 'text'
}, {
	id : 'mobile_phone',
	type : 'text'
}, {
	id : 'fax_number',
	type : 'text'
}, {
	id : 'societa_ente',
	type : 'text'
}, {
	id : 'professione',
	type : 'text'
}, {
	id : 'settore',
	type : 'text'
}, {
	id : 'codice_fiscale',
	type : 'text'
}, {
	id : 'partita_iva',
	type : 'text'
} ];

function inizializzaProfilo() {
	console.log('Get profilo info for user ' + _USERNAME);
	$('#impostazioni_profilo #id_username').text(_USERNAME);
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"username" : _USERNAME
	};
	console.log('---REQ---> getUserProfile');
	console.log(l_req_headers);
	console.log(l_req_data);
	$
			.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/getUserProfile",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}
					console.log('---RESP--> getUserProfile');
					console.log(p_response);
					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, inizializzaProfilo)) {
						// Per tutti i campi definiti in _PROFILE_FIELDS vengono
						// inizializzati i valori nel popup di impostazioni
						// profilo
						for ( var i = 0; i < _PROFILE_FIELDS.length; i++) {
							// Gli elementi html devono avere un id uguale a
							// 'id_<ID_CAMPO>'
							var l_html_element = $('#impostazioni_profilo #id_'
									+ _PROFILE_FIELDS[i].id);
							// Se l'elemento html esiste
							if (l_html_element) {
								// In base al tipo di elemento viene
								// inizializzato il valore
								if (_PROFILE_FIELDS[i].type == 'text') {
									if (p_response.Result[_PROFILE_FIELDS[i].id]) {
										l_html_element
												.val(p_response.Result[_PROFILE_FIELDS[i].id]);
									} else {
										l_html_element.val('');
									}
								}
								if (_PROFILE_FIELDS[i].type == 'checkbox') {
									if (p_response.Result[_PROFILE_FIELDS[i].id]) {
										if (p_response.Result[_PROFILE_FIELDS[i].id] == '0') {
											l_html_element.attr('checked',
													false);
										} else if (p_response.Result[_PROFILE_FIELDS[i].id] == '1') {
											l_html_element
													.attr('checked', true);
										}
									} else {
										l_html_element.attr('checked', false);
									}
									l_html_element.change();
								}
								if (_PROFILE_FIELDS[i].type == 'select') {
									$(
											'#impostazioni_profilo #id_'
													+ _PROFILE_FIELDS[i].id
													+ ' option:selected')
											.removeAttr('selected');
									l_html_element = $('#impostazioni_profilo #id_'
											+ _PROFILE_FIELDS[i].id
											+ ' option[value='
											+ p_response.Result[_PROFILE_FIELDS[i].id]
											+ ']');
									l_html_element.attr('selected', 'selected');
								}
							}
						}
						// Inizializzazione campo data di nascita
						if (p_response.Result['birth_day']
								&& p_response.Result['birth_month']
								&& p_response.Result['birth_year']) {
							$('#id_birthdate').scroller(
									'setDate',
									new Date(p_response.Result['birth_month']
											+ '/'
											+ p_response.Result['birth_day']
											+ '/'
											+ p_response.Result['birth_year']),
									true);
						}
						controlloSezioneConsensoEmail();
					}
					/*
					 * else { //Gestione eccezioni //TODO alert('Attenzione, ' +
					 * p_response.Exception.Description); }
					 */
				},
				error : ajaxErrorHandler
			});
}
/**
 * Salva i dati del profilo
 */
function popupImpostazioniProfiloAvanti() {
	if (controlloDatiProfilo()) {
		// Definizione del profilo utente
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : _USERNAME,
			"disclaimer" : "1"
		};
		var l_user_email = $('#impostazioni_profilo #id_email_address').val();
		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti
		// i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($(
					'#impostazioni_profilo #id_ConsensoPrivacy')
					.attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($(
					'#impostazioni_profilo #id_ConsensoMail').attr('checked') == "checked" ? '1'
					: '0');
			l_user_profile['consensoSocieta'] = ($(
					'#impostazioni_profilo #id_ConsensoSocieta')
					.attr('checked') == "checked" ? '1' : '0');
		}
		// Imposta la data di nascita
		var l_birthdate = $('#id_birthdate').scroller('getDate');
		$('#impostazioni_profilo #id_birth_day').val(l_birthdate.getDate());
		$('#impostazioni_profilo #id_birth_month').val(
				l_birthdate.getMonth() + 1);
		$('#impostazioni_profilo #id_birth_year')
				.val(l_birthdate.getFullYear());
		// Per tutti i campi definiti in _PROFILE_FIELDS vengono letti i nuovi
		// valori dal popup di impostazioni profilo
		for ( var i = 0; i < _PROFILE_FIELDS.length; i++) {
			if (!(_PROFILE_FIELDS[i].id in {
				email_address : 1,
				ConsensoPrivacy : 1,
				ConsensoMail : 1,
				ConsensoSocieta : 1
			})) {
				// Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
				var l_html_element = $('#impostazioni_profilo #id_'
						+ _PROFILE_FIELDS[i].id);
				// Se l'elemento html esiste
				if (l_html_element) {
					// In base al tipo di elemento viene settato il nuovo valore
					if (_PROFILE_FIELDS[i].type == 'text') {
						l_user_profile[_PROFILE_FIELDS[i].id] = l_html_element
								.val();
					}
					if (_PROFILE_FIELDS[i].type == 'checkbox') {
						l_user_profile[_PROFILE_FIELDS[i].id] = (l_html_element
								.attr('checked') == "checked" ? '1' : '0');
					}
					if (_PROFILE_FIELDS[i].type == 'select') {
						l_user_profile[_PROFILE_FIELDS[i].id] = $(
								'#impostazioni_profilo #id_'
										+ _PROFILE_FIELDS[i].id
										+ ' option:selected').val();
					}
				}
			}
		}
		console.log('updateUserProfile call for ' + _USERNAME + ': '
				+ l_user_profile);
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"profile" : l_user_profile
		};
		console.log('---REQ---> updateUserProfile');
		console.log(l_req_headers);
		console.log(l_req_data);
		$
				.ajax({
					type : "POST",
					timeout : _AJAX_TIMEOUT,
					cache : false,
					contentType : "application/json; charset=utf-8",
					url : _API24_ENDPOINT + "Users/updateUserProfile",
					headers : l_req_headers,
					processData : false,
					data : JSON.stringify(l_req_data),
					dataType : "json",
					success : function(p_response) {
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log('---RESP--> updateUserProfile');
						console.log(p_response);
						if (checkAjaxResponse(p_response,
								popupImpostazioniProfiloAvanti)) {
							// Chiudi popup
							popupImpostazioniProfiloChiudi();
						} else {
							// Gestione messaggi di errore dal server
							if (p_response.Exception.Name == 'InvalidParameterException') {
								abutils
										.alert(
												'Attenzione, uno o più campi inseriti non sono validi.',
												'Aggiornamento profilo')
							} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
								abutils.alert(p_response.Exception.Description,
										'Aggiornamento profilo');
							}
						}
					},
					error : function(xmlHttpRequest, textStatus, errorThrown) {
						/*
						 * console.log('ajax error'); console.log(textStatus);
						 * alert('Funzione non disponibile in assenza di
						 * connessione');
						 */
					}
				});
	}
}
/**
 * Controlla che i dati del profilo siano stati immessi correttamente
 */
function controlloDatiProfilo() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	// Controllo email
	email = $('#impostazioni_profilo #id_email_address').val();
	if (email == '') {
		abutils.alert("Attenzione, inserire un indirizzo email valido.",
				'Profilo utente');
		return false;
	}
	if (email != '' && !ck_email.test(email)) {
		abutils.alert("Attenzione, l'indirizzo email inserito non è valido.",
				'Profilo utente');
		return false;
	}
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != ''
			&& !$('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked')) {
		abutils
				.alert(
						"Attenzione, per proseguire devi acconsentire al trattamento dei tuoi dati personali.",
						'Profilo utente');
		return false;
	}
	return true;
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloChiudi() {
	// $('#impostazioni_profilo').fadeOut();
	$('#impostazioni_profilo').css('display', 'none');
}
/*******************************************************************************
 * Gestione popup di account menu
 ******************************************************************************/
/**
 * Apre il popup contenente il menu delle azioni riguardanti il profilo utente
 * Da tale menu l'utente potrà: - Visualizzare informazioni del proprio profilo -
 * Disassociare il proprio account
 */
function popupImpostazioniProfiloMenu() {
	// alert('is '+$('#impostazioni_prodotto_principale_select'));
	$('#impostazioni_prodotto_principale_select').attr('disabled', 'true');
	$('#impostazioni_profilo_menu_account_username').text(_USERNAME);
	$('#impostazioni_profilo_menu').css('display', 'inline');
}
/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloMenuChiudi() {
	// $('#impostazioni_profilo_menu').fadeOut();
	// alert('is '+$('#impostazioni_prodotto_principale_select').attr());
	$('#impostazioni_prodotto_principale_select').removeAttr('disabled');
	$('#impostazioni_profilo_menu').css('display', 'none');
}
/*******************************************************************************
 * Gestione pannello lista dispositivi
 ******************************************************************************/
/**
 * Apre la sezione per la gestione dei dispositivi associati all'utente
 */
function impostazioniGeneraliDispositivi() {
	$('#impostazioni_body_vista_container_dispositivi_lista').css('display',
			'none');
	$('#impostazioni_body_vista_container_generali').css('display', 'none');
	$('#impostazioni_body_vista_container_dispositivi').css('display',
			'inline-block');
	// Inizializza il pulsante di ritorno verso le impostazioni generali
	/*
	 * var l_back_button = $('#impostazioni_titolo_vista_back_button');
	 * l_back_button.html('<span></span>Generali');
	 * l_back_button.css('display', 'inline-block');
	 * l_back_button.click(impostazioniGeneraliDispositiviChiudi);
	 */
	$('#impostazioni_titolo_vista_txt').text('Dispositivi');
	inizializzaListaDispositivi();
}
/**
 * Ottiene dal server la lista dei dispositivi associati all'utente ed
 * inizializza la sezione
 */
function inizializzaListaDispositivi() {
	if (_USERNAME) {
		// console.log('Get devices for user ' + _USERNAME);
		var l_section_body = $('#impostazioni_body_vista_container_dispositivi_lista');
		l_section_body.empty();
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"username" : _USERNAME
		};
		console.log('---REQ---> getUserDevices');
		console.log(l_req_headers);
		console.log(l_req_data);
		// Ottengo i dispositivi associati all'utenza in base alle info date da
		// API24
		$
				.ajax({
					type : "GET",
					timeout : _AJAX_TIMEOUT,
					cache : false,
					contentType : "application/json; charset=utf-8",
					url : _API24_ENDPOINT + "Users/getUserDevices",
					headers : l_req_headers,
					data : l_req_data,
					dataType : "json",
					success : function(p_response) {
						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}
						console.log('---RESP--> getUserDevices');
						console.log(p_response);
						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response,
								inizializzaListaDispositivi)) {
							// p_response.Result.res =
							// [{"id":"1234567890","name":"Questo
							// device","type":1},{"id":"222","name":"Device
							// 2","type":2},{"id":"333","name":"Device
							// 3","type":3}]; //TODO PER DEBUG
							for ( var i = 0; i < p_response.Result.res.length; i++) {
								var l_device = p_response.Result.res[i];
								// I dispositivi associati vengono memorizzati
								// in una variabile globale
								_USER_DEVICES[l_device.id] = l_device;
								// Viene creato l'elemento nella lista dei
								// dispositivi
								var l_device_element_container = $('<div></div>');
								l_device_element_container
										.addClass('impostazioni_body_vista_container_label');
								if (l_device["name"] != '')
									l_device_element_container
											.html(l_device["name"]
													+ "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">"
													+ l_device["id"] + "</div>");
								else
									l_device_element_container
											.html("Dispositivo senza nome"
													+ "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">"
													+ l_device["id"] + "</div>");
								if (l_device.id != device.uuid) {
									var l_device_element_button = $('<div></div>');
									l_device_element_button
											.addClass("button medium red24 impostazioni_body_vista_container_label_button");
									l_device_element_button.text("Disassocia");
									l_device_element_button.attr("onclick",
											'_NEXT_ACTION=impostazioniGeneraliDispositivi;popupDisassociaDispositivo("'
													+ l_device.id + '")');
									l_device_element_container
											.append(l_device_element_button);
								}
								l_section_body
										.append(l_device_element_container);
							}
							l_section_body.fadeIn();
							if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
								_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
										'impostazioni_body_vista_wrapper', {
											bounce : false
										});
							} else {
								_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
							}
						} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
							abutils.alert(p_response.Exception.Description,
									'Dispositivi');
						}
					},
					error : ajaxErrorHandler
				});
	} else {
		impostazioniGeneraliDispositiviChiudi();
		inizializzaAgganciaProfilo();
	}
}
/**
 * Chiude la sezione per la gestione dei dispositivi e riapre le impostazioni
 * generali
 */
function impostazioniGeneraliDispositiviChiudi() {
	$('#impostazioni_titolo_vista_txt').text('Generali');
	// Inizializza il pulsante di ritorno verso le impostazioni generali
	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span>');
	l_back_button.css('display', 'none');
	$('#impostazioni_body_vista_container_generali').css('display',
			'inline-block');
	$('#impostazioni_body_vista_container_dispositivi').css('display', 'none');
	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll(
				'impostazioni_body_vista_wrapper', {
					bounce : false
				});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
}
/*******************************************************************************
 * Gestione popup disassocia dispositivo
 ******************************************************************************/
/**
 * Apre il popup che permette di disassociare un dispositivo
 */
function popupDisassociaDispositivo(p_device_id) {
	$('#disassocia_dispositivo').css('display', 'inline');
	if (p_device_id) {
		$('#disassocia_dispositivo_action_button').attr('onclick',
				'popupDisassociaDispositivoAvanti("' + p_device_id + '");')
	} else {
		$('#disassocia_dispositivo_action_button').attr('onclick',
				'popupDisassociaDispositivoAvanti();')
	}
}
/**
 * Chiude il popup per disassociare un dispositivo
 */
function popupDisassociaDispositivoChiudi() {
	// $('#impostazioni_profilo_menu').fadeOut();
	$('#disassocia_dispositivo').css('display', 'none');
}
/**
 * Disassocia l'account dal dispositivo
 */
function popupDisassociaDispositivoAvanti(p_device_id) {
	console.log('Delete user association to the device');
	var l_request_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	// Se il device id è settato viene disassociato il device memorizzato in
	// _USER_DEVICES[l_device.id]
	if (p_device_id) {
		l_request_data["deviceID"] = p_device_id;
		l_request_data["deviceType"] = _USER_DEVICES[p_device_id]["type"];
	} else {
		//_EDICOLA_LAST_PRODUCT_LOAD = 0;
	}
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	console.log('---REQ---> removeUserDevice');
	console.log(l_req_headers);
	console.log(l_request_data);
	/*
	 * navigator.notification.loadingStart({ 'labelText': "Disassociazione in
	 * corso...", 'backgroundOpacity': 0.8, 'strokeOpacity': 0.25,
	 * 'strokeColor': "FFFFFF", });
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Disassociazione in corso..." ]);
	// Ottengo la username associata al device in base alle info date da API24
	$
			.ajax({
				type : "POST",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/removeUserDevice",
				headers : l_req_headers,
				data : JSON.stringify(l_request_data),
				processData : false,
				dataType : "json",
				success : function(p_response) {
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}
					console.log('---RESP--> removeUserDevice');
					console.log(p_response);
					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response, function() {
						popupDisassociaDispositivoAvanti(p_device_id);
					})) {
						if (!p_device_id) {
							abutils
									.alert(
											'L\'account è stato disassociato dal dispositivo',
											'Disassociazione dispositivo');
							setUserData(null, null, null);
							/*
							 * _USERNAME = null; _PASSWORD = null;
							 * deleteUsername(); deletePassword();
							 */
							inizializzaAgganciaProfilo();
						}
						popupDisassociaDispositivoChiudi();
						gestisciProssimaAzione();
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
						abutils.alert(p_response.Exception.Description,
								'Disassociazione dispositivo');
					} else {
						abutils
								.alert(
										'Si è verificato un errore durante la disassociazione del dispositivo.',
										'Disassociazione dispositivo');
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					}
				},
				error : function() {
					abutils
							.alert(
									'Si è verificato un errore durante la disassociazione del dispositivo.',
									'Disassociazione dispositivo');
					navigator.notification.loadingStop();
				}
			});
}
/**
 * Cancella tutte le edizioni presenti in locale
 */
function impostazioniCancellaContenutoLocale() {
	window.simulatePG
			.confirm(
					'Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?',
					'impostazioniCancellaContenutoLocaleSucc()',
					'Cancellazione contenuto locale', 'Si,No');
}
/*
 * Aggancio abbonamento cartaceo
 */
function impostazioniCartaceoAgganciaAbbonamento() {
	var l_sub_code = $('#cartaceo_codice_abbonato').val();
	var l_sub_cap = $('#cartaceo_cap').val();
	if ((l_sub_code.length <= 0) || (l_sub_cap.length <= 0)) {
		abutils.alert('Inserire il proprio Codice Abbonato e il CAP',
				'Aggancio abbonamento');
		return;
	}
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform,
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"subscriptionCode" : l_sub_code,
		"subscriptionType" : "XXX",
		"cap" : l_sub_cap
	};
	console.log('---REQ---> subscription-paper');
	console.log(l_req_headers);
	console.log(l_req_data);
	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Richiesta in corso..." ]);
	$
			.ajax({
				type : "POST",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _SOLEGW_ENDPOINT + "subscription-paper.json",
				headers : l_req_headers,
				processData : false,
				data : JSON.stringify(l_req_data),
				dataType : "json",
				success : function(p_response) {
					if (typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}
					console.log('---RESP--> subscription-paper');
					console.log(p_response);
					// Controlla la risposta avuta dal server
					if (checkAjaxResponse(p_response,
							impostazioniCartaceoAgganciaAbbonamento)) {
						abutils
								.alert(
										'Il tuo abbonamento cartaceo è stato associato al tuo profilo',
										'Aggancio abbonamento');
						$(
								'#impostazioni_body_menu_container_box_'
										+ _CODICE_PRODOTTO_QUOTIDIANO).click();
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
						abutils.alert(p_response.Exception.Description,
								'Aggancio abbonamento');
						// navigator.notification.loadingStop();
						window.simulatePG.exec(null, null, "Notification",
								"activityStop", []);
					}
				},
				error : function() {
					abutils
							.alert(
									'Si è verificato un errore durante la comunicazione con il server.',
									'Aggancio abbonamento');
					navigator.notification.loadingStop();
				}
			});
}/**
	 * @author mconventi
	 */
_RICHOFFLINE_FILTRO_EDIZIONI = new Array();
var _MOD_OFFLINE = null;
var _EDICOLA_OFFLINE_MODE = 'ICONS';
// console.log('PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS');
function enableOfflineMode() {
	if (_MOD_OFFLINE != true) {
		_MOD_OFFLINE = true;

		// if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineOpen();
		// }
	}
}

function enableOnlineMode() {
	if (_MOD_OFFLINE != false) {

		var l_first_run = _MOD_OFFLINE == null;

		_MOD_OFFLINE = false;

		// if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineClose(!l_first_run);
		// }
	}
}

function edicolaOfflineOpen() {
	edicolaOfflineInitFilter();
	edicolaOfflineLoad('ICONS');
	$('#edicola_offline').css('display', 'inline-block');
	$('#edicola').css('display', 'none');

	// CLOSE OPENED ARCHIVES
	if ($('#archivio_titolo_chiudi_edicola').is(':visible'))
		$('#archivio_titolo_chiudi_edicola').trigger('click');
	if ($('#archivio_titolo_chiudi_sfoglio').is(':visible'))
		$('#archivio_titolo_chiudi_sfoglio').trigger('click');
	if ($('#qarchivio_titolo_chiudi_edicola').is(':visible'))
		$('#qarchivio_titolo_chiudi_edicola').trigger('click');
	if ($('#qarchivio_titolo_chiudi_sfoglio').is(':visible'))
		$('#qarchivio_titolo_chiudi_sfoglio').trigger('click');

	// disabilito impostazioni
	$('#impostazioni_body_menu_container_box_lista_prodotti').css('display',
			'none');
	$('#impostazioni_body_menu_container_box_codicepromozionale').css(
			'display', 'none');
	$('#impostazioni_body_vista_container_generali_agganciaprofilo').css(
			'display', 'none');
	$('#impostazioni_body_vista_container_generali_profilo').css('display',
			'none');
	$('#impostazioni_body_vista_container_generali_prodottoprincipale').css(
			'display', 'none');
	impostazioniOpenGenerali();

	if (window.innerWidth < 790 || window.innerWidth == 1024) {
		$("#edicola_offline_filtro").hide();
	}
}

function edicolaOfflineClose(reloadEdicola) {
	console.log("database reloadEdicola " + reloadEdicola);
	if (reloadEdicola) {
		/*
		 * navigator.notification.loadingStart({ 'labelText': "Modalità
		 * on-line...", 'backgroundOpacity': 0.80, 'strokeOpacity': 0.25,
		 * 'strokeColor': "FFFFFF", });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", [
				"Caricamento", "Modalità on-line..." ]);

		setTimeout(function() {
			_DB = null;

			// window.simulatePG.relaod();

			window.location = 'galaxy.html';

			/*
			 * $('#edicola_container').show(); $('#edicola_prodotto').show();
			 * $('#edicola').css('display', 'inline-block');
			 * $('#edicola_offline').css('display', 'none'); loadProducts();
			 * 
			 * window.simulatePG.exec(null, null, "Notification",
			 * "activityStop", []);
			 */
		}, 1500);
	} else {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola').css('display', 'inline-block');
		$('#edicola_offline').css('display', 'none');
		loadProducts();
	}
}

var _EDICOLA_OFFLINE_ISCROLL = null;
function edicolaOfflineUpdateIscroll() {
	if (!_MOD_OFFLINE)
		return;
	setTimeout(function() {
		if (_EDICOLA_OFFLINE_ISCROLL == null) {
			_EDICOLA_OFFLINE_ISCROLL = new iScroll('edicola_offline_wrapper', {
				hideScrollbar : false
			});
		} else {
			_EDICOLA_OFFLINE_ISCROLL.refresh();
			_EDICOLA_OFFLINE_ISCROLL.scrollTo(0, 0, 0);
		}
	}, 100);
}

/**
 * Carica gli articoli salvati in locale
 */
function edicolaOfflineLoad(mode) {

	_EDICOLA_OFFLINE_MODE = mode;

	if (_EDICOLA_OFFLINE_ISCROLL != null) {
		_EDICOLA_OFFLINE_ISCROLL.destroy();
		_EDICOLA_OFFLINE_ISCROLL = null;
	}

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			$('#edicola_offline_container').empty();
			$('#edicola_offline_subtitolo_opzioni_vista_ICONS').removeClass(
					'edicola_offline_subtitolo_opzioni_vista_ICONS_on');
			$('#edicola_offline_subtitolo_opzioni_vista_LIST').removeClass(
					'edicola_offline_subtitolo_opzioni_vista_LIST_on');
			$(
					'#edicola_offline_subtitolo_opzioni_vista_'
							+ _EDICOLA_OFFLINE_MODE).addClass(
					'edicola_offline_subtitolo_opzioni_vista_'
							+ _EDICOLA_OFFLINE_MODE + '_on');

			var len = p_results.rows.length;
			console.log("edicolaOfflineLoad: read items:" + len);

			for ( var i = 0; i < p_results.rows.length; i++) {
				if (_EDICOLA_OFFLINE_MODE == 'ICONS') {
					edicolaOfflineRenderAsIcon(p_results.rows.item(i));
				} else {
					edicolaOfflineRenderAsList(p_results.rows.item(i));
				}
				edicolaOfflineUpdateFilter(p_results.rows.item(i));
			}

			// Eseguendo l'evento di change del filtro prodotti, anche in caso
			// di switch della vista si otterrà
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#edicola_offline_filtro').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.edicola_offline_container_box_ICONS').height(
						Math.round(window.innerHeight / 7));
			} else {
				$('.edicola_offline_container_box_ICONS').height(
						Math.round(window.innerHeight / 4));
			}

			edicolaOfflineUpdateIscroll();
			updateRichFiltroOff();
		}

		var queryError = function(p_error) {
			console.log("edicolaOfflineLoad: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues order by issue DESC', [],
					querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un oggetto in locale come icona
 * 
 * @params p_item Oggetto in locale come salvato nel db issues
 */
function edicolaOfflineRenderAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	// box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
	// + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
			+ ' edicola_offline_'
			+ edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'edicola_offline_container_box_img_div';
	img_div.id = 'edicola_offline_container_box_icon_' + _EDICOLA_OFFLINE_MODE
			+ '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	$(img_div).click(
			function() {
				if (!$('#edicola_offline_container').hasClass(
						'edicola_offline_modify'))
					sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			});
	box.appendChild(img_div);

	var img = document.createElement('img');
	img_div.appendChild(img);
	img.className = 'edicola_offline_container_box_img';
	// img.src = navigator.fileMgr.docsFolderPath + '/issues/' + p_item.testata
	// + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	// ANDROID MODDED
	img.src = window.folder.getDir()
			+ /* navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' */'/'
			+ p_item.testata + '/' + p_item.issue + '/' + p_item.edizione
			+ '/cover_low.jpg';
	// console.log("path-off:: "+navigator.fileMgr.libFolderPath +
	// 'file:///mnt/sdcard/' + p_item.testata + '/' + p_item.issue + '/' +
	// p_item.edizione + '/cover_low.jpg');

	var txt = document.createElement('div');
	txt.className = 'edicola_offline_container_box_txt_'
			+ _EDICOLA_OFFLINE_MODE;
	txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong><br/>'
			+ p_item.issue_descr + '<br />' + p_item.edizione_descr;
	box.appendChild(txt);

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE
			+ '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'edicola_offline_container_box_txt_empty_'
			+ _EDICOLA_OFFLINE_MODE;
	$(txt_local).click(
			function() {
				if ($('#edicola_offline_container').hasClass(
						'edicola_offline_modify')) {
					eliminaCopiaLocale(p_item.testata, p_item.issue,
							p_item.edizione);
				}
			});
}

/**
 * Crea la rappresentazione in lista di un oggetto salvato in locale
 * 
 * @params p_item Oggetto salvato in locale
 * 
 */
function edicolaOfflineRenderAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	// box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
	// + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
			+ ' edicola_offline_'
			+ edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'edicola_offline_container_box_txt_'
			+ _EDICOLA_OFFLINE_MODE;
	// txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong> ' +
	// p_item.edizione_descr + ' ' + p_item.issue_descr;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> '
			+ p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	var btn = document.createElement('input');
	btn.id = 'edicola_offline_container_box_btn_' + p_item.testata + '_'
			+ p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 edicola_offline_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'edicola_offline_container_box_del_btn_' + p_item.testata
			+ '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 edicola_offline_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);
}

/**
 * Inizializza il filtro sulle testate/edizioni da mostrare.
 */
_EDICOLA_OFFLINE_FILTRO_EDIZIONI = null;
function edicolaOfflineInitFilter() {
	if (_EDICOLA_OFFLINE_FILTRO_EDIZIONI != null) {
		$(_EDICOLA_OFFLINE_FILTRO_EDIZIONI).empty();
	} else {
		_EDICOLA_OFFLINE_FILTRO_EDIZIONI = new Array();
	}
	var l_filtro_select = $('#edicola_offline_filtro');
	l_filtro_select.empty();

	l_filtro_select.change(function() {
		var l_selected_option = $('#edicola_offline_filtro option:selected');

		if (l_selected_option.val() == '') {
			// $('#edicola_offline_container .edicola_offline_container_box_' +
			// _EDICOLA_OFFLINE_MODE).fadeIn(200);
			$(
					'#edicola_offline_container .edicola_offline_container_box_'
							+ _EDICOLA_OFFLINE_MODE).css('display',
					'inline-block');
		} else {
			$(
					'#edicola_offline_container .edicola_offline_container_box_'
							+ _EDICOLA_OFFLINE_MODE).not(
					'.edicola_offline_' + l_selected_option.val()).css(
					'display', 'none');
			// $('#edicola_offline_container .edicola_offline_container_box_' +
			// _EDICOLA_OFFLINE_MODE + '.edicola_offline_' +
			// l_selected_option.val()).fadeIn(200);
			$(
					'#edicola_offline_container .edicola_offline_container_box_'
							+ _EDICOLA_OFFLINE_MODE + '.edicola_offline_'
							+ l_selected_option.val()).css('display',
					'inline-block');
		}

		edicolaOfflineUpdateIscroll();
	});

	var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	l_filtro_select.append(l_option);

	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_RICHOFFLINE_FILTRO_EDIZIONI.push(row);
}

/**
 * Gestisce la creazione del filtro sui prodotti da mostrare.
 * 
 * @params p_item Oggetto salvato in locale
 */
function edicolaOfflineLabelToValue(p_label) {
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}
function edicolaOfflineUpdateFilter(p_item) {
	// var l_value = p_item.testata + '_' + p_item.edizione;
	var l_value = edicolaOfflineLabelToValue(p_item.edizione_descr);
	// var l_text = p_item.testata_descr + ' - ' + p_item.edizione_descr;
	var l_text = p_item.edizione_descr;
	// Se l'edizione non è presente nell'array _EDICOLA_OFFLINE_FILTRO_EDIZIONI
	// crea un nuovo elemento nell'array ed aggiunge un opzione nel filtro
	if (jQuery.inArray(l_value, _EDICOLA_OFFLINE_FILTRO_EDIZIONI) == -1) {

		_EDICOLA_OFFLINE_FILTRO_EDIZIONI.push(l_value, l_text);

		var row = {
			value : l_value,
			label : l_text
		};
		console.log('rich ' + row.value + ',' + row.label);
		_RICHOFFLINE_FILTRO_EDIZIONI.push(row);

		// alert(_RICHOFFLINE_FILTRO_EDIZIONI.length);

		var l_option = $('<option></option>');
		l_option.val(l_value);
		l_option.text(l_text);
		$('#edicola_offline_filtro').append(l_option);
	}
}

function updateRichFiltroOff() {
	var value_select = $('#edicola_offline_filtro option:selected').val();
	var dhtmlx_listProductsSelectOff = _RICHOFFLINE_FILTRO_EDIZIONI;

	$$('myRichOffselect').attachEvent(
			"onchange",/* impostazioniProdottoPrincipaleSelectOnChange() */
			function(newv, oldv) {
				setTimeout(function() {
					if (oldv != newv) {

						$('#edicola_offline_filtro option:selected')
								.removeAttr('selected');

						if (newv.indexOf('Tutti i prodotti') == -1) {
							$(
									"#edicola_offline_filtro option[value='"
											+ newv + "']").attr('selected',
									'selected');
						} else {
							// alert('aaa'+newv);
							$("#edicola_offline_filtro option[value='']").attr(
									'selected', 'selected');
						}
						console.log('changed');
						edicolaOfflineLoad(_EDICOLA_OFFLINE_MODE);
					}
				}, 200);

			});

}

/**
 * Passa alla modalità modifica
 */
function edicolaOfflineModifica() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'none');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display',
			'inline-block');
	$('#edicola_offline_container').addClass('edicola_offline_modify');
}

/**
 * Passa alla modalità visualizza
 */
function edicolaOfflineVisualizza() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display',
			'inline-block');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'none');
	$('#edicola_offline_container').removeClass('edicola_offline_modify');
}

var _INBOX_LIST_ISCROLL = null;
var _INBOX_MESSAGES = {};
var _INBOX_NUM_UNREAD_MESSAGES = 0;

function inboxRefreshInCorso() {
	$('#inbox_list_refresh_button').css('display', 'none');
	$('#inbox_list_refresh_message').html('Aggiornamento in corso...');
}

function inboxRefreshCompletato() {
	setTimeout(function() {
		$('#inbox_list_refresh_button').css('display', 'inline');
		$('#inbox_list_refresh_message').html(
				'<strong>Aggiornato</strong> '
						+ (new Date()).format('dd/mm/yyyy') + ' <strong>'
						+ (new Date()).format('HH:MM:ss') + '</strong>');
	}, 1000);
}

/*
 * Restituisce i messaggi presenti nel database locale @return Lista di messaggi
 */
function inboxLoadMessages() {

	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.destroy();
		_INBOX_LIST_ISCROLL = null;
	}

	$('#inbox_list_container').empty();

	// Controlla che il database sia stato inizializzato e carica i messaggi
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// console.log("Read " + len + " messages from the local INBOX
			// store.");

			inboxAddMessages(p_results.rows);

			inboxLoadUnreadMessages();

			// inboxOpenFirstMessageSilent();

			setInterval(inboxLoadUnreadMessages, _INTERVALLO_CHECK_INBOX);
		}

		var queryError = function(p_error) {
			console.log("inboxLoadMessages: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			// tx.executeSql('DROP TABLE IF EXISTS INBOX_MESSAGES_2');
			tx
					.executeSql('CREATE TABLE IF NOT EXISTS INBOX_MESSAGES_2 (id unique, date, subject, mabstract, body, status)');
			tx
					.executeSql(
							'SELECT id, date, subject, mabstract, body, status FROM INBOX_MESSAGES_2 order by date asc, id asc',
							[], querySuccess, queryError);
		}

		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

function inboxCloseMsgView() {
	// $('#inbox_msg_container').css('display', 'none');
	$('#inbox_container').removeClass('inbox_container_open');
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
}

function inboxUpdateOrientation() {
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';

	console.log('inboxUpdateOrientation '
			+ $('#inbox_container').hasClass('inbox_container_open') + ','
			+ document.getElementById('inbox_container').className);

	// se aperto msg inbox lo riapro quando sono in verticale
	if ($('#inbox_container').hasClass('inbox_container_open')
			&& _ORIENTATION == 'V' && screen.width < 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-'
				+ window.innerWidth + 'px, 0px, 0)';
	} else if ($('#inbox_container').hasClass('inbox_container_open')
			&& _ORIENTATION == 'V' && screen.width > 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-'
				+ window.innerWidth + 'px, 0px, 0)';
	}

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.refresh();
	}
	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * 
 * @params p_messages_list Lista dei messaggi
 */
function inboxAddMessages(p_messages_list) {

	for ( var i = 0; i < p_messages_list.length; i++) {

		inboxAddMessage(p_messages_list.item(i));

	}

	/*
	 * console.log('Messaggi presenti in locale:');
	 * console.log(_INBOX_MESSAGES);
	 */
}

function inboxAddMessage(p_message) {
	_INBOX_MESSAGES['mid_' + p_message.id] = {
		id : p_message.id,
		subject : p_message.subject,
		mabstract : p_message.mabstract,
		date : p_message.date,
		body : p_message.body,
		status : p_message.status
	};

	inboxRenderHeader(p_message.id);

	inboxUpdateUnreadMessage();
}

/**
 * Carica i messaggi non letti in base al device
 */
var _INBOX_TOBEFETCH_MSGS = [];
var _INBOX_REFRESH_ISRUNNING = false;
function inboxLoadUnreadMessages() {

	if (_INBOX_REFRESH_ISRUNNING || (_INBOX_TOBEFETCH_MSGS.length > 0)) {
		console.log('Aggiornamento già in corso...');
		return;
	}

	_INBOX_REFRESH_ISRUNNING = true;

	inboxRefreshInCorso();

	// console.log('Retrieve unread messages');
	var l_signature = getSignature(device.uuid + ',' + device.platform);
	// console.log('Signature: ' + l_signature);

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> getUnreadMessagesDevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getUnreadMessagesDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if (typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getUnreadMessagesDevice');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				for ( var i = 0; i < p_response.Result.messages.length; i++) {
					var l_message = p_response.Result.messages[i];
					_INBOX_TOBEFETCH_MSGS.push({
						id : l_message.id,
						subject : l_message.subject,
						mabstract : "",
						date : l_message.data,
						body : "",
						status : 1
					});
				}

				inboxFetchMessages();

			} else {
				inboxRefreshCompletato();
			}

			_INBOX_REFRESH_ISRUNNING = false;
		},
		error : function() {
			inboxRefreshCompletato();

			_INBOX_REFRESH_ISRUNNING = false;
		}
	});

}

function inboxFetchMessages() {
	var l_message = _INBOX_TOBEFETCH_MSGS.shift();
	if (l_message == null) {
		inboxRefreshCompletato();
		// inboxOpenFirstMessageSilent();
		return;
	}
	console.log(l_message);

	// scarico in locale il messaggio
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"messageId" : l_message.id
	};
	console.log('---REQ---> getMessageBody (' + l_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getMessageBody",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if (typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getMessageBody (' + l_message.id + ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {

				l_message.body = p_response.Result.body;

				if (p_response.Result.preview) {
					l_message.mabstract = p_response.Result.preview;
				} else {
					l_message.mabstract = "";
				}

				inboxMarkAsReadMessageOnServer(l_message);

			} else {
				inboxFetchMessages();
			}
		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxMarkAsReadMessageOnServer(p_message) {
	var l_signature = getSignature(p_message.id + ',' + device.uuid + ','
			+ device.platform);
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"messageId" : p_message.id,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> markMessageReadDevice (' + p_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/markMessageReadDevice",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if (typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> markMessageReadDevice (' + p_message.id
					+ ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				// processo verso server completato, posso salvare il messaggio
				// in locale
				inboxStoreMessageFromServer(p_message);
			} else {
				inboxFetchMessages();
			}

		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxStoreMessageFromServer(p_message) {
	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxStoreMessageFromServer OK');
			inboxAddMessage(p_message);
			inboxFetchMessages();
		}

		var queryError = function(p_error) {
			console
					.log("inboxStoreMessageFromServer KO: Error processing SQL: "
							+ p_error.message);
			inboxFetchMessages();
		}

		var executeQuery = function(tx) {
			tx
					.executeSql(
							'INSERT INTO INBOX_MESSAGES_2 (id, date, subject, mabstract, body, status) VALUES (?,?,?,?,?,?)',
							[ p_message.id, p_message.date, p_message.subject,
									p_message.mabstract, p_message.body,
									p_message.status ], querySuccess,
							queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Aggiunge l'intestazione di un messaggio
 * 
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function inboxRenderHeader(p_mid) {
	var box = document.createElement('div');

	var l_container = document.getElementById('inbox_list_container');
	l_container.insertBefore(box, l_container.childNodes[0]);

	if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
		box.className = 'inbox_list_container_box inbox_list_container_box_read';
	} else {
		box.className = 'inbox_list_container_box inbox_list_container_box_unread';
	}

	box.id = 'inbox_list_container_box_' + p_mid;

	var table = document.createElement('table');
	box.appendChild(table);
	table.className = 'inbox_list_container_box_table';

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 * 
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 * 
	 * var td12 = document.createElement('td');
	 */

	var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
	if (l_subject && l_subject != '') {
		if (screen.width < 790) {
			l_subject = l_subject.substring(0, 25);
		} else {
			l_subject = l_subject.substring(0, 40);
		}
		if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
			l_subject += '...'
	}

	/*
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 * 
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 */

	var tr2 = document.createElement('tr');
	table.appendChild(tr2);

	var td21 = document.createElement('td');
	tr2.appendChild(td21);
	td21.className = 'inbox_list_container_box_c1_status';
	// Gestisce la selezione dei messaggi quando l'utente si trova nella
	// tipologia "modifica"
	td21.onclick = function(p_event) {
		var l_message_header = $('#inbox_list_container_box_' + p_mid);

		if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
			l_message_header.removeClass('inbox_list_container_box_unselected');
			l_message_header.addClass('inbox_list_container_box_selected');

		} else if (l_message_header
				.hasClass('inbox_list_container_box_selected')) {
			l_message_header.removeClass('inbox_list_container_box_selected');
			l_message_header.addClass('inbox_list_container_box_unselected');
		}

		p_event.stopPropagation();
	};
	td21 = null;

	var td22 = document.createElement('td');
	tr2.appendChild(td22);
	td22.className = 'inbox_list_container_box_c2';
	td22.innerHTML = '<h1>' + l_subject + '</h1><h3>'
			+ _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
	td22 = null;

	var td23 = document.createElement('td');
	tr2.appendChild(td23);
	td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>'
			+ inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	td23 = null;

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 * 
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 * 
	 * var td12 = document.createElement('td');
	 * 
	 * var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject; if (l_subject &&
	 * l_subject != '') { l_subject = l_subject.substring(0, 40); if
	 * (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
	 * l_subject += '...' }
	 * 
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 * 
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 * 
	 * var tr2 = document.createElement('tr'); table.appendChild(tr2);
	 * 
	 * var td21 = document.createElement('td'); tr2.appendChild(td21);
	 * td21.className = 'inbox_list_container_box_c1_status'; // Gestisce la
	 * selezione dei messaggi quando l'utente si trova nella tipologia
	 * "modifica" td21.onclick = function(p_event){ var l_message_header =
	 * $('#inbox_list_container_box_' + p_mid);
	 * 
	 * if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
	 * l_message_header.removeClass('inbox_list_container_box_unselected');
	 * l_message_header.addClass('inbox_list_container_box_selected'); } else if
	 * (l_message_header.hasClass('inbox_list_container_box_selected')) {
	 * l_message_header.removeClass('inbox_list_container_box_selected');
	 * l_message_header.addClass('inbox_list_container_box_unselected'); }
	 * 
	 * p_event.stopPropagation(); }; td21 = null;
	 * 
	 * var td22 = document.createElement('td'); tr2.appendChild(td22);
	 * td22.className = 'inbox_list_container_box_c2'; td22.innerHTML = '<h3>' +
	 * _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>'; td22 = null;
	 * 
	 * var td23 = document.createElement('td'); tr2.appendChild(td23);
	 * td23.className = 'inbox_list_container_box_c3_goto'; td23 = null;
	 */

	box.onclick = (function(p_mid) {
		return function() {
			inboxOpenMessage(p_mid);
		}
	})(p_mid);

	box = null;

	if (_INBOX_LIST_ISCROLL == null) {
		_INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
	} else {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/*
 * function inboxOpenFirstMessageSilent() { var l_opened =
 * $('.inbox_list_container_box_active'); if (l_opened.length == 0) { var
 * l_boxes = $('.inbox_list_container_box'); if (l_boxes.length > 0) {
 * console.log(l_boxes); $(l_boxes[0]).click(); inboxCloseMsgView(); } } }
 */

var _INBOX_MSG_ISCROLL = null;
function inboxOpenMessage(mid) {

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.destroy();
		_INBOX_MSG_ISCROLL = null;
	}

	inboxInitNavButtons(mid);

	$('#inbox_msg_title_content_del').css('display', 'inline-block');
	$('#inbox_msg_container_empty').css('display', 'none');

	var l_message_container = $('#inbox_msg_container');
	l_message_container.css('display', 'inline-block');

	var box = document.getElementById('inbox_list_container_box_' + mid);
	$('.inbox_list_container_box').removeClass(
			'inbox_list_container_box_active');
	$(box).addClass('inbox_list_container_box_active');
	$(box).removeClass('inbox_list_container_box_unread');
	$(box).addClass('inbox_list_container_box_read');
	box = null;

	/*
	 * if (_ORIENTATION == 'V' && screen.width < 790){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(-400px, 0px, 0)'; } else if (_ORIENTATION == 'V' &&
	 * screen.width > 790){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(-800px, 0px, 0)'; } else if(_ORIENTATION == 'H'){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(0px, 0px, 0)'; }
	 */

	if (_ORIENTATION == 'V') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-'
				+ window.innerWidth + 'px, 0px, 0)';
	} else if (_ORIENTATION == 'H') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}

	// .className+=' newclass'
	// document.getElementById('inbox_container').className +=
	// 'inbox_container_open';
	// alert('aaa'+document.getElementById('inbox_container').className);
	$('#inbox_container').addClass('inbox_container_open');
	// alert('aaa'+document.getElementById('inbox_container').className);
	// document.getElementById('inbox_container').className +=
	// 'inbox_container_open';

	if (_INBOX_MESSAGES['mid_' + mid] == null)
		return;

	document.getElementById('inbox_msg_header_title').innerHTML = _INBOX_MESSAGES['mid_'
			+ mid].subject;
	document.getElementById('inbox_msg_header_data').innerHTML = inboxFormatDate(_INBOX_MESSAGES['mid_'
			+ mid].date);
	document.getElementById('inbox_msg_body').innerHTML = _INBOX_MESSAGES['mid_'
			+ mid].body;
	_INBOX_MESSAGES['mid_' + mid].status = 0;
	inboxUpdateUnreadMessage();

	setTimeout(function() {
		if (_INBOX_MSG_ISCROLL == null) {
			_INBOX_MSG_ISCROLL = new iScroll('inbox_msg_wrapper');
		} else {
			_INBOX_MSG_ISCROLL.refresh();
		}
	}, 100);

	// marco il messaggio come letto sul db
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxOpenMessage OK');
		}

		var queryError = function(p_error) {
			console.log("inboxOpenMessage KO: Error processing SQL: "
					+ p_error.message);
			inboxFetchMessages();
		}

		var executeQuery = function(tx) {
			tx.executeSql('UPDATE INBOX_MESSAGES_2 SET status=0 WHERE id=?',
					[ mid ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

	omnitureTrackApp('APP:inbox:open:' + mid, 'APP:inbox');
}

function inboxUpdateUnreadMessage() {
	_INBOX_NUM_UNREAD_MESSAGES = 0;
	for ( var key in _INBOX_MESSAGES) {
		var l_msg = _INBOX_MESSAGES[key];
		if (l_msg.status == 1)
			_INBOX_NUM_UNREAD_MESSAGES++;
	}

	if (_INBOX_NUM_UNREAD_MESSAGES > 0) {
		// $('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
		// $('#appmenu_inbox_count').text('*');
		$('#appmenu_inbox_count').css('display', 'inline-block');
	} else {
		$('#appmenu_inbox_count').css('display', 'none');
	}
}

function inboxFormatDate(p_date) {
	if (p_date.length != 19)
		return "00 00 0000";
	var toks = p_date.split(' ');
	if (toks.length != 2)
		return "00 00 0000";
	var cals = toks[0].split('-');
	if (cals.length != 3)
		return "00 00 0000";
	return cals[2] + ' ' + cals[1] + ' ' + cals[0];
}

/**
 * Passa alla modalità modifica messaggi
 */
function inboxSwitchToModifyView() {
	$('#inbox_list_modify_button').hide();
	$('#inbox_list_show_button').show();
	$('.inbox_list_container_box').addClass(
			'inbox_list_container_box_unselected');
	$('#elimina_messaggi').fadeIn();
}

/**
 * Passa alla modalità visualizza messaggi
 */
function inboxSwitchToShowView() {
	$('#inbox_list_show_button').hide();
	$('#inbox_list_modify_button').show();
	$('.inbox_list_container_box.inbox_list_container_box_unselected')
			.removeClass('inbox_list_container_box_unselected');
	$('.inbox_list_container_box.inbox_list_container_box_selected')
			.removeClass('inbox_list_container_box_selected');
	$('#elimina_messaggi').fadeOut();
}

/**
 * Inizializza lo stato dei pulsanti per la navigazione tra i messaggi
 */
function inboxInitNavButtons(p_header_id) {
	// console.log("inboxInitNavButton");
	var l_next_element = $('#inbox_msg_title_nav_next_btn');
	l_next_element.unbind('click');

	var l_prev_element = $('#inbox_msg_title_nav_prev_btn');
	l_prev_element.unbind('click');

	if ($('#inbox_list_container_box_' + p_header_id).prev().length) {
		l_next_element.removeClass('disabled');
		l_next_element.click(function() {
			inboxOpenPrevMsg(p_header_id);
		});
	} else {
		l_next_element.addClass('disabled');
	}

	if ($('#inbox_list_container_box_' + p_header_id).next().length) {
		$('#inbox_msg_title_nav_prev_btn').removeClass('disabled');
		l_prev_element.click(function() {
			inboxOpenNextMsg(p_header_id);
		});
	} else {
		$('#inbox_msg_title_nav_prev_btn').addClass('disabled');
	}
}

/**
 * Apre il messaggio successivo
 */
function inboxOpenPrevMsg(p_header_id) {
	var l_prev = $('#inbox_list_container_box_' + p_header_id).prev();
	if (l_prev.length) {
		var mid = l_prev[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}
/**
 * Apre il messaggio precedente
 */
function inboxOpenNextMsg(p_header_id) {
	var l_next = $('#inbox_list_container_box_' + p_header_id).next();
	if (l_next.length) {
		var mid = l_next[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}

/*
 * Elimina i messaggi dal database @params p_mids Lista dei identificativi dei
 * messaggi
 */
function deleteLocalMessages(p_mids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB && p_mids.length > 0) {

		var querySuccess = function() {
			console.log('Deleted messages ' + p_mids.toString());
			deleteInboxElements(p_mids);
		}

		var queryError = function(p_error) {
			console.log("deleteLocalMessages: Error processing SQL: "
					+ p_error.message);
		}

		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM INBOX_MESSAGES_2 WHERE id in ('
					+ p_mids.toString() + ')');
			// querySuccess();
		}

		_DB.transaction(executeQuery, queryError, querySuccess);
	}
}

/**
 * Elimina i messaggi selezionati in modalità modifica
 */
function inboxDeleteMessages() {
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	var l_all_messages = [];

	for ( var i = 0; i < l_messages.length; i++) {
		var l_mid = l_messages[i].id.substring(25);
		l_all_messages.push(l_mid);
	}

	if (l_all_messages.length > 0) {
		deleteLocalMessages(l_all_messages);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun messaggio',
				'Inbox');
	}

	/*
	 * var l_messages =
	 * $('.inbox_list_container_box.inbox_list_container_box_selected'); var
	 * l_remote_messages = []; var l_all_messages = [];
	 * 
	 * for (var i = 0; i < l_messages.length; i++) { var l_mid =
	 * l_messages[i].id.substring(25); if (_INBOX_MESSAGES[l_mid]) {
	 * l_all_messages.push(l_mid);
	 * 
	 * if (!_INBOX_MESSAGES[l_mid].body) { l_remote_messages.push(l_mid); } } } //
	 * I messaggi non scaricati vengono segnalati come già letti if
	 * (l_remote_messages.length > 0) { markMessagesAsRead(l_remote_messages); } //
	 * Tutti i messaggi vengono eliminati dal database // (per evitare problemi
	 * dovuti alla sincronizzazione con chiamate remote si cerca di eliminare
	 * anche quelli che non sembrano essere stati scaricati) if
	 * (l_all_messages.length > 0) { deleteLocalMessages(l_all_messages); } else {
	 * alert('Attenzione, non è stato selezionato nessun messaggio'); }
	 */
}

/**
 * Elimina gli elementi html relativi ai messaggi
 * 
 * @params p_mids Lista degli identificativi dei messaggi che devono essere
 *         eliminati
 */
function deleteInboxElements(p_mids) {
	var l_active_message = $('.inbox_list_container_box_active');
	if (l_active_message.length > 0) {
		var l_active_message_id = l_active_message[0].id.substring(25);

		if (jQuery.inArray(l_active_message_id, p_mids) != -1) {
			// $('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
		}
	}
	$('.inbox_list_container_box.inbox_list_container_box_selected').remove();
}

/**
 * Elimina il messaggio aperto
 */
function inboxDeleteOpenedMessage() {
	window.simulatePG.confirm('Il messaggio verrà cancellato.\nSei sicuro?',
			'inboxDeleteOpenedMessageSucc()', 'Cancellazione messaggio',
			'Si,No');
}

(function() {
	var _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart'
			: 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend'
			: 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseout';

	var CoveerFlow = function(container, covers) {
		this._container = typeof container == 'object' ? container : document
				.getElementById(container);
		this._covers = covers;
		this._initialization();

	};

	CoveerFlow.prototype = {
		_startX : 0,
		_startY : 0,
		_moveX : 0,
		_moveY : 0,
		_galleryHeight : 0,
		_touching : false,
		_moved : false,
		_initialization : function() {
			try {
				this._current = 0;
				this._totals = this._covers.length;
				this._stepPercent = 30;// 25;//15;
				this._currentSlidePaddingPercent = 50;// 25;
				this._rotateAngle = 0;// 65;
				this._loaded = 0;

				var gallery = document.createElement('div');
				this._container.appendChild(gallery);
				gallery.className = 'coveerflow';
				// gallery.style.visibility = 'hidden';
				console.log("gallery _ORIENTATION is " + _ORIENTATION);
				console.log("gallery " + parseInt(gallery.offsetHeight, 10)
						+ "," + parseInt((window.innerHeight / 2) * 90 / 100));
				var galleryHeight = null;
				var slideHeight = null;
				if (_ORIENTATION == 'V') {
					galleryHeight = Math
							.round($('#edicola_prodotto').height() * 0.48);
					slideHeight = galleryHeight;
				} else {
					galleryHeight = Math.round($('#edicola_prodotto').height());
					slideHeight = galleryHeight;
				}

				this._galleryHeight = galleryHeight;
				// slideHeight = galleryHeight ;//- 20;/*50/*AB150;*/

				this._step = galleryHeight * this._stepPercent / 100;
				this._currentSlidePadding = galleryHeight
						* this._currentSlidePaddingPercent / 100;

				console.log('gal1 galleryHeight ' + galleryHeight);
				console.log('gal1 slideHeight ' + slideHeight);
				console.log('gal1 _step ' + this._step);
				console.log('gal1 _currentSlidePadding '
						+ this._currentSlidePadding);

				for ( var i = 0; i < this._totals; i++) {
					var coverdiv = document.createElement('div');
					gallery.appendChild(coverdiv);

					console.log('gal1 slideHeight ' + slideHeight);

					coverdiv.style.height = '100%';

					var coverimg = document.createElement('img');
					coverdiv.appendChild(coverimg);

					if (this._covers[i]['anteprima']) {
						var anteprimaimg = document.createElement('img');
						anteprimaimg.className = 'coveerflow_anteprima';
						coverdiv.appendChild(anteprimaimg);
						anteprimaimg.src = 'imgs/coveerflow_anteprima.png';
						anteprimaimg = null;
					}

					if (this._covers[i]['abbonati']) {
						var abbonatiimg = document.createElement('img');
						abbonatiimg.className = 'coveerflow_abbonati';
						coverdiv.appendChild(abbonatiimg);
						abbonatiimg.src = 'imgs/coveerflow_abbonati2.png';
						abbonatiimg = null;
					}

					coverimg = null;
					coverdiv = null;
				}

				gallery = null;

				this._bind(_START_EV);
				this._bind(_MOVE_EV);
				this._bind(_END_EV);
				this._bind(_CANCEL_EV);

				// parte aggiunta per evitare l'attesa dell'onload delle
				// immagini
				this._display();
				var that = this;
				setTimeout(function() {
					that._setAnimation();
				}, 100);
				// alert('ok'+_ORIENTATION);
			} catch (exc) {
				console.log(exc.message)
			}
		},
		_setAnimation : function() {
			var coverdivs = this._container.children[0].children;
			for ( var i = 0; i < coverdivs.length; i++) {
				coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
			}
		},
		_display : function() {
			if (_ORIENTATION == 'V') {
				galleryHeight = Math
						.round($('#edicola_prodotto').height() * 0.48);
				slideHeight = galleryHeight;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());
				slideHeight = galleryHeight;
			}
			this._galleryHeight = galleryHeight;

			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight
					* this._currentSlidePaddingPercent / 100;

			var galleryCenter = null;// 600 / 2;
			if (_ORIENTATION == 'V') {
				galleryCenter = Math.round(window.innerWidth * 0.5);
			} else {
				galleryCenter = Math.round($('#edicola_prodotto_coverflow')
						.width() * 0.5);
			}
			console.log("gallcent: " + galleryCenter);
			var coverdivs = this._container.children[0].children;

			// alert("children "+this._container.children[0].children);

			for ( var i = 0; i < this._totals; i++) {
				// var l_cover_width = parseInt(coverdivs[i].offsetWidth, 10);
				console.log("cover#" + i + " "
						+ parseInt(window.innerWidth / 2 + 10));
				var l_cover_width = null;
				if (_ORIENTATION == 'V') {
					l_cover_width = Math.round(window.innerWidth * 0.5);
					// alert(window.innerWidth);
				} else {
					l_cover_width = Math.round(window.innerWidth * 0.3);
				}
				$(coverdivs[i]).width(l_cover_width);

				this._step = $(coverdivs[i]).width() / 2;

				if (i < this._current) {
					// precedenti - sinistra
					var leftPos = parseInt(galleryCenter
							- (this._current * this._step) + (i * this._step)
							- (l_cover_width / 2) - this._currentSlidePadding,
							10);
					coverdivs[i].style.webkitTransform = 'translate3d('
							+ leftPos + 'px, 0px, 0px)';
				} else {
					if (i == this._current) {
						// corrente - centrale
						var leftPos = galleryCenter - (l_cover_width / 2);
						coverdivs[i].style.webkitTransform = 'translate3d('
								+ leftPos + 'px, 0px, 0px)';
					} else {
						// successivi - destra
						var leftPos = parseInt(galleryCenter
								+ ((i - this._current) * this._step)
								- (l_cover_width / 2)
								+ this._currentSlidePadding, 0);
						coverdivs[i].style.webkitTransform = 'translate3d('
								+ leftPos + 'px, 0px, 0px)';
					}

					coverdivs[i].style.display = 'inline-block';
					coverdivs[i].children[0].src = this._covers[i]['src'];
				}
			}

			if (_ORIENTATION == 'V') {
				$('.coveerflow img').each(
						function() {
							var that = this;
							$(that).css(
									'margin-top',
									Math.round((($('#edicola_prodotto')
											.height() * 0.48) - $(that)
											.height()) / 2));
							$(that).load(
									function() {
										$(that).css(
												'margin-top',
												Math.round((($(
														'#edicola_prodotto')
														.height() * 0.48) - $(
														that).height()) / 2));
									});
						});
			} else {
				$('.coveerflow img').each(
						function() {
							var that = this;
							$(that).css(
									'margin-top',
									Math.round(($('#centrale').height() - $(
											that).height()) / 2));
							$(that).load(
									function() {
										$(that).css(
												'margin-top',
												Math.round(($('#centrale')
														.height() - $(that)
														.height()) / 2));
									});
						});
			}
		},
		_bind : function(type, element, bubble) {
			(element || this._container).addEventListener(type, this, !!bubble);
		},
		_unbind : function(type, element, bubble) {
			(element || this._container).removeEventListener(type, this,
					!!bubble);
		},
		handleEvent : function(e) {
			switch (e.type) {
			case _START_EV:
				this._e_start(e);
				break;
			case _MOVE_EV:
				this._e_move(e);
				break;
			case _END_EV:
			case _CANCEL_EV:
				this._e_end(e);
				break;
			}
		},
		_e_start : function(e) {
			e.preventDefault();
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._startX = _e.clientX;
			this._startY = _e.clientY;
			this._touching = true;
			this._moved = false;
			/*
			 * this._bind(_MOVE_EV); this._bind(_END_EV);
			 * this._bind(_CANCEL_EV); this._unbind(_START_EV);
			 */
		},
		_e_move : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._moveX = _e.clientX;
			this._moveY = _e.clientY;
			this._moved = true;
		},
		_e_end : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;

			if (!this._moved) {
				if (this._touching) {
					if (typeof this.on_tap != "undefined") {
						this.on_tap.call();
					}
				}
				return;
			}

			if (this._moveX - this._startX > 100)
				this._gotoPrev();
			else if (this._moveX - this._startX < -100)
				this._gotoNext();

			var that = this;
			setTimeout(function() {
				that._touching = false;
			}, 300);

			if (this.on_end) {
				this.on_end.call();
			}
			/*
			 * this._unbind(_MOVE_EV); this._unbind(_END_EV);
			 * this._unbind(_CANCEL_EV);
			 */
		},
		_gotoNext : function() {
			if (this._current + 1 >= this._totals)
				return;
			this._current++;
			this._display();
		},
		_gotoPrev : function() {
			if (this._current <= 0)
				return;
			this._current--;
			this._display();
		},
		destroy : function() {
			this._unbind(_START_EV);
			this._unbind(_START_EV);
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
		}
	}

	window.CoveerFlow = CoveerFlow;
})();
/**
 * @author ABertacco
 */
var _NIELSEN_BASE_URL = "http://secure-it.imrworldwide.com/cgi-bin/m?ci=ilsole-app&cg=0&si=";

var _AREE = {
	'ALTRO' : 'http%3A//sfogliatoremobile.ilsole24ore.com',
	'EDICOLA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/edicola',
	'ARCHIVIO_PRODOTTI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/archivio_prodotti',
	'PREFERITI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/preferiti',
	'RICERCA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/ricerca',
	'INBOX' : 'http%3A//sfogliatoremobile.ilsole24ore.com/inbox',
	'REGISTRAZIONE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/registrazione',
	'SFOGLIATORE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/sfogliatore'
}

function nielsenCall(area) {
	try {
		if (_AREE[area] == null)
			area = 'ALTRO';
		document.getElementById('nielsen_wrapper').innerHTML = '';
		var img = document.createElement('img');
		document.getElementById('nielsen_wrapper').appendChild(img);
		$(img).load(function() {
			console.log('nielsen load ' + area);
		});
		$(img).error(function() {
			console.log('nielsen error ' + area);
		});
		img.src = _NIELSEN_BASE_URL + _AREE[area];
		img = null;
	} catch (exc) {
		console.log('nielsen exception: ' + exc.message);
	}
}
/**
 * @author ABertacco
 */
function omnitureTrackApp(pageName, channel) {
	try {

		// PhoneGap.exec("AppMeasurementCommand.trackApp", pageName, channel);
		// window.plugins.flipper24.trackApp(null, null, pageName, channel);
		console.log("omniture:: " + pageName + ', ' + channel);
		window.infodroid.track(null, null, pageName, channel);

	} catch (exc) {

		// alert("ERROR OMNI");
	}

}
/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il
// dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];

	// PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();

	if ((id_shopping24 == null) || (id_itunes == null))
		return;

	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' '
			+ id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui
	// conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere
	// processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console
				.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in
	// _IAP_REQ_QUEUE
	// var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	// PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for ( var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null)
				continue;
			console.log('OK ' + l_product.productIdentifier);
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}

		for ( var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}

		return "OK";
	} catch (exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils
				.alert(
						'Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.',
						'Acquisto');
		return false;
	}

	navigator.notification.loadingStart({
		'labelText' : "Acquisto in corso...",
		'backgroundOpacity' : 0.8,
		'strokeOpacity' : 0.25,
		'strokeColor' : "FFFFFF",
	});

	_APPSTORE_BUY_CALLBACK = callback;

	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({
			Success : false,
			Exception : {
				Name : 'ExpiredUserIdentityException',
				Description : 'Rinnovo useridentity pre-pagamento.'
			}
		}, function() {
			// PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes,
					id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		// PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: '
				+ p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK
				&& typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else
			abutils
					.alert(
							'Si è verificato un errore durante la comunicazione con il server.',
							'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}


if ($(window).width() < 590) {

	document.write('<script type="text/javascript" charset="utf-8" src="is24h_galaxy_little.js" ></script>');
	document.write('<script type="text/javascript" charset="utf-8" src="is24h_galaxy_little_qarchivio.js" ></script>');

} else {

	//document.write('<script type="text/javascript" charset="utf-8" src="is24h_galaxy.js" ></script>');
	document.write('<script type="text/javascript" charset="utf-8" src="is24h_galaxy_little.js" ></script>');
	document.write('<script type="text/javascript" charset="utf-8" src="is24h_galaxy_little_qarchivio.js" ></script>');

}

var checkboxHeight = "26";
var radioHeight = "26";

var GalaxyCheckboxStyle = {
	init: function() {
		var inputs = document.getElementsByTagName("input"), span = Array(), textnode, option, active;
		for(a = 0; a < inputs.length; a++) {
			if((inputs[a].type == "checkbox" || inputs[a].type == "radio") && inputs[a].className == "galaxy_style") {
				span[a] = document.createElement("span");
				span[a].className = inputs[a].type;

				if(inputs[a].checked == true) {
					if(inputs[a].type == "checkbox") {
						position = "0 -" + (checkboxHeight) + "px";
						span[a].style.backgroundPosition = position;
					} else {
						position = "0 -" + (radioHeight) + "px";
						span[a].style.backgroundPosition = position;
					}
				}
				inputs[a].parentNode.insertBefore(span[a], inputs[a]);
				inputs[a].onchange = GalaxyCheckboxStyle.clear;
				if(!inputs[a].getAttribute("disabled")) {
					if(_DEBUG_MODE){
						span[a].onmousedown = GalaxyCheckboxStyle.pushed;
						span[a].onmouseup = GalaxyCheckboxStyle.check;
					}else{
						span[a].ontouchstart = GalaxyCheckboxStyle.pushed;
						span[a].ontouchend = GalaxyCheckboxStyle.check;
					}
				} else {
					span[a].className = span[a].className += " disabled";
				}
			}
		}
		// verifico touch
		if(_DEBUG_MODE){
			document.onmouseup = GalaxyCheckboxStyle.clear;
		}else{
			document.ontouchend = GalaxyCheckboxStyle.clear;
		}
	},
	pushed: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "radio") {
			this.style.backgroundPosition = "0 -" + radioHeight + "px";
		}
	},
	check: function() {
		element = this.nextSibling;
		if(element.checked == true && element.type == "checkbox") {
			this.style.backgroundPosition = "0 0";
			element.checked = false;
		} else {
			if(element.type == "checkbox") {
				this.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else {
				this.style.backgroundPosition = "0 -" + radioHeight + "px";
				group = this.nextSibling.name;
				inputs = document.getElementsByTagName("input");
				for(a = 0; a < inputs.length; a++) {
					if(inputs[a].name == group && inputs[a] != this.nextSibling) {
						inputs[a].previousSibling.style.backgroundPosition = "0 0";
					}
				}
			}
			element.checked = true;
		}
	},
	clear: function() {
		inputs = document.getElementsByTagName("input");
		for(var b = 0; b < inputs.length; b++) {
			if(inputs[b].type == "checkbox" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + checkboxHeight + "px";
			} else if(inputs[b].type == "checkbox" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			} else if(inputs[b].type == "radio" && inputs[b].checked == true && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 -" + radioHeight + "px";
			} else if(inputs[b].type == "radio" && inputs[b].className == "galaxy_style") {
				inputs[b].previousSibling.style.backgroundPosition = "0 0";
			}
		}
	}
}

(function() {
  var iOSCheckbox;
  iOSCheckbox = (function() {
    function iOSCheckbox(elem, options) {
      var key, opts, value;
      this.elem = $(elem);
      opts = $.extend({}, iOSCheckbox.defaults, options);
      for (key in opts) {
        value = opts[key];
        this[key] = value;
      }
      this.wrapCheckboxWithDivs();
      this.attachEvents();
      this.disableTextSelection();
      if (this.resizeHandle) {
        this.optionallyResize('handle');
      }
      if (this.resizeContainer) {
        this.optionallyResize('container');
      }
      this.initialPosition();
    }
    iOSCheckbox.prototype.isDisabled = function() {
      return this.elem.is(':disabled');
    };
    iOSCheckbox.prototype.wrapCheckboxWithDivs = function() {
      this.elem.wrap("<div class='" + this.containerClass + "' />");
      this.container = this.elem.parent();
      this.offLabel = $("<label style=\"width:40px;\" class='" + this.labelOffClass + "'>\n  <span>" + this.uncheckedLabel + "</span>\n</label>").appendTo(this.container);
      this.offSpan = this.offLabel.children('span');
      this.onLabel = $("<label style=\"width: 40px;\" class='" + this.labelOnClass + "'>\n  <span>" + this.checkedLabel + "</span>\n</label>").appendTo(this.container);
      this.onSpan = this.onLabel.children('span');
      return this.handle = $("<div class='" + this.handleClass + "'>\n  <div class='" + this.handleRightClass + "'>\n    <div class='" + this.handleCenterClass + "' />\n  </div>\n</div>").appendTo(this.container);
    };
    iOSCheckbox.prototype.disableTextSelection = function() {
      if ($.browser.msie) {
        return $([this.handle, this.offLabel, this.onLabel, this.container]).attr("unselectable", "on");
      }
    };
    iOSCheckbox.prototype.optionallyResize = function(mode) {
      var newWidth, offLabelWidth, onLabelWidth;
      //onLabelWidth = this.onLabel.width();
      onLabelWidth = parseInt($(this.onLabel).css('width'));
      //offLabelWidth = this.offLabel.width();
      offLabelWidth = parseInt($(this.offLabel).css('width'));
      if (mode === "container") {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        //newWidth += this.handle.width() + this.handleMargin;
        newWidth += parseInt($(this.handle).css('width')) + this.handleMargin;
        return this.container.css({
          width: newWidth
        });
      } else {
        newWidth = onLabelWidth > offLabelWidth ? onLabelWidth : offLabelWidth;
        return this.handle.css({
          width: newWidth
        });
      }
    };
    iOSCheckbox.prototype.onMouseDown = function(event) {
      var x;
      event.preventDefault();
      if (this.isDisabled()) {
        return;
      }
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      iOSCheckbox.currentlyClicking = this.handle;
      iOSCheckbox.dragStartPosition = x;
      return iOSCheckbox.handleLeftOffset = parseInt(this.handle.css('left'), 10) || 0;
    };
    iOSCheckbox.prototype.onDragMove = function(event, x) {
      var newWidth, p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      p = (x + iOSCheckbox.handleLeftOffset - iOSCheckbox.dragStartPosition) / this.rightSide;
      if (p < 0) {
        p = 0;
      }
      if (p > 1) {
        p = 1;
      }
      newWidth = p * this.rightSide;
      this.handle.css({
        left: newWidth
      });
      this.onLabel.css({
        width: newWidth + this.handleRadius
      });
      this.offSpan.css({
        marginRight: -newWidth
      });
      return this.onSpan.css({
        marginLeft: -(1 - p) * this.rightSide
      });
    };
    iOSCheckbox.prototype.onDragEnd = function(event, x) {
      var p;
      if (iOSCheckbox.currentlyClicking !== this.handle) {
        return;
      }
      if (this.isDisabled()) {
        return;
      }
      if (iOSCheckbox.dragging) {
        p = (x - iOSCheckbox.dragStartPosition) / this.rightSide;
        this.elem.prop('checked', p >= 0.5);
      } else {
        this.elem.prop('checked', !this.elem.prop('checked'));
      }
      iOSCheckbox.currentlyClicking = null;
      iOSCheckbox.dragging = null;
      return this.elem.change();
    };
    iOSCheckbox.prototype.onChange = function() {
      var new_left;
      if (this.isDisabled()) {
        this.container.addClass(this.disabledClass);
        return false;
      } else {
        this.container.removeClass(this.disabledClass);
      }
      new_left = this.elem.prop('checked') ? this.rightSide : 0;
      this.handle.animate({
        left: new_left
      }, this.duration);
      this.onLabel.animate({
        width: new_left + this.handleRadius
      }, this.duration);
      this.offSpan.animate({
        marginRight: -new_left
      }, this.duration);
      return this.onSpan.animate({
        marginLeft: new_left - this.rightSide
      }, this.duration);
    };
    iOSCheckbox.prototype.attachEvents = function() {
      var localMouseMove, localMouseUp, self;
      self = this;
      localMouseMove = function(event) {
        return self.onGlobalMove.apply(self, arguments);
      };
      localMouseUp = function(event) {
        self.onGlobalUp.apply(self, arguments);
        $(document).unbind('mousemove touchmove', localMouseMove);
        return $(document).unbind('mouseup touchend', localMouseUp);
      };
      this.container.bind('mousedown touchstart', function(event) {
        self.onMouseDown.apply(self, arguments);
        $(document).bind('mousemove touchmove', localMouseMove);
        return $(document).bind('mouseup touchend', localMouseUp);
      });
      return this.elem.bind("change", function() {
        return self.onChange.apply(self, arguments);
      });
    };
    iOSCheckbox.prototype.initialPosition = function() {
      var offset;
      this.offLabel.css({
        //width: this.container.width() - this.containerRadius
        width: parseInt($(this.container).css('width')) - this.containerRadius
      });
      offset = this.containerRadius + 1;
      if ($.browser.msie && $.browser.version < 7) {
        offset -= 3;
      }
      //this.rightSide = this.container.width() - this.handle.width() - offset;
      this.rightSide = parseInt($(this.container).css('width')) - parseInt($(this.handle).css('width')) - offset;
      if (this.elem.is(':checked')) {
        this.handle.css({
          left: this.rightSide
        });
        this.onLabel.css({
          width: this.rightSide + this.handleRadius
        });
        this.offSpan.css({
          marginRight: -this.rightSide
        });
      } else {
        this.onLabel.css({
          width: 0
        });
        this.onSpan.css({
          marginLeft: -this.rightSide
        });
      }
      if (this.isDisabled()) {
        return this.container.addClass(this.disabledClass);
      }
    };
    iOSCheckbox.prototype.onGlobalMove = function(event) {
      var x;
      if (!(!this.isDisabled() && iOSCheckbox.currentlyClicking)) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      if (!iOSCheckbox.dragging && (Math.abs(iOSCheckbox.dragStartPosition - x) > this.dragThreshold)) {
        iOSCheckbox.dragging = true;
      }
      return this.onDragMove(event, x);
    };
    iOSCheckbox.prototype.onGlobalUp = function(event) {
      var x;
      if (!iOSCheckbox.currentlyClicking) {
        return;
      }
      event.preventDefault();
      x = event.pageX || event.originalEvent.changedTouches[0].pageX;
      return this.onDragEnd(event, x);
    };
    iOSCheckbox.defaults = {
      duration: 200,
      checkedLabel: 'ON',
      uncheckedLabel: 'OFF',
      resizeHandle: true,
      resizeContainer: true,
      disabledClass: 'iPhoneCheckDisabled',
      containerClass: 'iPhoneCheckContainer',
      labelOnClass: 'iPhoneCheckLabelOn',
      labelOffClass: 'iPhoneCheckLabelOff',
      handleClass: 'iPhoneCheckHandle',
      handleCenterClass: 'iPhoneCheckHandleCenter',
      handleRightClass: 'iPhoneCheckHandleRight',
      dragThreshold: 5,
      handleMargin: 15,
      handleRadius: 4,
      containerRadius: 5
    };
    return iOSCheckbox;
  })();
  $.iphoneStyle = this.iOSCheckbox = iOSCheckbox;
  $.fn.iphoneStyle = function(options) {
    var checkbox, _i, _len, _ref;
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iphoneStyle", new iOSCheckbox(checkbox, options));
    }
    return this;
  };
  $.fn.iOSCheckbox = function(options) {
    var checkbox, opts, _i, _len, _ref;
    if (options == null) {
      options = {};
    }
    opts = $.extend({}, options, {
      resizeHandle: false,
      disabledClass: 'iOSCheckDisabled',
      containerClass: 'iOSCheckContainer',
      labelOnClass: 'iOSCheckLabelOn',
      labelOffClass: 'iOSCheckLabelOff',
      handleClass: 'iOSCheckHandle',
      handleCenterClass: 'iOSCheckHandleCenter',
      handleRightClass: 'iOSCheckHandleRight'
    });
    _ref = this.filter(':checkbox');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      checkbox = _ref[_i];
      $(checkbox).data("iOSCheckbox", new iOSCheckbox(checkbox, opts));
    }
    return this;
  };
}).call(this);


(function(E,a){var j=a.document;function A(Q){var Z=j.createElement("div");j.body.insertBefore(Z,null);E.replaceWith(Z,'<script type="text/javascript">'+Q+"<\/script>")}E=E||(function(Q){return{ajax:Q.ajax,$:function(Z){return Q(Z)[0]},replaceWith:function(Z,ad){var ac=Q(Z)[0];var ab=ac.nextSibling,aa=ac.parentNode;Q(ac).remove();if(ab){Q(ab).before(ad)}else{Q(aa).append(ad)}},onLoad:function(Z){Q(Z)},copyAttrs:function(af,ab){var ad=Q(ab),aa=af.attributes;for(var ac=0,Z=aa.length;ac<Z;ac++){if(aa[ac]&&aa[ac].value){try{ad.attr(aa[ac].name,aa[ac].value)}catch(ae){}}}}}})(a.jQuery);E.copyAttrs=E.copyAttrs||function(){};E.onLoad=E.onLoad||function(){throw"error: autoAsync cannot be used without jQuery or defining writeCaptureSupport.onLoad"};function P(ab,aa){for(var Z=0,Q=ab.length;Z<Q;Z++){if(aa(ab[Z])===false){return}}}function v(Q){return Object.prototype.toString.call(Q)==="[object Function]"}function p(Q){return Object.prototype.toString.call(Q)==="[object String]"}function u(aa,Z,Q){return Array.prototype.slice.call(aa,Z||0,Q||aa&&aa.length)}function D(ab,aa){var Q=false;P(ab,Z);function Z(ac){return !(Q=aa(ac))}return Q}function L(Q){this._queue=[];this._children=[];this._parent=Q;if(Q){Q._addChild(this)}}L.prototype={_addChild:function(Q){this._children.push(Q)},push:function(Q){this._queue.push(Q);this._bubble("_doRun")},pause:function(){this._bubble("_doPause")},resume:function(){this._bubble("_doResume")},_bubble:function(Z){var Q=this;while(!Q[Z]){Q=Q._parent}return Q[Z]()},_next:function(){if(D(this._children,Q)){return true}function Q(aa){return aa._next()}var Z=this._queue.shift();if(Z){Z()}return !!Z}};function i(Q){if(Q){return new L(Q)}L.call(this);this.paused=0}i.prototype=(function(){function Q(){}Q.prototype=L.prototype;return new Q()})();i.prototype._doRun=function(){if(!this.running){this.running=true;try{while(this.paused<1&&this._next()){}}finally{this.running=false}}};i.prototype._doPause=function(){this.paused++};i.prototype._doResume=function(){this.paused--;this._doRun()};function M(){}M.prototype={_html:"",open:function(){this._opened=true;if(this._delegate){this._delegate.open()}},write:function(Q){if(this._closed){return}this._written=true;if(this._delegate){this._delegate.write(Q)}else{this._html+=Q}},writeln:function(Q){this.write(Q+"\n")},close:function(){this._closed=true;if(this._delegate){this._delegate.close()}},copyTo:function(Q){this._delegate=Q;Q.foobar=true;if(this._opened){Q.open()}if(this._written){Q.write(this._html)}if(this._closed){Q.close()}}};var e=(function(){var Q={f:j.getElementById};try{Q.f.call(j,"abc");return true}catch(Z){return false}})();function I(Q){P(Q,function(Z){var aa=j.getElementById(Z.id);if(!aa){l("<proxyGetElementById - finish>","no element in writen markup with id "+Z.id);return}P(Z.el.childNodes,function(ab){aa.appendChild(ab)});if(aa.contentWindow){a.setTimeout(function(){Z.el.contentWindow.document.copyTo(aa.contentWindow.document)},1)}E.copyAttrs(Z.el,aa)})}function s(Z,Q){if(Q&&Q[Z]===false){return false}return Q&&Q[Z]||o[Z]}function x(Z,ai){var ae=[],ad=s("proxyGetElementById",ai),ag=s("writeOnGetElementById",ai),Q={write:j.write,writeln:j.writeln,finish:function(){},out:""};Z.state=Q;j.write=ah;j.writeln=aa;if(ad||ag){Q.getEl=j.getElementById;j.getElementById=ab;if(ag){findEl=af}else{findEl=ac;Q.finish=function(){I(ae)}}}function ah(aj){Q.out+=aj}function aa(aj){Q.out+=aj+"\n"}function ac(ak){var aj=j.createElement("div");ae.push({id:ak,el:aj});aj.contentWindow={document:new M()};return aj}function af(al){var aj=E.$(Z.target);var ak=j.createElement("div");aj.parentNode.insertBefore(ak,aj);E.replaceWith(ak,Q.out);Q.out="";return e?Q.getEl.call(j,al):Q.getEl(al)}function ab(ak){var aj=e?Q.getEl.call(j,ak):Q.getEl(ak);return aj||findEl(ak)}return Q}function V(Q){j.write=Q.write;j.writeln=Q.writeln;if(Q.getEl){j.getElementById=Q.getEl}return Q.out}function N(Q){return Q&&Q.replace(/^\s*<!(\[CDATA\[|--)/,"").replace(/(\]\]|--)>\s*$/,"")}function b(){}function d(Z,Q){console.error("Error",Q,"executing code:",Z)}var l=v(a.console&&console.error)?d:b;function S(aa,Z,Q){var ab=x(Z,Q);try{A(N(aa))}catch(ac){l(aa,ac)}finally{V(ab)}return ab}function O(Z){var Q=/^(\w+:)?\/\/([^\/?#]+)/.exec(Z);return Q&&(Q[1]&&Q[1]!=location.protocol||Q[2]!=location.host)}function T(Q){return new RegExp(Q+"=(?:([\"'])([\\s\\S]*?)\\1|([^\\s>]+))","i")}function k(Q){var Z=T(Q);return function(aa){var ab=Z.exec(aa)||[];return ab[2]||ab[3]}}var r=/(<script[\s\S]*?>)([\s\S]*?)<\/script>/ig,n=T("src"),X=k("src"),q=k("type"),Y=k("language"),C="__document_write_ajax_callbacks__",B="__document_write_ajax_div-",g="window['"+C+"']['%d']();",m=a[C]={},w='<script type="text/javascript">'+g+"<\/script>",H=0;function c(){return(++H).toString()}function G(Z,aa){var Q;if(v(Z)){Q=Z;Z=null}Z=Z||{};Q=Q||Z&&Z.done;Z.done=aa?function(){aa(Q)}:Q;return Z}var z=new i();var y=[];var f=window._debugWriteCapture?function(){}:function(Q,aa,Z){y.push({type:Q,src:aa,data:Z})};var K=window._debugWriteCapture?function(){}:function(){y.push(arguments)};function W(Q){var Z=c();m[Z]=function(){Q();delete m[Z]};return Z}function J(Q){return w.replace(/%d/,W(Q))}function R(ac,ag,aa,ae){var ad=aa&&new i(aa)||z;ag=G(ag);var ab=s("done",ag);var Q="";var Z=s("fixUrls",ag);if(!v(Z)){Z=function(ah){return ah}}if(v(ab)){Q=J(function(){ad.push(ab)})}return ac.replace(r,af)+Q;function af(aj,av,ai){var an=X(av),am=q(av)||"",aB=Y(av)||"",aA=(!am&&!aB)||am.toLowerCase().indexOf("javascript")!==-1||aB.toLowerCase().indexOf("javascript")!==-1;f("replace",an,aj);if(!aA){return aj}var aw=W(ap),ao=B+aw,au,al={target:"#"+ao,parent:ae};function ap(){ad.push(au)}if(an){an=Z(an);av=av.replace(n,"");if(O(an)){au=az}else{if(s("asyncAll",ag)){au=ay()}else{au=at}}}else{au=ax}function ax(){ah(ai)}function at(){E.ajax({url:an,type:"GET",dataType:"text",async:false,success:function(aC){ah(aC)}})}function ak(aE,aC,aD){l("<XHR for "+an+">",aD);ad.resume()}function aq(){return J(function(){ad.resume()})}function ay(){var aE,aD;function aC(aG,aF){if(!aE){aD=aG;return}try{ah(aG,aq())}catch(aH){l(aG,aH)}}E.ajax({url:an,type:"GET",dataType:"text",async:true,success:aC,error:ak});return function(){aE=true;if(aD){ah(aD)}else{ad.pause()}}}function az(aC){var aE=x(al,ag);ad.pause();f("pause",an);E.ajax({url:an,type:"GET",dataType:"script",success:aD,error:ak});function aD(aH,aG,aF){f("out",an,aE.out);ar(V(aE),J(aE.finish)+aq());f("resume",an)}}function ah(aD,aC){var aE=S(aD,al,ag);aC=J(aE.finish)+(aC||"");ar(aE.out,aC)}function ar(aD,aC){E.replaceWith(al.target,R(aD,null,ad,al)+(aC||""))}return'<div style="display: none" id="'+ao+'"></div>'+av+g.replace(/%d/,aw)+"<\/script>"}}function F(Z,aa){var Q=z;P(Z,function(ab){Q.push(ac);function ac(){ab.action(R(ab.html,ab.options,Q),ab)}});if(aa){Q.push(aa)}}function U(Q){var Z=Q;while(Z&&Z.nodeType===1){Q=Z;Z=Z.lastChild;while(Z&&Z.nodeType!==1){Z=Z.previousSibling}}return Q}function h(Q){var aa=j.write,ad=j.writeln,Z,ab=[];j.writeln=function(ae){j.write(ae+"\n")};var ac;j.write=function(af){var ae=U(j.body);if(ae!==Z){Z=ae;ab.push(ac={el:ae,out:[]})}ac.out.push(af)};E.onLoad(function(){var ah,ak,af,aj,ai;Q=G(Q);ai=Q.done;Q.done=function(){j.write=aa;j.writeln=ad;if(ai){ai()}};for(var ag=0,ae=ab.length;ag<ae;ag++){ah=ab[ag].el;ak=j.createElement("div");ah.parentNode.insertBefore(ak,ah.nextSibling);af=ab[ag].out.join("");aj=ae-ag===1?R(af,Q):R(af);E.replaceWith(ak,aj)}})}var t="writeCapture";var o=a[t]={_original:a[t],fixUrls:function(Q){return Q.replace(/&amp;/g,"&")},noConflict:function(){a[t]=this._original;return this},debug:y,proxyGetElementById:false,_forTest:{Q:i,GLOBAL_Q:z,$:E,matchAttr:k,slice:u,capture:x,uncapture:V,captureWrite:S},replaceWith:function(Q,aa,Z){E.replaceWith(Q,R(aa,Z))},html:function(Q,ab,Z){var aa=E.$(Q);aa.innerHTML="<span/>";E.replaceWith(aa.firstChild,R(ab,Z))},load:function(Q,aa,Z){E.ajax({url:aa,dataType:"text",type:"GET",success:function(ab){o.html(Q,ab,Z)}})},autoAsync:h,sanitize:R,sanitizeSerial:F}})(this.writeCaptureSupport,this);(function(g,d,n){var c={html:h};g.each(["append","prepend","after","before","wrap","wrapAll","replaceWith","wrapInner"],function(){c[this]=i(this)});function a(q){return Object.prototype.toString.call(q)=="[object String]"}function p(u,t,s,r){if(arguments.length==0){return o.call(this)}var q=c[u];if(u=="load"){return l.call(this,t,s,r)}if(!q){j(u)}return b.call(this,t,s,q)}g.fn.writeCapture=p;var k="__writeCaptureJsProxied-fghebd__";function o(){if(this[k]){return this}var r=this;function q(){var t=this,s=false;this[k]=true;g.each(c,function(v){var u=r[v];if(!u){return}t[v]=function(y,x,w){if(!s&&a(y)){try{s=true;return p.call(t,v,y,x,w)}finally{s=false}}return u.apply(t,arguments)}});this.pushStack=function(){return o.call(r.pushStack.apply(t,arguments))};this.endCapture=function(){return r}}q.prototype=r;return new q()}function b(t,s,u){var q,r=this;if(s&&s.done){q=s.done;delete s.done}else{if(g.isFunction(s)){q=s;s=null}}d.sanitizeSerial(g.map(this,function(v){return{html:t,options:s,action:function(w){u.call(v,w)}}}),q&&function(){q.call(r)}||q);return this}function h(q){g(this).html(q)}function i(q){return function(r){g(this)[q](r)}}function l(t,s,v){var r=this,q,u=t.indexOf(" ");if(u>=0){q=t.slice(u,t.length);t=t.slice(0,u)}if(g.isFunction(v)){s=s||{};s.done=v}return g.ajax({url:t,type:s&&s.type||"GET",dataType:"html",data:s&&s.params,complete:f(r,s,q)})}function f(r,s,q){return function(u,t){if(t=="success"||t=="notmodified"){var v=m(u.responseText,q);b.call(r,v,s,h)}}}var e=/jquery-writeCapture-script-placeholder-(\d+)-wc/g;function m(s,r){if(!r||!s){return s}var t=0,q={};return g("<div/>").append(s.replace(/<script(.|\s)*?\/script>/g,function(u){q[t]=u;return"jquery-writeCapture-script-placeholder-"+(t++)+"-wc"})).find(r).html().replace(e,function(u,v){return q[v]})}function j(q){throw"invalid method parameter "+q}g.writeCapture=d})(jQuery,writeCapture.noConflict());

(function(b){function s(B,h,y){var z=this,D=y,A,C,m,x=false;this.settings=D;this.values=null;this.val=null;this.temp=null;this.setDefaults=function(E){b.extend(f,E)};this.enable=function(){D.disabled=false;if(b(B).is(":input")){b(B).prop("disabled",false)}};this.disable=function(){D.disabled=true;if(b(B).is(":input")){b(B).prop("disabled",true)}};this.formatDate=function(N,F,G){if(!F){return null}var O=b.extend({},this.settings,G),L=function(P){var Q=0;while(J+1<N.length&&N.charAt(J+1)==P){Q++;J++}return Q},I=function(Q,R,P){var S=""+R;if(L(Q)){while(S.length<P){S="0"+S}}return S},H=function(P,S,R,Q){return(L(P)?Q[S]:R[S])},E="",M=false;for(var J=0;J<N.length;J++){if(M){if(N.charAt(J)=="'"&&!L("'")){M=false}else{E+=N.charAt(J)}}else{switch(N.charAt(J)){case"d":E+=I("d",F.getDate(),2);break;case"D":E+=H("D",F.getDay(),O.dayNamesShort,O.dayNames);break;case"o":E+=I("o",(F.getTime()-new Date(F.getFullYear(),0,0).getTime())/86400000,3);break;case"m":E+=I("m",F.getMonth()+1,2);break;case"M":E+=H("M",F.getMonth(),O.monthNamesShort,O.monthNames);break;case"y":E+=(L("y")?F.getFullYear():(F.getYear()%100<10?"0":"")+F.getYear()%100);break;case"h":var K=F.getHours();E+=I("h",(K>12?(K-12):(K==0?12:K)),2);break;case"H":E+=I("H",F.getHours(),2);break;case"i":E+=I("i",F.getMinutes(),2);break;case"s":E+=I("s",F.getSeconds(),2);break;case"a":E+=F.getHours()>11?"pm":"am";break;case"A":E+=F.getHours()>11?"PM":"AM";break;case"'":if(L("'")){E+="'"}else{M=true}break;default:E+=N.charAt(J)}}}return E};this.parseDate=function(U,N,W){var I=new Date();if(!U||!N){return I}N=(typeof N=="object"?N.toString():N+"");var K=b.extend({},this.settings,W),F=I.getFullYear(),Y=I.getMonth(),S=I.getDate(),H=-1,V=I.getHours(),O=I.getMinutes(),G=I.getSeconds(),L=0,R=false,M=function(aa){var ab=(E+1<U.length&&U.charAt(E+1)==aa);if(ab){E++}return ab},Z=function(ab){M(ab);var ac=(ab=="@"?14:(ab=="!"?20:(ab=="y"?4:(ab=="o"?3:2))));var ad=new RegExp("^\\d{1,"+ac+"}");var aa=N.substr(T).match(ad);if(!aa){throw"Missing number at position "+T}T+=aa[0].length;return parseInt(aa[0],10)},J=function(ab,ad,aa){var ae=(M(ab)?aa:ad);for(var ac=0;ac<ae.length;ac++){if(N.substr(T,ae[ac].length).toLowerCase()==ae[ac].toLowerCase()){T+=ae[ac].length;return ac+1}}throw"Unknown name at position "+T},Q=function(){if(N.charAt(T)!=U.charAt(E)){throw"Unexpected literal at position "+T}T++},T=0;for(var E=0;E<U.length;E++){if(R){if(U.charAt(E)=="'"&&!M("'")){R=false}else{Q()}}else{switch(U.charAt(E)){case"d":S=Z("d");break;case"D":J("D",K.dayNamesShort,K.dayNames);break;case"o":H=Z("o");break;case"m":Y=Z("m");break;case"M":Y=J("M",K.monthNamesShort,K.monthNames);break;case"y":F=Z("y");break;case"H":V=Z("H");break;case"h":V=Z("h");break;case"i":O=Z("i");break;case"s":G=Z("s");break;case"a":L=J("a",["am","pm"],["am","pm"])-1;break;case"A":L=J("A",["am","pm"],["am","pm"])-1;break;case"'":if(M("'")){Q()}else{R=true}break;default:Q()}}}if(F<100){F+=new Date().getFullYear()-new Date().getFullYear()%100+(F<=K.shortYearCutoff?0:-100)}if(H>-1){Y=1;S=H;do{var P=32-new Date(F,Y-1,32).getDate();if(S<=P){break}Y++;S-=P}while(true)}if(L&&V<12){V+=12}var X=new Date(F,Y-1,S,V,O,G);if(X.getFullYear()!=F||X.getMonth()+1!=Y||X.getDate()!=S){throw"Invalid date"}return X};this.setValue=function(F){if(F==undefined){F=true}var E=this.formatResult();this.val=E;this.values=this.temp.slice(0);if(F&&b(B).is(":input")){b(B).val(E).change()}};this.getDate=function(){var F=this.values;if(D.preset=="date"){return new Date(F[A],F[C],F[m])}if(D.preset=="time"){var E=(D.ampm&&F[D.seconds?3:2]=="PM"&&(F[0]-0)<12)?(F[0]-0+12):F[0];return new Date(1970,0,1,E,F[1],D.seconds?F[2]:null)}if(D.preset=="datetime"){var E=(D.ampm&&F[D.seconds?6:5]=="PM"&&(F[3]-0)<12)?(F[3]-0+12):F[3];return new Date(F[A],F[C],F[m],E,F[4],D.seconds?F[5]:null)}};this.setDate=function(G,F){if(D.preset.match(/date/i)){this.temp[A]=G.getFullYear();this.temp[C]=G.getMonth();this.temp[m]=G.getDate()}if(D.preset=="time"){var E=G.getHours();this.temp[0]=(D.ampm)?(E>12?(E-12):(E==0?12:E)):E;this.temp[1]=G.getMinutes();if(D.seconds){this.temp[2]=G.getSeconds()}if(D.ampm){this.temp[D.seconds?3:2]=E>11?"PM":"AM"}}if(D.preset=="datetime"){var E=G.getHours();this.temp[3]=(D.ampm)?(E>12?(E-12):(E==0?12:E)):E;this.temp[4]=G.getMinutes();if(D.seconds){this.temp[5]=G.getSeconds()}if(D.ampm){this.temp[D.seconds?6:5]=E>11?"PM":"AM"}}this.setValue(F)};this.parseValue=function(I){if(this.preset){var E=[];if(D.preset=="date"){try{var H=this.parseDate(D.dateFormat,I,D)}catch(G){var H=new Date()}E[A]=H.getFullYear();E[C]=H.getMonth();E[m]=H.getDate()}else{if(D.preset=="time"){try{var H=this.parseDate(D.timeFormat,I,D)}catch(G){var H=new Date()}var F=H.getHours();E[0]=(D.ampm)?(F>12?(F-12):(F==0?12:F)):F;E[1]=H.getMinutes();if(D.seconds){E[2]=H.getSeconds()}if(D.ampm){E[D.seconds?3:2]=F>11?"PM":"AM"}}else{if(D.preset=="datetime"){try{var H=this.parseDate(D.dateFormat+" "+D.timeFormat,I,D)}catch(G){var H=new Date()}var F=H.getHours();E[A]=H.getFullYear();E[C]=H.getMonth();E[m]=H.getDate();E[3]=(D.ampm)?(F>12?(F-12):(F==0?12:F)):F;E[4]=H.getMinutes();if(D.seconds){E[5]=H.getSeconds()}if(D.ampm){E[D.seconds?6:5]=F>11?"PM":"AM"}}}}return E}return D.parseValue(I)};this.formatResult=function(){var F=this.temp;if(this.preset){if(D.preset=="date"){return this.formatDate(D.dateFormat,new Date(F[A],F[C],F[m]),D)}else{if(D.preset=="datetime"){var E=(D.ampm)?((F[D.seconds?6:5]=="PM"&&(F[3]-0)<12)?(F[3]-0+12):(F[D.seconds?6:5]=="AM"&&(F[3]==12)?0:F[3])):F[3];return this.formatDate(D.dateFormat+" "+D.timeFormat,new Date(F[A],F[C],F[m],E,F[4],D.seconds?F[5]:null),D)}else{if(D.preset=="time"){var E=(D.ampm)?((F[D.seconds?3:2]=="PM"&&(F[0]-0)<12)?(F[0]-0+12):(F[D.seconds?3:2]=="AM"&&(F[0]==12)?0:F[0])):F[0];return this.formatDate(D.timeFormat,new Date(1970,0,1,E,F[1],D.seconds?F[2]:null),D)}}}}return D.formatResult(F)};this.validate=function(F){if(this.preset&&D.preset.match(/date/i)&&((F==A)||(F==C)||(F==-1))){var G=32-new Date(this.temp[A],this.temp[C],32).getDate()-1;var E=b("ul:eq("+m+")",h);b("li",E).show();b("li:gt("+G+")",E).hide();if(this.temp[m]>G){E.addClass("dwa").css("top",(r*(n-G-1))+"px");this.temp[m]=b("li:eq("+G+")",E).data("val")}}else{D.validate(F)}};this.hide=function(){if(D.onClose(this.val,this)===false){return false}b(".dwtd").prop("disabled",false).removeClass("dwtd");b(B).blur();h.hide();i.hide();x=false;if(this.preset){D.wheels=null}b(window).unbind("resize.dw")};this.show=function(){if(D.disabled||x){return false}D.beforeShow(B,this);r=D.height;n=Math.round(D.rows/2);a=this;this.init();if(this.preset){D.wheels=new Array();if(D.preset.match(/date/i)){var E={};for(var G=0;G<3;G++){if(G==A){E[D.yearText]={};for(var J=D.startYear;J<=D.endYear;J++){E[D.yearText][J]=D.dateOrder.search(/yy/i)<0?J.toString().substr(2,2):J.toString()}}else{if(G==C){E[D.monthText]={};for(var J=0;J<12;J++){E[D.monthText][J]=(D.dateOrder.search(/MM/)<0?(D.dateOrder.search(/M/)<0?(D.dateOrder.search(/mm/)<0?(J+1):(J<9)?("0"+(J+1)):(J+1)):D.monthNamesShort[J]):D.monthNames[J])}}else{if(G==m){E[D.dayText]={};for(var J=1;J<32;J++){E[D.dayText][J]=D.dateOrder.search(/dd/i)<0?J:(J<10)?("0"+J):J}}}}}D.wheels.push(E)}if(D.preset.match(/time/i)){D.stepHour=(D.stepHour<1)?1:parseInt(D.stepHour);D.stepMinute=(D.stepMinute<1)?1:parseInt(D.stepMinute);D.stepSecond=(D.stepSecond<1)?1:parseInt(D.stepSecond);var E={};E[D.hourText]={};for(var J=0;J<(D.ampm?13:24);J+=D.stepHour){E[D.hourText][J]=(J<10)?("0"+J):J}E[D.minuteText]={};for(var J=0;J<60;J+=D.stepMinute){E[D.minuteText][J]=(J<10)?("0"+J):J}if(D.seconds){E[D.secText]={};for(var J=0;J<60;J+=D.stepSecond){E[D.secText][J]=(J<10)?("0"+J):J}}if(D.ampm){E[D.ampmText]={};E[D.ampmText]["AM"]="AM";E[D.ampmText]["PM"]="PM"}D.wheels.push(E)}}b(".dwc",h).remove();for(var J=0;J<D.wheels.length;J++){var F=b('<div class="dwc'+(D.mode=="clickpick"?" dwpm":"")+'"><div class="dwwc dwrc"><div class="clear" style="clear:both;"></div></div>').insertBefore(b(".dwbc",h));for(var I in D.wheels[J]){var K=b(".dwwc .clear",F);var E=b('<div class="dwwl dwrc">'+(D.mode=="clickpick"?'<div class="dwwb dwwbp">+</div><div class="dwwb dwwbm">&ndash;</div>':"")+'<div class="dwl">'+I+'</div><div class="dww dwrc"><ul></ul><div class="dwwo"></div></div><div class="dwwol"></div></div>').insertBefore(K);for(var H in D.wheels[J][I]){b('<li class="val_'+H+'">'+D.wheels[J][I][H]+"</li>").data("val",H).appendTo(b("ul",E))}}}b(".dww ul",h).each(function(M){var L=b("li",this).index(b("li.val_"+z.temp[M],this));while((L<0)&&(--z.temp[M]>=0)){L=b("li",this).index(b("li.val_"+z.temp[M],this))}var N=r*(n-(L<0?0:L)-1);b(this).css("top",N)});b(".dwv",h).html(this.formatResult());z.validate(-1);b("#dw_set",h).text(D.setText).unbind().bind("click",function(L){z.setValue();D.onSelect(z.val,a);z.hide();return false});b("#dw_cancel",h).text(D.cancelText).unbind().bind("click",function(L){D.onCancel(z.val,a);z.hide();return false});b(":input:not(:disabled)").addClass("dwtd");b(":input").prop("disabled",true);i.show();h.attr("class","dw "+D.theme).show();x=true;b(".dww, .dwwl",h).height(D.rows*r);b(".dww",h).each(function(){b(this).width(b(this).parent().width()<D.width?D.width:b(this).parent().width())});b(".dwbc a",h).attr("class",D.btnClass);b(".dww li, .dwwb",h).css({height:r,lineHeight:r+"px"});b(".dwwc",h).each(function(){var L=0;b(".dwwl",this).each(function(){L+=b(this).outerWidth(true)});b(this).width(L)});b(".dwc",h).each(function(){b(this).width(b(".dwwc",this).outerWidth(true))});this.pos();b(window).bind("resize.dw",function(){z.pos()})};this.pos=function(){var E=0,H=0,K=b(window).width(),G=b(window).height(),I=b(window).scrollTop(),F,J;b(".dwc",h).each(function(){F=b(this).outerWidth(true);E+=F;H=(F>H)?F:H});F=E>K?H:E;h.width(F);F=h.outerWidth();J=h.outerHeight();h.css({left:(K-F)/2,top:I+(G-J)/2});i.height(0);i.height(b(document).height())};this.init=function(){var E=D.dateOrder.search(/y/i),F=D.dateOrder.search(/m/i),G=D.dateOrder.search(/d/i);A=(E<F)?(E<G?0:1):(E<G?1:2);C=(F<E)?(F<G?0:1):(F<G?1:2);m=(G<E)?(G<F?0:1):(G<F?1:2);this.preset=(D.wheels===null);this.temp=this.parseValue(b(B).val()?b(B).val():"");this.setValue(false)};this.init();if(b(B).is(":input")&&D.showOnFocus){b(B).data("dwro",b(B).prop("readonly")).prop("readonly",true)}b(B).addClass("scroller").unbind("focus.dw").bind("focus.dw",function(E){if(D.showOnFocus){z.show()}})}var j,i,r,n,a,g={},v=new Date(),q=v.getTime(),l=false,w=null,c,o,d,e=("ontouchstart" in window),p=e?"touchstart":"mousedown",u=e?"touchmove":"mousemove",k=e?"touchend":"mouseup",f={width:90,height:40,rows:3,disabled:false,showOnFocus:true,wheels:null,theme:"",mode:"scroller",preset:"date",dateFormat:"mm/dd/yy",dateOrder:"mmddy",ampm:true,seconds:false,timeFormat:"hh:ii A",startYear:v.getFullYear()-10,endYear:v.getFullYear()+10,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortYearCutoff:"+10",monthText:"Month",dayText:"Day",yearText:"Year",hourText:"Hours",minuteText:"Minutes",secText:"Seconds",ampmText:"&nbsp;",setText:"Set",cancelText:"Cancel",btnClass:"dwb",stepHour:1,stepMinute:1,stepSecond:1,beforeShow:function(){},onClose:function(){},onSelect:function(){},onCancel:function(){},formatResult:function(x){var h="";for(var m=0;m<x.length;m++){h+=(m>0?" ":"")+x[m]}return h},parseValue:function(h){return h.split(" ")},validate:function(){return true}},t={init:function(y){if(y===undefined){y={}}var h={};if(y.theme=="ios"){h.dateOrder="MMdyy";h.rows=5;h.height=30;h.width=55}if(y.mode=="clickpick"){h.height=50;h.rows=3}var z=b.extend({},f,h,y),B=false,m=false;if(b(".dw").length){i=b(".dwo");j=b(".dw")}else{i=b('<div class="dwo"></div>').hide().appendTo("body");j=b('<div class="dw"><div class="dwv">&nbsp;</div><div class="dwbc" style="clear:both;"><span class="dwbw dwb-s"><a id="dw_set" href="#"></a></span><span class="dwbw dwb-c"><a id="dw_cancel" href="#"></a></span></div></div>');j.hide().appendTo("body");b(document).bind(u,function(D){if(l){o=e?D.originalEvent.changedTouches[0].pageY:D.pageY;w.removeClass("dwa").css("top",(d+o-c)+"px");D.preventDefault();D.stopPropagation();return false}});function x(F,G){var E=b("ul",j).index(F),D=b("li:visible",F).length;G=G>(n-1)?(n-1):G;G=G<(n-D)?(n-D):G;F.addClass("dwa").css("top",G*r);a.temp[E]=b("li:eq("+(n-1-G)+")",F).data("val");a.validate(E);b(".dwv",j).html(a.formatResult())}function C(D){if(B){var E=D.css("top").replace(/px/i,"")-0,F=(E-r)/r;F=F<(n-b("li:visible",D).length)?(n-1):F;x(D,F)}else{clearInterval(B)}}function A(D){if(m){var E=D.css("top").replace(/px/i,"")-0,F=(E+r)/r;F=F>(n-1)?(n-b("li:visible",D).length):F;x(D,F)}else{clearInterval(m)}}b(document).bind(k,function(D){if(l){var E=Math.round((d+o-c)/r);x(w,E);l=false;w=null;D.preventDefault();D.stopPropagation()}clearInterval(B);clearInterval(m);B=false;m=false;b(".dwb-a").removeClass("dwb-a")});j.delegate(".dwwl","DOMMouseScroll mousewheel",function(F){var H=F.wheelDelta?(F.wheelDelta/120):(F.detail?(-F.detail/3):0),D=b("ul",this),E=D.css("top").replace(/px/i,"")-0,G=Math.round((E+H*r)/r);x(D,G);F.preventDefault();F.stopPropagation()}).delegate(".dwb, .dwwb",p,function(D){b(this).addClass("dwb-a")}).delegate(".dwwbp",p,function(E){E.preventDefault();var D=b(this).closest(".dwwl").find("ul");clearInterval(B);B=setInterval(function(){C(D)},200);C(D)}).delegate(".dwwbm",p,function(E){E.preventDefault();var D=b(this).closest(".dwwl").find("ul");clearInterval(m);m=setInterval(function(){A(D)},200);A(D)}).delegate(".dwwl",p,function(F){if(!l&&a.settings.mode=="scroller"){var E=e?F.originalEvent.changedTouches[0].pageX:F.pageX,D=b(this).offset().left;l=true;w=b("ul",this);d=w.css("top").replace(/px/i,"")-0;c=e?F.originalEvent.changedTouches[0].pageY:F.pageY;o=c;F.preventDefault();F.stopPropagation()}})}return this.each(function(){if(!this.id){q+=1;this.id="scoller"+q}g[this.id]=new s(this,j,z)})},enable:function(){return this.each(function(){if(g[this.id]){g[this.id].enable()}})},disable:function(){return this.each(function(){if(g[this.id]){g[this.id].disable()}})},isDisabled:function(){if(g[this[0].id]){return g[this[0].id].settings.disabled}},option:function(h,m){return this.each(function(){if(g[this.id]){if(typeof h==="object"){b.extend(g[this.id].settings,h)}else{g[this.id].settings[h]=m}g[this.id].init()}})},setValue:function(m,h){if(h==undefined){h=false}return this.each(function(){if(g[this.id]){g[this.id].temp=m;g[this.id].setValue(m,h)}})},getValue:function(){if(g[this[0].id]){return g[this[0].id].values}},setDate:function(m,h){if(h==undefined){h=false}return this.each(function(){if(g[this.id]){g[this.id].setDate(m,h)}})},getDate:function(){if(g[this[0].id]){return g[this[0].id].getDate()}},show:function(){if(g[this[0].id]){return g[this[0].id].show()}},hide:function(){return this.each(function(){if(g[this.id]){g[this.id].hide()}})},destroy:function(){return this.each(function(){if(g[this.id]){b(this).unbind("focus.dw").removeClass("scroller");if(b(this).is(":input")){b(this).prop("readonly",b(this).data("dwro"))}delete g[this.id]}})}};b.fn.scroller=function(h){if(t[h]){return t[h].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof h==="object"||!h){return t.init.apply(this,arguments)}else{b.error("Unknown method")}}};b.scroller=new s(null,null,f)})(jQuery);





		function onbodyload(){
			var cities = [
				{id:3, value:"London"},
				{id:1, value:"Stockholm"},
				{id:4, value:"Berlin"},
				{id:2, value:"Moscow"}
			];
			
			dhx.ui({
				view:"popup",
				id:"cities",
				body:{
					view:"list", 
					template: "<div>#value#</div>",
					data:cities,
					type:{
						width:160
					},
					yCount:3
				}
			}).hide();
			/*
			dhx.ui({
				cols:[
				
				{
					rows:[
					
					{ 	view:"toolbar", type:"MainBar",  elements:[{ view:"richselect", name: "from", id:'myrich', label: 'From', value: 1, popup:"cities" }]}
				
				]}
				]
			});
			*/
			dhx.ui({ view:"richselect",id: "myRichselect", container:'jack', options:[
			                                    					{ value:1, label:"One"   }, 
			                                    					{ value:2, label:"Two"   }, 
			                                    					{ value:3, label:"Three" }]
			                                    });
			try{
				
				var item = $$('myRichselect');
				alert('item '+item);
				
				$('#jack').append($('.dhx_view dhx_el_richselect').html());
				
				alert($('.dhx_view dhx_el_richselect').css());
				alert($('#jack').html());
			}catch(exc){
				alert(exc.message);
			}
		}
		












	var dhtmlx_listProductsSelect = null;
	function onbodyload12() {
		var cities = [ {
			id : 3,
			value : "London"
		}, {
			id : 1,
			value : "Stockholm"
		}, {
			id : 4,
			value : "Berlin"
		}, {
			id : 2,
			value : "Moscow"
		} ];

		dhx.ui({
			view : "popup",
			id : "cities",
			body : {
				view : "list",
				template : "<div>#value#</div>",
				data : cities,
				type : {
					width : 160
				},
				yCount : 4
			}
		}).hide();

		dhtmlx_listProductsSelect = [ {
			value : 1,
			label : "Nessun prodotto principale"
		}, {
			value : 2,
			label : "Two"
		}, {
			value : 3,
			label : "Thre2e"
		} ];
		dhx.ui({
			view : "richselect",
			id : "myRichselect",
			container : 'impostazioni_body_vista_container_generali_info',
			label : '',
			value : "1",
			iconCss : 'dhx_list_icon2',
			width : '36',
			options : dhtmlx_listProductsSelect
		});
		$('.dhx_inp_list').css('width', '90%');

		//listProductsSelect = [ ;
		var arr1 = [ {
			value : 1,
			label : "Nessun prodotto principale"
		} ];
		//alert('_EDICOLA_PRODUCTS_DETAILS: ' + _EDICOLA_PRODUCTS_DETAILS);
		for ( var key in _EDICOLA_PRODUCTS_DETAILS) {
			if (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {

				//listProductsSelect += { value:parseInt(_EDICOLA_PRODUCTS_DETAILS[key].productId+1), label:"Nessun prodotto principale"+_EDICOLA_PRODUCTS_DETAILS[key].productId},
				console.log(_EDICOLA_PRODUCTS_DETAILS[key].productId + 1);
				console.log(_EDICOLA_PRODUCTS_DETAILS[key].name);
				var obj = {
					value : _EDICOLA_PRODUCTS_DETAILS[key].productId + 1,
					label : _EDICOLA_PRODUCTS_DETAILS[key].name
				};
				arr1.push(obj);

			}

		}
		dhtmlx_listProductsSelect = arr1;
		$$('myRichselect').refresh();
	}


/**
 * @author ABertacco
 */
function ab_number_format(number, decimals, dec_point, thousands_sep) {

	var n = number, prec = decimals;

	var toFixedFix = function(n, prec) {
		var k = Math.pow(10, prec);
		return (Math.round(n * k) / k).toString();
	};

	n = !isFinite(+n) ? 0 : +n;
	prec = !isFinite(+prec) ? 0 : Math.abs(prec);
	var sep = ( typeof thousands_sep === 'undefined') ? ',' : thousands_sep;
	var dec = ( typeof dec_point === 'undefined') ? '.' : dec_point;

	var s = (prec > 0) ? toFixedFix(n, prec) : toFixedFix(Math.round(n), prec);
	// fix
	// for
	// IE
	// parseFloat(0.55).toFixed(0)
	// = 0;
	var abs = toFixedFix(Math.abs(n), prec);
	var _, i;

	if (abs >= 1000) {
		_ = abs.split(/\D/);
		i = _[0].length % 3 || 3;

		_[0] = s.slice(0, i + (n < 0)) + _[0].slice(i).replace(/(\d{3})/g, sep + '$1');
		s = _.join(dec);
	} else {
		s = s.replace('.', dec);
	}

	var decPos = s.indexOf(dec);
	if (prec >= 1 && decPos !== -1 && (s.length - decPos - 1) < prec) {
		s += new Array(prec - (s.length - decPos - 1)).join(0) + '0';
	} else if (prec >= 1 && decPos === -1) {
		s += dec + new Array(prec).join(0) + '0';
	}
	return s;
}

function ab_euro_formatter(number) {
	return ab_number_format(number, 2, ',', '.') + " &euro;";
}

var dateFormat = function() {
	var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g, timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g, timezoneClip = /[^-+\dA-Z]/g, pad = function(val, len) {
		val = String(val);
		len = len || 2;
		while (val.length < len)
		val = "0" + val;
		return val;
	};

	// Regexes and supporting functions are cached through closure
	return function(date, mask, utc) {
		var dF = dateFormat;

		// You can't provide utc if you skip other args (use the "UTC:" mask
		// prefix)
		if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
			mask = date;
			date = undefined;
		}

		// Passing date through Date applies Date.parse, if necessary
		date = date ? new Date(date) : new Date;
		if (isNaN(date))
			throw SyntaxError("invalid date");

		mask = String(dF.masks[mask] || mask || dF.masks["default"]);

		// Allow setting the utc argument via the mask
		if (mask.slice(0, 4) == "UTC:") {
			mask = mask.slice(4);
			utc = true;
		}

		var _ = utc ? "getUTC" : "get", d = date[_ + "Date"](), D = date[_ + "Day"](), m = date[_ + "Month"](), y = date[_ + "FullYear"](), H = date[_ + "Hours"](), M = date[_ + "Minutes"](), s = date[_ + "Seconds"](), L = date[_ + "Milliseconds"](), o = utc ? 0 : date.getTimezoneOffset(), flags = {
			d : d,
			dd : pad(d),
			ddd : dF.i18n.dayNames[D],
			dddd : dF.i18n.dayNames[D + 7],
			m : m + 1,
			mm : pad(m + 1),
			mmm : dF.i18n.monthNames[m],
			mmmm : dF.i18n.monthNames[m + 12],
			yy : String(y).slice(2),
			yyyy : y,
			h : H % 12 || 12,
			hh : pad(H % 12 || 12),
			H : H,
			HH : pad(H),
			M : M,
			MM : pad(M),
			s : s,
			ss : pad(s),
			l : pad(L, 3),
			L : pad(L > 99 ? Math.round(L / 10) : L),
			t : H < 12 ? "a" : "p",
			tt : H < 12 ? "am" : "pm",
			T : H < 12 ? "A" : "P",
			TT : H < 12 ? "AM" : "PM",
			Z : utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
			o : (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
			S : [ "th", "st", "nd", "rd" ][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
		};

		return mask.replace(token, function($0) {
			return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
		});
	};
}();

// Some common format strings
dateFormat.masks = {
	"default" : "ddd mmm dd yyyy HH:MM:ss",
	shortDate : "m/d/yy",
	mediumDate : "mmm d, yyyy",
	longDate : "mmmm d, yyyy",
	fullDate : "dddd, mmmm d, yyyy",
	shortTime : "h:MM TT",
	mediumTime : "h:MM:ss TT",
	longTime : "h:MM:ss TT Z",
	isoDate : "yyyy-mm-dd",
	isoTime : "HH:MM:ss",
	isoDateTime : "yyyy-mm-dd'T'HH:MM:ss",
	isoUtcDateTime : "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
};

// Internationalization strings
dateFormat.i18n = {
	dayNames : ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
	monthNames : ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
};
dentro_click = 0;
// For convenience...
Date.prototype.format = function(mask, utc) {
	return dateFormat(this, mask, utc);
};

function parseDateWithDbFormat(string) {
	var reggie = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/g;
	var tokens = reggie.exec(string);
	if (tokens.length != 7)
		return new Date();
	else
		return new Date(tokens[1], tokens[2] - 1, // mesi partono da 0 in js
		tokens[3], tokens[4], tokens[5], tokens[6]);
};

var abutils = {
	voidfunc : function() {
	},
	alert : function(msg, title, callback) {
		if (title == null)
			title = "Il Sole 24 ORE";
		if (callback == null)
			callback = abutils.voidfunc;
		try {

			navigator.notification.alert(msg, function() {
				callback.call();
			}, title, 'Ok');

		} catch (exc) {
			alert(msg);
			if (callback != null) {
				callback.call();
			}
		}
	}
};

var PGAleBerUtils = function() {
}
PGAleBerUtils.prototype.splashScreenHide = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'splashScreenHide',
	// []);
}
PGAleBerUtils.prototype.activityStart = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStart',
	// []);
}
PGAleBerUtils.prototype.activityStop = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'activityStop',
	// []);
}
PGAleBerUtils.prototype.deviceExtraInfo = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils', 'deviceExtraInfo',
	// []);
}
PGAleBerUtils.prototype.deleteDirectoryAtAbsolutePath = function(successCB, errorCB, path) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils',
	// 'deleteDirectoryAtAbsolutePath', [path]);
}
PGAleBerUtils.prototype.registerForRemoteNotification = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.alebeer.utils',
	// 'registerForRemoteNotification', []);
}
/*
 * PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
 * window.plugins.pgaleberutils = new PGAleBerUtils(); });
 */
/* ------------------------------------------------------------- */

var PGFlipper24 = function() {
}
PGFlipper24.prototype.trackApp = function(successCB, errorCB, pageName, channel) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.appmeasurement',
	// 'trackApp', [pageName, channel]);
}
PGFlipper24.prototype.openFlipper24 = function(successCB, errorCB, testata, edizione, issue, startingPage, fastLoading) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.flipper24',
	// 'openFlipper24', [testata, edizione, issue, startingPage, fastLoading]);
}
PGFlipper24.prototype.addIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'addIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.removeIssueToDownloadQueue = function(successCB, errorCB, testata, issue, edizione) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'removeIssueToDownloadQueue', [testata, issue, edizione]);
}
PGFlipper24.prototype.getQueueDownloadQueue = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'getQueueDownloadQueue', []);
}
PGFlipper24.prototype.removeAllIssuesFromDownloadQueue = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.flipper24.downloadmanager',
	// 'removeAllIssuesFromDownloadQueue', []);
}
var PGAppStore = function() {
}
PGAppStore.prototype.setup = function(successCB, errorCB) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setup', []);
}
PGAppStore.prototype.setUserInfo = function(successCB, errorCB, username, useridentity) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'setUserInfo',
	// [username, useridentity]);
}
PGAppStore.prototype.productsListRequest = function(successCB, errorCB, productsIds) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore',
	// 'productsListRequest', [productsIds]);
}
PGAppStore.prototype.purchase = function(successCB, errorCB, productId, planS24) {
	// PhoneGap.exec(successCB, errorCB, 'it.dshare.pgappstore', 'purchase',
	// [productId, planS24]);
}
/*
 * PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
 * window.plugins.flipper24 = new PGFlipper24(); window.plugins.appstore = new
 * PGAppStore(); });
 */

/* ------------------------------------------------------------- */
NotificationEx = function() {
};

NotificationEx.prototype.loadingStart = function(options) {
	// PhoneGap.exec(null, null, "NotificationEx","loadingStart", [options]);
};
NotificationEx.prototype.loadingStop = function() {
	// PhoneGap.exec(null, null, "NotificationEx","loadingStop", []);
};

NotificationEx.prototype.activityStart = function() {
	// PhoneGap.exec(null, null, "NotificationEx", "activityStart", []);
};

NotificationEx.prototype.activityStop = function() {
	// PhoneGap.exec(null, null, "NotificationEx", "activityStop", []);
};
/*
* PhoneGap.addConstructor(function() { if(!window.plugins) window.plugins = {};
* navigator.plugins.notificationEx = new NotificationEx(); });
*/
// Variabile contente l'identificativo del prodotto aperto in edicola
var _PRODUCT_IN_EDICOLA = null;
var _INTERVALLO_CHECK_PRODUCTS = 15 * 60 * 1000;
var _EDICOLA_PRODUCTS_ISCROLL = null;
var _EDICOLA_PRODUCTS_COUNT = 0;
var _EDICOLA_PRODUCTS_INLINE_V = 3;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _EDICOLA_PRODUCTS_INLINE_H = 4;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _EDICOLA_PRODUCTS_DETAILS = null;
var _EDICOLA_DESCR_ISCROLL = null;
var _EDICOLA_PRODUCTS_DETAILS_ISCROLL = null;
// Flag utile per capire se i prodotti in edicola debbano essere aggiornati
// quando l'utente clicca sul relativo pulsante nella barra menu
var _EDICOLA_REFRESH_PRODUCTS = false;
// hash map tra testata e product id del sole, utilizzato per aprire l'archivio
var _HASH_MAP_TESTATA_PRODUCTID = {};

var _LockTap = false;

var _DEBUG_MODE = !('ontouchstart' in window), _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseup';
/*
 * var _API24_APPKEY = "IpadQuot";//<- PRODUZIONE //// DA CAMBIARE!!!
 * //DroidQuot //var _API24_APPKEY = "1123344";//<- NEURAL //var
 * _API24_SIGNATURE_KEY = "qu0t$STG";//<- PRODUZIONE var _API24_SIGNATURE_KEY =
 * "qu0t$PROD";//<- PRODUZIONE //var _API24_SIGNATURE_KEY = "pppppppp";//<-
 * NEURAL var _API24_SITECODE = "MB" var _API24_ENDPOINT =
 * "https://api24.ilsole24ore.com/"; //<- PRODUZIONE //var _API24_ENDPOINT =
 * "http://10.5.4.166:400/";//<- NEURAL var _SOLEGW_ENDPOINT = _API24_ENDPOINT +
 * "SoleGateway/";
 *
 * var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy.php"; // è da
 * cambiare anche dentro allo sfogliatore e a Flipper24
 */

var isPortrait = null, screenHeight = null, screenWidth = null;

var _SCREENADV = window.innerWidth;

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _debugIPADContent = false;

var _API24_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
// <- PRODUZIONE //DroidQuot iPadQuot
var _API24_SIGNATURE_KEY = "qu0t$PROD";
// <- PRODUZIONE
var _API24_SITECODE = "MB"
var _API24_ENDPOINT = "https://api24.ilsole24ore.com/";
// <- PRODUZIONE
var _SOLEGW_ENDPOINT = _API24_ENDPOINT + "SoleGateway/";
var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php";

var _API24TEST_APPKEY = (_debugIPADContent) ? 'iPadQuot' : 'DroidQuot';
// <- STAGE //DroidQuot iPadQuot
var _API24TEST_SIGNATURE_KEY = "qu0t$STG";
// <- STAGE
var _API24TEST_SITECODE = "MB"
var _API24TEST_ENDPOINT = "http://api24test.ilsole24ore.com/";
// <- STAGE
var _SOLEGWTEST_ENDPOINT = _API24TEST_ENDPOINT + "SoleGateway/";
var _ADVTEST_PROXY = "http://212.45.97.204/adv_proxy_and.php";

// Variabile globale contenente lo username dell'utente che sta utilizzando
// l'applicativo
var _USERNAME = null;
// Variabile globale contenente la password dell'utente che sta utilizzando
// l'applicativo
var _USER_PASSWORD = null;
// Variabile globale contenente lo user identity associato all'utente
var _USER_IDENTITY = null;
// Variabile contenente la funzione da richiamare come prossima azione. Utile in
// diverse situazioni per esempio dopo aver fatto la login e proseguire con la
// prossima azione.
var _NEXT_ACTION = null;

var _AJAX_TIMEOUT = 15000;
var _AJAX_TIMEOUT_PING = 10 * 1000;
var _INTERVALLO_CHECK_INBOX = 15 * 60 * 1000;
var _INTERVALLO_CHECK_ONLINE = 10 * 1000;

/**
 * *****************AGGIUNTA PER
 * CHECKACQ****************************************
 */
// metterlo a false se non si vogliono usare le categorie
// quotidiano --> false
// riviste professionali --> true
var _EDICOLA_USE_CATEGORIES = false;
// metterlo a true se si vuole chiedere la registrazione pre-acquisto one-shot
// quotidiano --> false
// riviste professionali --> true
var _ONESHOT_CHECK_REGISTRATO = true;

/** ********************************************************* */
var _menuButtonsIndex = ['#appmenu_edicola', '#appmenu_preferiti', '#appmenu_inbox', '#appmenu_impostazioni'];

var device = {
		uuid : null,
		version : null,
		platform : null,
		name : null,
		phonegap : null
};

function loadCategories() {
	try {

		// svuoto categorie
		$('#edicola_titolo_btn').html('');

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getCategorie");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "categories.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getCategories");
				console.log(p_response);
				if (checkAjaxResponse(p_response)) {
					var res = p_response.Result.res;
					if ((!res.categoryList) || (res.categoryList.length <= 0)) {
						loadProductsByCategory(null);
						return;
					}
					var l_select = $('<select onchange="edicolaFiltroProdottiByCategory();" id="edicola_titolo_btn_select"></select>');
					for (var i = 0; i < res.categoryList.length; i++) {
						$('<option value="' + res.categoryList[i].categoryName + '">' + res.categoryList[i].categoryDescription + '</option>').appendTo(l_select);
					}

					$('#edicola_titolo_btn').html('');
					l_select.appendTo('#edicola_titolo_btn');

					loadProductsByCategory(res.categoryList[0].categoryName);
				} else {
					console.log('getCategories check ajax response error');
					loadProductsByCategory(null);
				}
			},
			error : function() {
				console.log('getCategories ajax error');
				loadProductsByCategory(null);
			}
		});
	} catch (exc) {
		console.log('getCategories exception ' + exc.message);
		loadProductsByCategory(null);
	}
}

function loadProductsByCategory(p_category) {
	console.log('loadProductsByCategory:' + p_category);
	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				// console.log("getProducts "+
				// JSON.stringify(p_response));
				// Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					// console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/* new Array(); */
						// _EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] =
						// res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if ( typeof _PRODUCTLINK[0] != 'undefined' && _PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						// alert('is
						// '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						// Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						// Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						// Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						// pbox_icon_img.src = i % 5 == 0 ?
						// 'imgs/fake/prodotto_icon_appstore.png' : (i %
						// 2 == 0 ?
						// 'imgs/fake/prodotto_icon_standard.png' :
						// 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						// Nel caso in cui il prodotto sia esterno viene
						// creata l'icona appstore
						// if
						// (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'])
						// {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						// Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						// Viene associato l'evento di apertura del
						// dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						// Se il prodotto principale è
						// stato impostato, viene aperto
						// il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");

						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}

					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato
					// getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});
	} catch (exc) {
		console.log("error::load: " + exc.message);
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}
}

/**
 * Gestisce il caricamento dell'anteprima dei prodotti nell'edicola Utilizza le
 * seguenti chiamate: - ajaxErrorHandler per la gestione degli errori di
 * comunicazione con API24
 */
var _EDICOLA_LAST_PRODUCT_LOAD = null;
function loadProducts() {

	if ((_EDICOLA_LAST_PRODUCT_LOAD != null) && (Math.abs(_EDICOLA_LAST_PRODUCT_LOAD - (new Date().getTime())) < _INTERVALLO_CHECK_PRODUCTS)) {
		console.log('loadProducts NON necessario');
		return;
	}

	_EDICOLA_LAST_PRODUCT_LOAD = new Date().getTime();

	if (_EDICOLA_USE_CATEGORIES) {
		loadCategories();
		return;
	} else {
		loadProductsByCategory(null);
		return;
	}

	try {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola_container').empty();
		_EDICOLA_PRODUCTS_DETAILS = {};

		var req_headers = {
			"appKey" : _API24_APPKEY
		};

		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};

		console.log("--REQ---> getProducts");
		console.log(req_headers);
		console.log(req_data);

		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				$('#edicola_container').empty();
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts");
				console.log("getProducts " + /* JSON.stringify( */p_response/* ) */);
				// Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					// console.log('ajax success');
					var res = p_response.Result.res;
					_EDICOLA_REFRESH_PRODUCTS = false;
					_EDICOLA_PRODUCTS_COUNT = res.products.length;
					var l_edicola_container = document.getElementById('edicola_container');
					for (var i = 0; i < _EDICOLA_PRODUCTS_COUNT; i++) {
						var pid = res.products[i].productId;
						_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						/* new Array(); */
						// _EDICOLA_PRODUCTS_DETAILS[pid]['appstore'] =
						// res.products[i].inApp != true;
						_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;

						if (!_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] && _PRODUCTLINK) {
							if (_PRODUCTLINK[0]['linkType'])
								_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = _PRODUCTLINK;
						}

						// alert('is
						// '+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[pid]['linksList']));

						// Creazione elemento "edicola_prodotto_box"
						var pbox = document.createElement('div');
						pbox.id = 'edicola_prodotto_box_' + pid;
						if (_EDICOLA_CATALOGO_SMALL) {
							pbox.className = 'edicola_prodotto_box edicola_prodotto_box_small';
						} else {
							pbox.className = 'edicola_prodotto_box';
						}
						l_edicola_container.appendChild(pbox);

						var pbox_container = document.createElement('div');
						pbox.appendChild(pbox_container);
						pbox_container.className = 'edicola_prodotto_box_container';

						// Creazione container icona prodotto
						var pbox_icon = document.createElement('div');
						pbox_container.appendChild(pbox_icon);
						pbox_icon.className = 'edicola_prodotto_box_icon';
						pbox_icon.id = 'edicola_prodotto_box_icon_' + pid;

						// Creazione immagine icona prodotto
						var pbox_icon_img = document.createElement('img');
						pbox_icon.appendChild(pbox_icon_img);
						// pbox_icon_img.src = i % 5 == 0 ?
						// 'imgs/fake/prodotto_icon_appstore.png' : (i %
						// 2 == 0 ?
						// 'imgs/fake/prodotto_icon_standard.png' :
						// 'imgs/fake/prodotto_icon_quotidiano.png');
						pbox_icon_img.src = res.products[i].icon;
						pbox_icon_img = null;

						_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;

						// Nel caso in cui il prodotto sia esterno viene
						// creata l'icona appstore
						// if
						// (_EDICOLA_PRODUCTS_DETAILS[pid]['appstore'])
						// {
						if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "store") {
							// icona small appstore
							var pbox_icon_appstore = document.createElement('div');
							pbox_icon.appendChild(pbox_icon_appstore);
							pbox_icon_appstore.className = 'edicola_prodotto_box_icon_appstore';
							pbox_icon_appstore = null;

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_in_appstore';
						} else if (_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "webpage") {

							_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;

							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_prodotto_webpage';
						} else {
							// Viene aggiunta una classe utile per il
							// filtraggio dei prodotti
							pbox.className += ' edicola_non_in_appstore';
						}

						// Titolo del prodotto
						var pbox_text = document.createElement('div');
						pbox_text.id = 'edicola_prodotto_box_text_' + pid;
						pbox_text.className = 'edicola_prodotto_box_text';
						pbox_container.appendChild(pbox_text);
						pbox_text.appendChild(document.createTextNode(res.products[i].productName));

						// Viene associato l'evento di apertura del
						// dettaglio prodotto
						pbox.onclick = (function(pid) {
							return function() {
								openProductDetails(pid);
							}
						})(pid);

						pbox_text = null;
						pbox_icon = null;
						pbox_container = null;
						pbox = null;
					}

					$('#edicola_container').fadeIn(200, function() {
						updateEdicolaProductsIscroll();

						// Se il prodotto principale è
						// stato impostato, viene aperto
						// il relativo dettaglio
						var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
						if (l_prodotto_principale_id && l_prodotto_principale_id != '') {
							openProductDetails(l_prodotto_principale_id);
						} else if (_PRODUCT_IN_EDICOLA != null) {
							openProductDetails(_PRODUCT_IN_EDICOLA.productId);
						}
					});

					omnitureTrackApp('APP:edicola:loadProducts', 'APP:edicola');

					// aggiornamento impostazioni in base a risultato
					// getProducts
					impostazioniInizializza();
				} else {

					// c'è un errore nella risposta
					_EDICOLA_LAST_PRODUCT_LOAD = null;
					abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

				}

			},
			error : function() {

				// probabile timeout
				_EDICOLA_LAST_PRODUCT_LOAD = null;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');

			}
		});

	} catch (exc) {
		_EDICOLA_LAST_PRODUCT_LOAD = null;
		abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
	}

}

/**
 * Inizializza il controllo per l'aggiornamento dei prodotti attivando un flag
 * per l'aggiornamento dei dati quando l'utente clicca sul pulsante edicola
 * della barra menu
 */
function initCheckProducts() {
	console.log("initCheckProducts");
}

function updateEdicolaProductsIscroll() {
	var pboxes = $('#edicola_container .edicola_prodotto_box');

	if ((pboxes.length == 0) || (_EDICOLA_PRODUCTS_COUNT == 0)) {
		$('#edicola_container').width( _EDICOLA_CATALOGO_SMALL ? $('#edicola_wrapper').width() : (_ORIENTATION == 'V' ? '100%' : '100%'));
	} else {
		if (_ORIENTATION == 'V') {
			$('#edicola_catalogo').css('left', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('top', '-' + ($('#centrale').height() - 180) + 'px');
				$('#edicola_container').width($(pboxes[0]).outerWidth(true) * pboxes.length);
			} else {
				$('#edicola_catalogo').css('top', '1px');
				$('#edicola_container').width('100%');
			}
		} else {
			$('#edicola_catalogo').css('top', '0px');
			if (_EDICOLA_CATALOGO_SMALL) {
				$('#edicola_catalogo').css('left', ($('#centrale').width() - 200) + 'px');
				$('#edicola_container').width($('#edicola_wrapper').width());
			} else {
				$('#edicola_catalogo').css('left', '1px');
				$('#edicola_container').width('100%');
			}
		}
	}

	if (_EDICOLA_PRODUCTS_ISCROLL == null) {
		_EDICOLA_PRODUCTS_ISCROLL = new iScroll('edicola_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_PRODUCTS_ISCROLL.refresh();
	}

	if (_EDICOLA_DESCR_ISCROLL != null)
		_EDICOLA_DESCR_ISCROLL.refresh();
	if (_EDICOLA_PRODUCTS_DETAILS_ISCROLL != null)
		_EDICOLA_PRODUCTS_DETAILS_ISCROLL.refresh();
	if (_ABBONAMENTI_ISCROLL != null)
		_ABBONAMENTI_ISCROLL.refresh();
}

var _PRODUCT_DETAILS_COVERFLOW = null;
function openProductDetails(productId) {

	if (_LockTap)
		return;
	_LockTap = true;

	console.log("openProductDetails " + productId);
	if (_EDICOLA_PRODUCTS_DETAILS[productId] == null) {
		_LockTap = false;
		return;
	}

	$('#edicola_prodotto').attr('class', 'edicola_prodotto_type_' + _EDICOLA_PRODUCTS_DETAILS[productId].type);

	$('.edicola_prodotto_box_icon').removeClass('edicola_prodotto_box_icon_selected');
	$('#edicola_prodotto_box_icon_' + productId).addClass('edicola_prodotto_box_icon_selected');
	if (!_EDICOLA_CATALOGO_SMALL) {
		edicolaCatalogoSwitchView();
	}

	if (_PRODUCT_DETAILS_COVERFLOW != null) {
		_PRODUCT_DETAILS_COVERFLOW.destroy();
		_PRODUCT_DETAILS_COVERFLOW = null;
	}

	$('#edicola_prodotto').hide();

	// elimino prodotto precedente
	$('#edicola_prodotto_titolo_content').empty();
	$('#edicola_prodotto_coverflow_box').empty();
	$('#edicola_prodotto_btns').empty();
	// $('#edicola_prodotto_descr').empty();
	$('#edicola_prodotto_descr_container').empty();
	$('#edicola_prodotto_adv_content').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> getProductDetails(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			// try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			/*
			* console.log('--RESP--> getProductDetails(' + productId +
			* ')'); console.log('--RESP--> getProductDetails ' +
			* JSON.stringify(p_response));
			*/
			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				_LockTap = false;
				openProductDetails(productId);
			})) {
				// try{
				console.log("OK response openProductDetails " + /* JSON.stringify( */
				p_response.Result.res/* ) */);

				schedaProdotto(p_response.Result.res);
				// schedaProdotto($.parseJSON(risposta));
				$('#edicola_prodotto').fadeIn('normal', function() {
					_LockTap = false;
				});
				loadAdvCatalogo(productId);
				loadAdvTabbar(productId);
				window.product.setProduct(productId);
				// }catch(exc){
				// alert(exc.message);
				// }
			} else {
				_LockTap = false;
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			_LockTap = false;
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

	// carico link store android
	loadlink(productId);
}

// carico i link dello store per gli offerItunesProductId
function loadlink(productId) {
	console.log("loadlink " + productId);

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> loadlink(' + productId + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/links/" + productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {
			// try{
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			// console.log('--RESP--> url_loadlink ' + _SOLEGW_ENDPOINT
			// + "products/links/" + productId +
			// ".json?appKey="+_API24_APPKEY);
			console.log('--RESP--> loadlink(' + productId + ')');
			console.log('--RESP--> loadlink ' + p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				loadlink(productId);
			})) {
				console.log("OK response loadlink "/* +JSON.stringify(p_response) */);
				loadLinkProdotto(p_response.Result.res);
			} else {
				console.log('Si è verificato un errore nella comunicazione con il server');
			}
		},
		error : function() {
			console.log('Si è verificato un errore nella comunicazione con il server');
		}
	});

}

// Si popola _PRODUCTLINK per l'acquisto
_PRODUCTLINK = [];
function loadLinkProdotto(p_product) {
	console.log("loadLinkProdotto " + p_product.storeLinkItemsList.length + ',' + JSON.stringify(p_product.storeLinkItemsList));
	for (var i = 0; i < p_product.storeLinkItemsList.length; i++) {
		_PRODUCTLINK[i] = {};
		// name
		_PRODUCTLINK[i]['name'] = p_product.storeLinkItemsList[i]['name'];
		// url
		_PRODUCTLINK[i]['url'] = p_product.storeLinkItemsList[i]['url'];
		// productId
		_PRODUCTLINK[i]['productId'] = p_product.storeLinkItemsList[i]['productId'];
		// linkType
		_PRODUCTLINK[i]['linkType'] = p_product.storeLinkItemsList[i]['linkType'];
	}

	console.log("_PRODUCTLINK is  len ::: " + _PRODUCTLINK.length + " :::");
	console.log("_PRODUCTLINK[linkType] is " + ((_PRODUCTLINK) ? _PRODUCTLINK[0]['linkType'] : ""));
}

/**
 * Aggiorna la scheda del prodotto se necessario
 */
function refreshProductDetails() {
	if ((_EDICOLA_CATALOGO_SMALL == true) && (_PRODUCT_IN_EDICOLA != null)) {
		schedaProdotto(_PRODUCT_IN_EDICOLA);
	}
}

/**
 * Crea la scheda del prodotto
 */
// var _EDICOLA_DESCR_ISCROLL = null;
function schedaProdotto(p_product) {
	try {

		console.log("openProductDetails p_product is " + p_product + ',' + p_product.productId);

		if (_PRODUCT_DETAILS_COVERFLOW != null) {
			_PRODUCT_DETAILS_COVERFLOW.destroy();
			_PRODUCT_DETAILS_COVERFLOW = null;
		}
		$('#edicola_prodotto_titolo_content').empty();
		$('#edicola_prodotto_coverflow_box').empty();
		$('#edicola_prodotto_btns').empty();
		$('#edicola_prodotto_descr_container').empty();
		$('#edicola_prodotto_adv_content').empty();

		var code = $('#edicola_prodotto_titolo').html();
		$('#edicola_prodotto_titolo').html('<div class="buttonBack" onclick="edicolaProdottoTornaEdicola();" style="position:absolute; left: 0px; top: 0px;"><span></span>Prodotti</div>' + code);
		_PRODUCT_IN_EDICOLA = p_product;

		_HASH_MAP_TESTATA_PRODUCTID[p_product.testata] = p_product.productId;

		_MAP_CODICE_TESTATA[p_product.productId + ''] = p_product.testata;

		// titolo
		$('#edicola_prodotto_titolo_content').empty();
		$('<h1>' + p_product.productName + '</h1>').appendTo('#edicola_prodotto_titolo_content');
		$('<h2>' + (p_product.editionDescription != null ? 'Edizione del ' + p_product.editionDescription : '') + '</h2>').appendTo('#edicola_prodotto_titolo_content');

		// Coverflow
		$('#edicola_prodotto_coverflow_box').empty();
		var l_covers_list = [];
		var l_num_covers = p_product.inserts.length;
		for (var i = 0; i < l_num_covers; i++) {
			l_covers_list[i] = {
				'src' : p_product.inserts[i].cover,
				'code' : p_product.inserts[i].insertId,
				'description' : p_product.inserts[i].description,
				'anteprima' : p_product.inserts[i].anteprima && (parseInt(p_product.inserts[i].anteprima) > 0) && !(p_product.free || p_product.subscription),
				'abbonati' : p_product.inserts[i].premium && (parseInt(p_product.inserts[i].premium) > 0)
			}
		}
		var dim = screenHeight - $('#edicola_prodotto_titolo').height() - $('#appmenu').height();
		$('#edicola_prodotto_scroll').height(dim);

		//if (l_num_covers > 1) {
		_PRODUCT_DETAILS_COVERFLOW = new CoveerFlow('edicola_prodotto_coverflow_box', l_covers_list);
		console.log("_PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);
		//}

		// bottoni
		$('#edicola_prodotto_btns').empty();
		if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "store") {
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '" ><img src="imgs/edicola_catalogo_appstore_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				window.location = _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'];
			}
		} else if (_EDICOLA_PRODUCTS_DETAILS[p_product.productId]['type'] == "webpage") {
			// $('<a href="' +
			// _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] +
			// '?deviceId=' + encodeURIComponent(device.uuid) + '&appname=' +
			// encodeURIComponent(device.appname) + '&appversion=' +
			// encodeURIComponent(device.appversion) + '&deviceType=' +
			// encodeURIComponent(device.platform) + '" ><img
			// src="imgs/edicola_catalogo_webpage_logo.png"
			// /></a>').appendTo('#edicola_prodotto_btns');
			$('<a href="' + _EDICOLA_PRODUCTS_DETAILS[p_product.productId]['appstore_link'] + '?deviceId=' + encodeURIComponent(device.uuid) + '&deviceName=' + encodeURIComponent(device.name) + '&appname=' + encodeURIComponent(device.appname) + '&appversion=' + encodeURIComponent(device.appversion) + '&deviceType=' + encodeURIComponent(device.platform) + '" class="button red24 commonGenericButton" ><img src="imgs/edicola_catalogo_webpage_logo.png" /></a>').appendTo('#edicola_prodotto_btns');
		} else {
			// metto possibilitÃ di tappare dirrettamente sulla cover
			// dell'inserto
			_PRODUCT_DETAILS_COVERFLOW.on_tap = function() {
				console.log('TAP ON COVERFLOW: ' + p_product.testata + ' ' + p_product.editionId + ' ' + p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				tapOnAnInsert(p_product);
			}
			// nascondo i bottoni, vengono mostrati quando si sa se è sfoglia o
			// acquisto copia singola
			// $('#edicola_prodotto_btns').css('display', 'none');

			console.log('verifica is ' + p_product.productId + ',' + p_product.subscriptionOffers.length + ',' + (p_product.subscriptionOffers && p_product.subscriptionOffers.length));

			// Se ci sono delle offerte
			if (p_product.subscriptionOffers && p_product.subscriptionOffers.length) {
				$('<button class="button medium red24 prodotto_dettaglio_abbonamenti">Abbonamenti</button>').click(function() {
					popupAcquistoAbbonamenti(p_product);
				}).appendTo('#edicola_prodotto_btns');

			}

			// Se c'è la possibilitÃ di acquistare solo un numero viene
			// aggiunto il pulsante per l'acquisto della singola copia
			console.log('productsingle is ' + JSON.stringify(p_product.single));
			if (p_product.single) {
				for (var i = 0; i < p_product.singleOffers.length; i++) {
					$('<button class="button medium red24 prodotto_dettaglio_acquisto">' + ab_euro_formatter(p_product.singleOffers[i].offerPrice) + '</button>').click(function() {

						if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
							mostraPopupInsertoAbbonati();
						} else {
							acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[i].offerId, p_product.singleOffers[i].offerItunesProductId);
						}

					}).appendTo('#edicola_prodotto_btns');

					break;
					// <--- visualizzo una sola offerta
				}
			}

			// appstoreReqProducts();

			$('<button class="button medium red24 prodotto_dettaglio_sfoglia">Sfoglia</button>').click(function() {
				var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);
				if ((!p_product.subscription) && l_edizione_premium) {
					sfogliaCheckPremium(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				} else {
					sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				}
			}).appendTo('#edicola_prodotto_btns');

			// $('<br />').appendTo('#edicola_prodotto_btns');

			// Archivio
			$('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;">Archivio</button>').click(function() {
				if (_LockTap)
					return;
				_LockTap = true;

				console.log("CLICK CONSULTA ARCHIVIO");
				// archivio standard al momento non utilizzato
				if (p_product.productId == _CODICE_PRODOTTO_QUOTIDIANO/* '3' */) {// CORRETTO????
					// chiamata per aprire archivio STANDARD
					qarchivioOpen(p_product.productId);
				} else {
					// chiamata per aprire archivio QUOTIDIANO
					console.log('archivioOpen p_product.productId' + p_product.productId);
					archivioOpen(p_product.productId);
				}

				_LockTap = false;
			}).appendTo('#edicola_prodotto_btns');

			var consultaBtn = $('<button class="button medium gray prodotto_dettaglio_archivio" style="position: relative;">Archivio</button>');

			checkLocalProductForBtnsRender(p_product);
			console.log(" _PRODUCT_DETAILS_COVERFLOW");
		}

		// Descrizione prodotto
		if (_EDICOLA_DESCR_ISCROLL != null) {
			_EDICOLA_DESCR_ISCROLL.destroy();
			_EDICOLA_DESCR_ISCROLL = null;
		}
		if (_EDICOLA_PRODUCTS_DETAILS_ISCROLL != null) {
			_EDICOLA_PRODUCTS_DETAILS_ISCROLL.destroy();
			_EDICOLA_PRODUCTS_DETAILS_ISCROLL = null;
		}

		$('#edicola_prodotto_descr_container').empty();
		// console.log("descr " + p_product.productDescription);
		// alert("descr "+p_product.productDescription);
		$(p_product.productDescription).appendTo('#edicola_prodotto_descr_container');
		/*
		 * if (_EDICOLA_DESCR_ISCROLL == null) { setTimeout(function() {
		 * _EDICOLA_DESCR_ISCROLL.refresh(); }, 100);
		 *
		 * _EDICOLA_DESCR_ISCROLL = new iScroll('edicola_prodotto_descr', {
		 * hScroll : false, vScroll : true, hScrollbar : false, vScrollbar :
		 * true, bounce : false }); console.log("HELLO ISCROLL");
		 * console.log(_EDICOLA_DESCR_ISCROLL); //
		 * _EDICOLA_DESCR_ISCROLL.refresh(); }
		 */
		_EDICOLA_PRODUCTS_DETAILS_ISCROLL = null;
		if (_EDICOLA_PRODUCTS_DETAILS_ISCROLL == null) {
			setTimeout(function() {
				_EDICOLA_PRODUCTS_DETAILS_ISCROLL.refresh();
			}, 100);
			console.log("----------------scroll edicola");
			_EDICOLA_PRODUCTS_DETAILS_ISCROLL = new iScroll('edicola_prodotto_scroll', {
				hScroll : false,
				vScroll : true,
				hScrollbar : false,
				vScrollbar : true,
				bounce : true
			});
		}

		// console.log("2edicola descr iscroll is "+
		// $('#edicola_prodotto_descr_container').html()+ ":::
		// _EDICOLA_DESCR_ISCROLL " + _EDICOLA_DESCR_ISCROLL);
		// alert("aaa "+ $('#edicola_prodotto_descr_container').html() );
		omnitureTrackApp('APP:edicola:loadProduct:' + p_product.productId, 'APP:edicola');

		console.log(" _PRODUCT_DETAILS_COVERFLOW is " + _PRODUCT_DETAILS_COVERFLOW);
	} catch (exc) {
		console.log(exc.message);
	}
}

function checkLocalProductForBtnsRender(p_product) {
	try {

		var l_testata = p_product.testata;
		var l_issue = p_product.editionId;
		var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

		console.log('xok0');

		if (_DB) {
			console.log('xok');
			/* console.log('aaa_ant '+$('.coveerflow_anteprima').html()); */
			var querySuccess = function(tx, p_results) {
				// alert('asd ' + JSON.stringify(p_results.rows));
				var len = p_results.rows.length;
				// console.log("checkLocalProductForBtnsRender: testata: " +
				// l_testata + " issue: " + l_issue + " edizione: " + l_edizione
				// + ", letti record: " + len);
				if ((len > 0) || p_product.free || p_product.subscription) {
					// solo bottone sfoglia
					$('#edicola_prodotto_btns .prodotto_dettaglio_acquisto').css('display', 'none');
					/*
					 * console.log('aaa_ant
					 * '+$('.coveerflow_anteprima').html());
					 */
					$('.coveerflow_anteprima').css('display', 'none');
					// alert('aaa_sed' + p_product.free +','+
					// p_product.subscription );
				} else {
					// acquisto copia singola
					$('#edicola_prodotto_btns .prodotto_dettaglio_sfoglia').css('display', 'none');
					$('.coveerflow_anteprima').css('display', 'inline-block');
				}
				console.log('xok1');
				$('#edicola_prodotto_btns').css('display', 'inline-block');
			}
			var queryError = function(p_error) {
				console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaProdottoTornaEdicola() {
	edicolaCatalogoSwitchView();
}

function mostraPopupInsertoAbbonati() {
	abutils.alert('Per poter leggere questo inserto devi essere abbonato.', 'Inserto per abbonati');
}

function sfogliaCheckPremium(p_testata, p_issue, p_edizione) {
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			if (len > 0) {
				sfoglia(p_testata, p_issue, p_edizione);
			} else {
				mostraPopupInsertoAbbonati();
			}
		}
		var queryError = function(p_error) {
			sfoglia(p_testata, p_issue, p_edizione);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [p_testata, p_issue, p_edizione], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function tapOnAnInsert(p_product) {
	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
	var l_edizione_premium = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (_DB) {
		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// se la issue è gratuita o è coperta da abbonamento...
			if (p_product.free || p_product.subscription) {
				// si apre lo sfoglio...
				sfoglia(l_testata, l_issue, l_edizione);
			} else {
				// se la issue è presente in locale (o lo è uno dei suoi
				// inserti)...
				if (len > 0) {
					// controllo se è in locale proprio questa issue
					_DB.transaction(function(tx) {
						tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=? and edizione=?', [l_testata, l_issue, l_edizione], function(tx, p_results) {
							var len = p_results.rows.length;
							if (len > 0) {
								// la copia è
								// in locale
								sfoglia(l_testata, l_issue, l_edizione);
							} else {
								// la copia non
								// è ancora in
								// locale
								if (l_edizione_premium) {
									mostraPopupInsertoAbbonati();
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							}
						}, function() {
							sfoglia(l_testata, l_issue, l_edizione);
						});
					}, function() {
						sfoglia(l_testata, l_issue, l_edizione);
					});
					/*
					 * if ((!p_product.subscription) && l_edizione_premium) {
					 * sfogliaCheckPremium(l_testata, l_issue, l_edizione); }
					 * else { sfoglia(l_testata, l_issue, l_edizione); }
					 */
				} else {
					// se è disponibile l'anteprima
					if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima) > 0)) {
						// apro l'anteprima
						openAnteprima(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].anteprima));
					} else {
						// altrimenti se sono presenti degli abbonamenti ...
						if (p_product.subscriptionOffers.length) {
							// si aprono le offerte commerciali ...
							popupAcquistoAbbonamenti(p_product);
						} else {
							// altrimenti se è presente la possibilitÃ di
							// acquisto come copia singola ...
							if (p_product.single && (p_product.singleOffers.length > 0)) {
								// si passa all'acquisto della copia singola ...
								if (p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0)) {
									mostraPopupInsertoAbbonati();
								} else {
									acquistoSingolo(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_product.singleOffers[0].offerId, p_product.singleOffers[0].offerItunesProductId);
								}
							} else {
								// niente da fare...
							}
						}
					}
				}
			}
		}
		var queryError = function(p_error) {

		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

// DA CAMBIAREEEEEEEEEEEEEEEEEEEEEEEEEE***************************************
function openAnteprima(p_testata, p_issue, p_edizione, p_anteprima) {
	// openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
	console.log('anteprimaaaa');
	openFlipper(p_testata, p_issue, p_edizione, 1, p_anteprima);
}

function sfoglia(p_testata, p_issue, p_edizione, p_pagina) {
	if (_LockTap)
		return;
	_LockTap = true;

	if ( typeof p_pagina == undefined || p_pagina == null) {
		p_pagina = '1';
	}
	console.log('pagina sfoglia ' + p_pagina);
	// alert('pagina sfoglia ' + p_pagina);

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);
	// APRO LO SFOGLIO ANDROID
	try {
		// window.loader.launchSfogliatore("S24", "SOLE", "20111011",
		// "Descrizione");
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		// alert("style: "+node.style.display);
		if (node.style.display == 'block' || node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if ( typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		console.log("sfoglia " + p_testata + "," + p_edizione + "," + p_issue + "," + "Descrizione" + window.localStorage.getItem(keyinput) + "," + "aaaa" + "," + null);
		if (p_pagina != '1')
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null, p_pagina);
		else
			window.soledownloader.launchDownload(p_testata, p_edizione, p_issue, "Descrizione" + window.localStorage.getItem(keyinput), "" + "aaaa", null);
	} catch (exc) {
		// alert(exc.message);
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}

	// Chiude eventuali schermate aperte

	setTimeout(function() {
		archivioClose();
		qarchivioClose();
		_LockTap = false;
	}, 1500);

}

function scarica(p_testata, p_issue, p_edizione) {
	sfoglia(p_testata, p_issue, p_edizione);
}

function eliminaCopiaLocale(p_testata, p_issue, p_edizione) {
	if (_LockTap)
		return;
	_LockTap = true;

	var type = ($('#edicola_offline_subtitolo_opzioni_vista_ICONS').hasClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on')) ? 'ICONS' : 'LIST';
	// alert("Elimina copia locale testata: " + p_testata + " issue: " +
	// p_issue+ " edizione: " + p_edizione);
	window.simulatePG.confirm('Sei sicuro?', "eliminaCopiaLocaleSucc('" + p_testata + "','" + p_issue + "','" + p_edizione + "', '" + type + "')", 'Cancellazione issue', 'Si,No');

	setTimeout(function() {
		_LockTap = false;
	}, 2000);
}

function acquistoSingolo(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina, p_forceSkipOneshotCheck) {
	if (!p_forceSkipOneshotCheck)
		p_forceSkipOneshotCheck = false;
	if (false/*
	 * _ONESHOT_CHECK_REGISTRATO && !_USERNAME &&
	 * !p_forceSkipOneshotCheck
	 */) {
		_NEXT_ACTION = function() {
			acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
		}
		popupAcquistoRegistrazione(p_testata);
	} else {
		acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina);
	}
}

var _CURRENT_FLIPPER_TESTATA = null;
var _CURRENT_FLIPPER_ISSUE = null;
var _CURRENT_FLIPPER_EDIZIONE = null;
var _CURRENT_FLIPPER_PAGINA = null;
function setFlipperCurrentState(p_testata, p_issue, p_edizione, p_pagina) {
	if (p_testata == null)
		console.log('setFlipperCurrentState null*4');
	else
		console.log('setFlipperCurrentState ' + p_testata + ' ' + p_issue + ' ' + p_edizione + ' ' + p_pagina);
	_CURRENT_FLIPPER_TESTATA = p_testata;
	_CURRENT_FLIPPER_ISSUE = p_issue;
	_CURRENT_FLIPPER_EDIZIONE = p_edizione;
	_CURRENT_FLIPPER_PAGINA = p_pagina;
}

function openFlipper(testata, issue, edizione, pagina, anteprima) {
	if (_LockTap)
		return;
	_LockTap = true;
	try {

		if (anteprima == null || anteprima == 0)
			anteprima = false;
		else
			anteprima = true;

		console.log("openflipper");
		var l_fast_loading = false;

		if ((testata == null) && (issue == null) && (edizione == null)) {
			testata = _CURRENT_FLIPPER_TESTATA;
			issue = _CURRENT_FLIPPER_ISSUE;
			edizione = _CURRENT_FLIPPER_EDIZIONE;
			pagina = _CURRENT_FLIPPER_PAGINA;
			l_fast_loading = true;
		}

		if ((testata == null) || (issue == null) || (edizione == null)) {
			return false;
		}

		if (pagina == null)
			pagina = 1;

		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Attendere..."]);

		setTimeout(function() {

			if (anteprima) {
				_CURRENT_FLIPPER_TESTATA = null;
				_CURRENT_FLIPPER_ISSUE = null;
				_CURRENT_FLIPPER_EDIZIONE = null;
				_CURRENT_FLIPPER_PAGINA = null;
			} else {
				_CURRENT_FLIPPER_TESTATA = testata;
				_CURRENT_FLIPPER_ISSUE = issue;
				_CURRENT_FLIPPER_EDIZIONE = edizione;
				_CURRENT_FLIPPER_PAGINA = pagina;
			}

			var keyinput = "unread_message_sole";
			var valoutput = 0;

			var node = document.getElementById('appmenu_inbox_count');
			if (node.style.display == 'block' || node.style.display == 'inline-block') {
				valoutput = 1;
			} else {
				valoutput = 0;
			}

			if ( typeof (window.localStorage) != 'undefined') {
				window.localStorage.setItem(keyinput, valoutput);
			} else {
				throw "window.localStorage, not defined";
			}

			// VERIFICA****************************************
			removeToDownloadQueue(testata, edizione, issue);

			console.log(_CURRENT_FLIPPER_TESTATA + ',' + _CURRENT_FLIPPER_EDIZIONE + ',' + _CURRENT_FLIPPER_ISSUE + ',' + _CURRENT_FLIPPER_PAGINA);

			if (!anteprima) {
				window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA, _CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE, "Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');
			} else {
				console.log('anteprima launch');
				window.soledownloader.launchAnteprimaSfogliatore(testata, edizione, issue, "Descrizione" + valoutput, null, null);
			}

			setTimeout(function() {
				// window.go.to(_CURRENT_FLIPPER_PAGINA);

				// chiudo eventuali schermate aperte
				qarchivioClose();
				archivioClose();
				popupAcquistoAbbonamentiClose();
				popupAcquistoRegistrazioneClose();

				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				omnitureTrackApp('APP:edicola:open:' + testata + ':' + issue + ':' + edizione + ( anteprima ? ':PREVIEW' : ''), 'APP:edicola');
				nielsenCall('SFOGLIATORE');
				_LockTap = false;
			}, 3000);

		}, 250);

		return true;
	} catch (exc) {
		console.log(exc.message);
		return false;
	}
}

/*
 * Controlla se un prodotto sia stato scaricato in locale ed in caso abilita il
 * pulsante Sfoglia @params p_product Prodotto
 */
function checkLocalProduct(p_product) {

	var l_testata = p_product.testata;
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;

	// Controlla se il prodotto sia stato giÃ scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("checkLocalProduct: testata: " + l_testata + " issue: " + l_issue + " edizione: " + l_edizione + ", letti record: " + len);

			if (len) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				creaPulsanteSfoglia(p_product, false);
				// Se il prodotto/inserto è presente in locale avrÃ² il
				// pulsante sfoglia in grigio
			} else if (p_product.free || p_product.subscription) {
				// Vengono Nascosti gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeOut(200);
				// Se il prodotto/inserto non è presente in locale il pulsante
				// sfoglia sarÃ rosso
				creaPulsanteSfoglia(p_product, true);
			} else {
				// Vengono mostrati gli eventuali pulsanti per l'acquisto
				$('.prodotto_dettaglio_acquisto').fadeIn(200);
			}
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			// tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?
			// and edizione=?', [l_testata, l_issue, l_edizione], querySuccess,
			// queryError);
			tx.executeSql('SELECT * FROM issues WHERE testata=? and issue=?', [l_testata, l_issue], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

function creaPulsanteSfoglia(p_product, p_red) {
	var l_pulsante = $('#edicola_prodotto_sfoglia_btn');

	if (!l_pulsante.length) {

		l_pulsante = $('<button id ="edicola_prodotto_sfoglia_btn" class="button">Sfoglia</button>');

		if (p_red) {
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.addClass('gray');
		}

		l_pulsante.click(function() {
			sfoglia(p_product.testata, p_product.editionId, p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
		});

		l_pulsante.appendTo('#edicola_prodotto_btns');

	} else {
		if (p_red) {
			l_pulsante.removeClass('gray');
			l_pulsante.addClass('red24');
		} else {
			l_pulsante.removeClass('red24');
			l_pulsante.addClass('gray');
		}
	}
}

var _EDICOLA_CATALOGO_SMALL = false;
function edicolaCatalogoSwitchView() {

	var isPortrait = window.innerWidth < window.innerHeight;
	_EDICOLA_CATALOGO_SMALL = !_EDICOLA_CATALOGO_SMALL;

	if (!_EDICOLA_CATALOGO_SMALL) {
		$('.edicola_prodotto_box_icon_selected').removeClass('edicola_prodotto_box_icon_selected');
		_PRODUCT_IN_EDICOLA = null;
	}
	/*
	 * if (isPortrait) { if ($('#edicola_catalogo').css('top') == '1px') {
	 * $('#edicola_catalogo').animate({ 'top': '-' + ($('#centrale').height() -
	 * 180) + 'px' }); } else { $('#edicola_catalogo').animate({ 'top': '1px'
	 * }); } } else { if ($('#edicola_catalogo').css('left') == '1px') {
	 * $('#edicola_catalogo').animate({ 'left': ($('#centrale').width() - 200) +
	 * 'px' }); } else { $('#edicola_catalogo').animate({ 'left': '1px' }); } }
	 */
	if ($('#edicola_catalogo').css('display') != 'none') {
		$('#edicola_catalogo').hide();
		/*
		 * $('#edicola_catalogo').animate({ 'left':
		 * '-'+$('#edicola_catalogo').width() + 'px' });
		 */
	} else {
		$('#edicola_catalogo').show();
		/*
		 * $('#edicola_catalogo').animate({ 'left': '1px' });
		 */
	}
	$('#edicola_catalogo').toggleClass('edicola_catalogo_small');
	$('#edicola_container > .edicola_prodotto_box').toggleClass('edicola_prodotto_box_small');
	$('#edicola_wrapper').toggleClass('edicola_wrapper_small');

	setTimeout(function() {
		updateEdicolaProductsIscroll();
	}, 0);

	if (_EDICOLA_DESCR_ISCROLL != null && !_EDICOLA_CATALOGO_SMALL) {
		_EDICOLA_DESCR_ISCROLL.destroy();
		_EDICOLA_DESCR_ISCROLL = null;
	}
	if (_EDICOLA_PRODUCTS_DETAILS_ISCROLL != null) {
		_EDICOLA_PRODUCTS_DETAILS_ISCROLL.destroy();
		_EDICOLA_PRODUCTS_DETAILS_ISCROLL = null;
	}
}

/**
 * Filtra i prodotti in edicola.
 */
function edicolaFiltroProdotti() {
	var l_selected_option = $('#edicola_titolo_btn_select option:selected');

	if (l_selected_option.val() == '') {
		$('#edicola_container .edicola_prodotto_box').fadeIn(200);
	} else {
		$('#edicola_container .edicola_prodotto_box').not('.' + l_selected_option.val()).css('display', 'none');
		$('#edicola_container .edicola_prodotto_box.' + l_selected_option.val()).fadeIn(200);
	}

	_EDICOLA_PRODUCTS_ISCROLL.refresh();
}

/* --------- gestione drag&drop catalogo ----------- */
var _EDICOLA_TOUCH_START_POS_X = 0;
var _EDICOLA_TOUCH_START_POS_Y = 0;
var _EDICOLA_TOUCH_START_Y = 0;
var _EDICOLA_TOUCH_START_X = 0;
var _EDICOLA_TOUCH_MOVE_Y = 0;
var _EDICOLA_TOUCH_MOVE_X = 0;
var _EDICOLA_TOUCH_STARTED = false;
var _EDICOLA_TOUCH_MOVED = false;
function edicolaTouchStart(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_STARTED = true;
		_EDICOLA_TOUCH_MOVED = false;
		_EDICOLA_TOUCH_START_POS_X = $('#edicola_catalogo').offset().left;
		/* _EDICOLA_TOUCH_START_X = _event.clientX; */
		_EDICOLA_TOUCH_START_POS_Y = $('#edicola_catalogo').offset().top;
		_EDICOLA_TOUCH_START_X = _event.clientX;
		_EDICOLA_TOUCH_START_Y = _event.clientY;

	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMove(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_X = _event.clientX;
		var position = Math.max(0, Math.min(_EDICOLA_TOUCH_START_POS_X + $('#edicola_wrapper').position().left, (_EDICOLA_TOUCH_START_POS_X + _EDICOLA_TOUCH_MOVE_X - _EDICOLA_TOUCH_START_X)));
		if (position < -($('#centrale').height() - 180))
			position = -($('#centrale').height() - 180);
		$('#edicola_catalogo').css('left', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchMoveVertical(event) {
	try {
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		_EDICOLA_TOUCH_MOVED = true;
		_EDICOLA_TOUCH_MOVE_Y = _event.clientY;
		var position = Math.min(0, _EDICOLA_TOUCH_START_POS_Y + _EDICOLA_TOUCH_MOVE_Y - _EDICOLA_TOUCH_START_Y);
		if (position < -($('#centrale').height() - 180))
			position = -($('#centrale').height() - 180);
		$('#edicola_catalogo').css('top', position + 'px');
	} catch (exc) {
		console.log(exc.message);
	}
}

function edicolaTouchEnd(event) {
	try {
		var _event = _HAS_TOUCH ? event.touches[0] : event;
		if (!_EDICOLA_TOUCH_MOVED)
			return;
		if (!_EDICOLA_TOUCH_STARTED)
			return;
		_EDICOLA_TOUCH_STARTED = false;
		edicolaCatalogoSwitchView();

	} catch (exc) {
		console.log(exc.message);
	}
}

/*******************************************************************************
 * Gestione demo
 ******************************************************************************/
/**
 * Verifica che l'utente possa utilizzare la demo
 */
function verifyDemo() {
	console.log("---REQ---> verifyDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	} else {
		_NEXT_ACTION = verifyDemo;
		// popupAccediRegistrati();
		popupAcquistoRegistrazione();
		return;
	}

	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> verifyDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, verifyDemo)) {
				if (p_response.Result.res.canUseDemo == true)
					useDemo();
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

/**
 * Utilizza la demo
 */
function useDemo() {
	console.log("---REQ---> useDemo (" + _PRODUCT_IN_EDICOLA.productId + ")");

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		'userIdentity' : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		'username' : _USERNAME
	}

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/demo/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		dataType : "json",
		processData : false,
		data : JSON.stringify(l_req_data),
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('----> useDemo(' + _PRODUCT_IN_EDICOLA.productId + ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, useDemo)) {
				// && p_response.Result.res.canUseDemo == true
				sfoglia(_PRODUCT_IN_EDICOLA.testata, _PRODUCT_IN_EDICOLA.editionId, _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId);
				omnitureTrackApp('APP:edicola:demo:' + _PRODUCT_IN_EDICOLA.testata + ':' + _PRODUCT_IN_EDICOLA.editionId + ':' + _PRODUCT_IN_EDICOLA.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, 'APP:edicola');
			} else {
				abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore nella comunicazione con il server. Riprovare tra poco.', 'Errore');
		}
	});

}

_ABBONAMENTI_ISCROLL = null;
/* --------- gestione schermata acquisto ----------------- */
function popupAcquistoAbbonamenti(p_product_detail) {
	if (_LockTap)
		return;
	_LockTap = true;

	function creaPulsanteAbbonamento(p_offerta) {
		/*
		 * console .log("p_offerta is " +
		 * _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][0]['linkType'] +
		 * ',' + JSON
		 * .stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']) +
		 * ',' + JSON.stringify(p_product_detail) + '::' +
		 * JSON.stringify(p_offerta));
		 */
		var linkPulsante = '';
		if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] != null) {
			for (var x = 0; x < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; x++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['name'] == p_offerta.offerId) {
					linkPulsante = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x]['linkType'];
				}
			}
		}

		if (linkPulsante == '') {
			// _PRODUCTLINK
			console.log(JSON.stringify(_PRODUCTLINK));
			for (var x = 0; x < _PRODUCTLINK.length; x++) {
				if (_PRODUCTLINK[x]['name'] == p_offerta.offerId) {
					linkPulsante = _PRODUCTLINK[x]['linkType'];
				}
				_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][x] = _PRODUCTLINK[x];
			}

		}

		if (linkPulsante && linkPulsante.toString().indexOf('nolink') != -1) {
			// niente
		} else {
			$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
				popupAcquistoAbbonamentiClose();
				if (_USERNAME) {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /*
					 * ||
					 * p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG')
					 * !=-1
					 */) {// in
						// caso
						// di
						// abbo
						// annuale
						// altra
						// maschera
						// console.log("p_product_detail is
						// "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));

						// alert(JSON.stringify(p_product_detail,
						// null, 4));
						// alert(JSON.stringify(p_offerta, null,
						// 4));

						popupRiepilogoApri(p_product_detail, p_offerta);
					} else {
						// console.log("p_product_detail is
						// "+JSON.stringify(p_product_detail));
						// procediAcquistoAbbonamento(p_product_detail,
						// p_offerta.offerId,
						// p_offerta.offerItunesProductId);

						// alert(JSON.stringify(p_product_detail,
						// null, 4));
						// alert(JSON.stringify(p_offerta, null,
						// 4));

						window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
						console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
					}
				} else {
					console.log("p_offerta.offerId is " + JSON.stringify(p_offerta.offerId));
					_NEXT_ACTION = function() {
						if (linkPulsante.toString().toString().indexOf('link_wall') != -1 /*
						 * ||
						 * p_offerta.offerId.toString().indexOf('QOL_ABBONAMENTO_ANNUALE_PAG')
						 * !=-1
						 */) {// in
							// caso
							// di
							// abbo
							// annuale
							// altra
							// maschera
							// console.log("p_product_detail is
							// "+JSON.stringify(p_product_detail));
							popupRiepilogoApri(p_product_detail, p_offerta);
						} else {
							// console.log("p_product_detail is
							// "+JSON.stringify(p_product_detail));
							// procediAcquistoAbbonamento(p_product_detail,
							// p_offerta.offerId,
							// p_offerta.offerItunesProductId);
							window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
							console.log("offerItunesProductId " + p_offerta.offerItunesProductId);
						}
					}
					popupAcquistoRegistrazione(p_offerta.offerId);
				}
			}).appendTo('#acquisto_abbonamenti_offerte');
		}
	}

	function creaPulsanteCopiaSingola(p_offerta) {
		$('<div class="button medium red24 acquisto_abbonamenti_offerta" style="border-color: #BF8585;">' + ab_euro_formatter(p_offerta.offerPrice) + '<br /><span class="txtsmall">' + p_offerta.offerDescription + '</span></div>').click(function() {
			// acquistoSingolo(p_product_detail.testata,
			// p_product_detail.editionId,
			// p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId,
			// p_offerta.offerId,
			// p_offerta.offerItunesProductId);
			// alert("p_product_detail is
			// "+JSON.stringify(_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList']));
			popupAcquistoAbbonamentiClose();
			acquistoSingolo(p_product_detail.testata, p_product_detail.editionId, p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId, p_offerta.offerId, p_offerta.offerItunesProductId);
			console.log("offerItunesProductId " + p_offerta.offerItunesProductId);

		}).appendTo('#acquisto_abbonamenti_offerte');
	}


	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_others').css('display', p_product_detail.testata == 'S24' ? 'none' : 'inline-block');
	$('#acquisto_abbonamenti .acquisto_abbonamenti_el_s24').css('display', p_product_detail.testata == 'S24' ? 'inline-block' : 'none');
	if (p_product_detail.testata == 'S24') {
		$('#acquisto_abbonamenti_body_prodotto').html('Il Sole 24 Ore Versione Digitale');
	} else {
		$('#acquisto_abbonamenti_body_prodotto').html(p_product_detail.productName);
	}
	// Inserimento offerte
	$('#acquisto_abbonamenti_offerte').empty();

	var l_inserto_premium = p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium && (parseInt(p_product_detail.inserts[_PRODUCT_DETAILS_COVERFLOW._current].premium) > 0);

	if (!l_inserto_premium) {
		for (var i = 0; i < p_product_detail.singleOffers.length; i++) {
			creaPulsanteCopiaSingola(p_product_detail.singleOffers[i]);
			break;
			// <-- una sola offerta singola
		}
	}

	for (var i = 0; i < p_product_detail.subscriptionOffers.length; i++) {
		creaPulsanteAbbonamento(p_product_detail.subscriptionOffers[i]);
	}
	// Demo prodotto
	if ((!l_inserto_premium) && p_product_detail.demo == true)
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_demo').css('display', 'none');
	/* ---- inizio modifica ---- */
	if (_USERNAME == null)
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'block');
	else
		$('#acquisto_abbonamenti_opzioni_aggancio').css('display', 'none');
	/* ---- fine modifica ---- */

	// Viene mostrato il popup
	$('#acquisto_abbonamenti').css('display', 'inline');

	// $('#acquisto_abbonamenti_wrapper').height($('#acquisto_abbonamenti_content').height());

	if (_ABBONAMENTI_ISCROLL == null /* _ORIENTATION == 'H' */) {
		_ABBONAMENTI_ISCROLL = new iScroll('acquisto_abbonamenti_wrapper', {
			bounce : false
		});
		_ABBONAMENTI_ISCROLL.refresh();
	} else {
		_ABBONAMENTI_ISCROLL.refresh();
	}

	$('select').attr('disabled', 'disabled');
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}

function popupAcquistoAbbonamentiClose() {
	if (_LockTap)
		return;
	// $('#acquisto_abbonamenti').fadeOut();
	$('#acquisto_abbonamenti').css('display', 'none');
	$('select').removeAttr('disabled');
}

var _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = null;
function popupAcquistoRegistrazione(p_testata) {
	if (_LockTap)
		return;
	_LockTap = true;
	console.log("REGISTRAZIONE" + p_testata);
	// -------INIZIO
	if (p_testata == 'S24') {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'none');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'block');
		document.getElementById('acquisto_registrazione_body').className = '';
	} else {
		$('#acquisto_registrazione .acquisto_registrazione_el_others').css('display', 'block');
		$('#acquisto_registrazione .acquisto_registrazione_el_s24').css('display', 'none');
		document.getElementById('acquisto_registrazione_body').className = 'acquisto_registrazione_type_others';
	}
	// -------FINE
	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	$('#acquisto_abbonamenti').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');

	if (_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}

	console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is " + _EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL);
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}

function popupAcquistoRegistrazioneClose() {
	// $('#acquisto_registrazione').fadeOut();
	console.log("REGISTRAZIONE chiusa");
	$('#acquisto_registrazione').css('display', 'none');
}

function acquistoAbbonamento(abbonamento) {
	popupAcquistoRegistrazione();
}

function popupAcquistoRegistrazioneRegistrati() {
	console.log("REGISTRAZIONE 1");
	popupRegistrazioneApri();
}

function procediAcquistoAbbonamento(p_product, p_offerta, p_itunes) {
	var l_testata = p_product.testata;
	if (!l_testata)
		l_testata = 'S24';
	var l_issue = p_product.editionId;
	var l_edizione = p_product.inserts[_PRODUCT_DETAILS_COVERFLOW._current].insertId;
}

function acquistoAbbonamentiAgganciaAbbonamento() {

	_NEXT_ACTION = acquistoAbbonamentiAgganciaAbbonamento_done;

	popupLogin();

}

function acquistoAbbonamentiAgganciaAbbonamento_done() {
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggancio abbonamento..."]);
	// controllo stato abbonamento

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + _PRODUCT_IN_EDICOLA.productId);
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + _PRODUCT_IN_EDICOLA.productId + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> subscription/' + _PRODUCT_IN_EDICOLA.productId);
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				acquistoAbbonamentiAgganciaAbbonamento_done();
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					// if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);

						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}

				if (l_attivo) {

					acquistoAbbonamentiAgganciaAbbonamento_complete('Aggancio abbonamento completato. Il tuo abbonamento scade il ' + l_date_end.format('dd/mm/yyyy'));
				} else {
					acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
				}

			} else {
				acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
			}
		},
		error : function() {
			acquistoAbbonamentiAgganciaAbbonamento_complete('Ti sei associato all\'utente ' + _USERNAME + ', ma non risulta nessun abbonamento attivo.');
		}
	});

}

function acquistoAbbonamentiAgganciaAbbonamento_complete(p_msg) {
	abutils.alert(p_msg, 'Aggancia abbonamento');

	// chiudo schermata abbonamenti
	popupAcquistoAbbonamentiClose();
	// ricarico dettaglio prodotto
	openProductDetails(_PRODUCT_IN_EDICOLA.productId);

	/* navigator.notification.loadingStop(); */
	window.simulatePG.exec(null, null, "Notification", "activityStop", []);
}

function acquistoSingolo_aux(p_testata, p_issue, p_edizione, p_offerta, p_itunes, p_pagina) {
	if (!p_pagina)
		p_pagina = 1;
	var l_productid = _HASH_MAP_TESTATA_PRODUCTID[p_testata];

	// alert('aaa '+l_productid);
	if (!l_productid) {
		// appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata,
		// p_issue, p_edizione, p_pagina); });
		// BUY
		var link_singola = '';
		for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
			if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
				link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
			}
		}

		if (!link_singola || link_singola == '') {
			_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'] = _PRODUCTLINK;
			for (var i = 0; i < _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'].length; i++) {
				if (_EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[p_product_detail.productId]['linksList'][i]['url'];
				}
			}
		}

		if (link_singola != '') {
			window.payment.paySingle(p_testata, p_issue, p_edizione, p_offerta, p_itunes, link_singola);
		} else {
			abutils.alert('Errore su link!', 'Pagamento');
		}

	} else
		checkAcquisto(l_productid, p_issue, p_edizione, p_offerta, p_itunes, function() {
			sfoglia(p_testata, p_issue, p_edizione, p_pagina);
		});
	// appstoreBuy(p_offerta, p_itunes, function() { sfoglia(p_testata, p_issue,
	// p_edizione); });
}

var _PRODOTTO_PRINCIPALE_DEFAULT = {
	id : (_debugIPADContent) ? "1" : "a1",
	descr : "Il Sole 24 ORE"
};

var _DEVICE_SETTINGS = {
	platform : "2",
	appname : (_debugIPADContent) ? "ITQUOIPAD" : "ITQUOANDROID", // DA
	// CAMBIARE!!!
	// //ITQUOANDROID
	// ITQUOIPAD
	appversion : (_debugIPADContent) ? "2.2" : "1.5" // da cambiare in a2.0
	// 2.2 1.0
}

var _MAP_CODICE_TESTATA = (_debugIPADContent) ? {
	'1' : 'S24'
} : {
	'a1' : 'S24'
};
var _CODICE_PRODOTTO_QUOTIDIANO = (_debugIPADContent) ? '1' : 'a1';

function getQueryString(key) {
	key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
	var qs = regex.exec(window.location.href);
	if (qs == null)
		return '';
	else
		return qs[1];
}

function setUserData(p_username, p_password, p_useridentity) {
	console.log('setUserData ' + p_username + ' ' + p_password + ' ' + p_useridentity);
	if (p_username == null || p_password == null || p_useridentity == null) {
		deleteUsername();
		deletePassword();
		_USERNAME = null;
		_USER_PASSWORD = null;
		_USER_IDENTITY = null;
		// PhoneGap.exec('AppStore.setUserInfo');
		// window.plugins.appstore.setUserInfo();
	} else {
		storeUsername(p_username);
		storePassword(p_password);
		_USERNAME = p_username;
		_USER_PASSWORD = p_password;
		_USER_IDENTITY = p_useridentity;
		// PhoneGap.exec('AppStore.setUserInfo', _USERNAME, _USER_IDENTITY);
		// window.plugins.appstore.setUserInfo(null, null, _USERNAME,
		// _USER_IDENTITY);
		// console.log('logging '+p_username+','+p_password);
	}

	// console.log('setUserData2 ' + _USERNAME + ' ' + _USER_PASSWORD + ' ' +
	// _USER_IDENTITY);
}

function applicationWillEnterForeground() {
	console.log('JS|applicationWillEnterForeground');
	return "OK";
}

function applicationDidEnterBackground() {
	console.log('JS|applicationDidEnterBackground');
	return "OK";
}

var ROTATION_CLASSES = {

	"0" : "none",
	"90" : "right",
	"-90" : "left",
	"180" : "flipped"

};

/*
 * function detectOrientationEvent() { var orientationEvents =
 * ['onorientationchange', 'reorient', 'resize']; var orientationEvent = null;
 * for (var i = 0; i < orientationEvents.length; i++) { if (orientationEvents[i]
 * in window) { orientationEvent = orientationEvents[i]; break; } } return
 * orientationEvent; }
 */

function monitorOrientationChanges() {
	setInterval(function() {
		updateOrientation();
	}, 500);
}

function search() {
	window.searchlaunch.launch();
}

var CURRENT_ORIENTATION = null;
var _appPageIndex = 0;

function openAppPage(index) {
	_appPageIndex = index;
}

function onBodyLoad() {
	// alert('version 61');
	document.addEventListener("deviceready", onDeviceReady, false);
	document.addEventListener("touchmove", function(e) {
		e.preventDefault();
	}, false);
	/*
	 * if (_DEBUG_MODE) {
	 * document.getElementById('edicola_catalogo_tiro').addEventListener('click',
	 * function() { edicolaCatalogoSwitchView(); }, false); //verticale
	 * document.getElementById('edicola_catalogo_tiro_v').addEventListener('click',
	 * function() { edicolaCatalogoSwitchView(); }, false); } else {
	 * document.getElementById('edicola_catalogo_tiro').addEventListener(_START_EV,
	 * edicolaTouchStart, false);
	 * document.getElementById('edicola_catalogo_tiro').addEventListener(_MOVE_EV,
	 * edicolaTouchMove, false);
	 * document.getElementById('edicola_catalogo_tiro').addEventListener(_END_EV,
	 * edicolaTouchEnd, false);
	 * document.getElementById('edicola_catalogo_tiro').addEventListener(_CANCEL_EV,
	 * edicolaTouchEnd, false);
	 *
	 * //verticale
	 * document.getElementById('edicola_catalogo_tiro_v').addEventListener(_START_EV,
	 * edicolaTouchStart, false);
	 * document.getElementById('edicola_catalogo_tiro_v').addEventListener(_MOVE_EV,
	 * edicolaTouchMoveVertical, false);
	 * document.getElementById('edicola_catalogo_tiro_v').addEventListener(_END_EV,
	 * edicolaTouchEnd, false);
	 * document.getElementById('edicola_catalogo_tiro_v').addEventListener(_CANCEL_EV,
	 * edicolaTouchEnd, false); }
	 */
	/* inizializzazione componenti grafiche */
	GalaxyCheckboxStyle.init();

	/* inizializzazione componenti grafiche */
	if ($(".registrazione_body_group :checkbox").iphoneStyle != null)
		$(".registrazione_body_group :checkbox").iphoneStyle({
			checkedLabel : 'SI',
			uncheckedLabel : 'NO'
		});

	monitorOrientationChanges();

	setTimeout(function() {
		updateOrientation();
		// $(_menuButtonsIndex[_appPageIndex]).trigger('click');
	}, 200);

	document.addEventListener("backbutton", backKeyDown, true);

	if (_DEBUG_MODE) {
		device = {// ATTENZIONE, dati impostati anche in onDeviceReady
			platform : _DEVICE_SETTINGS.platform,
			appname : _DEVICE_SETTINGS.appname,
			appversion : _DEVICE_SETTINGS.appversion,
			name : 'Il mio Safari ;)',
			uuid : '201111111115'
		}

		PhoneGap = {};
		PhoneGap.exec = function(successCB, errorCB, namespace, method) {
			console.log('PG ' + namespace + ' . ' + method);
		};
		PhoneGap.windowEventHandler = function() {
		};
		if (navigator == null) {
			console.log("create navigator");
			navigator = {};
		}
		if (navigator.notification == null)
			navigator.notification = {};
		if (navigator.notification.loadingStart == null)
			navigator.notification.loadingStart = function() {
				console.log('loadingStart');
			};
		if (navigator.notification.loadingStop == null)
			navigator.notification.loadingStop = function() {
				console.log('loadingStop');
			};

		if (!window.plugins)
			window.plugins = {};
		window.plugins.flipper24 = new PGFlipper24();
		// window.plugins.appstore = new PGAppStore();
		navigator.plugins.notificationEx = new NotificationEx();
		// window.plugins.pgaleberutils = new PGAleBerUtils();

		onDeviceReadyDeviceInfo(null);
	}
}

function backKeyDown() {
	// ALERT sei sicuro, se si esegui finish()
	window.runfunc.askandrun('Sei sicuro di voler uscire?', '');
}

function onDeviceReady() {
	if (_API24TEST_SWITCH) {
		console.log('************* PUNTAMENTO AD AMBIENTE DI TEST ***********************');
		_API24_APPKEY = _API24TEST_APPKEY;
		_API24_SIGNATURE_KEY = _API24TEST_SIGNATURE_KEY;
		_API24_SITECODE = _API24TEST_SITECODE;
		_API24_ENDPOINT = _API24TEST_ENDPOINT;
		_SOLEGW_ENDPOINT = _SOLEGWTEST_ENDPOINT;
		_ADV_PROXY = _ADVTEST_PROXY;
	}

	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Caricamento in corso..."]);
	// window.plugins.pgaleberutils.activityStart();
	// window.plugins.pgaleberutils.deviceExtraInfo(onDeviceReadyDeviceInfo,
	// onDeviceReadyDeviceInfo);
	onDeviceReadyDeviceInfo(null);
}

function onDeviceReadyDeviceInfo(extraInfo) {
	// mod 03012013
	// inizializziamo l'uuid
	device.uuid = window.infodroid.getuuid();

	window.infodroid.setuuid(device.uuid);
	// **********************FINE**
	device.orig_uuid = device.uuid;
	if (extraInfo != null && extraInfo.deviceid != null)
		device.uuid = extraInfo.deviceid;

	device.appname = (extraInfo == null || extraInfo.appname == null) ? "---" : extraInfo.appname;
	device.appversion = (extraInfo == null || extraInfo.appversion == null) ? "---" : extraInfo.appversion;
	device.name = window.infodroid.getDevice();
	// DA CAMBIARE
	// device.usedspace = (extraInfo == null || extraInfo.usedspace == null) ?
	// "---" : extraInfo.usedspace;
	// device.usedspaceperc = (extraInfo == null || extraInfo.usedspaceperc ==
	// null) ? "---" : extraInfo.usedspaceperc;
	device.usedspace = (window.infodroid == null) ? "---" : window.infodroid.dirSize("/S24/");
	device.usedspaceperc = (window.infodroid == null) ? "---" : window.infodroid.dirSizePerc("/S24/");

	/*
	* MOD 03012013 if (navigator == null) navigator = {}; if (navigator.fileMgr ==
	* null) navigator.fileMgr = {}; if (navigator.fileMgr.libFolderPath ==
	* null) navigator.fileMgr.libFolderPath = (extraInfo == null ||
	* extraInfo.libFolderPath == null) ? "" : extraInfo.libFolderPath;
	*
	* if (navigator.notification == null) navigator.notification = {}; if
	* (navigator.notification.loadingStart == null)
	* navigator.notification.loadingStart =
	* navigator.plugins.notificationEx.loadingStart; if
	* (navigator.notification.loadingStop == null)
	* navigator.notification.loadingStop =
	* navigator.plugins.notificationEx.loadingStop;
	*/

	// DA VERIFICARE!!! forzo il device.platform a 1
	device.platform = _DEVICE_SETTINGS.platform;
	device.appversion = _DEVICE_SETTINGS.appversion;
	device.appname = _DEVICE_SETTINGS.appname;
	/*
	 * console.log = function(msg) { };
	 */

	/* inizializzazione prodotto principale */
	var l_local_storage_prodotto_principale = window.localStorage.getItem("prodotto_principale_id");
	console.log('prodotto principale settato: ' + l_local_storage_prodotto_principale);
	if (l_local_storage_prodotto_principale == null) {
		window.localStorage.setItem("prodotto_principale_id", _PRODOTTO_PRINCIPALE_DEFAULT.id);
		window.localStorage.setItem("prodotto_principale_descr", _PRODOTTO_PRINCIPALE_DEFAULT.descr);
	}

	// non piu' usato, ma puÃ² essere lasciato: all'avvio viene lasciata accesa
	// l'edicola dello sfoglio, per forzare il loading di entrambe le immagini
	// qui viene ripristinata l'icona dell'edicola, e tolta quella dello sfoglio
	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');

	// setta il valore di _ORIENTATION
	initOrientation();

	// apertura db
	inizializzaDatabase();

	// controllo username
	controlloUsername();

}

function onDeviceReady_aux() {

	initCheckProducts();

	// Controlla lo stato online/offline
	initCheckOnline();

	downloadManagerDBinit();

	inboxLoadMessages();

	loadAdvTabbar();
	loadAdvCatalogo();

	setTimeout(function() {
		// $('#splashscreen').css('display', 'none');
		// window.plugins.pgaleberutils.activityStop();
		// window.plugins.pgaleberutils.splashScreenHide();
		// navigator.notification.loadingStop();
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
		if (_API24TEST_SWITCH) {
			abutils.alert('Stai utilizzando l\'ambiente di test...');
		}
	}, 3000);
}

function loadAdvTabbar(product_id) {
	// alert("CALL ME!!!");
	// document.getElementById('advtabbar_close').style.display = 'none';
	document.getElementById('advtabbar_close_content').innerHTML = '';
	// $('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_02', function(){

	console.log(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);

	$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {

	}).endCapture();
	document.getElementById('advtabbar_open_content').innerHTML = '';
	console.log(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV);
	// $('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_03', function(){
	$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();

}

var _TABBAR_ADV_IS_OPEN = false;

function handleAdvTabbarClick() {
	var _width_close = $('#advtabbar_close_content img').first().width();
	// evita di aprire il contenuto se non c'è nulla caricato
	if ((_width_close == null) || (_width_close < 5))
		return;
	// alert("CALL ME1!!!");
	_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
	document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
	document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + ( _TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
}

function loadAdvCatalogo(product_id) {
	// alert("CALL ME2!!!");
	document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
	// $('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Ticker_01', function(){
	$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();
}

function getSignature(p_request_params) {
	return Crypto.HMAC(Crypto.SHA1, p_request_params, _API24_SIGNATURE_KEY).toUpperCase();
}

var _ORIENTATION = '';

function initOrientation() {
	console.log('********init_Orientation********');

	if (window.innerWidth > window.innerHeight) {
		_ORIENTATION = 'H';
	} else {
		_ORIENTATION = 'V';
	}
}

var _UPDATE_ORIENTATION_RUNNING = false;

function updateOrientation() {
	var that = this;
	setTimeout(function() {
		screenHeight = (_DEBUG_MODE) ? window.innerHeight : document.documentElement.clientHeight;
		screenWidth = (_DEBUG_MODE) ? window.innerWidth : document.documentElement.clientWidth;
		isPortrait = screenWidth < screenHeight;
		// alert("screenWidth " + screenWidth + ", screenHeight " + screenHeight);

		var orientation = isPortrait ? 1 : 2;
		if (CURRENT_ORIENTATION == orientation)
			return;
		CURRENT_ORIENTATION = orientation;

		if (_UPDATE_ORIENTATION_RUNNING)
			return;
		_UPDATE_ORIENTATION_RUNNING = true;
		console.log('_ORIENTATION ' + _ORIENTATION);

		if (!isPortrait) {
			_ORIENTATION = 'H';
		} else {
			_ORIENTATION = 'V';
		}

		$('#wrapper').width(screenWidth).height(screenHeight);

		// FONT SIZE CALCULATION
		var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.013) : Math.round(screenWidth * 0.013);
		$('body').css('font-size', fontSizeRatio + 'px');
		fontSizeRatio = null;

		var edicolaSmallHeight = 180;
		$('#centrale').height(screenHeight - $('#appmenu').height());
		$('#inbox_list_wrapper').height(screenHeight - $('#inbox_list_title').height() - $('#appmenu').height() - $('#inbox_list_refresh').height());

		if (isPortrait) {
			// PORTRAIT
			$('#edicola_prodotto').height($('#edicola').height()).width('100%');
			$('#edicola_prodotto_coverflow').width('100%');

			var dim = $(window).height() - 60 - 60 - 70;
			$('#edicola_prodotto_coverflow').height(dim);
			$('#edicola_prodotto_coverflow_box').height(dim - 50);
			
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_subtitolo_prodotto').height() - $('#archivio_subtitolo_opzioni').height() - $('#archivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(50);
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_subtitolo_prodotto').height() - $('#qarchivio_subtitolo_opzioni').height() - $('#qarchivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width('100%');
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width('100%');
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height() - $('#edicola_offline_subtitolo_opzioni').height());
			$('#qarchivio_label_local_v').show();
			$('#qarchivio_label_local_h').hide();
		} else {
			// LANDSCAPE
			$('#edicola_prodotto').height('100%').width(screenWidth - 200);
			$('#edicola_prodotto_coverflow').width(screenWidth - 200 - ((screenWidth - 200) * 0.3));
			$('#archivio_wrapper, #archivio_loading').height(screenHeight - $('#archivio_titolo').height() - $('#archivio_footer').height());
			$('#qarchivio_wrapper, #qarchivio_loading').height(screenHeight - $('#qarchivio_titolo').height() - $('#qarchivio_footer').height());
			$('#qarchivio_subtitolo_prodotto').height(screenHeight - $('#qarchivio_titolo').height());
			$('#qarchivio_wrapper, #qarchivio_loading, #qarchivio_footer').width(screenWidth - $('#qarchivio_subtitolo_prodotto').width());
			$('#archivio_wrapper, #archivio_loading, #archivio_footer').width(screenWidth - $('#archivio_subtitolo_prodotto').width());
			$('#edicola_offline_wrapper').height(screenHeight - $('#edicola_offline_titolo').height());
			$('#qarchivio_label_local').css('top', (screenHeight - 40) + 'px');
			$('#qarchivio_label_local_h').show();
			$('#qarchivio_label_local_v').hide();
		}

		// COMMON
		$('.commonContentWithTopBar').height(Math.round((screenHeight * 0.9) - 50));
		$('.commonWindowWithTopBar').height(screenHeight - 50);
		$('.commonWindowWithAppBar').height(screenHeight - 50 - $('#appmenu').height());
		$('.commonMaxContentWithTopBar').css('max-height', (screenHeight * 0.9) - 50);

		updateEdicolaProductsIscroll();
		if (_PRODUCT_DETAILS_COVERFLOW != null)
			_PRODUCT_DETAILS_COVERFLOW._display();

		qarchivioUpdateIScroll();
		archivioUpdateIscroll();
		inboxUpdateOrientation();
		preferitiUpdateOrientation();
		impostazioniUpdateOrientation();

		if (_REGISTRAZIONE_ISCROLL != null)
			_REGISTRAZIONE_ISCROLL.refresh();
		if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null)
			_IMPOSTAZIONI_ISCROLL_PRIVACY.refresh();

		_UPDATE_ORIENTATION_RUNNING = false;
	}, 100);
}

/*******************************************************************************
 * Gestione schermata di riepilogo abbonamento annuale
 ******************************************************************************/
var _RIEPILOGO_ISCROLL = null;
var _RIEPILOGO_PRODUCT = null;
var _RIEPILOGO_OFFER = null;

function popupRiepilogoApri(p_product_detail, p_offerta) {
	console.log('detail ' + /* JSON.stringify( */
	p_product_detail['subscriptionOffers'] /* ) */);
	_RIEPILOGO_PRODUCT = p_product_detail;
	_RIEPILOGO_OFFER = p_offerta;
	if (_RIEPILOGO_ISCROLL == null && _ORIENTATION == 'H') {
		_RIEPILOGO_ISCROLL = new iScroll('riepilogo_body', {
			bounce : false
		});
		_RIEPILOGO_ISCROLL.refresh();
	}

	_RIEPILOGO_OFFER = {};
	// p_product_detail['subscriptionOffers'];

	// alert("aaa "+p_product_detail['subscriptionOffers'].length);

	for (var j = 0; j < p_product_detail['subscriptionOffers'].length; j++) {
		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['annuale_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['annuale_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in unica soluzione.<BR/>L\'importo visualizzato a fianco si riferisce alla quota annuale di abbonamento';
			_RIEPILOGO_OFFER['annuale_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['annuale_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		if (p_product_detail['subscriptionOffers'][j]['offerId'] == 'QOL_ABBONAMENTO_MENSILE_PAG') {
			_RIEPILOGO_OFFER['mensile_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['mensile_descr'] = 'Abbonamento annuale a ' + p_product_detail.productName + '<BR/>in versione digitale con pagamento in rate mensili.<BR/>L\'importo visualizzato a fianco si riferisce al canone mensile di abbonamento';
			_RIEPILOGO_OFFER['mensile_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['mensile_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];
		}

		// se i codici che mi arrivano non sono quelli attessi mi conservo
		// quello che arriva
		if (p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_MENSILE_PAG' && p_product_detail['subscriptionOffers'][j]['offerId'] != 'QOL_ABBONAMENTO_ANNUALE_PAG') {
			_RIEPILOGO_OFFER['x_price'] = p_product_detail['subscriptionOffers'][j]['offerPrice'];
			_RIEPILOGO_OFFER['x_descr'] = 'Abbonamento a ' + p_product_detail.productName + '<BR/>in versione digitale.<BR/>';
			_RIEPILOGO_OFFER['x_url'] = p_product_detail['subscriptionOffers'][j]['offerItunesProductId'];
			_RIEPILOGO_OFFER['x_offerId'] = p_product_detail['subscriptionOffers'][j]['offerId'];

			// console.log(JSON.stringify(_RIEPILOGO_OFFER));
		}

	}

	// alert("aaa " + _RIEPILOGO_OFFER['annuale_price'] + "," +
	// _RIEPILOGO_OFFER['mensile_price']);

	$('#riepilogo').css('display', 'inline-block');
	$('.prezzo_abbo_anno').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['annuale_price'] /* p_offerta.offerPrice */));
	$('.prezzo_abbo_mese').text('Prezzo ' + ab_euro_formatter(_RIEPILOGO_OFFER['mensile_price'] /* p_offerta.offerPrice */));
	$('#prodotto_riepilogo').text(p_product_detail.productName);
	$('.abbo_mensile_text').html(_RIEPILOGO_OFFER['mensile_descr']);
	$('.abbo_annuale_text').html(_RIEPILOGO_OFFER['annuale_descr']);
}

function popupRiepilogoAnnulla() {
	$('#riepilogo').css('display', 'none');

}

function riepilogoProcedi() {
	var p_product_detail = _RIEPILOGO_PRODUCT;
	var p_offerta = _RIEPILOGO_OFFER;

	// alert('aaaa'+$('#riepilogo input[name=id_abbonamento]'));
	if ($('#riepilogo input[name=id_abbonamento]').attr('checked')) {
		console.log('hai selezionato ' + (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0 ? 'Ricorrrente' : 'One shot'));

		// Link se è ricorrente o oneshot
		if (parseInt($('#riepilogo input[name=id_abbonamento]:checked').val()) == 0) {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['mensile_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['mensile_url'];
			console.log('ricorrente ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			// 'Ricorrrente' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		} else {

			p_offerta = {};
			p_offerta['offerId'] = _RIEPILOGO_OFFER['annuale_offerId'];
			p_offerta['offerItunesProductId'] = _RIEPILOGO_OFFER['annuale_url'];
			console.log('oneshot ' + p_offerta.offerId + "," + p_offerta.offerItunesProductId);
			// 'One shot' METTERE CODICE
			window.payment.pay(JSON.stringify(p_product_detail), p_offerta.offerId, p_offerta.offerItunesProductId, _USER_IDENTITY);
		}
		$('#riepilogo').css('display', 'none');
	} else {
		alert('Nessuna selezione');
	}
}

/*******************************************************************************
 * Gestione schermata di registrazione
 ******************************************************************************/
var _REGISTRAZIONE_ISCROLL = null;

function popupRegistrazioneApri() {
	if (_LockTap)
		return;
	_LockTap = true;

	// Inizializzazione dei vari campi della registrazione
	$('#registrazione #id_username').val('');
	$('#registrazione #id_password').val('');
	$('#registrazione #id_password_confirm').val('');
	$('#registrazione #id_email').val('');
	$('#registrazione #id_consenso_privacy').attr('checked', false);
	$('#registrazione #id_consenso_email').attr('checked', false);
	$('#registrazione #id_consenso_societa').attr('checked', false);
	$('#registrazione #id_consenso_privacy').change();
	$('#registrazione #id_consenso_email').change();
	$('#registrazione #id_consenso_societa').change();
	$('#registrazione_senza_email').css('display', 'inline-block');
	$('#registrazione_con_email').css('display', 'none');

	$('#registrazione').css('display', 'inline');

	if (_REGISTRAZIONE_ISCROLL == null) {
		_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
			bounce : false
		});
	} else {
		_REGISTRAZIONE_ISCROLL.refresh();
	}

	// Se l'utente inserisce l'indirizzo email deve comparire il link
	// all'informativa sulla privacy
	$('#registrazione #id_email').unbind();
	$('#registrazione #id_email').keyup(function() {
		console.log('keyup');
		if ($('#registrazione #id_email').val() != '') {
			$('#registrazione_senza_email').css('display', 'none');
			$('#registrazione_con_email').css('display', 'inline-block');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();

			if (_REGISTRAZIONE_ISCROLL == null && _ORIENTATION == 'H') {
				_REGISTRAZIONE_ISCROLL = new iScroll('registrazione_body', {
					bounce : false
				});
				_REGISTRAZIONE_ISCROLL.refresh();
			}
		} else {
			$('#registrazione_senza_email').css('display', 'inline-block');
			$('#registrazione_con_email').css('display', 'none');
			if (_REGISTRAZIONE_ISCROLL != null)
				_REGISTRAZIONE_ISCROLL.refresh();
		}
	});
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}

function popupRegistrazioneChiudi() {
	// $('#registrazione').fadeOut();
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAnnulla() {
	// $('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneIndietro() {
	// $('#registrazione').fadeOut();
	_NEXT_ACTION = null;
	$('#registrazione').css('display', 'none');
}

function popupRegistrazioneAvanti() {
	if (controlloDatiRegistrazione()) {

		// Definizione del profilo utente
		var l_username = $('#registrazione #id_username').val();
		var l_password = $('#registrazione #id_password').val();
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : l_username,
			"password" : l_password
		};

		var l_user_email = $('#registrazione #id_email').val();

		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti
		// i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#registrazione #id_consenso_privacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#registrazione #id_consenso_email').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#registrazione #id_consenso_societa').attr('checked') == "checked" ? '1' : '0');
		}

		var l_req_headers = {
			"appKey" : _API24_APPKEY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceName" : device.name,
			"deviceID" : device.uuid,
			"deviceType" : device.platform,
			"profile" : l_user_profile
		};
		console.log('---REQ---> createUser (' + l_username + ')');
		console.log(l_req_headers);
		console.log(l_req_data);
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Registrazione in corso..."]);
		$.ajax({
			type : "POST",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/createUserEDOI",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(res) {
				if ( typeof res == "string") {
					res = $.parseJSON(res);
				}

				console.log('---RESP--> createUser (' + l_username + ')');
				console.log(res);

				if (!res.Success) {
					// navigator.notification.loadingStop();
					window.simulatePG.exec(null, null, "Notification", "activityStop", []);
					// Gestione messaggi di errore dal server
					if (res.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Uno o più campi inseriti non sono validi.', 'Registrazione');
					} else if (res.Exception.Name == 'ExistingUserException') {
						abutils.alert('Lo username è già  utilizzato.', 'Registrazione');
					} else {
						// alert('Attenzione, ' +
						// res.Exception.Description);
						abutils.alert(res.Exception.Description, 'Registrazione');
					}
				} else {
					if (l_user_email == '') {
						abutils.alert("L'indirizzo email ti verrà  richiesto al primo accesso al nostro sito web.", 'Registrazione completata');
					} else {
						abutils.alert("Ti abbiamo inviato una mail per attivare la tua utenza anche per il nostro sito web.", 'Registrazione completata');
					}
					eseguiLogin(l_username, l_password);
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				abutils.alert('Si è verificato un errore durante la registrazione.', 'Registrazione');
			}
		});
	}
}

/**
 * Controlla che i dati inseriti per la registrazione siano corretti, in
 * particolare: - la username non deve contenere caratteri speciali - le
 * password devono coincidere e non devono avere caratteri speciali -
 * l'indirizzo email, se presente, deve essere un indirizzo valido - l'utente
 * deve acconsentire al trattamento dei dati personali in caso di presenza
 * dell'indirizzo email
 */
function controlloDatiRegistrazione() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	var ck_username = /^[A-Za-z0-9_]{3,20}$/;
	/* Min 3 max 20 caratteri */
	var ck_password = /^[A-Za-z0-9!@#$%^*()_]{8,20}$/;
	/* Min 8 max 20 caratteri senza / \ e & */
	// Controllo username
	username = $('#registrazione #id_username').val();
	if (!ck_username.test(username)) {
		abutils.alert('Lo username non può contenere spazi e caratteri speciali. Deve essere lunga tra i 3 ed i 20 caratteri', 'Registrazione');
		return false;
	}

	// Controlli password
	password = $('#registrazione #id_password').val();
	if (password == '') {
		abutils.alert('La password è obbligatoria.', 'Registrazione');
		return false;
	}
	if (!ck_password.test(password)) {
		abutils.alert('La password inserita non è valida.', 'Registrazione');
		return false;
	}
	password_confirm = $('#registrazione #id_password_confirm').val();
	if (password_confirm != password) {
		abutils.alert('Le password inserite non coincidono.', 'Registrazione');
		return false;
	}

	// Controllo email
	email = $('#registrazione #id_email').val();

	// email obbilgatoria
	if (email == '') {
		abutils.alert("L'indirizzo email è obbligatorio.", 'Registrazione');
		return false;
	}

	if (email != '' && !ck_email.test(email)) {
		abutils.alert("L'indirizzo email inserito non è valido.", 'Registrazione');
		return false;
	}

	// console.log('aaa'+$('#registrazione
	// input[name=id_consenso_privacy]').attr('checked'));
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#registrazione input[name=id_consenso_privacy]').attr('checked')) {
		abutils.alert("Per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Registrazione');
		return false;
	}

	return true;
}

/*******************************************************************************
 * Gestione popup di login
 ******************************************************************************/
/**
 * Inizializza e mostra il popup per la login
 *
 * @params p_username Parametro opzionale con il quale inizializzare il campo
 *         username p_force Se impostato a true forza l'utente a non poter
 *         uscire dalla login se non attraverso l'effettuazione della login
 *         stessa
 */
var _POPUP_LOGIN_USERNAME = null;

function popupLogin(p_username, p_force) {
	if (_LockTap)
		return;
	_LockTap = true;
	// alert('bbb');
	_POPUP_LOGIN_USERNAME = p_username;

	// Inizializza lo username se questo viene passato come parametro
	if (p_username) {
		$('#login #id_username').val(p_username);
		$('#login #login_body_message').text(p_username);
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'none');
		$('#login #id_password').val('');
	} else {
		$('#login #id_username').val('');
		$('#login #login_body_message').text('');
		$('#login #login_body_message').css('display', 'none');
		$('#login #login_body_group_username_field').css('display', 'inline-block');
		$('#login #id_password').val('');
	}

	// Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#login_back_button').css('visibility', 'hidden');
	} else {
		$('#login_back_button').css('visibility', 'visible');
	}
	// $('#riepilogo').css('visibility', 'hidden');
	$('#login').css('display', 'inline');

	$('select').attr('disabled', 'disabled');
	setTimeout(function() {
		_LockTap = false;
	}, 500);
}

function popupLoginChiudi() {
	// $('#login').fadeOut();
	$('#login').css('display', 'none');
	$('#login_body_message').text('');

	$('select').removeAttr('disabled');
}

function popupLoginIndietro() {
	// $('#login').fadeOut();
	_NEXT_ACTION = null;
	$('#login').css('display', 'none');

	if (_POPUP_LOGIN_USERNAME != null) {
		// procedo ad una disassociazione del dispositivo
		disassociazioneSilenziosa(_POPUP_LOGIN_USERNAME);
	}

	$('select').removeAttr('disabled');
}

function disassociazioneSilenziosa(p_username) {
	if (p_username == null) {
		p_username = _USERNAME;
	}
	var l_request_data = {
		"username" : p_username, // _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};

	var l_req_headers = {
		"appKey" : _API24_APPKEY
		// ,
		// "userIdentity": _USER_IDENTITY
	};

	console.log('---REQ---> removeUserDevice Silent Login');
	console.log(l_req_headers);
	console.log(l_request_data);

	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> removeUserDevice Silent Login');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {

			} else {

			}

		},
		error : function() {

		}
	});
}

/**
 * Cerca di effettuare la login. In caso di successo memorizza i dati
 * dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupLoginAvanti() {

	if (controlloDatiLogin()) {
		var l_username = $('#login #id_username').val();
		var l_password = $('#login #id_password').val();
		// window.simulatePG.exec(null, null, "Notification", "activityStart", [
		// "Caricamento", "Login in corso..." ]);
		// _EDICOLA_LAST_PRODUCT_LOAD = 0;
		eseguiLogin(l_username, l_password);
	}
}

/**
 * Esegue la chiamata di login verso il server
 */
function eseguiLogin(p_username, p_password, p_silent) {
	console.log('---REQ---> userLogin (' + p_username + ')');
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"siteCode" : _API24_SITECODE,
		"username" : p_username,
		"password" : p_password
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/userLogin",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			setUserData(null, null, null);

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> userLogin');
			console.log(p_response);

			if (checkAjaxResponse(p_response)) {
				// procedo ad una associazione
				console.log("EEE: LOGIN SUCCESSO")
				associaDevice(p_username, p_password, p_response.Result.res, p_silent);
				popupAcquistoRegistrazioneClose();
				// abutils.alert('Login effettuata con successo',
				// 'Login');
				impostazioniVistaClose();
				setTimeout(function() {
					updateOrientation();
					openProductDetails(_PRODUCT_IN_EDICOLA.productId);
				}, 500);
			} else {
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				popupAcquistoRegistrazioneClose();
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// errore in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - login: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					// errore da mostrare
					abutils.alert('Si è verificato un errore durante la login. ' + l_exc_descr, 'Login');
				}

			}
		},
		error : function() {
			// navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - login: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare la login. Riprovare tra poco.', 'Login');
			}
		}
	});
}

/**
 * Associa l'utente al dispositivo
 */
function associaDevice(p_username, p_password, p_useridentity, p_silent) {

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : p_useridentity
		// _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceName" : device.name,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : p_username
		// _USERNAME
	};

	console.log('---REQ---> associauserdevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "POST",
		cache : false,
		contentType : "application/json; charset=utf-8",
		// url: _API24_ENDPOINT + "Users/addUserDevice",
		url : _SOLEGW_ENDPOINT + "associauserdevice.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> associauserdevice');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, associaDevice) || (p_response.Exception.Name == 'UserDeviceRelationException')) {
				setUserData(p_username, p_password, p_useridentity);
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				if (p_silent) {
					onDeviceReady_aux();
				} else {
					popupLoginChiudi();
					popupRegistrazioneChiudi();
					gestisciProssimaAzione();
				}
			} else {
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
				// Gestione eccezioni
				var l_exc_descr = (p_response && p_response.Exception && p_response.Exception.Description) ? p_response.Exception.Description : '';
				if (p_silent) {
					// exception in fase di inizializzazione
					console.log('Errore in fase di inizializzazione - associauserdevice: ' + l_exc_descr);
					abutils.alert('Si è verificato un errore di accesso per l\'utente ' + p_username, 'Errore');
					popupLogin(p_username);
					onDeviceReady_aux();
				} else {
					console.log('associaDevice EXCEPTION ' + p_response.Exception.Name + ': ' + p_response.Exception.Description);
					if ((p_response.Exception.Name != 'UserDeviceRelationException') && (p_response.Exception.Name != 'ExpiredUserIdentityException')) {
						abutils.alert(p_response.Exception.Description, 'Associazione device');
					}
				}

			}

		},
		error : function() {
			// navigator.notification.loadingStop();
			window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			// probabile errore di timeout
			if (p_silent) {
				// timeout in fase di inizializzazione
				console.log('Errore in fase di inizializzazione - associauserdevice: TIMEOUT');
				onDeviceReady_aux();
			} else {
				// errore da mostrare
				abutils.alert('Impossibile effettuare l\'associazione del device. Riprovare tra poco.', 'Login');
			}
		}
	});
}

function controlloDatiLogin() {
	username = $('#login #id_username').val();
	if (username == '') {
		abutils.alert('Attenzione, lo username è obbligatorio.', 'Login');
		return false;
	}

	// Controlli password
	password = $('#login #id_password').val();
	if (password == '') {
		abutils.alert('Attenzione, la password è obbligatoria.', 'Login');
		return false;
	}

	return true;
}

/*******************************************************************************
 * Gestione schermata di login
 ******************************************************************************/
/**
 * Inizializza e mostra il popup per il controllo della password
 *
 * @params p_force Se impostato a true forza l'utente a non poter annullare il
 *         controllo password
 */
function popupControlloPassword(p_force) {

	// Inizializza lo username
	$('#controllo_password #controllo_password_account_username').text(_USERNAME);
	$('#controllo_password #id_password').val('');

	// Rimuove il pulsante "Indietro" se il parametro p_force è true
	if (p_force == true) {
		$('#controllo_password_back_button').css('visibility', 'hidden');
	} else {
		$('#controllo_password_back_button').css('visibility', 'visible');
	}

	$('#controllo_password').css('display', 'inline');

	$('select').attr('disabled', 'disabled');
}

function popupControlloPasswordChiudi() {
	// $('#controllo_password').fadeOut();
	$('#controllo_password').css('display', 'none');

	$('select').removeAttr('disabled');
}

/**
 * Cerca di effettuare la login. In caso di successo memorizza i dati
 * dell'utente altrimenti ritorna errore verso l'utente.
 */
function popupControlloPasswordAvanti() {
	if ($('#controllo_password #id_password').val() != _USER_PASSWORD) {
		abutils.alert('La password non è corretta', 'Attenzione');
	} else {
		popupControlloPasswordChiudi();
		gestisciProssimaAzione();
	}
}

/*******************************************************************************
 * Gestione memorizzazione locale username
 ******************************************************************************/
/**
 * Elimina lo username dell'utente dal local storage
 */
function deleteUsername() {
	window.localStorage.removeItem("username");
}

/**
 * Memorizza lo username dell'utente nel local storage
 *
 * @params p_username Lo username che deve essere memorizzato
 */
function storeUsername(p_username) {
	window.localStorage.setItem("username", p_username);
}

/**
 * Legge lo username dell'utente da local storage
 *
 * @returns String Lo username dell'utente
 */
function getUsername() {
	return window.localStorage.getItem("username");
}

/*******************************************************************************
 * Gestione memorizzazione locale password
 ******************************************************************************/
/**
 * Elimina la password dell'utente dal local storage
 */
function deletePassword() {
	window.localStorage.removeItem("password");
}

/**
 * Memorizza la password dell'utente nel local storage
 *
 * @params p_username La password che deve essere memorizzata
 */
function storePassword(p_password) {
	window.localStorage.setItem("password", p_password);
}

/**
 * Legge la password dell'utente da local storage
 *
 * @returns String La password dell'utente
 */
function getPassword() {
	return window.localStorage.getItem("password");
}

/*******************************************************************************
 * Gestione controllo iniziale username
 ******************************************************************************/
/**
 * Controlla la presenza dello username nel local storage ed in caso controlla
 * che sia lo stesso username associato al dispositivo
 */
function controlloUsername() {
	var l_local_storage_username = getUsername();
	var l_local_storage_password = getPassword();
	console.log('Utente secondo IPAD: ' + l_local_storage_username);
	if (l_local_storage_username != null && l_local_storage_password != null) {
		// procedo direttamente alla login
		// setUserData(null, null, null);
		_NEXT_ACTION = onDeviceReady_aux;
		eseguiLogin(l_local_storage_username, l_local_storage_password, true);
		return;
	}

	// se non ci sono dati in locale chiedo l'eventuale utenza ad API24

	// console.log('Lettura utente associato al dispositivo');
	var l_signature = getSignature(device.uuid + ',' + device.platform);

	console.log('---REQ---> getUserFromDevice');
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log(l_req_headers);
	console.log(l_req_data);

	// Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserFromDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			console.log('---RESP--> getUserFromDevice');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				var l_api24_username = p_response.Result.res;
				console.log('Utente secondo API24: ' + l_api24_username);

				if (l_api24_username != '') {
					_NEXT_ACTION = loadProducts;
					popupLogin(l_api24_username);
					onDeviceReady_aux();
				} else {
					onDeviceReady_aux();
				}
			} else {
				// Gestione eccezioni
				// setUserData(null, null, null);
				onDeviceReady_aux();
				return;
			}
		},
		error : function() {
			// setUserData(null, null, null);
			onDeviceReady_aux();
			return;
		}
	});
}

function popupInformativaPrivacy() {
	// $('#informativa_privacy').fadeIn();
	if (_IMPOSTAZIONI_PROFILO_ISCROLL != null) {
		_IMPOSTAZIONI_PROFILO_ISCROLL.destroy();
		_IMPOSTAZIONI_PROFILO_ISCROLL = null;
	}
	// Viene mostrato il popup
	$('#informativa_privacy').css('display', 'inline');
	if (_IMPOSTAZIONI_ISCROLL_PRIVACY == null)
		_IMPOSTAZIONI_ISCROLL_PRIVACY = new iScroll('informativa_privacy_body');
}

function popupInformativaPrivacyClose() {
	// $('#informativa_privacy').fadeOut();
	$('#informativa_privacy').css('display', 'none');
	if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
		console.log("_IMPOSTAZIONI_PROFILO_ISCROLL is null");
		_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper');
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
	}
}

/*******************************************************************************
 * Gestione inizializzazione database
 ******************************************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 10 * 1024 * 1024;
var _DB = null;
var _DBFAIL = false;

/**
 * Inizializza il database associato all'applicazione
 */
function inizializzaDatabase() {
	console.log("Inizializzazione database");

	if (!window.openDatabase)
		console.log("Error: can't open local database");
	if (!localStorage)
		console.log("Error: localstorage not usable");
	try {
		if (!_DB) {
			console.log("opendatabase " + _DB_NAME + "," + "1.0" + "," + _DB_NAME + "," + _DB_SIZE);
			_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
		}
	} catch (exc) {
		console.log('Errore database ' + exc.message);
		setTimeout(function() {
			try {
				if (window.openDatabase) {
					_DB = null;
					_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
					// window.simulateDB.openDatabase(_DB_NAME,
					// "1.0", _DB_NAME, _DB_SIZE);
					// window.location.assign('index.html');
				} else {
					_DBFAIL = true;

					if (!window.infodroid.isfoglioopen()) {
						window.simulatePG.relaod();
					}
				}
			} catch (exc) {
				console.log('Errore simDB database ' + exc.message);
				_DBFAIL = true;
				if (!window.infodroid.isfoglioopen()) {
					window.simulatePG.relaod();
				}
			}
		}, 500);
	}
	console.log("Inizializzazione database OK");
}

/**
 * Funzione di gestione degli erorri delle operazioni sul database
 */
function dbErrorHandler(p_error) {
	console.log("Error processing SQL: " + p_error);
}

/* -------------------- DOWNLOAD MANAGER ----------------------------------- */
/* ricordarsi di mettere la downloadManagerDBinit() nel deviceready-bodyload */
function downloadManagerDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK downloadManagerDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO downloadManagerDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS issues (id unique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, dttm)', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function addToDownloadQueue(testata, issue, edizione) {
	renderDownloadQueue(testata, issue, edizione);
	// PhoneGap.exec("DownloadManagerCommand.addIssueToDownloadQueue", testata,
	// issue, edizione);
	// window.plugins.flipper24.addIssueToDownloadQueue(null, null, testata,
	// issue, edizione);
	window.soledownloader.launchDownload(testata, edizione, issue, "Descrizione" + window.localStorage.getItem('unread_message_sole'), "" + "aaaa", "false");
	console.log("queue!!!")
}

function getUnreadMessage(testata, edizione, issue) {
	var unread = window.localStorage.getItem('unread_message_sole');
	// alert('aunread is '+unread);
	if (unread != null)
		window.runfunc.retMessage(testata, edizione, issue, unread);
	else
		window.runfunc.retMessage(testata, edizione, issue, 0);
}

function renderDownloadQueue(testata, issue, edizione) {
	// Modifica pulsante
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	btn.show();
	if (btn) {
		$(btn).val('Annulla');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log("EEE: evento click annulla");
			console.log(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " + issue + " " + edizione);
			// alert(";;;;;;;;;; REMOVE FROM QUEUE " + testata + " " +
			// issue + " " + edizione);
			setTimeout(function() {
				removeToDownloadQueue(testata, issue, edizione);
			}, 0);
			/*
			 * setTimeout(function(){
			 * window.soledelete.deleteIssue(testata, issue, edizione);
			 * },1000);
			 */
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'visible';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'white';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-image'] =
		 * '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%,
		 * rgb(255,255,255) 100%)';
		 */
		document
		.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
}

function removeToDownloadQueue(testata, issue, edizione) {
	// PhoneGap.exec("DownloadManagerCommand.removeIssueToDownloadQueue",
	// testata, issue, edizione);
	// window.plugins.flipper24.removeIssueToDownloadQueue(null, null, testata,
	// issue, edizione);
	window.soledownloader.cancelDownload(testata, edizione, issue, "", "", true);
	console.log("remove queue t: " + testata + " ed: " + edizione + " iss: " + issue);

	// Modifica pulsante
	var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
	if (btn) {
		$(btn).val('Salva');
		$(btn).unbind();
		$(btn).bind('click', function() {
			console.log("EEE: evento click salva ");
			console.log(";;;;;;;;;; ADD2 TO QUEUE " + testata + " " + issue + " " + edizione);
			addToDownloadQueue(testata, issue, edizione);
		});
	}

	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'white';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-image'] =
		 * '-webkit-linear-gradient(bottom, rgb(255,255,255) 0%,
		 * rgb(255,255,255) 100%)';
		 */
		document
		.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = '0%';
	}
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSingleFileComplete(testata, issue, edizione, progress) {
	if (!$('#progressbar_status_' + testata + '_' + issue + '_' + edizione).length)
		return;
	
	$('#qarchivio_container .qarchivio_free_copy_btn').hide();
	$('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).show();

	if ($('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione).val().indexOf('Salva') != -1) {
		renderDownloadQueue(testata, issue, edizione);
	}

	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-color'] = 'royalblue';
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['background-image'] = '-webkit-linear-gradient(bottom, rgb(10,43,128) 0%, rgb(99,151,255) 100%)';

	//alert("is "+progress);
	console.log("progress is " + progress);
	document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione).style['width'] = parseInt(progress) + '%';

}

function downloadManagerCallbackSingleFileError(testata, issue, edizione, progress) {
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
}

function downloadManagerCallbackSetComplete(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	if (document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione))
		document.getElementById('qarchivio_container_box_txt_LIST_' + testata + '_' + issue + '_' + edizione).className = 'qarchivio_container_box_txt_local_LIST';
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
	}
	downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr);
	omnitureTrackApp('APP:download:complete:' + testata + ':' + issue + ':' + edizione, 'APP:download');
	$('#qarchivio_container .qarchivio_free_copy_btn').show();
}

function downloadManagerCallbackSaveIssueDb(testata, testata_descr, issue, issue_descr, edizione, edizione_descr) {
	console.log('downloadManagerCallbackSaveIssueDb!!!');
	if (_DB) {
		var querySuccess = function() {
			console.log('OK SAVE LOCAL DB');
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);

			// togliere pulsante scarica e mostrare sfoglia
			var btn = $('#qarchivio_container_box_btn_LIST_' + testata + '_' + issue + '_' + edizione);
			if (btn) {
				$(btn).unbind();
				$(btn).removeClass('gray24');
				$(btn).removeClass('qarchivio_free_copy_btn');
				$(btn).addClass('red24');
				$(btn).val('Sfoglia');
				$(btn).bind('click', function() {
					console.log(";;;;;;;;;; SFOGLIA " + testata + " " + issue + " " + edizione);
					sfoglia(testata, issue, edizione);
					console.log("sfoglia archivio");
					window.loader.local(true);
				});
			}

			// aggiorna dettaglio prodotto se necessario
			refreshProductDetails();
		}
		var queryError = function(tx, p_error) {
			console.log('KO SAVE LOCAL DB ' + p_error.message);
			console.log('TESTATA  ' + testata + ' - ' + testata_descr);
			console.log('ISSUE    ' + issue + ' - ' + issue_descr);
			console.log('EDIZIONE ' + edizione + ' - ' + edizione_descr);
		}
		var executeQuery = function(tx) {
			var idunique = testata + '_' + issue + '_' + edizione;
			console.log('INSERT INTO issues: ' + idunique);
			// tx.executeSql('INSERT INTO issues VALUES("' + idunique + '", "' +
			// testata + '", "' + testata_descr + '", "' + issue + '", "' +
			// issue_descr + '", "' + edizione + '", "' + edizione_descr + '",
			// DATETIME(\'NOW\'));', [], querySuccess, queryError);
			tx.executeSql('INSERT INTO issues VALUES(?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'));', [idunique, testata, testata_descr, issue, issue_descr, edizione, edizione_descr], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function downloadManagerCallbackSetError(testata, issue, edizione) {
	if (document.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('progressbar_' + testata + '_' + issue + '_' + edizione).style['visibility'] = 'hidden';
	if (document.getElementById('progressbar_status_' + testata + '_' + issue + '_' + edizione)) {
		/*
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['background-color'] = 'red';
		 * document.getElementById('progressbar_status_' + testata + '_' + issue +
		 * '_' + edizione).style['width'] = '100%';
		 */
	}
	if (document.getElementById('stop_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('stop_' + testata + '_' + issue + '_' + edizione).style['display'] = 'none';
	if (document.getElementById('download_' + testata + '_' + issue + '_' + edizione))
		document
		.getElementById('download_' + testata + '_' + issue + '_' + edizione).style['display'] = 'inline-block';
}

/* ------------------------- FINE DOWNLOAD MANAGER ---------------------- */

/*******************************************************************************
 * Gestione popup accedi/registrati
 ******************************************************************************/
function popupAccediRegistrati() {
	$('#accedi_registrati_menu').css('display', 'inline-block');
}

function popupAccediRegistratiChiudi() {
	$('#accedi_registrati_menu').css('display', 'none');
}

function popupAccediRegistratiAnnulla() {
	$('#accedi_registrati_menu').css('display', 'none');
	_NEXT_ACTION = null;
}

/*******************************************************************************
 * Ajax COMMONS
 ******************************************************************************/
/**
 * Gestisce il controllo del risultato proveniente dalle richieste Ajax. Le
 * risposte devono essere in formato JSON ed avere almeno l'attributo Success ed
 * eventuali eccezioni.
 *
 * @params p_result La risposta proveniente dal server
 * @returns Boolean False in caso di errori, True in caso di successo
 */
function checkAjaxResponse(p_response, p_callback) {
	if ( typeof p_response == "string") {
		p_response = $.parseJSON(p_response);
	}
	if (p_response.Success) {
		// console.log('Check ajax response OK');
		// console.log(p_response);
		return true;
	} else {
		console.log('Check ajax response KO: [' + p_response.Exception.Name + '] ' + p_response.Exception.Description);
		if (p_response.Exception.Name == 'ExpiredUserIdentityException') {
			if (_USERNAME == null && _USER_PASSWORD == null) {
				console.log('WARNING username e/o password non settati, impossibile procedere al rinnovo della useridentity');
				setUserData(null, null, null);
				return false;
			}
			console.log('GESTIONE ExpiredUserIdentityException');
			console.log('---REQ---> userLogin4ExpiredUserIdentityException(' + _USERNAME + ')');
			var l_username = _USERNAME;
			var l_user_password = _USER_PASSWORD;
			var l_req_headers = {
				"appKey" : _API24_APPKEY
			};
			var l_req_data = {
				"siteCode" : _API24_SITECODE,
				"username" : l_username,
				"password" : l_user_password
			};
			console.log(l_req_headers);
			console.log(l_req_data);
			// resetto username e password
			/*
			 * _USERNAME = null; _USER_PASSWORD = null;
			 */
			setUserData(null, null, null);

			$.ajax({
				type : "GET",
				timeout : _AJAX_TIMEOUT,
				cache : false,
				contentType : "application/json; charset=utf-8",
				url : _API24_ENDPOINT + "Users/userLogin",
				headers : l_req_headers,
				data : l_req_data,
				dataType : "json",
				success : function(p_response) {

					if ( typeof p_response == "string") {
						p_response = $.parseJSON(p_response);
					}

					console.log('---RESP--> userLogin4ExpiredUserIdentityException');
					console.log(p_response);

					if (checkAjaxResponse(p_response)) {
						setUserData(l_username, l_user_password, p_response.Result.res);
						if (p_callback != null)
							p_callback.call();
						else
							console.log('WARNING userLogin4ExpiredUserIdentityException completata, ma manca la callback');
					} else {
						console.log('WARNING userLogin4ExpiredUserIdentityException error');
					}
				},
				error : function() {
					console.log('WARNING userLogin4ExpiredUserIdentityException timeout');
				}
			});
		}
		return false;
	}
}

/**
 * Callback generica per la gestione degli errori di comunicazione verso le
 * API24
 */
function ajaxErrorHandler(xmlHttpRequest, textStatus, errorThrown) {
	console.log('Ajax error: ' + textStatus);
	// enableOfflineMode();
}

/**
 * Inizializza il controllo per la gestione online/offline
 */
var _OFFLINE_COUNTER = null;
// var _PING_COUNTER = 0;
function testConnectionWorker() {
	// _PING_COUNTER++;
	if (_OFFLINE_COUNTER == null)
		_OFFLINE_COUNTER = 1;
	// al primo avvio il primo risultato è quello buono

	console.log('---REQ---> PING');
	// 	var l_req_headers = {
	// 		"appKey" : _API24_APPKEY
	// 	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	// console.log(l_req_headers);
	// console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT_PING,
		//headers : l_req_headers,
		data : l_req_data,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + 'ping.json',
		dataType : "json",
		beforeSend : function(request) {
			request.setRequestHeader("appKey", _API24_APPKEY);
		},
		success : function(p_response) {
			// console.log('---RESP--> PING');
			console.log(p_response);
			try {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				if (checkAjaxResponse(p_response) && (p_response.Result.res.statusCode == 0)) {
					enableOnlineMode();
					_OFFLINE_COUNTER = 0;
				} else {
					_OFFLINE_COUNTER++;
					if (_OFFLINE_COUNTER >= 2) {
						enableOfflineMode();
					}
				}
			} catch (exc) {
				// console.log('errore formato risposta');
				_OFFLINE_COUNTER++;
				if (_OFFLINE_COUNTER >= 2) {
					enableOfflineMode();
				}
			}
		},
		error : function() {
			// console.log('ajax error');
			_OFFLINE_COUNTER++;
			if (_OFFLINE_COUNTER >= 2) {
				enableOfflineMode();
			}
		}
	});
}

function initCheckOnline() {
	testConnectionWorker();
	setInterval(function() {
		testConnectionWorker();
	}, _INTERVALLO_CHECK_ONLINE);
}

/**
 * Gestisce l'esecuzione della prossima azione. Alcune volte al termine delle
 * azioni su una popup è necessario eseguire un azione. Per fare ciÃ² viene
 * impostata la variabile _NEXT_ACTION alla funzione che deve essere richiamata.
 * La seguente funzione controlla che ci sia una prossima azione ed in caso la
 * esegue.
 */
function gestisciProssimaAzione() {
	// Se la variabile _NEXT_ACTION è inizializzata chiama la funzione
	// associata
	if (_NEXT_ACTION && typeof _NEXT_ACTION == "function") {
		var l_next_action = _NEXT_ACTION;
		_NEXT_ACTION = null;
		l_next_action.call();
	}
}

/* --------- gestione bottoni appmenu -------------------- */
function appmenuButtonReset() {
	$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
	$('#appmenu_edicola').removeClass('appmenu_edicola_on');
	$('#appmenu_preferiti').removeClass('appmenu_preferiti_on');
	$('#appmenu_inbox').removeClass('appmenu_inbox_on');
	$('#appmenu_impostazioni').removeClass('appmenu_impostazioni_on');
}

function appmenuSfoglioOpen() {
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
	var l_ret = openFlipper();
	if (!l_ret) {
		$('#appmenu_sfoglio').removeClass('appmenu_sfoglio_on');
		abutils.alert('Nessuna pubblicazione è ancora stata aperta.', 'Sfoglia');
		return;
	}
	appmenuButtonReset();
	$('#appmenu_sfoglio').addClass('appmenu_sfoglio_on');
}

function appmenuEdicolaOpenWithIndice(testata, edizione) {
	appmenuEdicolaOpen(true);
	try {
		var l_product_id = _HASH_MAP_TESTATA_PRODUCTID[testata];
		console.log(testata + ' ---> ' + l_product_id);
		if (l_product_id == null)
			return;
		// qarchivioOpen(l_product_id, true, edizione);
		if (l_product_id == _CODICE_PRODOTTO_QUOTIDIANO)
			qarchivioOpen(l_product_id, true, edizione);
		else
			archivioOpen(l_product_id, true);
	} catch (exc) {

	}
}

function appmenuEdicolaOpen(skipFlipper) {

	if (!skipFlipper && _CURRENT_FLIPPER_TESTATA != null && _CURRENT_FLIPPER_ISSUE != null && _CURRENT_FLIPPER_EDIZIONE != null) {
		openFlipper();
		setTimeout(function() {
			appmenuEdicolaOpen(true);
		}, 2000);
		return;
	}

	if (_MOD_OFFLINE != true) {
		loadProducts();
	}

	appmenuButtonReset();
	$('#appmenu_edicola').addClass('appmenu_edicola_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(0px, 0px, 0)');

	$('#edicola_titolo_btn_select').removeAttr('disabled');

	/*
	 * console.log("FFF: edicola_prodotto"+$('#edicola').css("display"));
	 * console.log("FFF:
	 * edicola_prodotto"+$('#edicola_prodotto').css("display"));
	 * console.log("FFF:
	 * edicola_catalogo"+$('#edicola_prodotto').css("display")); if
	 * ($('#edicola_prodotto').css("display")=='none'){ console.log("FFF: entro
	 * nello show") edicolaProdottoTornaEdicola();
	 * edicolaProdottoTornaEdicola(); } else { console.log("FFF: non entro nello
	 * show") } console.log("FFF:
	 * edicola_prodotto"+$('#edicola').css("display")); console.log("FFF:
	 * edicola_prodotto"+$('#edicola_prodotto').css("display"));
	 * console.log("FFF:
	 * edicola_catalogo"+$('#edicola_prodotto').css("display"));
	 */
	omnitureTrackApp("APP:edicola", "APP:edicola");
	nielsenCall('EDICOLA');
}

function appmenuPreferitiOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	preferitiLoadMenuProdotto();
	appmenuButtonReset();
	$('#appmenu_preferiti').addClass('appmenu_preferiti_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-3000px, 0px, 0)');

	omnitureTrackApp("APP:preferiti", "APP:preferiti");
	nielsenCall('PREFERITI');
}

function appmenuInboxOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	$('#appmenu_inbox').addClass('appmenu_inbox_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-6000px, 0px, 0)');

	omnitureTrackApp("APP:inbox", "APP:inbox");
	nielsenCall('INBOX');
}

function appmenuImpostazioniOpen() {
	$('#edicola_titolo_btn_select').attr('disabled', 'disabled');
	appmenuButtonReset();
	impostazioniInizializza();
	impostazioniOpen();
	$('#appmenu_impostazioni').addClass('appmenu_impostazioni_on');
	$('#centrale_container').css('-webkit-transform', 'translate3d(-9000px, 0px, 0)');

	omnitureTrackApp("APP:impostazioni", "APP:impostazioni");
}

/* ----------------------------------------------------------------- */
function injectAutoLogin(username, password) {
	if (username == null || password == null)
		return "KO";
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

	_NEXT_ACTION = function() {
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Aggiornamento in corso..."]);

		setTimeout(function() {
			window.location = 'galaxy.html';
		}, 1000);
	}
	eseguiLogin(username, password);

	return "OK";
}

function checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback) {
	console.log('--->checkAcquisto');
	if (p_prodotto24 == '1') {
		// android workaround temporaneo
		p_prodotto24 = 'a1';
	}

	var local = window.verify.Local(_MAP_CODICE_TESTATA[p_prodotto24 + ''], p_issue, p_edizione);
	console.log("local is " + local);
	if (local == '1') {
		if (callback && typeof callback == "function") {
			console.log("aaaa passsq");
			callback.call();
			return;
		}
	}
	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"date" : p_issue
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	console.log('--REQ---> checkAcquisto(' + p_prodotto24 + ')');
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "checkacquisto/" + p_prodotto24 + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('--RESP--> checkAcquisto(' + p_prodotto24 + ')');
			console.log('checkAcquisto resp ' + /* JSON.stringify( */p_response /* ) */);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				checkAcquisto(p_prodotto24, p_issue, p_edizione, id_shopping24, id_itunes, callback);
			})) {
				console.log('check ' + p_response.Result.res);

				if (p_response.Result.res && p_response.Result.res.checkAcquisto && (p_response.Result.res.checkAcquisto == true)) {
					// navigator.notification.confirm('Hai giÃ
					// acquistato questa edizione: il nuovo download è
					// gratuito.', function(button){
					if (callback && typeof callback == "function") {
						console.log("Aquisto-->pass to func");
						callback.call();
					}
					// }, 'Acquisto non necessario', 'Ok');
				} else {
					// appstoreBuy(id_shopping24, id_itunes, callback);
					// BUY-----------------------------------------------------------------------------------------

					console.log('buy');
					console.log("aaaa passsq1");
					var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
					var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
					var link_singola = '';
					console.log('productId ' + productId);
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
					// prova con i link
					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
							}
						}
					}

					if (link_singola != '') {
						window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				}
			} else {
				if (p_response.Exception.Name == 'ExpiredUserIdentityException')
					return;
				// appstoreBuy(id_shopping24, id_itunes, callback);
				// BUY---------------------------------------------------------------------------------------------
				console.log('buy');
				console.log("aaaa passsq2");
				var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
				var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];

				var link_singola = '';
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}

				// prova con i link
				if (!link_singola || link_singola == '') {
					_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
						if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
						}
					}
				}
				if (link_singola != '') {
					window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
				} else {
					abutils.alert('Errore su link!', 'Pagamento');
				}
			}
		},
		error : function() {
			// appstoreBuy(id_shopping24, id_itunes, callback);
			// BUY-------------------------------------------------------------------------------------------------
			console.log('buy');
			console.log("aaaa passsq3");
			var testata = _MAP_CODICE_TESTATA[p_prodotto24 + ''];
			var productId = _HASH_MAP_TESTATA_PRODUCTID[testata];
			var link_singola = '';
			for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
				if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
					link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
				}
			}
			// prova con i link
			if (!link_singola || link_singola == '') {
				_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'] = _PRODUCTLINK;
				for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'].length; j++) {
					if (_EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType'] == 'link_singola') {
						link_singola = _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['url'];
					}
				}
			}
			if (link_singola != '') {
				window.payment.paySingle(testata, p_edizione, p_issue, id_shopping24, id_itunes, link_singola);
			} else {
				abutils.alert('Errore su link!', 'Pagamento');
			}
		}
	});
}/**

 * @author ABertacco, MConventi
 */
var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;
var _PREFERITI_ISCROLL_MENU = null;
var _PREFERITI_ISCROLL_VISTA = null;
var _PREFERITI_ISCROLL_DETTAGLIO = null;

// Lista di prodotti da inserire nel menu di sinistra tra i prodotti
/*
 * viene calcolata in base agli articoli presenti in db var
 * _PREFERITI_PRODUCTS_LIST = [ { testata: 'S24', nome: "Il Sole 24 ORE", icon:
 * 'imgs/fake/s24_small_icon.png' } ];
 */
var _PREFERITI_PRODUCTS_LIST = null;

function preferitiLoadMenuTag() {
	preferitiLoadMenu('TAG');
}

function preferitiLoadMenuProdotto() {
	preferitiLoadMenu('PRODOTTO');
}

function preferitiLoadMenu(mode) {
	$('#preferiti_titolo_menu_opzioni_prodotto').removeClass('newgray24');
	$('#preferiti_titolo_menu_opzioni_tag').removeClass('newgray24');
	$('#preferiti_body_menu_container').empty();

	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.destroy();
		_PREFERITI_ISCROLL_MENU = null;
	}

	if (mode == 'PRODOTTO') {
		$('#preferiti_titolo_menu_opzioni_prodotto').addClass('newgray24');
		preferitiInitProductList();
	} else {
		$('#preferiti_titolo_menu_opzioni_tag').addClass('newgray24');
		preferitiInitTagList();
	}

}

function searchPref(search) {
	console.log('search is ' + search);

	/*
	 * db.transaction(function(tx) { tx.executeSql("SELECT id FROM table LIMIT
	 * 1", [], function(tx, result) { row = result.rows.item(0); }, function(tx,
	 * error) { }); });
	 *
	 * return row;
	 *
	 */
	if (search == null)
		return;

	if (_DB) {
		_DB.transaction(function(tx) {
			// 'occhiello text, titolo text, sottotitolo text, firma
			// text, testo text';
			var l_query = 'occhiello like ? OR titolo like ? OR sottotitolo like ? OR firma like ? OR testo like ?';
			var tmpsearch = search.split(' ');
			var s = '';
			// GLOBAL REPLACE
			// DA FARE
			var args = new Array(tmpsearch.length * 5);
			for (var i = 0; i < tmpsearch.length; i++) {
				if (i > 0)
					l_query += " OR " + l_query;
				s = tmpsearch[i];
				// "4,250%";
				s = s.replace(/%/g, "\\%");
				s = s.replace(/_/g, "\\_");
				s = s.replace(/&rsquo;/g, "\'");
				s = s.replace(/&quot;/g, "\"");
				s = "%" + s + "%";
				for (var j = i * 5; j < (i + 1) * 5; j++)
					args[j] = s;
				console.log("search2323 selec " + s);
			}
			search = "%" + search + "%";
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE ' + l_query + " escape '" + "\\" + "' order by issue DESC, pagina ;", args, function(tx, p_results) {
				var row = null;
				if (p_results != null && p_results.rows.length != 0) {
					for (var irow = 0; irow < p_results.rows.length; irow++) {
						row = p_results.rows.item(irow);
						// console.log("testo[0]
						// "+row.testo);
						// 'artid text unique, testata
						// text, testata_descr text,
						// issue text, issue_descr text,
						// edizione text, edizione_descr
						// text, sezione text, pagina
						// text, occhiello text, titolo
						// text, sottotitolo text, firma
						// text, testo text, dttm, tags
						// text';
						window.searchlaunch.addResult(row.artid, row.testata, row.testata_descr, row.issue, row.issue_descr, row.edizione, row.edizione_descr, row.sezione, row.pagina, row.occhiello, row.titolo, row.sottotitolo, row.firma, row.testo);
						row = null;
					}

					window.searchlaunch.broadcastResult();
				} else {
					console.log('search res ' + p_results);
					window.searchlaunch.broadcastResult();
				}

			}, function(tx, error) {
				alert(error);
			});

		});

		// _DB.transaction(querySearch);

	}
}

function getArticleFromId(artid) {
	console.log("DDD: getArticleFromId " + artid);
	if (_DB) {
		_DB.transaction(function(tx) {

			console.log("DDD: getArticleFromId_table: " + _PREFERITI_ARTICLE_DB_NAME);
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid = ? ;', [artid], function(tx, p_results) {
				var row = null;
				console.log("DDD: getArticleFromId_lenght: " + p_results.rows.length);
				if (p_results != null && p_results.rows.length != 0) {
					console.log("DDD: getArticleFromId_1 ");
					preferitiDettaglio(p_results.rows.item(0));
				} else {

					console.log("DDD: getArticleFromId_2 ");
					console.log('search res ' + p_results);
				}

			}, function(tx, error) {
				alert(error);
			});

		});

	}
}

/**
 * Crea gli elementi per un singolo articolo
 *
 * @params p_article Oggetto articolo cosÃ¬ come definito nel database locale
 */
function renderPreferitiArticle(p_article) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_vista_container').appendChild(box);
	box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
	box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
	box.onclick = function() {
		console.debug("click renderPreferitiArticle");
		if (dentro_click == 0) {
			if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
				popupPreferitiUpdateArticle(p_article);
			} else {
				preferitiDettaglio(p_article);
			}
		}
	};

	var boxtb = document.createElement('table');
	box.appendChild(boxtb);

	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);

	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);

	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);

	var status_box = document.createElement('div');
	boxtd1.appendChild(status_box);
	status_box.className = 'preferiti_body_vista_container_box_status';
	// Gestisce la selezione dei preferiti quando l'utente si trova nella
	// tipologia "modifica"
	status_box.onclick = function(e) {
		e.stopPropagation();

		if (_LockTap)
			return;
		_LockTap = true;

		var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));

		if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
			l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
			l_message_header.addClass('preferiti_body_vista_container_box_status_selected');

		} else if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
			l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
			l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
		}

		setTimeout(function() {
			_LockTap = false;
		}, 500);
	};

	if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
		status_box.style.display = 'block';
	}
	status_box = null;

	var title = document.createElement('div');
	boxtd2.appendChild(title);
	title.className = 'preferiti_body_vista_container_box_title';
	title.appendChild(document.createTextNode(p_article.titolo));
	title = null;

	var descr = document.createElement('div');
	boxtd2.appendChild(descr);
	descr.className = 'preferiti_body_vista_container_box_descr';
	descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
	descr = null;

	var tags = document.createElement('div');
	boxtd2.appendChild(tags);
	tags.className = 'preferiti_body_vista_container_box_tags';
	// tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags
	// + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
	tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
	tags = null;

	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei prodotti in base ai
 * dati inseriti in _PREFERITI_PRODUCTS_LIST
 */
function preferitiInitProductList() {
	/*
	 * for (var i=0; i < _PREFERITI_PRODUCTS_LIST.length; i++){
	 * preferitiMenuRenderProduct(_PREFERITI_PRODUCTS_LIST[i]); } if
	 * (_PREFERITI_ISCROLL_MENU == null) { _PREFERITI_ISCROLL_MENU = new
	 * iScroll('preferiti_body_menu_wrapper'); } else {
	 * _PREFERITI_ISCROLL_MENU.refresh(); }
	 */
	_PREFERITI_PRODUCTS_LIST = [];

	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_row = p_results.rows.item(i);
				preferitiMenuRenderProduct({
					testata : l_row.testata,
					nome : l_row.testata_descr,
					icon : 'imgs/fake/s24_small_icon.png' // icona
					// indipendente
					// dalla testata
				});
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}

			/*
			 * if (p_results.rows.length > 0) { // apro il primo elemento nel
			 * menu
			 * preferitiLoadArticlesByProduct(p_results.rows.item(0).testata); $(
			 * '#preferiti_body_menu_container_box_id_' +
			 * p_results.rows.item(0).testata.replace( /[^a-zA-Z0-9]+/g,
			 * '')).click(); }
			 */
		}
		var queryError = function(p_error) {
			console.log("preferitiInitProductList: Error processing SQL: " + p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			var l_query = 'SELECT testata, testata_descr FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' GROUP BY testata, testata_descr ORDER BY testata_descr';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	} else {
		// TEST DA RIMUOVRE
		preferitiMenuRenderProduct({
			testata : "TESTATA",
			nome : "Descrizione della testata",
			icon : 'imgs/fake/s24_small_icon.png'
		});
	}
}

/**
 * Crea un elemento prodotto nel menu a sinistra della finestra dei preferiti
 *
 * @params p_product Oggetto tag cosÃ¬ come presente in _PREFERITI_PRODUCTS_LIST
 */
function preferitiMenuRenderProduct(p_product) {

	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_box';
	box.id = 'preferiti_body_menu_container_box_id_' + p_product.testata.replace(/[^a-zA-Z 0-9]+/g, '');

	box.appendChild(document.createTextNode(p_product.nome));

	var icon = document.createElement('img');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_box_icon';
	icon.src = p_product.icon;

	box.onclick = (function(event) {
		dentro_click = 1;
		event.preventDefault();
		preferitiLoadArticlesByProduct(p_product.testata);

		$('.preferiti_body_menu_container_box').removeClass('preferiti_body_menu_container_box_active');
		$(this).addClass('preferiti_body_menu_container_box_active');
		$('#preferiti_body_vista_wrapper').css("left", "0");
		$('#buttonBackPreferiti').show();
		$('#preferiti_titolo_vista_opzioni').show();
		$('#preferiti_titolo_menu_opzioni').hide();
		setTimeout(function() {
			dentro_click = 0;
		}, 1000);
	});
}

/**
 * Inizializza il menu di sinistra inserendo la lista dei tag attualmente nel
 * database dei preferiti
 */
function preferitiInitTagList() {

	// Inizializza la lista dei tag nel menu di sinistra
	if (_DB) {
		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length == 0) {
				document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
			}

			for (var i = 0; i < p_results.rows.length; i++) {
				preferitiMenuRenderTag(p_results.rows.item(i));
			}

			if (_PREFERITI_ISCROLL_MENU == null) {
				_PREFERITI_ISCROLL_MENU = new iScroll('preferiti_body_menu_wrapper');
			} else {
				_PREFERITI_ISCROLL_MENU.refresh();
			}
			/*
			 * if (p_results.rows.length > 0) { // apro il primo elemento nel
			 * menu $( '#preferiti_body_menu_container_boxtag_id_' +
			 * p_results.rows.item(0).nome.replace( /[^a-zA-Z0-9]+/g,
			 * '')).click(); }
			 */
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			document.getElementById('preferiti_body_menu_container').innerHTML = '<div class="preferiti_body_menu_container_empty">Nessun Preferito salvato.</div>';
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
			// var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM
			// '+_PREFERITI_TAG_DB_NAME+' GROUP BY nome ORDER BY num_articles';
			var l_query = 'SELECT nome FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY nome';
			tx.executeSql(l_query, [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Crea un elemento tag nel menu a sinistra della finestra dei preferiti
 *
 * @params p_tag Oggetto tag cosÃ¬ come presente nel db _PREFERITI_TAG_DB_NAME
 */
function preferitiMenuRenderTag(p_tag) {
	var box = document.createElement('div');
	document.getElementById('preferiti_body_menu_container').appendChild(box);
	box.className = 'preferiti_body_menu_container_boxtag';
	box.id = 'preferiti_body_menu_container_boxtag_id_' + p_tag.nome.replace(/[^a-zA-Z0-9]+/g, '');
	box.appendChild(document.createTextNode(p_tag.nome));

	var icon = document.createElement('div');
	box.appendChild(icon);
	icon.className = 'preferiti_body_menu_container_boxtag_icon';

	box.onclick = (function() {
		dentro_click = 1;
		preferitiLoadArticlesByTag(p_tag.nome);

		// Setta il tag attivo nel menu di sinistra
		$('.preferiti_body_menu_container_boxtag').removeClass('preferiti_body_menu_container_boxtag_active');
		$('.preferiti_body_menu_container_boxtag_icon').removeClass('preferiti_body_menu_container_boxtag_icon_active');
		$(this).addClass('preferiti_body_menu_container_boxtag_active');
		var icon = this.querySelector('div.preferiti_body_menu_container_boxtag_icon');
		if (icon != null) {
			$(icon).addClass('preferiti_body_menu_container_boxtag_icon_active');
		}
		$('#preferiti_body_vista_wrapper').css("left", "0");
		$('#buttonBackPreferiti').show();
		$('#preferiti_titolo_vista_opzioni').show();
		$('#preferiti_titolo_menu_opzioni').hide();
		setTimeout(function() {
			dentro_click = 0;
		}, 1000);
	});
}

/**
 * Crea la lista di articoli salvati come preferiti.
 *
 * @params p_articles Array di articoli cosÃ¬ come definiti nel db locale
 *         _PREFERITI_ARTICLE_DB_NAME
 */
function preferitiOpenArticlesList(p_articles) {
	/*
	 * if (_PREFERITI_ISCROLL_VISTA != null) {
	 * _PREFERITI_ISCROLL_VISTA.destroy(); _PREFERITI_ISCROLL_VISTA = null; }
	 */

	$('#preferiti_body_vista_container').empty();

	for (var i = 0; i < p_articles.length; i++) {
		renderPreferitiArticle(p_articles.item(i));
	}

	if (_PREFERITI_ISCROLL_VISTA == null) {
		_PREFERITI_ISCROLL_VISTA = new iScroll('preferiti_body_vista_wrapper');
	} else {
		_PREFERITI_ISCROLL_VISTA.refresh();
		// alert('aaaaa');
		_PREFERITI_ISCROLL_VISTA.scrollTo(0, -2, 0);
	}
	// $('#preferiti_body_vista_wrapper').css("left", "0");
}

/**
 * Passa alla modalitÃ modifica preferiti
 */
function preferitiSwitchToModifyView() {
	$('#preferiti_list_modify_button').hide();
	$('#preferiti_list_show_button').show();
	$('#preferiti_body_vista_container').addClass('preferiti_modify_view');
	$('.preferiti_body_vista_container_box_status').fadeIn();
	$('#elimina_preferiti').fadeIn();
}

/**
 * Passa alla modalitÃ visualizza preferiti
 */
function preferitiSwitchToShowView() {
	$('#preferiti_list_show_button').hide();
	$('#preferiti_list_modify_button').show();
	$('.preferiti_body_vista_container_box_status').hide();

	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	l_selected_items.removeClass('preferiti_body_vista_container_box_status_selected');
	l_selected_items.addClass('preferiti_body_vista_container_box_status_unselected');

	$('#preferiti_body_vista_container').removeClass('preferiti_modify_view');
	$('#elimina_preferiti').fadeOut();
}

/*******************************************************************************
 * Gestione eliminazione preferiti
 ******************************************************************************/
/**
 * Elimina i record selezionati in modalitÃ modifica
 */
function preferitiDeleteArticles() {
	var l_selected_items = $('.preferiti_body_vista_container_box_status_selected');
	var l_items = '';

	for (var i = 0; i < l_selected_items.length; i++) {
		var l_pid = l_selected_items[i].id.substring(35);
		if (i > 0)
			l_items += ',';
		l_items += '"' + l_pid + '"';
	}

	if (l_items != '') {
		deletePreferitiFromDB(l_items);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun articolo', 'Preferiti');
	}
}

/*
 * Elimina i record dal database @params p_artids Lista dei identificativi degli
 * articoli
 */
function deletePreferitiFromDB(p_artids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB && p_artids.length > 0) {

		var queryArticleSuccess = function() {
			console.log('Deleted preferiti ' + p_artids);
			deletePreferitiElements();
		}
		var queryTagSuccess = function() {
			console.log('Deleted tags ' + p_artids);
		}
		var queryError = function(p_error) {
			console.log("deletePreferitiFromDB: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryArticleSuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid in (' + p_artids + ')', [], queryTagSuccess, queryError);

			// queryArticleSuccess();
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Elimina gli elementi html relativi agli articoli preferiti
 *
 * @params p_pids Lista degli identificativi degli articoli che devono essere
 *         eliminati
 */
function deletePreferitiElements() {
	$('.preferiti_body_vista_container_box_status_selected').remove();
}

/*******************************************************************************
 * Gestione caricamento preferiti
 ******************************************************************************/
/*
 * Restituisce gli articoli preferiti presenti nel database locale @params
 * p_testata Identificativo del prodotto @return Lista di articoli
 */
function preferitiLoadArticlesByProduct(p_testata) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_testata) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticles: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE testata=?', [p_testata], querySuccess, queryError);
		}
		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}

}

/*
 * Restituisce gli articoli preferiti presenti nel database locale in base ad un
 * tag @params p_tag Il nome del tag @return Lista di articoli
 */
function preferitiLoadArticlesByTag(p_tag) {

	// Controlla che il database sia stato inizializzato e carica gli articoli
	if (_DB && p_tag) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " articles from the local PREFERITI store.");

			preferitiOpenArticlesList(p_results.rows);
		}
		var tagQuerySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			console.log("Read " + len + " tags from the local TAG table.");
			var l_articles = '';
			for (var i = 0; i < p_results.rows.length; i++) {
				if (i > 0)
					l_articles += ',';
				l_articles += '"' + p_results.rows.item(i).artid + '"';
			}
			console.log("Read " + l_articles);

			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')');
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid IN (' + l_articles + ')', [], querySuccess, queryError);
		}
		var queryError = function(p_error) {
			console.log("preferitiLoadArticlesByTag: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			console.log("tag: " + p_tag);
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
			tx.executeSql('SELECT artid FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE nome=?', [p_tag], tagQuerySuccess, queryError);
		}
		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

function preferitiCloseArticles() {
	$('.preferiti_body_menu_container_box_active').removeClass("preferiti_body_menu_container_box_active");
	$('#preferiti_body_vista_wrapper').css("left", "100%");
	$('#buttonBackPreferiti').hide();
	$('#preferiti_titolo_vista_opzioni').hide();
	$('#preferiti_titolo_menu_opzioni').show();

}

/*******************************************************************************
 * Gestione popup modifica preferiti
 ******************************************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 *
 * @params p_article Oggetto articolo cosÃ¬ come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {
	// $('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').text(p_article.titolo);
		$('#modifica_articolo_preferito_text').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
		// $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id_tags').val($('#preferiti_body_vista_container_box_tags_span_' + p_article.artid).html());
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for (var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
				}
			}
			var queryError = function(p_error) {
				console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo
 * preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();

	// Salva le modifiche
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
		}
		var updateQuerySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			/*
			 * if (p_results.rowsAffected > 0) {
			 * document.getElementById('preferiti_body_vista_container_box_tags_' +
			 * l_artid).innerHTML = 'Tags: ' + l_tags; }
			 */
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);

			var l_tags_array = l_tags.toLowerCase().split(',');
			for (var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, "");
				// TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
			}
		}
		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}

	var l_tags_el = document.getElementById('preferiti_body_vista_container_box_tags_span_' + l_artid);
	if (l_tags_el) {
		l_tags_el.innerHTML = l_tags;
	}
	l_tags_el = null;

	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	// $('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

/*******************************************************************************
 * Gestione Dettaglio Preferiti
 ******************************************************************************/
/**
 * Apre il dettaglio dei preferiti
 */
function preferitiDettaglio(p_article) {
	console.log("DDD: preferitiDettaglio " + JSON.stringify(p_article))
	// Inizializzazione dati articolo
	$('#preferiti_dettaglio_titolo').text(p_article.titolo);
	$('#preferiti_dettaglio_occhiello').text(p_article.occhiello);
	$('#preferiti_dettaglio_sottotitolo').text(p_article.sottotitolo);
	$('#preferiti_dettaglio_other_info').html('<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
	$('#preferiti_dettaglio_firma').text(p_article.firma);
	$('#preferiti_dettaglio_text').html(p_article.testo);
	$('#preferiti_dettaglio_header_modifica input').click(function() {
		popupPreferitiUpdateArticle(p_article);
	});

	// $('#preferiti_dettaglio').fadeIn(200, function(){
	$('#preferiti_dettaglio').css('display', 'inline-block');

	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	} else {
		_PREFERITI_ISCROLL_DETTAGLIO = new iScroll('preferiti_dettaglio_wrapper');
	}
	// });

	omnitureTrackApp('APP:preferiti:open:' + p_article.artid, 'APP:preferiti');
}

/**
 * Chiude il dettaglio dei preferiti
 */
function preferitiDettaglioChiudi() {
	// $('#preferiti_dettaglio').fadeOut(200);
	$('#preferiti_dettaglio').css('display', 'none');
}

function preferitiUpdateOrientation() {
	if (_PREFERITI_ISCROLL_VISTA != null) {
		_PREFERITI_ISCROLL_VISTA.refresh();
	}
	if (_PREFERITI_ISCROLL_MENU != null) {
		_PREFERITI_ISCROLL_MENU.refresh();
	}
	if (_PREFERITI_ISCROLL_DETTAGLIO != null) {
		_PREFERITI_ISCROLL_DETTAGLIO.refresh();
	}
}

/**
 * @author ABertacco FSantagada
 */
var _ARCHIVIO_ISOPEN = false;
var _ARCHIVIO_RENDERED_ITEMS = null;
var _PROID = null;
function archivioOpen(p_product_id, isFromSfoglio) {
	_ARCHIVIO_ISOPEN = true;

	_PROID = p_product_id;

	archivioLoad(p_product_id);
	// archivioLoad();
	archivioLoadAdv(p_product_id);

	// Inizializzazione filtro edizioni
	archivioInitFilter();

	$('#archivio_titolo_chiudi_edicola').css('display', (isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#archivio_titolo_chiudi_sfoglio').css('display', (isFromSfoglio == true ? 'inline-block' : 'none'));

	// $('#archivio').fadeIn();
	$('#archivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function archivioClose() {
	// $('#archivio').fadeOut();
	$('#archivio').css('display', 'none');
	if (_ARCHIVIO_ISCROLL != null) {
		_ARCHIVIO_ISCROLL.destroy();
		_ARCHIVIO_ISCROLL = null;
	}
	_ARCHIVIO_ISOPEN = false;
}

function archivioCloseSfoglia() {
	// appmenuSfoglioOpen();
	openFlipper();
}

function archivioLoadAdv(p_product_id) {
	document.getElementById('archivio_footer_adv').innerHTML = '';
	// $('#qarchivio_footer_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/'
	// + device.uuid + '@Bottom', function(){
	// }).endCapture();
	// http://mobapp24.ilsole24ore.com/adv_proxy.php?z=SFO_INTERSTITIAL&t=S24&d=123

	// *********************DA SOSTITUIRE!!!!!!************************
	$('#archivio_footer_adv').writeCapture().load(
	/*
	 * 'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' +
	 * device.uuid + '@Bottom'
	 */_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d=' + device.uuid + '&s=' + _SCREENADV, function() {
	}).endCapture();
}

function archivioLoadTutti() {
	// archivioModificaFine();
	archivioLoadMenu('TUTTI');
}

function archivioLoadAcquisti() {
	archivioLoadMenu('ACQUISTI');
}

function archivioLoadMenu(mode) {
	$('#archivio_subtitolo_opzioni_tutti').removeClass('gray24');
	$('#archivio_subtitolo_opzioni_acquisti').removeClass('gray24');
	// mode = 'TUTTI';
	if (mode == 'TUTTI') {
		$('#archivio_subtitolo_opzioni_tutti').addClass('gray24');
		$('.archivio_container_box').css('display', 'inline-block');
	} else {
		$('#archivio_subtitolo_opzioni_acquisti').addClass('gray24');
		$('.archivio_container_box_isremote').css('display', 'none');
	}

	archivioUpdateIscroll();
}

var _ARCHIVIO_IS_IN_MODIFICA = false;
function archivioModifica() {
	_ARCHIVIO_IS_IN_MODIFICA = true;
	$('#archivio_subtitolo_opzioni_modifica').hide();
	$('#archivio_subtitolo_opzioni_modifica_fine').show();
	archivioLoadAcquisti();
	$('.archivio_container_box > div > .archivio_button_sfoglia').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_elimina').css('display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('LOCAL');
}

function archivioModificaFine() {
	_ARCHIVIO_IS_IN_MODIFICA = false;
	$('#archivio_subtitolo_opzioni_modifica_fine').hide();
	$('#archivio_subtitolo_opzioni_modifica').show();
	// archivioLoadAcquisti();
	archivioLoadTutti();
	// alert($('#archivio_wrapper').html());
	$('.archivio_container_box > div > .archivio_button_elimina').css('display', 'none');
	$('.archivio_container_box_islocal > div > .archivio_button_sfoglia').css('display', 'inline-block');
	$('.archivio_container_box_isremote > div > .archivio_button_acquista').css('display', 'inline-block');
	$('#archivio_filtro_edizioni_tempo').val('');
}

var _ARCHIVIO_ISCROLL = null;
function archivioUpdateIscroll() {
	if (!_ARCHIVIO_ISOPEN)
		return;
	setTimeout(function() {
		if (_ARCHIVIO_ISCROLL == null) {
			_ARCHIVIO_ISCROLL = new iScroll('archivio_wrapper', {
				hideScrollbar : false
			});
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		} else {
			_ARCHIVIO_ISCROLL.refresh();
			_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
		}
	}, 100);
}

var _ARCHIVIO_BOXES_INLINE_V = 2;
// numero di prodotti visualizzati su una riga in PORTRAIT
var _ARCHIVIO_BOXES_INLINE_H = 3;
// numero di prodotti visualizzati su una riga in LANDSCAPE
var _ARCHIVIO_COUNT = 0;
function archivioLoad(p_product_id) {
	$('#archivio_container').empty();

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_ARCHIVIO_RENDERED_ITEMS = {};

	console.log('---REQ---> past-issues/' + p_product_id);
	console.log(l_request_headers);
	console.log(l_request_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "products/past-issues/" + p_product_id + ".json",
		headers : l_request_headers,
		data : l_request_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> past-issues/' + p_product_id);
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				archivioLoad(p_product_id);
			})) {
				var res = p_response.Result.res;

				_ARCHIVIO_PRODUCT = res;

				archivioRenderItems();

				for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
					var l_single_offers = _ARCHIVIO_PRODUCT.items[i].singleOffers;
					if (l_single_offers == null)
						continue;
					for (var j = 0; j < l_single_offers.length; j++) {
						// appstoreReqProduct(l_single_offers[j].offerId,
						// l_single_offers[j].offerItunesProductId);
					}
				}
				// appstoreReqProducts();
			} else {
				console.log('archivioLoad: Error, ' + p_response.Exception.Description);
				abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
				_ARCHIVIO_PRODUCT = {
					items : [],
					testata : _MAP_CODICE_TESTATA['' + p_product_id]
				};
				archivioRenderItems();
			}
		},
		error : function() {
			abutils.alert('Gli arretrati non sono al momento disponibili. Riprovare tra poco.', 'Arretrati');
			_ARCHIVIO_PRODUCT = {
				items : [],
				testata : _MAP_CODICE_TESTATA['' + p_product_id]
			};
			archivioRenderItems();
		}
	});

}

var _ARCHIVIO_LOCAL_ITEMS;
var _ARCHIVIO_LOCAL_ITEMS_ISSUE;
function archivioRenderItems() {
	_ARCHIVIO_LOCAL_ITEMS = [];
	_ARCHIVIO_LOCAL_ITEMS_ISSUE = [];
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioRenderItems: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;

				_ARCHIVIO_LOCAL_ITEMS.push(l_item_id);
				_ARCHIVIO_LOCAL_ITEMS_ISSUE.push(l_local_item.testata + '_' + l_local_item.issue);
			}

			archivioRenderItems_aux();
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	} else {
		// TEST
		_ARCHIVIO_LOCAL_ITEMS.push("testata_iusse_edizione");
		_ARCHIVIO_LOCAL_ITEMS_ISSUE.push("testata_iusse");
		archivioRenderItems_aux();
	}

}

function archivioRenderItems_aux() {
	console.log('archivioRenderItems...');
	console.log(_ARCHIVIO_LOCAL_ITEMS);

	_ARCHIVIO_RENDERED_ITEMS = {};
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId];
	console.log(_EDICOLA_PRODUCTS_DETAILS[_ARCHIVIO_PRODUCT.productId]);
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#archivio_titolo_prodotto').text(l_product_details.name);

	// var l_sole_count_per_cover = 0;
	for (var i = 0; i < _ARCHIVIO_PRODUCT.items.length; i++) {
		for (var j = 0; j < _ARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
			var l_item_id = _ARCHIVIO_PRODUCT.testata + '_' + _ARCHIVIO_PRODUCT.items[i].editionId + '_' + _ARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

			if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
				_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
				// archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j,
				// (l_sole_count_per_cover <= 12) && (i <= 20));
				archivioRenderAsIcon(_ARCHIVIO_PRODUCT.items[i], j, i < 30);
			}
		}
	}

	archivioLoadLocalData();
}

function archivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	console.log('archivioRenderAsIcon');

	archivioUpdateFilter(p_item.inserts[p_insert_index].insertId, p_item.inserts[p_insert_index].description);

	var item_full_id = _ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	var isLocal = $.inArray(item_full_id, _ARCHIVIO_LOCAL_ITEMS) != -1;
	var isLocalFree = $.inArray(_ARCHIVIO_PRODUCT.testata + "_" + p_item.editionId, _ARCHIVIO_LOCAL_ITEMS_ISSUE) != -1;

	var l_premium = p_item.inserts[p_insert_index].premium && (parseInt(p_item.inserts[p_insert_index].premium) > 0) ? true : false;

	// console.log(item_full_id + ' ' + isLocal + ' ' + isLocalFree);

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_edizione_' + p_item.inserts[p_insert_index].insertId;
	// box.id = 'archivio_container_box_' + p_insert_index + '_' +
	// p_item.editionId;
	box.id = 'archivio_container_box_' + item_full_id;
	// box.style['display'] = 'none';

	// console.log(item_full_id + " " + (isLocal ? "LOCAL" : "REMOTE"));

	$(box).addClass( isLocal ? 'archivio_container_box_islocal' : 'archivio_container_box_isremote');

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = p_item.inserts[p_insert_index].cover;

	if (l_premium) {
		var premiumflag = document.createElement('img');
		imgdiv.appendChild(premiumflag);
		premiumflag.className = 'archivio_container_box_img_div_premiumflag';
		premiumflag.src = 'imgs/inserto_abbonati_archivio.png';
		// premiumflag.innerHTML = 'Inserto per abbonati';
	}

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	/*
	 * if (screen.width > 790) txt_elimina.style['width'] = '100px'; else
	 * txt_elimina.style['width'] = '60px';
	 */
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		// eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata,
		// p_item.editionId, p_item.inserts[p_insert_index].insertId,
		// p_item.singleOffers[0].offerId,
		// p_item.singleOffers[0].offerItunesProductId);
		eliminaCopiaLocale(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	// se issue giÃ presente in locale
	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	/*
	 * if (screen.width < 790) txt_sfoglia.style['width'] = '60px';
	 */
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		// sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId,
		// p_item.inserts[p_insert_index].insertId,
		// p_item.singleOffers[0].offerId,
		// p_item.singleOffers[0].offerItunesProductId);
		sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
	});
	txt_sfoglia.style.display = isLocal ? 'inline-block' : 'none';
	txt_sfoglia = null;

	// se issue non presente in locale
	var l_prezzo = "";
	if (p_item.free || p_item.subscription || (p_item.singleOffers && (p_item.singleOffers.length > 0))) {
		var txt_acquista = document.createElement('div');
		txt.appendChild(txt_acquista);
		txt_acquista.className = 'button medium red24 archivio_button_acquista';
		txt_acquista.style['text-align'] = 'center';
		// txt_acquista.appendChild(document.createTextNode('0,79 â‚¬'));

		if (l_premium && (!p_item.subscription) && (!p_item.free)) {
			txt_acquista.innerHTML = 'Per abbonati';
			$(txt_acquista).bind('click', function() {
				mostraPopupInsertoAbbonati();
			});
		} else {

			if (p_item.free || p_item.subscription || isLocalFree) {
				txt_acquista.innerHTML = 'Sfoglia';
				$(txt_acquista).bind('click', function() {
					// sfoglia(_ARCHIVIO_PRODUCT.testata,
					// p_item.editionId,
					// p_item.inserts[p_insert_index].insertId,
					// p_item.singleOffers[0].offerId,
					// p_item.singleOffers[0].offerItunesProductId);
					sfoglia(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId);
				});
			} else {
				// txt_acquista.innerHTML = 'Acquista ' +
				// ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				l_prezzo = "<br />" + ab_euro_formatter(p_item.singleOffers[0].offerPrice);
				txt_acquista.innerHTML = 'Seleziona';
				$(txt_acquista).bind('click', function() {
					// acquistoSingolo(_ARCHIVIO_PRODUCT.testata,
					// p_item.editionId,
					// p_item.inserts[p_insert_index].insertId,
					// p_item.singleOffers[0].offerId,
					// p_item.singleOffers[0].offerItunesProductId);

					var link_singola = '';
					for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
						// _EDICOLA_PRODUCTS_DETAILS[productId]['linksList'][j]['linkType']
						// == 'link_singola'
						if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
							link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
						}
					}
					// prova con i link

					if (!link_singola || link_singola == '') {
						_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'] = _PRODUCTLINK;
						for (var j = 0; j < _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'].length; j++) {
							if (_EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['linkType'] == 'link_singola') {
								link_singola = _EDICOLA_PRODUCTS_DETAILS[_PROID]['linksList'][j]['url'];
							}
						}
					}

					// alert('aaaa');
					// alert('link: '+link_singola);
					// alert('aaa'+JSON.stringify(p_product.singleOffers[i]));
					if (link_singola != '') {
						window.payment.paySingle(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, p_item.singleOffers[0].offerId, p_item.singleOffers[0].offerItunesProductId, link_singola);
						console.log('offerItunesProductId ' + p_item.singleOffers[0].offerItunesProductId);
					} else {
						abutils.alert('Errore su link!', 'Pagamento');
					}

				});
			}
		}
		txt_acquista.style.display = !isLocal ? 'inline-block' : 'none';
		txt_acquista = null;
	}
	// }

	// ATTENZIONE: solo per test
	// p_item.inserts[p_insert_index].anteprima = 5;
	if ((!isLocalFree) && (!p_item.free) && (!p_item.subscription) && p_item.inserts[p_insert_index].anteprima && (parseInt(p_item.inserts[p_insert_index].anteprima) > 0)) {
		var txt_anteprima = document.createElement('div');
		txt.appendChild(txt_anteprima);
		txt_anteprima.className = 'button medium gray24 archivio_button_anteprima';
		txt_anteprima.style['text-align'] = 'center';
		txt_anteprima.appendChild(document.createTextNode('Anteprima'));
		$(txt_anteprima).bind('click', function() {
			openAnteprima(_ARCHIVIO_PRODUCT.testata, p_item.editionId, p_item.inserts[p_insert_index].insertId, parseInt(p_item.inserts[p_insert_index].anteprima));
		});
		txt_anteprima = null;
	}

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	// VERIFICA!!!!*************************************
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	// txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.inserts[p_insert_index].description;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	// txt_subtitolo.appendChild(document.createTextNode('LunedÃ¬ 12 settembre
	// 2011'));
	// txt_subtitolo.innerHTML = p_item.editionDescription;
	txt_subtitolo.innerHTML = p_item.editionDescription + (!(isLocal || isLocalFree) ? l_prezzo : "");
	txt_subtitolo = null;

	if (isLocal) {
		var l_localdiv = document.createElement('img');
		txt.appendChild(l_localdiv);
		l_localdiv.className = 'archivio_container_box_txt_local_ICONS';
		l_localdiv.src = 'imgs/qarchivio_locale_flag.png';
		l_localdiv = null;
	}

	txt = null;
	box = null;

}

function archivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("archivioLoadLocalData: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue + '_' + l_local_item.edizione;
				// console.log(l_item_id);

				if (!_ARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_ARCHIVIO_RENDERED_ITEMS[l_item_id] = true;

					archivioRenderLocalAsIcon(l_local_item);

				}

			}

			archivioLoadTutti();
			setTimeout(function() {
				$('#archivio_loading').css('display', 'none');

				if (_ARCHIVIO_ISCROLL != null) {
					_ARCHIVIO_ISCROLL.refresh();
					// FIX REDRAW
					_ARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
				}
			}, 500);
		}
		var queryError = function(p_error) {
			console.log("archivioLoadLocalData: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues WHERE testata=? ORDER BY issue DESC', [_ARCHIVIO_PRODUCT.testata], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

function archivioRenderLocalAsIcon(p_item) {
	console.log('archivioRenderLocalAsIcon');

	archivioUpdateFilter(p_item.edizione, p_item.edizione_descr);

	var item_full_id = p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	var isLocal = true;

	var box = document.createElement('div');
	document.getElementById('archivio_container').appendChild(box);
	box.className = 'archivio_container_box archivio_container_box_islocal archivio_edizione_' + p_item.edizione;
	box.id = 'archivio_container_box_' + item_full_id;

	var imgdiv = document.createElement('div');
	box.appendChild(imgdiv);
	imgdiv.className = 'archivio_container_box_img_div';

	var img = document.createElement('img');
	imgdiv.appendChild(img);
	img.className = 'archivio_container_box_img';
	img.src = window.folder.getDir() + /*
	 * navigator.fileMgr.libFolderPath +
	 * 'file:///mnt/sdcard/'
	 */'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	// ???? DA VERIFICARE******************************

	img = null;
	imgdiv = null;

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'archivio_container_box_txt';

	var txt_elimina = document.createElement('div');
	txt.appendChild(txt_elimina);
	txt_elimina.className = 'button medium gray24 archivio_button_elimina';
	txt_elimina.style['width'] = '100px';
	txt_elimina.style['text-align'] = 'center';
	txt_elimina.appendChild(document.createTextNode('Elimina'));
	$(txt_elimina).bind('click', function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_elimina.style.display = 'none';
	txt_elimina = null;

	var txt_sfoglia = document.createElement('div');
	txt.appendChild(txt_sfoglia);
	txt_sfoglia.className = 'button medium red24 archivio_button_sfoglia';
	txt_sfoglia.style['width'] = '100px';
	txt_sfoglia.style['text-align'] = 'center';
	txt_sfoglia.appendChild(document.createTextNode('Sfoglia'));
	$(txt_sfoglia).bind('click', function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	txt_sfoglia.style.display = 'inline-block';
	txt_sfoglia = null;

	var txt_titolo = document.createElement('div');
	txt.appendChild(txt_titolo);
	txt_titolo.className = 'archivio_container_box_txt_titolo';
	// txt_titolo.appendChild(document.createTextNode('Ispezioni sul lavoro'));
	txt_titolo.innerHTML = p_item.edizione_descr;
	txt_titolo = null;

	var txt_subtitolo = document.createElement('div');
	txt.appendChild(txt_subtitolo);
	txt_subtitolo.className = 'archivio_container_box_txt_subtitolo';
	// txt_subtitolo.appendChild(document.createTextNode('LunedÃ¬ 12 settembre
	// 2011'));
	txt_subtitolo.innerHTML = p_item.issue_descr;
	txt_subtitolo = null;

	txt = null;
	box = null;

}

var _ARCHIVIO_FILTRO_EDIZIONI = null;
function archivioInitFilter() {
	var l_filtro_tempo_select = $('#archivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_ARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#archivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si è in modifica allora si toglie la
		// modifica
		if (_ARCHIVIO_IS_IN_MODIFICA)
			archivioModificaFine();

		archivioAggiornaContenutoVisualizzato();
	});

	// var l_option = $('<option value="" selected="selected">Tutti i
	// prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);

}

function archivioUpdateFilter(p_edizione_id, p_edizione_descr) {
	if (jQuery.inArray(p_edizione_id, _ARCHIVIO_FILTRO_EDIZIONI) == -1) {
		_ARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		var l_option = $('<option></option>');
		l_option.val(p_edizione_id);
		l_option.text(p_edizione_descr.replace('&igrave;', 'Ã¬').replace('&#39;', '\''));
		$('#archivio_filtro_edizioni').append(l_option);
	}
}

function archivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#archivio_filtro_edizioni_tempo option:selected');

	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box_isremote').css('display', 'none');
			$('#archivio_container .archivio_container_box_islocal').css('display', 'inline-block');
			$('#archivio_container .archivio_container_box_islocal').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#archivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#archivio_container .archivio_container_box').css('display', 'inline-block');
		} else {
			$('#archivio_container .archivio_container_box').not('.archivio_edizione_' + l_selected_option.val()).css('display', 'none');
			$('#archivio_container .archivio_edizione_' + l_selected_option.val()).css('display', 'inline-block');
		}
	}

	setTimeout(archivioUpdateIscroll, 100);
}

/**
 * @author ABertacco, MConventi
 */
var _USER_DEVICES = [];
var _IMPOSTAZIONI_MENU_ISCROLL = null;
var _IMPOSTAZIONI_VISTA_ISCROLL = null;
var _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};

function impostazioniInizializza() {
	if (_EDICOLA_USE_CATEGORIES) {
		var req_headers = {
			"appKey" : _API24_APPKEY
		};
		var req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform
		};
		console.log("--REQ---> getProducts4Impostazioni");
		console.log(req_headers);
		console.log(req_data);
		$.ajax({
			type : "GET",
			cache : false,
			timeout : _AJAX_TIMEOUT,
			contentType : "application/json; charset=utf-8",
			url : _SOLEGW_ENDPOINT + "products.json",
			headers : req_headers,
			data : req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log("--RESP--> getProducts4Impostazioni");
				console.log(p_response);
				// Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response)) {
					// console.log('ajax success');
					var res = p_response.Result.res;
					_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = {};
					for (var i = 0; i < res.products.length; i++) {
						var pid = res.products[i].productId;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid] = {};
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = res.products[i].type;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['productId'] = pid;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['description'] = res.products[i].description;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['name'] = res.products[i].productName;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['icon'] = res.products[i].icon;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['appstore_link'] = res.products[i].appStoreLink;
						_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['linksList'] = res.products[i].linksList;
						if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] == "storeplus") {
							_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type'] = "store";
							_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[pid]['type_original'] = "storeplus";
						}
					}
					impostazioniInizializza_aux();
				}
			}
		});
	} else {
		_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS = _EDICOLA_PRODUCTS_DETAILS;
		impostazioniInizializza_aux();
	}
}

function impostazioniInizializza_aux() {
	// Inizializza la lista dei prodotti disponibili
	inizializzaImpostazioniProdotti();
	// lista prodotti in select per selezione prodotto principale
	inizializzaListaProdottoPrincipale();
	// carico informativa privacy
	impostazioniLoadInformativaPrivacy();
}

var _IMPOSTAZIONI_ISCROLL_PRIVACY = null;

function impostazioniLoadInformativaPrivacy() {
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		url : 'http://du.ilsole24ore.com/utenti/Privacy.html',
		success : function(p_response) {
			if (_IMPOSTAZIONI_ISCROLL_PRIVACY != null) {
				_IMPOSTAZIONI_ISCROLL_PRIVACY.destroy();
				_IMPOSTAZIONI_ISCROLL_PRIVACY = null;
			}
			document.getElementById('informativa_privacy_body_container').innerHTML = p_response;
			// _IMPOSTAZIONI_ISCROLL_PRIVACY = new
			// iScroll('informativa_privacy_body');
		},
		error : function() {
		}
	});
}

// corregge padding nel caso di monitor 10''
function adjustPadding() {
	$('#impostazioni_body_menu_container_box_generali, #impostazioni_body_menu_container_box_codicepromozionale, #impostazioni_body_menu_container_box_help').css({
		'paddingLeft' : '5%'
	});
}

function impostazioniOpen() {
	// alert('aaaaa');
	impostazioniInizializza();
	var l_impostazioni_current = $('.impostazioni_body_menu_container_box_active');
	// alert($('#impostazioni_prodotto_principale_select').html());
	// if (l_impostazioni_current.length == 0)

	$('#impostazioni_body_vista_wrapper').css('left: 0');
	// impostazioniOpenGenerali();
	// aggiusto 10''
	adjustPadding();
}

function impostazioniVistaClose() {
	$('#impostazioni_body_vista_wrapper').removeClass('impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').removeClass('impostazioni_body_vista_active');
	$('.impostazioni_body_menu_container_box_active').removeClass('impostazioni_body_menu_container_box_active');
	$('#impostazioni_body_vista_wrapper').css('left', '100%');
	$('#impostazioni_titolo_vista').css('left', '100%');
}

function impostazioniInitOpen(menu, title) {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL = null;
	}
	$('#impostazioni_body_vista_wrapper').css('left', '0');
	$('#impostazioni_titolo_vista').css('left', '0');
	$('#impostazioni_body_vista_wrapper').addClass('impostazioni_body_vista_active');
	$('#impostazioni_titolo_vista').addClass('impostazioni_body_vista_active');
	// $('#impostazioni_titolo_vista_back_button').css('display', 'none');
	$('#impostazioni_body_vista_container > div').css('display', 'none');
	$('.impostazioni_body_menu_container_box').removeClass('impostazioni_body_menu_container_box_active');
	$('#' + menu).addClass('impostazioni_body_menu_container_box_active');
	document.getElementById('impostazioni_titolo_vista_txt').innerHTML = title;
	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span><span>Impostaz.</span>');
	l_back_button.unbind('click');
	l_back_button.click(impostazioniVistaClose);
}

function impostazioniUpdateOrientation() {
	if (_IMPOSTAZIONI_MENU_ISCROLL != null) {
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	if (_IMPOSTAZIONI_HELP_LOADED)
		hlpCreaLinea();
}

function impostazioniOpenGenerali(event) {
	console.log("DEBUG DOPPIO CLICK: impostazioniOpenGenerali")
	dentro_click = 1;
	event.stopPropagation();
	if (event.stopImmediatePropagation)
		event.stopImmediatePropagation();
	impostazioniInitOpen('impostazioni_body_menu_container_box_generali', 'Generali');
	// informazioni sul profilo utente
	inizializzaAgganciaProfilo();
	// memoria disponibile
	if (( typeof device != "undefined") && (device.usedspace != null) && (device.usedspaceperc != null))
		$('#impostazioni_body_vista_container_generali_memoria_value').html(device.usedspace + ' (' + device.usedspaceperc + ')');
	// carico informazioni sulle versioni
	$('#impostazioni_body_vista_container_generali_info_versione_app').text(device.appversion);
	$('#impostazioni_body_vista_container_generali_info_device_id').text(device.uuid);
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : true,
		url : 'VERSION',
		success : function(p_response) {
			$('#impostazioni_body_vista_container_generali_info_versione_gui').text(p_response);
		},
		error : function() {
			$('#impostazioni_body_vista_container_generali_info_versione_gui').text('---');
		}
	});
	$('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	omnitureTrackApp('APP:impostazioni:generali', 'APP:impostazioni');

	setTimeout(function() {
		dentro_click = 0;
	}, 1000)
}

/**
 * Inizializza la sezione di "Aggancia profilo" nelle impostazioni generali
 */
function inizializzaAgganciaProfilo() {
	if (_MOD_OFFLINE) {
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
		// alert('aaa'+_MOD_OFFLINE);
		return;
	}
	// Se l'utente ha effettuato la login viene mostrato il pulsante per
	// accedere al profilo
	if (_USERNAME) {
		// alert('aaa'+_USERNAME);
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_profilo_value').text(_USERNAME);
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'inline-block');
		// alert($('#impostazioni_body_vista_wrapper').width()+','+
		// $('#impostazioni_body_vista_container_generali_profilo').children().outerWidth());
	} else {
		// alert('aaa');
		// Altrimenti viene mostrato il pulsante per aprire il popup per la
		// login
		$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
		$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'inline-block');
	}
}

IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = null

function impostazioniGeneraliRegistrazione() {
	// console.log("REGISTRAZIONE 2");
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupImpostazioniRegistratiDone;
	if (IMP_ACQUISTO_REGISTRAZIONE_ISCROLL == null) {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL = new iScroll('acquisto_registrazione_wrapper', {
			bounce : false
		});
	} else {
		IMP_ACQUISTO_REGISTRAZIONE_ISCROLL.refresh();
	}
	// console.log("_EDICOLA_ACQUISTO_REGISTRAZIONE_ISCROLL is
	// "+IMP_ACQUISTO_REGISTRAZIONE_ISCROLL)
}

function impostazioniCodicePromoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupCodicePromoRegistratiDone;
}

function impostazioniProdottoRegistrazione() {
	$('#acquisto_registrazione_opzioni_impostazioni').css('display', 'inline-block');
	$('#acquisto_registrazione_opzioni_acquisto').css('display', 'none');
	$('#acquisto_registrazione').css('display', 'inline');
	_NEXT_ACTION = popupProdottoRegistratiDone;
}

function popupImpostazioniRegistrati() {
	// _NEXT_ACTION = popupImpostazioniRegistratiDone;
	popupRegistrazioneApri();
}

function popupImpostazioniRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}

function popupCodicePromoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenCodicePromozionale();
}

function popupProdottoRegistratiDone() {
	$('#acquisto_registrazione').css('display', 'none');
	impostazioniOpenGenerali();
}

/*******************************************************************************
 * Gestione impostazioni codice promozionale
 ******************************************************************************/
/**
 * Apre la sezione delle impostazioni per l'attivazione di un codice
 * promozionale Nel caso in cui l'utente non sia autenticato viene richiesta la
 * login o la registrazione
 */
function impostazioniOpenCodicePromozionale() {
	impostazioniInitOpen('impostazioni_body_menu_container_box_codicepromozionale', 'Codice promozionale');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'inline-block');
	} else {
		$('#impostazioni_body_vista_container_codicepromozionale_attiva_codice').css('display', 'none');
		$('#impostazioni_body_vista_container_codicepromozionale_login').css('display', 'inline-block');
	}
	$('#impostazioni_body_vista_container_codicepromozionale').css('display', 'inline-block');

	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
	omnitureTrackApp('APP:impostazioni:codice_promo', 'APP:impostazioni');
}

/**
 * Esegue la chiamata per l'attivazione di un codice promozionale
 */
function impostazioniOpenCodicePromozionaleAvanti() {
	var l_codice_promozionale = $('#impostazioni_body_vista_container_codicepromozionale_attiva_codice #codice_promozionale').val();
	console.log('Sending the promotional code ' + l_codice_promozionale);
	if (l_codice_promozionale && l_codice_promozionale != '') {
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"appName" : device.appname,
			"appVersion" : device.appversion,
			"deviceId" : device.uuid,
			"deviceType" : device.platform,
			"username" : _USERNAME
			// ,
			// "promo_code": l_codice_promozionale
		};
		console.log('---REQ---> promo-code');
		console.log(l_req_headers);
		console.log(l_req_data);
		/*
		 * navigator.notification.loadingStart({ 'labelText': "Richiesta in
		 * corso...", 'backgroundOpacity': 0.8, 'strokeOpacity': 0.25,
		 * 'strokeColor': "FFFFFF", });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
		$.ajax({
			type : "POST",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			// url: _SOLEGW_ENDPOINT + "promo-code.json",
			url : _SOLEGW_ENDPOINT + "promo/" + l_codice_promozionale + ".json",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log('---RESP--> promo-code');
				console.log(p_response);
				// Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, impostazioniOpenCodicePromozionaleAvanti)) {
					abutils.alert('La tua promozione è stata attivata con successo', 'Codice promozionale');
				} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
					if (p_response.Exception.Description) {
						abutils.alert(p_response.Exception.Description, 'Codice promozionale');
					} else {
						abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale.', 'Codice promozionale');
					}
				}
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			},
			error : function() {
				abutils.alert('Si è verificato un errore durante l\'invio del codice promozionale. Riprovare tra poco.', 'Codice promozionale');
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		});
	} else {
		abutils.alert('Attenzione, inserire un codice promozionale', 'Codice promozionale');
	}
}

var _IMPOSTAZIONI_HELP_LOADED = false;
var hlpTabsScr, hlpContScr, hlpFaqScr, strOr, hlpGlobNav;

function hlpNav(hli) {
	$('#hlp_tbs2_scroll .tbon').removeClass("tbon");
	$('#hlp_tbs2_scroll .hlp_tb:eq(' + hli + ')').addClass("tbon");
	$('#hlp_tot div[class^=hlp_slide]:visible').fadeOut(200);
	$('#hlp_cont_scroll > div:eq(' + hli + ')').delay(200).fadeIn(200);
	setTimeout(function() {
		hlpContScr.refresh();
		hlpCreaLinea();
	}, 410);
}

function hlpCreaLinea() {
	console.log('hlpCreaLinea()');
	console.log(window.orientation);
	/* verticale o orizzontale */
	if ( typeof window.orientation != "undefined") {
		strOr = Math.abs(window.orientation) == 90 ? "l" : "p";
	} else {// temp non ipad
		strOr = window.innerWidth > window.innerHeight ? "l" : "p";
	}
	if (strOr == "l") {
		$('#hlp_mail').html('Desideri assistenza specifica? Contatta il Servizio Clienti all\'indirizzo <a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	} else {
		$('#hlp_mail').html('Contatta il Servizio Clienti:<br><a href="mailto:portale@info.ilsole24ore.com">portale@info.ilsole24ore.com</a>');
	}
	if (hlpFaqScr != null)
		hlpFaqScr.refresh();
	setTimeout(function() {
		$("#hlp_cont_scroll canvas:visible").each(function(index, element) {
			var $c = $(this);
			var c = $(this)[0];
			$c.width(Number($c.data(strOr + "w")));
			$c.height(Number($c.data(strOr + "h")) + 15);
			c.width = Number($c.data(strOr + "w"));
			c.height = Number($c.data(strOr + "h") + 15);
			$c.css({
				'left' : "-" + c.width + "px",
				'top' : "-" + (c.height - 15) + "px"
			});
			var cxt = c.getContext("2d");
			cxt.strokeStyle = '#FF0000';
			cxt.lineWidth = 2;
			cxt.lineCap = 'round';
			cxt.moveTo(1, 1);
			cxt.lineTo(c.width - 7, c.height - 2);
			cxt.stroke();
		});
	}, 10);
}

function impostazioniOpenHelp() {
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.destroy();
		_IMPOSTAZIONI_VISTA_ISCROLL == null;
	}
	impostazioniInitOpen('impostazioni_body_menu_container_box_help', 'Help');
	console.log('PASSS HELP');
	// window.location = 'ipad_help.html';
	/*
	 * $('div').ajaxError(function(event, request, settings){ alert("Error
	 * requesting page " + settings.url ); });
	 */
	if (!_IMPOSTAZIONI_HELP_LOADED) {
		// carico il contenuto via ajax
		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : true,
			url : "ipad_help.html",
			success : function(p_response) {
				try {
					console.log('ipad_help.html letto');
					$('#impostazioni_body_vista_container_help_content').html(p_response);
					// console.log('asdadadasdasdas');
					$('#impostazioni_body_vista_container_help').css('display', 'inline-block');
					// ATTENZIONE ---> evento di aggiornamento in
					// impostazioniUpdateOrientation
					console.log('carico help');
					$('#hlp_tbs2_scroll .hlp_tb').click(function(e) {
						e.preventDefault();
						if (!$(this).hasClass('tbon')) {
							var hli = $(this).index();
							hlpNav(hli);
						}
					});
					hlpNav(0);
					hlpTabsScr = new iScroll('hlp_tbs2', {
						snap : "a",
						hScrollbar : false
					});
					hlpContScr = new iScroll('hlp_cont', {
						vScrollbar : false
					});
					hlpFaqScr = new iScroll('hlp_faq', {
						vScrollbar : false
					});
					$('#hlp_faq').hide(0);
					$('#hlp_tbs1 .hlp_tb').click(function(e) {
						if (hlpGlobNav != $(this).data('nav')) {
							hlpGlobNav = $(this).data('nav');
							$('#hlp_tbs1 .hlp_tb').toggleClass("tbon");
							$('#hlp_glob_switch > div[id^=hlp_]').hide(0);
							hlpFaqScr.refresh();
							$('#hlp_glob_switch > #hlp_' + hlpGlobNav).fadeIn(300, function() {
								if (hlpGlobNav == "faq") {
									hlpFaqScr.refresh();
								}
							});
						}
					});
				} catch (exc) {
					console.log(exc.message);
				}
				_IMPOSTAZIONI_HELP_LOADED = true;
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				/*
				 * readyState status statusText responseXML and/or responseText when
				 * the underlying request responded with xml and/or text,
				 * respectively setRequestHeader(name, value) which departs from the
				 * standard by replacing the old value with the new one rather than
				 * concatenating the new value to the old one
				 * getAllResponseHeaders() getResponseHeader() abort()
				 */
				console.log("Error status :" + textStatus);
				console.log("Error type :" + errorThrown);
				console.log("Error message :" + XMLHttpRequest.status);
			}
		});
	}
	$('#impostazioni_body_vista_container_help').css('display', 'inline-block');
	/*
	 * lo fa il codice dell'help if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
	 * _IMPOSTAZIONI_VISTA_ISCROLL = new
	 * iScroll('impostazioni_body_vista_wrapper'); } else {
	 * _IMPOSTAZIONI_VISTA_ISCROLL.refresh(); }
	 */
	omnitureTrackApp('APP:impostazioni:help', 'APP:impostazioni');
}

/*******************************************************************************
 * Gestione prodotto principale
 ******************************************************************************/
/**
 * Inizializza la lista dei prodotti tra i quali poter scegliere per selezionare
 * il prodotto principale.
 */
function inizializzaListaProdottoPrincipale() {
	// Ottenere il prodotto principale da local storage
	var l_prodotto_principale_id = window.localStorage.getItem("prodotto_principale_id");
	var l_prodotto_principale_descr = window.localStorage.getItem("prodotto_principale_descr");
	var l_impostazioni_prodotto_principale_select = $('#impostazioni_prodotto_principale_select');
	l_impostazioni_prodotto_principale_select.empty();
	l_impostazioni_prodotto_principale_select.append($('<option value="">Nessun prodotto principale</option>'));
	for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
			var l_option = $('<option></option>');
			l_option.val(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId);
			l_option.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == l_prodotto_principale_id) {
				l_option.attr('selected', 'selected');
			}
			l_impostazioni_prodotto_principale_select.append(l_option);
		}
	}
}

function impostazioniProdottoPrincipaleSelectOnChange() {
	// alert('CIAO');
	console.log('impostazioniProdottoPrincipaleSelectOnChange...');
	var l_selected_option = $('#impostazioni_prodotto_principale_select option:selected');
	l_prodotto_principale_id = l_selected_option.val();
	l_prodotto_principale_descr = l_selected_option.text();
	window.localStorage.setItem("prodotto_principale_id", l_prodotto_principale_id);
	window.localStorage.setItem("prodotto_principale_descr", l_prodotto_principale_descr);
	// console.log('impostazioniProdottoPrincipaleSelectOnChange --->
	// '+l_selected_option.val()+':::'+ l_selected_option.text());
}

/*******************************************************************************
 * Gestione impostazioni prodotti
 ******************************************************************************/
/**
 * Inizializza la lista dei prodotti nel pannello delle impostazioni
 */
function inizializzaImpostazioniProdotti() {
	var l_lista_prodotti_container = $('#impostazioni_body_menu_container_box_lista_prodotti');
	l_lista_prodotti_container.empty();
	/*
	 * for (var key in _EDICOLA_PRODUCTS_DETAILS) { if
	 * (_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") { var pbox = $('<div></div>');
	 * pbox.addClass('impostazioni_body_menu_container_box');
	 * pbox.addClass('impostazioni_body_menu_container_box_prodotto');
	 * pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
	 * pbox.text(_EDICOLA_PRODUCTS_DETAILS[key].name); pbox.bind('click',
	 * (function(p_key){ return function(){
	 * impostazioniOpenProdotto(_EDICOLA_PRODUCTS_DETAILS[p_key].productId,
	 * _EDICOLA_PRODUCTS_DETAILS[p_key].name); } })(key));
	 * l_lista_prodotti_container.append(pbox); //alert('aaa_
	 * '+_EDICOLA_PRODUCTS_DETAILS[key].icon); var img =
	 * document.createElement('img'); img.className =
	 * 'impostazioni_body_menu_container_box_icon'; img.src =
	 * _EDICOLA_PRODUCTS_DETAILS[key].icon;//'imgs/fake/s24_small_icon.png';
	 * pbox.append(img); img = null; pbox = null; } }
	 */
	for (var key in _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS) {
		if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].type == "inapp") {
			var pbox = $('<div></div>');
			pbox.addClass('impostazioni_body_menu_container_box');
			pbox.addClass('impostazioni_body_menu_container_box_prodotto');
			pbox.attr('id', 'impostazioni_body_menu_container_box_' + key);
			pbox.text(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].name);
			pbox.bind('click', (function(p_key) {
				return function(event) {
					impostazioniOpenProdotto(_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].productId, _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[p_key].name);
				}
			})(key));
			l_lista_prodotti_container.append(pbox);
			var img = document.createElement('img');
			img.className = 'impostazioni_body_menu_container_box_icon';
			if (_IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].productId == _CODICE_PRODOTTO_QUOTIDIANO)
				img.src = 'imgs/fake/s24_small_icon.png';
			else
				img.src = _IMPOSTAZIONI_EDICOLA_PRODUCTS_DETAILS[key].icon;
			pbox.append(img);
			img = null;
			pbox = null;
		}
	}
	if (_IMPOSTAZIONI_MENU_ISCROLL == null) {
		_IMPOSTAZIONI_MENU_ISCROLL = new iScroll('impostazioni_body_menu_wrapper', {
			bounce : false
		});
	} else {
		// aggiorno iscroll
		_IMPOSTAZIONI_MENU_ISCROLL.refresh();
	}
}

/**
 * Apre il pannello di impostazioni di un prodotto
 *
 * @params p_product_id Il codice del prodotto p_product_description La
 *         descrizione del prodotto
 */
function impostazioniOpenProdotto(p_product_id, p_product_description) {
	GLOB_p_product_id = p_product_id;
	GOLB_p_product_description = p_product_description;
	$('#impostazioni_body_vista_wrapper').css("left", "0%");
	impostazioniInitOpen('impostazioni_body_menu_container_box_' + p_product_id, p_product_description);
	$('#cartaceo_codice_abbonato').val('');
	$('#cartaceo_cap').val('');
	$('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display', 'none');
	if (_USERNAME) {
		$('#impostazioni_body_vista_container_prodotto_login').css('display', 'none');
		$('#impostazioni_body_vista_container_prodotto_info').css('display', 'inline');
		impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
	} else {
		$('#impostazioni_body_vista_container_prodotto_info').css('display', 'none');
		$('#impostazioni_body_vista_container_prodotto_login').css('display', 'inline-block');
		_NEXT_ACTION = function() {
			impostazioniOpenProdotto(p_product_id, p_product_description);
		}
	}
	$('#impostazioni_body_vista_container_prodotto').css('display', 'inline-block');
	if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper');
	}
	omnitureTrackApp('APP:impostazioni:prodotto:' + p_product_id, 'APP:impostazioni');
}

/**
 * Carica le info sull'abbonamento
 */
function impostazioniProdottoCaricaInfoAbbonamento(p_product_id) {
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform,
		"username" : _USERNAME
	};
	console.log('---REQ---> subscription/' + p_product_id);
	console.log(l_req_headers);
	console.log(l_req_data);
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription/" + p_product_id + ".json",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log('---RESP--> subscription/' + p_product_id);
			console.log(p_response);
			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				impostazioniProdottoCaricaInfoAbbonamento(p_product_id);
			})) {
				var l_attivo = false;
				var l_date_end = null;
				try {
					// if (p_response.Result.res.endDate == null)
					if (p_response.Result.res && p_response.Result.res.details && (p_response.Result.res.details.length > 0) && p_response.Result.res.details[0].endDate) {
						l_date_end = parseDateWithDbFormat(p_response.Result.res.details[0].endDate);
						l_attivo = l_date_end > new Date();
					} else {
						throw {
							message : "endDate non valorizzato"
						};
					}
				} catch (exc) {
					console.log(exc.message);
					console.log('ERRORE: si è verificato un errore durante la lettura dello stato dell\'abbonamento.');
					l_attivo = false;
					l_date_end = null;
				}
				if (l_attivo) {
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Attivo');
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text(l_date_end.format('dd/mm/yyyy'));
				} else {
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('Non Attivo');
					$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
					/*
					 * if (p_product_id == _CODICE_PRODOTTO_QUOTIDIANO) {
					 * $('#impostazioni_body_vista_container_prodotto_info_cartaceo').css('display',
					 * 'inline-block'); }
					 */
					if (_IMPOSTAZIONI_VISTA_ISCROLL != null) {
						_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
					} else {
						_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
							bounce : false
						});
					}
				}
			} else {
				$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_stato_value').text('---');
				$('#impostazioni_body_vista_container_ilsole24ore_abbonamento_validita_value').text('');
			}
		},
		error : ajaxErrorHandler
	});
}

/*******************************************************************************
 * Gestione impostazioni profilo
 ******************************************************************************/
/**
 * Apre il popup contenente le informazioni sul profilo utente
 */
var _IMPOSTAZIONI_PROFILO_ISCROLL = null;
var _IMPOSTAZIONI_PROFILO_INITIALIZED = false;

function popupImpostazioniProfilo() {
	window.location = 'http://du.ilsole24ore.com/utenti/areautente/ilmioprofilo.aspx';
	return;
	if (!_IMPOSTAZIONI_PROFILO_INITIALIZED) {
		// Se l'utente inserisce l'indirizzo email deve comparire il link
		// all'informativa sulla privacy
		$('#impostazioni_profilo #id_email_address').unbind();
		$('#impostazioni_profilo #id_email_address').keyup(controlloSezioneConsensoEmail);
		// Inizializzazione campo data
		$('#id_birthdate').scroller({
			showOnFocus : false,
			theme : 'ios',
			mode : 'scroller',
			startYear : 1910
		});
		$('#id_birthdate').click(function() {
			$('#id_birthdate').scroller('show');
			return false;
		});
		_IMPOSTAZIONI_PROFILO_INITIALIZED = true;
	}
	$('#impostazioni_profilo').css('display', 'inline');
	$('#impostazioni_profilo_menu').css('display', 'none');
	// Inizializza i dati del profilo utente
	inizializzaProfilo();
}

/**
 * In base alla presenza dell'email mostra i campi per il consenso della privacy
 */
function controlloSezioneConsensoEmail() {
	if ($('#impostazioni_profilo #id_email_address').val() != '') {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeIn(200, function() {
			if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
				_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
					bounce : false
				});
			} else {
				_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
			}
		});
	} else {
		$('#impostazioni_profilo #impostazioni_profilo_sezione_consenso_email').fadeOut(200, function() {
			if (_IMPOSTAZIONI_PROFILO_ISCROLL == null) {
				_IMPOSTAZIONI_PROFILO_ISCROLL = new iScroll('impostazioni_profilo_body_wrapper', {
					bounce : false
				});
			} else {
				_IMPOSTAZIONI_PROFILO_ISCROLL.refresh();
			}
		});
	}
}

/**
 * Inizializza i dati del profilo dell'utente che sta utilizzando l'applicativo
 */
var _PROFILE_FIELDS = [{
	id : 'email_address',
	type : 'text'
}, {
	id : 'ConsensoPrivacy',
	type : 'checkbox'
}, {
	id : 'ConsensoSocieta',
	type : 'checkbox'
}, {
	id : 'ConsensoMail',
	type : 'checkbox'
}, {
	id : 'first_name',
	type : 'text'
}, {
	id : 'last_name',
	type : 'text'
}, {
	id : 'birth_year',
	type : 'text'
}, {
	id : 'birth_month',
	type : 'text'
}, {
	id : 'birth_day',
	type : 'text'
}, {
	id : 'gender',
	type : 'select'
}, {
	id : 'address_street',
	type : 'text'
}, {
	id : 'city',
	type : 'text'
}, {
	id : 'provincia',
	type : 'text'
}, {
	id : 'state',
	type : 'text'
}, {
	id : 'zip_code',
	type : 'text'
}, {
	id : 'tel_number',
	type : 'text'
}, {
	id : 'mobile_phone',
	type : 'text'
}, {
	id : 'fax_number',
	type : 'text'
}, {
	id : 'societa_ente',
	type : 'text'
}, {
	id : 'professione',
	type : 'text'
}, {
	id : 'settore',
	type : 'text'
}, {
	id : 'codice_fiscale',
	type : 'text'
}, {
	id : 'partita_iva',
	type : 'text'
}];

function inizializzaProfilo() {
	console.log('Get profilo info for user ' + _USERNAME);
	$('#impostazioni_profilo #id_username').text(_USERNAME);
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"username" : _USERNAME
	};
	console.log('---REQ---> getUserProfile');
	console.log(l_req_headers);
	console.log(l_req_data);
	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/getUserProfile",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log('---RESP--> getUserProfile');
			console.log(p_response);
			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, inizializzaProfilo)) {
				// Per tutti i campi definiti in _PROFILE_FIELDS vengono
				// inizializzati i valori nel popup di impostazioni
				// profilo
				for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
					// Gli elementi html devono avere un id uguale a
					// 'id_<ID_CAMPO>'
					var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
					// Se l'elemento html esiste
					if (l_html_element) {
						// In base al tipo di elemento viene
						// inizializzato il valore
						if (_PROFILE_FIELDS[i].type == 'text') {
							if (p_response.Result[_PROFILE_FIELDS[i].id]) {
								l_html_element.val(p_response.Result[_PROFILE_FIELDS[i].id]);
							} else {
								l_html_element.val('');
							}
						}
						if (_PROFILE_FIELDS[i].type == 'checkbox') {
							if (p_response.Result[_PROFILE_FIELDS[i].id]) {
								if (p_response.Result[_PROFILE_FIELDS[i].id] == '0') {
									l_html_element.attr('checked', false);
								} else if (p_response.Result[_PROFILE_FIELDS[i].id] == '1') {
									l_html_element.attr('checked', true);
								}
							} else {
								l_html_element.attr('checked', false);
							}
							l_html_element.change();
						}
						if (_PROFILE_FIELDS[i].type == 'select') {
							$('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').removeAttr('selected');
							l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option[value=' + p_response.Result[_PROFILE_FIELDS[i].id] + ']');
							l_html_element.attr('selected', 'selected');
						}
					}
				}
				// Inizializzazione campo data di nascita
				if (p_response.Result['birth_day'] && p_response.Result['birth_month'] && p_response.Result['birth_year']) {
					$('#id_birthdate').scroller('setDate', new Date(p_response.Result['birth_month'] + '/' + p_response.Result['birth_day'] + '/' + p_response.Result['birth_year']), true);
				}
				controlloSezioneConsensoEmail();
			}
			/*
			 * else { //Gestione eccezioni //TODO alert('Attenzione, ' +
			 * p_response.Exception.Description); }
			 */
		},
		error : ajaxErrorHandler
	});
}

/**
 * Salva i dati del profilo
 */
function popupImpostazioniProfiloAvanti() {
	if (controlloDatiProfilo()) {
		// Definizione del profilo utente
		var l_user_profile = {
			"siteCode" : _API24_SITECODE,
			"username" : _USERNAME,
			"disclaimer" : "1"
		};
		var l_user_email = $('#impostazioni_profilo #id_email_address').val();
		// Nel caso in cui sia presente l'indirizzo email devono essere aggiunti
		// i campi sul consenso
		if (l_user_email != '') {
			l_user_profile['email_address'] = l_user_email;
			l_user_profile['consensoPrivacy'] = ($('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoMail'] = ($('#impostazioni_profilo #id_ConsensoMail').attr('checked') == "checked" ? '1' : '0');
			l_user_profile['consensoSocieta'] = ($('#impostazioni_profilo #id_ConsensoSocieta').attr('checked') == "checked" ? '1' : '0');
		}
		// Imposta la data di nascita
		var l_birthdate = $('#id_birthdate').scroller('getDate');
		$('#impostazioni_profilo #id_birth_day').val(l_birthdate.getDate());
		$('#impostazioni_profilo #id_birth_month').val(l_birthdate.getMonth() + 1);
		$('#impostazioni_profilo #id_birth_year').val(l_birthdate.getFullYear());
		// Per tutti i campi definiti in _PROFILE_FIELDS vengono letti i nuovi
		// valori dal popup di impostazioni profilo
		for (var i = 0; i < _PROFILE_FIELDS.length; i++) {
			if (!(_PROFILE_FIELDS[i].id in {
				email_address : 1,
				ConsensoPrivacy : 1,
				ConsensoMail : 1,
				ConsensoSocieta : 1
			})) {
				// Gli elementi html devono avere un id uguale a 'id_<ID_CAMPO>'
				var l_html_element = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id);
				// Se l'elemento html esiste
				if (l_html_element) {
					// In base al tipo di elemento viene settato il nuovo valore
					if (_PROFILE_FIELDS[i].type == 'text') {
						l_user_profile[_PROFILE_FIELDS[i].id] = l_html_element.val();
					}
					if (_PROFILE_FIELDS[i].type == 'checkbox') {
						l_user_profile[_PROFILE_FIELDS[i].id] = (l_html_element.attr('checked') == "checked" ? '1' : '0');
					}
					if (_PROFILE_FIELDS[i].type == 'select') {
						l_user_profile[_PROFILE_FIELDS[i].id] = $('#impostazioni_profilo #id_' + _PROFILE_FIELDS[i].id + ' option:selected').val();
					}
				}
			}
		}
		console.log('updateUserProfile call for ' + _USERNAME + ': ' + l_user_profile);
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"profile" : l_user_profile
		};
		console.log('---REQ---> updateUserProfile');
		console.log(l_req_headers);
		console.log(l_req_data);
		$.ajax({
			type : "POST",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/updateUserProfile",
			headers : l_req_headers,
			processData : false,
			data : JSON.stringify(l_req_data),
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log('---RESP--> updateUserProfile');
				console.log(p_response);
				if (checkAjaxResponse(p_response, popupImpostazioniProfiloAvanti)) {
					// Chiudi popup
					popupImpostazioniProfiloChiudi();
				} else {
					// Gestione messaggi di errore dal server
					if (p_response.Exception.Name == 'InvalidParameterException') {
						abutils.alert('Attenzione, uno o piÃ¹ campi inseriti non sono validi.', 'Aggiornamento profilo')
					} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
						abutils.alert(p_response.Exception.Description, 'Aggiornamento profilo');
					}
				}
			},
			error : function(xmlHttpRequest, textStatus, errorThrown) {
				/*
				 * console.log('ajax error'); console.log(textStatus);
				 * alert('Funzione non disponibile in assenza di
				 * connessione');
				 */
			}
		});
	}
}

/**
 * Controlla che i dati del profilo siano stati immessi correttamente
 */
function controlloDatiProfilo() {
	var ck_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
	// Controllo email
	email = $('#impostazioni_profilo #id_email_address').val();
	if (email == '') {
		abutils.alert("Attenzione, inserire un indirizzo email valido.", 'Profilo utente');
		return false;
	}
	if (email != '' && !ck_email.test(email)) {
		abutils.alert("Attenzione, l'indirizzo email inserito non è valido.", 'Profilo utente');
		return false;
	}
	// Controllo consenso alla privacy solo in caso di email non vuota
	if (email != '' && !$('#impostazioni_profilo #id_ConsensoPrivacy').attr('checked')) {
		abutils.alert("Attenzione, per proseguire devi acconsentire al trattamento dei tuoi dati personali.", 'Profilo utente');
		return false;
	}
	return true;
}

/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloChiudi() {
	// $('#impostazioni_profilo').fadeOut();
	$('#impostazioni_profilo').css('display', 'none');
}

/*******************************************************************************
 * Gestione popup di account menu
 ******************************************************************************/
/**
 * Apre il popup contenente il menu delle azioni riguardanti il profilo utente
 * Da tale menu l'utente potrÃ : - Visualizzare informazioni del proprio profilo -
 * Disassociare il proprio account
 */
function popupImpostazioniProfiloMenu(event) {
	console.log("DEBUG DOPPIO CLICK: popupImpostazioniProfiloMenu")
	if (dentro_click == 0) {
		// alert('is '+$('#impostazioni_prodotto_principale_select'));
		$('#impostazioni_prodotto_principale_select').attr('disabled', 'true');
		$('#impostazioni_profilo_menu_account_username').text(_USERNAME);
		$('#impostazioni_profilo_menu').css('display', 'inline');
	}
}

/**
 * Chiude il popup contenente le informazioni sul profilo utente
 */
function popupImpostazioniProfiloMenuChiudi() {
	// $('#impostazioni_profilo_menu').fadeOut();
	// alert('is '+$('#impostazioni_prodotto_principale_select').attr());
	$('#impostazioni_prodotto_principale_select').removeAttr('disabled');
	$('#impostazioni_profilo_menu').css('display', 'none');
}

/*******************************************************************************
 * Gestione pannello lista dispositivi
 ******************************************************************************/
/**
 * Apre la sezione per la gestione dei dispositivi associati all'utente
 */
function impostazioniGeneraliDispositivi() {
	$('#impostazioni_body_vista_container_dispositivi_lista').css('display', 'none');
	$('#impostazioni_body_vista_container_generali').css('display', 'none');
	$('#impostazioni_body_vista_container_dispositivi').css('display', 'inline-block');
	// Inizializza il pulsante di ritorno verso le impostazioni generali
	/*
	 * var l_back_button = $('#impostazioni_titolo_vista_back_button');
	 * l_back_button.html('<span></span>Generali');
	 * l_back_button.css('display', 'inline-block');
	 * l_back_button.click(impostazioniGeneraliDispositiviChiudi);
	 */
	$('#impostazioni_titolo_vista_txt').text('Dispositivi');
	inizializzaListaDispositivi();
}

/**
 * Ottiene dal server la lista dei dispositivi associati all'utente ed
 * inizializza la sezione
 */
function inizializzaListaDispositivi() {
	if (_USERNAME) {
		// console.log('Get devices for user ' + _USERNAME);
		var l_section_body = $('#impostazioni_body_vista_container_dispositivi_lista');
		l_section_body.empty();
		var l_req_headers = {
			"appKey" : _API24_APPKEY,
			"userIdentity" : _USER_IDENTITY
		};
		var l_req_data = {
			"username" : _USERNAME
		};
		console.log('---REQ---> getUserDevices');
		console.log(l_req_headers);
		console.log(l_req_data);
		// Ottengo i dispositivi associati all'utenza in base alle info date da
		// API24
		$.ajax({
			type : "GET",
			timeout : _AJAX_TIMEOUT,
			cache : false,
			contentType : "application/json; charset=utf-8",
			url : _API24_ENDPOINT + "Users/getUserDevices",
			headers : l_req_headers,
			data : l_req_data,
			dataType : "json",
			success : function(p_response) {
				if ( typeof p_response == "string") {
					p_response = $.parseJSON(p_response);
				}
				console.log('---RESP--> getUserDevices');
				console.log(p_response);
				// Controlla la risposta avuta dal server
				if (checkAjaxResponse(p_response, inizializzaListaDispositivi)) {
					// p_response.Result.res =
					// [{"id":"1234567890","name":"Questo
					// device","type":1},{"id":"222","name":"Device
					// 2","type":2},{"id":"333","name":"Device
					// 3","type":3}]; //TODO PER DEBUG
					for (var i = 0; i < p_response.Result.res.length; i++) {
						var l_device = p_response.Result.res[i];
						// I dispositivi associati vengono memorizzati
						// in una variabile globale
						_USER_DEVICES[l_device.id] = l_device;
						// Viene creato l'elemento nella lista dei
						// dispositivi
						var l_device_element_container = $('<div></div>');
						l_device_element_container.addClass('impostazioni_body_vista_container_label');
						if (l_device["name"] != '')
							l_device_element_container.html(decodeURIComponent(l_device["name"]) + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
						else
							l_device_element_container.html("Dispositivo senza nome" + "<br /><div class=\"impostazioni_body_vista_container_label_inblue\">" + l_device["id"] + "</div>");
						if (l_device.id != device.uuid) {
							var l_device_element_button = $('<div></div>');
							l_device_element_button.addClass("button medium red24 impostazioni_body_vista_container_label_button");
							l_device_element_button.text("Disassocia");
							l_device_element_button.attr("onclick", '_NEXT_ACTION=impostazioniGeneraliDispositivi;popupDisassociaDispositivo("' + l_device.id + '")');
							l_device_element_container.append(l_device_element_button);
						}
						l_section_body.append(l_device_element_container);
					}
					l_section_body.fadeIn();
					if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
						_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
							bounce : false
						});
					} else {
						_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
					}
				} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
					abutils.alert(p_response.Exception.Description, 'Dispositivi');
				}
			},
			error : ajaxErrorHandler
		});
	} else {
		impostazioniGeneraliDispositiviChiudi();
		inizializzaAgganciaProfilo();
	}
}

/**
 * Chiude la sezione per la gestione dei dispositivi e riapre le impostazioni
 * generali
 */
function impostazioniGeneraliDispositiviChiudi() {
	$('#impostazioni_titolo_vista_txt').text('Generali');
	// Inizializza il pulsante di ritorno verso le impostazioni generali
	var l_back_button = $('#impostazioni_titolo_vista_back_button');
	l_back_button.html('<span></span>');
	l_back_button.css('display', 'none');
	$('#impostazioni_body_vista_container_generali').css('display', 'inline-block');
	$('#impostazioni_body_vista_container_dispositivi').css('display', 'none');
	if (_IMPOSTAZIONI_VISTA_ISCROLL == null) {
		_IMPOSTAZIONI_VISTA_ISCROLL = new iScroll('impostazioni_body_vista_wrapper', {
			bounce : false
		});
	} else {
		_IMPOSTAZIONI_VISTA_ISCROLL.refresh();
	}
}

/*******************************************************************************
 * Gestione popup disassocia dispositivo
 ******************************************************************************/
/**
 * Apre il popup che permette di disassociare un dispositivo
 */
function popupDisassociaDispositivo(p_device_id) {
	console.log("DEBUG DOPPIO CLICK: popupDisassociaDispositivo")
	if (dentro_click == 0) {
		$('#disassocia_dispositivo').css('display', 'inline');
		if (p_device_id) {
			$('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti("' + p_device_id + '");')
		} else {
			$('#disassocia_dispositivo_action_button').attr('onclick', 'popupDisassociaDispositivoAvanti();')
		}
	}
}

/**
 * Chiude il popup per disassociare un dispositivo
 */
function popupDisassociaDispositivoChiudi() {
	// $('#impostazioni_profilo_menu').fadeOut();
	$('#disassocia_dispositivo').css('display', 'none');
}

/**
 * Disassocia l'account dal dispositivo
 */
function popupDisassociaDispositivoAvanti(p_device_id) {
	console.log('Delete user association to the device');
	var l_request_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	// Se il device id è settato viene disassociato il device memorizzato in
	// _USER_DEVICES[l_device.id]
	if (p_device_id) {
		l_request_data["deviceID"] = p_device_id;
		l_request_data["deviceType"] = _USER_DEVICES[p_device_id]["type"];
	} else {
		// _EDICOLA_LAST_PRODUCT_LOAD = 0;
	}
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	console.log('---REQ---> removeUserDevice');
	console.log(l_req_headers);
	console.log(l_request_data);
	/*
	 * navigator.notification.loadingStart({ 'labelText': "Disassociazione in
	 * corso...", 'backgroundOpacity': 0.8, 'strokeOpacity': 0.25,
	 * 'strokeColor': "FFFFFF", });
	 */
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Disassociazione in corso..."]);
	// Ottengo la username associata al device in base alle info date da API24
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "Users/removeUserDevice",
		headers : l_req_headers,
		data : JSON.stringify(l_request_data),
		processData : false,
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log('---RESP--> removeUserDevice');
			console.log(p_response);
			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, function() {
				popupDisassociaDispositivoAvanti(p_device_id);
			})) {
				if (!p_device_id) {
					abutils.alert('L\'account è stato disassociato dal dispositivo', 'Disassociazione dispositivo');
					setUserData(null, null, null);
					/*
					 * _USERNAME = null; _PASSWORD = null; deleteUsername();
					 * deletePassword();
					 */
					inizializzaAgganciaProfilo();
				}
				popupDisassociaDispositivoChiudi();
				gestisciProssimaAzione();
				openProductDetails(_PRODUCT_IN_EDICOLA.productId);
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
				abutils.alert(p_response.Exception.Description, 'Disassociazione dispositivo');
			} else {
				abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore durante la disassociazione del dispositivo.', 'Disassociazione dispositivo');
			navigator.notification.loadingStop();
		}
	});
}

/**
 * Cancella tutte le edizioni presenti in locale
 */
function impostazioniCancellaContenutoLocale() {
	if (dentro_click == 0) {
		dentro_click = 1;
		window.simulatePG.confirm('Verranno cancellate tutte le edizioni presenti sul tuo tablet.\nSei sicuro?', 'impostazioniCancellaContenutoLocaleSucc()', 'Cancellazione contenuto locale', 'Si,No');

		setTimeout(function() {
			dentro_click = 0;
		}, 1000);
	}
}

/*
 * Aggancio abbonamento cartaceo
 */
function impostazioniCartaceoAgganciaAbbonamento() {
	var l_sub_code = $('#cartaceo_codice_abbonato').val();
	var l_sub_cap = $('#cartaceo_cap').val();
	if ((l_sub_code.length <= 0) || (l_sub_cap.length <= 0)) {
		abutils.alert('Inserire il proprio Codice Abbonato e il CAP', 'Aggancio abbonamento');
		return;
	}
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"userIdentity" : _USER_IDENTITY
	};
	var l_req_data = {
		"username" : _USERNAME,
		"deviceID" : device.uuid,
		"deviceType" : device.platform,
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"subscriptionCode" : l_sub_code,
		"subscriptionType" : "XXX",
		"cap" : l_sub_cap
	};
	console.log('---REQ---> subscription-paper');
	console.log(l_req_headers);
	console.log(l_req_data);
	window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "Richiesta in corso..."]);
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "subscription-paper.json",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log('---RESP--> subscription-paper');
			console.log(p_response);
			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response, impostazioniCartaceoAgganciaAbbonamento)) {
				abutils.alert('Il tuo abbonamento cartaceo è stato associato al tuo profilo', 'Aggancio abbonamento');
				$('#impostazioni_body_menu_container_box_' + _CODICE_PRODOTTO_QUOTIDIANO).click();
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			} else if (p_response.Exception.Name != 'ExpiredUserIdentityException') {
				abutils.alert(p_response.Exception.Description, 'Aggancio abbonamento');
				// navigator.notification.loadingStop();
				window.simulatePG.exec(null, null, "Notification", "activityStop", []);
			}
		},
		error : function() {
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Aggancio abbonamento');
			navigator.notification.loadingStop();
		}
	});
}/**

 * @author mconventi
 */
_RICHOFFLINE_FILTRO_EDIZIONI = new Array();
var _MOD_OFFLINE = null;
// var _EDICOLA_OFFLINE_MODE = 'ICONS';
var _EDICOLA_OFFLINE_MODE = 'LIST';
// console.log('PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS');
function enableOfflineMode() {
	if (_MOD_OFFLINE != true) {
		_MOD_OFFLINE = true;

		// if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineOpen();
		// }
	}
}

function enableOnlineMode() {
	if (_MOD_OFFLINE != false) {

		var l_first_run = _MOD_OFFLINE == null;

		_MOD_OFFLINE = false;

		// if ($('#appmenu_edicola').hasClass('appmenu_edicola_on')) {
		edicolaOfflineClose(!l_first_run);
		// }
	}
}

function edicolaOfflineOpen() {
	edicolaOfflineInitFilter();
	edicolaOfflineLoad('LIST');
	$('#edicola_offline').css('display', 'inline-block');
	$('#edicola').css('display', 'none');

	// CLOSE OPENED ARCHIVES
	if ($('#archivio_titolo_chiudi_edicola').is(':visible'))
		$('#archivio_titolo_chiudi_edicola').trigger('click');
	if ($('#archivio_titolo_chiudi_sfoglio').is(':visible'))
		$('#archivio_titolo_chiudi_sfoglio').trigger('click');
	if ($('#qarchivio_titolo_chiudi_edicola').is(':visible'))
		$('#qarchivio_titolo_chiudi_edicola').trigger('click');
	if ($('#qarchivio_titolo_chiudi_sfoglio').is(':visible'))
		$('#qarchivio_titolo_chiudi_sfoglio').trigger('click');

	// disabilito impostazioni
	$('#impostazioni_body_menu_container_box_lista_prodotti').css('display', 'none');
	$('#impostazioni_body_menu_container_box_codicepromozionale').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_agganciaprofilo').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_profilo').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_prodottoprincipale').css('display', 'none');
	$('#impostazioni_body_vista_container_generali_memoria').hide();
	impostazioniOpenGenerali();

	if (window.innerWidth < 790 || window.innerWidth == 1024) {
		$("#edicola_offline_filtro").hide();
	}
}

function edicolaOfflineClose(reloadEdicola) {
	console.log("database reloadEdicola " + reloadEdicola);
	if (reloadEdicola) {
		/*
		 * navigator.notification.loadingStart({ 'labelText': "ModalitÃ
		 * on-line...", 'backgroundOpacity': 0.80, 'strokeOpacity': 0.25,
		 * 'strokeColor': "FFFFFF", });
		 */
		window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento", "ModalitÃ  on-line..."]);

		setTimeout(function() {
			_DB = null;

			// window.simulatePG.relaod();

			window.location = 'galaxy.html';

			/*
			 * $('#edicola_container').show(); $('#edicola_prodotto').show();
			 * $('#edicola').css('display', 'inline-block');
			 * $('#edicola_offline').css('display', 'none'); loadProducts();
			 *
			 * window.simulatePG.exec(null, null, "Notification",
			 * "activityStop", []);
			 */
		}, 1500);
	} else {
		$('#edicola_container').hide();
		$('#edicola_prodotto').hide();
		$('#edicola').css('display', 'inline-block');
		$('#edicola_offline').css('display', 'none');
		loadProducts();
	}

	$('#impostazioni_body_vista_container_generali_memoria').show();
}

var _EDICOLA_OFFLINE_ISCROLL = null;
function edicolaOfflineUpdateIscroll() {
	if (!_MOD_OFFLINE)
		return;
	setTimeout(function() {
		if (_EDICOLA_OFFLINE_ISCROLL == null) {
			_EDICOLA_OFFLINE_ISCROLL = new iScroll('edicola_offline_wrapper', {
				hideScrollbar : false
			});
		} else {
			_EDICOLA_OFFLINE_ISCROLL.refresh();
			_EDICOLA_OFFLINE_ISCROLL.scrollTo(0, 0, 0);
		}
	}, 100);
}

/**
 * Carica gli articoli salvati in locale
 */
function edicolaOfflineLoad(mode) {

	_EDICOLA_OFFLINE_MODE = mode;

	if (_EDICOLA_OFFLINE_ISCROLL != null) {
		_EDICOLA_OFFLINE_ISCROLL.destroy();
		_EDICOLA_OFFLINE_ISCROLL = null;
	}

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			$('#edicola_offline_container').empty();
			$('#edicola_offline_subtitolo_opzioni_vista_ICONS').removeClass('edicola_offline_subtitolo_opzioni_vista_ICONS_on');
			$('#edicola_offline_subtitolo_opzioni_vista_LIST').removeClass('edicola_offline_subtitolo_opzioni_vista_LIST_on');
			$('#edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE).addClass('edicola_offline_subtitolo_opzioni_vista_' + _EDICOLA_OFFLINE_MODE + '_on');

			var len = p_results.rows.length;
			console.log("edicolaOfflineLoad: read items:" + len);

			for (var i = 0; i < p_results.rows.length; i++) {
				if (_EDICOLA_OFFLINE_MODE == 'ICONS') {
					edicolaOfflineRenderAsIcon(p_results.rows.item(i));
				} else {
					edicolaOfflineRenderAsList(p_results.rows.item(i));
				}
				edicolaOfflineUpdateFilter(p_results.rows.item(i));
			}

			// Eseguendo l'evento di change del filtro prodotti, anche in caso
			// di switch della vista si otterrÃ
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#edicola_offline_filtro').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 7));
			} else {
				$('.edicola_offline_container_box_ICONS').height(Math.round(window.innerHeight / 4));
			}

			edicolaOfflineUpdateIscroll();
			updateRichFiltroOff();
		}
		var queryError = function(p_error) {
			console.log("edicolaOfflineLoad: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM issues order by issue DESC', [], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un oggetto in locale come icona
 *
 * @params p_item Oggetto in locale come salvato nel db issues
 */
function edicolaOfflineRenderAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	// box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
	// + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'edicola_offline_container_box_img_div';
	img_div.id = 'edicola_offline_container_box_icon_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	$(img_div).click(function() {
		if (!$('#edicola_offline_container').hasClass('edicola_offline_modify'))
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	box.appendChild(img_div);

	var img = document.createElement('img');
	img_div.appendChild(img);
	img.className = 'edicola_offline_container_box_img';
	// img.src = navigator.fileMgr.docsFolderPath + '/issues/' + p_item.testata
	// + '/' + p_item.issue + '/' + p_item.edizione + '/cover.jpg';
	// ANDROID MODDED
	img.src = window.folder.getDir() + /*
	 * navigator.fileMgr.libFolderPath +
	 * 'file:///mnt/sdcard/'
	 */'/' + p_item.testata + '/' + p_item.issue + '/' + p_item.edizione + '/cover_low.jpg';
	// console.log("path-off:: "+navigator.fileMgr.libFolderPath +
	// 'file:///mnt/sdcard/' + p_item.testata + '/' + p_item.issue + '/' +
	// p_item.edizione + '/cover_low.jpg');

	var txt = document.createElement('div');
	txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
	txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong><br/>' + p_item.issue_descr + '<br />' + p_item.edizione_descr;
	box.appendChild(txt);

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'edicola_offline_container_box_txt_empty_' + _EDICOLA_OFFLINE_MODE;
	$(txt_local).click(function() {
		if ($('#edicola_offline_container').hasClass('edicola_offline_modify')) {
			eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
		}
	});
}

/**
 * Crea la rappresentazione in lista di un oggetto salvato in locale
 *
 * @params p_item Oggetto salvato in locale
 *
 */
function edicolaOfflineRenderAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('edicola_offline_container').appendChild(box);
	// box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE
	// + ' edicola_offline_' + p_item.testata + '_' + p_item.edizione;
	box.className = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + ' edicola_offline_' + edicolaOfflineLabelToValue(p_item.edizione_descr);
	box.id = 'edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'edicola_offline_container_box_txt_' + _EDICOLA_OFFLINE_MODE;
	// txt.innerHTML = '<strong>' + p_item.testata_descr + '</strong> ' +
	// p_item.edizione_descr + ' ' + p_item.issue_descr;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> ' + p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	var btn = document.createElement('input');
	btn.id = 'edicola_offline_container_box_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 edicola_offline_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'edicola_offline_container_box_del_btn_' + p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 edicola_offline_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);
}

/**
 * Inizializza il filtro sulle testate/edizioni da mostrare.
 */
_EDICOLA_OFFLINE_FILTRO_EDIZIONI = null;
function edicolaOfflineInitFilter() {
	if (_EDICOLA_OFFLINE_FILTRO_EDIZIONI != null) {
		$(_EDICOLA_OFFLINE_FILTRO_EDIZIONI).empty();
	} else {
		_EDICOLA_OFFLINE_FILTRO_EDIZIONI = new Array();
	}
	var l_filtro_select = $('#edicola_offline_filtro');
	l_filtro_select.empty();

	l_filtro_select.change(function() {
		var l_selected_option = $('#edicola_offline_filtro option:selected');

		if (l_selected_option.val() == '') {
			// $('#edicola_offline_container
			// .edicola_offline_container_box_' +
			// _EDICOLA_OFFLINE_MODE).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).css('display', 'inline-block');
		} else {
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE).not('.edicola_offline_' + l_selected_option.val()).css('display', 'none');
			// $('#edicola_offline_container
			// .edicola_offline_container_box_' +
			// _EDICOLA_OFFLINE_MODE + '.edicola_offline_' +
			// l_selected_option.val()).fadeIn(200);
			$('#edicola_offline_container .edicola_offline_container_box_' + _EDICOLA_OFFLINE_MODE + '.edicola_offline_' + l_selected_option.val()).css('display', 'inline-block');
		}

		edicolaOfflineUpdateIscroll();
	});

	var l_option = $('<option value="" selected="selected">Tutti i prodotti</option>');
	l_filtro_select.append(l_option);

	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_RICHOFFLINE_FILTRO_EDIZIONI.push(row);
}

/**
 * Gestisce la creazione del filtro sui prodotti da mostrare.
 *
 * @params p_item Oggetto salvato in locale
 */
function edicolaOfflineLabelToValue(p_label) {
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function edicolaOfflineUpdateFilter(p_item) {
	// var l_value = p_item.testata + '_' + p_item.edizione;
	var l_value = edicolaOfflineLabelToValue(p_item.edizione_descr);
	// var l_text = p_item.testata_descr + ' - ' + p_item.edizione_descr;
	var l_text = p_item.edizione_descr;
	// Se l'edizione non è presente nell'array _EDICOLA_OFFLINE_FILTRO_EDIZIONI
	// crea un nuovo elemento nell'array ed aggiunge un opzione nel filtro
	if (jQuery.inArray(l_value, _EDICOLA_OFFLINE_FILTRO_EDIZIONI) == -1) {

		_EDICOLA_OFFLINE_FILTRO_EDIZIONI.push(l_value, l_text);

		var row = {
			value : l_value,
			label : l_text
		};
		console.log('rich ' + row.value + ',' + row.label);
		_RICHOFFLINE_FILTRO_EDIZIONI.push(row);

		// alert(_RICHOFFLINE_FILTRO_EDIZIONI.length);

		var l_option = $('<option></option>');
		l_option.val(l_value);
		l_option.text(l_text);
		$('#edicola_offline_filtro').append(l_option);
	}
}

function updateRichFiltroOff() {
	var value_select = $('#edicola_offline_filtro option:selected').val();
	var dhtmlx_listProductsSelectOff = _RICHOFFLINE_FILTRO_EDIZIONI;

	$$('myRichOffselect').attachEvent("onchange", /* impostazioniProdottoPrincipaleSelectOnChange() */
	function(newv, oldv) {
		setTimeout(function() {
			if (oldv != newv) {

				$('#edicola_offline_filtro option:selected').removeAttr('selected');

				if (newv.indexOf('Tutti i prodotti') == -1) {
					$("#edicola_offline_filtro option[value='" + newv + "']").attr('selected', 'selected');
				} else {
					// alert('aaa'+newv);
					$("#edicola_offline_filtro option[value='']").attr('selected', 'selected');
				}
				console.log('changed');
				edicolaOfflineLoad(_EDICOLA_OFFLINE_MODE);
			}
		}, 200);

	});

}

/**
 * Passa alla modalitÃ modifica
 */
function edicolaOfflineModifica() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'none');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'inline-block');
	$('#edicola_offline_container').addClass('edicola_offline_modify');
}

/**
 * Passa alla modalitÃ visualizza
 */
function edicolaOfflineVisualizza() {
	$('#edicola_offline_subtitolo_opzioni_modifica').css('display', 'inline-block');
	$('#edicola_offline_subtitolo_opzioni_visualizza').css('display', 'none');
	$('#edicola_offline_container').removeClass('edicola_offline_modify');
}

var _INBOX_LIST_ISCROLL = null;
var _INBOX_MESSAGES = {};
var _INBOX_NUM_UNREAD_MESSAGES = 0;

function inboxRefreshInCorso() {
	$('#inbox_list_refresh_button').css('display', 'none');
	$('#inbox_list_refresh_message').html('Aggiornamento in corso...');
}

function inboxRefreshCompletato() {
	setTimeout(function() {
		$('#inbox_list_refresh_button').css('display', 'inline');
		$('#inbox_list_refresh_message').html('<strong>Aggiornato</strong> ' + (new Date()).format('dd/mm/yyyy') + ' <strong>' + (new Date()).format('HH:MM:ss') + '</strong>');
	}, 1000);
}

/*
 * Restituisce i messaggi presenti nel database locale @return Lista di messaggi
 */
function inboxLoadMessages() {

	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.destroy();
		_INBOX_LIST_ISCROLL = null;
	}

	$('#inbox_list_container').empty();

	// Controlla che il database sia stato inizializzato e carica i messaggi
	if (_DB) {

		var querySuccess = function(tx, p_results) {
			var len = p_results.rows.length;
			// console.log("Read " + len + " messages from the local INBOX
			// store.");

			inboxAddMessages(p_results.rows);

			inboxLoadUnreadMessages();

			// inboxOpenFirstMessageSilent();

			setInterval(inboxLoadUnreadMessages, _INTERVALLO_CHECK_INBOX);
		}
		var queryError = function(p_error) {
			console.log("inboxLoadMessages: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			// tx.executeSql('DROP TABLE IF EXISTS INBOX_MESSAGES_2');
			tx.executeSql('CREATE TABLE IF NOT EXISTS INBOX_MESSAGES_2 (id unique, date, subject, mabstract, body, status)');
			tx.executeSql('SELECT id, date, subject, mabstract, body, status FROM INBOX_MESSAGES_2 order by date asc, id asc', [], querySuccess, queryError);
		}
		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
}

function inboxCloseMsgView() {
	// $('#inbox_msg_container').css('display', 'none');
	$('#inbox_container').removeClass('inbox_container_open');
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
}

function inboxUpdateOrientation() {
	document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';

	console.log('inboxUpdateOrientation ' + $('#inbox_container').hasClass('inbox_container_open') + ',' + document.getElementById('inbox_container').className);

	// se aperto msg inbox lo riapro quando sono in verticale
	if ($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width < 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if ($('#inbox_container').hasClass('inbox_container_open') && _ORIENTATION == 'V' && screen.width > 790) {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	}

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.refresh();
	}
	if (_INBOX_LIST_ISCROLL != null) {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 *
 * @params p_messages_list Lista dei messaggi
 */
function inboxAddMessages(p_messages_list) {

	for (var i = 0; i < p_messages_list.length; i++) {

		inboxAddMessage(p_messages_list.item(i));

	}

	/*
	 * console.log('Messaggi presenti in locale:');
	 * console.log(_INBOX_MESSAGES);
	 */
}

function inboxAddMessage(p_message) {
	_INBOX_MESSAGES['mid_' + p_message.id] = {
		id : p_message.id,
		subject : p_message.subject,
		mabstract : p_message.mabstract,
		date : p_message.date,
		body : p_message.body,
		status : p_message.status
	};

	inboxRenderHeader(p_message.id);

	inboxUpdateUnreadMessage();
}

/**
 * Carica i messaggi non letti in base al device
 */
var _INBOX_TOBEFETCH_MSGS = [];
var _INBOX_REFRESH_ISRUNNING = false;
function inboxLoadUnreadMessages() {

	if (_INBOX_REFRESH_ISRUNNING || (_INBOX_TOBEFETCH_MSGS.length > 0)) {
		console.log('Aggiornamento giÃ  in corso...');
		return;
	}

	_INBOX_REFRESH_ISRUNNING = true;

	inboxRefreshInCorso();

	// console.log('Retrieve unread messages');
	var l_signature = getSignature(device.uuid + ',' + device.platform);
	// console.log('Signature: ' + l_signature);

	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"deviceID" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> getUnreadMessagesDevice');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getUnreadMessagesDevice",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getUnreadMessagesDevice');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				for (var i = 0; i < p_response.Result.messages.length; i++) {
					var l_message = p_response.Result.messages[i];
					_INBOX_TOBEFETCH_MSGS.push({
						id : l_message.id,
						subject : l_message.subject,
						mabstract : "",
						date : l_message.data,
						body : "",
						status : 1
					});
				}

				inboxFetchMessages();

			} else {
				inboxRefreshCompletato();
			}

			_INBOX_REFRESH_ISRUNNING = false;
		},
		error : function() {
			inboxRefreshCompletato();

			_INBOX_REFRESH_ISRUNNING = false;
		}
	});

}

function inboxFetchMessages() {
	var l_message = _INBOX_TOBEFETCH_MSGS.shift();
	if (l_message == null) {
		inboxRefreshCompletato();
		// inboxOpenFirstMessageSilent();
		return;
	}
	console.log(l_message);

	// scarico in locale il messaggio
	var l_req_headers = {
		"appKey" : _API24_APPKEY
	};
	var l_req_data = {
		"messageId" : l_message.id
	};
	console.log('---REQ---> getMessageBody (' + l_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);

	$.ajax({
		type : "GET",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/getMessageBody",
		headers : l_req_headers,
		data : l_req_data,
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> getMessageBody (' + l_message.id + ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {

				l_message.body = p_response.Result.body;

				if (p_response.Result.preview) {
					l_message.mabstract = p_response.Result.preview;
				} else {
					l_message.mabstract = "";
				}

				inboxMarkAsReadMessageOnServer(l_message);

			} else {
				inboxFetchMessages();
			}
		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxMarkAsReadMessageOnServer(p_message) {
	var l_signature = getSignature(p_message.id + ',' + device.uuid + ',' + device.platform);
	var l_req_headers = {
		"appKey" : _API24_APPKEY,
		"Signature" : l_signature
	};
	var l_req_data = {
		"messageId" : p_message.id,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};
	console.log('---REQ---> markMessageReadDevice (' + p_message.id + ')');
	console.log(l_req_headers);
	console.log(l_req_data);
	$.ajax({
		type : "POST",
		timeout : _AJAX_TIMEOUT,
		cache : false,
		contentType : "application/json; charset=utf-8",
		url : _API24_ENDPOINT + "MessageBroadcasting/markMessageReadDevice",
		headers : l_req_headers,
		processData : false,
		data : JSON.stringify(l_req_data),
		dataType : "json",
		success : function(p_response) {

			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}

			console.log('---RESP--> markMessageReadDevice (' + p_message.id + ')');
			console.log(p_response);

			// Controlla la risposta avuta dal server
			if (checkAjaxResponse(p_response)) {
				// processo verso server completato, posso salvare il messaggio
				// in locale
				inboxStoreMessageFromServer(p_message);
			} else {
				inboxFetchMessages();
			}

		},
		error : function() {
			inboxFetchMessages();
		}
	});
}

function inboxStoreMessageFromServer(p_message) {
	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxStoreMessageFromServer OK');
			inboxAddMessage(p_message);
			inboxFetchMessages();
		}
		var queryError = function(p_error) {
			console.log("inboxStoreMessageFromServer KO: Error processing SQL: " + p_error.message);
			inboxFetchMessages();
		}
		var executeQuery = function(tx) {
			tx.executeSql('INSERT INTO INBOX_MESSAGES_2 (id, date, subject, mabstract, body, status) VALUES (?,?,?,?,?,?)', [p_message.id, p_message.date, p_message.subject, p_message.mabstract, p_message.body, p_message.status], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}
}

/**
 * Aggiunge l'intestazione di un messaggio
 *
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function inboxRenderHeader(p_mid) {
	var box = document.createElement('div');

	var l_container = document.getElementById('inbox_list_container');
	l_container.insertBefore(box, l_container.childNodes[0]);

	if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
		box.className = 'inbox_list_container_box inbox_list_container_box_read';
	} else {
		box.className = 'inbox_list_container_box inbox_list_container_box_unread';
	}

	box.id = 'inbox_list_container_box_' + p_mid;

	var table = document.createElement('table');
	box.appendChild(table);
	table.className = 'inbox_list_container_box_table';

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 *
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 *
	 * var td12 = document.createElement('td');
	 */

	var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
	if (l_subject && l_subject != '') {
		if (screen.width < 790) {
			l_subject = l_subject.substring(0, 25);
		} else {
			l_subject = l_subject.substring(0, 40);
		}
		if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
			l_subject += '...'
	}

	/*
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 *
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 */

	var tr2 = document.createElement('tr');
	table.appendChild(tr2);

	var td21 = document.createElement('td');
	tr2.appendChild(td21);
	td21.className = 'inbox_list_container_box_c1_status';
	// Gestisce la selezione dei messaggi quando l'utente si trova nella
	// tipologia "modifica"
	td21.onclick = function(p_event) {
		var l_message_header = $('#inbox_list_container_box_' + p_mid);

		if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
			l_message_header.removeClass('inbox_list_container_box_unselected');
			l_message_header.addClass('inbox_list_container_box_selected');

		} else if (l_message_header.hasClass('inbox_list_container_box_selected')) {
			l_message_header.removeClass('inbox_list_container_box_selected');
			l_message_header.addClass('inbox_list_container_box_unselected');
		}

		p_event.stopPropagation();
	};
	td21 = null;

	var td22 = document.createElement('td');
	tr2.appendChild(td22);
	td22.className = 'inbox_list_container_box_c2';
	td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
	td22 = null;

	var td23 = document.createElement('td');
	tr2.appendChild(td23);
	td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	td23 = null;

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 *
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 *
	 * var td12 = document.createElement('td');
	 *
	 * var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject; if (l_subject &&
	 * l_subject != '') { l_subject = l_subject.substring(0, 40); if
	 * (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
	 * l_subject += '...' }
	 *
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 *
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 *
	 * var tr2 = document.createElement('tr'); table.appendChild(tr2);
	 *
	 * var td21 = document.createElement('td'); tr2.appendChild(td21);
	 * td21.className = 'inbox_list_container_box_c1_status'; // Gestisce la
	 * selezione dei messaggi quando l'utente si trova nella tipologia
	 * "modifica" td21.onclick = function(p_event){ var l_message_header =
	 * $('#inbox_list_container_box_' + p_mid);
	 *
	 * if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
	 * l_message_header.removeClass('inbox_list_container_box_unselected');
	 * l_message_header.addClass('inbox_list_container_box_selected'); } else if
	 * (l_message_header.hasClass('inbox_list_container_box_selected')) {
	 * l_message_header.removeClass('inbox_list_container_box_selected');
	 * l_message_header.addClass('inbox_list_container_box_unselected'); }
	 *
	 * p_event.stopPropagation(); }; td21 = null;
	 *
	 * var td22 = document.createElement('td'); tr2.appendChild(td22);
	 * td22.className = 'inbox_list_container_box_c2'; td22.innerHTML = '<h3>' +
	 * _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>'; td22 = null;
	 *
	 * var td23 = document.createElement('td'); tr2.appendChild(td23);
	 * td23.className = 'inbox_list_container_box_c3_goto'; td23 = null;
	 */

	box.onclick = (function(p_mid) {
		return function() {
			inboxOpenMessage(p_mid);
		}
	})(p_mid);

	box = null;

	if (_INBOX_LIST_ISCROLL == null) {
		_INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
	} else {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

/*
 * function inboxOpenFirstMessageSilent() { var l_opened =
 * $('.inbox_list_container_box_active'); if (l_opened.length == 0) { var
 * l_boxes = $('.inbox_list_container_box'); if (l_boxes.length > 0) {
 * console.log(l_boxes); $(l_boxes[0]).click(); inboxCloseMsgView(); } } }
 */

var _INBOX_MSG_ISCROLL = null;
function inboxOpenMessage(mid) {

	if (_INBOX_MSG_ISCROLL != null) {
		_INBOX_MSG_ISCROLL.destroy();
		_INBOX_MSG_ISCROLL = null;
	}

	inboxInitNavButtons(mid);

	$('#inbox_msg_title_content_del').css('display', 'inline-block');
	$('#inbox_msg_container_empty').css('display', 'none');

	var l_message_container = $('#inbox_msg_container');
	l_message_container.css('display', 'inline-block');

	var box = document.getElementById('inbox_list_container_box_' + mid);
	$('.inbox_list_container_box').removeClass('inbox_list_container_box_active');
	$(box).addClass('inbox_list_container_box_active');
	$(box).removeClass('inbox_list_container_box_unread');
	$(box).addClass('inbox_list_container_box_read');
	box = null;

	/*
	 * if (_ORIENTATION == 'V' && screen.width < 790){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(-400px, 0px, 0)'; } else if (_ORIENTATION == 'V' &&
	 * screen.width > 790){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(-800px, 0px, 0)'; } else if(_ORIENTATION == 'H'){
	 * document.getElementById('inbox_container').style['-webkit-transform'] =
	 * 'translate3d(0px, 0px, 0)'; }
	 */

	if (_ORIENTATION == 'V') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(-' + window.innerWidth + 'px, 0px, 0)';
	} else if (_ORIENTATION == 'H') {
		document.getElementById('inbox_container').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
	}

	// .className+=' newclass'
	// document.getElementById('inbox_container').className +=
	// 'inbox_container_open';
	// alert('aaa'+document.getElementById('inbox_container').className);
	$('#inbox_container').addClass('inbox_container_open');
	// alert('aaa'+document.getElementById('inbox_container').className);
	// document.getElementById('inbox_container').className +=
	// 'inbox_container_open';

	if (_INBOX_MESSAGES['mid_' + mid] == null)
		return;

	document.getElementById('inbox_msg_header_title').innerHTML = _INBOX_MESSAGES['mid_' + mid].subject;
	document.getElementById('inbox_msg_header_data').innerHTML = inboxFormatDate(_INBOX_MESSAGES['mid_' + mid].date);
	document.getElementById('inbox_msg_body').innerHTML = _INBOX_MESSAGES['mid_' + mid].body;
	_INBOX_MESSAGES['mid_' + mid].status = 0;
	inboxUpdateUnreadMessage();

	setTimeout(function() {
		if (_INBOX_MSG_ISCROLL == null) {
			_INBOX_MSG_ISCROLL = new iScroll('inbox_msg_wrapper');
		} else {
			_INBOX_MSG_ISCROLL.refresh();
		}
	}, 100);

	// marco il messaggio come letto sul db
	if (_DB) {

		var querySuccess = function() {
			console.log('inboxOpenMessage OK');
		}
		var queryError = function(p_error) {
			console.log("inboxOpenMessage KO: Error processing SQL: " + p_error.message);
			inboxFetchMessages();
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE INBOX_MESSAGES_2 SET status=0 WHERE id=?', [mid], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

	omnitureTrackApp('APP:inbox:open:' + mid, 'APP:inbox');
}

function inboxUpdateUnreadMessage() {
	_INBOX_NUM_UNREAD_MESSAGES = 0;
	for (var key in _INBOX_MESSAGES) {
		var l_msg = _INBOX_MESSAGES[key];
		if (l_msg.status == 1)
			_INBOX_NUM_UNREAD_MESSAGES++;
	}

	if (_INBOX_NUM_UNREAD_MESSAGES > 0) {
		// $('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
		// $('#appmenu_inbox_count').text('*');
		$('#appmenu_inbox_count').css('display', 'inline-block');
	} else {
		$('#appmenu_inbox_count').css('display', 'none');
	}
}

function inboxFormatDate(p_date) {
	if (p_date.length != 19)
		return "00 00 0000";
	var toks = p_date.split(' ');
	if (toks.length != 2)
		return "00 00 0000";
	var cals = toks[0].split('-');
	if (cals.length != 3)
		return "00 00 0000";
	return cals[2] + ' ' + cals[1] + ' ' + cals[0];
}

/**
 * Passa alla modalitÃ modifica messaggi
 */
function inboxSwitchToModifyView() {
	$('#inbox_list_modify_button').hide();
	$('#inbox_list_show_button').show();
	$('.inbox_list_container_box').addClass('inbox_list_container_box_unselected');
	$('#elimina_messaggi').fadeIn();
}

/**
 * Passa alla modalitÃ visualizza messaggi
 */
function inboxSwitchToShowView() {
	$('#inbox_list_show_button').hide();
	$('#inbox_list_modify_button').show();
	$('.inbox_list_container_box.inbox_list_container_box_unselected').removeClass('inbox_list_container_box_unselected');
	$('.inbox_list_container_box.inbox_list_container_box_selected').removeClass('inbox_list_container_box_selected');
	$('#elimina_messaggi').fadeOut();
}

/**
 * Inizializza lo stato dei pulsanti per la navigazione tra i messaggi
 */
function inboxInitNavButtons(p_header_id) {
	// console.log("inboxInitNavButton");
	var l_next_element = $('#inbox_msg_title_nav_next_btn');
	l_next_element.unbind('click');

	var l_prev_element = $('#inbox_msg_title_nav_prev_btn');
	l_prev_element.unbind('click');

	if ($('#inbox_list_container_box_' + p_header_id).prev().length) {
		l_next_element.removeClass('disabled');
		l_next_element.click(function() {
			inboxOpenPrevMsg(p_header_id);
		});
	} else {
		l_next_element.addClass('disabled');
	}

	if ($('#inbox_list_container_box_' + p_header_id).next().length) {
		$('#inbox_msg_title_nav_prev_btn').removeClass('disabled');
		l_prev_element.click(function() {
			inboxOpenNextMsg(p_header_id);
		});
	} else {
		$('#inbox_msg_title_nav_prev_btn').addClass('disabled');
	}
}

/**
 * Apre il messaggio successivo
 */
function inboxOpenPrevMsg(p_header_id) {
	var l_prev = $('#inbox_list_container_box_' + p_header_id).prev();
	if (l_prev.length) {
		var mid = l_prev[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}

/**
 * Apre il messaggio precedente
 */
function inboxOpenNextMsg(p_header_id) {
	var l_next = $('#inbox_list_container_box_' + p_header_id).next();
	if (l_next.length) {
		var mid = l_next[0].id.substr(25);
		inboxOpenMessage(mid);
	}
}

/*
 * Elimina i messaggi dal database @params p_mids Lista dei identificativi dei
 * messaggi
 */
function deleteLocalMessages(p_mids) {

	// Controlla che il database sia stato inizializzato e salva il messaggio in
	// locale
	if (_DB && p_mids.length > 0) {

		var querySuccess = function() {
			console.log('Deleted messages ' + p_mids.toString());
			deleteInboxElements(p_mids);
		}
		var queryError = function(p_error) {
			console.log("deleteLocalMessages: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('DELETE FROM INBOX_MESSAGES_2 WHERE id in (' + p_mids.toString() + ')');
			// querySuccess();
		}

		_DB.transaction(executeQuery, queryError, querySuccess);
	}
}

/**
 * Elimina i messaggi selezionati in modalitÃ modifica
 */
function inboxDeleteMessages() {
	var l_messages = $('.inbox_list_container_box.inbox_list_container_box_selected');
	var l_all_messages = [];

	for (var i = 0; i < l_messages.length; i++) {
		var l_mid = l_messages[i].id.substring(25);
		l_all_messages.push(l_mid);
	}

	if (l_all_messages.length > 0) {
		deleteLocalMessages(l_all_messages);
	} else {
		abutils.alert('Attenzione, non è stato selezionato nessun messaggio', 'Inbox');
	}

	/*
	 * var l_messages =
	 * $('.inbox_list_container_box.inbox_list_container_box_selected'); var
	 * l_remote_messages = []; var l_all_messages = [];
	 *
	 * for (var i = 0; i < l_messages.length; i++) { var l_mid =
	 * l_messages[i].id.substring(25); if (_INBOX_MESSAGES[l_mid]) {
	 * l_all_messages.push(l_mid);
	 *
	 * if (!_INBOX_MESSAGES[l_mid].body) { l_remote_messages.push(l_mid); } } } //
	 * I messaggi non scaricati vengono segnalati come giÃ letti if
	 * (l_remote_messages.length > 0) { markMessagesAsRead(l_remote_messages); } //
	 * Tutti i messaggi vengono eliminati dal database // (per evitare problemi
	 * dovuti alla sincronizzazione con chiamate remote si cerca di eliminare
	 * anche quelli che non sembrano essere stati scaricati) if
	 * (l_all_messages.length > 0) { deleteLocalMessages(l_all_messages); } else {
	 * alert('Attenzione, non è stato selezionato nessun messaggio'); }
	 */
}

/**
 * Elimina gli elementi html relativi ai messaggi
 *
 * @params p_mids Lista degli identificativi dei messaggi che devono essere
 *         eliminati
 */
function deleteInboxElements(p_mids) {
	var l_active_message = $('.inbox_list_container_box_active');
	if (l_active_message.length > 0) {
		var l_active_message_id = l_active_message[0].id.substring(25);

		if (jQuery.inArray(l_active_message_id, p_mids) != -1) {
			// $('#inbox_msg_container').css('display', 'none');
			inboxCloseMsgView();
		}
	}
	$('.inbox_list_container_box.inbox_list_container_box_selected').remove();
}

/**
 * Elimina il messaggio aperto
 */
function inboxDeleteOpenedMessage() {
	window.simulatePG.confirm('Il messaggio verrÃ  cancellato.\nSei sicuro?', 'inboxDeleteOpenedMessageSucc()', 'Cancellazione messaggio', 'Si,No');
}

(function() {
	var _HAS_TOUCH = 'ontouchstart' in window, _START_EV = _HAS_TOUCH ? 'touchstart' : 'mousedown', _MOVE_EV = _HAS_TOUCH ? 'touchmove' : 'mousemove', _END_EV = _HAS_TOUCH ? 'touchend' : 'mouseup', _CANCEL_EV = _HAS_TOUCH ? 'touchcancel' : 'mouseout';

	var CoveerFlow = function(container, covers) {
		this._container = typeof container == 'object' ? container : document.getElementById(container);
		this._covers = covers;
		this._initialization();

	};

	CoveerFlow.prototype = {
		_startX : 0,
		_startY : 0,
		_moveX : 0,
		_moveY : 0,
		_galleryHeight : 0,
		_touching : false,
		_moved : false,
		_initialization : function() {
			try {
				this._current = 0;
				this._totals = this._covers.length;
				this._stepPercent = 30;
				// 25;//15;
				this._currentSlidePaddingPercent = 50;
				// 25;
				this._rotateAngle = 0;
				// 65;
				this._loaded = 0;

				var gallery = document.createElement('div');
				this._container.appendChild(gallery);
				gallery.className = 'coveerflow';
				// gallery.style.visibility = 'hidden';
				console.log("gallery _ORIENTATION is " + _ORIENTATION);
				console.log("gallery " + parseInt(gallery.offsetHeight, 10) + "," + parseInt((window.innerHeight / 2) * 90 / 100));
				var galleryHeight = null;
				var slideHeight = null;
				if (_ORIENTATION == 'V') {
					galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
					slideHeight = galleryHeight;
				} else {
					galleryHeight = Math.round($('#edicola_prodotto').height());
					slideHeight = galleryHeight;
				}

				this._galleryHeight = galleryHeight;
				// slideHeight = galleryHeight ;//- 20;/*50/*AB150;*/

				this._step = galleryHeight * this._stepPercent / 100;
				this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;

				console.log('gal1 galleryHeight ' + galleryHeight);
				console.log('gal1 slideHeight ' + slideHeight);
				console.log('gal1 _step ' + this._step);
				console.log('gal1 _currentSlidePadding ' + this._currentSlidePadding);

				for (var i = 0; i < this._totals; i++) {
					var coverdiv = document.createElement('div');
					gallery.appendChild(coverdiv);

					console.log('gal1 slideHeight ' + slideHeight);

					coverdiv.style.height = '100%';

					var coverimg = document.createElement('img');
					coverdiv.appendChild(coverimg);

					if (this._covers[i]['anteprima']) {
						var anteprimaimg = document.createElement('img');
						anteprimaimg.className = 'coveerflow_anteprima';
						coverdiv.appendChild(anteprimaimg);
						anteprimaimg.src = 'imgs/coveerflow_anteprima.png';
						anteprimaimg = null;
					}

					if (this._covers[i]['abbonati']) {
						var abbonatiimg = document.createElement('img');
						abbonatiimg.className = 'coveerflow_abbonati';
						coverdiv.appendChild(abbonatiimg);
						abbonatiimg.src = 'imgs/coveerflow_abbonati2.png';
						abbonatiimg = null;
					}

					coverimg = null;
					coverdiv = null;
				}

				gallery = null;

				this._bind(_START_EV);
				this._bind(_MOVE_EV);
				this._bind(_END_EV);
				this._bind(_CANCEL_EV);

				// parte aggiunta per evitare l'attesa dell'onload delle
				// immagini
				this._display();
				var that = this;
				setTimeout(function() {
					that._setAnimation();
				}, 100);
				// alert('ok'+_ORIENTATION);
			} catch (exc) {
				console.log(exc.message)
			}
		},
		_setAnimation : function() {
			var coverdivs = this._container.children[0].children;
			for (var i = 0; i < coverdivs.length; i++) {
				coverdivs[i].style.webkitTransition = '-webkit-transform .3s ease-out';
			}
		},
		_display : function() {
			if (_ORIENTATION == 'V') {
				//galleryHeight = Math.round($('#edicola_prodotto').height() * 0.48);
				galleryHeight = Math.round($(window).height() - 60 - 60 - 70);
				slideHeight = galleryHeight;
			} else {
				galleryHeight = Math.round($('#edicola_prodotto').height());
				slideHeight = galleryHeight;
			}
			this._galleryHeight = galleryHeight;

			this._step = galleryHeight * this._stepPercent / 100;
			this._currentSlidePadding = galleryHeight * this._currentSlidePaddingPercent / 100;

			var galleryCenter = null;
			// 600 / 2;
			if (_ORIENTATION == 'V') {
				galleryCenter = Math.round(window.innerWidth * 0.5);
			} else {
				galleryCenter = Math.round($('#edicola_prodotto_coverflow').width() * 0.5);
			}
			console.log("gallcent: " + galleryCenter);
			var coverdivs = this._container.children[0].children;

			// alert("children "+this._container.children[0].children);

			for (var i = 0; i < this._totals; i++) {
				// var l_cover_width = parseInt(coverdivs[i].offsetWidth, 10);
				console.log("LLL: cover#" + i + " " + parseInt(window.innerWidth / 2 + 10));
				var l_cover_width = null;

				l_cover_width = Math.round(window.innerWidth * 0.8);

				//l_cover_width = galleryHeight / 1.175;
				$(coverdivs[i]).width(l_cover_width);

				this._step = l_cover_width / 4.2;

				if (i < this._current) {
					// precedenti - sinistra
					var leftPos = parseInt(galleryCenter - (this._current * this._step) + (i * this._step) - (l_cover_width / 2) - this._currentSlidePadding, 10);
					coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
				} else {
					if (i == this._current) {
						// corrente - centrale
						var leftPos = galleryCenter - (l_cover_width / 2);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					} else {
						// successivi - destra
						var leftPos = parseInt(galleryCenter + ((i - this._current) * this._step) - (l_cover_width / 2) + this._currentSlidePadding, 0);
						coverdivs[i].style.webkitTransform = 'translate3d(' + leftPos + 'px, 0px, 0px)';
					}

					coverdivs[i].style.display = 'inline-block';
					coverdivs[i].children[0].src = this._covers[i]['src'];
				}
			}
			
			//$('.coveerflow img').css('margin-top', '40px');
// 			$('.coveerflow img').each(function(){
// 				$(that).css('margin-top', Math.round((galleryHeight - $(that).height()) / 2));
// 				$(that).load(function(){
// 					alert(galleryHeight + ' ' + $(that).height());
// 					$(that).css('margin-top', Math.round((galleryHeight - $(that).height()) / 2));
// 				});
// 			});
		},
		_bind : function(type, element, bubble) {
			(element || this._container).addEventListener(type, this, !!bubble);
		},
		_unbind : function(type, element, bubble) {
			(element || this._container).removeEventListener(type, this, !!bubble);
		},
		handleEvent : function(e) {
			switch (e.type) {
				case _START_EV:
					this._e_start(e);
					break;
				case _MOVE_EV:
					this._e_move(e);
					break;
				case _END_EV:
				case _CANCEL_EV:
					this._e_end(e);
					break;
			}
		},
		_e_start : function(e) {
			e.preventDefault();
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._startX = _e.clientX;
			this._startY = _e.clientY;
			this._touching = true;
			this._moved = false;
			/*
			 * this._bind(_MOVE_EV); this._bind(_END_EV); this._bind(_CANCEL_EV);
			 * this._unbind(_START_EV);
			 */
		},
		_e_move : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;
			var _e = _HAS_TOUCH ? e.touches[0] : e;
			this._moveX = _e.clientX;
			this._moveY = _e.clientY;
			this._moved = true;
		},
		_e_end : function(e) {
			e.preventDefault();
			if (!this._touching)
				return;

			if (!this._moved) {
				if (this._touching) {
					if ( typeof this.on_tap != "undefined") {
						this.on_tap.call();
					}
				}
				return;
			}

			if (this._moveX - this._startX > 100)
				this._gotoPrev();
			else if (this._moveX - this._startX < -100)
				this._gotoNext();

			var that = this;
			setTimeout(function() {
				that._touching = false;
			}, 300);

			if (this.on_end) {
				this.on_end.call();
			}
			/*
			 * this._unbind(_MOVE_EV); this._unbind(_END_EV);
			 * this._unbind(_CANCEL_EV);
			 */
		},
		_gotoNext : function() {
			if (this._current + 1 >= this._totals)
				return;
			this._current++;
			this._display();
		},
		_gotoPrev : function() {
			if (this._current <= 0)
				return;
			this._current--;
			this._display();
		},
		destroy : function() {
			this._unbind(_START_EV);
			this._unbind(_START_EV);
			this._unbind(_MOVE_EV);
			this._unbind(_END_EV);
			this._unbind(_CANCEL_EV);
		}
	}

	window.CoveerFlow = CoveerFlow;
})();
/**
 * @author ABertacco
 */
var _NIELSEN_BASE_URL = "http://secure-it.imrworldwide.com/cgi-bin/m?ci=ilsole-app&cg=0&si=";

var _AREE = {
	'ALTRO' : 'http%3A//sfogliatoremobile.ilsole24ore.com',
	'EDICOLA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/edicola',
	'ARCHIVIO_PRODOTTI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/archivio_prodotti',
	'PREFERITI' : 'http%3A//sfogliatoremobile.ilsole24ore.com/preferiti',
	'RICERCA' : 'http%3A//sfogliatoremobile.ilsole24ore.com/ricerca',
	'INBOX' : 'http%3A//sfogliatoremobile.ilsole24ore.com/inbox',
	'REGISTRAZIONE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/registrazione',
	'SFOGLIATORE' : 'http%3A//sfogliatoremobile.ilsole24ore.com/sfogliatore'
}

function nielsenCall(area) {
	try {
		if (_AREE[area] == null)
			area = 'ALTRO';
		document.getElementById('nielsen_wrapper').innerHTML = '';
		var img = document.createElement('img');
		document.getElementById('nielsen_wrapper').appendChild(img);
		$(img).load(function() {
			console.log('nielsen load ' + area);
		});
		$(img).error(function() {
			console.log('nielsen error ' + area);
		});
		img.src = _NIELSEN_BASE_URL + _AREE[area];
		img = null;
	} catch (exc) {
		console.log('nielsen exception: ' + exc.message);
	}
}

/**
 * @author ABertacco
 */
function omnitureTrackApp(pageName, channel) {
	try {

		// PhoneGap.exec("AppMeasurementCommand.trackApp", pageName, channel);
		// window.plugins.flipper24.trackApp(null, null, pageName, channel);
		console.log("omniture:: " + pageName + ', ' + channel);
		window.infodroid.track(null, null, pageName, channel);

	} catch (exc) {

		// alert("ERROR OMNI");
	}

}

/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il
// dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];

	// PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();

	if ((id_shopping24 == null) || (id_itunes == null))
		return;

	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è giÃ presente nella lista dei prodotti di cui
	// conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è giÃ nella lista di quelli che devono essere
	// processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto giÃ  in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in
	// _IAP_REQ_QUEUE
	// var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	// PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null)
				continue;
			console.log('OK ' + l_product.productIdentifier);
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}

		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}

		return "OK";
	} catch (exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}

	navigator.notification.loadingStart({
		'labelText' : "Acquisto in corso...",
		'backgroundOpacity' : 0.8,
		'strokeOpacity' : 0.25,
		'strokeColor' : "FFFFFF",
	});

	_APPSTORE_BUY_CALLBACK = callback;

	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({
			Success : false,
			Exception : {
				Name : 'ExpiredUserIdentityException',
				Description : 'Rinnovo useridentity pre-pagamento.'
			}
		}, function() {
			// PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si puÃ² procedere all'acquisto
		// PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}





		_INBOX_NUM_UNREAD_MESSAGES = 0;
		var _ADV_PROXY = "http://mobapp24.ilsole24ore.com/adv_proxy_and.php"; // è da cambiare anche dentro allo sfogliatore e a Flipper24
		var _ADV_PROXY_TEST = "http://212.45.97.204/adv_proxy_and.php";
		var _API24TEST_SWITCH = false; // se a true, l'app utilizza la configurazione di stage
		
		var uuid_device = window.infodroid.getUUID();
		var PRODUCT_ID = 0;
		//alert(uuid_device);
		function upFromDB(){
    		var valoutput ;
    		console.log('passed... ');
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    			_INBOX_NUM_UNREAD_MESSAGES=valoutput;
    			
    		} 
    		else{
    			console.log('error');
    			throw "window.localStorage, not defined"; 
    		}

		}
		
		function updateUnreadMessage() {
			try{
			//upFromDB();
				setTimeout(function (){
					console.log('updateUnreadMessage:::passed... ');
				    if (_INBOX_NUM_UNREAD_MESSAGES > 0 ){
				        //$('#appmenu_inbox_count').text(_INBOX_NUM_UNREAD_MESSAGES);
				        //$('#appmenu_inbox_count').css('display', 'block');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'block';
				    } else {
				        //$('#appmenu_inbox_count').css('display', 'none');
				        var node = document.getElementById('appmenu_inbox_count');
				    	node.style.display = 'none';
		
				    }
				},1000);
			}catch(exc){
				console.log(exc.message);
			}
		}
		
		
		function loadExtra(){
			if(_API24TEST_SWITCH){
				_ADV_PROXY = _ADV_PROXY_TEST;
			}
			try{
			    loadAdvTabbar(PRODUCT_ID);
			    loadAdvCatalogo();
			}catch(exc){
				alert(exc.message);
			}
		}
		
		function loadAdvTabbar(product_id){
			//alert("CALL ME!!!");
			//document.getElementById('advtabbar_close').style.display = 'none';
			try{
		    document.getElementById('advtabbar_close_content').innerHTML = '';
		    //$('#advtabbar_close_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_02', function(){
			$('#advtabbar_close_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABARCLOSE&p=' + product_id + '&d=' + uuid_device, function(){
		        /*
				setTimeout(function() {
					var ret = false;
					try {

						var imgs = document.getElementById('advtabbar_close_content').getElementsByTagName('img');
						if(imgs != null || imgs.length >= 0) {
							for(var i = 0; i < imgs.length; i++) {
								if(parseInt(imgs[i].height) > 10) {
									ret = true;
								}
							}	
						}
						
					} catch(exc) {
						ret = false;
					}
					
					if (ret) {
						$('#advtabbar_close').fadeIn();
					}

				}, 100);
		        */
		    }).endCapture();
		    document.getElementById('advtabbar_open_content').innerHTML = '';
		    //$('#advtabbar_open_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_03', function(){
			$('#advtabbar_open_content').writeCapture().load(_ADV_PROXY + '?z=EDI_TABAROPEN&p=' + product_id + '&d=' + uuid_device, function(){
				setTimeout(function() {
				    	centerImage('advtabbar_open_content');
				}, 100);
		
		    }).endCapture();
		    }catch(exc){
		    	alert(exc.message);
		    }
		}

		var _TABBAR_ADV_IS_OPEN = false;
		function handleAdvTabbarClick(){
			var _width_close = $('#advtabbar_close_content img').first().width();
			// evita di aprire il contenuto se non c'è nulla caricato
			if ((_width_close == null) || (_width_close < 5)) return;
			//alert("CALL ME1!!!");
			_TABBAR_ADV_IS_OPEN = !_TABBAR_ADV_IS_OPEN;
		    document.getElementById('advtabbar_close').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_open').style['-webkit-transition'] = 'none';
		    document.getElementById('advtabbar_close').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    document.getElementById('advtabbar_open').style['-webkit-transform'] = 'translate3d(0px, ' + (_TABBAR_ADV_IS_OPEN ? '-160' : '0') + 'px, 0)';
		    window.resize.resizeweb(200, !_TABBAR_ADV_IS_OPEN);
			return false;
		}

		function loadAdvCatalogo(product_id){
			//alert("CALL ME2!!!");
			if(!product_id) return;
		    document.getElementById('edicola_prodotto_adv_content').innerHTML = '';
		    //$('#edicola_prodotto_adv_content').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + device.uuid + '@Ticker_01', function(){
			$('#edicola_prodotto_adv_content').writeCapture().load(_ADV_PROXY + '?z=EDI_VETRINA&p=' + product_id + '&d=' + uuid_device, function(){
		    }).endCapture();
		}
		
		function onBodyLoaded() {
			updateUnreadMessage();
			//alert('aaaa');
			loadExtra();
		}
		
		function centerImage(divname){
			try{
				console.log("CALLED");
				var screenwidth = screen.width;
				var screenheight = screen.height;
				if(screenwidth < screenheight){//verticale
					$("#" + divname + " img").load(function(){
						console.log("CALLED1");
			   			var currentImage = $(this);
			   			if(currentImage.width() > $("#" + divname).width()){//sposta indietro
			   				currentImage.css("margin-left", '-' + parseInt((currentImage.width() - $("#" + divname).width())/2) +"px");
			   			}else{//sposta avanti
			   				currentImage.css("margin-left", parseInt(($("#" + divname).width() - currentImage.width() )/2) +"px");
			   			}
			   			console.log(currentImage.css("margin-left"));
					});
				}else{//orizzontale
					$("#" + divname + " img").load(function(){
						console.log("CALLED1");
			   			var currentImage = $(this);
			   			if(currentImage.width() > $("#" + divname).width()){//sposta indietro
			   				currentImage.css("margin-left", '-' + parseInt((currentImage.width() - $("#" + divname).width())/2) +"px");
			   			}else{//sposta avanti
			   				currentImage.css("margin-left", parseInt(($("#" + divname).width() - currentImage.width() )/2) +"px");
			   			}
			   			console.log(currentImage.css("margin-left"));
					});
					
				}
			}catch(exc){
				alert(exc.message);
			}
		}
		
		
		
	document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
	





	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);

	}
	
	function onDeviceReady()
	{
		
		
       	console.log("NO IOS BRIDGE CALLBACK.");
       	console.log("Load green droid OS file!");
        	
            setTimeout(function(){
	            $('#splashscreen').css('display', 'none');

	    		window.location = 'galaxy.html';

            },3000);
        /*
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
        */
	}
    
    




function load() {
	try{   
		$("#progressbar").reportprogress(0);
		$("#progressbar1").reportprogress(0);
		$("#progressbar2").reportprogress(0);
		$("#progressbar3").reportprogress(0);
		$("#progressbar4").reportprogress(0);
		$("#progressbar5").reportprogress(0);
		
		PhoneGap.exec(null, null, "Notification", "activityStop", []);
	}catch(exc){
		alert(exc.message);
	}
}

var pct=0;
var pct1=0;
var pct2=0;
var pct3=0;
var pct4=0;
var pct5=0;
var handle=0;
var handle1=0;
var handle2=0;
var handle3=0;
var handle4=0;
var handle5=0;
function update(increment_var){
	
	if(increment_var == 'pct'){
        $("#progressbar").reportprogress(++pct);
        if(pct==100){
                clearInterval(handle);
                $("#run").val("sfoglia");
                pct=0;
        }
   }else if(increment_var == 'pct1'){
       $("#progressbar1").reportprogress(++pct1);
       if(pct1==100){
               clearInterval(handle1);
               $("#run1").val("sfoglia");
               //pct1=0;
       }
	}else if(increment_var == 'pct2'){
	       $("#progressbar2").reportprogress(++pct2);
	       if(pct2==100){
	               clearInterval(handle2);
	               $("#run2").val("sfoglia");
	               pct2=0;
	       }
	}else if(increment_var == 'pct3'){
	       $("#progressbar3").reportprogress(++pct3);
	       if(pct3==100){
	               clearInterval(handle3);
	               $("#run3").val("sfoglia");
	               pct3=0;
	       }
	}else if(increment_var == 'pct4'){
	       $("#progressbar4").reportprogress(++pct4);
	       if(pct4==100){
	               clearInterval(handle4);
	               $("#run4").val("sfoglia");
	               pct4=0;
	       }
	}else if(increment_var == 'pct5'){
	       $("#progressbar4").reportprogress(++pct5);
	       if(pct5==100){
	               clearInterval(handle5);
	               $("#run5").val("sfoglia");
	               pct5=0;
	       }
	}else{
		//niente
		console.log("increment_var: "+increment_var);
		if(increment_var == null){
	        $("#progressbar").reportprogress(++pct);
	        if(pct==100){
	                clearInterval(handle2);
	                $("#run").val("sfoglia");
	                pct=0;
			
			}
		}
	}
}

function updateBar(idprogress, value){
	//console.log(" passed!!!!!! " + idprogress + "____" + value);
	if(idprogress != null && value >= 0){
		//console.log(" passed2!!!!!! " + idprogress.id + "____" + value);
        $("#"+idprogress.id).reportprogress(parseInt(value));
        if(value == 100){
                //clearInterval(handle);
                $("#run_"+idprogress.id).val("sfoglia");
                //pct=0;

		}
    }
}



jQuery(function($){
        $("#run_progressbar").click(function(){
                if(this.value=="start"){
                        //handle=setInterval("update(\'pct\')",100);
						//LAUNCH DOWNLOAD
						var temp = this.id.split('_');
						var prog_id = temp[1];
						console.log(prog_id);
						
						window.soledownloader.launchDownload("S24", "SOLE", "20110925", "Descrizione", ""+prog_id);
                        
                        this.value="annulla";
                }else if(this.value=="sfoglia"){
                	console.log("SFOGLIA S24 SOLE 20110925");
                    //CALL A JAVASCRIPT INTERFACE
                	window.loader.launchSfogliatore("S24", "SOLE", "20110925", "Descrizione");
                	//window.location = 'ipad.html';
                }else{
                    clearInterval(handle);
					pct=0;
					$("#progressbar").reportprogress(0);

                    this.value="start";
                    }
        });
        $("#reset").click(function(){
                pct=0;
                $("#progressbar").reportprogress(0);
        });
        $("#run_progressbar1").click(function(){
            if(this.value=="start"){
                    //handle1=setInterval("update(\'pct1\')",100);
                    //this.value="annulla";
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111006", "Descrizione", ""+prog_id);
                
                this.value="annulla";
                
            }else if(this.value=="sfoglia"){
            	console.log("SFOGLIA S24 SOLE 20111007");
                //CALL A JAVASCRIPT INTERFACE
            	window.loader.launchSfogliatore("S24", "SOLE", "20111006", "Descrizione");
            }else{
                clearInterval(handle1);
				pct1=0;
				$("#progressbar1").reportprogress(0);

                this.value="start";
                }
    });
        $("#run_progressbar2").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111115", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111115");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle2);
				pct2=0;
				$("#progressbar2").reportprogress(0);

                this.value="start";
            }
    });
        $("#run_progressbar3").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111109", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111109");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111109", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle3);
				pct3=0;
				$("#progressbar3").reportprogress(0);

                this.value="start";
            }
    });

        $("#run_progressbar4").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "SOLE", "20111129", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111129");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "SOLE", "20111129", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle4);
				pct4=0;
				$("#progressbar4").reportprogress(0);

                this.value="start";
            }
    });
        
        $("#run_progressbar5").click(function(){
            if(this.value=="start"){
                //handle=setInterval("update(\'pct\')",100);
				//LAUNCH DOWNLOAD
				var temp = this.id.split('_');
				var prog_id = temp[1];
				console.log(prog_id);
				
				window.soledownloader.launchDownload("S24", "LUNEDI", "20111114", "Descrizione", ""+prog_id);
				/*
	    		var valoutput ;
	    		if(typeof(window.localStorage) != 'undefined'){ 
	    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
	    		} 
	    		else{ 
	    			throw "window.localStorage, not defined"; 
	    		}
				window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
                */
                this.value="annulla";
        }else if(this.value=="sfoglia"){
        	console.log("SFOGLIA S24 SOLE 20111114");
    		var valoutput ;
    		if(typeof(window.localStorage) != 'undefined'){ 
    			valoutput = window.localStorage.getItem ("unread_message_sole"); 
    		} 
    		else{ 
    			throw "window.localStorage, not defined"; 
    		}


        	//alert("unread "+valoutput);
        	setTimeout("history.go(-1)", 1500);
            //CALL A JAVASCRIPT INTERFACE
        	window.loader.launchSfogliatore("S24", "LUNEDI", "20111114", "Descrizione"+valoutput);
        	//window.location = 'ipad.html';
            }else{
                clearInterval(handle5);
				pct5=0;
				$("#progressbar5").reportprogress(0);

                this.value="start";
            }
    });
        
});

	function loadQuick(){
		var valoutput ;
		if(typeof(window.localStorage) != 'undefined'){ 
			valoutput = window.localStorage.getItem ("unread_message_sole"); 
		} 
		else{ 
			throw "window.localStorage, not defined"; 
		}
		window.loader.launchSfogliatore("S24", "SOLE", "20111115", "Descrizione"+valoutput);
    	setTimeout("history.go(-1)", 1500);
	}



/**
 * @author ABertacco
 */
var _QARCHIVIO_ISOPEN = false;
// var _QARCHIVIO_MODE = 'ICONS';
var _QARCHIVIO_MODE = 'LIST';
var _QARCHIVIO_RENDERED_ITEMS = null;

var _QARCHIVIO_DEFAULT_EDIZIONE = 'SOLE';

var _PROID = null;

function qarchivioOpen(p_product_id, isFromSfoglio, defaultEdizione) {
	_QARCHIVIO_ISOPEN = true;
	_QARCHIVIO_DEFAULT_EDIZIONE = (defaultEdizione == null ? 'SOLE'
			: defaultEdizione);
	console.log('p_product_id ' + p_product_id);
	$('#qarchivio_subtitolo_opzioni_mode').css('display', 'none');

	_PROID = p_product_id;
	// alert('aaa'+_PROID);
	qarchivioLoad(_QARCHIVIO_MODE, p_product_id);
	qarchivioLoadAdv(p_product_id);
	// $('#qarchivio').fadeIn();

	$('#qarchivio_titolo_chiudi_edicola').css('display',
			(isFromSfoglio != true ? 'inline-block' : 'none'));
	$('#qarchivio_titolo_chiudi_sfoglio').css('display',
			(isFromSfoglio == true ? 'inline-block' : 'none'));

	// $('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_loading').css('display', 'inline-block');
	$('#qarchivio').css('display', 'inline');

	omnitureTrackApp('APP:archivio:' + p_product_id, 'APP:archivio');
	nielsenCall('ARCHIVIO_PRODOTTI');

}

function qarchivioClose() {
	// $('#qarchivio').fadeOut();
	$('#qarchivio').css('display', 'none');
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}
	_QARCHIVIO_ISOPEN = false;
}

function sfogliaArchivio(p_testata, p_issue, p_edizione) {
	var keyinput = "unread_message_sole";
	var valoutput = 0;

	var node = document.getElementById('appmenu_inbox_count');
	if (node.style.display == 'block' || node.style.display == 'inline-block') {
		valoutput = 1;
	} else {
		valoutput = 0;
	}

	if (typeof (window.localStorage) != 'undefined') {
		window.localStorage.setItem(keyinput, valoutput);
	} else {
		throw "window.localStorage, not defined";
	}

	window.loader.launchSfogliatore(p_testata, p_edizione, p_issue,
			"Descrizione" + valoutput);

}

function qarchivioCloseSfoglia() {
	// appmenuSfoglioOpen();
	// openFlipper();
	console.log("closesfoglia");

	window.simulatePG.exec(null, null, "Notification", "activityStart", [
			"Caricamento", "Attendere..." ]);

	try {
		var keyinput = "unread_message_sole";
		var valoutput = 0;

		var node = document.getElementById('appmenu_inbox_count');
		if (node.style.display == 'block'
				|| node.style.display == 'inline-block') {
			valoutput = 1;
		} else {
			valoutput = 0;
		}

		if (typeof (window.localStorage) != 'undefined') {
			window.localStorage.setItem(keyinput, valoutput);
		} else {
			throw "window.localStorage, not defined";
		}

		window.loader.launchSfogliatore(_CURRENT_FLIPPER_TESTATA,
				_CURRENT_FLIPPER_EDIZIONE, _CURRENT_FLIPPER_ISSUE,
				"Descrizione" + valoutput, _CURRENT_FLIPPER_PAGINA, 'true');

		qarchivioClose();
		setTimeout(function() {
			console.log("launch page " + _CURRENT_FLIPPER_PAGINA);
			window.simulatePG.exec(null, null, "Notification", "activityStop",
					[]);
			// window.go.to(_CURRENT_FLIPPER_PAGINA);

		}, 1500);
	} catch (exc) {
		console.log(exc.message);
		window.simulatePG.exec(null, null, "Notification", "activityStop", []);
	}
}

function qarchivioLoadAdv(p_product_id) {
	document.getElementById('qarchivio_footer_adv').innerHTML = '';
	// 'http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
	$('#qarchivio_footer_adv').writeCapture().load(
			/*
			 * 'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' +
			 * device.uuid + '@Bottom'
			 */_ADV_PROXY + '?z=ARC_BOTTOM&p=' + p_product_id + '&d='
					+ device.uuid + '&s=' + _SCREENADV, function() {
			}).endCapture();
}

function updateRichBtn() {
}

var _QARCHIVIO_ISCROLL = null;
function qarchivioUpdateIScroll() {
	// updateRichBtn();
	if (!_QARCHIVIO_ISOPEN)
		return;
	if (_QARCHIVIO_ISCROLL == null) {
		_QARCHIVIO_ISCROLL = new iScroll('qarchivio_wrapper', {
			hideScrollbar : false
		});
	} else {
		_QARCHIVIO_ISCROLL.refresh();
	}
}

function qarchivioLoad(mode, p_product_id) {
	console.log("qarchivioLoad p_product_id: " + p_product_id);
	// se si cerca di cambiare vista e si Ã¨ in modifica allora si toglie la
	// modifica
	if ($('#qarchivio_subtitolo_opzioni_visualizza').is(':visible'))
		qarchivioVisualizza();

	$('#qarchivio_loading').css('display', 'inline-block');
	if (mode) {
		_QARCHIVIO_MODE = mode;
	} else {
		if (_QARCHIVIO_MODE == null) {
			_QARCHIVIO_MODE = 'ICONS';
		}
	}

	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.destroy();
		_QARCHIVIO_ISCROLL = null;
	}

	$('#qarchivio_container').empty();
	$('#qarchivio_subtitolo_opzioni_vista1').removeClass(
			'qarchivio_subtitolo_opzioni_vista1_on');
	$('#qarchivio_subtitolo_opzioni_vista2').removeClass(
			'qarchivio_subtitolo_opzioni_vista2_on');

	var l_request_headers = {
		"appKey" : _API24_APPKEY
	};

	var l_request_data = {
		"appName" : device.appname,
		"appVersion" : device.appversion,
		"deviceId" : device.uuid,
		"deviceType" : device.platform
	};

	// Se username e user identity non sono nulli vengono aggiunti come
	// parametri della chiamata
	if (_USERNAME && _USER_IDENTITY) {
		l_request_headers['userIdentity'] = _USER_IDENTITY;
		l_request_data['username'] = _USERNAME;
	}

	_QARCHIVIO_RENDERED_ITEMS = {};

	if (p_product_id && p_product_id != '') {

		// Inizializzazione filtro edizioni
		qarchivioInitFilter();

		console.log('---REQ---> past-issues/' + p_product_id);
		console.log(l_request_headers);
		console.log(l_request_data);

		$
				.ajax({
					type : "GET",
					timeout : _AJAX_TIMEOUT,
					cache : false,
					contentType : "application/json; charset=utf-8",
					url : _SOLEGW_ENDPOINT + "products/past-issues/"
							+ p_product_id + ".json",
					headers : l_request_headers,
					data : l_request_data,
					dataType : "json",
					success : function(p_response) {

						if (typeof p_response == "string") {
							p_response = $.parseJSON(p_response);
						}

						console.log('---RESP--> past-issues/' + p_product_id);
						console.log(p_response);

						// Controlla la risposta avuta dal server
						if (checkAjaxResponse(p_response, function() {
							qarchivioLoad(mode, p_product_id);
						})) {
							var res = p_response.Result.res;

							_QARCHIVIO_PRODUCT = res;

							qarchivioRenderItems();
						} else {
							console.log('qarchivioLoad: Error, '
									+ p_response.Exception.Description);
							abutils
									.alert(
											'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
											'Arretrati');
							_QARCHIVIO_PRODUCT = {
								items : [],
								testata : _MAP_CODICE_TESTATA['' + p_product_id]
							};
							qarchivioRenderItems();
						}
					},
					error : function() {
						abutils
								.alert(
										'Gli arretrati non sono al momento disponibili. Riprovare tra poco.',
										'Arretrati');
						_QARCHIVIO_PRODUCT = {
							items : [],
							testata : _MAP_CODICE_TESTATA['' + p_product_id]
						};
						qarchivioRenderItems();
					}
				});

	} else {
		// _QARCHIVIO_PRODUCT = { items: [], testata:
		// _MAP_CODICE_TESTATA[''+p_product_id] };
		qarchivioRenderItems();
	}
	// alert('aaa '+$('#qarchivio_filtro_edizioni option:selected').val());
}

function qarchivioRenderItems() {
	console.log('qarchivioRenderItems...');
	_QARCHIVIO_RENDERED_ITEMS = {};
	// $('#qarchivio_titolo_prodotto').text(_QARCHIVIO_PRODUCT.productDescription);
	var l_product_details = _EDICOLA_PRODUCTS_DETAILS[_QARCHIVIO_PRODUCT.productId];
	if (l_product_details == null)
		l_product_details = {
			'name' : 'Il Sole 24 ORE'
		}
	$('#qarchivio_titolo_prodotto').text(l_product_details.name);

	if (_QARCHIVIO_MODE == 'ICONS') {
		// modalitÃ vista icone
		$('#qarchivio_subtitolo_opzioni_vista1').addClass(
				'qarchivio_subtitolo_opzioni_vista1_on');

		var l_sole_count_per_cover = 0;

		for ( var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for ( var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_'
						+ _QARCHIVIO_PRODUCT.items[i].editionId + '_'
						+ _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (_QARCHIVIO_PRODUCT.items[i].inserts[j].insertId == 'SOLE')
					l_sole_count_per_cover++;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsIcon(_QARCHIVIO_PRODUCT.items[i], j,
							(l_sole_count_per_cover <= 12) && (i <= 20));
				}
			}
		}
		console.log('prima di qarchivioLoadLocalData');
		// setTimeout("qarchivioLoadLocalData()",0);
		qarchivioLoadLocalData();
	} else {
		console.log("qarchivioRenderItems LIST");
		// modalitÃ vista lista
		$('#qarchivio_subtitolo_opzioni_vista2').addClass(
				'qarchivio_subtitolo_opzioni_vista2_on');

		qarchivioRenderItems_List_aux();
	}
	
	$('#qarchivio_loading').css('display', 'none');
	$('#qarchivio_subtitolo_opzioni_mode').css('visibility',
	'visible');
	
	if (_QARCHIVIO_ISCROLL != null) {
		_QARCHIVIO_ISCROLL.refresh();
		_QARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
	}
	
}

function qarchivioRenderItems_List_aux() {
	console.log('qarchivioRenderItems_List_aux...'
			+ _QARCHIVIO_PRODUCT.items.length);
	try {
		for ( var i = 0; i < _QARCHIVIO_PRODUCT.items.length; i++) {
			for ( var j = 0; j < _QARCHIVIO_PRODUCT.items[i].inserts.length; j++) {
				var l_item_id = _QARCHIVIO_PRODUCT.testata + '_'
						+ _QARCHIVIO_PRODUCT.items[i].editionId + '_'
						+ _QARCHIVIO_PRODUCT.items[i].inserts[j].insertId;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					qarchivioRenderAsList(_QARCHIVIO_PRODUCT.items[i], j);
				}
			}
		}

		qarchivioLoadLocalData();
	} catch (exc) {
		console.log("qarchivioRenderItems_List_aux::error: " + exc.message);
	}
}

var _CURRENT_QUEUE_LIST;
function downloadManagerCallbackQueueList(p_queue) {
	console.log('downloadManagerCallbackQueueList...');
	_CURRENT_QUEUE_LIST = p_queue;
	qarchivioRenderItems_List_aux();
	return "OK";
}

function isInQueueList(testata, issue, edizione) {
	// console.log('isInQueueList?');
	// console.log(testata + ' ' + issue + ' ' + edizione);
	if (_CURRENT_QUEUE_LIST == null)
		return false;
	for ( var i = 0; i < _CURRENT_QUEUE_LIST.length; i++) {
		var l_item = _CURRENT_QUEUE_LIST[i];
		// console.log(l_item.testata + ' ' + l_item.issue + ' ' +
		// l_item.edizione);
		if ((l_item.testata == testata) && (l_item.issue == issue)
				&& (l_item.edizione == edizione)) {
			return true;
		}
	}
	return false;
}

/**
 * Crea la rappresentazione di un arretrato come icona
 * 
 * @params p_item Oggetto rappresentante l'arretrato p_insert_index Indice
 *         dell'inserto
 */
function qarchivioRenderAsIcon(p_item, p_insert_index, createCoverImg) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + '
	// qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.inserts[p_insert_index].description)
			+ ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24')
			&& (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId,
			p_item.inserts[p_insert_index].description);

	var img_div = document.createElement('div');
	box.appendChild(img_div);
	img_div.className = 'qarchivio_container_box_img_div';
	img_div.id = 'qarchivio_container_box_icon_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	if (createCoverImg) {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = p_item.inserts[p_insert_index].cover;
	} else {
		var img = document.createElement('img');
		img_div_crop.appendChild(img);
		img.className = 'qarchivio_container_box_img';
		img.src = 'imgs/fake/fake_cover.jpg';
	}

	if (p_item.inserts[p_insert_index].premium
			&& (parseInt(p_item.inserts[p_insert_index].premium) > 0)) {
		var premium_flag = document.createElement('img');
		img_div.appendChild(premium_flag);
		premium_flag.src = 'imgs/inserto_abbonati_archivio.png';
		premium_flag.className = 'qarchivio_container_box_img_div_premiumflag';
	}

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description
			+ '</strong><br />' + p_item.editionDescription;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	$(txt_local).click(
			function() {
				if ($('#qarchivio_container').hasClass('qarchivio_modify')
						&& ($(this)
								.hasClass('qarchivio_container_box_txt_local_'
										+ _QARCHIVIO_MODE))) {
					eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata,
							p_item.editionId,
							p_item.inserts[p_insert_index].insertId);
				}
			});
	checkLocalArretrato(p_item, p_insert_index);
}

/**
 * Crea la rappresentazione di un arretrato come lista
 * 
 * @params p_item Oggetto rappresentante l'arretrato p_insert_index Indice
 *         dell'inserto
 */
function qarchivioRenderAsList(p_item, p_insert_index) {
	console.log('qarchivioRenderAsList');
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.inserts[p_insert_index].insertId + '
	// qarchivio_container_box_isremote';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.inserts[p_insert_index].description)
			+ ' qarchivio_container_box_isremote';
	if ((_QARCHIVIO_PRODUCT.testata == 'S24')
			&& (p_item.inserts[p_insert_index].insertId == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	box.style['display'] = 'none';
	qarchivioUpdateFilter(p_item.inserts[p_insert_index].insertId,
			p_item.inserts[p_insert_index].description);

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.inserts[p_insert_index].description
			+ '</strong> ' + p_item.editionDescription;
	// p_item.editionTitle;
	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	btndiv.id = 'qarchivio_container_btndiv_' + _QARCHIVIO_MODE + '_'
			+ p_insert_index + '_' + p_item.editionId;
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	btn.type = 'button';
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_'
			+ _QARCHIVIO_PRODUCT.testata + '_' + p_item.editionId + '_'
			+ p_item.inserts[p_insert_index].insertId;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'qarchivio_hidden_btn';

	$(del_btn).click(
			function() {
				eliminaCopiaLocale(_QARCHIVIO_PRODUCT.testata,
						p_item.editionId,
						p_item.inserts[p_insert_index].insertId);
			});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + _QARCHIVIO_PRODUCT.testata + "_"
			+ p_item.editionId + "_" + p_item.inserts[p_insert_index].insertId;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + _QARCHIVIO_PRODUCT.testata
			+ "_" + p_item.editionId + "_"
			+ p_item.inserts[p_insert_index].insertId;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);

	checkLocalArretrato(p_item, p_insert_index);

}

/*******************************************************************************
 * Gestione caricamento arretrati salvati in locale
 ******************************************************************************/
/**
 * Carica gli articoli salvati in locale
 */
function qarchivioLoadLocalData() {

	if (_DB) {

		var querySuccess = function(tx, p_results) {

			var len = p_results.rows.length;
			console.log("qarchivioLoadLocalData: read items:" + len);

			for ( var i = 0; i < p_results.rows.length; i++) {
				var l_local_item = p_results.rows.item(i);
				var l_item_id = l_local_item.testata + '_' + l_local_item.issue
						+ '_' + l_local_item.edizione;

				if (!_QARCHIVIO_RENDERED_ITEMS[l_item_id]) {
					_QARCHIVIO_RENDERED_ITEMS[l_item_id] = true;
					/*
					 * if (_QARCHIVIO_MODE == 'ICONS') {
					 * qarchivioRenderLocalAsIcon(l_local_item); } else {
					 * console.log("NO ICONS");
					 * qarchivioRenderLocalAsList(l_local_item); }
					 */
					//qarchivioRenderLocalAsIcon(l_local_item);
					 qarchivioRenderLocalAsList(l_local_item);
				}

				qarchivioUpdateFilter(l_local_item.edizione,
						l_local_item.edizione_descr);
			}

			// Eseguendo l'evento di change del filtro prodotti, anche in caso
			// di switch della vista si otterrÃ
			// sempre una visualizzazione coerente in base al prodotto filtrato
			$('#qarchivio_filtro_edizioni').change();

			var isPortrait = window.innerWidth < window.innerHeight;
			if (isPortrait) {
				$('.qarchivio_container_box_ICONS').height(
						Math.round(window.innerHeight / 7));
			} else {
				$('.qarchivio_container_box_ICONS').height(
						Math.round(window.innerHeight / 4));
			}
/*
 * setTimeout(function() { // $('#qarchivio_container').css('visibility',
 * 'hidden'); $('#qarchivio_loading').css('display', 'none'); //
 * $('#qarchivio_container').css('visibility', 'visible');
 * $('#qarchivio_subtitolo_opzioni_mode').css('visibility', 'visible'); //
 * window.simulate.redraw();
 * 
 * if (_QARCHIVIO_ISCROLL != null) { _QARCHIVIO_ISCROLL.refresh(); // FIX REDRAW
 * _QARCHIVIO_ISCROLL.scrollTo(0, 0, 0); } }, 500);
 */
			$('#qarchivio_loading').css('display', 'none');
			$('#qarchivio_subtitolo_opzioni_mode').css('visibility',
			'visible');
			
			if (_QARCHIVIO_ISCROLL != null) {
				_QARCHIVIO_ISCROLL.refresh();
				_QARCHIVIO_ISCROLL.scrollTo(0, 0, 0);
			}
			
			/*
			 * setTimeout(function(){ window.scrollTo(0,0); },560);
			 */

		}
		var queryError = function(p_error) {
			console.log("qarchivioLoadLocalData: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql(
					'SELECT * FROM issues WHERE testata=? ORDER BY issue DESC',
					[ _QARCHIVIO_PRODUCT.testata ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	}

}

/**
 * Crea la rappresentazione di un arretrato in locale come icona
 * 
 * @params p_item Arretrato in locale come salvato nel db issues
 */
function qarchivioRenderLocalAsIcon(p_item) {
	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.edizione + '
	// qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.edizione_descr)
			+ ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	var img_div = document.createElement('div');
	img_div.className = 'qarchivio_container_box_img_div';
	$(img_div).click(function() {
		if (!$('#qarchivio_container').hasClass('qarchivio_modify')) {
			sfoglia(p_item.testata, p_item.issue, p_item.edizione);
			console.log("sfoglia LIST archivio");
			// window.loader.local(true);
		}
	});
	box.appendChild(img_div);

	var img_div_crop = document.createElement('div');
	img_div.appendChild(img_div_crop);
	img_div_crop.className = 'qarchivio_container_box_img_div_crop';

	var img = document.createElement('img');
	img_div_crop.appendChild(img);
	img.className = 'qarchivio_container_box_img';
	// ANDROID MODDED
	img.src = window.folder.getDir()
			+ /* navigator.fileMgr.libFolderPath + 'file:///mnt/sdcard/' */'/'
			+ p_item.testata + '/' + p_item.issue + '/' + p_item.edizione
			+ '/cover_low.jpg';

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong><br />'
			+ p_item.issue_descr;

	// flag stato edizione
	var txt_local = document.createElement('div');
	box.appendChild(txt_local);
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_'
			+ _QARCHIVIO_MODE;
	$(txt_local).click(
			function() {
				if ($('#qarchivio_container').hasClass('qarchivio_modify')
						&& ($(this)
								.hasClass('qarchivio_container_box_txt_local_'
										+ _QARCHIVIO_MODE))) {
					eliminaCopiaLocale(p_item.testata, p_item.issue,
							p_item.edizione);
				}
			});

}

/**
 * Crea la rappresentazione in lista di un arretrato salvato in locale
 * 
 * @params p_item Arretrato in locale come salvato nel db issues
 * 
 */
function qarchivioRenderLocalAsList(p_item) {

	var box = document.createElement('div');
	document.getElementById('qarchivio_container').appendChild(box);
	// box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '
	// qarchivio_edizione_' + p_item.edizione + '
	// qarchivio_container_box_isinlocal';
	box.className = 'qarchivio_container_box_' + _QARCHIVIO_MODE
			+ ' qarchivio_edizione_'
			+ qarchivioLabelToValue(p_item.edizione_descr)
			+ ' qarchivio_container_box_isinlocal';
	if ((p_item.testata == 'S24') && (p_item.edizione == 'LUNEDI'))
		box.className += ' qarchivio_edizione_'
				+ qarchivioLabelToValue('Il Sole 24 Ore');
	box.id = 'qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
			+ +p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	box.style['display'] = 'none';

	// flag stato edizione
	var txt_local = document.createElement('div');
	txt_local.id = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_'
			+ p_item.testata + '_' + p_item.issue + '_' + p_item.edizione;
	txt_local.className = 'qarchivio_container_box_txt_local_'
			+ _QARCHIVIO_MODE;
	box.appendChild(txt_local);

	var txt = document.createElement('div');
	box.appendChild(txt);
	txt.className = 'qarchivio_container_box_txt_' + _QARCHIVIO_MODE;
	txt.innerHTML = '<strong>' + p_item.edizione_descr + '</strong> '
			+ p_item.issue_descr;

	// bottone
	var btndiv = document.createElement('div');
	box.appendChild(btndiv);
	btndiv.style['float'] = 'right';
	btndiv.style['margin-right'] = '20px';
	var btn = document.createElement('input');
	btn.id = 'qarchivio_container_box_btn_' + p_item.testata + '_'
			+ p_item.issue + '_' + p_item.edizione;
	btn.type = 'button';
	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	$(btn).click(function() {
		sfoglia(p_item.testata, p_item.issue, p_item.edizione);
		console.log("sfoglia LIST archivio");
		window.loader.local(true);
	});
	btndiv.appendChild(btn);

	// delete
	var del_btn = document.createElement('input');
	del_btn.id = 'qarchivio_container_box_del_btn_' + p_item.testata + '_'
			+ p_item.issue + '_' + p_item.edizione;
	del_btn.type = 'button';
	del_btn.value = 'Elimina';
	del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';

	$(del_btn).click(function() {
		eliminaCopiaLocale(p_item.testata, p_item.issue, p_item.edizione);
	});

	btndiv.appendChild(del_btn);

	// Progress bar
	var prg_bar = document.createElement('div');
	prg_bar.id = "progressbar_" + p_item.testata + "_" + p_item.edizione + "_"
			+ p_item.issue;
	prg_bar.className = 'qarchivio_progress_bar';

	// Progress bar status
	var prg_bar_status = document.createElement('div');
	prg_bar_status.id = "progressbar_status_" + p_item.testata + "_"
			+ p_item.edizione + "_" + p_item.issue;
	prg_bar_status.className = 'qarchivio_progress_bar_status';
	prg_bar.appendChild(prg_bar_status);

	box.appendChild(prg_bar);
}

/*******************************************************************************
 * Gestione filtro
 ******************************************************************************/
function qarchivioAggiornaContenutoVisualizzato() {
	var l_tempo_option = $('#qarchivio_filtro_edizioni_tempo option:selected');
	if (l_tempo_option.val() == 'LOCAL') {
		// mostro solo i prodotti in locale
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$('#qarchivio_container .qarchivio_container_box_isremote').css(
					'display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css(
					'display', 'inline-block');
		} else {
			$('#qarchivio_container .qarchivio_container_box_isremote').css(
					'display', 'none');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').css(
					'display', 'inline-block');
			$('#qarchivio_container .qarchivio_container_box_isinlocal').not(
					'.qarchivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');
		}
	} else {
		// mostro tutti i prodotti
		var l_selected_option = $('#qarchivio_filtro_edizioni option:selected');
		if (l_selected_option.val() == '') {
			$(
					'#qarchivio_container .qarchivio_container_box_'
							+ _QARCHIVIO_MODE).css('display', 'inline-block');
		} else {
			$(
					'#qarchivio_container .qarchivio_container_box_'
							+ _QARCHIVIO_MODE).not(
					'.qarchivio_edizione_' + l_selected_option.val()).css(
					'display', 'none');
			$(
					'#qarchivio_container .qarchivio_edizione_'
							+ l_selected_option.val()).css('display',
					'inline-block');
		}

	}

	setTimeout(qarchivioUpdateIScroll, 100);
}

/**
 * Inizializza il filtro sulle edizioni da mostrare.
 */
var _QARCHIVIO_FILTRO_EDIZIONI = null;
function qarchivioInitFilter() {
	var l_filtro_tempo_select = $('#qarchivio_filtro_edizioni_tempo');
	l_filtro_tempo_select.empty();

	l_filtro_tempo_select.change(function() {
		// se si cerca di cambiare vista e si Ã¨ in modifica allora si toglie la
		// modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});
	var l_option = $('<option value="" selected="selected">Ultimo mese</option>');
	l_filtro_tempo_select.append(l_option);
	l_option = $('<option value="LOCAL">Il mio archivio</option>');
	l_filtro_tempo_select.append(l_option);

	_QARCHIVIO_FILTRO_EDIZIONI = new Array();

	var l_filtro_edizioni_select = $('#qarchivio_filtro_edizioni');
	l_filtro_edizioni_select.empty();

	l_filtro_edizioni_select.change(function() {
		// se si cerca di cambiare vista e si Ã¨ in modifica allora si toglie la
		// modifica
		if (_QARCHIVIO_IS_IN_MODIFICA)
			qarchivioVisualizza(true);

		qarchivioAggiornaContenutoVisualizzato();
	});

	// var l_option = $('<option value="" selected="selected">Tutti i
	// prodotti</option>');
	var l_option = $('<option value="">Tutti i prodotti</option>');
	l_filtro_edizioni_select.append(l_option);
	var row = {
		value : "",
		label : "Tutti i prodotti"
	}
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	// l_option = $('<option value="SOLE" selected="selected">Il Sole 24
	// Ore</option>');
	l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore")
			+ '" selected="selected">Il Sole 24 Ore</option>');
	l_filtro_edizioni_select.append(l_option);
	// _QARCHIVIO_FILTRO_EDIZIONI.push("SOLE", "Il Sole 24 Ore");
	_QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore"),
			"Il Sole 24 Ore");

	row = {
		value : qarchivioLabelToValue("Il Sole 24 Ore"),
		label : "Il Sole 24 Ore"
	};
	console.log('rich ' + row.value + ',' + row.label);
	_QARCHIVIOFILTRORICH.push(row);

	/*
	 * l_option = $('<option value="' + qarchivioLabelToValue("Il Sole 24 Ore
	 * lunedÃ¬") + '" selected="selected">Il Sole 24 Ore lunedÃ¬</option>');
	 * l_filtro_edizioni_select.append(l_option);
	 * _QARCHIVIO_FILTRO_EDIZIONI.push(qarchivioLabelToValue("Il Sole 24 Ore
	 * lunedÃ¬"), "Il Sole 24 Ore lunedÃ¬");
	 * 
	 * row = { value : qarchivioLabelToValue("Il Sole 24 Ore lunedÃ¬"), label :
	 * "Il Sole 24 Ore lunedÃ¬" }; console.log('rich ' + row.value + ',' +
	 * row.label); _QARCHIVIOFILTRORICH.push(row);
	 */

	l_filtro_edizioni_select
			.append($('<optgroup label="Altre testate" id="qarchivio_filtro_edizioni_optgroup"></optgroup>'));
}

function qarchivioLabelToValue(p_label) {
	// return p_label.toLowerCase(p_label.replace(/[^a-zA-Z0-9]/g,'x'));
	return p_label.replace(/[^a-zA-Z0-9]/g, 'x').toLowerCase();
}

function qarchivioUpdateFilter(p_edizione_id, p_edizione_descr) {

	if (jQuery.inArray(qarchivioLabelToValue(p_edizione_descr),
			_QARCHIVIO_FILTRO_EDIZIONI) == -1) {
		// _QARCHIVIO_FILTRO_EDIZIONI.push(p_edizione_id, p_edizione_descr);
		_QARCHIVIO_FILTRO_EDIZIONI.push(
				qarchivioLabelToValue(p_edizione_descr), p_edizione_descr);
		var row = {
			value : qarchivioLabelToValue(p_edizione_descr),
			label : p_edizione_descr
		};
		// console.log('rich '+row.value+','+row.label);
		_QARCHIVIOFILTRORICH.push(row);
		// console.log('rich '+_QARCHIVIOFILTRORICH[0].value);
		var l_option = $('<option></option>');

		l_option.val(qarchivioLabelToValue(p_edizione_descr));
		l_option.html(p_edizione_descr);
		// $('#qarchivio_filtro_edizioni').append(l_option);
		// console.log('append-->'+l_option.html());
		$('#qarchivio_filtro_edizioni_optgroup').append(l_option);
	}

	if (_QARCHIVIO_DEFAULT_EDIZIONE == p_edizione_id) {
		$('#qarchivio_filtro_edizioni').val(
				qarchivioLabelToValue(p_edizione_descr));
	}
}

_QARCHIVIOFILTRORICH = new Array();
function updateRichFilter() {
}

/*
 * Controlla se un arretrato sia stato scaricato in locale @params p_item
 * Arretrato p_insert_index Indice dell'inserto
 */
function checkLocalArretrato(p_item, p_insert_index) {

	var l_testata = _QARCHIVIO_PRODUCT.testata;
	var l_issue = p_item.editionId;
	var l_edizione = p_item.inserts[p_insert_index].insertId;
	var l_edizione_premium = p_item.inserts[p_insert_index].premium
			&& (parseInt(p_item.inserts[p_insert_index].premium) > 0);

	// Controlla se il prodotto sia stato giÃ scaricato
	if (_DB) {

		var querySuccess = function(tx, p_results) {

			if (p_results.rows.length <= 0)
				return;

			var l_query_result = p_results.rows.item(0);

			if (l_query_result.in_locale > 0) {
				$(
						'#qarchivio_container_box_' + _QARCHIVIO_MODE + '_'
								+ p_insert_index + '_' + p_item.editionId)
						.addClass('qarchivio_container_box_isinlocal');
				document.getElementById('qarchivio_container_box_txt_'
						+ _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue
						+ '_' + l_edizione).className = 'qarchivio_container_box_txt_local_'
						+ _QARCHIVIO_MODE;
			} else {
				document.getElementById('qarchivio_container_box_txt_'
						+ _QARCHIVIO_MODE + '_' + l_testata + '_' + l_issue
						+ '_' + l_edizione).className = 'qarchivio_container_box_txt_empty_'
						+ _QARCHIVIO_MODE;
			}

			if (_QARCHIVIO_MODE == 'LIST') {
				var btn = document
						.getElementById('qarchivio_container_box_btn_'
								+ _QARCHIVIO_MODE + '_' + l_testata + '_'
								+ l_issue + '_' + l_edizione);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
					btn.value = 'Sfoglia';
					$(btn).click(function() {
						sfoglia(l_testata, l_issue, l_edizione);
						window.loader.local(true);
					});

					var del_btn = document
							.getElementById('qarchivio_container_box_del_btn_'
									+ _QARCHIVIO_MODE + '_' + l_testata + '_'
									+ l_issue + '_' + l_edizione);
					del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
				} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
					// copia con download in corso
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					renderDownloadQueue(l_testata, l_issue, l_edizione);
				} else {
					if (p_item.free || l_query_result.da_scaricare > 0
							|| p_item.subscription == true) {
						if ((!p_item.subscription) && l_edizione_premium) {
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							btn.value = 'Solo per abbonati';
							$(btn).unbind();
							$(btn).bind('click', function() {
								mostraPopupInsertoAbbonati();
							});
						} else {
							// copia gratuita
							btn.className = 'button medium gray24 qarchivio_free_copy_btn';
							btn.value = 'Salva';
							$(btn).unbind();
							$(btn).bind(
									'click',
									function() {
										console.log(";;;;;;;;;; ADD1 TO QUEUE "
												+ l_testata + " " + l_issue
												+ " " + l_edizione);
										addToDownloadQueue(l_testata, l_issue,
												l_edizione);
									});
						}
					} else if (l_edizione_premium) {
						btn.className = 'button medium red24 qarchivio_buy_copy_btn';
						btn.value = 'Solo per abbonati';
						$(btn).unbind();
						$(btn).bind('click', function() {
							mostraPopupInsertoAbbonati();
						});
					} else {
						if (p_item.single && (p_item.singleOffers.length > 0)) {
							// acquisto
							btn.className = 'button medium red24 qarchivio_buy_copy_btn';
							// btn.value = 'Acquista ' +
							// p_item.singleOffers[0].offerPrice + ' â‚¬';
							// btn.value = 'Acquista ' +
							// ab_euro_formatter(p_item.singleOffers[0].offerPrice);
							btn.value = 'Seleziona';
							$(btn).unbind();
							$(btn)
									.bind(
											'click',
											function() {
												console
														.log(";;;;;;;;;; ACQUISTO "
																+ l_testata
																+ " "
																+ l_issue
																+ " "
																+ l_edizione);
												acquistoSingolo(
														l_testata,
														l_issue,
														l_edizione,
														p_item.singleOffers[0].offerId,
														p_item.singleOffers[0].offerItunesProductId);
											});
						} else {
							var btndiv = document
									.getElementById('qarchivio_container_btndiv_'
											+ _QARCHIVIO_MODE
											+ '_'
											+ p_insert_index
											+ '_'
											+ p_item.editionId);
							btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
							btndiv.style['position'] = 'relative';
							btndiv.style['margin-right'] = '30px';
							btndiv.style['margin-top'] = '10px';
						}
					}
				}
			} else if (_QARCHIVIO_MODE == 'ICONS') {

				var icon = document
						.getElementById('qarchivio_container_box_icon_'
								+ _QARCHIVIO_MODE + '_' + p_insert_index + '_'
								+ p_item.editionId);
				if (l_query_result.in_locale > 0) {
					// copia in locale
					$(icon).click(
							function() {
								if (!$('#qarchivio_container').hasClass(
										'qarchivio_modify')) {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							});
				} else
				// if (_QARCHIVIO_PRODUCT.free || l_query_result.da_scaricare >
				// 0) {
				if (p_item.free || l_query_result.da_scaricare > 0
						|| p_item.subscription == true) {
					// copia gratuita
					$(icon).click(
							function() {
								// scarica(l_testata, l_issue, l_edizione);
								if ((!p_item.subscription)
										&& l_edizione_premium) {
									sfogliaCheckPremium(l_testata, l_issue,
											l_edizione);
								} else {
									sfoglia(l_testata, l_issue, l_edizione);
								}
							});
				} else
				// if (p_item.subscription == false && p_item.single) {
				if (l_edizione_premium) {
					$(icon).click(function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					if (p_item.single && (p_item.singleOffers.length > 0)) {
						// acquisto
						$(icon)
								.click(
										function() {
											acquistoSingolo(
													l_testata,
													l_issue,
													l_edizione,
													p_item.singleOffers[0].offerId,
													p_item.singleOffers[0].offerItunesProductId);
										});
					}
				}

			}
		}
		// try{
		var queryError = function(p_error) {
			console.log("checkLocalArretrato: Error processing SQL: "
					+ p_error.message);
		}
		var executeQuery = function(tx) {
			var l_query = 'select * from (select count(*) as in_locale, 1 as id from issues where testata=? and issue=? and edizione=?) as a inner join (select count(*) as da_scaricare, 1 as id from issues where testata=? and issue=?) as b on (a.id = b.id)';
			tx.executeSql(l_query, [ l_testata, l_issue, l_edizione, l_testata,
					l_issue ], querySuccess, queryError);
		}

		_DB.transaction(executeQuery, queryError);
	} else {
	// DA RIMUOVERE
	var btn = document.getElementById('qarchivio_container_box_btn_'+ _QARCHIVIO_MODE + '_' + l_testata + '_'+ l_issue + '_' + l_edizione);

	btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
	btn.value = 'Sfoglia';
	}
}

/**
 * Passa alla modalitÃ modifica
 */
var _QARCHIVIO_IS_IN_MODIFICA = false;
var _QARCHIVIO_PRE_MODIFICA_TEMPO = '';
function qarchivioModifica() {
	console.log("modifica");
	_QARCHIVIO_IS_IN_MODIFICA = true;
	$('#qarchivio_subtitolo_opzioni_modifica').hide();
	$('#qarchivio_subtitolo_opzioni_visualizza').show();

	$('#qarchivio_container').addClass('qarchivio_modify');

	_QARCHIVIO_PRE_MODIFICA_TEMPO = $('#qarchivio_filtro_edizioni_tempo').val();
	$('#qarchivio_filtro_edizioni_tempo').val("LOCAL");
	qarchivioAggiornaContenutoVisualizzato();
}

/**
 * Passa alla modalitÃ visualizza
 */
function qarchivioVisualizza(light) {
	_QARCHIVIO_IS_IN_MODIFICA = false;
	$('#qarchivio_subtitolo_opzioni_modifica').show();
	$('#qarchivio_subtitolo_opzioni_visualizza').hide();

	$('#qarchivio_container').removeClass('qarchivio_modify');

	if (light == true)
		return;

	$('#qarchivio_filtro_edizioni_tempo').val(_QARCHIVIO_PRE_MODIFICA_TEMPO);
	qarchivioAggiornaContenutoVisualizzato();

	gestisciProssimaAzione();
	// <-- PERCHE'???

}


function hack(){
	if (_QARCHIVIO_MODE == 'LIST') {
		var btn = document
				.getElementById('qarchivio_container_box_btn_'
						+ _QARCHIVIO_MODE + '_' + l_testata + '_'
						+ l_issue + '_' + l_edizione);
		// if (l_query_result.in_locale > 0) {
			if (1 > 0) {
			// copia in locale
			btn.className = 'button medium red24 qarchivio_show_local_copy_btn';
			btn.value = 'Sfoglia';
			$(btn).click(function() {
				sfoglia(l_testata, l_issue, l_edizione);
				window.loader.local(true);
			});

			var del_btn = document
					.getElementById('qarchivio_container_box_del_btn_'
							+ _QARCHIVIO_MODE + '_' + l_testata + '_'
							+ l_issue + '_' + l_edizione);
			del_btn.className = 'button medium red24 qarchivio_delete_local_copy_btn';
		} else if (isInQueueList(l_testata, l_issue, l_edizione)) {
			// copia con download in corso
			btn.className = 'button medium gray24 qarchivio_free_copy_btn';
			renderDownloadQueue(l_testata, l_issue, l_edizione);
		} else {
			if (p_item.free || l_query_result.da_scaricare > 0
					|| p_item.subscription == true) {
				if ((!p_item.subscription) && l_edizione_premium) {
					btn.className = 'button medium red24 qarchivio_buy_copy_btn';
					btn.value = 'Solo per abbonati';
					$(btn).unbind();
					$(btn).bind('click', function() {
						mostraPopupInsertoAbbonati();
					});
				} else {
					// copia gratuita
					btn.className = 'button medium gray24 qarchivio_free_copy_btn';
					btn.value = 'Salva';
					$(btn).unbind();
					$(btn).bind(
							'click',
							function() {
								console.log(";;;;;;;;;; ADD1 TO QUEUE "
										+ l_testata + " " + l_issue
										+ " " + l_edizione);
								addToDownloadQueue(l_testata, l_issue,
										l_edizione);
							});
				}
			} else if (l_edizione_premium) {
				btn.className = 'button medium red24 qarchivio_buy_copy_btn';
				btn.value = 'Solo per abbonati';
				$(btn).unbind();
				$(btn).bind('click', function() {
					mostraPopupInsertoAbbonati();
				});
			} else {
				if (p_item.single && (p_item.singleOffers.length > 0)) {
					// acquisto
					btn.className = 'button medium red24 qarchivio_buy_copy_btn';
					// btn.value = 'Acquista ' +
					// p_item.singleOffers[0].offerPrice + ' â‚¬';
					// btn.value = 'Acquista ' +
					// ab_euro_formatter(p_item.singleOffers[0].offerPrice);
					btn.value = 'Seleziona';
					$(btn).unbind();
					$(btn)
							.bind(
									'click',
									function() {
										console
												.log(";;;;;;;;;; ACQUISTO "
														+ l_testata
														+ " "
														+ l_issue
														+ " "
														+ l_edizione);
										acquistoSingolo(
												l_testata,
												l_issue,
												l_edizione,
												p_item.singleOffers[0].offerId,
												p_item.singleOffers[0].offerItunesProductId);
									});
				} else {
					var btndiv = document
							.getElementById('qarchivio_container_btndiv_'
									+ _QARCHIVIO_MODE
									+ '_'
									+ p_insert_index
									+ '_'
									+ p_item.editionId);
					btndiv.innerHTML = '<strong class="qarchivio_none_btn">Non disponibile</strong>';
					btndiv.style['position'] = 'relative';
					btndiv.style['margin-right'] = '30px';
					btndiv.style['margin-top'] = '10px';
				}
			}
		}
	}
}





	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	function onDeviceReady()
	{
		if (window.innerWidth < 400) {
			window.location = 'iphone/iphone.html';
		} else {
			window.location = 'ipad.html';
		}
	}
    
    

/**
 * @author ABertacco
 */

// contiene il map prodotto itunes -> dettagli prodotto
var _IAP_PRODUCTS_DETAILS = null;
// contiene la lista di prodotti per i quali è necessario richiedere il dettaglio prodotto
var _IAP_REQ_QUEUE = null;
var _IAP_REQ_QUEUE_FULL = null;

function appstoreSetup() {
	console.log('APPSTORE|JS setup');
	// inizializzazione array di supporto
	_IAP_PRODUCTS_DETAILS = {};
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	
	//PhoneGap.exec('AppStore.setup');
	window.plugins.appstore.setup();
}

function appstoreReqProduct(id_shopping24, id_itunes) {
	if ((_IAP_PRODUCTS_DETAILS == null) || (_IAP_REQ_QUEUE == null))
		appstoreSetup();
		
	if ((id_shopping24 == null) || (id_itunes == null)) return;
	
	console.log('APPSTORE|JS appstoreReqProduct ' + id_shopping24 + ' ' + id_itunes);
	// se il codice itunes è già presente nella lista dei prodotti di cui conosco le info evito di reinserirlo
	if (_IAP_PRODUCTS_DETAILS[id_itunes] != null) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto conosciuto');
		return;
	}
	// se il codice itunes è già nella lista di quelli che devono essere processati, allora evito di reinserirlo
	if (_IAP_REQ_QUEUE.indexOf(id_itunes) != -1) {
		console.log('APPSTORE|JS appstoreReqProduct prodotto già in attesa');
		return;
	}
	// inserisco il codice nella lista di codici da richiedere
	_IAP_REQ_QUEUE.push(id_itunes);
	_IAP_REQ_QUEUE_FULL.push(id_itunes + ';' + id_shopping24);
}

function appstoreReqProducts() {
	console.log('APPSTORE|JS appstoreReqProducts');
	if (_IAP_REQ_QUEUE.length <= 0) {
		console.log('APPSTORE|JS appstoreReqProducts Nessun prodotto al momento risulta senza informazioni.');
		return;
	}
	// richiede le info su tutti i prodotti al momento contenuti in _IAP_REQ_QUEUE
	//var l_products = _IAP_REQ_QUEUE.join('|');
	var l_products = _IAP_REQ_QUEUE_FULL.join('|');
	_IAP_REQ_QUEUE = [];
	_IAP_REQ_QUEUE_FULL = [];
	//PhoneGap.exec('AppStore.productsListRequest', l_products);
	window.plugins.appstore.productsListRequest(null, null, l_products);
}

function appstoreReqProductsCallback(p_info, p_invalid) {
	try {
		console.log('APPSTORE|JS appstoreReqProductsCallback');
		for (var key in p_info) {
			var l_product = p_info[key];
			if (l_product == null) 
				continue;
			console.log('OK ' + l_product.productIdentifier); 
			_IAP_PRODUCTS_DETAILS[l_product.productIdentifier] = l_product;
		}
		
		for (var i = 0; i < p_invalid.length; i++) {
			console.log('KO ' + p_invalid[i]);
		}
		
		return "OK";
	} catch(exc) {
		return "KO";
	}
}

var _APPSTORE_BUY_CALLBACK = null;
function appstoreBuy(id_shopping24, id_itunes, callback) {
	_APPSTORE_BUY_CALLBACK = null;
	var l_product_info = _IAP_PRODUCTS_DETAILS[id_itunes];
	if (l_product_info == null) {
		abutils.alert('Il prodotto selezionato non è al momento disponibile.\nRiprovare tra poco.', 'Acquisto');
		return false;
	}	
	
	navigator.notification.loadingStart({
        'labelText': "Acquisto in corso...",
        'backgroundOpacity': 0.8,
        'strokeOpacity': 0.25,
        'strokeColor': "FFFFFF",
    });
	
	_APPSTORE_BUY_CALLBACK = callback;
	
	if (_USERNAME && _USER_IDENTITY) {
		// utente è loggato, bisogna refreshare la _USER_IDENTITY
		checkAjaxResponse({Success: false, Exception: { Name: 'ExpiredUserIdentityException', Description: 'Rinnovo useridentity pre-pagamento.'}}, function() {
			//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
			window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
		})
	} else {
		// utente anonimo si può procedere all'acquisto
		//PhoneGap.exec('AppStore.purchase', id_itunes, id_shopping24);
		window.plugins.appstore.purchase(null, null, id_itunes, id_shopping24);
	}
}

function appstorePurchaseFailedCallback(p_info) {
	_APPSTORE_BUY_CALLBACK = null;
	if (p_info.localizedDescription) {
		console.log('APPSTORE|JS Transazione annullate: ' + p_info.localizedDescription);
	} else {
		console.log('APPSTORE|JS Transazione annullata');
	}
	navigator.notification.loadingStop();
	return "OK";
}

function appstorePurchaseCompleteCallback(p_productid, p_response) {
	navigator.notification.loadingStop();
	if (p_response != null && p_response.Success == true) {
		if (_APPSTORE_BUY_CALLBACK && typeof _APPSTORE_BUY_CALLBACK == "function") {
			var l_next_action = _APPSTORE_BUY_CALLBACK;
			_APPSTORE_BUY_CALLBACK = null;
			l_next_action.call();
		}
	} else {
		_APPSTORE_BUY_CALLBACK = null;
		if (p_response.Exception && p_response.Exception.Description)
			abutils.alert(p_response.Exception.Description, 'Acquisto');
		else 
			abutils.alert('Si è verificato un errore durante la comunicazione con il server.', 'Acquisto');
	}
	omnitureTrackApp('APP:buy:' + p_productid, 'APP:buy');
	return "OK";
}




function eliminaCopiaLocaleSucc(p_testata, p_issue, p_edizione, type){
		//alert('aaa1');
        if(_DB){
            _DB.transaction(function(transaction){
                transaction.executeSql("DELETE FROM issues WHERE testata=? and issue=? and edizione=?", [p_testata, p_issue, p_edizione], function(transaction){
                    console.log('delete ok');
                    //navigator.fileMgr.deleteDirectory('issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
					//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
					//window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues/' + p_testata + '/' + p_issue + '/' + p_edizione);
					
					setTimeout(function(){
						window.soledownloader.cancelDownload(p_testata, p_edizione, p_issue, "", "", true);
					},0);

					setTimeout(function(){
						window.soledelete.deleteIssue(p_testata, p_issue, p_edizione);
					},1000);
					
					if (_QARCHIVIO_MODE) {
                    //Modifica la visualizzazioni dello stato nell'archivio
                    var l_status_el = $('#qarchivio_container_box_txt_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione);
                    l_status_el.addClass('qarchivio_container_box_txt_empty_' + _QARCHIVIO_MODE);
                    l_status_el.removeClass('qarchivio_container_box_txt_local_' + _QARCHIVIO_MODE);
                    if (_QARCHIVIO_MODE == 'LIST') {
                        $('#qarchivio_container_box_del_btn_' + _QARCHIVIO_MODE + '_' + p_testata + '_' + p_issue + '_' + p_edizione).css('display', 'none');
                    }
                    _NEXT_ACTION = qarchivioLoad;
                    }
					
                    // gestione cancellazione da archivio standard
                    if ($('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione)) {
                     console.log('cancellazione da archivio standard');
                     $('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).removeClass('archivio_container_box_islocal');
                     $('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione).addClass('archivio_container_box_isremote');
                     $('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + ' > div > .archivio_button_elimina').css('display', 'none');
                     $('#archivio_container_box_' + p_testata + '_' + p_issue + '_' + p_edizione + " .archivio_container_box_txt_local_ICONS").remove();
						}
						
						if (type) edicolaOfflineLoad(type);
                }, function(){
                    console.log('delete error');
                });
            });
        }
    }

    
    function impostazioniCancellaContenutoLocaleSucc(){
        if (_DB) {
        	/*
        	navigator.notification.loadingStart({
		        'labelText': "Cancellazione in corso...",
		        'backgroundOpacity': 0.8,
		        'strokeOpacity': 0.25,
		        'strokeColor': "FFFFFF",
		    });
        	*/
			window.simulatePG.exec(null, null, "Notification", "activityStart", ["Caricamento","Cancellazione in corso..."]);
            _DB.transaction(function(transaction){
                transaction.executeSql("DELETE FROM issues", [], function(transaction){
                    console.log('delete db ok');
                    //navigator.fileMgr.deleteDirectory('issues');
					//PhoneGap.exec("File.deleteDirectoryAbsolutePath", navigator.fileMgr.libFolderPath + '/Caches/issues');
					
                    //window.plugins.pgaleberutils.deleteDirectoryAtAbsolutePath(null, null, navigator.fileMgr.libFolderPath + '/Caches/issues');
                    window.soledelete.deleteAll('/S24/');
                    console.log('delete fs ok');
                    window.simulatePG.alert('Tutte le edizioni presenti sono state cancellate.', 
						'window.simulatePG.exec(null, null, "Notification", "activityStop", [])'
                    , 'Cancellazione contenuto locale', 'Ok');
							 openProductDetails(_PRODUCT_IN_EDICOLA.productId);
                }, function(){
                    console.log('delete error');
                    window.simulatePG.alert('Si è verificato un errore durante la cancellazione.', 
						'window.simulatePG.exec(null, null, "Notification", "activityStop", [])'
                    , 'Cancellazione contenuto locale', 'Ok');
                });
            });
        }
    }
    
    
    function inboxDeleteOpenedMessageSucc(){
        if (true) {
            var l_active_message = $('.inbox_list_container_box_active');
		    if (l_active_message.length > 0) {
		        var l_active_message_id = l_active_message[0].id.substring(25);
		        
		        if (_INBOX_MESSAGES['mid_' + l_active_message_id]) {
		        	/*
		            if (!_INBOX_MESSAGES[l_active_message_id].body) {
		                markMessagesAsRead([l_active_message_id]);
		            }
		            */
		            deleteLocalMessages([l_active_message_id]);
		        }
		        
		        //$('#inbox_msg_container').css('display', 'none');
				inboxCloseMsgView();
		        l_active_message.remove();
		    }
        }
    }

var PGCheckVersion = function() {
}
PGCheckVersion.prototype.checkVersion = function(successCB, errorCB) {
	PhoneGap.exec(successCB, errorCB, 'it.alebeer.checkversion', 'checkVersion', []);
}
PhoneGap.addConstructor(function() {
	if(!window.plugins)
		window.plugins = {};
	window.plugins.pgcheckversion = new PGCheckVersion();
});



/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
    
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
	
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
            popupPreferitiUpdateArticle(p_article);
        }
        else {
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.artid);
        	window.searchdb.display(p_article.artid);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
	
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
   
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
//var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}







/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
//var _DEPLOY_BASE_URL = 'http://212.45.97.204/_deploy/';
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';
var _ADV_PROXY = 'http://mobapp24.ilsole24ore.com/adv_proxy_and.php';
var _ADV_PROXY_TEST = 'http://212.45.97.204/adv_proxy_and.php';

var _API24TEST_SWITCH = false;
// se a true, l'app utilizza la configurazione di stage

var _SCREENADV = screen.width;
var screenHeight = (_DEBUG_MODE) ? window.innerHeight : screen.height / window.devicePixelRatio ;
var screenWidth = (_DEBUG_MODE) ? window.innerWidth : screen.width / window.devicePixelRatio ;
var isPortrait = screenWidth < screenHeight;
var _LockTap = false;

function onBodyLoaded() {
	$('#wrapper_articolo').bind('click', function(event){
		if (_LockTap) return;
		_LockTap = true;
		wrapperArticoloClick();
		setTimeout(function(){ _LockTap = false; }, 500);
	});
	
	setInterval(function(){
		updateOrientation();
	}, 500);

	if (_API24TEST_SWITCH) {
		_ADV_PROXY = _ADV_PROXY_TEST;
	}
	articoloZoomAuxText(0);

	if (_DB == null) {
		inizializzaDatabase();
		preferitiDBinit();
	}

	if (_DEBUG_MODE) {
		debugContent();
	}
}

function debugContent() {
	_CURRENT_ARTICLE = {};
	_CURRENT_ARTICLE.shared_id = "2769977";
	loadArticolo({
		artid : '1317851504',
		shared_id : '2844111',
		testata : 'S24',
		edizione : 'SOLE',
		issue : '20111129',
		testata_descr : 'Il Sole 24 ORE',
		edizione_descr : 'Il Sole 24 Ore',
		issue_descr : '29 Novembre 2011',
		pagina : 1,
		sezione : 'PRIMA',
		sezione_descr : '6126',
		occhiello : ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"],
		titolo : ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"],
		sottotitolo : ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"],
		firme : [],
		testo : ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
		photos : [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg", "«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]],
		grafici : [],
		sommari : []
	}, [], [], [{
		"items" : [{
			"url" : "http://mrdoob.com/projects/chromeexperiments/ball_pool/",
			"descrizione" : "Ball Pool"
		}],
		"id" : "145",
		"package" : "1317851504",
		"descrizione" : "HTML5 - Ball Pool",
		"preview" : "",
		"tipo" : "LINK"
	}]);
	loadCorrelates();
	loadSezioni([{
		"section" : "4898",
		"description" : "PRIMA"
	}, {
		"section" : "4899",
		"description" : "PRIMO PIANO"
	}, {
		"section" : "4901",
		"description" : "COMMENTI E INCHIESTE"
	}, {
		"section" : "4902",
		"description" : "POLITICA E SOCIETA'"
	}, {
		"section" : "4903",
		"description" : "MONDO"
	}, {
		"section" : "4904",
		"description" : "ECONOMIA E IMPRESE"
	}, {
		"section" : "4905",
		"description" : "NORME E TRIBUTI"
	}, {
		"section" : "4906",
		"description" : "LETTERA AL RISPARMIATORE"
	}, {
		"section" : "4907",
		"description" : "FINANZA E MERCATI"
	}, {
		"section" : "4908",
		"description" : "PRIMA PAGINA DOMENICA"
	}, {
		"section" : "4909",
		"description" : "LUOGHI E PERSONE"
	}, {
		"section" : "4910",
		"description" : "TERZA PAGINA"
	}, {
		"section" : "4911",
		"description" : "RACCONTI"
	}, {
		"section" : "4912",
		"description" : "EDITORIA"
	}, {
		"section" : "4913",
		"description" : "LETTURE"
	}, {
		"section" : "4914",
		"description" : "SCIENZA E FILOSOFIA"
	}, {
		"section" : "4916",
		"description" : "GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
	}, {
		"section" : "4917",
		"description" : "GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
	}, {
		"section" : "4918",
		"description" : "FOTOGRAFIA"
	}, {
		"section" : "4919",
		"description" : "ARTE"
	}, {
		"section" : "4920",
		"description" : "ECONOMIA E SOCIETA'"
	}, {
		"section" : "4922",
		"description" : "MUSICA"
	}, {
		"section" : "4923",
		"description" : "IN SCENA"
	}, {
		"section" : "4924",
		"description" : "TEMPO LIBERATO"
	}, {
		"section" : "4925",
		"description" : "PRIMA PAGINA NOVA24"
	}, {
		"section" : "4926",
		"description" : "IDEE"
	}, {
		"section" : "4927",
		"description" : "IMPRESE"
	}, {
		"section" : "4928",
		"description" : "PRODOTTI"
	}]);

	loadListaArticoliSezione('4899', [{
		"pagina" : "0",
		"titolo" : "Correzione prima dell'Eurogruppo",
		"id" : "1317802942"
	}, {
		"pagina" : "0",
		"titolo" : "Braccio di ferro\nsu viceministri\ne sottosegretari",
		"id" : "1317802946"
	}, {
		"pagina" : "0",
		"titolo" : "«Patrimoniale per chi ha di più»",
		"id" : "1317802948"
	}, {
		"pagina" : "0",
		"titolo" : "I nodi della manovra sul tavolo Monti",
		"id" : "1317802950"
	}, {
		"pagina" : "0",
		"titolo" : "Sull'acqua piani per 30 miliardi",
		"id" : "1317802955"
	}, {
		"pagina" : "0",
		"titolo" : "Sud, per la banda larga 1,3 miliardi",
		"id" : "1317802966"
	}, {
		"pagina" : "0",
		"titolo" : "Infrastrutture, in arrivo\npiù incentivi per i privati",
		"id" : "1317802972"
	}, {
		"pagina" : "0",
		"titolo" : "Prevalga la coesione",
		"id" : "1317802973"
	}, {
		"pagina" : "0",
		"titolo" : "Fini: via i vitalizi degli ex deputati",
		"id" : "1317802976"
	}, {
		"pagina" : "0",
		"titolo" : "Primo taglio: 600 giudici di pace",
		"id" : "1317802982"
	}, {
		"pagina" : "0",
		"titolo" : "Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita",
		"id" : "1317802985"
	}, {
		"pagina" : "0",
		"titolo" : "Casa, più entrate fino a 28 miliardi",
		"id" : "1317802993"
	}, {
		"pagina" : "0",
		"titolo" : "L'urgenza della qualità",
		"id" : "1317802995"
	}, {
		"pagina" : "0",
		"titolo" : "Guida per evitare le liti in condominio",
		"id" : "1317802996"
	}, {
		"pagina" : "0",
		"titolo" : "Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice",
		"id" : "1317803003"
	}, {
		"pagina" : "0",
		"titolo" : "CROLLO IN BORSA",
		"id" : "1317803004"
	}, {
		"pagina" : "0",
		"titolo" : "Enav, arrestato l'ad Pugliesi",
		"id" : "1317803007"
	}, {
		"pagina" : "0",
		"titolo" : "Le Borse guardano al debito Usa",
		"id" : "1317803013"
	}, {
		"pagina" : "0",
		"titolo" : "Bruxelles\nvara un budget\ndi austerità",
		"id" : "1317803017"
	}, {
		"pagina" : "0",
		"titolo" : "Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori",
		"id" : "1317803022"
	}, {
		"pagina" : "0",
		"titolo" : "Sugli eurobond\ntre ipotesi\nda Bruxelles",
		"id" : "1317803023"
	}, {
		"pagina" : "0",
		"titolo" : "I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa",
		"id" : "1317803024"
	}, {
		"pagina" : "0",
		"titolo" : "Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa",
		"id" : "1317803026"
	}, {
		"pagina" : "0",
		"titolo" : "Rischio contagio",
		"id" : "1317803032"
	}, {
		"pagina" : "0",
		"titolo" : "Solo l'Asia resiste\nalla frenata\ndegli scambi",
		"id" : "1317803033"
	}, {
		"pagina" : "0",
		"titolo" : "La liquidità\nche scappa\nsceglie la via\ndi Wall Street",
		"id" : "1317803034"
	}, {
		"pagina" : "0",
		"titolo" : "INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA",
		"id" : "1317803050"
	}, {
		"pagina" : "0",
		"titolo" : "Il «tranello»\ndel dividend yield",
		"id" : "1317803051"
	}, {
		"pagina" : "0",
		"titolo" : "L'impatto \ndell'euro",
		"id" : "1317803052"
	}, {
		"pagina" : "0",
		"titolo" : "Cosa sono lo spread e i buoni del tesoro?",
		"id" : "1317803061"
	}, {
		"pagina" : "0",
		"titolo" : "Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California",
		"id" : "1317803066"
	}, {
		"pagina" : "0",
		"titolo" : "Se il bene è senza prezzo»\nservono tasse e divieti",
		"id" : "1317803068"
	}]);
}

var _INDICE_OPEN = true;
function wrapperArticoloClick() {
	if (_INDICE_OPEN) {
		if (isPortrait) {
			closeIndice();
		} else {
			handleTopbar();
		}
	} else {
		handleTopbar();
	}
}

function openIndice() {
	if (_INDICE_OPEN) return;
	_INDICE_OPEN = true;
	nascondiTopbar();
	var wrapperSize = (!isPortrait) ? 0.25 : 0.4 ;
	
	$('#wrapper_indice').animate({
		'left': '+=' + (screenWidth * wrapperSize) + 'px'
	}, 'normal');
}

function closeIndice() {
	if (!_INDICE_OPEN) return;
	_INDICE_OPEN = false;
	var wrapperSize = (!isPortrait) ? 0.25 : 0.4 ;
	
	$('#wrapper_indice').animate({
		'left': '-=' + (screenWidth * wrapperSize) + 'px'
	}, 'normal');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
		_CURRENT_ARTICLE.titolo = ( typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
		_CURRENT_ARTICLE.sottotitolo = ( typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
		_CURRENT_ARTICLE.occhiello = ( typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
		_CURRENT_ARTICLE.firma = ( typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
		_CURRENT_ARTICLE.testo = ( typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
		_CURRENT_ARTICLE.tags = "";
		// usato per agganciare in automatico gli stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = ( typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
		_CURRENT_ARTICLE.grafici = ( typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
		_CURRENT_ARTICLE.sommari = ( typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = ( typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = ( typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = ( typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;

		return renderArticolo();
	} catch (exc) {
		return exc.message;
	}
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
		_CURRENT_ARTICLE.titolo = ( typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
		_CURRENT_ARTICLE.sottotitolo = ( typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
		_CURRENT_ARTICLE.occhiello = ( typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
		_CURRENT_ARTICLE.firma = ( typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
		_CURRENT_ARTICLE.testo = ( typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
		_CURRENT_ARTICLE.tags = "";
		// usato per agganciare in automatico gli stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = ( typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
		_CURRENT_ARTICLE.grafici = ( typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
		_CURRENT_ARTICLE.sommari = ( typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = ( typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = ( typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = ( typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;

		if (!_DEBUG_MODE) {
			setTimeout(function() {
				// window.location = 'dsh://loading.done';

				$('#container_adv').writeCapture().load(_ADV_PROXY + '?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime() + '&s=' + _SCREENADV, function() {
				}).endCapture();
				console.log('adv is ' + _ADV_PROXY + '?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime());
				/*
				$('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
				}).endCapture();*/
				//console.log('adv '+'http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04');

				setTimeout(function() {
					nascondiTopbar();
				}, 2000);

			}, 200);
		}
	} catch (exc) {
		return exc.message;
	}
	return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo() {
	try {

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.destroy();
			_ARTICOLO_ISCROLL = null;
		}
		if (_MMEDIA_ISCROLL != null) {
			_MMEDIA_ISCROLL.destroy();
			_MMEDIA_ISCROLL = null;
		}

		checkDBalreadyPresent();

		$('.box_articolo_selected').removeClass('box_articolo_selected');
		if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
			$('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
		}

		$('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
		$('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
		$('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);

		if (_CURRENT_ARTICLE.titolo.length > 0) {
			$('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
			document.getElementById('articolo_titolazione_titolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_titolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
			$('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.occhiello.length > 0) {
			$('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
			document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.firma.length > 0) {
			$('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
			document.getElementById('articolo_titolazione_firma').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_firma').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.testo.length > 0) {
			$('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
		} else {
			$('#articolo_body_text').html('&nbsp;');
		}

		if (_CURRENT_ARTICLE.sommari.length == 0) {
			document.getElementById('articolo_body_media_sommari').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_sommari').style.display = 'block';
			document.getElementById('articolo_body_media_sommari').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_sommario';
				document.getElementById('articolo_body_media_sommari').appendChild(box);

				var con = document.createElement('div');
				con.className = 'articolo_body_media_sommario_container';
				box.appendChild(con);

				var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
				var l_testo = _CURRENT_ARTICLE.sommari[i][1];

				con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<p>' + l_titolo + '</p>') : '') + l_testo;
				//alert("aaa "+_CURRENT_ARTICLE.sommari[i][0] );
				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.photos.length == 0) {
			document.getElementById('articolo_body_media_photos').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_photos').style.display = 'block';
			document.getElementById('articolo_body_media_photos').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
				var box = document.createElement('div');
				box.className = "articolo_body_media_photo";
				document.getElementById('articolo_body_media_photos').appendChild(box);

				var con = document.createElement('div');
				con.className = "articolo_body_media_photo_container";
				box.appendChild(con);

				var crop = document.createElement('div');
				crop.className = "articolo_body_media_photo_container_crop";
				con.appendChild(crop);

				var cropbox = document.createElement('div');
				cropbox.className = 'articolo_body_media_photo_container_crop_box';
				crop.appendChild(cropbox);

				var img = document.createElement('img');
				cropbox.appendChild(img);
				img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';

				if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
					var dida = document.createElement('div');
					con.appendChild(dida);
					dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
					dida = null;
				}

				var open = document.createElement('img');
				open.className = 'articolo_body_media_photo_container_open';
				crop.appendChild(open);
				open.src = 'imgs/articolo_body_media_photo_container_open.png';

				box.onclick = (function(url) {
					return function() {
						if (_LockTap) return;
						_LockTap = true;
						//window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.photos[i][0]);

				open = null;
				img = null;
				cropbox = null;
				crop = null;
				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.grafici.length == 0) {
			document.getElementById('articolo_body_media_grafici').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_grafici').style.display = 'block';
			document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
				var box = document.createElement('div');
				document.getElementById('articolo_body_media_grafici_content').appendChild(box);
				box.className = 'articolo_body_media_arricchimento_item';
				box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';

				box.onclick = (function(url) {
					return function() {
						if (_LockTap) return;
						_LockTap = true;
						//window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.grafici[i][0]);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_photos.length == 0) {
			document.getElementById('articolo_body_media_gallery').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_gallery').style.display = 'block';
			document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_gallery_content').appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';

				box.onclick = (function(id) {
					return function(event) {
						if (_LockTap) return;
						_LockTap = true;
						event.preventDefault();
						event.stopPropagation();
						//window.location = 'dsh://gallery.open/' + id;
						console.log("urlid is" + id);
						window.opengallery.open(id);
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.arr_photos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_videos.length == 0) {
			document.getElementById('articolo_body_media_video').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_video').style.display = 'block';
			document.getElementById('articolo_body_media_video_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_video_content').appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';

				box.onclick = (function(id) {
					return function(event) {
						if (_LockTap) return;
						_LockTap = true;
						event.preventDefault();
						event.stopPropagation();
						//window.location = 'dsh://video.open/' + id;
						window.openvideo.open(id);
						_LockTap = false;
					}
				})(_CURRENT_ARTICLE.arr_videos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_link.length == 0) {
			document.getElementById('articolo_body_media_link').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_link').style.display = 'block';
			document.getElementById('articolo_body_media_link_content').innerHTML = '';
			for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_link_content').appendChild(box);

				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

				if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
							setTimeout(function(){ _LockTap = false; }, 500);
						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

				box = null;
			}
		}
		
		var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
		if (fullArr.length == 0) {
			document.getElementById('articolo_mainmedia').style.display = 'none';
		} else {
			document.getElementById('articolo_mainmedia').style.display = 'block';
			document.getElementById('articolo_mainmedia_container').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
			$('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
			for (var i = 0; i < fullArr.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_mainmedia_container_box';
				document.getElementById('articolo_mainmedia_container').appendChild(box);

				var container = document.createElement('div');
				container.className = 'articolo_mainmedia_container_box_container';
				box.appendChild(container);

				var img = document.createElement('img');
				img.className = 'articolo_mainmedia_container_box_img';
				container.appendChild(img);
				img.src = fullArr[i]['preview'];

				var icon = document.createElement('img');
				icon.className = 'articolo_mainmedia_container_icon';
				box.appendChild(icon);
				icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';

				if (fullArr[i]['tipo'] == "VIDEO") {
					box.onclick = (function(id) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = 'dsh://video.open/' + id;
							window.openvideo.open(id);
							_LockTap = false;
						}
					})(fullArr[i]['id']);
				} else if (fullArr[i]['tipo'] == "PHOTOS") {
					box.onclick = (function(id) {
						return function(event) {
							if (_LockTap) return;
							_LockTap = true;
							event.preventDefault();
							event.stopPropagation();
							//window.location = 'dsh://gallery.open/' + id;
							console.log("urlid is" + id);
							window.opengallery.open(id);
							_LockTap = false;
						}
					})(fullArr[i]['id']);
				}
				
				icon = null;
				img = null;
				container = null;
				box = null;

				var progress = document.createElement('div');
				progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
				document.getElementById('articolo_mainmedia_progress').appendChild(progress);
				progress = null;
			}
		
			_MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
				snap : true,
				momentum : false,
				hScrollbar : false,
				vScroll : false,
				onScrollEnd : function() {
					document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
					document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
				}
			});
		}

		_ARTICOLO_ISCROLL = new iScroll('wrapper_articolo', {});
		
		$('#articolo_body_text table').click(function(event) {
			event.stopPropagation();
			try {
				ARTICOLO_BODY_TEXT_TABLE_CONTENT = $(this)[0].outerHTML;
				if ((ARTICOLO_BODY_TEXT_TABLE_CONTENT != null) && (ARTICOLO_BODY_TEXT_TABLE_CONTENT.length >= 1)) {
					//window.location = 'dsh://tabella.open/HTML';
					//alert('aaaa12');
					window.opentabella.open(JSON.stringify(ARTICOLO_BODY_TEXT_TABLE_CONTENT));
				}
			} catch (exc) {
				console.log(exc.message);
			}
		});

		loadCorrelates();

		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display", "none");
	} catch (exc) {
		console.log("error: " + exc.message + ":::" + exc.what + ":" + exc.stack);
		return exc.message;
	}

	return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var ARTICOLO_BODY_TEXT_TABLE_CONTENT = '';
function getArticoloBodyTextTableContent() {
	return ARTICOLO_BODY_TEXT_TABLE_CONTENT;
}

var CURRENT_ORIENTATION = null;

function updateOrientation() {
	setTimeout(function() {
		screenHeight = window.innerHeight;
		screenWidth = window.innerWidth;
		if (!screenHeight) screenHeight = screen.height;
		if (!screenWidth) screenWidth = screen.width;
		if (!_DEBUG_MODE) screenHeight /= window.devicePixelRatio;
		if (!_DEBUG_MODE) screenWidth /= window.devicePixelRatio;
		isPortrait = screenWidth < screenHeight;
		//alert('isPortrait: ' + isPortrait);

		var orientation = isPortrait ? 1 : 2 ;
		if (CURRENT_ORIENTATION == orientation) return;
		CURRENT_ORIENTATION = orientation;
		
		var fontSizeRatio = (isPortrait) ? Math.round(screenHeight * 0.02) : Math.round(screenWidth * 0.02);
		$('body').css('font-size', fontSizeRatio + 'px');
		fontSizeRatio = null;
		
		if (isPortrait) {
			closeIndice();
		} else {
			openIndice();
		}
		
		var androidComponents = (isPortrait) ? 75 : 25;
		$('#articoli_wrapper').height(screenHeight - $('#sezioni_wrapper').height() - androidComponents);
		
		$('.articolo_mainmedia_container_box').width($('#articolo_mainmedia_wrapper').width());
		$('.articolo_body_media_photo_container_crop').height((isPortrait) ? screenHeight * 0.4 : screenHeight * 0.7) ;
		$('#articolo_mainmedia').height((isPortrait) ? screenHeight * 0.3 : screenHeight * 0.55) ;
		
		if (_ARTICOLO_ISCROLL != null) _ARTICOLO_ISCROLL.refresh();
		if (_ISCROLL_ARTICOLI != null) _ISCROLL_ARTICOLI.refresh();
		
	}, 500);
}

function handleTopbar() {
	//document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
	$('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

//var _TIMEOUT_MENU = null;
function mostraTopbar() {
	$('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar() {
	//document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
	$('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent() {
	if (_DB) {
		var querySuccess = function(tx, rs) {
			checkDBalreadyPresent_aux(rs.rows.length > 0);
		}
		var queryError = function(tx, p_error) {
			checkDBalreadyPresent_aux(false);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	} else {

		checkDBalreadyPresent_aux(false);
	}
}

function checkDBalreadyPresent_aux(isPresent) {
	document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
	document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}

function eliminaPreferito() {
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?', 'eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
	if (_CURRENT_ARTICLE == null)
		return;
	try {
		if (_DB) {
			var querySuccessTag = function(tx) {
				//alert('OK eliminazione tag preferito.');
				document.getElementById('btn_preferiti_off').style.display = 'inline-block';
				document.getElementById('btn_preferiti_on').style.display = 'none';
			}
			var queryErrorTag = function(tx, p_error) {
				//alert('KO eliminazione tag preferito: ' + p_error.message);
			}
			var querySuccess = function(tx) {
				//alert('OK eliminazione preferito.');
				tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
			}
			var queryError = function(tx, p_error) {
				//alert('KO eliminazione preferito: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				try {
					tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
				} catch (exc) {
					console.log(exc.message);
				}
			}
			_DB.transaction(executeQuery);
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function openSavePreferiti() {
	if (_CURRENT_ARTICLE == null)
		return;
	if (_LockTap) return;
	_LockTap = true;

	popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
	setTimeout(function(){ _LockTap = false; }, 500);
}

function doSavePreferiti() {
	try {//MOD HTML
		preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());

		document.getElementById('btn_preferiti_off').style.display = 'none';
		document.getElementById('btn_preferiti_on').style.display = 'inline-block';

		popupPreferitiUpdateArticleChiudi();
	} catch(exc) {
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK preferitiDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO preferitiDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
			tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags) {
	console.log("db is " + _DB);
	try {
		if (_DB) {
			var querySuccess = function(tx) {
				console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
				var tags_arr = tags.split(',');
				for (var t = 0; t < tags_arr.length; t++) {
					var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, "");
					//TRIM
					if (l_tag.length <= 0)
						continue;
					tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function() {
						console.log('OK SAVE LOCAL DB TAG');
					}, function(tx, p_error) {
						console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
					});
				}
			}
			var queryError = function(tx, p_error) {
				console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
			}
			_DB.transaction(executeQuery);
		}
	} catch(exc) {
		console.log('error ' + exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson) {
	if (_ISCROLL_SEZIONI != null) {
		_ISCROLL_SEZIONI.destroy();
		_ISCROLL_SEZIONI = null;
	}

	document.getElementById('sezioni_container').innerHTML = '';

	//document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';

	//alert(JSON.stringify(sezioniJson));

	for (var i = 0; i < sezioniJson.length; i++) {

		var box = document.createElement('div');
		box.id = 'box_section_' + sezioniJson[i].section;
		box.className = 'box_sezione';
		document.getElementById('sezioni_container').appendChild(box);

		var inner = document.createElement('div');
		box.appendChild(inner);

		inner.innerHTML = sezioniJson[i].description;

		box.onclick = (function(sid) {
			return function() {
				sezioneSelected(sid);
				_ISCROLL_ARTICOLI.refresh();
			}
		})(sezioniJson[i].section);

		inner = null;
		box = null;

	}

	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true));
	}

	setTimeout(function() {
		_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {});
	}, 200);

	return "OK";

}

function sezioneSelected(sid) {
	$('.box_sezione_selected').removeClass('box_sezione_selected');
	//window.location = 'dsh://indice.load/' + sid;
	window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson) {
	$('#box_section_' + sid).addClass('box_sezione_selected');
	$('#articoli_container').empty();

	if (articoliJson.length == 0) $('#articoli_container').html('<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>');

	for (var i = 0; i < articoliJson.length; i++) {
		var box = document.createElement('div');
		box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
		box.id = 'box_articolo_' + articoliJson[i].id;
		document.getElementById('articoli_container').appendChild(box);

		var titolo = document.createElement('p');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;

		box.onclick = (function(aid) {
			return function() {
				console.log("aid is " + aid);
				window.indice.loadArticle(aid);
				if (isPortrait) closeIndice();
			}
		})(articoliJson[i].id);

		titolo = null;
		box = null;
	}

	setTimeout(function() {
		if (_ISCROLL_ARTICOLI != null) {
			_ISCROLL_ARTICOLI.refresh();
		} else {
			_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
				bounce: false,
				hideScrollbar: true,
				fadeScrollbar: true
			});
		}

		if (_ISCROLL_SEZIONI != null) {
			//_ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
		}
	}, 300);

	return "OK";
}

/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	try {
		_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
	} catch(exc) {
		console.log(exc.message);
	}
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;

/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {

	//$('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').html(p_article.titolo);
		$('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
		$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for (var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
				}
			}
			var queryError = function(p_error) {
				console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
			}
			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();
	// Salva le modifiche
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
		}
		var updateQuerySuccess = function(tx, p_results) {
			console.log("popupPreferitiUpdateArticleAvanti: Update article success");
			if (p_results.rowsAffected > 0) {
				document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
			}
		}
		var queryError = function(p_error) {
			console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
			var l_tags_array = l_tags.toLowerCase().split(',');
			for (var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, "");
				//TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
			}
		}
		//Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	//$('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

function decodeHtml(value) {
	return $('<div />').html(value).text();
}

function shareFacebook() {
	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;
		
	if (_LockTap) return;
	_LockTap = true;

    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';

	var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

	//window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
	//window.location = 'http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo);
	window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent(l_url) + '&t=' + encodeURIComponent(l_titolo));
	setTimeout(function(){ _LockTap = false; }, 500);
}

function shareTwitter() {
	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;
		
	if (_LockTap) return;
	_LockTap = true;

   var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? decodeHtml(_CURRENT_ARTICLE.titolo) : 'edicola.ilsole24ore.com';
    
	var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_social.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

	//window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
	//window.location = 'https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo);
	window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent(l_url) + '&text=' + encodeURIComponent(l_titolo));
	setTimeout(function(){ _LockTap = false; }, 500);
}

/*
 function shareFacebook(){
 if (_CURRENT_ARTICLE == null)
 return;

 if (_CURRENT_ARTICLE == null)
 return;

 var l_shared_id = _CURRENT_ARTICLE.shared_id;
 if (l_shared_id == null)
 return;

 var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

 window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
 }

 function shareTwitter(){
 if (_CURRENT_ARTICLE == null)
 return;

 var l_shared_id = _CURRENT_ARTICLE.shared_id;
 if (l_shared_id == null)
 return;

 var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

 window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?idart=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
 }

 */
var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
var _API24_APPKEY = "DroidQuot";//"iPadQuot";
//DA CAMBIARE
var _APPNAME = 'ITQUOIPAD';
//DA CAMBIARE
var _APPVERSION = '1.1';
// DA CAMBIARE A 2.0
function loadCorrelates() {
	if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null))
		renderCorrelate(null, null);

	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');

	var req_headers = {
		"appKey" : _API24_APPKEY
	};
	var req_data = {
		"appName" : _APPNAME,
		"appVersion" : _APPVERSION
	};
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
	$.ajax({
		type : "GET",
		cache : false,
		timeout : _AJAX_TIMEOUT,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
		headers : req_headers,
		data : req_data,
		dataType : "json",
		success : function(p_response) {
			if ( typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
		},
		error : function() {
			renderCorrelate(null, null);
		}
	});
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		$('#articolo_body_media_correlati').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}

		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);

		box.innerHTML = articoli[i].titolo;

		box.onclick = (function(url) {
			return function(event) {
				event.preventDefault();
				event.stopPropagation();
				window.open.openUrl(url);
			}
		})(articoli[i].url);

		box = null;
	}

	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}

}

function articoloZoomAuxText(p_zoomstep) {
	try {
		if (_LockTap) return;
		_LockTap = true;
		var l_currtextzoom = null;
		if ( typeof (window.localStorage) != 'undefined') {
			l_currtextzoom = window.localStorage.getItem("currtxtzoom");
		}
		if (!l_currtextzoom)
			l_currtextzoom = 100;
		else
			l_currtextzoom = parseInt(l_currtextzoom);
		switch (l_currtextzoom) {
			case 80:
			case 100:
			case 120:
			case 140:
			case 160:

				break;
			default:
				l_currtextzoom = 100;
		}
		l_currtextzoom = Math.max(80, Math.min(160, l_currtextzoom + p_zoomstep));
		window.localStorage.setItem("currtxtzoom", l_currtextzoom);
		$('#articolo_body_text').css('font-size', l_currtextzoom + '%');

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
		setTimeout(function(){ _LockTap = false; }, 500);
	} catch (exc) {
		console.log(exc.message);
	}
}

function articoloZoomInText() {
	articoloZoomAuxText(20);
	//console.log("aaaaaaaa1a");
}

function articoloZoomOutText() {
	articoloZoomAuxText(-20);
	//console.log("aaaaaaaaa");
}

function shareMy24() {
	try {
		if (_CURRENT_ARTICLE == null)
			return;

		var l_shared_id = _CURRENT_ARTICLE.shared_id;
		if (l_shared_id == null)
			return;
			
		if (_LockTap) return;
		_LockTap = true;

		var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';

		var l_url = 'http://mobapp24.ilsole24ore.com/_proxy/proxy_my24.php?testata=' + _CURRENT_ARTICLE.testata + '&edizione=' + _CURRENT_ARTICLE.edizione + '&issue=' + _CURRENT_ARTICLE.issue + '&artid=' + l_shared_id;

		window.open.openUrl(l_url);
		setTimeout(function(){ _LockTap = false; }, 500);
	} catch(exc) {
		alert(exc.message);
	}
}

if (_DEBUG_MODE) {
	$(function(){ onBodyLoaded(); });
} else {
	document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
}

function setBackground(color){
	$('#wrapper_articolo').css("background-color", color);
	$('#wrapper_articolo').css("background-image","none");
}

/**
 * @author ABertacco
 */
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

function doCerca() {
	if ($('#search_input').val() == '')
		return;
	if ($('#searchkeyword_option').val() == 'LOCAL')
		searchDb();
	else
		remoteSearch();
}

var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_ISCROLL_ARTICOLI != null) {
		_ISCROLL_ARTICOLI.destroy();
		_ISCROLL_ARTICOLI = null;
	}

	document.getElementById('articoli_container').innerHTML = '';

	if (articoliJson.length == 0)
		document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';

	for ( var i = 0; i < articoliJson.length; i++) {

		var box = document.createElement('div');
		box.className = 'box_articolo';
		document.getElementById('articoli_container').appendChild(box);
		box.id = 'box_articolo_' + i;

		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;

		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;

		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr
				+ '</strong> del ' + articoliJson[i].issue_descr + ' (pag. '
				+ articoliJson[i].pagina + ')';

		box.onclick = (function(articoloJson, domid) {
			return function() {
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(
						function() {
							that.className = 'box_articolo';
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
							_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;

							// window.location = 'dsh://remotecerca.goto';
							// alert(articoloJson.testata + ' ' +
							// articoloJson.issue + ' ' + articoloJson.edizione
							// + ' ' + articoloJson.itunes);
						}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);

		pagina = null;
		snippet = null;
		titolo = null;
		box = null;

	}

	setTimeout(function() {
		_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
			hScroll : false,
			vScroll : true
		});
		_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);

	}, 200);
}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA,
			'issue' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE,
			'edizione' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE,
			'itunes' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina' : _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}

function onBodyLoad() {

	// mostraTopbar();

	if (_DB == null) {
		inizializzaDatabase();
		preferitiDBinit();
	}

	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo(
				{
					artid : '1317851504',
					shared_id : '2844111',
					testata : 'S24',
					edizione : 'SOLE',
					issue : '20111129',
					testata_descr : 'Il Sole 24 ORE',
					edizione_descr : 'Il Sole 24 Ore',
					issue_descr : '29 Novembre 2011',
					pagina : 1,
					sezione : 'PRIMA',
					sezione_descr : '6126',
					occhiello : [ "RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte" ],
					titolo : [ "Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse" ],
					sottotitolo : [ "Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500" ],
					firme : [],
					testo : [ "Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5" ],
					photos : [ [
							"/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg",
							"«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)" ] ],
					grafici : [],
					sommari : []
				},
				[],
				[],
				[ {
					"items" : [ {
						"url" : "http://mrdoob.com/projects/chromeexperiments/ball_pool/",
						"descrizione" : "Ball Pool"
					} ],
					"id" : "145",
					"package" : "1317851504",
					"descrizione" : "HTML5 - Ball Pool",
					"preview" : "",
					"tipo" : "LINK"
				} ]);
		loadCorrelates();
		loadSezioni([
				{
					"section" : "4898",
					"description" : "PRIMA"
				},
				{
					"section" : "4899",
					"description" : "PRIMO PIANO"
				},
				{
					"section" : "4901",
					"description" : "COMMENTI E INCHIESTE"
				},
				{
					"section" : "4902",
					"description" : "POLITICA E SOCIETA'"
				},
				{
					"section" : "4903",
					"description" : "MONDO"
				},
				{
					"section" : "4904",
					"description" : "ECONOMIA E IMPRESE"
				},
				{
					"section" : "4905",
					"description" : "NORME E TRIBUTI"
				},
				{
					"section" : "4906",
					"description" : "LETTERA AL RISPARMIATORE"
				},
				{
					"section" : "4907",
					"description" : "FINANZA E MERCATI"
				},
				{
					"section" : "4908",
					"description" : "PRIMA PAGINA DOMENICA"
				},
				{
					"section" : "4909",
					"description" : "LUOGHI E PERSONE"
				},
				{
					"section" : "4910",
					"description" : "TERZA PAGINA"
				},
				{
					"section" : "4911",
					"description" : "RACCONTI"
				},
				{
					"section" : "4912",
					"description" : "EDITORIA"
				},
				{
					"section" : "4913",
					"description" : "LETTURE"
				},
				{
					"section" : "4914",
					"description" : "SCIENZA E FILOSOFIA"
				},
				{
					"section" : "4916",
					"description" : "GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
				},
				{
					"section" : "4917",
					"description" : "GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"
				}, {
					"section" : "4918",
					"description" : "FOTOGRAFIA"
				}, {
					"section" : "4919",
					"description" : "ARTE"
				}, {
					"section" : "4920",
					"description" : "ECONOMIA E SOCIETA'"
				}, {
					"section" : "4922",
					"description" : "MUSICA"
				}, {
					"section" : "4923",
					"description" : "IN SCENA"
				}, {
					"section" : "4924",
					"description" : "TEMPO LIBERATO"
				}, {
					"section" : "4925",
					"description" : "PRIMA PAGINA NOVA24"
				}, {
					"section" : "4926",
					"description" : "IDEE"
				}, {
					"section" : "4927",
					"description" : "IMPRESE"
				}, {
					"section" : "4928",
					"description" : "PRODOTTI"
				} ]);

		loadListaArticoliSezione(
				'4899',
				[
						{
							"pagina" : "0",
							"titolo" : "Correzione prima dell'Eurogruppo",
							"id" : "1317802942"
						},
						{
							"pagina" : "0",
							"titolo" : "Braccio di ferro\nsu viceministri\ne sottosegretari",
							"id" : "1317802946"
						},
						{
							"pagina" : "0",
							"titolo" : "«Patrimoniale per chi ha di più»",
							"id" : "1317802948"
						},
						{
							"pagina" : "0",
							"titolo" : "I nodi della manovra sul tavolo Monti",
							"id" : "1317802950"
						},
						{
							"pagina" : "0",
							"titolo" : "Sull'acqua piani per 30 miliardi",
							"id" : "1317802955"
						},
						{
							"pagina" : "0",
							"titolo" : "Sud, per la banda larga 1,3 miliardi",
							"id" : "1317802966"
						},
						{
							"pagina" : "0",
							"titolo" : "Infrastrutture, in arrivo\npiù incentivi per i privati",
							"id" : "1317802972"
						},
						{
							"pagina" : "0",
							"titolo" : "Prevalga la coesione",
							"id" : "1317802973"
						},
						{
							"pagina" : "0",
							"titolo" : "Fini: via i vitalizi degli ex deputati",
							"id" : "1317802976"
						},
						{
							"pagina" : "0",
							"titolo" : "Primo taglio: 600 giudici di pace",
							"id" : "1317802982"
						},
						{
							"pagina" : "0",
							"titolo" : "Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita",
							"id" : "1317802985"
						},
						{
							"pagina" : "0",
							"titolo" : "Casa, più entrate fino a 28 miliardi",
							"id" : "1317802993"
						},
						{
							"pagina" : "0",
							"titolo" : "L'urgenza della qualità",
							"id" : "1317802995"
						},
						{
							"pagina" : "0",
							"titolo" : "Guida per evitare le liti in condominio",
							"id" : "1317802996"
						},
						{
							"pagina" : "0",
							"titolo" : "Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice",
							"id" : "1317803003"
						},
						{
							"pagina" : "0",
							"titolo" : "CROLLO IN BORSA",
							"id" : "1317803004"
						},
						{
							"pagina" : "0",
							"titolo" : "Enav, arrestato l'ad Pugliesi",
							"id" : "1317803007"
						},
						{
							"pagina" : "0",
							"titolo" : "Le Borse guardano al debito Usa",
							"id" : "1317803013"
						},
						{
							"pagina" : "0",
							"titolo" : "Bruxelles\nvara un budget\ndi austerità",
							"id" : "1317803017"
						},
						{
							"pagina" : "0",
							"titolo" : "Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori",
							"id" : "1317803022"
						},
						{
							"pagina" : "0",
							"titolo" : "Sugli eurobond\ntre ipotesi\nda Bruxelles",
							"id" : "1317803023"
						},
						{
							"pagina" : "0",
							"titolo" : "I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa",
							"id" : "1317803024"
						},
						{
							"pagina" : "0",
							"titolo" : "Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa",
							"id" : "1317803026"
						},
						{
							"pagina" : "0",
							"titolo" : "Rischio contagio",
							"id" : "1317803032"
						},
						{
							"pagina" : "0",
							"titolo" : "Solo l'Asia resiste\nalla frenata\ndegli scambi",
							"id" : "1317803033"
						},
						{
							"pagina" : "0",
							"titolo" : "La liquidità\nche scappa\nsceglie la via\ndi Wall Street",
							"id" : "1317803034"
						},
						{
							"pagina" : "0",
							"titolo" : "INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA",
							"id" : "1317803050"
						},
						{
							"pagina" : "0",
							"titolo" : "Il «tranello»\ndel dividend yield",
							"id" : "1317803051"
						},
						{
							"pagina" : "0",
							"titolo" : "L'impatto \ndell'euro",
							"id" : "1317803052"
						},
						{
							"pagina" : "0",
							"titolo" : "Cosa sono lo spread e i buoni del tesoro?",
							"id" : "1317803061"
						},
						{
							"pagina" : "0",
							"titolo" : "Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California",
							"id" : "1317803066"
						},
						{
							"pagina" : "0",
							"titolo" : "Se il bene è senza prezzo»\nservono tasse e divieti",
							"id" : "1317803068"
						} ]);
	}
}

var _INDICE_OPEN = false;
function wrapperArticoloClick() {
	if (_INDICE_OPEN) {
		closeIndice();
	} else {
		// mostraTopbar();
		handleTopbar();
	}
}

function openIndice() {
	_INDICE_OPEN = true;
	$('#wrapper_indice').addClass('wrapper_indice_attivo');
	nascondiTopbar();
}

function closeIndice() {
	console.log('a');
	_INDICE_OPEN = false;
	$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id
				: 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id
				: null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata
				: '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr
				: '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue
				: '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr
				: '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione
				: '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr
				: '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr
				: '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina
				: 1;
		_CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined"
				&& articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo
				: '';
		_CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined"
				&& articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo
				: '';
		_CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined"
				&& articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello
				: '';
		_CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined"
				&& articolo.firma != null && articolo.firma.length > 0) ? articolo.firma
				: '';
		_CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined"
				&& articolo.testo != null && articolo.testo.length > 0) ? articolo.testo
				: '';
		_CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli
									// stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined"
				|| articolo.photos == null || articolo.photos.length == 0) ? []
				: articolo.photos;
		_CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined"
				|| articolo.grafici == null || articolo.grafici.length == 0) ? []
				: articolo.grafici;
		_CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined"
				|| articolo.sommari == null || articolo.sommari.length == 0) ? []
				: articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined"
				|| arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined"
				|| arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined"
				|| arrLink == null || arrLink.length == 0) ? [] : arrLink;

		return renderArticolo();
	} catch (exc) {
		return exc.message;
	}
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink) {
	try {
		_CURRENT_ARTICLE = {};

		_CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid
				: 'x_' + new Date().getTime();
		_CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id
				: null;
		_CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata
				: '';
		_CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr
				: '';
		_CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue
				: '';
		_CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr
				: '';
		_CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione
				: '';
		_CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr
				: '';
		_CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione
				: '';
		_CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina
				: 1;
		_CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined"
				&& articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo
				.join('<br />')
				: '';
		_CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined"
				&& articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo
				.join('<br />')
				: '';
		_CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined"
				&& articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello
				.join('<br />')
				: '';
		_CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined"
				&& articolo.firma != null && articolo.firma.length > 0) ? articolo.firma
				.join('<br />')
				: '';
		_CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined"
				&& articolo.testo != null && articolo.testo.length > 0) ? articolo.testo
				.join('<br />')
				: '';
		_CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli
									// stessi metodi del modifica tags
		_CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined"
				|| articolo.photos == null || articolo.photos.length == 0) ? []
				: articolo.photos;
		_CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined"
				|| articolo.grafici == null || articolo.grafici.length == 0) ? []
				: articolo.grafici;
		_CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined"
				|| articolo.sommari == null || articolo.sommari.length == 0) ? []
				: articolo.sommari;
		_CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined"
				|| arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
		_CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined"
				|| arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined"
				|| arrLink == null || arrLink.length == 0) ? [] : arrLink;

		if (!_DEBUG_MODE) {
			setTimeout(function() {
				// window.location = 'dsh://loading.done';

				// $('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t='
				// + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(),
				// function(){}).endCapture();

				/*
				 * $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' +
				 * new Date().getTime() + '@Ticker_04', function(){
				 * }).endCapture();
				 */

				setTimeout(function() {
					nascondiTopbar();
				}, 2000);

			}, 200);
		}
	} catch (exc) {
		return exc.message;
	}
	return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo() {
	try {

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.destroy();
			_ARTICOLO_ISCROLL = null;
		}
		if (_MMEDIA_ISCROLL != null) {
			_MMEDIA_ISCROLL.destroy();
			_MMEDIA_ISCROLL = null;
		}

		checkDBalreadyPresent();

		$('.box_articolo_selected').removeClass('box_articolo_selected');
		if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
			$('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass(
					'box_articolo_selected');
		}

		$('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
		$('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
		$('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);

		if (_CURRENT_ARTICLE.titolo.length > 0) {
			$('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
			document.getElementById('articolo_titolazione_titolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_titolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
			$('#articolo_titolazione_sottotitolo').html(
					_CURRENT_ARTICLE.sottotitolo);
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.occhiello.length > 0) {
			$('#articolo_titolazione_occhiello').html(
					_CURRENT_ARTICLE.occhiello);
			document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.firma.length > 0) {
			$('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
			document.getElementById('articolo_titolazione_firma').style.display = 'block';
		} else {
			document.getElementById('articolo_titolazione_firma').style.display = 'none';
		}

		if (_CURRENT_ARTICLE.testo.length > 0) {
			$('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
		} else {
			$('#articolo_body_text').html('&nbsp;');
		}

		if (_CURRENT_ARTICLE.sommari.length == 0) {
			document.getElementById('articolo_body_media_sommari').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_sommari').style.display = 'block';
			document.getElementById('articolo_body_media_sommari').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_sommario';
				document.getElementById('articolo_body_media_sommari')
						.appendChild(box);

				var con = document.createElement('div');
				con.className = 'articolo_body_media_sommario_container';
				box.appendChild(con);

				var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
				var l_testo = _CURRENT_ARTICLE.sommari[i][1];

				con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>'
						+ l_titolo + '</h1>')
						: '')
						+ l_testo;

				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.photos.length == 0) {
			document.getElementById('articolo_body_media_photos').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_photos').style.display = 'block';
			document.getElementById('articolo_body_media_photos').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
				var box = document.createElement('div');
				box.className = "articolo_body_media_photo";
				document.getElementById('articolo_body_media_photos')
						.appendChild(box);

				var con = document.createElement('div');
				con.className = "articolo_body_media_photo_container";
				box.appendChild(con);

				var crop = document.createElement('div');
				crop.className = "articolo_body_media_photo_container_crop";
				con.appendChild(crop);

				var cropbox = document.createElement('div');
				cropbox.className = 'articolo_body_media_photo_container_crop_box';
				crop.appendChild(cropbox);

				var img = document.createElement('img');
				cropbox.appendChild(img);
				img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0]
						+ '.thumb.jpg';

				if (_CURRENT_ARTICLE.photos[i][1] != null
						&& _CURRENT_ARTICLE.photos[i][1].length > 0) {
					var dida = document.createElement('div');
					con.appendChild(dida);
					dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
					dida = null;
				}

				var open = document.createElement('img');
				open.className = 'articolo_body_media_photo_container_open';
				crop.appendChild(open);
				open.src = 'imgs/articolo_body_media_photo_container_open.png';

				box.onclick = (function(url) {
					return function() {
						// window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery
								.open(_DEPLOY_BASE_URL + url + '.jpg');
					}
				})(_CURRENT_ARTICLE.photos[i][0]);

				open = null;
				img = null;
				cropbox = null;
				crop = null;
				con = null;
				box = null;
			}
		}

		if (_CURRENT_ARTICLE.grafici.length == 0) {
			document.getElementById('articolo_body_media_grafici').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_grafici').style.display = 'block';
			document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
				var box = document.createElement('div');
				document.getElementById('articolo_body_media_grafici_content')
						.appendChild(box);
				box.className = 'articolo_body_media_arricchimento_item';
				box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1]
						: 'Grafico';

				box.onclick = (function(url) {
					return function() {
						// window.location = 'dsh://photo.open' + url + '.jpg';
						console.log("url is " + url + '.jpg');
						window.opengallery
								.open(_DEPLOY_BASE_URL + url + '.jpg');
					}
				})(_CURRENT_ARTICLE.grafici[i][0]);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_photos.length == 0) {
			document.getElementById('articolo_body_media_gallery').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_gallery').style.display = 'block';
			document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_gallery_content')
						.appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null
						&& _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione']
						: 'Gallery';

				box.onclick = (function(id) {
					return function(event) {
						event.preventDefault();
						event.stopPropagation();
						// window.location = 'dsh://gallery.open/' + id;
						console.log("urlid is" + id);
						window.opengallery.open(id);

					}
				})(_CURRENT_ARTICLE.arr_photos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_videos.length == 0) {
			document.getElementById('articolo_body_media_video').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_video').style.display = 'block';
			document.getElementById('articolo_body_media_video_content').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_video_content')
						.appendChild(box);
				box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null
						&& _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione']
						: 'Video';

				box.onclick = (function(id) {
					return function(event) {
						event.preventDefault();
						event.stopPropagation();
						// window.location = 'dsh://video.open/' + id;
						window.openvideo.open(id);
					}
				})(_CURRENT_ARTICLE.arr_videos[i]['id']);

				box = null;
			}
		}

		if (_CURRENT_ARTICLE.arr_link.length == 0) {
			document.getElementById('articolo_body_media_link').style.display = 'none';
		} else {
			document.getElementById('articolo_body_media_link').style.display = 'block';
			document.getElementById('articolo_body_media_link_content').innerHTML = '';
			for ( var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_body_media_arricchimento_item';
				document.getElementById('articolo_body_media_link_content')
						.appendChild(box);

				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null
						&& _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione']
						: 'Link';

				if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url) {
						return function(event) {
							event.preventDefault();
							event.stopPropagation();
							// window.location = url;
							window.open.openUrl(url);
							// window.open.openUrl('http://www.facebook.com/sharer.php?u='
							// +
							// encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt='
							// + l_shared_id) + '&t=' +
							// encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

				box = null;
			}
		}

		var fullArr = _CURRENT_ARTICLE.arr_photos
				.concat(_CURRENT_ARTICLE.arr_videos);
		if (fullArr.length == 0) {
			document.getElementById('articolo_mainmedia').style.display = 'none';
		} else {
			document.getElementById('articolo_mainmedia').style.display = 'block';
			document.getElementById('articolo_mainmedia_container').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none'
					: '';
			$('#articolo_mainmedia_container').width(
					$('#articolo_mainmedia_wrapper').width() * fullArr.length);
			for ( var i = 0; i < fullArr.length; i++) {
				var box = document.createElement('div');
				box.className = 'articolo_mainmedia_container_box';
				document.getElementById('articolo_mainmedia_container')
						.appendChild(box);

				var container = document.createElement('div');
				container.className = 'articolo_mainmedia_container_box_container';
				box.appendChild(container);

				var img = document.createElement('img');
				img.className = 'articolo_mainmedia_container_box_img';
				container.appendChild(img);
				img.src = fullArr[i]['preview'];

				var desc

				var icon = document.createElement('img');
				icon.className = 'articolo_mainmedia_container_icon';
				box.appendChild(icon);
				icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';

				if (fullArr[i]['tipo'] == "VIDEO") {
					box.onclick = (function(id) {
						return function(event) {
							event.preventDefault();
							event.stopPropagation();
							// window.location = 'dsh://video.open/' + id;
							window.openvideo.open(id);
						}
					})(fullArr[i]['id']);
				} else if (fullArr[i]['tipo'] == "PHOTOS") {
					box.onclick = (function(id) {
						return function(event) {
							event.preventDefault();
							event.stopPropagation();
							// window.location = 'dsh://gallery.open/' + id;
							console.log("urlid is" + id);
							window.opengallery.open(id);

						}
					})(fullArr[i]['id']);
				}

				icon = null;
				img = null;
				container = null;
				box = null;

				var progress = document.createElement('div');
				progress.className = 'articolo_mainmedia_progress_box'
						+ (i == 0 ? ' articolo_mainmedia_progress_box_active'
								: '');
				document.getElementById('articolo_mainmedia_progress')
						.appendChild(progress);
				progress = null;
			}

			_MMEDIA_ISCROLL = new iScroll(
					'articolo_mainmedia_wrapper',
					{
						snap : true,
						momentum : false,
						hScrollbar : false,
						vScroll : false,
						onScrollEnd : function() {
							document
									.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
							document
									.querySelector('#articolo_mainmedia_progress > div:nth-child('
											+ (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
						}
					});
		}

		_ARTICOLO_ISCROLL = null;// new iScroll('wrapper_articolo', {});

		loadCorrelates();

		// window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display", "none");
	} catch (exc) {
		console.log("error: " + exc.message + ":::" + exc.what + ":"
				+ exc.stack);
		return exc.message;
	}

	return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

function updateOrientation() {
	setTimeout(function() {
		closeIndice();

		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
			_ARTICOLO_ISCROLL.refresh();
		}

		if (_ISCROLL_ARTICOLI != null) {
			_ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
			_ISCROLL_ARTICOLI.refresh();
		}
	}, 200);
}

function handleTopbar() {
	// document.getElementById('wrapper_topbar').style['-webkit-transform'] =
	// 'translate3d(0px, ''px, 0)';
	$('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * 
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list) {
	

	for ( var i = 0; i < p_messages_list.length; i++) {

		inboxAddMessage(p_messages_list.item(i));

	}

	/*
	 * console.log('Messaggi presenti in locale:');
	 * console.log(_INBOX_MESSAGES);
	 */
}

function searchAddMessage(p_message) {
	_INBOX_MESSAGES['mid_' + p_message.id] = {
		id : p_message.id,
		subject : p_message.subject,
		mabstract : p_message.mabstract,
		date : p_message.date,
		body : p_message.body,
		status : p_message.status
	};

	inboxRenderHeader(p_message.id);

	// inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * 
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid) {
	var box = document.createElement('div');

	var l_container = document.getElementById('inbox_list_container');
	l_container.insertBefore(box, l_container.childNodes[0]);

	if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
		box.className = 'inbox_list_container_box inbox_list_container_box_read';
	} else {
		box.className = 'inbox_list_container_box inbox_list_container_box_unread';
	}

	box.id = 'inbox_list_container_box_' + p_mid;

	var table = document.createElement('table');
	box.appendChild(table);
	table.className = 'inbox_list_container_box_table';

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 * 
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 * 
	 * var td12 = document.createElement('td');
	 */

	var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
	if (l_subject && l_subject != '') {
		l_subject = l_subject.substring(0, 40);
		if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
			l_subject += '...'
	}

	/*
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 * 
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 */

	var tr2 = document.createElement('tr');
	table.appendChild(tr2);

	var td21 = document.createElement('td');
	tr2.appendChild(td21);
	td21.className = 'inbox_list_container_box_c1_status';
	// Gestisce la selezione dei messaggi quando l'utente si trova nella
	// tipologia "modifica"
	td21.onclick = function(p_event) {
		var l_message_header = $('#inbox_list_container_box_' + p_mid);

		if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
			l_message_header.removeClass('inbox_list_container_box_unselected');
			l_message_header.addClass('inbox_list_container_box_selected');

		} else if (l_message_header
				.hasClass('inbox_list_container_box_selected')) {
			l_message_header.removeClass('inbox_list_container_box_selected');
			l_message_header.addClass('inbox_list_container_box_unselected');
		}

		p_event.stopPropagation();
	};
	td21 = null;

	var td22 = document.createElement('td');
	tr2.appendChild(td22);
	td22.className = 'inbox_list_container_box_c2';
	td22.innerHTML = '<h1>' + l_subject + '</h1><h3>'
			+ _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
	td22 = null;

	var td23 = document.createElement('td');
	tr2.appendChild(td23);
	td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>'
			+ inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
	td23 = null;

	/*
	 * var tr1 = document.createElement('tr'); table.appendChild(tr1);
	 * 
	 * var td11 = document.createElement('td'); tr1.appendChild(td11);
	 * td11.className = 'inbox_list_container_box_c1'; td11 = null;
	 * 
	 * var td12 = document.createElement('td');
	 * 
	 * var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject; if (l_subject &&
	 * l_subject != '') { l_subject = l_subject.substring(0, 40); if
	 * (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length)
	 * l_subject += '...' }
	 * 
	 * tr1.appendChild(td12); td12.className =
	 * 'inbox_list_container_box_c2_title'; td12.innerHTML = '<h1>' +
	 * l_subject + '</h1>'; td12 = null;
	 * 
	 * var td13 = document.createElement('td'); tr1.appendChild(td13);
	 * td13.className = 'inbox_list_container_box_c3'; td13.innerHTML = '<h2>' +
	 * inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>'; td13 =
	 * null;
	 * 
	 * var tr2 = document.createElement('tr'); table.appendChild(tr2);
	 * 
	 * var td21 = document.createElement('td'); tr2.appendChild(td21);
	 * td21.className = 'inbox_list_container_box_c1_status'; // Gestisce la
	 * selezione dei messaggi quando l'utente si trova nella tipologia
	 * "modifica" td21.onclick = function(p_event){ var l_message_header =
	 * $('#inbox_list_container_box_' + p_mid);
	 * 
	 * if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
	 * l_message_header.removeClass('inbox_list_container_box_unselected');
	 * l_message_header.addClass('inbox_list_container_box_selected');
	 *  } else if
	 * (l_message_header.hasClass('inbox_list_container_box_selected')) {
	 * l_message_header.removeClass('inbox_list_container_box_selected');
	 * l_message_header.addClass('inbox_list_container_box_unselected'); }
	 * 
	 * p_event.stopPropagation(); }; td21 = null;
	 * 
	 * var td22 = document.createElement('td'); tr2.appendChild(td22);
	 * td22.className = 'inbox_list_container_box_c2'; td22.innerHTML = '<h3>' +
	 * _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>'; td22 = null;
	 * 
	 * var td23 = document.createElement('td'); tr2.appendChild(td23);
	 * td23.className = 'inbox_list_container_box_c3_goto'; td23 = null;
	 */

	box.onclick = (function(p_mid) {
		return function() {
			// inboxOpenMessage(p_mid);
		}
	})(p_mid);

	box = null;

	if (_INBOX_LIST_ISCROLL == null) {
		_INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
	} else {
		_INBOX_LIST_ISCROLL.refresh();
	}
}

function searchDb() {
	// alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	
	abutils.alert("test serch");

	if (toSearch == '') {
		alert('Inserisci una chiave di ricerca');
		return;
	}

	res = window.searchdb.search(toSearch);
	searchAddMessages(res);
}

function remoteSearch() {
	// alert($('#search_input').val());
	var toSearch = $('#search_input').val();
	// alert('remote!!!' + toSearch);
	// Array res = window.searchdb.search(toSearch);
	// searchAddMessages(res);
}

// var _TIMEOUT_MENU = null;
function mostraTopbar() {
	// document.getElementById('wrapper_topbar').style['-webkit-transform'] =
	// 'translate3d(0px, 0px, 0)';
	/*
	 * if (_TIMEOUT_MENU != null) { clearTimeout(_TIMEOUT_MENU); _TIMEOUT_MENU =
	 * null; } _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
	 */
	$('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar() {
	// document.getElementById('wrapper_topbar').style['-webkit-transform'] =
	// 'translate3d(0px, -50px, 0)';
	$('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent() {
	if (_DB) {
		var querySuccess = function(tx, rs) {
			checkDBalreadyPresent_aux(rs.rows.length > 0);
		}
		var queryError = function(tx, p_error) {
			checkDBalreadyPresent_aux(false);
		}
		var executeQuery = function(tx) {
			tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' WHERE artid=?;', [ _CURRENT_ARTICLE.artid ],
					querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	} else {

		checkDBalreadyPresent_aux(false);
	}
}

function checkDBalreadyPresent_aux(isPresent) {
	document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none'
			: 'inline-block';
	document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block'
			: 'none';
}

function eliminaPreferito() {
	// window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?',
			'eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
	if (_CURRENT_ARTICLE == null)
		return;
	try {
		if (_DB) {
			var querySuccessTag = function(tx) {
				// alert('OK eliminazione tag preferito.');
				document.getElementById('btn_preferiti_off').style.display = 'inline-block';
				document.getElementById('btn_preferiti_on').style.display = 'none';
			}
			var queryErrorTag = function(tx, p_error) {
				// alert('KO eliminazione tag preferito: ' + p_error.message);
			}

			var querySuccess = function(tx) {
				// alert('OK eliminazione preferito.');
				tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME
						+ ' WHERE artid=?;', [ _CURRENT_ARTICLE.artid ],
						querySuccessTag, queryErrorTag);
			}
			var queryError = function(tx, p_error) {
				// alert('KO eliminazione preferito: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				try {
					tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME
							+ ' WHERE artid=?;', [ _CURRENT_ARTICLE.artid ],
							querySuccess, queryError);
				} catch (exc) {
					console.log(exc.message);
				}
			}
			_DB.transaction(executeQuery);
		}
	} catch (exc) {
		console.log(exc.message);
	}
}

function openSavePreferiti() {
	if (_CURRENT_ARTICLE == null)
		return;

	popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti() {
	try {// MOD HTML
		preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata,
				_CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue,
				_CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione,
				_CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione,
				_CURRENT_ARTICLE.pagina, $('<div/>').html(
						_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(
						_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(
						_CURRENT_ARTICLE.sottotitolo).text(),
				_CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $(
						'#modifica_articolo_preferito #id_tags').val());

		document.getElementById('btn_preferiti_off').style.display = 'none';
		document.getElementById('btn_preferiti_on').style.display = 'inline-block';

		popupPreferitiUpdateArticleChiudi();
	} catch (exc) {
		console.log(exc.message);
	}
	// window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit() {
	if (_DB) {
		var querySuccess = function() {
			console.log('OK preferitiDBinit');
		}
		var queryError = function(tx, p_error) {
			console.log('KO preferitiDBinit ' + p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_ARTICLE_DB_NAME + ' ('
					+ _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess,
					queryError);
			tx.executeSql('CREATE TABLE IF NOT EXISTS '
					+ _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS
					+ ')', [], querySuccess, queryError);
		}
		_DB.transaction(executeQuery);
	}
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr,
		edizione, edizione_descr, sezione, pagina, occhiello, titolo,
		sottotitolo, firma, testo, tags) {
	console.log("db is " + _DB);
	try {
		if (_DB) {
			var querySuccess = function(tx) {
				console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
				var tags_arr = tags.split(',');
				for ( var t = 0; t < tags_arr.length; t++) {
					var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); // TRIM
					if (l_tag.length <= 0)
						continue;
					tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME
							+ ' VALUES(?, ?);', [ l_tag, artid ], function() {
						console.log('OK SAVE LOCAL DB TAG');
					}, function(tx, p_error) {
						console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
					});
				}
			}
			var queryError = function(tx, p_error) {
				console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
			}
			var executeQuery = function(tx) {
				tx
						.executeSql(
								'INSERT INTO '
										+ _PREFERITI_ARTICLE_DB_NAME
										+ ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);',
								[ artid, testata, testata_descr, issue,
										issue_descr, edizione, edizione_descr,
										sezione, pagina, occhiello, titolo,
										sottotitolo, firma, testo, tags ],
								querySuccess, queryError);
			}
			_DB.transaction(executeQuery);
		}
	} catch (exc) {
		console.log('error ' + exc.message);
	}
}

/*******************************************************************************
 * Gestione indice visibile in landscape
 ******************************************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson) {
	if (_ISCROLL_SEZIONI != null) {
		_ISCROLL_SEZIONI.destroy();
		_ISCROLL_SEZIONI = null;
	}

	document.getElementById('sezioni_container').innerHTML = '';

	// document.getElementById('sezioni_container').style.width = 160 *
	// sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500
			* sezioniJson.length + 'px';

	for ( var i = 0; i < sezioniJson.length; i++) {

		var box = document.createElement('div');
		box.id = 'box_section_' + sezioniJson[i].section;
		box.className = 'box_sezione';
		document.getElementById('sezioni_container').appendChild(box);

		var inner = document.createElement('div');
		box.appendChild(inner);

		inner.innerHTML = sezioniJson[i].description;

		box.onclick = (function(sid) {
			return function() {
				sezioneSelected(sid);
			}
		})(sezioniJson[i].section);

		inner = null;
		box = null;

	}

	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_'
				+ sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(
					last_stection_box.position().left
							+ last_stection_box.outerWidth(true));
	}

	setTimeout(function() {
		_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
			hScroll : true,
			vScroll : false
		});
		_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
	}, 200);

	return "OK";

}

function sezioneSelected(sid) {
	$('.box_sezione_selected').removeClass('box_sezione_selected');
	// window.location = 'dsh://indice.load/' + sid;
	window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson) {
	try {
		$('#box_section_' + sid).addClass('box_sezione_selected');

		if (_ISCROLL_ARTICOLI != null) {
			_ISCROLL_ARTICOLI.destroy();
			_ISCROLL_ARTICOLI = null;
		}

		document.getElementById('articoli_container').innerHTML = '';

		if (articoliJson.length == 0)
			document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';

		for ( var i = 0; i < articoliJson.length; i++) {

			var box = document.createElement('div');
			box.className = 'box_articolo'
					+ (_CURRENT_ARTICLE != null
							&& articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected'
							: '');
			box.id = 'box_articolo_' + articoliJson[i].id;
			document.getElementById('articoli_container').appendChild(box);

			var titolo = document.createElement('h1');
			box.appendChild(titolo);
			titolo.innerHTML = articoliJson[i].titolo;

			box.onclick = (function(aid) {
				return function() {
					// window.location = 'dsh://indice.open/' + aid;
					console.log("aid is " + aid);
					window.indice.loadArticle(aid);
					closeIndice();
				}
			})(articoliJson[i].id);

			titolo = null;
			box = null;

		}

		setTimeout(function() {
			_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
				hScroll : false,
				vScroll : true
			});
			_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
			// setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);

			if (_ISCROLL_SEZIONI != null) {
				_ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
			}

		}, 300);

		return "OK";
	} catch (exc) {
		return exc.message;
	}
}

/*******************************************************************************
 * Gestione database
 ******************************************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase() {
	console.log("Inizializzazione database");
	try {
		_DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
	} catch (exc) {
		console.log(exc.message);
	}
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;

/*******************************************************************************
 * Gestione popup modifica preferiti
 ******************************************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * 
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article) {

	// $('#modifica_articolo_preferito').fadeIn();
	if (p_article) {

		$('#modifica_articolo_preferito').css('display', 'inline');
		$('#modifica_articolo_preferito_title').html(p_article.titolo);
		$('#modifica_articolo_preferito_text').html(
				'<strong>' + p_article.testata_descr + '</strong> '
						+ p_article.issue_descr + ' - pag. '
						+ parseInt(p_article.pagina));
		$('#modifica_articolo_preferito #id_tags').val(p_article.tags);
		$('#modifica_articolo_preferito #id').val(p_article.artid);

		// Inizializza i tag preferiti
		if (_DB) {

			var querySuccess = function(tx, p_results) {
				var l_tags_help = $('#modifica_articolo_preferito_tags_help');
				// I tag preferiti vengono inseriti come possibili scelte
				l_tags_help.empty();
				for ( var i = 0; i < p_results.rows.length; i++) {
					var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
						l_tags_help
								.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\''
										+ tag.nome
										+ '\', this)" value="'
										+ tag.nome + '" />');
				}
			}

			var queryError = function(p_error) {
				console
						.log("popupPreferitiUpdateArticle: Error processing SQL: "
								+ p_error.message);
			}

			var executeQuery = function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS '
						+ _PREFERITI_TAG_DB_NAME + ' ('
						+ _PREFERITI_TAG_DB_COLUMNS + ')');
				var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM '
						+ _PREFERITI_TAG_DB_NAME
						+ ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,'
						+ _NUM_PREFERITE_TAGS;
				tx.executeSql(l_query, [], querySuccess, queryError);
			}

			_DB.transaction(executeQuery, queryError);
		}
	}
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo
 * preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button) {
	if (button != null)
		button.style['display'] = 'none';
	var l_tags_el = $('#modifica_articolo_preferito #id_tags');
	var l_tags_string = l_tags_el.val();

	if (l_tags_string != '') {
		l_tags_string += ', ' + p_tag;
	} else {
		l_tags_string = p_tag;
	}

	l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti() {
	var l_artid = $('#modifica_articolo_preferito #id').val();
	var l_tags = $('#modifica_articolo_preferito #id_tags').val();
	// Salva le modifiche
	if (_DB) {
		var querySuccess = function(tx, p_results) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: "
							+ p_results.rowsAffected);
		}
		var updateQuerySuccess = function(tx, p_results) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Update article success");
			if (p_results.rowsAffected > 0) {
				document
						.getElementById('preferiti_body_vista_container_box_tags_'
								+ l_artid).innerHTML = 'Tags: ' + l_tags;
			}
		}
		var queryError = function(p_error) {
			console
					.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: "
							+ p_error.message);
		}
		var executeQuery = function(tx) {
			tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME
					+ ' SET tags=? WHERE artid=?', [ l_tags, l_artid ],
					updateQuerySuccess, queryError);

			// Elimina i tag attualmente presenti per quel prodotto
			tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME
					+ ' WHERE artid=? OR artid=""', [ l_artid ], querySuccess,
					queryError);
			var l_tags_array = l_tags.toLowerCase().split(',');
			for ( var i = 0; i < l_tags_array.length; i++) {
				var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); // TRIM
				tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME
						+ ' (nome, artid) VALUES(?,?)', [ l_tag, l_artid ],
						querySuccess, queryError);
			}
		}
		// Caricamento INBOX da locale
		_DB.transaction(executeQuery, queryError);
	}
	popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi() {
	// $('#modifica_articolo_preferito').fadeOut();
	$('#modifica_articolo_preferito').css('display', 'none');
}

function shareFacebook() {
	if (_CURRENT_ARTICLE == null)
		return;

	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;

	var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo
			: 'edicola.ilsole24ore.com';

	window.open
			.openUrl('http://www.facebook.com/sharer.php?u='
					+ encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt='
							+ l_shared_id) + '&t='
					+ encodeURIComponent(l_titolo));
}

function shareTwitter() {
	if (_CURRENT_ARTICLE == null)
		return;

	var l_shared_id = _CURRENT_ARTICLE.shared_id;
	if (l_shared_id == null)
		return;

	var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo
			: 'edicola.ilsole24ore.com';

	window.open
			.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url='
					+ encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt='
							+ l_shared_id)
					+ '&text='
					+ encodeURIComponent(l_titolo));
}

var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
// var _API24_APPKEY = "iPadQuot";//DA CAMBIARE
var _API24_APPKEY = "DroidQuot";
var _APPNAME = 'ITQUOIPAD';// DA CAMBIARE
var _APPVERSION = '1.1';// DA CAMBIARE A 2.0
function loadCorrelates() {
	if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null))
		renderCorrelate(null, null);

	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');

	var req_headers = {
		"appKey" : _API24_APPKEY
	};
	var req_data = {
		"appName" : _APPNAME,
		"appVersion" : _APPVERSION
	};
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id
			+ ".json");
	console.log(req_headers);
	console.log(req_data);
	$.ajax({
		type : "GET",
		cache : false,
		timeout : _AJAX_TIMEOUT,
		contentType : "application/json; charset=utf-8",
		url : _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id
				+ ".json",
		headers : req_headers,
		data : req_data,
		dataType : "json",
		success : function(p_response) {
			if (typeof p_response == "string") {
				p_response = $.parseJSON(p_response);
			}
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
		},
		error : function() {
			renderCorrelate(null, null);
		}
	});
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty')
				.css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}

		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello
		// attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
			_ARTICOLO_ISCROLL.refresh();
		}
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for ( var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content')
				.appendChild(box);

		box.innerHTML = articoli[i].titolo;

		box.onclick = (function(url) {
			return function(event) {
				event.preventDefault();
				event.stopPropagation();
				window.open.openUrl(url);
			}
		})(articoli[i].url);

		box = null;
	}

	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}

}





		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_03', function() { }).endCapture();
		}
	

/**
 * @author ABertacco
 */
try{
var _DEBUG_MODE = !('ontouchstart' in window);
var _CURRENT_ARTICLE = null;
var _DEPLOY_BASE_URL = 'http://mobapp24.ilsole24ore.com/_deploy/';

function doCerca() {
	if ($('#search_input').val() == '') return;
	/*if ($('#searchkeyword_option') == null){
		searchDb();
		return;
	}*/
	if ($('#searchkeyword_option').val() == 'REMOTE')
		remoteSearch();
	else
		searchDb();
}


var _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = null;
var _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = null;

function showRemoteResults(articoliJson) {
	if (_RICERCA_ISCROLL_VISTA != null) {
		_RICERCA_ISCROLL_VISTA.destroy();
		_RICERCA_ISCROLL_VISTA = null;
	}
	
	if((articoliJson == null) || (typeof articoliJson == undefined)){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	//preferitiOpenArticlesList(res);
	 $('#preferiti_body_vista_container').empty();
	
	//alert(JSON.stringify(articoliJson)+","+articoliJson.length);
	
	//articoliJson = JSON.parse( JSON.stringify( articoliJson ) );
	
	//alert('aaa' + articoliJson.length);
	
	document.getElementById('search_list_container').innerHTML = '';
	
	if (articoliJson.length == 0)
		document.getElementById('search_list_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo trovato.</div>';
	
	for (var i = 0; i < articoliJson.length; i++) {
		
		var box = document.createElement('div');
		box.className = 'box_articolo_remote';
		document.getElementById('search_list_container').appendChild(box);
		box.id = 'box_articolo_' + i;
		
		var titolo = document.createElement('h1');
		box.appendChild(titolo);
		titolo.innerHTML = articoliJson[i].titolo;
		
		var snippet = document.createElement('h2');
		box.appendChild(snippet);
		snippet.innerHTML = articoliJson[i].sommario;
		
		var pagina = document.createElement('h3');
		box.appendChild(pagina);
		pagina.innerHTML = '<strong>' + articoliJson[i].edizione_descr + '</strong> del ' + articoliJson[i].issue_descr + ' (pag. ' + articoliJson[i].pagina + ')';
		
		box.onclick = (function(articoloJson, domid) {
			return function(){
				this.className = 'box_articolo box_articolo_active';
				var that = this;
				setTimeout(function() {
					that.className = 'box_articolo_remote';
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA = articoloJson.testata;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE = articoloJson.issue;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE = articoloJson.edizione;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES = articoloJson.itunes;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID = articoloJson.productid;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING = articoloJson.accounting;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_URL = articoloJson.url;
					_FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA = articoloJson.pagina;
					
					//window.location = 'dsh://remotecerca.goto';
					//alert(articoloJson.testata + ',' + articoloJson.issue + ',' + articoloJson.edizione + ',' + articoloJson.itunes);
					
					//window.searchdb.display(articoloJson.idart);
					
					//checkaquisto
					//var para = new Array();//[articoloJson.testata,articoloJson.issue,articoloJson.edizione,articoloJson.pagina];
					/*para[0] =  articoloJson.testata ;
					para[1] =   articoloJson.issue;
					para[2] =  articoloJson.edizione ;
					para[3]=  articoloJson.pagina ;
					*/
					var para = articoloJson.testata + "|" + articoloJson.issue + "|" +  articoloJson.edizione + "|" + articoloJson.pagina;
					//alert( "asdce "+JSON.stringify(para));
					window.searchdb.check(articoloJson.productid,  articoloJson.issue, articoloJson.edizione,articoloJson.accounting, articoloJson.itunes, "sfoglia", para);
					//checkAcquisto(articoloJson.productid,  articoloJson.issue, articoloJson.accounting, articoloJson.itunes, function() { sfoglia(articoloJson.testata, articoloJson.issue, articoloJson.edizione, articoloJson.pagina); });
					//poi apro pagina
				}, 250);
			}
		})(articoliJson[i], 'box_articolo_' + i);
		
		pagina = null;
		snippet = null;
		titolo = null;
		box = null;
		
	}
	
	setTimeout(function() {
		
		
		
		_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');// = new iScroll('search_list_wrapper', { hScroll: false, vScroll: true });
		_RICERCA_ISCROLL_VISTA.scrollTo(0,0,0);
		
		
	    $('#search_list_container').css("background-color","white");
	    //$('#search_list_container').css("height","100%")
	    $('#search_list_wrapper').css("position","relative");
	    //$('#search_list_wrapper').css("height","100%")
	    //$('#search_list_wrapper').css("height","460px");
	    $('#search_list_wrapper').css("overflow","hidden");
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html(articoliJson.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white"){
	    	$('#search_list_wrapper').css("background-color","white");
	    }
	    
	    _RICERCA_ISCROLL_VISTA.refresh();

		
	}, 200);
	

}

function getRemoteArticleSelected() {
	var ret;
	try {
		ret = JSON.stringify({
			'testata': _FLIPPER24_REMOTE_ARTICLE_SELECTED_TESTATA, 
			'issue': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ISSUE, 
			'edizione': _FLIPPER24_REMOTE_ARTICLE_SELECTED_EDIZIONE, 
			'itunes': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ITUNES,
			'productid': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PRODUCTID,
			'accounting': _FLIPPER24_REMOTE_ARTICLE_SELECTED_ACCOUNTING,
			'url': _FLIPPER24_REMOTE_ARTICLE_SELECTED_URL,
			'pagina': _FLIPPER24_REMOTE_ARTICLE_SELECTED_PAGINA
		});
	} catch (exc) {
		ret = '{}';
	}
	return ret;
}



var ROTATION_CLASSES = {

        "0": "none",

         "90": "right",

         "-90": "left",

         "180": "flipped"

      };


    function monitorOrientationChanges() {
    	console.log('monitorOrientationChanges!!!');

      var canDetect = "onorientationchange" in window;

      var orientationTimer = 0;

     

      $(window).bind(canDetect ? "orientationchange" : "resize", function(evt) {

         clearTimeout(orientationTimer);

         orientationTimer = setTimeout(function() {

             // given we can only really rely on width and height at this stage,

             // calculate the orientation based on aspect ratio

             var aspectRatio = 1;

             if (window.innerHeight !== 0) {

                 aspectRatio = window.innerWidth / window.innerHeight;

             } // if



             // determine the orientation based on aspect ratio

             var orientation = aspectRatio <= 1 ? "portrait" : "landscape";



             // if the event type is an orientation change event, we can rely on

             // the orientation angle

             var rotationText = null;

             if (evt.type == "orientationchange") {

                 rotationText = ROTATION_CLASSES[window.orientation.toString()];
                 console.log('rotationText is '+rotationText);

             } // if

             $(window).trigger("reorient", [orientation, rotationText]);

         }, 500);

      });       

  } // monitorOrientationChanges

var CURRENT_ORIENTATION = '';

function onBodyLoad(){
	
	//window.searchdb.remoteSearch('abc');
	//window.searchdb.search3('abc');
    if (_DB == null) {
        inizializzaDatabase();
        preferitiDBinit();
    }
    
	if (_DEBUG_MODE) {
		_CURRENT_ARTICLE = {}
		_CURRENT_ARTICLE.shared_id = "2769977";
		loadArticolo({artid:'1317851504', shared_id:'2844111', testata:'S24', edizione:'SOLE', issue:'20111129', testata_descr:'Il Sole 24 ORE', edizione_descr:'Il Sole 24 Ore', issue_descr:'29 Novembre 2011', pagina:1, sezione:'PRIMA', sezione_descr:'6126', occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], firme: [], testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"], photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], grafici: [], sommari: []}, [], [], [{"items":[{"url":"http://mrdoob.com/projects/chromeexperiments/ball_pool/","descrizione":"Ball Pool"}],"id":"145","package":"1317851504","descrizione":"HTML5 - Ball Pool","preview":"","tipo":"LINK"}]);
		loadCorrelates();
		loadSezioni([
{"section":"4898","description":"PRIMA"},
{"section":"4899","description":"PRIMO PIANO"},
{"section":"4901","description":"COMMENTI E INCHIESTE"},
{"section":"4902","description":"POLITICA E SOCIETA'"},
{"section":"4903","description":"MONDO"},
{"section":"4904","description":"ECONOMIA E IMPRESE"},
{"section":"4905","description":"NORME E TRIBUTI"},
{"section":"4906","description":"LETTERA AL RISPARMIATORE"},
{"section":"4907","description":"FINANZA E MERCATI"},
{"section":"4908","description":"PRIMA PAGINA DOMENICA"},
{"section":"4909","description":"LUOGHI E PERSONE"},
{"section":"4910","description":"TERZA PAGINA"},
{"section":"4911","description":"RACCONTI"},
{"section":"4912","description":"EDITORIA"},
{"section":"4913","description":"LETTURE"},
{"section":"4914","description":"SCIENZA E FILOSOFIA"},
{"section":"4916","description":"GEORGES DE LA TOUR. DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4917","description":"GEORGES DE LA TOUR DUE CAPOLAVORI A MILANO A PALAZZO MARINO"},
{"section":"4918","description":"FOTOGRAFIA"},
{"section":"4919","description":"ARTE"},
{"section":"4920","description":"ECONOMIA E SOCIETA'"},
{"section":"4922","description":"MUSICA"},
{"section":"4923","description":"IN SCENA"},
{"section":"4924","description":"TEMPO LIBERATO"},
{"section":"4925","description":"PRIMA PAGINA NOVA24"},
{"section":"4926","description":"IDEE"},
{"section":"4927","description":"IMPRESE"},
{"section":"4928","description":"PRODOTTI"}]);

  loadListaArticoliSezione('4899', [
  {"pagina":"0","titolo":"Correzione prima dell'Eurogruppo","id":"1317802942"},
  {"pagina":"0","titolo":"Braccio di ferro\nsu viceministri\ne sottosegretari","id":"1317802946"},
  {"pagina":"0","titolo":"«Patrimoniale per chi ha di più»","id":"1317802948"},
  {"pagina":"0","titolo":"I nodi della manovra sul tavolo Monti","id":"1317802950"},
  {"pagina":"0","titolo":"Sull'acqua piani per 30 miliardi","id":"1317802955"},
  {"pagina":"0","titolo":"Sud, per la banda larga 1,3 miliardi","id":"1317802966"},
  {"pagina":"0","titolo":"Infrastrutture, in arrivo\npiù incentivi per i privati","id":"1317802972"},
  {"pagina":"0","titolo":"Prevalga la coesione","id":"1317802973"},
  {"pagina":"0","titolo":"Fini: via i vitalizi degli ex deputati","id":"1317802976"},
  {"pagina":"0","titolo":"Primo taglio: 600 giudici di pace","id":"1317802982"},
  {"pagina":"0","titolo":"Nuova mappa\ndei tribunali, \nfattore chiave\nper la crescita","id":"1317802985"},
  {"pagina":"0","titolo":"Casa, più entrate fino a 28 miliardi","id":"1317802993"},
  {"pagina":"0","titolo":"L'urgenza della qualità","id":"1317802995"},
  {"pagina":"0","titolo":"Guida per evitare le liti in condominio","id":"1317802996"},
  {"pagina":"0","titolo":"Finmeccanica stretta tra crisi, \nindagini e le tensioni al vertice","id":"1317803003"},
  {"pagina":"0","titolo":"CROLLO IN BORSA","id":"1317803004"},
  {"pagina":"0","titolo":"Enav, arrestato l'ad Pugliesi","id":"1317803007"},
  {"pagina":"0","titolo":"Le Borse guardano al debito Usa","id":"1317803013"},
  {"pagina":"0","titolo":"Bruxelles\nvara un budget\ndi austerità","id":"1317803017"},
  {"pagina":"0","titolo":"Sfida fra BtP\ne bond bancari\nper attirare\ni risparmiatori","id":"1317803022"},
  {"pagina":"0","titolo":"Sugli eurobond\ntre ipotesi\nda Bruxelles","id":"1317803023"},
  {"pagina":"0","titolo":"I grandi movimenti dei capitali:\nsi prosciugano i commerci,\nfuga degli investitori dall'Europa","id":"1317803024"},
  {"pagina":"0","titolo":"Torna il protezionismo:\nfondi e banche centrali\nin ritirata dall'Europa","id":"1317803026"},
  {"pagina":"0","titolo":"Rischio contagio","id":"1317803032"},
  {"pagina":"0","titolo":"Solo l'Asia resiste\nalla frenata\ndegli scambi","id":"1317803033"},
  {"pagina":"0","titolo":"La liquidità\nche scappa\nsceglie la via\ndi Wall Street","id":"1317803034"},
  {"pagina":"0","titolo":"INVESTIRE NEL «LUNGO»\nPUNTANDO ALLA CEDOLA","id":"1317803050"},
  {"pagina":"0","titolo":"Il «tranello»\ndel dividend yield","id":"1317803051"},
  {"pagina":"0","titolo":"L'impatto \ndell'euro","id":"1317803052"},
  {"pagina":"0","titolo":"Cosa sono lo spread e i buoni del tesoro?","id":"1317803061"},
  {"pagina":"0","titolo":"Così le sementi\ndell'Etiopia\nsalvano l'orzo\ndella California","id":"1317803066"},
  {"pagina":"0","titolo":"Se il bene è senza prezzo»\nservono tasse e divieti","id":"1317803068"}]);
    }
	
	monitorOrientationChanges();
	
	   $(window).bind("reorient", function(evt, orientation, rotation) {

	               // display the details we have determine from the display

	               //$("#orientation").html(orientation);

	               //$("#rotation-class").html(rotation);

	               if(CURRENT_ORIENTATION != orientation){

	                   CURRENT_ORIENTATION = orientation;
	                   
	                   if(orientation == 'landscape')
	                		_ORIENTATION = 'H';
	                   else
	                	   _ORIENTATION = 'V';
	                   
	                   console.log("bind _ORIENTATION is " + _ORIENTATION);
	                   
	                   updateOrientation();

	               }

	           });
	   
	 	$('#search_result_bar').css("display","none");
	//$('#wrapper_articolo').css("background-color","black");
	 	$("#search_input").keydown( function(event) {
            if (event.keyCode == 13) {
            	doCerca();
            }
    });

}



var _ORIENTATION = '';
function initOrientation(){
	console.log('********init_Orientation********');
	if(screen.width > 790){
	    if ($(window).width() > 900) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    }else{
	    if ($(window).width() > 500) 
	        _ORIENTATION = 'H';
	    else 
	        _ORIENTATION = 'V';
    	
    }
    //updateOrientation();
}

var _INDICE_OPEN = false;
function wrapperArticoloClick(){
    if (_INDICE_OPEN) {
        closeIndice();
    }
    else {
        //mostraTopbar();
        handleTopbar();
    }
}

function openIndice(){
    _INDICE_OPEN = true;
    //$('#wrapper_indice').addClass('wrapper_indice_attivo');
    nascondiTopbar();
}

function closeIndice(){
    console.log('a');
    _INDICE_OPEN = false;
    //$('#wrapper_indice').removeClass('wrapper_indice_attivo');
}

function loadArticoloFromDB(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.id != "undefined" ? articolo.id : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione_descr != "undefined" ? articolo.sezione_descr : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        return renderArticolo();
    } 
    catch (exc) {
        return exc.message;
    }
}

function loadArticolo(articolo, arrPhotos, arrVideos, arrLink){
    try {
        _CURRENT_ARTICLE = {};
        
        _CURRENT_ARTICLE.artid = typeof articolo.artid != "undefined" ? articolo.artid : 'x_' + new Date().getTime();
        _CURRENT_ARTICLE.shared_id = typeof articolo.shared_id != "undefined" ? articolo.shared_id : null;
        _CURRENT_ARTICLE.testata = typeof articolo.testata != "undefined" ? articolo.testata : '';
        _CURRENT_ARTICLE.testata_descr = typeof articolo.testata_descr != "undefined" ? articolo.testata_descr : '';
        _CURRENT_ARTICLE.issue = typeof articolo.issue != "undefined" ? articolo.issue : '';
        _CURRENT_ARTICLE.issue_descr = typeof articolo.issue_descr != "undefined" ? articolo.issue_descr : '';
        _CURRENT_ARTICLE.edizione = typeof articolo.edizione != "undefined" ? articolo.edizione : '';
        _CURRENT_ARTICLE.edizione_descr = typeof articolo.edizione_descr != "undefined" ? articolo.edizione_descr : '';
        _CURRENT_ARTICLE.sezione = typeof articolo.sezione != "undefined" ? articolo.sezione : '';
        _CURRENT_ARTICLE.pagina = typeof articolo.pagina != "undefined" ? articolo.pagina : 1;
        _CURRENT_ARTICLE.titolo = (typeof articolo.titolo != "undefined" && articolo.titolo != null && articolo.titolo.length > 0) ? articolo.titolo.join('<br />') : '';
        _CURRENT_ARTICLE.sottotitolo = (typeof articolo.sottotitolo != "undefined" && articolo.sottotitolo != null && articolo.sottotitolo.length > 0) ? articolo.sottotitolo.join('<br />') : '';
        _CURRENT_ARTICLE.occhiello = (typeof articolo.occhiello != "undefined" && articolo.occhiello != null && articolo.occhiello.length > 0) ? articolo.occhiello.join('<br />') : '';
        _CURRENT_ARTICLE.firma = (typeof articolo.firma != "undefined" && articolo.firma != null && articolo.firma.length > 0) ? articolo.firma.join('<br />') : '';
        _CURRENT_ARTICLE.testo = (typeof articolo.testo != "undefined" && articolo.testo != null && articolo.testo.length > 0) ? articolo.testo.join('<br />') : '';
        _CURRENT_ARTICLE.tags = ""; // usato per agganciare in automatico gli stessi metodi del modifica tags
        _CURRENT_ARTICLE.photos = (typeof articolo.photos == "undefined" || articolo.photos == null || articolo.photos.length == 0) ? [] : articolo.photos;
        _CURRENT_ARTICLE.grafici = (typeof articolo.grafici == "undefined" || articolo.grafici == null || articolo.grafici.length == 0) ? [] : articolo.grafici;
        _CURRENT_ARTICLE.sommari = (typeof articolo.sommari == "undefined" || articolo.sommari == null || articolo.sommari.length == 0) ? [] : articolo.sommari;
        _CURRENT_ARTICLE.arr_photos = (typeof arrPhotos == "undefined" || arrPhotos == null || arrPhotos.length == 0) ? [] : arrPhotos;
        _CURRENT_ARTICLE.arr_videos = (typeof arrVideos == "undefined" || arrVideos == null || arrVideos.length == 0) ? [] : arrVideos;
		_CURRENT_ARTICLE.arr_link = (typeof arrLink == "undefined" || arrLink == null || arrLink.length == 0) ? [] : arrLink;
        
        if (!_DEBUG_MODE) {
            setTimeout(function(){
               // window.location = 'dsh://loading.done';
                
				//$('#container_adv').writeCapture().load('http://212.45.97.204/adv_proxy.php?z=ART_TOP&t=' + _CURRENT_ARTICLE.testata + '&d=' + new Date().getTime(), function(){}).endCapture();
				
				/*
                $('#container_adv').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + new Date().getTime() + '@Ticker_04', function(){
                }).endCapture();
				*/
					   
					   setTimeout(function() {
								  nascondiTopbar();
								  }, 2000);
				
            }, 200);
        }
    } 
    catch (exc) {
        return exc.message;
    }
    return renderArticolo();
}

var _MMEDIA_ISCROLL = null;
var _ARTICOLO_ISCROLL = null;
function renderArticolo(){
    try {
    
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.destroy();
            _ARTICOLO_ISCROLL = null;
        }
        if (_MMEDIA_ISCROLL != null) {
            _MMEDIA_ISCROLL.destroy();
            _MMEDIA_ISCROLL = null;
        }
        
        checkDBalreadyPresent();
        
        $('.box_articolo_selected').removeClass('box_articolo_selected');
        if (document.getElementById('box_articolo_' + _CURRENT_ARTICLE.artid) != null) {
            $('#box_articolo_' + _CURRENT_ARTICLE.artid).addClass('box_articolo_selected');
        }
        
        $('#articolo_header_sezione').html(_CURRENT_ARTICLE.sezione);
        $('#articolo_header_edizione').html(_CURRENT_ARTICLE.edizione_descr);
        $('#articolo_header_issue').html(_CURRENT_ARTICLE.issue_descr);
        
        if (_CURRENT_ARTICLE.titolo.length > 0) {
            $('#articolo_titolazione_titolo').html(_CURRENT_ARTICLE.titolo);
            document.getElementById('articolo_titolazione_titolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_titolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.sottotitolo.length > 0) {
            $('#articolo_titolazione_sottotitolo').html(_CURRENT_ARTICLE.sottotitolo);
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_sottotitolo').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.occhiello.length > 0) {
            $('#articolo_titolazione_occhiello').html(_CURRENT_ARTICLE.occhiello);
            document.getElementById('articolo_titolazione_occhiello').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_occhiello').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.firma.length > 0) {
            $('#articolo_titolazione_firma').html(_CURRENT_ARTICLE.firma);
            document.getElementById('articolo_titolazione_firma').style.display = 'block';
        }
        else {
            document.getElementById('articolo_titolazione_firma').style.display = 'none';
        }
        
        if (_CURRENT_ARTICLE.testo.length > 0) {
            $('#articolo_body_text').html(_CURRENT_ARTICLE.testo);
        }
        else {
            $('#articolo_body_text').html('&nbsp;');
        }
        
        if (_CURRENT_ARTICLE.sommari.length == 0) {
            document.getElementById('articolo_body_media_sommari').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_sommari').style.display = 'block';
            document.getElementById('articolo_body_media_sommari').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.sommari.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_sommario';
                document.getElementById('articolo_body_media_sommari').appendChild(box);
                
                var con = document.createElement('div');
                con.className = 'articolo_body_media_sommario_container';
                box.appendChild(con);
                
                var l_titolo = _CURRENT_ARTICLE.sommari[i][0];
                var l_testo = _CURRENT_ARTICLE.sommari[i][1];
                
                con.innerHTML = (((l_titolo != null) && (l_titolo.length > 3)) ? ('<h1>' + l_titolo + '</h1>') : '') + l_testo;
                
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.photos.length == 0) {
            document.getElementById('articolo_body_media_photos').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_photos').style.display = 'block';
            document.getElementById('articolo_body_media_photos').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.photos.length; i++) {
                var box = document.createElement('div');
                box.className = "articolo_body_media_photo";
                document.getElementById('articolo_body_media_photos').appendChild(box);
                
                var con = document.createElement('div');
                con.className = "articolo_body_media_photo_container";
                box.appendChild(con);
                
                var crop = document.createElement('div');
                crop.className = "articolo_body_media_photo_container_crop";
                con.appendChild(crop);
                
                var cropbox = document.createElement('div');
                cropbox.className = 'articolo_body_media_photo_container_crop_box';
                crop.appendChild(cropbox);
                
                var img = document.createElement('img');
                cropbox.appendChild(img);
                img.src = _DEPLOY_BASE_URL + _CURRENT_ARTICLE.photos[i][0] + '.thumb.jpg';
                
                if (_CURRENT_ARTICLE.photos[i][1] != null && _CURRENT_ARTICLE.photos[i][1].length > 0) {
                    var dida = document.createElement('div');
                    con.appendChild(dida);
                    dida.innerHTML = _CURRENT_ARTICLE.photos[i][1];
                    dida = null;
                }
                
                var open = document.createElement('img');
                open.className = 'articolo_body_media_photo_container_open';
                crop.appendChild(open);
                open.src = 'imgs/articolo_body_media_photo_container_open.png';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.photos[i][0]);
                
                
                open = null;
                img = null;
                cropbox = null;
                crop = null;
                con = null;
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.grafici.length == 0) {
            document.getElementById('articolo_body_media_grafici').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_grafici').style.display = 'block';
            document.getElementById('articolo_body_media_grafici_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.grafici.length; i++) {
                var box = document.createElement('div');
                document.getElementById('articolo_body_media_grafici_content').appendChild(box);
                box.className = 'articolo_body_media_arricchimento_item';
                box.innerHTML = _CURRENT_ARTICLE.grafici[i][1].length > 0 ? _CURRENT_ARTICLE.grafici[i][1] : 'Grafico';
                
                box.onclick = (function(url){
                    return function(){
                        //window.location = 'dsh://photo.open' + url + '.jpg';
                    	console.log("url is "+url + '.jpg');
                    	window.opengallery.open(_DEPLOY_BASE_URL + url + '.jpg');
                    }
                })(_CURRENT_ARTICLE.grafici[i][0]);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_photos.length == 0) {
            document.getElementById('articolo_body_media_gallery').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_gallery').style.display = 'block';
            document.getElementById('articolo_body_media_gallery_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_photos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_gallery_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_photos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_photos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_photos[i]['descrizione'] : 'Gallery';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://gallery.open/' + id;
                        console.log("urlid is"+id);
                        window.opengallery.open(id);

                    }
                })(_CURRENT_ARTICLE.arr_photos[i]['id']);
                
                box = null;
            }
        }
        
        if (_CURRENT_ARTICLE.arr_videos.length == 0) {
            document.getElementById('articolo_body_media_video').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_video').style.display = 'block';
            document.getElementById('articolo_body_media_video_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_videos.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_video_content').appendChild(box);
                box.innerHTML = _CURRENT_ARTICLE.arr_videos[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_videos[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_videos[i]['descrizione'] : 'Video';
                
                box.onclick = (function(id){
                    return function(event){
                        event.preventDefault();
                        event.stopPropagation();
                        //window.location = 'dsh://video.open/' + id;
                        window.openvideo.open(id);
                    }
                })(_CURRENT_ARTICLE.arr_videos[i]['id']);
                
                box = null;
            }
        }
		
		
		if (_CURRENT_ARTICLE.arr_link.length == 0) {
            document.getElementById('articolo_body_media_link').style.display = 'none';
        }
        else {
            document.getElementById('articolo_body_media_link').style.display = 'block';
            document.getElementById('articolo_body_media_link_content').innerHTML = '';
            for (var i = 0; i < _CURRENT_ARTICLE.arr_link.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_body_media_arricchimento_item';
                document.getElementById('articolo_body_media_link_content').appendChild(box);
                
				box.innerHTML = _CURRENT_ARTICLE.arr_link[i]['descrizione'] != null && _CURRENT_ARTICLE.arr_link[i]['descrizione'].length > 0 ? _CURRENT_ARTICLE.arr_link[i]['descrizione'] : 'Link';

                if (_CURRENT_ARTICLE.arr_link[i]['items'].length > 0) {
					box.onclick = (function(url){
						return function(event){
							event.preventDefault();
							event.stopPropagation();
							//window.location = url;
							window.open.openUrl(url);
							//window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));

						}
					})(_CURRENT_ARTICLE.arr_link[i]['items'][0]['url']);
				}

                box = null;
            }
        }
        
        var fullArr = _CURRENT_ARTICLE.arr_photos.concat(_CURRENT_ARTICLE.arr_videos);
        if (fullArr.length == 0) {
            document.getElementById('articolo_mainmedia').style.display = 'none';
        }
        else {
            document.getElementById('articolo_mainmedia').style.display = 'block';
            document.getElementById('articolo_mainmedia_container').innerHTML = '';
            document.getElementById('articolo_mainmedia_progress').innerHTML = '';
			document.getElementById('articolo_mainmedia_progress').style.display = fullArr.length < 2 ? 'none' : '';
            $('#articolo_mainmedia_container').width($('#articolo_mainmedia_wrapper').width() * fullArr.length);
            for (var i = 0; i < fullArr.length; i++) {
                var box = document.createElement('div');
                box.className = 'articolo_mainmedia_container_box';
                document.getElementById('articolo_mainmedia_container').appendChild(box);
                
                var container = document.createElement('div');
                container.className = 'articolo_mainmedia_container_box_container';
                box.appendChild(container);
                
                var img = document.createElement('img');
                img.className = 'articolo_mainmedia_container_box_img';
                container.appendChild(img);
                img.src = fullArr[i]['preview'];
                
                var desc
                
                var icon = document.createElement('img');
                icon.className = 'articolo_mainmedia_container_icon';
                box.appendChild(icon);
                icon.src = 'imgs/ps' + fullArr[i]['tipo'] + '.png';
                
                if (fullArr[i]['tipo'] == "VIDEO") {
                    box.onclick = (function(id){
                        return function(event){
                            event.preventDefault();
                            event.stopPropagation();
                            //window.location = 'dsh://video.open/' + id;
                            window.openvideo.open(id);
                        }
                    })(fullArr[i]['id']);
                }
                else 
                    if (fullArr[i]['tipo'] == "PHOTOS") {
                        box.onclick = (function(id){
                            return function(event){
                                event.preventDefault();
                                event.stopPropagation();
                                //window.location = 'dsh://gallery.open/' + id;
                                console.log("urlid is"+id);
                                window.opengallery.open(id);

                            }
                        })(fullArr[i]['id']);
                    }
                
                icon = null;
                img = null;
                container = null;
                box = null;
                
                var progress = document.createElement('div');
                progress.className = 'articolo_mainmedia_progress_box' + (i == 0 ? ' articolo_mainmedia_progress_box_active' : '');
                document.getElementById('articolo_mainmedia_progress').appendChild(progress);
                progress = null;
            }
            
            _MMEDIA_ISCROLL = new iScroll('articolo_mainmedia_wrapper', {
                snap: true,
                momentum: false,
                hScrollbar: false,
                vScroll: false,
                onScrollEnd: function(){
                    document.querySelector('.articolo_mainmedia_progress_box_active').className = 'articolo_mainmedia_progress_box';
                    document.querySelector('#articolo_mainmedia_progress > div:nth-child(' + (this.currPageX + 1) + ')').className = 'articolo_mainmedia_progress_box articolo_mainmedia_progress_box_active';
                }
            });
        }
        
        _ARTICOLO_ISCROLL = null;//new iScroll('wrapper_articolo', {});
        
		
		loadCorrelates();
		
		//window.location = 'dsh://stats.articolo/' + _CURRENT_ARTICLE.artid;
		$("#splashArticolo").css("display","none");
    } 
    catch (exc) {
    	console.log("error: "+exc.message+":::"+exc.what+":"+exc.stack);
        return exc.message;
    }
    
    return "OK #" + _CURRENT_ARTICLE.shared_id + "#";
}

var _RICERCA_ISCROLL_VISTA  = null;
function updateOrientation(){
	
	console.log('an updateOrientation');
    setTimeout(function(){
        closeIndice();
        
        if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.scrollTo(0, 0, 0);
            _ARTICOLO_ISCROLL.refresh();
        }
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 0);
            _ISCROLL_ARTICOLI.refresh();
        }
        
        if(_RICERCA_ISCROLL_VISTA  != null){
        	console.log('_RICERCA_ISCROLL_VISTA  updated');
        	//$('#search_list_wrapper').css("height","100px");
        	_RICERCA_ISCROLL_VISTA .scrollTo(0,0,0);
        	_RICERCA_ISCROLL_VISTA .refresh();
        }
        
        var screenHeight = screen.height;
			if (screenHeight > 0) {
      		$('#search_box').height(screenHeight - 47);
      		$('#search_list_wrapper').height($('#search_box').height() - 90);
			}
			
    }, 200);
}

function handleTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, ''px, 0)';
    $('#wrapper_topbar').toggleClass('wrapper_topbar_open');
}

/**
 * Crea gli elementi per un singolo articolo
 * @params p_article Oggetto articolo così come definito nel database locale
 */
function renderPreferitiArticle(p_article){
    var box = document.createElement('div');
    document.getElementById('search_list_container').appendChild(box);
    box.className = 'preferiti_body_vista_container_box preferiti_body_vista_container_box_status_unselected';
    box.id = 'preferiti_body_vista_container_box_' + p_article.artid;
    box.onclick = function(){
    
        if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        	console.log("DDD_searchDb_4_click1");
            popupPreferitiUpdateArticle(p_article);
        }
        else {
        	console.log("DDD_searchDb_4_click2");
            //preferitiDettaglio(p_article);
        	console.log('CLICK ON BOX id '+p_article.pagina);
        	//alert('pag ' + p_article.pagina + "," + JSON.stringify(p_article) );
        	//alert(JSON.stringify(p_article));
        	window.searchdb.display(p_article.artid);
        }
    };
    
	var boxtb = document.createElement('table');
	box.appendChild(boxtb);
	
	var boxtr = document.createElement('tr');
	boxtb.appendChild(boxtr);
	
	var boxtd1 = document.createElement('td');
	boxtr.appendChild(boxtd1);
	
	var boxtd2 = document.createElement('td');
	boxtr.appendChild(boxtd2);
	
    var status_box = document.createElement('div');
    boxtd1.appendChild(status_box);
    status_box.className = 'preferiti_body_vista_container_box_status';
    // Gestisce la selezione dei preferiti quando l'utente si trova nella tipologia "modifica"
    status_box.onclick = function(p_event){
        var l_message_header = $(document.getElementById('preferiti_body_vista_container_box_' + p_article.artid));
        
        if (l_message_header.hasClass('preferiti_body_vista_container_box_status_unselected')) {
            l_message_header.removeClass('preferiti_body_vista_container_box_status_unselected');
            l_message_header.addClass('preferiti_body_vista_container_box_status_selected');
            
        }
        else 
            if (l_message_header.hasClass('preferiti_body_vista_container_box_status_selected')) {
                l_message_header.removeClass('preferiti_body_vista_container_box_status_selected');
                l_message_header.addClass('preferiti_body_vista_container_box_status_unselected');
            }
        
        p_event.stopPropagation();
    };
    
    if ($('#preferiti_body_vista_container').hasClass('preferiti_modify_view')) {
        status_box.style.display = 'block';
    }
    status_box = null;
    
    var title = document.createElement('div');
    boxtd2.appendChild(title);
    title.className = 'preferiti_body_vista_container_box_title';
    title.innerHTML = p_article.titolo;
    console.log("titolo '"+p_article.titolo+"' added");
    //title.appendChild(document.createTextNode(p_article.titolo));
    //$("<div>").html(title.child());
    title = null;

    var stralcio = document.createElement('div');
    boxtd2.appendChild(stralcio);
    stralcio.className = 'preferiti_body_vista_container_box_descr';
    stralcio.innerHTML = p_article.stralcio;
    console.log("stralcio "+p_article.stralcio);
    stralcio = null;
    
    var descr = document.createElement('div');
    boxtd2.appendChild(descr);
    descr.className = 'preferiti_body_vista_container_box_descr';
    descr.innerHTML = '<strong>' + p_article.edizione_descr + '</strong> ' + p_article.issue_descr + '<strong>' + p_article.sezione + '</strong> ' + ' - pag. ' + parseInt(p_article.pagina);
    descr = null;
    /*
    var tags = document.createElement('div');
    boxtd2.appendChild(tags);
    tags.className = 'preferiti_body_vista_container_box_tags';
    //tags.appendChild(document.createTextNode('Tags: <span>' + p_article.tags + '</span>'));
	tags.innerHTML = 'Tags: <span id="preferiti_body_vista_container_box_tags_span_' + p_article.artid + '">' + p_article.tags + '</span>';
    tags.id = 'preferiti_body_vista_container_box_tags_' + p_article.artid;
    tags = null;
	*/
    
	boxtd2 = null;
	boxtd1 = null;
	boxtr = null;
	boxtb = null;
	box = null;
}


/**
 * Crea le intestazioni della lista dei messaggi passati per parametro
 * @params p_messages_list Lista dei messaggi
 */
function searchAddMessages(p_messages_list){

    for (var i = 0; i < p_messages_list.length; i++) {
    
    	searchAddMessage(p_messages_list.item(i));
        
    }
    
    /*
	console.log('Messaggi presenti in locale:');
    console.log(_INBOX_MESSAGES);
    */
}

function searchAddMessage(p_message){
    _INBOX_MESSAGES['mid_' + p_message.id] = {
        id: p_message.id,
        subject: p_message.subject,
        mabstract: p_message.mabstract,
        date: p_message.date,
        body: p_message.body,
        status: p_message.status
    };
    
    inboxRenderHeader(p_message.id);
	
	//inboxUpdateUnreadMessage();
}
/**
 * Aggiunge l'intestazione di un messaggio
 * @params p_mid Indentificatore del messaggio all'interno di _INBOX_MESSAGES
 */
function searchRenderHeader(p_mid){
    var box = document.createElement('div');
    
    var l_container = document.getElementById('inbox_list_container');
    l_container.insertBefore(box, l_container.childNodes[0]);
    
    if (_INBOX_MESSAGES['mid_' + p_mid].status == 0) {
        box.className = 'inbox_list_container_box inbox_list_container_box_read';
    }
    else {
        box.className = 'inbox_list_container_box inbox_list_container_box_unread';
    }
    
    box.id = 'inbox_list_container_box_' + p_mid;
    
    var table = document.createElement('table');
    box.appendChild(table);
    table.className = 'inbox_list_container_box_table';
    
	
	/*
	var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    */
	
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    /*
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    */
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h1>' + l_subject + '</h1><h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
	td23.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td23 = null;
	
	/*
    var tr1 = document.createElement('tr');
    table.appendChild(tr1);
    
    var td11 = document.createElement('td');
    tr1.appendChild(td11);
    td11.className = 'inbox_list_container_box_c1';
    td11 = null;
    
    var td12 = document.createElement('td');
    
    var l_subject = _INBOX_MESSAGES['mid_' + p_mid].subject;
    if (l_subject && l_subject != '') {
        l_subject = l_subject.substring(0, 40);
        if (l_subject.length < _INBOX_MESSAGES['mid_' + p_mid].subject.length) 
            l_subject += '...'
    }
    
    tr1.appendChild(td12);
    td12.className = 'inbox_list_container_box_c2_title';
    td12.innerHTML = '<h1>' + l_subject + '</h1>';
    td12 = null;
    
    var td13 = document.createElement('td');
    tr1.appendChild(td13);
    td13.className = 'inbox_list_container_box_c3';
    td13.innerHTML = '<h2>' + inboxFormatDate(_INBOX_MESSAGES['mid_' + p_mid].date) + '</h2>';
    td13 = null;
    
    var tr2 = document.createElement('tr');
    table.appendChild(tr2);
    
    var td21 = document.createElement('td');
    tr2.appendChild(td21);
    td21.className = 'inbox_list_container_box_c1_status';
    // Gestisce la selezione dei messaggi quando l'utente si trova nella tipologia "modifica"
    td21.onclick = function(p_event){
        var l_message_header = $('#inbox_list_container_box_' + p_mid);
        
        if (l_message_header.hasClass('inbox_list_container_box_unselected')) {
            l_message_header.removeClass('inbox_list_container_box_unselected');
            l_message_header.addClass('inbox_list_container_box_selected');
            
        }
        else 
            if (l_message_header.hasClass('inbox_list_container_box_selected')) {
                l_message_header.removeClass('inbox_list_container_box_selected');
                l_message_header.addClass('inbox_list_container_box_unselected');
            }
        
        p_event.stopPropagation();
    };
    td21 = null;
    
    var td22 = document.createElement('td');
    tr2.appendChild(td22);
    td22.className = 'inbox_list_container_box_c2';
    td22.innerHTML = '<h3>' + _INBOX_MESSAGES['mid_' + p_mid].mabstract + '</h3>';
    td22 = null;
    
    var td23 = document.createElement('td');
    tr2.appendChild(td23);
    td23.className = 'inbox_list_container_box_c3_goto';
    td23 = null;
    */
    
    
    box.onclick = (function(p_mid){
        return function(){
            //inboxOpenMessage(p_mid);
        	//TODO
        }
    })(p_mid);
    
    box = null;
    
    if (_INBOX_LIST_ISCROLL == null) {
        _INBOX_LIST_ISCROLL = new iScroll('inbox_list_wrapper');
    }
    else {
        _INBOX_LIST_ISCROLL.refresh();
    }
}

var GLOBAL_SEARCH = null;
function searchDb(){
	console.log("DDD_searchDb_4");
	try{
		//Progress dialog
		//window.searchutil.progressStart();
		//console.log('search is '+$('#search_input').val());	
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
	
		if (toSearch == '') {
			alert('Inserisci una chiave di ricerca');
			return;
		}
		
		window.searchdb.search2(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert(window.searchdb.prova(null));
		//searchAddMessages(res);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function remoteSearch(){
	try{
		//alert($('#search_input').val());
		var toSearch = $('#search_input').val();
		var res = null;//new Array();
		
		window.searchdb.remoteSearch(''+toSearch);
		GLOBAL_SEARCH = toSearch;
		//alert('remote!!!' + toSearch);
		$('#search_list_container').empty();
		$('#search_result_bar').empty();
	}catch(exc){
		alert(exc.message);
	}
}

function resSearch(res){
	//alert('ok');
	
	if(res == null){
	    if($('#search_result_bar').css("display")!='block'){
	    	$('#search_result_bar').css("display","block");
	    	$('#search_box').css("background-color","gray");
	    }
	    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
	    console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
	    $('#search_result_bar').html("0 risultati per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
	    if($('#search_list_wrapper').css("background-color")!="white")
	    	$('#search_list_wrapper').css("background-color","white");
	    return;
	}
	preferitiOpenArticlesList(res);
}

function aaa(res){
	alert(res);
}

/**
 * Crea la lista di articoli salvati come preferiti.
 * @params p_articles Array di articoli così come definiti nel db locale _PREFERITI_ARTICLE_DB_NAME
 */
var _RICERCA_ISCROLL_VISTA = null;
function preferitiOpenArticlesList(p_articles){
	/*
    if (_PREFERITI_ISCROLL_VISTA != null) {
        _PREFERITI_ISCROLL_VISTA.destroy();
        _PREFERITI_ISCROLL_VISTA = null;
    }
    */
	
    $('#preferiti_body_vista_container').empty();
    
    //alert(p_articles.length);
    //alert(p_articles.artid);
    /*
    var aser = {
    		artid:'1317851504', 
    		shared_id:'2844111', 
    		testata:'S24', 
    		edizione:'SOLE', 
    		issue:'20111129', 
    		testata_descr:'Il Sole 24 ORE', 
    		edizione_descr:'Il Sole 24 Ore', 
    		issue_descr:'29 Novembre 2011', 
    		pagina:1, 
    		sezione:'PRIMA', 
    		sezione_descr:'6126', 
    		occhiello: ["RISCHIO DEBITOJuncker: pericoloso dividere l'eurozona - L'opzione di acquisti massicci della Bce - Obama: pronti a fare la nostra parte"], 
    		titolo: ["Il patto per l'euro spinge le Borse. Il patto per l'euro spinge le Borse"], 
    		sottotitolo: ["Balzo dei listini dopo le ipotesi di modifica del Trattato ma lo spread resta a quota 500"], 
    		firme: [], 
    		testo: ["Borse europee in rally dopo le ipotesi, emerse nel fine settimana, di un nuovo piano di stabilità per il salvataggio dell'euro. I listini del Vecchio continente hanno festeggiato la svolta che potrebbe essere già discussa ai prossimi vertici europei dell'8 e 9 dicembre: Piazza Affari ha chiuso con un rialzo del 4,6%, così come Francoforte, mentre Parigi ha guadagnato il 5,46% e Londra il 2,87%. Bene anche Wall Street (+2,9%). Lo spread tra BTp e Bund, dopo essere sceso in mattinata a quota 478 è poi risalito fino alla soglia dei 500 punti. <br/>\nIl percorso per la modifica dei Trattati europei, comunque, resta ancora in salita: il presidente dell'Eurogruppo, Jean-Claude Juncker, ha espresso dei dubbi su accordi intergovernativi che rischiano di dividere la zona euro. E si fa avanti l'ipotesi di interventi massicci di acquisto di titoli da parte della Bce. Il presidente Barack Obama ha assicurato che gli Usa faranno la loro parte per il salvataggio dell'euro.<br/>\nServizi u pagine 2-5"],
    		photos: [["/S24/20111129/SOLE//IMMAGINI/photo/1/obama3.jpg","«Salviamo l'euro». \nVan Rompuy, Obama e Barroso ieri a Washington\n(a fianco le var. % dei listini principali)"]], 
    		grafici: [], 
    		sommari: []
    };
    alert(aser.artid);*/
    for (var i = 0; i < p_articles.length; i++) {
        renderPreferitiArticle(p_articles[i]/*.item(i)*/);
        console.log("titolo"+i+" is "+p_articles[i].titolo);
        //renderPreferitiArticle(aser);
    }
    
    if (_RICERCA_ISCROLL_VISTA == null) {
    	_RICERCA_ISCROLL_VISTA = new iScroll('search_list_wrapper');
    }
    else {
    	_RICERCA_ISCROLL_VISTA.refresh();
    }
    
    $('#search_list_container').css("background-color","white");
    //$('#search_list_container').css("height","400px")
    $('#search_list_wrapper').css("position","relative");
   // $('#search_list_wrapper').css("height","460px");
    $('#search_list_wrapper').css("overflow","hidden");
    if($('#search_result_bar').css("display")!='block'){
    	$('#search_result_bar').css("display","block");
    	$('#search_box').css("background-color","gray");
    }
    
    GLOBAL_SEARCH = GLOBAL_SEARCH.replace(/</g,'&lt;').replace(/>/g,'&gt;')
    //console.log("GLOBAL_SEARCH is " + GLOBAL_SEARCH);
    $('#search_result_bar').html(p_articles.length+" risultati "+" per la ricerca &quot;<em>"+GLOBAL_SEARCH+"</em>&quot;");
    if($('#search_list_wrapper').css("background-color")!="white")
    	$('#search_list_wrapper').css("background-color","white");
    
    _RICERCA_ISCROLL_VISTA.refresh();
    //PhoneGap.exec(null, null, "Notification", "activityStop", []);
    //window.searchutil.progressStop();
}



//var _TIMEOUT_MENU = null;
function mostraTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, 0px, 0)';
    /*
     if (_TIMEOUT_MENU != null) {
     clearTimeout(_TIMEOUT_MENU);
     _TIMEOUT_MENU = null;
     }
     _TIMEOUT_MENU = setTimeout(nascondiTopbar, 2000);
     */
    $('#wrapper_topbar').addClass('wrapper_topbar_open');
}

function nascondiTopbar(){
    //document.getElementById('wrapper_topbar').style['-webkit-transform'] = 'translate3d(0px, -50px, 0)';
    $('#wrapper_topbar').removeClass('wrapper_topbar_open');
}

function checkDBalreadyPresent(){
    if (_DB) {
        var querySuccess = function(tx, rs){
            checkDBalreadyPresent_aux(rs.rows.length > 0);
        }
        var queryError = function(tx, p_error){
            checkDBalreadyPresent_aux(false);
        }
        var executeQuery = function(tx){
            tx.executeSql('SELECT * FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
    else {
    
        checkDBalreadyPresent_aux(false);
    }
}

function checkDBalreadyPresent_aux(isPresent){
    document.getElementById('btn_preferiti_off').style.display = isPresent ? 'none' : 'inline-block';
    document.getElementById('btn_preferiti_on').style.display = isPresent ? 'inline-block' : 'none';
}


function eliminaPreferito(){
	//window.location = 'dsh://preferito.elimina';
	// ALERT sei sicuro, se si esegui eliminaPreferitoExec()
	window.runfunc.askandrun('Sei sicuro di voler eliminare dai prefriti?','eliminaPreferitoExec()');
}

function eliminaPreferitoExec() {
	console.log("elimina pref called");
    if (_CURRENT_ARTICLE == null) 
        return;
    try {
        if (_DB) {
            var querySuccessTag = function(tx){
                //alert('OK eliminazione tag preferito.');
                document.getElementById('btn_preferiti_off').style.display = 'inline-block';
                document.getElementById('btn_preferiti_on').style.display = 'none';
            }
            var queryErrorTag = function(tx, p_error){
                //alert('KO eliminazione tag preferito: ' + p_error.message);
            }
            
            var querySuccess = function(tx){
                //alert('OK eliminazione preferito.');
                tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccessTag, queryErrorTag);
            }
            var queryError = function(tx, p_error){
                //alert('KO eliminazione preferito: ' + p_error.message);
            }
            var executeQuery = function(tx){
                try {
                    tx.executeSql('DELETE FROM ' + _PREFERITI_ARTICLE_DB_NAME + ' WHERE artid=?;', [_CURRENT_ARTICLE.artid], querySuccess, queryError);
                } 
                catch (exc) { 
                	console.log(exc.message);
                }
            }
            _DB.transaction(executeQuery);
        }
    } 
    catch (exc) { 
    	console.log(exc.message);
    }
}

function openSavePreferiti(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    popupPreferitiUpdateArticle(_CURRENT_ARTICLE);
}

function doSavePreferiti(){
	try{//MOD HTML
	    preferitiDBsave(_CURRENT_ARTICLE.artid, _CURRENT_ARTICLE.testata, _CURRENT_ARTICLE.testata_descr, _CURRENT_ARTICLE.issue, _CURRENT_ARTICLE.issue_descr, _CURRENT_ARTICLE.edizione, _CURRENT_ARTICLE.edizione_descr, _CURRENT_ARTICLE.sezione, _CURRENT_ARTICLE.pagina, $('<div/>').html(_CURRENT_ARTICLE.occhiello).text(), $('<div/>').html(_CURRENT_ARTICLE.titolo).text(), $('<div/>').html(_CURRENT_ARTICLE.sottotitolo).text(), _CURRENT_ARTICLE.firma, _CURRENT_ARTICLE.testo, $('#modifica_articolo_preferito #id_tags').val());
	    
	    document.getElementById('btn_preferiti_off').style.display = 'none';
	    document.getElementById('btn_preferiti_on').style.display = 'inline-block';
	    
	    popupPreferitiUpdateArticleChiudi();
	}catch(exc){
		console.log(exc.message);
	}
	//window.location = 'dsh://stats.preferito/' + _CURRENT_ARTICLE.artid;
}

function preferitiDBinit(){
    if (_DB) {
        var querySuccess = function(){
            console.log('OK preferitiDBinit');
        }
        var queryError = function(tx, p_error){
            console.log('KO preferitiDBinit ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_ARTICLE_DB_NAME + ' (' + _PREFERITI_ARTICLE_DB_COLUMNS + ')', [], querySuccess, queryError);
            tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')', [], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
}

function preferitiDBsave(artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags){
    console.log("db is "+_DB);
    try{
	if (_DB) {
        var querySuccess = function(tx){
            console.log('OK SAVE LOCAL DB PREFERITO: ' + artid);
            var tags_arr = tags.split(',');
            for (var t = 0; t < tags_arr.length; t++) {
                var l_tag = tags_arr[t].replace(/^\s+|\s+$/g, ""); //TRIM
                if (l_tag.length <= 0) 
                    continue;
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' VALUES(?, ?);', [l_tag, artid], function(){
                    console.log('OK SAVE LOCAL DB TAG');
                }, function(tx, p_error){
                    console.log('KO SAVE LOCAL DB TAG ' + p_error.message);
                });
            }
        }
        var queryError = function(tx, p_error){
            console.log('KO SAVE LOCAL DB PREFERITO: ' + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('INSERT INTO ' + _PREFERITI_ARTICLE_DB_NAME + ' VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, DATETIME(\'NOW\'), ?);', [artid, testata, testata_descr, issue, issue_descr, edizione, edizione_descr, sezione, pagina, occhiello, titolo, sottotitolo, firma, testo, tags], querySuccess, queryError);
        }
        _DB.transaction(executeQuery);
    }
	}catch(exc){
		console.log('error '+exc.message);
	}
}

/******************************************************
 Gestione indice visibile in landscape
 ******************************************************/
var _ISCROLL_SEZIONI = null;
var _ISCROLL_ARTICOLI = null;

function loadSezioni(sezioniJson){
    if (_ISCROLL_SEZIONI != null) {
        _ISCROLL_SEZIONI.destroy();
        _ISCROLL_SEZIONI = null;
    }
    
    document.getElementById('sezioni_container').innerHTML = '';
    
    //document.getElementById('sezioni_container').style.width = 160 * sezioniJson.length + 'px';
	document.getElementById('sezioni_container').style.width = 500 * sezioniJson.length + 'px';
    
    for (var i = 0; i < sezioniJson.length; i++) {
    
        var box = document.createElement('div');
        box.id = 'box_section_' + sezioniJson[i].section;
        box.className = 'box_sezione';
        document.getElementById('sezioni_container').appendChild(box);
        
        var inner = document.createElement('div');
        box.appendChild(inner);
        
        inner.innerHTML = sezioniJson[i].description;
        
        box.onclick = (function(sid){
            return function(){
                sezioneSelected(sid);
            }
        })(sezioniJson[i].section);
        
        inner = null;
        box = null;
        
    }
	
	if (sezioniJson.length > 0) {
		var last_stection_box = $('#box_section_' + sezioniJson[sezioniJson.length - 1].section);
		if (last_stection_box)
			$('#sezioni_container').width(last_stection_box.position().left + last_stection_box.outerWidth(true)); 
	}
    
    
    setTimeout(function(){
        _ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
            hScroll: true,
            vScroll: false
        });
        _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
    }, 200);
    
    
    return "OK";
    
}

function sezioneSelected(sid){
    $('.box_sezione_selected').removeClass('box_sezione_selected');
    //window.location = 'dsh://indice.load/' + sid;
    window.indice.load(sid);
}

function loadListaArticoliSezione(sid, articoliJson){
    try {
        $('#box_section_' + sid).addClass('box_sezione_selected');
        
        if (_ISCROLL_ARTICOLI != null) {
            _ISCROLL_ARTICOLI.destroy();
            _ISCROLL_ARTICOLI = null;
        }
        
        document.getElementById('articoli_container').innerHTML = '';
        
        if (articoliJson.length == 0)
				document.getElementById('articoli_container').innerHTML = '<div class="articolo_container_empty">Nessun articolo indicizzato per questa sezione.</div>';
			
        for (var i = 0; i < articoliJson.length; i++) {
        
            var box = document.createElement('div');
            box.className = 'box_articolo' + (_CURRENT_ARTICLE != null && articoliJson[i].id == _CURRENT_ARTICLE.artid ? ' box_articolo_selected' : '');
            box.id = 'box_articolo_' + articoliJson[i].id;
            document.getElementById('articoli_container').appendChild(box);
            
            var titolo = document.createElement('h1');
            box.appendChild(titolo);
            titolo.innerHTML = articoliJson[i].titolo;
            
            box.onclick = (function(aid){
                return function(){
                    //window.location = 'dsh://indice.open/' + aid;
                	console.log("aid is "+aid);
                	window.indice.loadArticle(aid); 
                    closeIndice();
                }
            })(articoliJson[i].id);
            
            titolo = null;
            box = null;
            
        }
        
        setTimeout(function(){
            _ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
                hScroll: false,
                vScroll: true
            });
            _ISCROLL_ARTICOLI.scrollTo(0, 0, 100);
            //setTimeout(function() { _ISCROLL_ARTICOLI.refresh() }, 500);
            
            
            if (_ISCROLL_SEZIONI != null) {
                _ISCROLL_SEZIONI.scrollToElement('#box_section_' + sid, 200);
            }
            
        }, 300);
        
        return "OK";
    } 
    catch (exc) {
        return exc.message;
    }
}


/******************************************************
 Gestione database
 ******************************************************/
var _DB_NAME = 'Sole24DB';
var _DB_SIZE = 100000;
var _DB = null;
function inizializzaDatabase(){
    console.log("Inizializzazione database");
    try{
    _DB = window.openDatabase(_DB_NAME, "1.0", _DB_NAME, _DB_SIZE);
    }catch(exc){
    	console.log(exc.message);
    }
}

var _PREFERITI_ARTICLE_DB_NAME = 'PREFERITI_ARTICLE';
var _PREFERITI_ARTICLE_DB_COLUMNS = 'artid text unique, testata text, testata_descr text, issue text, issue_descr text, edizione text, edizione_descr text, sezione text, pagina text, occhiello text, titolo text, sottotitolo text, firma text, testo text, dttm, tags text';
var _PREFERITI_TAG_DB_NAME = 'PREFERITI_TAG';
var _PREFERITI_TAG_DB_COLUMNS = 'nome text, artid text';
var _NUM_PREFERITE_TAGS = 5;


/******************************************************
 Gestione popup modifica preferiti
 ******************************************************/
/**
 * Apre il popup per la modifica di un articolo preferito
 * @params p_article Oggetto articolo così come definito nel database in locale
 */
function popupPreferitiUpdateArticle(p_article){

    //$('#modifica_articolo_preferito').fadeIn();
    if (p_article) {
    
        $('#modifica_articolo_preferito').css('display', 'inline');
        $('#modifica_articolo_preferito_title').html(p_article.titolo);
        $('#modifica_articolo_preferito_text').html('<strong>' + p_article.testata_descr + '</strong> ' + p_article.issue_descr + ' - pag. ' + parseInt(p_article.pagina));
        $('#modifica_articolo_preferito #id_tags').val(p_article.tags);
        $('#modifica_articolo_preferito #id').val(p_article.artid);
        
        
        // Inizializza i tag preferiti
        if (_DB) {
        
            var querySuccess = function(tx, p_results){
                var l_tags_help = $('#modifica_articolo_preferito_tags_help');
                // I tag preferiti vengono inseriti come possibili scelte
                l_tags_help.empty();
                for (var i = 0; i < p_results.rows.length; i++) {
                    var tag = p_results.rows.item(i);
					if (p_article.tags.indexOf(tag.nome) == -1)
                    	l_tags_help.append('<input type="button" class="button medium lightgray24" stye="margin-right:10px;" onclick="popupPreferitiUpdateAddTag(\'' + tag.nome + '\', this)" value="' + tag.nome + '" />');
                }
            }
            
            var queryError = function(p_error){
                console.log("popupPreferitiUpdateArticle: Error processing SQL: " + p_error.message);
            }
            
            var executeQuery = function(tx){
                tx.executeSql('CREATE TABLE IF NOT EXISTS ' + _PREFERITI_TAG_DB_NAME + ' (' + _PREFERITI_TAG_DB_COLUMNS + ')');
                var l_query = 'SELECT nome, COUNT(*) AS num_articles FROM ' + _PREFERITI_TAG_DB_NAME + ' GROUP BY nome ORDER BY num_articles DESC LIMIT 0,' + _NUM_PREFERITE_TAGS;
                tx.executeSql(l_query, [], querySuccess, queryError);
            }
            
            
            _DB.transaction(executeQuery, queryError);
        }
    }
}

/**
 * Aggiunge un tag all'elemento input contentente tutti i tag di un articolo preferito
 */
function popupPreferitiUpdateAddTag(p_tag, button){
	if (button != null) button.style['display'] = 'none';
    var l_tags_el = $('#modifica_articolo_preferito #id_tags');
    var l_tags_string = l_tags_el.val();
    
    if (l_tags_string != '') {
        l_tags_string += ', ' + p_tag;
    }
    else {
        l_tags_string = p_tag;
    }
    
    l_tags_el.val(l_tags_string);
}

/**
 * Esegue il salvataggio del preferito
 */
function popupPreferitiUpdateArticleAvanti(){
    var l_artid = $('#modifica_articolo_preferito #id').val();
    var l_tags = $('#modifica_articolo_preferito #id_tags').val();
    // Salva le modifiche
    if (_DB) {
        var querySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Data saved, rows affected: " + p_results.rowsAffected);
        }
        var updateQuerySuccess = function(tx, p_results){
            console.log("popupPreferitiUpdateArticleAvanti: Update article success");
            if (p_results.rowsAffected > 0) {
                document.getElementById('preferiti_body_vista_container_box_tags_' + l_artid).innerHTML = 'Tags: ' + l_tags;
            }
        }
        var queryError = function(p_error){
            console.log("popupPreferitiUpdateArticleAvanti: Error processing SQL: " + p_error.message);
        }
        var executeQuery = function(tx){
            tx.executeSql('UPDATE ' + _PREFERITI_ARTICLE_DB_NAME + ' SET tags=? WHERE artid=?', [l_tags, l_artid], updateQuerySuccess, queryError);
            
            // Elimina i tag attualmente presenti per quel prodotto
            tx.executeSql('DELETE FROM ' + _PREFERITI_TAG_DB_NAME + ' WHERE artid=? OR artid=""', [l_artid], querySuccess, queryError);
            var l_tags_array = l_tags.toLowerCase().split(',');
            for (var i = 0; i < l_tags_array.length; i++) {
                var l_tag = l_tags_array[i].replace(/^\s+|\s+$/g, ""); //TRIM
                tx.executeSql('INSERT INTO ' + _PREFERITI_TAG_DB_NAME + ' (nome, artid) VALUES(?,?)', [l_tag, l_artid], querySuccess, queryError);
            }
        }
        //Caricamento INBOX da locale
        _DB.transaction(executeQuery, queryError);
    }
    popupPreferitiUpdateArticleChiudi();
}

/**
 * Chiude il popup per la modifica di un articolo preferito
 */
function popupPreferitiUpdateArticleChiudi(){
    //$('#modifica_articolo_preferito').fadeOut();
    $('#modifica_articolo_preferito').css('display', 'none');
}


function shareFacebook(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('http://www.facebook.com/sharer.php?u=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&t=' + encodeURIComponent(l_titolo));
}

function shareTwitter(){
    if (_CURRENT_ARTICLE == null) 
        return;
    
    var l_shared_id = _CURRENT_ARTICLE.shared_id;
    if (l_shared_id == null) 
        return;
    
    var l_titolo = (_CURRENT_ARTICLE.titolo.length > 0) ? _CURRENT_ARTICLE.titolo : 'edicola.ilsole24ore.com';
    
    window.open.openUrl('https://twitter.com/share?original_referer=http%3A%2F%2Fwww.ilsole24ore.com%2F&related=24backstage&via=24backstage&url=' + encodeURIComponent('http://edicola.ilsole24ore.com/index.jsp?IdArt=' + l_shared_id) + '&text=' + encodeURIComponent(l_titolo));
}


var _AJAX_TIMEOUT = 15000;
var _SOLEGW_ENDPOINT = "https://api24.ilsole24ore.com/SoleGateway/";
var _API24_APPKEY = "DroidQuot";//"iPadQuot";//DA CAMBIARE
var _APPNAME = 'ITQUOIPAD';//DA CAMBIARE
var _APPVERSION = '1.5';// DA CAMBIARE A 2.0
function loadCorrelates(){
    if ((_CURRENT_ARTICLE == null) || (_CURRENT_ARTICLE.shared_id == null)) 
        renderCorrelate(null, null);
	
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'inline-block');
	
    var req_headers = {
        "appKey": _API24_APPKEY
    };
    var req_data = {
        "appName": _APPNAME,
        "appVersion": _APPVERSION
    };
	console.log(_SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json");
	console.log(req_headers);
	console.log(req_data);
    $.ajax({
        type: "GET",
        cache: false,
        timeout: _AJAX_TIMEOUT,
        contentType: "application/json; charset=utf-8",
        url: _SOLEGW_ENDPOINT + "correlates/" + _CURRENT_ARTICLE.shared_id + ".json",
        headers: req_headers,
        data: req_data,
        dataType: "json",
        success: function(p_response){
			if (typeof p_response == "string") {
                p_response = $.parseJSON(p_response);
            }
			console.log(p_response);
			if (p_response.Success) {
				var l_res = p_response.Result.res;
				renderCorrelate(l_res.docId, l_res.correlateItem);
			} else {
				renderCorrelate(null, null);
			}
        },
        error: function(){
        	renderCorrelate(null, null);
        }
    });
}

function renderCorrelate(shared_id, articoli) {
	if ((shared_id == null) || (articoli == null)) {
		// si è verificato un errore --> nascondo i correlati
		$('#articolo_body_media_correlati_content').empty();
		$('#articolo_body_media_correlati_empty').css('display', 'inline-block');
		$('#articolo_body_media_correlati_loading').css('display', 'none');
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		
		return;
	}
	if ((shared_id + '') != (_CURRENT_ARTICLE.shared_id + '')) {
		// l'articolo al quale fanno riferimento i correlati non è quello attualmente aperto --> non faccio nulla
		if (_ARTICOLO_ISCROLL != null) {
            _ARTICOLO_ISCROLL.refresh();
        }
		return;
	}
	// mostro i correlati
	$('#articolo_body_media_correlati_content').empty();
	$('#articolo_body_media_correlati_empty').css('display', 'none');
	$('#articolo_body_media_correlati_loading').css('display', 'none');
	for (var i = 0; i < articoli.length; i++) {
		var box = document.createElement('div');
		box.className = 'articolo_body_media_arricchimento_item';
		document.getElementById('articolo_body_media_correlati_content').appendChild(box);
		
		box.innerHTML = articoli[i].titolo;
		
		box.onclick = (function(url){
            return function(event){
                event.preventDefault();
                event.stopPropagation();
                window.open.openUrl(url);
            }
        })(articoli[i].url);
		
		box = null;
	}
	
	if (_ARTICOLO_ISCROLL != null) {
		_ARTICOLO_ISCROLL.refresh();
	}
	
}
}catch(exc){
	alert(exc.message);
}








		function ipadFlipperTopBarEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuEdicola() {
			window.location = 'dsh://edicola.open';
		}
		function ipadFlipper24AppmenuPreferiti() {
			window.location = 'dsh://preferiti.open';
		}
		function ipadFlipper24AppmenuInbox() {
			window.location = 'dsh://inbox.open';
		}
		function ipadFlipper24AppmenuImpostazioni() {
			window.location = 'dsh://impostazioni.open';
		}
		function ipadFlipper24Thumb() {
			window.location = 'dsh://thumb.open';
		}
		function ipadFlipper24UpdatePgnum(current, total) {
			document.getElementById('flipper24_topbar_thumb').innerHTML = current + ' di ' + total;
			return "OK";
		}
		function ipadFlipper24AppmenuIndice() {
			window.location = 'dsh://indice.open';
		}
	


    	function loadTabella(p_tabella) {
    		if (!p_tabella) return;
    		//alert(JSON.stringify(p_tabella));
    		if (p_tabella.titolo) {
    			document.getElementById('flipper24_tab_titolo').innerHTML = p_tabella.titolo;
    		} else {
    			document.getElementById('flipper24_tab_titolo').style.display = 'none';
    		}
    		if (p_tabella.contenuto) {
    			document.getElementById('flipper24_tab_contenuto').innerHTML = p_tabella.contenuto;
    		} else {
    			document.getElementById('flipper24_tab_contenuto').style.display = 'none';
    		}
    	}
    




		function getUrlParameter(name){
    		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    		var regexS = "[\\?&]" + name + "=([^&#]*)";
   	 		var regex = new RegExp(regexS);
    		var results = regex.exec(window.location.href);
		    if (results == null) 
	        	return "";
	    	else 
	        	return results[1];
		}
		
		function willShowPopup() {
			try {
				var imgs = document.getElementById('wrapper').getElementsByTagName('img');
				if (imgs == null || imgs.length == 0) return "no1";
				for (var i = 0; i < imgs.length; i++) {
					if (parseInt(imgs[i].height) > 10) return "yes";
				}
				return "no2";
			} catch (exc) {
				return "no3";
			}
		}
	
		function onBodyLoad() {
			$('#wrapper').writeCapture().load('http://adv.ilsole24ore.it/RealMedia/ads/adstream_sx.ads/www.ilsole24ore.it/11/ipad_app_v2/' + getUrlParameter('u') + '@Ticker_02', function() { }).endCapture();
		}
	



			var _DEBUG_MODE = !('ontouchstart' in window);
			var orientationTimer = null;
			
			function getRatio(value) {
				return parseInt(value) / window.devicePixelRatio;
			}
			
			var CURRENT_ORIENTATION = null;
			
			function updateOrientation() {
				var screenHeight = screen.height;
				var screenWidth = screen.width;
				isPortrait = screenWidth < screenHeight;
				var aspectRatio = screenWidth / screenHeight;

				var orientation = isPortrait ? 1 : 2 ;
				if (CURRENT_ORIENTATION == orientation) return;
				CURRENT_ORIENTATION = orientation;
		
				var fontSizeRatio = (isPortrait) ? Math.round(getRatio(screenHeight) * 0.02) : Math.round(getRatio(screenWidth) * 0.02);
				$('body').css('font-size', fontSizeRatio + 'px');
				fontSizeRatio = null;
				
				var spaceComponents = 0;
				var contentWidth = document.documentElement.clientWidth;
				var contentHeight = getRatio(screenHeight - 200 - spaceComponents);
				if (isPortrait) contentHeight /= 2.8;
				$('#wrapper').width(contentWidth).height(contentHeight).show();
			}
			
			function onBodyLoaded() {
				$('#wrapper').hide();
				
				setInterval(function(){
					updateOrientation();
				}, 500);
			}
			
			if (_DEBUG_MODE) {
				$(function(){ onBodyLoaded(); });
			} else {
				document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
			}
		










			var _ISCROLL_SEZIONI = null;
			var _ISCROLL_ARTICOLI = null;
			var _DEBUG_MODE = !('ontouchstart' in window);
			
			function getRatio(value) {
				return parseInt(value) / window.devicePixelRatio;
			}
			
// 			var CURRENT_ORIENTATION = null;
			
			function updateOrientation(screenWidth, screenHeight) {
				//var screenWidth = screen.width;
				//var screenHeight = screen.height;
				var deviceData = $.parseJSON(window.DeviceDetection.getData());
				var aspectRatio = screenWidth / screenHeight;
				isPortrait = screenWidth < screenHeight;

// 				var orientation = isPortrait ? 1 : 2 ;
// 				if (CURRENT_ORIENTATION == orientation) return;
// 				CURRENT_ORIENTATION = orientation;
		
				var fontSizeRatio = (isPortrait) ? Math.round(getRatio(screenHeight) * 0.04) : Math.round(getRatio(screenWidth) * 0.04);
				$('body').css('font-size', fontSizeRatio + 'px');
				fontSizeRatio = null;
				
				$('#wrapper').width(screenWidth).height(screenHeight);

				//alert(screen.height + ' ' + document.documentElement.clientWidth + ' ' + window.innerHeight);
			}
			
			function onBodyLoaded() {
// 				setInterval(function(){
// 					updateOrientation();
// 				}, 1000);
			}
			
			function loadSezioni(sezioniJson) {
			
				if (_ISCROLL_SEZIONI != null) {
					_ISCROLL_SEZIONI.destroy();
					_ISCROLL_SEZIONI = null;
				}

				document.getElementById('sezioni_container').innerHTML = '';
			
				for (var i = 0; i < sezioniJson.length; i++) {

					var box = document.createElement('div');
					box.id = 'box_section_' + sezioniJson[i].section;
					box.className = 'box_sezione';
					document.getElementById('sezioni_container').appendChild(box);

					var inner = document.createElement('div');
					box.appendChild(inner);

					inner.innerHTML = sezioniJson[i].description;

					box.onclick = (function(sid) {
						return function() {
							sezioneSelected(sid);
						}
					})(sezioniJson[i].section);

					inner = null;
					box = null;

				}

				if (sezioniJson.length > 0) {
					var scrollerWidth = 0;
					$('#sezioni_container .box_sezione').each(function(){
						scrollerWidth += $(this).width();
					});
					$('#sezioni_container').width(scrollerWidth);
					scrollerWidth = null;
				}
				
				//$('.box_sezione').eq(0).addClass('box_sezione_selected');
				$('.box_sezione div').css('margin-top', ($('#sezioni_wrapper').height() - $('.box_sezione div').eq(0).outerHeight()) / 2);

				setTimeout(function() {
					_ISCROLL_SEZIONI = new iScroll('sezioni_wrapper', {
						hideScrollbar: true,
						fadeScrollbar: true
					});
					_ISCROLL_SEZIONI.scrollTo(0, 0, 100);
					_ISCROLL_SEZIONI.refresh();
					
					$('#sezioni_container .box_sezione').eq(0).trigger('click');
				}, 200);
				
				return "OK";
			}

			function sezioneSelected(sid) {
				$('.box_sezione_selected').removeClass('box_sezione_selected');
				//window.location = 'dsh://indice.load/' + sid;
				console.log("sezioneSelected  " + sid);
				window.indice.load(sid);
			}

			function loadListaArticoliSezione(sid, articoliJson) {
				$('#box_section_' + sid).addClass('box_sezione_selected');

				if (_ISCROLL_ARTICOLI != null) {
					_ISCROLL_ARTICOLI.destroy();
					_ISCROLL_ARTICOLI = null;
				}

				document.getElementById('articoli_container').innerHTML = '';

				if (articoliJson.length == 0)
					return "VUOTO";

				for (var i = 0; i < articoliJson.length; i++) {

					var box = document.createElement('div');
					box.className = 'box_articolo';
					box.id = 'box_articolo' + new Date().getTime();
					document.getElementById('articoli_container').appendChild(box);

					var titolo = document.createElement('h1');
					box.appendChild(titolo);
					titolo.innerHTML = articoliJson[i].titolo;

					var pagina = document.createElement('h3');
					box.appendChild(pagina);
					pagina.innerHTML = 'pag. ' + articoliJson[i].pagina;

					console.log('indice box1 ' + box.id);

					box.onclick = (function(pagina) {
						return function() {
							$('#' + this.id).addClass('box_articolo_selected');

							setTimeout(function() {
								$('.box_articolo_selected').removeClass('box_articolo_selected');
							}, 120);

							setTimeout(function() {
								console.log("vai a " + pagina);
								//Da USARE GOTO THUMB
								window.go.to(pagina);

							}, 150);
						}
					})(articoliJson[i].pagina);

					pagina = null;
					titolo = null;
					box = null;

				}

				setTimeout(function() {
					_ISCROLL_ARTICOLI = new iScroll('articoli_wrapper', {
						hScroll : false,
						vScroll : true
					});
					_ISCROLL_ARTICOLI.scrollTo(0, 0, 100);

				}, 200);

				return "OK";

			}

			if (_DEBUG_MODE) {
				$(function(){ onBodyLoaded(); });
			} else {
				document.addEventListener("DOMContentLoaded", onBodyLoaded, false);
			}
		
